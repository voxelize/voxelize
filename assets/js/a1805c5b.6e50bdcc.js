"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3964],{14789:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>h,default:()=>o,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"networking/custom-dispatcher","title":"Custom Dispatcher","description":"The Voxelize server is built on top of the specs ECS framework. This means that the server is made up of a series of systems that are running in parallel. By default, Voxelize has a list of systems that are used to handle things like chunk generation, network packet handling, and more. These systems come together and define what happens every game tick.","source":"@site/docs/wiki/networking/custom-dispatcher.md","sourceDirName":"networking","slug":"/networking/custom-dispatcher","permalink":"/wiki/networking/custom-dispatcher","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Metadata Processing","permalink":"/wiki/networking/metadata-processing"},"next":{"title":"Transport","permalink":"/wiki/networking/transport"}}');var i=s(62540),d=s(43023);const r={sidebar_position:4},h="Custom Dispatcher",a={},l=[{value:"The Default Dispatcher",id:"the-default-dispatcher",level:2},{value:"Core Systems",id:"core-systems",level:3},{value:"Chunk Systems",id:"chunk-systems",level:3},{value:"Physics System",id:"physics-system",level:3},{value:"AI &amp; Pathfinding Systems",id:"ai--pathfinding-systems",level:3},{value:"Network &amp; Persistence Systems",id:"network--persistence-systems",level:3},{value:"Customizing the Dispatcher",id:"customizing-the-dispatcher",level:2},{value:"Adding Custom Systems",id:"adding-custom-systems",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"custom-dispatcher",children:"Custom Dispatcher"})}),"\n",(0,i.jsxs)(n.p,{children:["The Voxelize server is built on top of the ",(0,i.jsx)(n.a,{href:"https://specs.amethyst.rs/docs/tutorials/",children:"specs"})," ECS framework. This means that the server is made up of a series of systems that are running in parallel. By default, Voxelize has a list of systems that are used to handle things like chunk generation, network packet handling, and more. These systems come together and define what happens every game tick."]}),"\n",(0,i.jsx)(n.p,{children:"In order to customize this behavior, you can define your own dispatcher. This allows you to define your own systems, and to control the order in which they are executed. This can be useful for creating custom game logic, or for optimizing the server."}),"\n",(0,i.jsx)(n.h2,{id:"the-default-dispatcher",children:"The Default Dispatcher"}),"\n",(0,i.jsx)(n.p,{children:"The default dispatcher consists of the following systems:"}),"\n",(0,i.jsx)(n.h3,{id:"core-systems",children:"Core Systems"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"UpdateStatsSystem"}),' ("update-stats")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Updates the game tick counter and the time since the last tick"}),"\n",(0,i.jsxs)(n.li,{children:["The details are within the ",(0,i.jsx)(n.code,{children:"Stats"})," resource in the ECS world"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EntitiesMetaSystem"}),' ("entities-meta")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Updates the metadata of entities"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PeersMetaSystem"}),' ("peers-meta")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Updates the metadata of peers"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CurrentChunkSystem"}),' ("current-chunk")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Based on each entity's position, determines which chunks they are currently in"}),"\n",(0,i.jsxs)(n.li,{children:["This updates the ",(0,i.jsx)(n.code,{children:"CurrentChunkComp"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"chunk-systems",children:"Chunk Systems"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ChunkUpdatingSystem"}),' ("chunk-updating")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "current-chunk"'}),"\n",(0,i.jsx)(n.li,{children:"Processes the voxel updates that have been queued by the clients"}),"\n",(0,i.jsx)(n.li,{children:"This is where the voxel updates are actually applied to the chunks"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ChunkRequestsSystem"}),' ("chunk-requests")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "current-chunk"'}),"\n",(0,i.jsx)(n.li,{children:"Processes the chunks requested by the clients"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ChunkGeneratingSystem"}),' ("chunk-generation")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "chunk-requests"'}),"\n",(0,i.jsx)(n.li,{children:"Generates chunks that have not been generated yet"}),"\n",(0,i.jsx)(n.li,{children:"Meshes are generated here for the chunks"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ChunkSendingSystem"}),' ("chunk-sending")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "chunk-generation"'}),"\n",(0,i.jsx)(n.li,{children:"Sends the chunks that are generated and meshed to the clients"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ChunkSavingSystem"}),' ("chunk-saving")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "chunk-generation"'}),"\n",(0,i.jsx)(n.li,{children:"Saves the chunks that are generated to the disk"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"physics-system",children:"Physics System"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PhysicsSystem"}),' ("physics")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'2 dependencies: "current-chunk", "update-stats"'}),"\n",(0,i.jsx)(n.li,{children:"Ticks the rigid bodies in the voxel world"}),"\n",(0,i.jsxs)(n.li,{children:["Detects any interactions/collisions between ",(0,i.jsx)(n.code,{children:"InteractorComp"}),"s"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"ai--pathfinding-systems",children:"AI & Pathfinding Systems"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EntityTreeSystem"}),' ("entity-tree")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Builds a KdTree spatial index of all entities and players for fast nearest-neighbor lookups"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EntityObserveSystem"}),' ("entity-observe")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsxs)(n.li,{children:["Uses the KdTree to find and update the closest target for entities with ",(0,i.jsx)(n.code,{children:"TargetComp"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"TargetMetadataSystem"}),' ("target-meta")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsxs)(n.li,{children:["Syncs ",(0,i.jsx)(n.code,{children:"TargetComp"})," data to the entity's metadata"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PathFindingSystem"}),' ("path-finding")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "entity-observe"'}),"\n",(0,i.jsxs)(n.li,{children:["Runs A* pathfinding for entities with both ",(0,i.jsx)(n.code,{children:"PathComp"})," and ",(0,i.jsx)(n.code,{children:"TargetComp"})]}),"\n",(0,i.jsx)(n.li,{children:"Computes paths with configurable constraints and path smoothing"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PathMetadataSystem"}),' ("path-meta")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"0 dependencies"}),"\n",(0,i.jsx)(n.li,{children:"Syncs computed paths to the entity's metadata"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"WalkTowardsSystem"}),' ("walk-towards")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "path-finding"'}),"\n",(0,i.jsxs)(n.li,{children:["Operates the ",(0,i.jsx)(n.code,{children:"BrainComp"})," to make entities walk along their computed paths"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"network--persistence-systems",children:"Network & Persistence Systems"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"DataSavingSystem"}),' ("entities-saving")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "entities-meta"'}),"\n",(0,i.jsx)(n.li,{children:"Saves the entities' metadata that have been modified to the disk"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EntitiesSendingSystem"}),' ("entities-sending")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "entities-meta"'}),"\n",(0,i.jsx)(n.li,{children:"Sends the entities' metadata that have been modified to the clients"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PeersSendingSystem"}),' ("peers-sending")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "peers-meta"'}),"\n",(0,i.jsx)(n.li,{children:"Sends the peers' metadata that have been modified to the clients"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"BroadcastSystem"}),' ("broadcast")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'3 dependencies: "chunk-sending", "entities-sending", "peers-sending"'}),"\n",(0,i.jsx)(n.li,{children:"All the above systems will queue up packets to be sent to the clients. This system will actually send the packets to the clients"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"CleanupSystem"}),' ("cleanup")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'2 dependencies: "entities-sending", "peers-sending"'}),"\n",(0,i.jsx)(n.li,{children:"Cleans up the ECS world by clearing the collisions and interactions that have been processed"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"EventsSystem"}),' ("events")',"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'1 dependency: "broadcast"'}),"\n",(0,i.jsx)(n.li,{children:"Processes the events that have been queued by the clients by broadcasting them to the other clients that are interested"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"customizing-the-dispatcher",children:"Customizing the Dispatcher"}),"\n",(0,i.jsxs)(n.p,{children:["To customize the dispatcher, use ",(0,i.jsx)(n.code,{children:"world.set_dispatcher()"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",metastring:'title="Custom Dispatcher"',children:'use specs::DispatcherBuilder;\n\nworld.set_dispatcher(|| {\n    DispatcherBuilder::new()\n        .with(UpdateStatsSystem, "update-stats", &[])\n        .with(EntitiesMetaSystem, "entities-meta", &[])\n        .with(PeersMetaSystem, "peers-meta", &[])\n        .with(CurrentChunkSystem, "current-chunk", &[])\n        .with(ChunkUpdatingSystem, "chunk-updating", &["current-chunk"])\n        .with(ChunkRequestsSystem, "chunk-requests", &["current-chunk"])\n        .with(ChunkGeneratingSystem, "chunk-generation", &["chunk-requests"])\n        .with(ChunkSendingSystem, "chunk-sending", &["chunk-generation"])\n        .with(ChunkSavingSystem, "chunk-saving", &["chunk-generation"])\n        .with(PhysicsSystem, "physics", &["current-chunk", "update-stats"])\n        .with(DataSavingSystem, "entities-saving", &["entities-meta"])\n        .with(EntitiesSendingSystem, "entities-sending", &["entities-meta"])\n        .with(PeersSendingSystem, "peers-sending", &["peers-meta"])\n        .with(\n            BroadcastSystem,\n            "broadcast",\n            &["chunk-sending", "entities-sending", "peers-sending"],\n        )\n        .with(\n            CleanupSystem,\n            "cleanup",\n            &["entities-sending", "peers-sending"],\n        )\n        .with(EventsSystem, "events", &["broadcast"])\n        // Add AI systems if needed\n        .with(EntityObserveSystem, "entity-observe", &[])\n        .with(PathFindingSystem, "path-finding", &["entity-observe"])\n        .with(WalkTowardsSystem, "walk-towards", &["path-finding"])\n        .with(EntityTreeSystem, "entity-tree", &[])\n        // Add your custom systems here\n        .with(MyCustomSystem, "my-custom", &["entities-meta"])\n});\n'})}),"\n",(0,i.jsx)(n.h2,{id:"adding-custom-systems",children:"Adding Custom Systems"}),"\n",(0,i.jsx)(n.p,{children:"You can add your own systems to extend the server behavior. Here's an example of a custom system that makes entities take damage when they collide:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",metastring:'title="Custom Damage System"',children:"use specs::{System, ReadStorage, WriteStorage, Join};\n\nstruct DamageOnCollisionSystem;\n\nimpl<'a> System<'a> for DamageOnCollisionSystem {\n    type SystemData = (\n        ReadStorage<'a, CollisionsComp>,\n        WriteStorage<'a, HealthComp>,\n        WriteStorage<'a, MetadataComp>,\n    );\n\n    fn run(&mut self, (collisions, mut healths, mut metadatas): Self::SystemData) {\n        for (collision, health, metadata) in (&collisions, &mut healths, &mut metadatas).join() {\n            if !collision.0.is_empty() {\n                health.0 = health.0.saturating_sub(1);\n                metadata.set::<HealthComp>(\"health\", health);\n            }\n        }\n    }\n}\n"})})]})}function o(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},43023:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>h});var t=s(63696);const i={},d=t.createContext(i);function r(e){const n=t.useContext(d);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function h(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(d.Provider,{value:n},e.children)}}}]);