"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1900],{6084:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"intermediate/protocol-networking","title":"Protocol Networking","description":"Voxelize uses Protocol Buffers for efficient binary serialization of network messages. Understanding the protocol helps when building custom features.","source":"@site/docs/tutorials/intermediate/11-protocol-networking.md","sourceDirName":"intermediate","slug":"/intermediate/protocol-networking","permalink":"/tutorials/intermediate/protocol-networking","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"sidebar_position":11},"sidebar":"tutorialSidebar","previous":{"title":"Chat and Colored Text","permalink":"/tutorials/intermediate/chat-and-colored-text"},"next":{"title":"Custom Blocks","permalink":"/tutorials/intermediate/custom-blocks"}}');var r=t(62540),i=t(43023);const l={sidebar_position:11},d="Protocol Networking",o={},c=[{value:"Message Structure",id:"message-structure",level:2},{value:"Message Types",id:"message-types",level:2},{value:"Entity Protocol",id:"entity-protocol",level:2},{value:"Peer Protocol",id:"peer-protocol",level:2},{value:"Chunk Protocol",id:"chunk-protocol",level:2},{value:"Custom Transport",id:"custom-transport",level:2},{value:"Client Side",id:"client-side",level:3},{value:"Server Side",id:"server-side",level:3},{value:"Network Flow",id:"network-flow",level:2},{value:"Connection Sequence",id:"connection-sequence",level:3},{value:"Frame Loop",id:"frame-loop",level:3},{value:"Server Tick",id:"server-tick",level:3},{value:"Debugging Network",id:"debugging-network",level:2},{value:"Client Logging",id:"client-logging",level:3},{value:"Message Inspection",id:"message-inspection",level:3},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"Chunk Loading",id:"chunk-loading",level:3},{value:"Entity Updates",id:"entity-updates",level:3},{value:"Peer Updates",id:"peer-updates",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"protocol-networking",children:"Protocol Networking"})}),"\n",(0,r.jsx)(n.p,{children:"Voxelize uses Protocol Buffers for efficient binary serialization of network messages. Understanding the protocol helps when building custom features."}),"\n",(0,r.jsx)(n.h2,{id:"message-structure",children:"Message Structure"}),"\n",(0,r.jsxs)(n.p,{children:["All messages follow the ",(0,r.jsx)(n.code,{children:"MessageProtocol"})," structure:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Message Protocol"',children:"interface MessageProtocol {\n  type: MessageType;\n  json?: string;\n  text?: string;\n  chat?: ChatMessage;\n  peers?: Peer[];\n  entities?: Entity[];\n  chunks?: Chunk[];\n  updates?: Update[];\n  events?: Event[];\n  method?: Method;\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"message-types",children:"Message Types"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Direction"}),(0,r.jsx)(n.th,{children:"Purpose"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"INIT"})}),(0,r.jsx)(n.td,{children:"Server \u2192 Client"}),(0,r.jsx)(n.td,{children:"Initial world state"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"JOIN"})}),(0,r.jsx)(n.td,{children:"Server \u2192 Client"}),(0,r.jsx)(n.td,{children:"Player joined notification"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"LEAVE"})}),(0,r.jsx)(n.td,{children:"Server \u2192 Client"}),(0,r.jsx)(n.td,{children:"Player left notification"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"PEER"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"Player position/metadata updates"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ENTITY"})}),(0,r.jsx)(n.td,{children:"Server \u2192 Client"}),(0,r.jsx)(n.td,{children:"Entity create/update/delete"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"LOAD"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"Chunk requests and data"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"UNLOAD"})}),(0,r.jsx)(n.td,{children:"Client \u2192 Server"}),(0,r.jsx)(n.td,{children:"Chunk unload notification"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"UPDATE"})}),(0,r.jsx)(n.td,{children:"Server \u2192 Client"}),(0,r.jsx)(n.td,{children:"World stats (time, etc.)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CHAT"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"Chat messages"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EVENT"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"Custom events"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"METHOD"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"RPC calls"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"TRANSPORT"})}),(0,r.jsx)(n.td,{children:"Bidirectional"}),(0,r.jsx)(n.td,{children:"Custom binary data"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"entity-protocol",children:"Entity Protocol"}),"\n",(0,r.jsx)(n.p,{children:"Entity messages contain:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Entity Protocol"',children:'interface EntityProtocol {\n  id: string;\n  type: string;\n  operation: "CREATE" | "UPDATE" | "DELETE";\n  metadata?: string; // JSON string\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Operations:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"CREATE"})," - New entity spawned"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"UPDATE"})," - Entity state changed"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"DELETE"})," - Entity removed"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"peer-protocol",children:"Peer Protocol"}),"\n",(0,r.jsx)(n.p,{children:"Peer messages contain:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Peer Protocol"',children:"interface PeerProtocol {\n  id: string;\n  username: string;\n  metadata: string; // JSON with position, direction, etc.\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"chunk-protocol",children:"Chunk Protocol"}),"\n",(0,r.jsx)(n.p,{children:"Chunk data is compressed:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Chunk Protocol"',children:"interface ChunkProtocol {\n  x: number;\n  z: number;\n  id: string;\n  meshes: MeshProtocol[];\n  voxels: Uint8Array; // Compressed voxel data\n  lights: Uint8Array; // Compressed light data\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"custom-transport",children:"Custom Transport"}),"\n",(0,r.jsx)(n.p,{children:"For custom binary data, use the transport system:"}),"\n",(0,r.jsx)(n.h3,{id:"client-side",children:"Client Side"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Client Transport"',children:'network.send({\n  type: "TRANSPORT",\n  json: JSON.stringify({\n    action: "custom-action",\n    data: { x: 10, y: 20 },\n  }),\n});\n'})}),"\n",(0,r.jsx)(n.h3,{id:"server-side",children:"Server Side"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",metastring:'title="Server Transport Handler"',children:'world.set_transport_handle(|world, value| {\n    let action = value.get("action").and_then(|v| v.as_str());\n\n    match action {\n        Some("custom-action") => {\n            let data = value.get("data").unwrap();\n            // Process custom data\n        }\n        _ => {}\n    }\n});\n'})}),"\n",(0,r.jsx)(n.h2,{id:"network-flow",children:"Network Flow"}),"\n",(0,r.jsx)(n.h3,{id:"connection-sequence",children:"Connection Sequence"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Client connects via WebSocket"}),"\n",(0,r.jsxs)(n.li,{children:["Client sends ",(0,r.jsx)(n.code,{children:"JOIN"})," with world name"]}),"\n",(0,r.jsxs)(n.li,{children:["Server sends ",(0,r.jsx)(n.code,{children:"INIT"})," with world config, blocks, existing peers/entities"]}),"\n",(0,r.jsxs)(n.li,{children:["Client processes ",(0,r.jsx)(n.code,{children:"INIT"})," and starts requesting chunks"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"frame-loop",children:"Frame Loop"}),"\n",(0,r.jsx)(n.p,{children:"Each frame:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Client receives"}),": Server messages queued"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"network.sync()"}),": Messages dispatched to interceptors"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Game logic"}),": Updates based on received data"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Interceptors queue packets"}),": Add to ",(0,r.jsx)(n.code,{children:"packets"})," arrays"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"network.flush()"}),": All queued packets sent to server"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"server-tick",children:"Server Tick"}),"\n",(0,r.jsx)(n.p,{children:"Each server tick:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Process incoming messages"}),"\n",(0,r.jsx)(n.li,{children:"Run ECS systems"}),"\n",(0,r.jsx)(n.li,{children:"Collect changed entities/peers"}),"\n",(0,r.jsx)(n.li,{children:"Send updates to interested clients"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"debugging-network",children:"Debugging Network"}),"\n",(0,r.jsx)(n.h3,{id:"client-logging",children:"Client Logging"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Network Debugging"',children:'const debugInterceptor = {\n  onMessage(message: MessageProtocol) {\n    console.log("Received:", message.type, message);\n  },\n};\n\nnetwork.register(debugInterceptor);\n'})}),"\n",(0,r.jsx)(n.h3,{id:"message-inspection",children:"Message Inspection"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Message Inspection"',children:'network.on("message", (raw: ArrayBuffer) => {\n  console.log("Raw message size:", raw.byteLength);\n});\n'})}),"\n",(0,r.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,r.jsx)(n.h3,{id:"chunk-loading",children:"Chunk Loading"}),"\n",(0,r.jsx)(n.p,{children:"Chunks are loaded based on:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Player position and direction (frustum culling)"}),"\n",(0,r.jsx)(n.li,{children:"Render radius configuration"}),"\n",(0,r.jsxs)(n.li,{children:["Server ",(0,r.jsx)(n.code,{children:"max_chunks_per_tick"})," setting"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"entity-updates",children:"Entity Updates"}),"\n",(0,r.jsx)(n.p,{children:"Entities only send updates when metadata changes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-rust",metastring:'title="Efficient Updates"',children:'// Only changed fields are sent\nmetadata.set("health", &new_health);  // Sends if health changed\n'})}),"\n",(0,r.jsx)(n.h3,{id:"peer-updates",children:"Peer Updates"}),"\n",(0,r.jsx)(n.p,{children:"Peer positions are sent every frame, but interpolated on the client:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Peer Interpolation"',children:"onPeerUpdate(peer, metadata) {\n  // Don't set position directly, interpolate\n  peer.targetPosition.set(...metadata.position);\n}\n\nupdate() {\n  peer.position.lerp(peer.targetPosition, 0.1);\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Read on to learn about ",(0,r.jsx)(n.a,{href:"./custom-blocks",children:"custom blocks"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},43023:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>d});var s=t(63696);const r={},i=s.createContext(r);function l(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);