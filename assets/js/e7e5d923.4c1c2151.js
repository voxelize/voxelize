"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[4034],{43023:(e,t,a)=>{a.d(t,{R:()=>d,x:()=>o});var n=a(63696);const i={},s=n.createContext(i);function d(e){const t=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),n.createElement(s.Provider,{value:t},e.children)}},91856:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>o,default:()=>c,frontMatter:()=>d,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"intermediate/metadata-component","title":"Metadata Component","description":"Metadata is how entity state gets synchronized from server to client. The MetadataComp stores a JSON-serializable map that gets sent to clients whenever it changes.","source":"@site/docs/tutorials/intermediate/4-metadata-component.md","sourceDirName":"intermediate","slug":"/intermediate/metadata-component","permalink":"/tutorials/intermediate/metadata-component","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Custom Entity Creation","permalink":"/tutorials/intermediate/custom-entity-creation"},"next":{"title":"Customizing the ECS","permalink":"/tutorials/intermediate/customizing-the-ecs"}}');var i=a(62540),s=a(43023);const d={sidebar_position:4},o="Metadata Component",r={},l=[{value:"How Metadata Works",id:"how-metadata-works",level:2},{value:"Setting Metadata",id:"setting-metadata",level:2},{value:"Getting Metadata",id:"getting-metadata",level:2},{value:"Built-in Metadata Systems",id:"built-in-metadata-systems",level:2},{value:"EntitiesMetaSystem",id:"entitiesmetasystem",level:3},{value:"PeersMetaSystem",id:"peersmetasystem",level:3},{value:"Custom Metadata Systems",id:"custom-metadata-systems",level:2},{value:"Client-Side Data Types",id:"client-side-data-types",level:2},{value:"Partial Updates",id:"partial-updates",level:2},{value:"Metadata in Entity Loaders",id:"metadata-in-entity-loaders",level:2},{value:"Serialization Requirements",id:"serialization-requirements",level:2},{value:"Peer Metadata",id:"peer-metadata",level:2},{value:"Example: Complete Metadata Flow",id:"example-complete-metadata-flow",level:2}];function m(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"metadata-component",children:"Metadata Component"})}),"\n",(0,i.jsxs)(t.p,{children:["Metadata is how entity state gets synchronized from server to client. The ",(0,i.jsx)(t.code,{children:"MetadataComp"})," stores a JSON-serializable map that gets sent to clients whenever it changes."]}),"\n",(0,i.jsx)(t.h2,{id:"how-metadata-works",children:"How Metadata Works"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Server systems update ",(0,i.jsx)(t.code,{children:"MetadataComp"})," each tick"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"EntitiesSendingSystem"})," detects changes"]}),"\n",(0,i.jsx)(t.li,{children:"Changed metadata is sent to interested clients"}),"\n",(0,i.jsx)(t.li,{children:"Client receives data in entity lifecycle hooks"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"setting-metadata",children:"Setting Metadata"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"metadata.set()"})," to add typed data:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Setting Metadata"',children:'use serde::{Serialize, Deserialize};\n\n#[derive(Serialize, Deserialize)]\nstruct HealthData {\n    current: i32,\n    max: i32,\n}\n\nlet mut metadata = MetadataComp::default();\nmetadata.set("health", &HealthData { current: 80, max: 100 });\nmetadata.set("position", &PositionComp::new(10.0, 64.0, 10.0));\nmetadata.set("name", &"Bob".to_string());\n'})}),"\n",(0,i.jsx)(t.h2,{id:"getting-metadata",children:"Getting Metadata"}),"\n",(0,i.jsxs)(t.p,{children:["Retrieve typed data with ",(0,i.jsx)(t.code,{children:"metadata.get()"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Getting Metadata"',children:'let health: Option<HealthData> = metadata.get("health");\nlet position: Option<PositionComp> = metadata.get("position");\nlet name: Option<String> = metadata.get("name");\n'})}),"\n",(0,i.jsx)(t.h2,{id:"built-in-metadata-systems",children:"Built-in Metadata Systems"}),"\n",(0,i.jsx)(t.p,{children:"Voxelize includes systems that automatically sync common components:"}),"\n",(0,i.jsx)(t.h3,{id:"entitiesmetasystem",children:"EntitiesMetaSystem"}),"\n",(0,i.jsxs)(t.p,{children:["For non-client entities, syncs ",(0,i.jsx)(t.code,{children:"PositionComp"})," to metadata:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="EntitiesMetaSystem Behavior"',children:'// Automatically adds to all entities with EntityFlag:\nmetadata.set("position", &position_comp);\n'})}),"\n",(0,i.jsx)(t.h3,{id:"peersmetasystem",children:"PeersMetaSystem"}),"\n",(0,i.jsx)(t.p,{children:"For client entities, syncs position, direction, and name:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="PeersMetaSystem Behavior"',children:'// Automatically adds to all entities with ClientFlag:\nmetadata.set("position", &position_comp);\nmetadata.set("direction", &direction_comp);\nmetadata.set("username", &name_comp);\n'})}),"\n",(0,i.jsx)(t.h2,{id:"custom-metadata-systems",children:"Custom Metadata Systems"}),"\n",(0,i.jsx)(t.p,{children:"Create systems to sync your custom components:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Custom Metadata System"',children:"use specs::{System, ReadStorage, WriteStorage, Join};\n\npub struct HealthMetaSystem;\n\nimpl<'a> System<'a> for HealthMetaSystem {\n    type SystemData = (\n        ReadStorage<'a, HealthComp>,\n        WriteStorage<'a, MetadataComp>,\n    );\n\n    fn run(&mut self, (healths, mut metadatas): Self::SystemData) {\n        use rayon::prelude::*;\n        use specs::ParJoin;\n\n        (&healths, &mut metadatas)\n            .par_join()\n            .for_each(|(health, metadata)| {\n                metadata.set(\"health\", health);\n            });\n    }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Add to the dispatcher before ",(0,i.jsx)(t.code,{children:"EntitiesSendingSystem"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Adding to Dispatcher"',children:'.with(HealthMetaSystem, "health-meta", &[])\n.with(EntitiesSendingSystem, "entities-sending", &["entities-meta", "health-meta"])\n'})}),"\n",(0,i.jsx)(t.h2,{id:"client-side-data-types",children:"Client-Side Data Types"}),"\n",(0,i.jsx)(t.p,{children:"Define matching TypeScript types for your metadata:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="Client Data Types"',children:"type BotData = {\n  position: VOXELIZE.Coords3;\n  direction: number[];\n  health: {\n    current: number;\n    max: number;\n  };\n  name: string;\n};\n\nclass Bot extends VOXELIZE.Entity<BotData> {\n  onUpdate = (data: BotData) => {\n    this.position.set(...data.position);\n    this.updateHealthBar(data.health.current, data.health.max);\n    this.setName(data.name);\n  };\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"partial-updates",children:"Partial Updates"}),"\n",(0,i.jsx)(t.p,{children:"Only changed fields are sent. Metadata tracks what changed since last send:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Efficient Updates"',children:'// Only sends "health" field, not entire metadata\nmetadata.set("health", &new_health);\n\n// Position sent separately by EntitiesMetaSystem\n'})}),"\n",(0,i.jsx)(t.h2,{id:"metadata-in-entity-loaders",children:"Metadata in Entity Loaders"}),"\n",(0,i.jsx)(t.p,{children:"Access metadata passed during spawning:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Metadata in Loaders"',children:'world.set_entity_loader("npc", |world, metadata| {\n    let name = metadata.get::<String>("name").unwrap_or("NPC".to_string());\n    let health = metadata.get::<HealthComp>("health").unwrap_or(HealthComp(100));\n\n    world\n        .create_entity(&nanoid!(), "npc")\n        .with(PositionComp::default())\n        .with(health)\n        .with(NameComp::new(&name))\n        .with(metadata)\n});\n'})}),"\n",(0,i.jsx)(t.h2,{id:"serialization-requirements",children:"Serialization Requirements"}),"\n",(0,i.jsxs)(t.p,{children:["Components synced via metadata must implement ",(0,i.jsx)(t.code,{children:"Serialize"})," and ",(0,i.jsx)(t.code,{children:"Deserialize"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Serializable Component"',children:"use serde::{Serialize, Deserialize};\nuse specs::{Component, VecStorage};\n\n#[derive(Component, Default, Serialize, Deserialize, Clone)]\n#[storage(VecStorage)]\npub struct StatsComp {\n    pub kills: u32,\n    pub deaths: u32,\n    pub score: i32,\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"peer-metadata",children:"Peer Metadata"}),"\n",(0,i.jsx)(t.p,{children:"For client metadata (peers), use the client parser:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Client Parser"',children:"world.set_client_parser(|world, metadata_str, client_ent| {\n    let metadata: PeerUpdate = serde_json::from_str(metadata_str).unwrap();\n\n    if let Some(position) = metadata.position {\n        let mut positions = world.write_component::<PositionComp>();\n        if let Some(p) = positions.get_mut(client_ent) {\n            p.0.set(position.0, position.1, position.2);\n        }\n    }\n});\n"})}),"\n",(0,i.jsxs)(t.p,{children:["The client sends metadata via the ",(0,i.jsx)(t.code,{children:"Peers"})," manager:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="Client Peer Metadata"',children:"peers.packInfo(); // Returns position, direction, and custom data\n"})}),"\n",(0,i.jsx)(t.h2,{id:"example-complete-metadata-flow",children:"Example: Complete Metadata Flow"}),"\n",(0,i.jsx)(t.p,{children:"Server component and system:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Server Side"',children:"#[derive(Component, Default, Serialize, Deserialize)]\n#[storage(VecStorage)]\npub struct MoodComp(pub String);\n\npub struct MoodMetaSystem;\n\nimpl<'a> System<'a> for MoodMetaSystem {\n    type SystemData = (\n        ReadStorage<'a, MoodComp>,\n        WriteStorage<'a, MetadataComp>,\n    );\n\n    fn run(&mut self, (moods, mut metadatas): Self::SystemData) {\n        for (mood, metadata) in (&moods, &mut metadatas).join() {\n            metadata.set(\"mood\", mood);\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"Client entity:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-ts",metastring:'title="Client Side"',children:'type NPCData = {\n  position: VOXELIZE.Coords3;\n  mood: string;\n};\n\nclass NPC extends VOXELIZE.Entity<NPCData> {\n  private moodText: VOXELIZE.SpriteText;\n\n  constructor(id: string) {\n    super(id);\n    this.moodText = new VOXELIZE.SpriteText("...");\n    this.moodText.position.y = 2;\n    this.add(this.moodText);\n  }\n\n  onUpdate = (data: NPCData) => {\n    this.position.set(...data.position);\n    this.moodText.text = data.mood;\n  };\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Read on to learn about ",(0,i.jsx)(t.a,{href:"./customizing-the-ecs",children:"customizing the ECS dispatcher"}),"."]})]})}function c(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}}}]);