"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7808],{43023:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>r});var t=i(63696);const o={},s=t.createContext(o);function l(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),t.createElement(s.Provider,{value:n},e.children)}},67073:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"intermediate/collision-detection","title":"Collision Detection","description":"Voxelize uses Rapier physics for entity-to-entity collision detection. Entities with InteractorComp can detect when they collide with other interactors.","source":"@site/docs/tutorials/intermediate/7-collision-detection.md","sourceDirName":"intermediate","slug":"/intermediate/collision-detection","permalink":"/tutorials/intermediate/collision-detection","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"tutorialSidebar","previous":{"title":"Network Interception","permalink":"/tutorials/intermediate/network-interception"},"next":{"title":"The Events System","permalink":"/tutorials/intermediate/the-events-system"}}');var o=i(62540),s=i(43023);const l={sidebar_position:7},r="Collision Detection",c={},a=[{value:"Server-Side Collisions",id:"server-side-collisions",level:2},{value:"Setting Up Colliders",id:"setting-up-colliders",level:3},{value:"Reading Collisions",id:"reading-collisions",level:3},{value:"Collision Data",id:"collision-data",level:3},{value:"Client-Side Collisions",id:"client-side-collisions",level:2},{value:"Rigid Controls Collision",id:"rigid-controls-collision",level:3},{value:"Raycasting",id:"raycasting",level:3},{value:"Custom Collision Checks",id:"custom-collision-checks",level:3},{value:"Physics Properties",id:"physics-properties",level:2},{value:"Example: Pickup System",id:"example-pickup-system",level:2},{value:"Collision Repulsion",id:"collision-repulsion",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"collision-detection",children:"Collision Detection"})}),"\n",(0,o.jsxs)(n.p,{children:["Voxelize uses ",(0,o.jsx)(n.a,{href:"https://rapier.rs/",children:"Rapier physics"})," for entity-to-entity collision detection. Entities with ",(0,o.jsx)(n.code,{children:"InteractorComp"})," can detect when they collide with other interactors."]}),"\n",(0,o.jsx)(n.h2,{id:"server-side-collisions",children:"Server-Side Collisions"}),"\n",(0,o.jsx)(n.h3,{id:"setting-up-colliders",children:"Setting Up Colliders"}),"\n",(0,o.jsxs)(n.p,{children:["Entities need both ",(0,o.jsx)(n.code,{children:"RigidBodyComp"})," and ",(0,o.jsx)(n.code,{children:"InteractorComp"})," to participate in collision detection:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="Entity with Collider"',children:'world.set_entity_loader("enemy", |world, _| {\n    let body = RigidBody::new(\n        &AABB::new()\n            .scale_x(0.8)\n            .scale_y(1.8)\n            .scale_z(0.8)\n            .build()\n    ).build();\n\n    let interactor = world.physics_mut().register(&body);\n\n    world\n        .create_entity(&nanoid!(), "enemy")\n        .with(PositionComp::default())\n        .with(RigidBodyComp::new(&body))\n        .with(InteractorComp::new(&interactor))\n        .with(CollisionsComp::new())\n});\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"RigidBodyComp"})," - Defines the collision box shape and physics properties"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"InteractorComp"})," - Registers the body with Rapier for collision detection"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"CollisionsComp"})," - Stores collision results each frame"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"reading-collisions",children:"Reading Collisions"}),"\n",(0,o.jsx)(n.p,{children:"Create a system to process collisions:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="Collision Processing System"',children:"use specs::{System, ReadStorage, Join};\n\npub struct DamageOnCollisionSystem;\n\nimpl<'a> System<'a> for DamageOnCollisionSystem {\n    type SystemData = (\n        ReadStorage<'a, CollisionsComp>,\n        ReadStorage<'a, IDComp>,\n        WriteStorage<'a, HealthComp>,\n    );\n\n    fn run(&mut self, (collisions, ids, mut healths): Self::SystemData) {\n        for (collision, id, health) in (&collisions, &ids, &mut healths).join() {\n            for other_entity in &collision.0 {\n                // Entity collided with another interactor\n                health.0 = health.0.saturating_sub(1);\n            }\n        }\n    }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"collision-data",children:"Collision Data"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"CollisionsComp"})," contains a vector of entities that collided this frame:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="CollisionsComp Structure"',children:"pub struct CollisionsComp(pub Vec<Entity>);\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Collisions are cleared each frame by ",(0,o.jsx)(n.code,{children:"CleanupSystem"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"client-side-collisions",children:"Client-Side Collisions"}),"\n",(0,o.jsx)(n.h3,{id:"rigid-controls-collision",children:"Rigid Controls Collision"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"RigidControls"})," handles player-to-voxel collisions automatically. Configure collision behavior:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="RigidControls Collision Options"',children:"const controls = new VOXELIZE.RigidControls(camera, canvas, world, {\n  bodyWidth: 0.8,\n  bodyHeight: 1.8,\n  bodyDepth: 0.8,\n  stepHeight: 0.5,\n  maxSpeed: 8,\n});\n"})}),"\n",(0,o.jsx)(n.h3,{id:"raycasting",children:"Raycasting"}),"\n",(0,o.jsx)(n.p,{children:"Use raycasting to detect blocks or entities:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="Raycasting for Blocks"',children:"const voxelInteract = new VOXELIZE.VoxelInteract(camera, world, {\n  reachDistance: 5,\n});\n\nfunction update() {\n  voxelInteract.update();\n\n  if (voxelInteract.target) {\n    const { voxel, normal } = voxelInteract.target;\n    console.log(`Looking at block at ${voxel}`);\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"custom-collision-checks",children:"Custom Collision Checks"}),"\n",(0,o.jsx)(n.p,{children:"For custom entity collision on the client:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="Distance-Based Collision"',children:"class CollisionChecker {\n  checkCollision(\n    entity1: THREE.Object3D,\n    entity2: THREE.Object3D,\n    threshold: number\n  ): boolean {\n    const distance = entity1.position.distanceTo(entity2.position);\n    return distance < threshold;\n  }\n\n  checkPlayerNearEntity(\n    controls: VOXELIZE.RigidControls,\n    entity: THREE.Object3D,\n    threshold: number\n  ): boolean {\n    const playerPos = controls.object.position;\n    return playerPos.distanceTo(entity.position) < threshold;\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"physics-properties",children:"Physics Properties"}),"\n",(0,o.jsx)(n.p,{children:"Configure rigid body physics:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="Physics Configuration"',children:"let mut body = RigidBody::new(\n    &AABB::new()\n        .scale_x(0.5)\n        .scale_y(0.5)\n        .scale_z(0.5)\n        .build()\n).build();\n\nbody.gravity_multiplier = 1.0;  // Gravity scale\nbody.air_drag = 0.1;            // Air resistance\nbody.fluid_drag = 0.4;          // Water resistance\nbody.friction = 0.5;            // Ground friction\n"})}),"\n",(0,o.jsx)(n.h2,{id:"example-pickup-system",children:"Example: Pickup System"}),"\n",(0,o.jsx)(n.p,{children:"Detect when players collide with drops:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="Pickup System"',children:"pub struct PickupSystem;\n\nimpl<'a> System<'a> for PickupSystem {\n    type SystemData = (\n        Entities<'a>,\n        ReadStorage<'a, CollisionsComp>,\n        ReadStorage<'a, ClientFlag>,\n        ReadStorage<'a, DropComp>,\n        ReadStorage<'a, IDComp>,\n        Write<'a, Events>,\n    );\n\n    fn run(&mut self, data: Self::SystemData) {\n        let (entities, collisions, clients, drops, ids, mut events) = data;\n\n        for (entity, collision, _, id) in (&entities, &collisions, &clients, &ids).join() {\n            for &other in &collision.0 {\n                if let Some(drop) = drops.get(other) {\n                    // Player collided with a drop\n                    events.dispatch(\n                        Event::new(\"pickup\")\n                            .payload(serde_json::json!({\n                                \"playerId\": id.0,\n                                \"itemId\": drop.item_id,\n                            }))\n                            .build()\n                    );\n\n                    // Delete the drop entity\n                    entities.delete(other).ok();\n                }\n            }\n        }\n    }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"collision-repulsion",children:"Collision Repulsion"}),"\n",(0,o.jsx)(n.p,{children:"Configure how entities push each other apart:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-rust",metastring:'title="World Config Collision Settings"',children:"let config = WorldConfig::new()\n    .collision_repulsion(1.0)        // Entity-entity repulsion strength\n    .client_collision_repulsion(0.2) // Player-entity repulsion strength\n    .build();\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Read on to learn about ",(0,o.jsx)(n.a,{href:"./the-events-system",children:"the events system"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);