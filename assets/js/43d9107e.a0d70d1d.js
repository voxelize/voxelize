"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1086],{43023:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>c});var s=n(63696);const i={},a=s.createContext(i);function r(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:t},e.children)}},63392:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"intermediate/customizing-the-ecs","title":"Customizing the ECS","description":"Voxelize\'s server runs on Specs ECS, which executes systems in parallel each game tick. You can customize the dispatcher to add your own systems, modify execution order, or extend built-in behaviors.","source":"@site/docs/tutorials/intermediate/5-customizing-the-ecs.md","sourceDirName":"intermediate","slug":"/intermediate/customizing-the-ecs","permalink":"/tutorials/intermediate/customizing-the-ecs","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Metadata Component","permalink":"/tutorials/intermediate/metadata-component"},"next":{"title":"Network Interception","permalink":"/tutorials/intermediate/network-interception"}}');var i=n(62540),a=n(43023);const r={sidebar_position:5},c="Customizing the ECS",o={},d=[{value:"Setting a Custom Dispatcher",id:"setting-a-custom-dispatcher",level:2},{value:"Creating Custom Systems",id:"creating-custom-systems",level:2},{value:"Syncing to Metadata",id:"syncing-to-metadata",level:2},{value:"Parallel Execution",id:"parallel-execution",level:2},{value:"Accessing World Resources",id:"accessing-world-resources",level:2},{value:"System Dependencies Graph",id:"system-dependencies-graph",level:2}];function l(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"customizing-the-ecs",children:"Customizing the ECS"})}),"\n",(0,i.jsxs)(t.p,{children:["Voxelize's server runs on ",(0,i.jsx)(t.a,{href:"https://specs.amethyst.rs/docs/tutorials/",children:"Specs ECS"}),", which executes systems in parallel each game tick. You can customize the dispatcher to add your own systems, modify execution order, or extend built-in behaviors."]}),"\n",(0,i.jsx)(t.h2,{id:"setting-a-custom-dispatcher",children:"Setting a Custom Dispatcher"}),"\n",(0,i.jsxs)(t.p,{children:["Use ",(0,i.jsx)(t.code,{children:"world.set_dispatcher()"})," to define which systems run and their dependencies:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Custom Dispatcher Setup"',children:'use specs::DispatcherBuilder;\n\nworld.set_dispatcher(|| {\n    DispatcherBuilder::new()\n        // Core systems\n        .with(UpdateStatsSystem, "update-stats", &[])\n        .with(EntitiesMetaSystem, "entities-meta", &[])\n        .with(PeersMetaSystem, "peers-meta", &[])\n        .with(CurrentChunkSystem, "current-chunk", &[])\n        // Chunk systems\n        .with(ChunkUpdatingSystem, "chunk-updating", &["current-chunk"])\n        .with(ChunkRequestsSystem, "chunk-requests", &["current-chunk"])\n        .with(ChunkGeneratingSystem, "chunk-generation", &["chunk-requests"])\n        .with(ChunkSendingSystem, "chunk-sending", &["chunk-generation"])\n        .with(ChunkSavingSystem, "chunk-saving", &["chunk-generation"])\n        // Physics\n        .with(PhysicsSystem, "physics", &["current-chunk", "update-stats"])\n        // Persistence & network\n        .with(DataSavingSystem, "entities-saving", &["entities-meta"])\n        .with(EntitiesSendingSystem, "entities-sending", &["entities-meta"])\n        .with(PeersSendingSystem, "peers-sending", &["peers-meta"])\n        .with(\n            BroadcastSystem,\n            "broadcast",\n            &["chunk-sending", "entities-sending", "peers-sending"],\n        )\n        .with(CleanupSystem, "cleanup", &["entities-sending", "peers-sending"])\n        .with(EventsSystem, "events", &["broadcast"])\n        // AI systems (optional)\n        .with(EntityTreeSystem, "entity-tree", &[])\n        .with(EntityObserveSystem, "entity-observe", &[])\n        .with(PathFindingSystem, "path-finding", &["entity-observe"])\n        .with(WalkTowardsSystem, "walk-towards", &["path-finding"])\n        .with(TargetMetadataSystem, "target-meta", &[])\n        .with(PathMetadataSystem, "path-meta", &[])\n        // Your custom systems\n        .with(MyCustomSystem, "my-custom", &["entities-meta"])\n});\n'})}),"\n",(0,i.jsxs)(t.p,{children:["The third argument to ",(0,i.jsx)(t.code,{children:".with()"})," lists dependencies. A system only runs after all its dependencies complete."]}),"\n",(0,i.jsx)(t.h2,{id:"creating-custom-systems",children:"Creating Custom Systems"}),"\n",(0,i.jsxs)(t.p,{children:["Systems operate on components each tick. Here's a system that applies gravity to entities with a custom ",(0,i.jsx)(t.code,{children:"VelocityComp"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Custom Velocity System"',children:"use specs::{System, ReadExpect, WriteStorage, Join};\n\n#[derive(Component, Default)]\n#[storage(VecStorage)]\nstruct VelocityComp(pub Vec3<f32>);\n\nstruct GravitySystem;\n\nimpl<'a> System<'a> for GravitySystem {\n    type SystemData = (\n        ReadExpect<'a, Stats>,\n        WriteStorage<'a, VelocityComp>,\n    );\n\n    fn run(&mut self, (stats, mut velocities): Self::SystemData) {\n        let delta = stats.delta;\n\n        for velocity in (&mut velocities).join() {\n            velocity.0.1 -= 9.8 * delta;\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"Register the component and add the system to your dispatcher:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Registering Custom Components"',children:'world.ecs().register::<VelocityComp>();\n\nworld.set_dispatcher(|| {\n    // ... other systems ...\n    DispatcherBuilder::new()\n        .with(GravitySystem, "gravity", &["update-stats"])\n        // ... rest of dispatcher ...\n});\n'})}),"\n",(0,i.jsx)(t.h2,{id:"syncing-to-metadata",children:"Syncing to Metadata"}),"\n",(0,i.jsxs)(t.p,{children:["To send custom component data to clients, sync it to ",(0,i.jsx)(t.code,{children:"MetadataComp"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Metadata Sync System"',children:"struct VelocityMetaSystem;\n\nimpl<'a> System<'a> for VelocityMetaSystem {\n    type SystemData = (\n        ReadStorage<'a, VelocityComp>,\n        WriteStorage<'a, MetadataComp>,\n    );\n\n    fn run(&mut self, (velocities, mut metadatas): Self::SystemData) {\n        use rayon::prelude::*;\n        use specs::ParJoin;\n\n        (&velocities, &mut metadatas)\n            .par_join()\n            .for_each(|(velocity, metadata)| {\n                metadata.set::<VelocityComp>(\"velocity\", velocity);\n            });\n    }\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Add this system before ",(0,i.jsx)(t.code,{children:"EntitiesSendingSystem"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Adding Metadata Sync to Dispatcher"',children:'.with(VelocityMetaSystem, "velocity-meta", &[])\n.with(EntitiesSendingSystem, "entities-sending", &["entities-meta", "velocity-meta"])\n'})}),"\n",(0,i.jsx)(t.h2,{id:"parallel-execution",children:"Parallel Execution"}),"\n",(0,i.jsxs)(t.p,{children:["Specs runs systems in parallel when their dependencies allow. Use ",(0,i.jsx)(t.code,{children:"ParJoin"})," for parallel iteration within a system:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Parallel System Execution"',children:"fn run(&mut self, (read_a, mut write_b): Self::SystemData) {\n    use rayon::prelude::*;\n    use specs::ParJoin;\n\n    (&read_a, &mut write_b)\n        .par_join()\n        .for_each(|(a, b)| {\n            // Process each entity in parallel\n        });\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"accessing-world-resources",children:"Accessing World Resources"}),"\n",(0,i.jsx)(t.p,{children:"Systems can access shared resources:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-rust",metastring:'title="Accessing Resources in Systems"',children:"impl<'a> System<'a> for MySystem {\n    type SystemData = (\n        ReadExpect<'a, Stats>,\n        ReadExpect<'a, WorldConfig>,\n        ReadExpect<'a, Chunks>,\n        Write<'a, Events>,\n    );\n\n    fn run(&mut self, (stats, config, chunks, mut events): Self::SystemData) {\n        let delta = stats.delta;\n        let chunk_size = config.chunk_size;\n\n        // Use chunks.get_voxel() to read voxel data\n        let voxel = chunks.get_voxel(0, 64, 0);\n\n        // Dispatch events to clients\n        events.dispatch(Event::new(\"my-event\").payload(\"data\").build());\n    }\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"system-dependencies-graph",children:"System Dependencies Graph"}),"\n",(0,i.jsx)(t.p,{children:"When designing your dispatcher, consider the data flow:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Stats & Positions first"})," - Other systems depend on updated positions and delta time"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Chunk systems"})," - Generate and mesh chunks based on requests"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Physics"})," - Needs current positions and stats"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"AI systems"})," - Build spatial index, find targets, compute paths, execute movement"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Metadata sync"})," - Sync component changes before sending"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Network"})," - Send updates to clients"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.strong,{children:"Cleanup"})," - Clear per-frame data"]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For more details on the default systems, see the ",(0,i.jsx)(t.a,{href:"/tutorials/intermediate/entity-component-system",children:"Entity Component System"})," tutorial."]})]})}function h(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);