"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2144],{36151:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"intermediate/typescript-transport","title":"TypeScript Transport","description":"The Transport class is a server-side WebSocket client that connects to the Voxelize game server from an external Node.js process. It receives the same real-time events that browser clients receive (player joins, chat messages, entity updates), enabling you to build services that react to game activity.","source":"@site/docs/tutorials/intermediate/13-typescript-transport.md","sourceDirName":"intermediate","slug":"/intermediate/typescript-transport","permalink":"/tutorials/intermediate/typescript-transport","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"sidebar_position":13},"sidebar":"tutorialSidebar","previous":{"title":"Custom Blocks","permalink":"/tutorials/intermediate/custom-blocks"}}');var s=t(62540),a=t(43023);const i={sidebar_position:13},o="TypeScript Transport",c={},l=[{value:"Why Use Transport?",id:"why-use-transport",level:2},{value:"Basic Setup",id:"basic-setup",level:2},{value:"Event Handlers",id:"event-handlers",level:2},{value:"Example: Discord Bot Bridge",id:"example-discord-bot-bridge",level:2},{value:"Step 1: Track Player Info",id:"step-1-track-player-info",level:3},{value:"Step 2: Handle Join/Leave",id:"step-2-handle-joinleave",level:3},{value:"Step 3: Forward Chat Messages",id:"step-3-forward-chat-messages",level:3},{value:"Full Implementation",id:"full-implementation",level:3},{value:"Example: Asset Cleanup Service",id:"example-asset-cleanup-service",level:2},{value:"Step 1: Track Block Entities",id:"step-1-track-block-entities",level:3},{value:"Step 2: Clean Up on Block Destruction",id:"step-2-clean-up-on-block-destruction",level:3},{value:"Connection Lifecycle",id:"connection-lifecycle",level:2},{value:"When to Use Transport vs Other Patterns",id:"when-to-use-transport-vs-other-patterns",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"typescript-transport",children:"TypeScript Transport"})}),"\n",(0,s.jsx)(n.p,{children:"The Transport class is a server-side WebSocket client that connects to the Voxelize game server from an external Node.js process. It receives the same real-time events that browser clients receive (player joins, chat messages, entity updates), enabling you to build services that react to game activity."}),"\n",(0,s.jsxs)(n.p,{children:["For a quick reference on Transport concepts, see the ",(0,s.jsx)(n.a,{href:"/wiki/networking/transport",children:"Transport wiki page"}),"."]}),"\n",(0,s.jsx)(n.mermaid,{value:'flowchart LR\n    subgraph External["Your Node.js Service"]\n        T[Transport]\n    end\n\n    subgraph Voxelize["Voxelize Server (Rust)"]\n        WS[WebSocket]\n        W[World]\n    end\n\n    subgraph Clients["Browser Clients"]\n        C1[Player 1]\n        C2[Player 2]\n    end\n\n    T <--\x3e|"Authenticated"| WS\n    C1 <--\x3e WS\n    C2 <--\x3e WS\n    WS <--\x3e W'}),"\n",(0,s.jsx)(n.h2,{id:"why-use-transport",children:"Why Use Transport?"}),"\n",(0,s.jsx)(n.p,{children:"Transport connects external services to your game world. Some examples:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"External Service"}),(0,s.jsx)(n.th,{children:"What It Does"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Discord bot"}),(0,s.jsx)(n.td,{children:'Posts "Player joined" messages to a channel when someone enters the game'})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Express API"}),(0,s.jsx)(n.td,{children:"Tracks entity positions so a REST endpoint can query game state"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Analytics service"}),(0,s.jsx)(n.td,{children:"Logs player activity, chat messages, block placements to a database"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Asset manager"}),(0,s.jsx)(n.td,{children:"Deletes uploaded images when picture-frame blocks are destroyed"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["The key insight: ",(0,s.jsx)(n.strong,{children:"Transport runs outside the browser"}),". It's for backend services that need game data, not for game clients."]}),"\n",(0,s.jsx)(n.h2,{id:"basic-setup",children:"Basic Setup"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Connecting to Voxelize"',children:'import { Transport } from "@voxelize/protocol";\n\nconst transport = new Transport(5000);\n\nawait transport.connect("http://localhost:4000", "your-secret-key");\n'})}),"\n",(0,s.jsx)(n.p,{children:"The secret authenticates the Transport as a trusted listener. Configure it on your Voxelize server."}),"\n",(0,s.jsx)(n.h2,{id:"event-handlers",children:"Event Handlers"}),"\n",(0,s.jsx)(n.p,{children:"Assign callbacks to react to game events:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Available Handlers"',children:"transport.onInit; // World initialized with existing state\ntransport.onJoin; // Player connected\ntransport.onLeave; // Player disconnected\ntransport.onPeer; // Player position/metadata changed\ntransport.onEntity; // Entity created/updated/deleted\ntransport.onChat; // Chat message sent\ntransport.onUpdate; // Voxel changed\ntransport.onMethod; // RPC call received\ntransport.onEvent; // Custom event fired\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"example-discord-bot-bridge",children:"Example: Discord Bot Bridge"}),"\n",(0,s.jsx)(n.p,{children:"This example builds a Discord bot that announces when players join, leave, or chat in your Voxelize world."}),"\n",(0,s.jsx)(n.mermaid,{value:'sequenceDiagram\n    participant Player\n    participant Voxelize\n    participant Transport\n    participant Discord\n\n    Player->>Voxelize: Joins world\n    Voxelize->>Transport: JOIN event\n    Transport->>Discord: "Alice joined #lobby"\n\n    Player->>Voxelize: Types "hello everyone"\n    Voxelize->>Transport: CHAT event\n    Transport->>Discord: "Alice: hello everyone"\n\n    Player->>Voxelize: Disconnects\n    Voxelize->>Transport: LEAVE event\n    Transport->>Discord: "Alice left"'}),"\n",(0,s.jsx)(n.h3,{id:"step-1-track-player-info",children:"Step 1: Track Player Info"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"onPeer"})," event provides player metadata. Cache it so we can look up usernames later:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Player Cache"',children:"const playerCache = new Map<string, { username: string }>();\n\ntransport.onPeer = (event) => {\n  event.peers?.forEach((peer) => {\n    playerCache.set(peer.id, { username: peer.username });\n  });\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-2-handle-joinleave",children:"Step 2: Handle Join/Leave"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Join and Leave Events"',children:"transport.onJoin = async (event) => {\n  const peerId = event.text;\n  const worldName = event.worldName;\n  const player = playerCache.get(peerId);\n\n  await discord.send(`**${player?.username}** joined *${worldName}*`);\n};\n\ntransport.onLeave = async (event) => {\n  const peerId = event.text;\n  const player = playerCache.get(peerId);\n\n  await discord.send(`**${player?.username}** left`);\n  playerCache.delete(peerId);\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"step-3-forward-chat-messages",children:"Step 3: Forward Chat Messages"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Chat Forwarding"',children:"transport.onChat = async (event) => {\n  const { chat, worldName } = event;\n  const username = chat.sender;\n  const message = chat.body;\n\n  await discord.send(`**${username}** (${worldName}): ${message}`);\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"full-implementation",children:"Full Implementation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="discord-bridge.ts"',children:'import { Transport } from "@voxelize/protocol";\nimport { Client, GatewayIntentBits, TextChannel } from "discord.js";\n\nconst discord = new Client({ intents: [GatewayIntentBits.Guilds] });\nconst transport = new Transport(5000);\nconst playerCache = new Map<string, { username: string }>();\n\nlet channel: TextChannel;\n\nasync function main() {\n  await discord.login(process.env.DISCORD_TOKEN);\n  channel = (await discord.channels.fetch(\n    process.env.CHANNEL_ID\n  )) as TextChannel;\n\n  await transport.connect(\n    process.env.VOXELIZE_URL,\n    process.env.VOXELIZE_SECRET\n  );\n\n  transport.onPeer = (event) => {\n    event.peers?.forEach((peer) => {\n      playerCache.set(peer.id, { username: peer.username });\n    });\n  };\n\n  transport.onJoin = async (event) => {\n    const player = playerCache.get(event.text);\n    await channel.send(`**${player?.username}** joined *${event.worldName}*`);\n  };\n\n  transport.onLeave = async (event) => {\n    const player = playerCache.get(event.text);\n    await channel.send(`**${player?.username}** left`);\n    playerCache.delete(event.text);\n  };\n\n  transport.onChat = async (event) => {\n    const { chat, worldName } = event;\n    await channel.send(`**${chat.sender}** (${worldName}): ${chat.body}`);\n  };\n\n  console.log("Discord bridge running");\n}\n\nmain();\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"example-asset-cleanup-service",children:"Example: Asset Cleanup Service"}),"\n",(0,s.jsx)(n.p,{children:'When players place "picture frame" blocks, they upload images. When those blocks are destroyed, the images become orphaned. This service watches for block deletions and cleans up the associated files.'}),"\n",(0,s.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Player\n    participant Voxelize\n    participant Transport\n    participant Storage\n\n    Player->>Voxelize: Places picture frame\n    Voxelize->>Transport: ENTITY CREATE\n    Transport->>Transport: Track entity + image URL\n\n    Player->>Voxelize: Breaks picture frame\n    Voxelize->>Transport: UPDATE (voxel = 0)\n    Transport->>Storage: Delete image file"}),"\n",(0,s.jsx)(n.h3,{id:"step-1-track-block-entities",children:"Step 1: Track Block Entities"}),"\n",(0,s.jsx)(n.p,{children:"Build a mapping from voxel positions to entity metadata:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Entity Tracking"',children:'type BlockMetadata = {\n  type: string;\n  imageSource?: string;\n};\n\nconst entityMap = new Map<string, BlockMetadata>();\nconst voxelToEntity = new Map<string, string>();\n\ntransport.onEntity = (event) => {\n  event.entities?.forEach((entity) => {\n    if (!entity.type.startsWith("block::")) return;\n\n    const { id, operation, metadata } = entity;\n    const voxelKey = metadata.voxel.join(",");\n\n    if (operation === "CREATE" || operation === "UPDATE") {\n      entityMap.set(id, metadata);\n      voxelToEntity.set(voxelKey, id);\n    } else if (operation === "DELETE") {\n      entityMap.delete(id);\n    }\n  });\n};\n'})}),"\n",(0,s.jsx)(n.h3,{id:"step-2-clean-up-on-block-destruction",children:"Step 2: Clean Up on Block Destruction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Image Cleanup"',children:'transport.onUpdate = async (event) => {\n  for (const update of event.updates) {\n    if (update.voxel !== 0) continue;\n\n    const voxelKey = `${update.vx},${update.vy},${update.vz}`;\n    const entityId = voxelToEntity.get(voxelKey);\n    if (!entityId) continue;\n\n    const metadata = entityMap.get(entityId);\n    if (metadata?.type === "picture-frame" && metadata.imageSource) {\n      await deleteFromStorage(metadata.imageSource);\n      console.log(`Cleaned up: ${metadata.imageSource}`);\n    }\n\n    voxelToEntity.delete(voxelKey);\n    entityMap.delete(entityId);\n  }\n};\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"connection-lifecycle",children:"Connection Lifecycle"}),"\n",(0,s.jsx)(n.p,{children:"Transport auto-reconnects when the connection drops:"}),"\n",(0,s.jsx)(n.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Connecting: connect()\n    Connecting --\x3e Connected: Open\n    Connecting --\x3e Reconnecting: Failed\n    Connected --\x3e Reconnecting: Closed\n    Reconnecting --\x3e Connecting: After timeout"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="Reconnection"',children:"const transport = new Transport(5000); // Retry every 5 seconds\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"when-to-use-transport-vs-other-patterns",children:"When to Use Transport vs Other Patterns"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Need"}),(0,s.jsx)(n.th,{children:"Use"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"External service needs game data"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Transport"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Client triggers server action"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/wiki/networking/calling-methods",children:"Methods"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Server broadcasts to clients"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/wiki/networking/handling-events",children:"Events"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Sync entity state to clients"}),(0,s.jsx)(n.td,{children:"Entity metadata"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["Transport is for ",(0,s.jsx)(n.strong,{children:"out-of-game services"}),". For in-game client-server communication, use Methods and Events instead."]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},43023:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>o});var r=t(63696);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);