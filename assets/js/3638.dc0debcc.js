"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3638],{3638:(g,I,C)=>{C.r(I),C.d(I,{AnimationUtils:()=>Q,Arm:()=>gI,Arrow:()=>CI,AtlasTexture:()=>ZC,BLUE_LIGHT:()=>bg,BOX_SIDES:()=>yg,BlockOverlayEffect:()=>tI,BlockRotation:()=>sg,BlockRuleLogic:()=>P,BlockUtils:()=>eg,BoxLayer:()=>Vg,CanvasBox:()=>Kg,Character:()=>Dg,Chat:()=>LI,Chunk:()=>lC,ChunkUtils:()=>dg,Clouds:()=>T,ColorText:()=>Sg,DEFAULT_CHUNK_SHADERS:()=>aC,DOMUtils:()=>cg,Debug:()=>iI,Entities:()=>EI,Entity:()=>OI,Events:()=>qI,FaceAnimation:()=>mC,GREEN_LIGHT:()=>mg,Inputs:()=>$I,ItemSlot:()=>BI,ItemSlots:()=>WI,LightShined:()=>cI,LightUtils:()=>hg,Loader:()=>nC,MathUtils:()=>pg,Method:()=>_I,MobileRigidControls:()=>UI,NX_ROTATION:()=>E,NY_ROTATION:()=>U,NZ_ROTATION:()=>$,NameTag:()=>Fg,Network:()=>AC,OPAQUE_RENDER_ORDER:()=>hI,PX_ROTATION:()=>O,PY_ROTATION:()=>j,PZ_ROTATION:()=>q,Peers:()=>oC,Perspective:()=>rI,Portrait:()=>KI,RED_LIGHT:()=>Zg,Registry:()=>cC,RigidControls:()=>jI,SUNLIGHT:()=>Gg,Shadow:()=>eI,Shadows:()=>lI,SharedWorkerPool:()=>vI,Sky:()=>Yg,SpriteText:()=>Rg,TRANSPARENT_RENDER_ORDER:()=>aI,TRANSPARENT_SORT:()=>mI,ThreeUtils:()=>ug,VoxelInteract:()=>MI,WorkerPool:()=>F,World:()=>VC,Y_ROT_MAP:()=>gg,Y_ROT_MAP_EIGHT:()=>Ig,Y_ROT_MAP_FOUR:()=>Cg,Y_ROT_SEGMENTS:()=>_,artFunctions:()=>Xg,cull:()=>M,customShaders:()=>hC,defaultArmsOptions:()=>Lg,defaultBodyOptions:()=>Mg,defaultCharacterOptions:()=>vg,defaultHeadOptions:()=>zg,defaultLegsOptions:()=>xg,noop:()=>bI,requestWorkerAnimationFrame:()=>HI,setWorkerInterval:()=>FI});var A=C(4628),i=C(7858),t=class{constructor(g,I,C,A,i,s){this.minX=g,this.minY=I,this.minZ=C,this.maxX=A,this.maxY=i,this.maxZ=s,this.getMin=g=>{if(0===g)return this.minX;if(1===g)return this.minY;if(2===g)return this.minZ;throw new Error("GetMinError: Unknown axis.")},this.setMin=(g,I)=>{if(0===g)this.minX=I;else if(1===g)this.minY=I;else{if(2!==g)throw new Error("SetMinError: Unknown axis.");this.minZ=I}},this.getMax=g=>{if(0===g)return this.maxX;if(1===g)return this.maxY;if(2===g)return this.maxZ;throw new Error("GetMaxError: Unknown axis.")},this.setMax=(g,I)=>{if(0===g)this.maxX=I;else if(1===g)this.maxY=I;else{if(2!==g)throw new Error("SetMaxError: Unknown axis.");this.maxZ=I}},this.translate=([g,I,C])=>(this.minX+=g,this.minY+=I,this.minZ+=C,this.maxX+=g,this.maxY+=I,this.maxZ+=C,this),this.translateAxis=(g,I)=>{if(0===g)this.minX+=I,this.maxX+=I;else if(1===g)this.minY+=I,this.maxY+=I;else{if(2!==g)throw new Error("TranslateAxisError: Unknown axis.");this.minZ+=I,this.maxZ+=I}return this},this.setPosition=([g,I,C])=>(this.maxX=g+this.width,this.maxY=I+this.height,this.maxZ=C+this.depth,this.minX=g,this.minY=I,this.minZ=C,this),this.intersects=g=>!(g.minX>=this.maxX)&&(!(g.minY>=this.maxY)&&(!(g.minZ>=this.maxZ)&&(!(g.maxX<=this.minX)&&(!(g.maxY<=this.minY)&&!(g.maxZ<=this.minZ))))),this.touches=g=>{const I=this.intersection(g);return null!==I&&(0===I.width||0===I.height||0===I.depth)},this.union=g=>new t(Math.min(this.minX,g.minX),Math.min(this.minY,g.minY),Math.min(this.minZ,g.minZ),Math.max(this.maxX,g.maxX),Math.max(this.maxY,g.maxY),Math.max(this.maxZ,g.maxZ)),this.intersection=g=>new t(Math.max(this.minX,g.minX),Math.max(this.minY,g.minY),Math.max(this.minZ,g.minZ),Math.min(this.maxX,g.maxX),Math.min(this.maxY,g.maxY),Math.min(this.maxZ,g.maxZ)),this.clone=()=>new t(this.minX,this.minY,this.minZ,this.maxX,this.maxY,this.maxZ)}get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}get depth(){return this.maxZ-this.minZ}get mag(){return Math.sqrt((this.maxX-this.minX)**2+(this.maxY-this.minY)**2+(this.maxZ-this.minZ)**2)}computeOffsetX(g,I){const C=this.intersection(g);return C.height<=0||C.depth<=0?I:C.width>=0?0:I>0&&g.minX>=this.maxX?Math.min(g.minX-this.maxX,I):I<0&&g.maxX<=this.minX?Math.max(g.maxX-this.minX,I):I}computeOffsetY(g,I){const C=this.intersection(g);return C.width<=0||C.depth<=0?I:C.height>=0?0:I>0&&g.minY>=this.maxY?Math.min(g.minY-this.maxY,I):I<0&&g.maxY<=this.minY?Math.max(g.maxY-this.minY,I):I}computeOffsetZ(g,I){const C=this.intersection(g);return C.width<=0||C.height<=0?I:C.depth>=0?0:I>0&&g.minZ>=this.maxZ?Math.min(g.minZ-this.maxZ,I):I<0&&g.maxZ<=this.minZ?Math.max(g.maxZ-this.minZ,I):I}},s=t;s.union=g=>{let I=g[0].minX,C=g[0].minY,A=g[0].minZ,i=g[0].maxX,s=g[0].maxY,o=g[0].maxZ;for(const t of g)I=Math.min(I,t.minX),C=Math.min(C,t.minY),A=Math.min(A,t.minZ),i=Math.max(i,t.maxX),s=Math.max(s,t.maxY),o=Math.max(o,t.maxZ);return new t(I,C,A,i,s,o)};var o=C(6271),e=C(1540),l=C(6704),d=C(4579),n=C(381),c=C(4063),a=C(1024);const h=a.Reader,Z=a.Writer,m=a.util,b=a.roots.default||(a.roots.default={}),G=b.protocol=(()=>{const g={};return g.Geometry=function(){function g(g){if(this.at=[],this.positions=[],this.uvs=[],this.indices=[],this.lights=[],g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}let I;return g.prototype.voxel=0,g.prototype.faceName=null,g.prototype.at=m.emptyArray,g.prototype.positions=m.emptyArray,g.prototype.uvs=m.emptyArray,g.prototype.indices=m.emptyArray,g.prototype.lights=m.emptyArray,Object.defineProperty(g.prototype,"_faceName",{get:m.oneOfGetter(I=["faceName"]),set:m.oneOfSetter(I)}),g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=Z.create()),null!=g.voxel&&Object.hasOwnProperty.call(g,"voxel")&&I.uint32(8).uint32(g.voxel),null!=g.faceName&&Object.hasOwnProperty.call(g,"faceName")&&I.uint32(18).string(g.faceName),null!=g.at&&g.at.length){I.uint32(26).fork();for(let C=0;C<g.at.length;++C)I.int32(g.at[C]);I.ldelim()}if(null!=g.positions&&g.positions.length){I.uint32(34).fork();for(let C=0;C<g.positions.length;++C)I.float(g.positions[C]);I.ldelim()}if(null!=g.uvs&&g.uvs.length){I.uint32(42).fork();for(let C=0;C<g.uvs.length;++C)I.float(g.uvs[C]);I.ldelim()}if(null!=g.indices&&g.indices.length){I.uint32(50).fork();for(let C=0;C<g.indices.length;++C)I.int32(g.indices[C]);I.ldelim()}if(null!=g.lights&&g.lights.length){I.uint32(58).fork();for(let C=0;C<g.lights.length;++C)I.int32(g.lights[C]);I.ldelim()}return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Geometry;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.voxel=g.uint32();break;case 2:A.faceName=g.string();break;case 3:if(A.at&&A.at.length||(A.at=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.at.push(g.int32())}else A.at.push(g.int32());break;case 4:if(A.positions&&A.positions.length||(A.positions=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.positions.push(g.float())}else A.positions.push(g.float());break;case 5:if(A.uvs&&A.uvs.length||(A.uvs=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.uvs.push(g.float())}else A.uvs.push(g.float());break;case 6:if(A.indices&&A.indices.length||(A.indices=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.indices.push(g.int32())}else A.indices.push(g.int32());break;case 7:if(A.lights&&A.lights.length||(A.lights=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.lights.push(g.int32())}else A.lights.push(g.int32());break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.voxel&&g.hasOwnProperty("voxel")&&!m.isInteger(g.voxel))return"voxel: integer expected";if(null!=g.faceName&&g.hasOwnProperty("faceName")&&!m.isString(g.faceName))return"faceName: string expected";if(null!=g.at&&g.hasOwnProperty("at")){if(!Array.isArray(g.at))return"at: array expected";for(let I=0;I<g.at.length;++I)if(!m.isInteger(g.at[I]))return"at: integer[] expected"}if(null!=g.positions&&g.hasOwnProperty("positions")){if(!Array.isArray(g.positions))return"positions: array expected";for(let I=0;I<g.positions.length;++I)if("number"!=typeof g.positions[I])return"positions: number[] expected"}if(null!=g.uvs&&g.hasOwnProperty("uvs")){if(!Array.isArray(g.uvs))return"uvs: array expected";for(let I=0;I<g.uvs.length;++I)if("number"!=typeof g.uvs[I])return"uvs: number[] expected"}if(null!=g.indices&&g.hasOwnProperty("indices")){if(!Array.isArray(g.indices))return"indices: array expected";for(let I=0;I<g.indices.length;++I)if(!m.isInteger(g.indices[I]))return"indices: integer[] expected"}if(null!=g.lights&&g.hasOwnProperty("lights")){if(!Array.isArray(g.lights))return"lights: array expected";for(let I=0;I<g.lights.length;++I)if(!m.isInteger(g.lights[I]))return"lights: integer[] expected"}return null},g.fromObject=function(g){if(g instanceof b.protocol.Geometry)return g;let I=new b.protocol.Geometry;if(null!=g.voxel&&(I.voxel=g.voxel>>>0),null!=g.faceName&&(I.faceName=String(g.faceName)),g.at){if(!Array.isArray(g.at))throw TypeError(".protocol.Geometry.at: array expected");I.at=[];for(let C=0;C<g.at.length;++C)I.at[C]=0|g.at[C]}if(g.positions){if(!Array.isArray(g.positions))throw TypeError(".protocol.Geometry.positions: array expected");I.positions=[];for(let C=0;C<g.positions.length;++C)I.positions[C]=Number(g.positions[C])}if(g.uvs){if(!Array.isArray(g.uvs))throw TypeError(".protocol.Geometry.uvs: array expected");I.uvs=[];for(let C=0;C<g.uvs.length;++C)I.uvs[C]=Number(g.uvs[C])}if(g.indices){if(!Array.isArray(g.indices))throw TypeError(".protocol.Geometry.indices: array expected");I.indices=[];for(let C=0;C<g.indices.length;++C)I.indices[C]=0|g.indices[C]}if(g.lights){if(!Array.isArray(g.lights))throw TypeError(".protocol.Geometry.lights: array expected");I.lights=[];for(let C=0;C<g.lights.length;++C)I.lights[C]=0|g.lights[C]}return I},g.toObject=function(g,I){I||(I={});let C={};if((I.arrays||I.defaults)&&(C.at=[],C.positions=[],C.uvs=[],C.indices=[],C.lights=[]),I.defaults&&(C.voxel=0),null!=g.voxel&&g.hasOwnProperty("voxel")&&(C.voxel=g.voxel),null!=g.faceName&&g.hasOwnProperty("faceName")&&(C.faceName=g.faceName,I.oneofs&&(C._faceName="faceName")),g.at&&g.at.length){C.at=[];for(let I=0;I<g.at.length;++I)C.at[I]=g.at[I]}if(g.positions&&g.positions.length){C.positions=[];for(let A=0;A<g.positions.length;++A)C.positions[A]=I.json&&!isFinite(g.positions[A])?String(g.positions[A]):g.positions[A]}if(g.uvs&&g.uvs.length){C.uvs=[];for(let A=0;A<g.uvs.length;++A)C.uvs[A]=I.json&&!isFinite(g.uvs[A])?String(g.uvs[A]):g.uvs[A]}if(g.indices&&g.indices.length){C.indices=[];for(let I=0;I<g.indices.length;++I)C.indices[I]=g.indices[I]}if(g.lights&&g.lights.length){C.lights=[];for(let I=0;I<g.lights.length;++I)C.lights[I]=g.lights[I]}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Geometry"},g}(),g.Mesh=function(){function g(g){if(this.geometries=[],g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.level=0,g.prototype.geometries=m.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=Z.create()),null!=g.level&&Object.hasOwnProperty.call(g,"level")&&I.uint32(8).int32(g.level),null!=g.geometries&&g.geometries.length)for(let C=0;C<g.geometries.length;++C)b.protocol.Geometry.encode(g.geometries[C],I.uint32(18).fork()).ldelim();return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Mesh;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.level=g.int32();break;case 2:A.geometries&&A.geometries.length||(A.geometries=[]),A.geometries.push(b.protocol.Geometry.decode(g,g.uint32()));break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.level&&g.hasOwnProperty("level")&&!m.isInteger(g.level))return"level: integer expected";if(null!=g.geometries&&g.hasOwnProperty("geometries")){if(!Array.isArray(g.geometries))return"geometries: array expected";for(let I=0;I<g.geometries.length;++I){let C=b.protocol.Geometry.verify(g.geometries[I]);if(C)return"geometries."+C}}return null},g.fromObject=function(g){if(g instanceof b.protocol.Mesh)return g;let I=new b.protocol.Mesh;if(null!=g.level&&(I.level=0|g.level),g.geometries){if(!Array.isArray(g.geometries))throw TypeError(".protocol.Mesh.geometries: array expected");I.geometries=[];for(let C=0;C<g.geometries.length;++C){if("object"!=typeof g.geometries[C])throw TypeError(".protocol.Mesh.geometries: object expected");I.geometries[C]=b.protocol.Geometry.fromObject(g.geometries[C])}}return I},g.toObject=function(g,I){I||(I={});let C={};if((I.arrays||I.defaults)&&(C.geometries=[]),I.defaults&&(C.level=0),null!=g.level&&g.hasOwnProperty("level")&&(C.level=g.level),g.geometries&&g.geometries.length){C.geometries=[];for(let A=0;A<g.geometries.length;++A)C.geometries[A]=b.protocol.Geometry.toObject(g.geometries[A],I)}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Mesh"},g}(),g.Chunk=function(){function g(g){if(this.meshes=[],this.voxels=[],this.lights=[],g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.x=0,g.prototype.z=0,g.prototype.id="",g.prototype.meshes=m.emptyArray,g.prototype.voxels=m.emptyArray,g.prototype.lights=m.emptyArray,g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=Z.create()),null!=g.x&&Object.hasOwnProperty.call(g,"x")&&I.uint32(8).int32(g.x),null!=g.z&&Object.hasOwnProperty.call(g,"z")&&I.uint32(16).int32(g.z),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(26).string(g.id),null!=g.meshes&&g.meshes.length)for(let C=0;C<g.meshes.length;++C)b.protocol.Mesh.encode(g.meshes[C],I.uint32(34).fork()).ldelim();if(null!=g.voxels&&g.voxels.length){I.uint32(42).fork();for(let C=0;C<g.voxels.length;++C)I.uint32(g.voxels[C]);I.ldelim()}if(null!=g.lights&&g.lights.length){I.uint32(50).fork();for(let C=0;C<g.lights.length;++C)I.uint32(g.lights[C]);I.ldelim()}return I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Chunk;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.x=g.int32();break;case 2:A.z=g.int32();break;case 3:A.id=g.string();break;case 4:A.meshes&&A.meshes.length||(A.meshes=[]),A.meshes.push(b.protocol.Mesh.decode(g,g.uint32()));break;case 5:if(A.voxels&&A.voxels.length||(A.voxels=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.voxels.push(g.uint32())}else A.voxels.push(g.uint32());break;case 6:if(A.lights&&A.lights.length||(A.lights=[]),2==(7&I)){let I=g.uint32()+g.pos;for(;g.pos<I;)A.lights.push(g.uint32())}else A.lights.push(g.uint32());break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.x&&g.hasOwnProperty("x")&&!m.isInteger(g.x))return"x: integer expected";if(null!=g.z&&g.hasOwnProperty("z")&&!m.isInteger(g.z))return"z: integer expected";if(null!=g.id&&g.hasOwnProperty("id")&&!m.isString(g.id))return"id: string expected";if(null!=g.meshes&&g.hasOwnProperty("meshes")){if(!Array.isArray(g.meshes))return"meshes: array expected";for(let I=0;I<g.meshes.length;++I){let C=b.protocol.Mesh.verify(g.meshes[I]);if(C)return"meshes."+C}}if(null!=g.voxels&&g.hasOwnProperty("voxels")){if(!Array.isArray(g.voxels))return"voxels: array expected";for(let I=0;I<g.voxels.length;++I)if(!m.isInteger(g.voxels[I]))return"voxels: integer[] expected"}if(null!=g.lights&&g.hasOwnProperty("lights")){if(!Array.isArray(g.lights))return"lights: array expected";for(let I=0;I<g.lights.length;++I)if(!m.isInteger(g.lights[I]))return"lights: integer[] expected"}return null},g.fromObject=function(g){if(g instanceof b.protocol.Chunk)return g;let I=new b.protocol.Chunk;if(null!=g.x&&(I.x=0|g.x),null!=g.z&&(I.z=0|g.z),null!=g.id&&(I.id=String(g.id)),g.meshes){if(!Array.isArray(g.meshes))throw TypeError(".protocol.Chunk.meshes: array expected");I.meshes=[];for(let C=0;C<g.meshes.length;++C){if("object"!=typeof g.meshes[C])throw TypeError(".protocol.Chunk.meshes: object expected");I.meshes[C]=b.protocol.Mesh.fromObject(g.meshes[C])}}if(g.voxels){if(!Array.isArray(g.voxels))throw TypeError(".protocol.Chunk.voxels: array expected");I.voxels=[];for(let C=0;C<g.voxels.length;++C)I.voxels[C]=g.voxels[C]>>>0}if(g.lights){if(!Array.isArray(g.lights))throw TypeError(".protocol.Chunk.lights: array expected");I.lights=[];for(let C=0;C<g.lights.length;++C)I.lights[C]=g.lights[C]>>>0}return I},g.toObject=function(g,I){I||(I={});let C={};if((I.arrays||I.defaults)&&(C.meshes=[],C.voxels=[],C.lights=[]),I.defaults&&(C.x=0,C.z=0,C.id=""),null!=g.x&&g.hasOwnProperty("x")&&(C.x=g.x),null!=g.z&&g.hasOwnProperty("z")&&(C.z=g.z),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),g.meshes&&g.meshes.length){C.meshes=[];for(let A=0;A<g.meshes.length;++A)C.meshes[A]=b.protocol.Mesh.toObject(g.meshes[A],I)}if(g.voxels&&g.voxels.length){C.voxels=[];for(let I=0;I<g.voxels.length;++I)C.voxels[I]=g.voxels[I]}if(g.lights&&g.lights.length){C.lights=[];for(let I=0;I<g.lights.length;++I)C.lights[I]=g.lights[I]}return C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Chunk"},g}(),g.Peer=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.id="",g.prototype.username="",g.prototype.metadata="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(10).string(g.id),null!=g.username&&Object.hasOwnProperty.call(g,"username")&&I.uint32(18).string(g.username),null!=g.metadata&&Object.hasOwnProperty.call(g,"metadata")&&I.uint32(26).string(g.metadata),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Peer;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.id=g.string();break;case 2:A.username=g.string();break;case 3:A.metadata=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.id&&g.hasOwnProperty("id")&&!m.isString(g.id)?"id: string expected":null!=g.username&&g.hasOwnProperty("username")&&!m.isString(g.username)?"username: string expected":null!=g.metadata&&g.hasOwnProperty("metadata")&&!m.isString(g.metadata)?"metadata: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Peer)return g;let I=new b.protocol.Peer;return null!=g.id&&(I.id=String(g.id)),null!=g.username&&(I.username=String(g.username)),null!=g.metadata&&(I.metadata=String(g.metadata)),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.id="",C.username="",C.metadata=""),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),null!=g.username&&g.hasOwnProperty("username")&&(C.username=g.username),null!=g.metadata&&g.hasOwnProperty("metadata")&&(C.metadata=g.metadata),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Peer"},g}(),g.Entity=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.operation=0,g.prototype.id="",g.prototype.type="",g.prototype.metadata="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.operation&&Object.hasOwnProperty.call(g,"operation")&&I.uint32(8).int32(g.operation),null!=g.id&&Object.hasOwnProperty.call(g,"id")&&I.uint32(18).string(g.id),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(26).string(g.type),null!=g.metadata&&Object.hasOwnProperty.call(g,"metadata")&&I.uint32(34).string(g.metadata),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Entity;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.operation=g.int32();break;case 2:A.id=g.string();break;case 3:A.type=g.string();break;case 4:A.metadata=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.operation&&g.hasOwnProperty("operation"))switch(g.operation){default:return"operation: enum value expected";case 0:case 1:case 2:}return null!=g.id&&g.hasOwnProperty("id")&&!m.isString(g.id)?"id: string expected":null!=g.type&&g.hasOwnProperty("type")&&!m.isString(g.type)?"type: string expected":null!=g.metadata&&g.hasOwnProperty("metadata")&&!m.isString(g.metadata)?"metadata: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Entity)return g;let I=new b.protocol.Entity;switch(g.operation){default:if("number"==typeof g.operation){I.operation=g.operation;break}break;case"CREATE":case 0:I.operation=0;break;case"DELETE":case 1:I.operation=1;break;case"UPDATE":case 2:I.operation=2}return null!=g.id&&(I.id=String(g.id)),null!=g.type&&(I.type=String(g.type)),null!=g.metadata&&(I.metadata=String(g.metadata)),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.operation=I.enums===String?"CREATE":0,C.id="",C.type="",C.metadata=""),null!=g.operation&&g.hasOwnProperty("operation")&&(C.operation=I.enums===String?void 0===b.protocol.Entity.Operation[g.operation]?g.operation:b.protocol.Entity.Operation[g.operation]:g.operation),null!=g.id&&g.hasOwnProperty("id")&&(C.id=g.id),null!=g.type&&g.hasOwnProperty("type")&&(C.type=g.type),null!=g.metadata&&g.hasOwnProperty("metadata")&&(C.metadata=g.metadata),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Entity"},g.Operation=function(){const g={},I=Object.create(g);return I[g[0]="CREATE"]=0,I[g[1]="DELETE"]=1,I[g[2]="UPDATE"]=2,I}(),g}(),g.Event=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.name="",g.prototype.payload="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.name&&Object.hasOwnProperty.call(g,"name")&&I.uint32(10).string(g.name),null!=g.payload&&Object.hasOwnProperty.call(g,"payload")&&I.uint32(18).string(g.payload),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Event;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.name=g.string();break;case 2:A.payload=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.name&&g.hasOwnProperty("name")&&!m.isString(g.name)?"name: string expected":null!=g.payload&&g.hasOwnProperty("payload")&&!m.isString(g.payload)?"payload: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Event)return g;let I=new b.protocol.Event;return null!=g.name&&(I.name=String(g.name)),null!=g.payload&&(I.payload=String(g.payload)),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.name="",C.payload=""),null!=g.name&&g.hasOwnProperty("name")&&(C.name=g.name),null!=g.payload&&g.hasOwnProperty("payload")&&(C.payload=g.payload),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Event"},g}(),g.Method=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.name="",g.prototype.payload="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.name&&Object.hasOwnProperty.call(g,"name")&&I.uint32(10).string(g.name),null!=g.payload&&Object.hasOwnProperty.call(g,"payload")&&I.uint32(18).string(g.payload),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Method;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.name=g.string();break;case 2:A.payload=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.name&&g.hasOwnProperty("name")&&!m.isString(g.name)?"name: string expected":null!=g.payload&&g.hasOwnProperty("payload")&&!m.isString(g.payload)?"payload: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Method)return g;let I=new b.protocol.Method;return null!=g.name&&(I.name=String(g.name)),null!=g.payload&&(I.payload=String(g.payload)),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.name="",C.payload=""),null!=g.name&&g.hasOwnProperty("name")&&(C.name=g.name),null!=g.payload&&g.hasOwnProperty("payload")&&(C.payload=g.payload),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Method"},g}(),g.Update=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.vx=0,g.prototype.vy=0,g.prototype.vz=0,g.prototype.voxel=0,g.prototype.light=0,g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.vx&&Object.hasOwnProperty.call(g,"vx")&&I.uint32(8).int32(g.vx),null!=g.vy&&Object.hasOwnProperty.call(g,"vy")&&I.uint32(16).int32(g.vy),null!=g.vz&&Object.hasOwnProperty.call(g,"vz")&&I.uint32(24).int32(g.vz),null!=g.voxel&&Object.hasOwnProperty.call(g,"voxel")&&I.uint32(32).uint32(g.voxel),null!=g.light&&Object.hasOwnProperty.call(g,"light")&&I.uint32(40).uint32(g.light),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Update;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.vx=g.int32();break;case 2:A.vy=g.int32();break;case 3:A.vz=g.int32();break;case 4:A.voxel=g.uint32();break;case 5:A.light=g.uint32();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.vx&&g.hasOwnProperty("vx")&&!m.isInteger(g.vx)?"vx: integer expected":null!=g.vy&&g.hasOwnProperty("vy")&&!m.isInteger(g.vy)?"vy: integer expected":null!=g.vz&&g.hasOwnProperty("vz")&&!m.isInteger(g.vz)?"vz: integer expected":null!=g.voxel&&g.hasOwnProperty("voxel")&&!m.isInteger(g.voxel)?"voxel: integer expected":null!=g.light&&g.hasOwnProperty("light")&&!m.isInteger(g.light)?"light: integer expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Update)return g;let I=new b.protocol.Update;return null!=g.vx&&(I.vx=0|g.vx),null!=g.vy&&(I.vy=0|g.vy),null!=g.vz&&(I.vz=0|g.vz),null!=g.voxel&&(I.voxel=g.voxel>>>0),null!=g.light&&(I.light=g.light>>>0),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.vx=0,C.vy=0,C.vz=0,C.voxel=0,C.light=0),null!=g.vx&&g.hasOwnProperty("vx")&&(C.vx=g.vx),null!=g.vy&&g.hasOwnProperty("vy")&&(C.vy=g.vy),null!=g.vz&&g.hasOwnProperty("vz")&&(C.vz=g.vz),null!=g.voxel&&g.hasOwnProperty("voxel")&&(C.voxel=g.voxel),null!=g.light&&g.hasOwnProperty("light")&&(C.light=g.light),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Update"},g}(),g.ChatMessage=function(){function g(g){if(g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.type="",g.prototype.sender="",g.prototype.body="",g.prototype.metadata="",g.create=function(I){return new g(I)},g.encode=function(g,I){return I||(I=Z.create()),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(10).string(g.type),null!=g.sender&&Object.hasOwnProperty.call(g,"sender")&&I.uint32(18).string(g.sender),null!=g.body&&Object.hasOwnProperty.call(g,"body")&&I.uint32(26).string(g.body),null!=g.metadata&&Object.hasOwnProperty.call(g,"metadata")&&I.uint32(34).string(g.metadata),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.ChatMessage;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.type=g.string();break;case 2:A.sender=g.string();break;case 3:A.body=g.string();break;case 4:A.metadata=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){return"object"!=typeof g||null===g?"object expected":null!=g.type&&g.hasOwnProperty("type")&&!m.isString(g.type)?"type: string expected":null!=g.sender&&g.hasOwnProperty("sender")&&!m.isString(g.sender)?"sender: string expected":null!=g.body&&g.hasOwnProperty("body")&&!m.isString(g.body)?"body: string expected":null!=g.metadata&&g.hasOwnProperty("metadata")&&!m.isString(g.metadata)?"metadata: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.ChatMessage)return g;let I=new b.protocol.ChatMessage;return null!=g.type&&(I.type=String(g.type)),null!=g.sender&&(I.sender=String(g.sender)),null!=g.body&&(I.body=String(g.body)),null!=g.metadata&&(I.metadata=String(g.metadata)),I},g.toObject=function(g,I){I||(I={});let C={};return I.defaults&&(C.type="",C.sender="",C.body="",C.metadata=""),null!=g.type&&g.hasOwnProperty("type")&&(C.type=g.type),null!=g.sender&&g.hasOwnProperty("sender")&&(C.sender=g.sender),null!=g.body&&g.hasOwnProperty("body")&&(C.body=g.body),null!=g.metadata&&g.hasOwnProperty("metadata")&&(C.metadata=g.metadata),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.ChatMessage"},g}(),g.Message=function(){function g(g){if(this.peers=[],this.entities=[],this.chunks=[],this.events=[],this.updates=[],g)for(let I=Object.keys(g),C=0;C<I.length;++C)null!=g[I[C]]&&(this[I[C]]=g[I[C]])}return g.prototype.type=0,g.prototype.json="",g.prototype.text="",g.prototype.method=null,g.prototype.chat=null,g.prototype.peers=m.emptyArray,g.prototype.entities=m.emptyArray,g.prototype.chunks=m.emptyArray,g.prototype.events=m.emptyArray,g.prototype.updates=m.emptyArray,g.prototype.worldName="",g.create=function(I){return new g(I)},g.encode=function(g,I){if(I||(I=Z.create()),null!=g.type&&Object.hasOwnProperty.call(g,"type")&&I.uint32(8).int32(g.type),null!=g.json&&Object.hasOwnProperty.call(g,"json")&&I.uint32(18).string(g.json),null!=g.text&&Object.hasOwnProperty.call(g,"text")&&I.uint32(26).string(g.text),null!=g.method&&Object.hasOwnProperty.call(g,"method")&&b.protocol.Method.encode(g.method,I.uint32(34).fork()).ldelim(),null!=g.chat&&Object.hasOwnProperty.call(g,"chat")&&b.protocol.ChatMessage.encode(g.chat,I.uint32(42).fork()).ldelim(),null!=g.peers&&g.peers.length)for(let C=0;C<g.peers.length;++C)b.protocol.Peer.encode(g.peers[C],I.uint32(50).fork()).ldelim();if(null!=g.entities&&g.entities.length)for(let C=0;C<g.entities.length;++C)b.protocol.Entity.encode(g.entities[C],I.uint32(58).fork()).ldelim();if(null!=g.chunks&&g.chunks.length)for(let C=0;C<g.chunks.length;++C)b.protocol.Chunk.encode(g.chunks[C],I.uint32(66).fork()).ldelim();if(null!=g.events&&g.events.length)for(let C=0;C<g.events.length;++C)b.protocol.Event.encode(g.events[C],I.uint32(74).fork()).ldelim();if(null!=g.updates&&g.updates.length)for(let C=0;C<g.updates.length;++C)b.protocol.Update.encode(g.updates[C],I.uint32(82).fork()).ldelim();return null!=g.worldName&&Object.hasOwnProperty.call(g,"worldName")&&I.uint32(90).string(g.worldName),I},g.encodeDelimited=function(g,I){return this.encode(g,I).ldelim()},g.decode=function(g,I){g instanceof h||(g=h.create(g));let C=void 0===I?g.len:g.pos+I,A=new b.protocol.Message;for(;g.pos<C;){let I=g.uint32();switch(I>>>3){case 1:A.type=g.int32();break;case 2:A.json=g.string();break;case 3:A.text=g.string();break;case 4:A.method=b.protocol.Method.decode(g,g.uint32());break;case 5:A.chat=b.protocol.ChatMessage.decode(g,g.uint32());break;case 6:A.peers&&A.peers.length||(A.peers=[]),A.peers.push(b.protocol.Peer.decode(g,g.uint32()));break;case 7:A.entities&&A.entities.length||(A.entities=[]),A.entities.push(b.protocol.Entity.decode(g,g.uint32()));break;case 8:A.chunks&&A.chunks.length||(A.chunks=[]),A.chunks.push(b.protocol.Chunk.decode(g,g.uint32()));break;case 9:A.events&&A.events.length||(A.events=[]),A.events.push(b.protocol.Event.decode(g,g.uint32()));break;case 10:A.updates&&A.updates.length||(A.updates=[]),A.updates.push(b.protocol.Update.decode(g,g.uint32()));break;case 11:A.worldName=g.string();break;default:g.skipType(7&I)}}return A},g.decodeDelimited=function(g){return g instanceof h||(g=new h(g)),this.decode(g,g.uint32())},g.verify=function(g){if("object"!=typeof g||null===g)return"object expected";if(null!=g.type&&g.hasOwnProperty("type"))switch(g.type){default:return"type: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:}if(null!=g.json&&g.hasOwnProperty("json")&&!m.isString(g.json))return"json: string expected";if(null!=g.text&&g.hasOwnProperty("text")&&!m.isString(g.text))return"text: string expected";if(null!=g.method&&g.hasOwnProperty("method")){let I=b.protocol.Method.verify(g.method);if(I)return"method."+I}if(null!=g.chat&&g.hasOwnProperty("chat")){let I=b.protocol.ChatMessage.verify(g.chat);if(I)return"chat."+I}if(null!=g.peers&&g.hasOwnProperty("peers")){if(!Array.isArray(g.peers))return"peers: array expected";for(let I=0;I<g.peers.length;++I){let C=b.protocol.Peer.verify(g.peers[I]);if(C)return"peers."+C}}if(null!=g.entities&&g.hasOwnProperty("entities")){if(!Array.isArray(g.entities))return"entities: array expected";for(let I=0;I<g.entities.length;++I){let C=b.protocol.Entity.verify(g.entities[I]);if(C)return"entities."+C}}if(null!=g.chunks&&g.hasOwnProperty("chunks")){if(!Array.isArray(g.chunks))return"chunks: array expected";for(let I=0;I<g.chunks.length;++I){let C=b.protocol.Chunk.verify(g.chunks[I]);if(C)return"chunks."+C}}if(null!=g.events&&g.hasOwnProperty("events")){if(!Array.isArray(g.events))return"events: array expected";for(let I=0;I<g.events.length;++I){let C=b.protocol.Event.verify(g.events[I]);if(C)return"events."+C}}if(null!=g.updates&&g.hasOwnProperty("updates")){if(!Array.isArray(g.updates))return"updates: array expected";for(let I=0;I<g.updates.length;++I){let C=b.protocol.Update.verify(g.updates[I]);if(C)return"updates."+C}}return null!=g.worldName&&g.hasOwnProperty("worldName")&&!m.isString(g.worldName)?"worldName: string expected":null},g.fromObject=function(g){if(g instanceof b.protocol.Message)return g;let I=new b.protocol.Message;switch(g.type){default:if("number"==typeof g.type){I.type=g.type;break}break;case"INIT":case 0:I.type=0;break;case"JOIN":case 1:I.type=1;break;case"LEAVE":case 2:I.type=2;break;case"ERROR":case 3:I.type=3;break;case"PEER":case 4:I.type=4;break;case"ENTITY":case 5:I.type=5;break;case"LOAD":case 6:I.type=6;break;case"UNLOAD":case 7:I.type=7;break;case"UPDATE":case 8:I.type=8;break;case"METHOD":case 9:I.type=9;break;case"CHAT":case 10:I.type=10;break;case"TRANSPORT":case 11:I.type=11;break;case"EVENT":case 12:I.type=12;break;case"ACTION":case 13:I.type=13;break;case"STATS":case 14:I.type=14}if(null!=g.json&&(I.json=String(g.json)),null!=g.text&&(I.text=String(g.text)),null!=g.method){if("object"!=typeof g.method)throw TypeError(".protocol.Message.method: object expected");I.method=b.protocol.Method.fromObject(g.method)}if(null!=g.chat){if("object"!=typeof g.chat)throw TypeError(".protocol.Message.chat: object expected");I.chat=b.protocol.ChatMessage.fromObject(g.chat)}if(g.peers){if(!Array.isArray(g.peers))throw TypeError(".protocol.Message.peers: array expected");I.peers=[];for(let C=0;C<g.peers.length;++C){if("object"!=typeof g.peers[C])throw TypeError(".protocol.Message.peers: object expected");I.peers[C]=b.protocol.Peer.fromObject(g.peers[C])}}if(g.entities){if(!Array.isArray(g.entities))throw TypeError(".protocol.Message.entities: array expected");I.entities=[];for(let C=0;C<g.entities.length;++C){if("object"!=typeof g.entities[C])throw TypeError(".protocol.Message.entities: object expected");I.entities[C]=b.protocol.Entity.fromObject(g.entities[C])}}if(g.chunks){if(!Array.isArray(g.chunks))throw TypeError(".protocol.Message.chunks: array expected");I.chunks=[];for(let C=0;C<g.chunks.length;++C){if("object"!=typeof g.chunks[C])throw TypeError(".protocol.Message.chunks: object expected");I.chunks[C]=b.protocol.Chunk.fromObject(g.chunks[C])}}if(g.events){if(!Array.isArray(g.events))throw TypeError(".protocol.Message.events: array expected");I.events=[];for(let C=0;C<g.events.length;++C){if("object"!=typeof g.events[C])throw TypeError(".protocol.Message.events: object expected");I.events[C]=b.protocol.Event.fromObject(g.events[C])}}if(g.updates){if(!Array.isArray(g.updates))throw TypeError(".protocol.Message.updates: array expected");I.updates=[];for(let C=0;C<g.updates.length;++C){if("object"!=typeof g.updates[C])throw TypeError(".protocol.Message.updates: object expected");I.updates[C]=b.protocol.Update.fromObject(g.updates[C])}}return null!=g.worldName&&(I.worldName=String(g.worldName)),I},g.toObject=function(g,I){I||(I={});let C={};if((I.arrays||I.defaults)&&(C.peers=[],C.entities=[],C.chunks=[],C.events=[],C.updates=[]),I.defaults&&(C.type=I.enums===String?"INIT":0,C.json="",C.text="",C.method=null,C.chat=null,C.worldName=""),null!=g.type&&g.hasOwnProperty("type")&&(C.type=I.enums===String?void 0===b.protocol.Message.Type[g.type]?g.type:b.protocol.Message.Type[g.type]:g.type),null!=g.json&&g.hasOwnProperty("json")&&(C.json=g.json),null!=g.text&&g.hasOwnProperty("text")&&(C.text=g.text),null!=g.method&&g.hasOwnProperty("method")&&(C.method=b.protocol.Method.toObject(g.method,I)),null!=g.chat&&g.hasOwnProperty("chat")&&(C.chat=b.protocol.ChatMessage.toObject(g.chat,I)),g.peers&&g.peers.length){C.peers=[];for(let A=0;A<g.peers.length;++A)C.peers[A]=b.protocol.Peer.toObject(g.peers[A],I)}if(g.entities&&g.entities.length){C.entities=[];for(let A=0;A<g.entities.length;++A)C.entities[A]=b.protocol.Entity.toObject(g.entities[A],I)}if(g.chunks&&g.chunks.length){C.chunks=[];for(let A=0;A<g.chunks.length;++A)C.chunks[A]=b.protocol.Chunk.toObject(g.chunks[A],I)}if(g.events&&g.events.length){C.events=[];for(let A=0;A<g.events.length;++A)C.events[A]=b.protocol.Event.toObject(g.events[A],I)}if(g.updates&&g.updates.length){C.updates=[];for(let A=0;A<g.updates.length;++A)C.updates[A]=b.protocol.Update.toObject(g.updates[A],I)}return null!=g.worldName&&g.hasOwnProperty("worldName")&&(C.worldName=g.worldName),C},g.prototype.toJSON=function(){return this.constructor.toObject(this,a.util.toJSONOptions)},g.getTypeUrl=function(g){return void 0===g&&(g="type.googleapis.com"),g+"/protocol.Message"},g.Type=function(){const g={},I=Object.create(g);return I[g[0]="INIT"]=0,I[g[1]="JOIN"]=1,I[g[2]="LEAVE"]=2,I[g[3]="ERROR"]=3,I[g[4]="PEER"]=4,I[g[5]="ENTITY"]=5,I[g[6]="LOAD"]=6,I[g[7]="UNLOAD"]=7,I[g[8]="UPDATE"]=8,I[g[9]="METHOD"]=9,I[g[10]="CHAT"]=10,I[g[11]="TRANSPORT"]=11,I[g[12]="EVENT"]=12,I[g[13]="ACTION"]=13,I[g[14]="STATS"]=14,I}(),g}(),g})();var B=C(8702);function W(g,I,C,A=1/0){const[i,t,s]=I,o=(C.minX-g[0])/i,e=(C.maxX-g[0])/i,l=(C.minY-g[1])/t,d=(C.maxY-g[1])/t,n=(C.minZ-g[2])/s,c=(C.maxZ-g[2])/s,a=Math.max(Math.max(Math.min(o,e),Math.min(l,d)),Math.min(n,c)),h=a===o||a===e?0:a===l||a===d?1:2,Z=Math.min(Math.min(Math.max(o,e),Math.max(l,d)),Math.max(n,c));return Z<0||a>Z?null:a<0?Z>A?null:{axis:a===o||a===e?0:a===l||a===d?1:2,distance:Z}:a>A?null:{axis:h,distance:a}}function p(g,I,C,A){let i=+C[0],t=+C[1],s=+C[2];const o=Math.sqrt(i*i+t*t+s*s);if(0===o)throw new Error("Can't raycast along a zero vector");i/=o,t/=o,s/=o;const[e,l,d]=I;let n=0,c=0|Math.floor(e),a=0|Math.floor(l),h=0|Math.floor(d);const Z=i>0?1:-1,m=t>0?1:-1,b=s>0?1:-1,G=Math.abs(1/i),B=Math.abs(1/t),p=Math.abs(1/s);let u=G<1/0?G*(Z>0?c+1-e:e-c):1/0,r=B<1/0?B*(m>0?a+1-l:l-a):1/0,y=p<1/0?p*(b>0?h+1-d:d-h):1/0;for(;n<=A;){let C;if((g(c,a,h)||[]).forEach((g=>{const o=W(I,[i,t,s],g.clone(),A);o&&(C=o)})),C)return{point:[e+C.distance*i,l+C.distance*t,d+C.distance*s],normal:[0===C.axis?-Z:0,1===C.axis?-m:0,2===C.axis?-b:0],voxel:[c,a,h]};u<r?u<y?(c+=Z,n=u,u+=G):(h+=b,n=y,y+=p):r<y?(a+=m,n=r,r+=B):(h+=b,n=y,y+=p)}return null}var u=p,r=class{constructor(g,I,C,A,i,t,s,o){this.aabb=g,this.mass=I,this.friction=C,this.restitution=A,this.gravityMultiplier=i,this.stepHeight=t,this.onStep=s,this.onCollide=o,this.resting=[0,0,0],this.velocity=[0,0,0],this.inFluid=!1,this.ratioInFluid=0,this.forces=[0,0,0],this.impulses=[0,0,0],this.sleepFrameCount=10,this.isCliffHanging=!1,this.setPosition=g=>{this.aabb.setPosition([g[0]-this.aabb.width/2,g[1]-this.aabb.height/2,g[2]-this.aabb.depth/2]),this.markActive()},this.getPosition=()=>[this.aabb.minX+this.aabb.width/2,this.aabb.minY+this.aabb.height/2,this.aabb.minZ+this.aabb.depth/2],this.applyForce=g=>{this.forces[0]+=g[0],this.forces[1]+=g[1],this.forces[2]+=g[2],this.markActive()},this.applyImpulse=g=>{this.impulses[0]+=g[0],this.impulses[1]+=g[1],this.impulses[2]+=g[2],this.markActive()},this.markActive=()=>{this.sleepFrameCount=10},this.airDrag=-1,this.fluidDrag=-1}get atRestX(){return this.resting[0]}get atRestY(){return this.resting[1]}get atRestZ(){return this.resting[2]}};function y(g,I,C){const[A,i,t]=g,[s,o,e]=I,[l,d,n]=C,c=l*A+d*i+n*t;return 0===c?1/0:(l*s+d*o+n*e)/c}function V(g,I,C){return g>=I&&g<=C}function K(g,I,C){const A=I.minX-g.maxX,i=I.minY-g.maxY,t=I.minZ-g.maxZ,s=g.width+I.width,o=g.height+I.height,e=g.depth+I.depth,[l,d,n]=C;let c=1,a=0,h=0,Z=0,m=0;return a=y(C,[A,i,t],[-1,0,0]),a>=0&&l>0&&a<c&&V(a*d,i,i+o)&&V(a*n,t,t+e)&&(c=a,h=-1,Z=0,m=0),a=y(C,[A+s,i,t],[1,0,0]),a>=0&&l<0&&a<c&&V(a*d,i,i+o)&&V(a*n,t,t+e)&&(c=a,h=1,Z=0,m=0),a=y(C,[A,i,t],[0,-1,0]),a>=0&&d>0&&a<c&&V(a*l,A,A+s)&&V(a*n,t,t+e)&&(c=a,h=0,Z=-1,m=0),a=y(C,[A,i+o,t],[0,1,0]),a>=0&&d<0&&a<c&&V(a*l,A,A+s)&&V(a*n,t,t+e)&&(c=a,h=0,Z=1,m=0),a=y(C,[A,i,t],[0,0,-1]),a>=0&&n>0&&a<c&&V(a*l,A,A+s)&&V(a*d,i,i+o)&&(c=a,h=0,Z=0,m=-1),a=y(C,[A,i,t+e],[0,0,1]),a>=0&&n<0&&a<c&&V(a*l,A,A+s)&&V(a*d,i,i+o)&&(c=a,h=0,Z=0,m=1),{h:c,nx:h,ny:Z,nz:m}}function X(g,I,C,A,i,t,s){if(void 0===i&&(i=!0),void 0===t&&(t=100),void 0===s&&(s=[]),t<=0)return;const[o,e,l]=C,d=Math.sqrt(o*o+e*e+l*l),n=Math.floor(o>0?I.minX:I.minX+o)-1,c=Math.floor(e>0?I.minY:I.minY+e)-1,a=Math.floor(l>0?I.minZ:I.minZ+l)-1,h=Math.floor(o>0?I.maxX+o:I.maxX)+1,Z=Math.floor(e>0?I.maxY+e:I.maxY)+1,m=Math.floor(l>0?I.maxZ+l:I.maxZ)+1;let b=[],G={h:1,nx:0,ny:0,nz:0};for(const V of s){const g=K(I,V,C);g.h<G.h&&(G=g,b=[o,e,l])}for(let V=n;V<=h;V++)for(let A=a;A<=m;A++)for(let i=c;i<=Z;i++){const t=g(V,i,A);for(const g of t){const t=K(I,g,C);t.h<G.h&&(G=t,b=[V,i,A])}}const B=G.h*o+H.EPSILON*G.nx,W=G.h*e+H.EPSILON*G.ny,p=G.h*l+H.EPSILON*G.nz;if(i&&I.translate([B,W,p]),1===G.h)return;const u=0!==G.nx?0:0!==G.ny?1:2,r=-(G.nx+G.ny+G.nz),y=[(1-G.h)*o,(1-G.h)*e,(1-G.h)*l];0!==r&&A(d*G.h,u,r,y,b)||y[0]**2+y[1]**2+y[2]**2!=0&&X(g,I,y,A,i,t-1,s)}function w(g,I){return Math.abs(g-I)<1e-5}var Y=class{constructor(g,I,C){var A=this;this.getVoxel=g,this.testFluid=I,this.options=C,this.bodies=[],this.addBody=g=>{const I={aabb:new s(0,0,0,1,1,1),mass:1,friction:1,restitution:0,gravityMultiplier:1,stepHeight:0},{aabb:C,mass:A,friction:i,restitution:t,gravityMultiplier:o,stepHeight:e,onStep:l,onCollide:d}={...I,...g},n=new r(C,A,i,t,o,e,l,d);return this.bodies.push(n),n},this.removeBody=g=>{const I=this.bodies.indexOf(g);I<0||this.bodies.splice(I,1)},this.update=g=>{const I=w(0,this.options.gravity[0]**2+this.options.gravity[1]**2+this.options.gravity[2]**2);this.bodies.forEach((C=>this.iterateBody(C,g,I)))},this.iterateBody=(g,I,C)=>{const A=[...g.resting];if(g.mass<=0)return g.velocity=[0,0,0],g.forces=[0,0,0],void(g.impulses=[0,0,0]);const i=C||0===g.gravityMultiplier;if(this.isBodyAsleep(g,I,i))return;g.sleepFrameCount--,this.applyFluidForces(g);const t=[g.forces[0]/g.mass+this.options.gravity[0]*g.gravityMultiplier,g.forces[1]/g.mass+this.options.gravity[1]*g.gravityMultiplier,g.forces[2]/g.mass+this.options.gravity[2]*g.gravityMultiplier],s=[g.impulses[0]/g.mass+t[0]*I,g.impulses[1]/g.mass+t[1]*I,g.impulses[2]/g.mass+t[2]*I];g.velocity=[g.velocity[0]+s[0],g.velocity[1]+s[1],g.velocity[2]+s[2]],g.friction&&(this.applyFrictionByAxis(0,g,s),this.applyFrictionByAxis(1,g,s),this.applyFrictionByAxis(2,g,s));let o=g.airDrag>=0?g.airDrag:this.options.airDrag;g.inFluid&&(o=g.fluidDrag>=0?g.fluidDrag:this.options.fluidDrag,o*=1-(1-g.ratioInFluid)**2);const e=Math.max(1-o*I/g.mass,0);g.velocity=[g.velocity[0]*e,g.velocity[1]*e,g.velocity[2]*e];const l=[g.velocity[0]*I,g.velocity[1]*I,g.velocity[2]*I];g.forces=[0,0,0],g.impulses=[0,0,0];const d=g.aabb.clone();this.processCollisions(g.aabb,l,g.resting),this.tryCliffHanging(g,d,l),g.stepHeight>0&&this.tryAutoStepping(g,d,l);const n=[0,0,0];for(let a=0;a<3;++a)g.resting[a]&&(A[a]||(n[a]=-g.velocity[a]),g.velocity[a]=0);const c=Math.sqrt(n[0]**2+n[1]**2+n[2]**2);c>.001&&(n[0]=n[0]*g.mass,n[1]=n[1]*g.mass,n[2]=n[2]*g.mass,g.onCollide&&g.onCollide(n),g.restitution>0&&c>this.options.minBounceImpulse&&(n[0]=n[0]*g.restitution,n[1]=n[1]*g.restitution,n[2]=n[2]*g.restitution,g.applyImpulse(n)));g.velocity[0]**2+g.velocity[1]**2+g.velocity[2]**2>1e-5&&g.markActive()},this.tryCliffHanging=(g,I,C)=>{if(!g.isCliffHanging||!g.resting[1])return;const A=[],i=Math.abs(I.minY-Math.floor(I.minY))<=Y.EPSILON?Math.floor(I.minY):I.minY,t=[I.maxX,i,I.maxZ],o=[I.maxX,i,I.minZ],e=[I.minX,i,I.maxZ],l=[I.minX,i,I.minZ],d=this.isRaycastEmpty(e,[0,-1,0]),n=this.isRaycastEmpty(l,[0,-1,0]),c=this.isRaycastEmpty(t,[0,-1,0]),a=this.isRaycastEmpty(o,[0,-1,0]),h=I.maxX-I.minX,Z=I.maxZ-I.minZ,m=.2;if(C[0]>0&&(c||a)){const g=this.findCliffX(I,i,!0);if(null!==g){const C=Math.min(m,g-I.minX);A.push(new s(g-C+h,i,I.minZ,g-C+h+.1,i+1,I.maxZ))}}else if(C[0]<0&&(d||n)){const g=this.findCliffX(I,i,!1);if(null!==g){const C=Math.min(m,I.maxX-g);A.push(new s(g+C-h-.1,i,I.minZ,g+C-h,i+1,I.maxZ))}}if(C[2]>0&&(c||d)){const g=this.findCliffVz(I,i,!0);if(null!==g){const C=Math.min(m,g-I.minZ);A.push(new s(I.minX,i,g-C+Z,I.maxX,i+1,g-C+Z+.1))}}else if(C[2]<0&&(a||n)){const g=this.findCliffVz(I,i,!1);if(null!==g){const C=Math.min(m,I.maxZ-g);A.push(new s(I.minX,i,g+C-Z-.1,I.maxX,i+1,g+C-Z))}}if(A.length>0){const i=[0,0,0];this.processCollisions(I,[C[0],0,C[2]],i,A),g.aabb=I}},this.findCliffX=(g,I,C)=>{const A=Math.floor(C?g.minX:g.maxX),i=Math.floor(C?g.maxX:g.minX),t=Math.floor(g.maxZ),s=Math.floor(g.minZ),o=C?1:-1;let e=null;for(let l=A;C?l<=i:l>=i;l+=o)for(let A=t;A>=s;A--){const i=[l,I-3*Y.EPSILON,A];if(this.isEmpty(i))continue;const t=this.getVoxel(i[0],i[1],i[2]);if(0===t.length)continue;const s=t.reduce(((g,I)=>g.union(I)),t[0]);if(s.maxY+Y.EPSILON<I)continue;const o=g.maxZ-g.minZ;s.maxZ-s.minZ+Y.EPSILON<.7*o||(e=C?s.maxX:s.minX)}return e},this.findCliffVz=(g,I,C)=>{const A=Math.floor(g.maxX),i=Math.floor(g.minX),t=Math.floor(C?g.minZ:g.maxZ),s=Math.floor(C?g.maxZ:g.minZ),o=C?1:-1;let e=null;for(let l=t;C?l<=s:l>=s;l+=o)for(let t=A;t>=i;t--){const A=[t,I-3*Y.EPSILON,l];if(this.isEmpty(A))continue;const i=this.getVoxel(A[0],A[1],A[2]);if(0===i.length)continue;const s=i.reduce(((g,I)=>g.union(I)),i[0]);if(s.maxY+Y.EPSILON<I)continue;const o=g.maxX-g.minX;s.maxX-s.minX+Y.EPSILON<.7*o||(e=C?s.maxZ:s.minZ)}return e},this.isRaycastEmpty=(g,I)=>!u(this.getVoxel,g,I,3*Y.EPSILON),this.isEmpty=g=>0===this.getVoxel(g[0],g[1],g[2]).length,this.applyFluidForces=g=>{const I=g.aabb,C=Math.floor(I.minX),A=Math.floor(I.minZ),i=Math.floor(I.minY),t=Math.floor(I.maxY);if(!this.testFluid(C,i,A))return g.inFluid=!1,void(g.ratioInFluid=0);let s=1,o=i+1;for(;o<=t&&this.testFluid(C,o,A);)s++,o++;let e=(i+s-I.minY)/(I.maxY-I.minY);e>1&&(e=1);const l=(I.maxX-I.minX)*(I.maxY-I.minY)*(I.maxZ-I.minZ)*e,d=-this.options.fluidDensity*l,n=[this.options.gravity[0]*d,this.options.gravity[1]*d,this.options.gravity[2]*d];g.applyForce(n),g.inFluid=!0,g.ratioInFluid=e},this.applyFrictionByAxis=(g,I,C)=>{const A=I.resting[g],i=C[g];if(0===A)return;if(A*i<=0)return;const t=[...I.velocity];t[g]=0;const s=Math.sqrt(t[0]**2+t[1]**2+t[2]**2);if(w(s,0))return;const o=Math.abs(I.friction*i),e=s>o?(s-o)/s:0;I.velocity[(g+1)%3]*=e,I.velocity[(g+2)%3]*=e},this.processCollisions=function(g,I,C,i){void 0===i&&(i=[]),C[0]=0,C[1]=0,C[2]=0,X(A.getVoxel,g,I,(function(g,I,A,i){return C[I]=A,i[I]=0,!1}),!0,100,i)},this.tryAutoStepping=(g,I,C)=>{if(g.resting[1]>=0&&!g.inFluid)return;const A=0!==g.resting[0],i=0!==g.resting[2];if(!A&&!i)return;const t=[I.minX+C[0],I.minY+C[1],I.minZ+C[2]];let s=[];X(this.getVoxel,I,C,(function(g,I,C,A,i){return 1===I?(A[I]=0,!1):(s=i||[],!0)}));const o=g.aabb.minY;let e=0;if(s){this.getVoxel(s[0],s[1],s[2]).forEach((g=>{g.maxY>e&&(e=g.maxY)}))}const l=Math.floor(o)+e-o+Y.EPSILON,d=[0,Math.min(l,g.stepHeight+.001),0];let n=!1;if(X(this.getVoxel,I,d,(function(){return n=!0,!0})),n)return;const c=[t[0]-I.minX,t[1]-I.minY,t[2]-I.minZ];c[1]=0;const a=[0,0,0];this.processCollisions(I,c,a);const h=I.clone();X(this.getVoxel,h,[0,-l,0],(g=>(g>Y.EPSILON&&I.translate([0,-g+Y.EPSILON,0]),!0))),I.minY<o||(g.resting[0]=a[0],g.resting[2]=a[2],g.onStep?g.onStep(I,a):g.aabb=I.clone())},this.isBodyAsleep=(g,I,C)=>{if(g.sleepFrameCount>0)return!1;if(C)return!0;let A=!1;const i=.5*I*I*g.gravityMultiplier,t=[this.options.gravity[0]*i,this.options.gravity[1]*i,this.options.gravity[2]*i];return X(this.getVoxel,g.aabb,t,(function(){return A=!0,!0}),!1),A},this.teleport=(g,I,C)=>{const A=1e3,i=g.getPosition(),t=(I[0]-i[0])/A,s=(I[1]-i[1])/A,o=(I[2]-i[2])/A;setInterval((()=>{g.aabb.translate([t,s,o])}),C/A)}}},H=Y;H.EPSILON=1e-10;var S=C(7232);const R={maxWorker:8},k=class g{constructor(I,C=R){this.Proto=I,this.options=C,this.queue=[],this.workers=[],this.available=[],this.addJob=g=>{this.queue.push(g),this.process()},this.postMessage=(g,I)=>{for(const C of this.workers)C.postMessage(g,I)},this.process=()=>{if(0!==this.queue.length&&this.available.length>0){const I=this.available.pop(),C=this.workers[I],{message:A,buffers:i,resolve:t}=this.queue.shift();C.postMessage(A,i),g.WORKING_COUNT++;const s=({data:A})=>{g.WORKING_COUNT--,C.removeEventListener("message",s),this.available.unshift(I),t(A),this.queue.length>0&&setTimeout(this.process,0)};C.addEventListener("message",s)}};const{maxWorker:A}=C;for(let g=0;g<A;g++){const C=new I;this.workers.push(C),this.available.push(g)}}get isBusy(){return this.available.length<=0}get workingCount(){return this.workers.length-this.available.length}};k.WORKING_COUNT=0;let F=k;const J="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICBjb25zdCBGQUNFUyA9IFsKICAgIHsKICAgICAgLy8gbGVmdAogICAgICBkaXI6IFstMSwgMCwgMF0sCiAgICAgIGNvcm5lcnM6IFsKICAgICAgICBbMCwgMSwgMF0sCiAgICAgICAgWzAsIDAsIDBdLAogICAgICAgIFswLCAxLCAxXSwKICAgICAgICBbMCwgMCwgMV0KICAgICAgXQogICAgfSwKICAgIHsKICAgICAgLy8gcmlnaHQKICAgICAgZGlyOiBbMSwgMCwgMF0sCiAgICAgIGNvcm5lcnM6IFsKICAgICAgICBbMSwgMSwgMV0sCiAgICAgICAgWzEsIDAsIDFdLAogICAgICAgIFsxLCAxLCAwXSwKICAgICAgICBbMSwgMCwgMF0KICAgICAgXQogICAgfSwKICAgIHsKICAgICAgLy8gYm90dG9tCiAgICAgIGRpcjogWzAsIC0xLCAwXSwKICAgICAgY29ybmVyczogWwogICAgICAgIFsxLCAwLCAxXSwKICAgICAgICBbMCwgMCwgMV0sCiAgICAgICAgWzEsIDAsIDBdLAogICAgICAgIFswLCAwLCAwXQogICAgICBdCiAgICB9LAogICAgewogICAgICAvLyB0b3AKICAgICAgZGlyOiBbMCwgMSwgMF0sCiAgICAgIGNvcm5lcnM6IFsKICAgICAgICBbMCwgMSwgMV0sCiAgICAgICAgWzEsIDEsIDFdLAogICAgICAgIFswLCAxLCAwXSwKICAgICAgICBbMSwgMSwgMF0KICAgICAgXQogICAgfSwKICAgIHsKICAgICAgLy8gYmFjawogICAgICBkaXI6IFswLCAwLCAtMV0sCiAgICAgIGNvcm5lcnM6IFsKICAgICAgICBbMSwgMCwgMF0sCiAgICAgICAgWzAsIDAsIDBdLAogICAgICAgIFsxLCAxLCAwXSwKICAgICAgICBbMCwgMSwgMF0KICAgICAgXQogICAgfSwKICAgIHsKICAgICAgLy8gZnJvbnQKICAgICAgZGlyOiBbMCwgMCwgMV0sCiAgICAgIGNvcm5lcnM6IFsKICAgICAgICBbMCwgMCwgMV0sCiAgICAgICAgWzEsIDAsIDFdLAogICAgICAgIFswLCAxLCAxXSwKICAgICAgICBbMSwgMSwgMV0KICAgICAgXQogICAgfQogIF07CiAgZnVuY3Rpb24gZ2V0KGFyciwgeCwgeSwgeiwgc3RyaWRlKSB7CiAgICBjb25zdCBpbmRleCA9IHggKiBzdHJpZGVbMF0gKyB5ICogc3RyaWRlWzFdICsgeiAqIHN0cmlkZVsyXTsKICAgIHJldHVybiBpbmRleCA+IGFyci5sZW5ndGggfHwgaW5kZXggPCAwID8gMCA6IGFycltpbmRleF07CiAgfQogIGZ1bmN0aW9uIGNvbnRhaW5zKHZveGVsLCBtaW4sIG1heCkgewogICAgY29uc3QgW3N4LCBzeSwgc3pdID0gbWluOwogICAgY29uc3QgW2V4LCBleSwgZXpdID0gbWF4OwogICAgY29uc3QgW3Z4LCB2eSwgdnpdID0gdm94ZWw7CiAgICByZXR1cm4gdnggPCBleCAmJiB2eCA+PSBzeCAmJiB2eSA8IGV5ICYmIHZ5ID49IHN5ICYmIHZ6IDwgZXogJiYgdnogPj0gc3o7CiAgfQogIG9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YSwKICAgICAgY29uZmlnczogeyBkaW1lbnNpb25zLCBtaW4sIG1heCwgcmVhbE1pbiwgcmVhbE1heCwgc3RyaWRlIH0KICAgIH0gPSBlLmRhdGE7CiAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTsKICAgIGNvbnN0IG5vcm1hbHMgPSBbXTsKICAgIGNvbnN0IGluZGljZXMgPSBbXTsKICAgIGNvbnN0IFtzdGFydFgsIHN0YXJ0WSwgc3RhcnRaXSA9IG1pbjsKICAgIGNvbnN0IFtlbmRYLCBlbmRZLCBlbmRaXSA9IG1heDsKICAgIGNvbnN0IFtkeCwgZHksIGR6XSA9IGRpbWVuc2lvbnM7CiAgICBmb3IgKGxldCB2eCA9IHN0YXJ0WCwgeCA9IDA7IHZ4IDwgZW5kWDsgKyt2eCwgKyt4KSB7CiAgICAgIGZvciAobGV0IHZ6ID0gc3RhcnRaLCB6ID0gMDsgdnogPCBlbmRaOyArK3Z6LCArK3opIHsKICAgICAgICBmb3IgKGxldCB2eSA9IHN0YXJ0WSwgeSA9IDA7IHZ5IDwgZW5kWTsgKyt2eSwgKyt5KSB7CiAgICAgICAgICBjb25zdCB2b3hlbCA9IGdldChkYXRhLCB2eCwgdnksIHZ6LCBzdHJpZGUpOwogICAgICAgICAgaWYgKHZveGVsKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgeyBkaXIsIGNvcm5lcnMgfSBvZiBGQUNFUykgewogICAgICAgICAgICAgIGNvbnN0IG52eCA9IHZ4ICsgZGlyWzBdOwogICAgICAgICAgICAgIGNvbnN0IG52eSA9IHZ5ICsgZGlyWzFdOwogICAgICAgICAgICAgIGNvbnN0IG52eiA9IHZ6ICsgZGlyWzJdOwogICAgICAgICAgICAgIGNvbnN0IG5Wb3hlbCA9IFtudngsIG52eSwgbnZ6XTsKICAgICAgICAgICAgICBpZiAoIWdldChkYXRhLCBudngsIG52eSwgbnZ6LCBzdHJpZGUpIHx8ICFjb250YWlucyhuVm94ZWwsIHJlYWxNaW4sIHJlYWxNYXgpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZHggPSBwb3NpdGlvbnMubGVuZ3RoIC8gMzsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcG9zIG9mIGNvcm5lcnMpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgcG9zWCA9IHBvc1swXSArIHg7CiAgICAgICAgICAgICAgICAgIGNvbnN0IHBvc1kgPSBwb3NbMV0gKyB5OwogICAgICAgICAgICAgICAgICBjb25zdCBwb3NaID0gcG9zWzJdICsgejsKICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2gocG9zWCAqIGR4LCBwb3NZICogZHksIHBvc1ogKiBkeik7CiAgICAgICAgICAgICAgICAgIG5vcm1hbHMucHVzaCguLi5kaXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5kaWNlcy5wdXNoKG5keCwgbmR4ICsgMSwgbmR4ICsgMiwgbmR4ICsgMiwgbmR4ICsgMSwgbmR4ICsgMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCBwb3NpdGlvbnNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkocG9zaXRpb25zKTsKICAgIGNvbnN0IG5vcm1hbHNBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkobm9ybWFscyk7CiAgICBjb25zdCBpbmRpY2VzQXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KGluZGljZXMpOwogICAgcG9zdE1lc3NhZ2UoCiAgICAgIHsKICAgICAgICBwb3NpdGlvbnM6IHBvc2l0aW9uc0FycmF5LAogICAgICAgIG5vcm1hbHM6IG5vcm1hbHNBcnJheSwKICAgICAgICBpbmRpY2VzOiBpbmRpY2VzQXJyYXkKICAgICAgfSwKICAgICAgLy8gQHRzLWlnbm9yZQogICAgICBbcG9zaXRpb25zQXJyYXkuYnVmZmVyLCBub3JtYWxzQXJyYXkuYnVmZmVyLCBpbmRpY2VzQXJyYXkuYnVmZmVyXQogICAgKTsKICB9Owp9KSgpOwo=",N="undefined"!=typeof self&&self.Blob&&new Blob([(v=J,Uint8Array.from(atob(v),(g=>g.charCodeAt(0))))],{type:"text/javascript;charset=utf-8"});var v;const z=new F((function(g){let I;try{if(I=N&&(self.URL||self.webkitURL).createObjectURL(N),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+J,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}),{maxWorker:2});async function M(g,I){const{stride:C,data:A}=g,{dimensions:i,min:t,max:s,realMin:o,realMax:e}=I;return new Promise((g=>{z.addJob({message:{data:A,configs:{min:t,max:s,dimensions:i,stride:C,realMin:o,realMax:e}},resolve:g,buffers:[A.buffer.slice(0)]})}))}const L="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgbm9pc2VqcyA9IHsgZXhwb3J0czoge30gfTsKICAoZnVuY3Rpb24obW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsKSB7CiAgICAgIGZ1bmN0aW9uIE5vaXNlKHNlZWQpIHsKICAgICAgICBmdW5jdGlvbiBHcmFkKHgsIHksIHopIHsKICAgICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgICAgdGhpcy56ID0gejsKICAgICAgICB9CiAgICAgICAgR3JhZC5wcm90b3R5cGUuZG90MiA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnggKiB4ICsgdGhpcy55ICogeTsKICAgICAgICB9OwogICAgICAgIEdyYWQucHJvdG90eXBlLmRvdDMgPSBmdW5jdGlvbih4LCB5LCB6KSB7CiAgICAgICAgICByZXR1cm4gdGhpcy54ICogeCArIHRoaXMueSAqIHkgKyB0aGlzLnogKiB6OwogICAgICAgIH07CiAgICAgICAgdGhpcy5ncmFkMyA9IFsKICAgICAgICAgIG5ldyBHcmFkKDEsIDEsIDApLAogICAgICAgICAgbmV3IEdyYWQoLTEsIDEsIDApLAogICAgICAgICAgbmV3IEdyYWQoMSwgLTEsIDApLAogICAgICAgICAgbmV3IEdyYWQoLTEsIC0xLCAwKSwKICAgICAgICAgIG5ldyBHcmFkKDEsIDAsIDEpLAogICAgICAgICAgbmV3IEdyYWQoLTEsIDAsIDEpLAogICAgICAgICAgbmV3IEdyYWQoMSwgMCwgLTEpLAogICAgICAgICAgbmV3IEdyYWQoLTEsIDAsIC0xKSwKICAgICAgICAgIG5ldyBHcmFkKDAsIDEsIDEpLAogICAgICAgICAgbmV3IEdyYWQoMCwgLTEsIDEpLAogICAgICAgICAgbmV3IEdyYWQoMCwgMSwgLTEpLAogICAgICAgICAgbmV3IEdyYWQoMCwgLTEsIC0xKQogICAgICAgIF07CiAgICAgICAgdGhpcy5wID0gWwogICAgICAgICAgMTUxLAogICAgICAgICAgMTYwLAogICAgICAgICAgMTM3LAogICAgICAgICAgOTEsCiAgICAgICAgICA5MCwKICAgICAgICAgIDE1LAogICAgICAgICAgMTMxLAogICAgICAgICAgMTMsCiAgICAgICAgICAyMDEsCiAgICAgICAgICA5NSwKICAgICAgICAgIDk2LAogICAgICAgICAgNTMsCiAgICAgICAgICAxOTQsCiAgICAgICAgICAyMzMsCiAgICAgICAgICA3LAogICAgICAgICAgMjI1LAogICAgICAgICAgMTQwLAogICAgICAgICAgMzYsCiAgICAgICAgICAxMDMsCiAgICAgICAgICAzMCwKICAgICAgICAgIDY5LAogICAgICAgICAgMTQyLAogICAgICAgICAgOCwKICAgICAgICAgIDk5LAogICAgICAgICAgMzcsCiAgICAgICAgICAyNDAsCiAgICAgICAgICAyMSwKICAgICAgICAgIDEwLAogICAgICAgICAgMjMsCiAgICAgICAgICAxOTAsCiAgICAgICAgICA2LAogICAgICAgICAgMTQ4LAogICAgICAgICAgMjQ3LAogICAgICAgICAgMTIwLAogICAgICAgICAgMjM0LAogICAgICAgICAgNzUsCiAgICAgICAgICAwLAogICAgICAgICAgMjYsCiAgICAgICAgICAxOTcsCiAgICAgICAgICA2MiwKICAgICAgICAgIDk0LAogICAgICAgICAgMjUyLAogICAgICAgICAgMjE5LAogICAgICAgICAgMjAzLAogICAgICAgICAgMTE3LAogICAgICAgICAgMzUsCiAgICAgICAgICAxMSwKICAgICAgICAgIDMyLAogICAgICAgICAgNTcsCiAgICAgICAgICAxNzcsCiAgICAgICAgICAzMywKICAgICAgICAgIDg4LAogICAgICAgICAgMjM3LAogICAgICAgICAgMTQ5LAogICAgICAgICAgNTYsCiAgICAgICAgICA4NywKICAgICAgICAgIDE3NCwKICAgICAgICAgIDIwLAogICAgICAgICAgMTI1LAogICAgICAgICAgMTM2LAogICAgICAgICAgMTcxLAogICAgICAgICAgMTY4LAogICAgICAgICAgNjgsCiAgICAgICAgICAxNzUsCiAgICAgICAgICA3NCwKICAgICAgICAgIDE2NSwKICAgICAgICAgIDcxLAogICAgICAgICAgMTM0LAogICAgICAgICAgMTM5LAogICAgICAgICAgNDgsCiAgICAgICAgICAyNywKICAgICAgICAgIDE2NiwKICAgICAgICAgIDc3LAogICAgICAgICAgMTQ2LAogICAgICAgICAgMTU4LAogICAgICAgICAgMjMxLAogICAgICAgICAgODMsCiAgICAgICAgICAxMTEsCiAgICAgICAgICAyMjksCiAgICAgICAgICAxMjIsCiAgICAgICAgICA2MCwKICAgICAgICAgIDIxMSwKICAgICAgICAgIDEzMywKICAgICAgICAgIDIzMCwKICAgICAgICAgIDIyMCwKICAgICAgICAgIDEwNSwKICAgICAgICAgIDkyLAogICAgICAgICAgNDEsCiAgICAgICAgICA1NSwKICAgICAgICAgIDQ2LAogICAgICAgICAgMjQ1LAogICAgICAgICAgNDAsCiAgICAgICAgICAyNDQsCiAgICAgICAgICAxMDIsCiAgICAgICAgICAxNDMsCiAgICAgICAgICA1NCwKICAgICAgICAgIDY1LAogICAgICAgICAgMjUsCiAgICAgICAgICA2MywKICAgICAgICAgIDE2MSwKICAgICAgICAgIDEsCiAgICAgICAgICAyMTYsCiAgICAgICAgICA4MCwKICAgICAgICAgIDczLAogICAgICAgICAgMjA5LAogICAgICAgICAgNzYsCiAgICAgICAgICAxMzIsCiAgICAgICAgICAxODcsCiAgICAgICAgICAyMDgsCiAgICAgICAgICA4OSwKICAgICAgICAgIDE4LAogICAgICAgICAgMTY5LAogICAgICAgICAgMjAwLAogICAgICAgICAgMTk2LAogICAgICAgICAgMTM1LAogICAgICAgICAgMTMwLAogICAgICAgICAgMTE2LAogICAgICAgICAgMTg4LAogICAgICAgICAgMTU5LAogICAgICAgICAgODYsCiAgICAgICAgICAxNjQsCiAgICAgICAgICAxMDAsCiAgICAgICAgICAxMDksCiAgICAgICAgICAxOTgsCiAgICAgICAgICAxNzMsCiAgICAgICAgICAxODYsCiAgICAgICAgICAzLAogICAgICAgICAgNjQsCiAgICAgICAgICA1MiwKICAgICAgICAgIDIxNywKICAgICAgICAgIDIyNiwKICAgICAgICAgIDI1MCwKICAgICAgICAgIDEyNCwKICAgICAgICAgIDEyMywKICAgICAgICAgIDUsCiAgICAgICAgICAyMDIsCiAgICAgICAgICAzOCwKICAgICAgICAgIDE0NywKICAgICAgICAgIDExOCwKICAgICAgICAgIDEyNiwKICAgICAgICAgIDI1NSwKICAgICAgICAgIDgyLAogICAgICAgICAgODUsCiAgICAgICAgICAyMTIsCiAgICAgICAgICAyMDcsCiAgICAgICAgICAyMDYsCiAgICAgICAgICA1OSwKICAgICAgICAgIDIyNywKICAgICAgICAgIDQ3LAogICAgICAgICAgMTYsCiAgICAgICAgICA1OCwKICAgICAgICAgIDE3LAogICAgICAgICAgMTgyLAogICAgICAgICAgMTg5LAogICAgICAgICAgMjgsCiAgICAgICAgICA0MiwKICAgICAgICAgIDIyMywKICAgICAgICAgIDE4MywKICAgICAgICAgIDE3MCwKICAgICAgICAgIDIxMywKICAgICAgICAgIDExOSwKICAgICAgICAgIDI0OCwKICAgICAgICAgIDE1MiwKICAgICAgICAgIDIsCiAgICAgICAgICA0NCwKICAgICAgICAgIDE1NCwKICAgICAgICAgIDE2MywKICAgICAgICAgIDcwLAogICAgICAgICAgMjIxLAogICAgICAgICAgMTUzLAogICAgICAgICAgMTAxLAogICAgICAgICAgMTU1LAogICAgICAgICAgMTY3LAogICAgICAgICAgNDMsCiAgICAgICAgICAxNzIsCiAgICAgICAgICA5LAogICAgICAgICAgMTI5LAogICAgICAgICAgMjIsCiAgICAgICAgICAzOSwKICAgICAgICAgIDI1MywKICAgICAgICAgIDE5LAogICAgICAgICAgOTgsCiAgICAgICAgICAxMDgsCiAgICAgICAgICAxMTAsCiAgICAgICAgICA3OSwKICAgICAgICAgIDExMywKICAgICAgICAgIDIyNCwKICAgICAgICAgIDIzMiwKICAgICAgICAgIDE3OCwKICAgICAgICAgIDE4NSwKICAgICAgICAgIDExMiwKICAgICAgICAgIDEwNCwKICAgICAgICAgIDIxOCwKICAgICAgICAgIDI0NiwKICAgICAgICAgIDk3LAogICAgICAgICAgMjI4LAogICAgICAgICAgMjUxLAogICAgICAgICAgMzQsCiAgICAgICAgICAyNDIsCiAgICAgICAgICAxOTMsCiAgICAgICAgICAyMzgsCiAgICAgICAgICAyMTAsCiAgICAgICAgICAxNDQsCiAgICAgICAgICAxMiwKICAgICAgICAgIDE5MSwKICAgICAgICAgIDE3OSwKICAgICAgICAgIDE2MiwKICAgICAgICAgIDI0MSwKICAgICAgICAgIDgxLAogICAgICAgICAgNTEsCiAgICAgICAgICAxNDUsCiAgICAgICAgICAyMzUsCiAgICAgICAgICAyNDksCiAgICAgICAgICAxNCwKICAgICAgICAgIDIzOSwKICAgICAgICAgIDEwNywKICAgICAgICAgIDQ5LAogICAgICAgICAgMTkyLAogICAgICAgICAgMjE0LAogICAgICAgICAgMzEsCiAgICAgICAgICAxODEsCiAgICAgICAgICAxOTksCiAgICAgICAgICAxMDYsCiAgICAgICAgICAxNTcsCiAgICAgICAgICAxODQsCiAgICAgICAgICA4NCwKICAgICAgICAgIDIwNCwKICAgICAgICAgIDE3NiwKICAgICAgICAgIDExNSwKICAgICAgICAgIDEyMSwKICAgICAgICAgIDUwLAogICAgICAgICAgNDUsCiAgICAgICAgICAxMjcsCiAgICAgICAgICA0LAogICAgICAgICAgMTUwLAogICAgICAgICAgMjU0LAogICAgICAgICAgMTM4LAogICAgICAgICAgMjM2LAogICAgICAgICAgMjA1LAogICAgICAgICAgOTMsCiAgICAgICAgICAyMjIsCiAgICAgICAgICAxMTQsCiAgICAgICAgICA2NywKICAgICAgICAgIDI5LAogICAgICAgICAgMjQsCiAgICAgICAgICA3MiwKICAgICAgICAgIDI0MywKICAgICAgICAgIDE0MSwKICAgICAgICAgIDEyOCwKICAgICAgICAgIDE5NSwKICAgICAgICAgIDc4LAogICAgICAgICAgNjYsCiAgICAgICAgICAyMTUsCiAgICAgICAgICA2MSwKICAgICAgICAgIDE1NiwKICAgICAgICAgIDE4MAogICAgICAgIF07CiAgICAgICAgdGhpcy5wZXJtID0gbmV3IEFycmF5KDUxMik7CiAgICAgICAgdGhpcy5ncmFkUCA9IG5ldyBBcnJheSg1MTIpOwogICAgICAgIHRoaXMuc2VlZChzZWVkIHx8IDApOwogICAgICB9CiAgICAgIE5vaXNlLnByb3RvdHlwZS5zZWVkID0gZnVuY3Rpb24oc2VlZCkgewogICAgICAgIGlmIChzZWVkID4gMCAmJiBzZWVkIDwgMSkgewogICAgICAgICAgc2VlZCAqPSA2NTUzNjsKICAgICAgICB9CiAgICAgICAgc2VlZCA9IE1hdGguZmxvb3Ioc2VlZCk7CiAgICAgICAgaWYgKHNlZWQgPCAyNTYpIHsKICAgICAgICAgIHNlZWQgfD0gc2VlZCA8PCA4OwogICAgICAgIH0KICAgICAgICB2YXIgcCA9IHRoaXMucDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgaSsrKSB7CiAgICAgICAgICB2YXIgdjsKICAgICAgICAgIGlmIChpICYgMSkgewogICAgICAgICAgICB2ID0gcFtpXSBeIHNlZWQgJiAyNTU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2ID0gcFtpXSBeIHNlZWQgPj4gOCAmIDI1NTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZXJtID0gdGhpcy5wZXJtOwogICAgICAgICAgdmFyIGdyYWRQID0gdGhpcy5ncmFkUDsKICAgICAgICAgIHBlcm1baV0gPSBwZXJtW2kgKyAyNTZdID0gdjsKICAgICAgICAgIGdyYWRQW2ldID0gZ3JhZFBbaSArIDI1Nl0gPSB0aGlzLmdyYWQzW3YgJSAxMl07CiAgICAgICAgfQogICAgICB9OwogICAgICB2YXIgRjIgPSAwLjUgKiAoTWF0aC5zcXJ0KDMpIC0gMSk7CiAgICAgIHZhciBHMiA9ICgzIC0gTWF0aC5zcXJ0KDMpKSAvIDY7CiAgICAgIHZhciBGMyA9IDEgLyAzOwogICAgICB2YXIgRzMgPSAxIC8gNjsKICAgICAgTm9pc2UucHJvdG90eXBlLnNpbXBsZXgyID0gZnVuY3Rpb24oeGluLCB5aW4pIHsKICAgICAgICB2YXIgbjAsIG4xLCBuMjsKICAgICAgICB2YXIgcyA9ICh4aW4gKyB5aW4pICogRjI7CiAgICAgICAgdmFyIGkgPSBNYXRoLmZsb29yKHhpbiArIHMpOwogICAgICAgIHZhciBqID0gTWF0aC5mbG9vcih5aW4gKyBzKTsKICAgICAgICB2YXIgdCA9IChpICsgaikgKiBHMjsKICAgICAgICB2YXIgeDAgPSB4aW4gLSBpICsgdDsKICAgICAgICB2YXIgeTAgPSB5aW4gLSBqICsgdDsKICAgICAgICB2YXIgaTEsIGoxOwogICAgICAgIGlmICh4MCA+IHkwKSB7CiAgICAgICAgICBpMSA9IDE7CiAgICAgICAgICBqMSA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkxID0gMDsKICAgICAgICAgIGoxID0gMTsKICAgICAgICB9CiAgICAgICAgdmFyIHgxID0geDAgLSBpMSArIEcyOwogICAgICAgIHZhciB5MSA9IHkwIC0gajEgKyBHMjsKICAgICAgICB2YXIgeDIgPSB4MCAtIDEgKyAyICogRzI7CiAgICAgICAgdmFyIHkyID0geTAgLSAxICsgMiAqIEcyOwogICAgICAgIGkgJj0gMjU1OwogICAgICAgIGogJj0gMjU1OwogICAgICAgIHZhciBwZXJtID0gdGhpcy5wZXJtOwogICAgICAgIHZhciBncmFkUCA9IHRoaXMuZ3JhZFA7CiAgICAgICAgdmFyIGdpMCA9IGdyYWRQW2kgKyBwZXJtW2pdXTsKICAgICAgICB2YXIgZ2kxID0gZ3JhZFBbaSArIGkxICsgcGVybVtqICsgajFdXTsKICAgICAgICB2YXIgZ2kyID0gZ3JhZFBbaSArIDEgKyBwZXJtW2ogKyAxXV07CiAgICAgICAgdmFyIHQwID0gMC41IC0geDAgKiB4MCAtIHkwICogeTA7CiAgICAgICAgaWYgKHQwIDwgMCkgewogICAgICAgICAgbjAgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0MCAqPSB0MDsKICAgICAgICAgIG4wID0gdDAgKiB0MCAqIGdpMC5kb3QyKHgwLCB5MCk7CiAgICAgICAgfQogICAgICAgIHZhciB0MSA9IDAuNSAtIHgxICogeDEgLSB5MSAqIHkxOwogICAgICAgIGlmICh0MSA8IDApIHsKICAgICAgICAgIG4xID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdDEgKj0gdDE7CiAgICAgICAgICBuMSA9IHQxICogdDEgKiBnaTEuZG90Mih4MSwgeTEpOwogICAgICAgIH0KICAgICAgICB2YXIgdDIgPSAwLjUgLSB4MiAqIHgyIC0geTIgKiB5MjsKICAgICAgICBpZiAodDIgPCAwKSB7CiAgICAgICAgICBuMiA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQyICo9IHQyOwogICAgICAgICAgbjIgPSB0MiAqIHQyICogZ2kyLmRvdDIoeDIsIHkyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDcwICogKG4wICsgbjEgKyBuMik7CiAgICAgIH07CiAgICAgIE5vaXNlLnByb3RvdHlwZS5zaW1wbGV4MyA9IGZ1bmN0aW9uKHhpbiwgeWluLCB6aW4pIHsKICAgICAgICB2YXIgbjAsIG4xLCBuMiwgbjM7CiAgICAgICAgdmFyIHMgPSAoeGluICsgeWluICsgemluKSAqIEYzOwogICAgICAgIHZhciBpID0gTWF0aC5mbG9vcih4aW4gKyBzKTsKICAgICAgICB2YXIgaiA9IE1hdGguZmxvb3IoeWluICsgcyk7CiAgICAgICAgdmFyIGsgPSBNYXRoLmZsb29yKHppbiArIHMpOwogICAgICAgIHZhciB0ID0gKGkgKyBqICsgaykgKiBHMzsKICAgICAgICB2YXIgeDAgPSB4aW4gLSBpICsgdDsKICAgICAgICB2YXIgeTAgPSB5aW4gLSBqICsgdDsKICAgICAgICB2YXIgejAgPSB6aW4gLSBrICsgdDsKICAgICAgICB2YXIgaTEsIGoxLCBrMTsKICAgICAgICB2YXIgaTIsIGoyLCBrMjsKICAgICAgICBpZiAoeDAgPj0geTApIHsKICAgICAgICAgIGlmICh5MCA+PSB6MCkgewogICAgICAgICAgICBpMSA9IDE7CiAgICAgICAgICAgIGoxID0gMDsKICAgICAgICAgICAgazEgPSAwOwogICAgICAgICAgICBpMiA9IDE7CiAgICAgICAgICAgIGoyID0gMTsKICAgICAgICAgICAgazIgPSAwOwogICAgICAgICAgfSBlbHNlIGlmICh4MCA+PSB6MCkgewogICAgICAgICAgICBpMSA9IDE7CiAgICAgICAgICAgIGoxID0gMDsKICAgICAgICAgICAgazEgPSAwOwogICAgICAgICAgICBpMiA9IDE7CiAgICAgICAgICAgIGoyID0gMDsKICAgICAgICAgICAgazIgPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaTEgPSAwOwogICAgICAgICAgICBqMSA9IDA7CiAgICAgICAgICAgIGsxID0gMTsKICAgICAgICAgICAgaTIgPSAxOwogICAgICAgICAgICBqMiA9IDA7CiAgICAgICAgICAgIGsyID0gMTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKHkwIDwgejApIHsKICAgICAgICAgICAgaTEgPSAwOwogICAgICAgICAgICBqMSA9IDA7CiAgICAgICAgICAgIGsxID0gMTsKICAgICAgICAgICAgaTIgPSAwOwogICAgICAgICAgICBqMiA9IDE7CiAgICAgICAgICAgIGsyID0gMTsKICAgICAgICAgIH0gZWxzZSBpZiAoeDAgPCB6MCkgewogICAgICAgICAgICBpMSA9IDA7CiAgICAgICAgICAgIGoxID0gMTsKICAgICAgICAgICAgazEgPSAwOwogICAgICAgICAgICBpMiA9IDA7CiAgICAgICAgICAgIGoyID0gMTsKICAgICAgICAgICAgazIgPSAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaTEgPSAwOwogICAgICAgICAgICBqMSA9IDE7CiAgICAgICAgICAgIGsxID0gMDsKICAgICAgICAgICAgaTIgPSAxOwogICAgICAgICAgICBqMiA9IDE7CiAgICAgICAgICAgIGsyID0gMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHgxID0geDAgLSBpMSArIEczOwogICAgICAgIHZhciB5MSA9IHkwIC0gajEgKyBHMzsKICAgICAgICB2YXIgejEgPSB6MCAtIGsxICsgRzM7CiAgICAgICAgdmFyIHgyID0geDAgLSBpMiArIDIgKiBHMzsKICAgICAgICB2YXIgeTIgPSB5MCAtIGoyICsgMiAqIEczOwogICAgICAgIHZhciB6MiA9IHowIC0gazIgKyAyICogRzM7CiAgICAgICAgdmFyIHgzID0geDAgLSAxICsgMyAqIEczOwogICAgICAgIHZhciB5MyA9IHkwIC0gMSArIDMgKiBHMzsKICAgICAgICB2YXIgejMgPSB6MCAtIDEgKyAzICogRzM7CiAgICAgICAgaSAmPSAyNTU7CiAgICAgICAgaiAmPSAyNTU7CiAgICAgICAgayAmPSAyNTU7CiAgICAgICAgdmFyIHBlcm0gPSB0aGlzLnBlcm07CiAgICAgICAgdmFyIGdyYWRQID0gdGhpcy5ncmFkUDsKICAgICAgICB2YXIgZ2kwID0gZ3JhZFBbaSArIHBlcm1baiArIHBlcm1ba11dXTsKICAgICAgICB2YXIgZ2kxID0gZ3JhZFBbaSArIGkxICsgcGVybVtqICsgajEgKyBwZXJtW2sgKyBrMV1dXTsKICAgICAgICB2YXIgZ2kyID0gZ3JhZFBbaSArIGkyICsgcGVybVtqICsgajIgKyBwZXJtW2sgKyBrMl1dXTsKICAgICAgICB2YXIgZ2kzID0gZ3JhZFBbaSArIDEgKyBwZXJtW2ogKyAxICsgcGVybVtrICsgMV1dXTsKICAgICAgICB2YXIgdDAgPSAwLjUgLSB4MCAqIHgwIC0geTAgKiB5MCAtIHowICogejA7CiAgICAgICAgaWYgKHQwIDwgMCkgewogICAgICAgICAgbjAgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0MCAqPSB0MDsKICAgICAgICAgIG4wID0gdDAgKiB0MCAqIGdpMC5kb3QzKHgwLCB5MCwgejApOwogICAgICAgIH0KICAgICAgICB2YXIgdDEgPSAwLjUgLSB4MSAqIHgxIC0geTEgKiB5MSAtIHoxICogejE7CiAgICAgICAgaWYgKHQxIDwgMCkgewogICAgICAgICAgbjEgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0MSAqPSB0MTsKICAgICAgICAgIG4xID0gdDEgKiB0MSAqIGdpMS5kb3QzKHgxLCB5MSwgejEpOwogICAgICAgIH0KICAgICAgICB2YXIgdDIgPSAwLjUgLSB4MiAqIHgyIC0geTIgKiB5MiAtIHoyICogejI7CiAgICAgICAgaWYgKHQyIDwgMCkgewogICAgICAgICAgbjIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0MiAqPSB0MjsKICAgICAgICAgIG4yID0gdDIgKiB0MiAqIGdpMi5kb3QzKHgyLCB5MiwgejIpOwogICAgICAgIH0KICAgICAgICB2YXIgdDMgPSAwLjUgLSB4MyAqIHgzIC0geTMgKiB5MyAtIHozICogejM7CiAgICAgICAgaWYgKHQzIDwgMCkgewogICAgICAgICAgbjMgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0MyAqPSB0MzsKICAgICAgICAgIG4zID0gdDMgKiB0MyAqIGdpMy5kb3QzKHgzLCB5MywgejMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMzIgKiAobjAgKyBuMSArIG4yICsgbjMpOwogICAgICB9OwogICAgICBmdW5jdGlvbiBmYWRlKHQpIHsKICAgICAgICByZXR1cm4gdCAqIHQgKiB0ICogKHQgKiAodCAqIDYgLSAxNSkgKyAxMCk7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbGVycChhLCBiLCB0KSB7CiAgICAgICAgcmV0dXJuICgxIC0gdCkgKiBhICsgdCAqIGI7CiAgICAgIH0KICAgICAgTm9pc2UucHJvdG90eXBlLnBlcmxpbjIgPSBmdW5jdGlvbih4LCB5KSB7CiAgICAgICAgdmFyIFggPSBNYXRoLmZsb29yKHgpLCBZID0gTWF0aC5mbG9vcih5KTsKICAgICAgICB4ID0geCAtIFg7CiAgICAgICAgeSA9IHkgLSBZOwogICAgICAgIFggPSBYICYgMjU1OwogICAgICAgIFkgPSBZICYgMjU1OwogICAgICAgIHZhciBwZXJtID0gdGhpcy5wZXJtOwogICAgICAgIHZhciBncmFkUCA9IHRoaXMuZ3JhZFA7CiAgICAgICAgdmFyIG4wMCA9IGdyYWRQW1ggKyBwZXJtW1ldXS5kb3QyKHgsIHkpOwogICAgICAgIHZhciBuMDEgPSBncmFkUFtYICsgcGVybVtZICsgMV1dLmRvdDIoeCwgeSAtIDEpOwogICAgICAgIHZhciBuMTAgPSBncmFkUFtYICsgMSArIHBlcm1bWV1dLmRvdDIoeCAtIDEsIHkpOwogICAgICAgIHZhciBuMTEgPSBncmFkUFtYICsgMSArIHBlcm1bWSArIDFdXS5kb3QyKHggLSAxLCB5IC0gMSk7CiAgICAgICAgdmFyIHUgPSBmYWRlKHgpOwogICAgICAgIHJldHVybiBsZXJwKAogICAgICAgICAgbGVycChuMDAsIG4xMCwgdSksCiAgICAgICAgICBsZXJwKG4wMSwgbjExLCB1KSwKICAgICAgICAgIGZhZGUoeSkKICAgICAgICApOwogICAgICB9OwogICAgICBOb2lzZS5wcm90b3R5cGUucGVybGluMyA9IGZ1bmN0aW9uKHgsIHksIHopIHsKICAgICAgICB2YXIgWCA9IE1hdGguZmxvb3IoeCksIFkgPSBNYXRoLmZsb29yKHkpLCBaID0gTWF0aC5mbG9vcih6KTsKICAgICAgICB4ID0geCAtIFg7CiAgICAgICAgeSA9IHkgLSBZOwogICAgICAgIHogPSB6IC0gWjsKICAgICAgICBYID0gWCAmIDI1NTsKICAgICAgICBZID0gWSAmIDI1NTsKICAgICAgICBaID0gWiAmIDI1NTsKICAgICAgICB2YXIgcGVybSA9IHRoaXMucGVybTsKICAgICAgICB2YXIgZ3JhZFAgPSB0aGlzLmdyYWRQOwogICAgICAgIHZhciBuMDAwID0gZ3JhZFBbWCArIHBlcm1bWSArIHBlcm1bWl1dXS5kb3QzKHgsIHksIHopOwogICAgICAgIHZhciBuMDAxID0gZ3JhZFBbWCArIHBlcm1bWSArIHBlcm1bWiArIDFdXV0uZG90Myh4LCB5LCB6IC0gMSk7CiAgICAgICAgdmFyIG4wMTAgPSBncmFkUFtYICsgcGVybVtZICsgMSArIHBlcm1bWl1dXS5kb3QzKHgsIHkgLSAxLCB6KTsKICAgICAgICB2YXIgbjAxMSA9IGdyYWRQW1ggKyBwZXJtW1kgKyAxICsgcGVybVtaICsgMV1dXS5kb3QzKHgsIHkgLSAxLCB6IC0gMSk7CiAgICAgICAgdmFyIG4xMDAgPSBncmFkUFtYICsgMSArIHBlcm1bWSArIHBlcm1bWl1dXS5kb3QzKHggLSAxLCB5LCB6KTsKICAgICAgICB2YXIgbjEwMSA9IGdyYWRQW1ggKyAxICsgcGVybVtZICsgcGVybVtaICsgMV1dXS5kb3QzKHggLSAxLCB5LCB6IC0gMSk7CiAgICAgICAgdmFyIG4xMTAgPSBncmFkUFtYICsgMSArIHBlcm1bWSArIDEgKyBwZXJtW1pdXV0uZG90Myh4IC0gMSwgeSAtIDEsIHopOwogICAgICAgIHZhciBuMTExID0gZ3JhZFBbWCArIDEgKyBwZXJtW1kgKyAxICsgcGVybVtaICsgMV1dXS5kb3QzKHggLSAxLCB5IC0gMSwgeiAtIDEpOwogICAgICAgIHZhciB1ID0gZmFkZSh4KTsKICAgICAgICB2YXIgdiA9IGZhZGUoeSk7CiAgICAgICAgdmFyIHcgPSBmYWRlKHopOwogICAgICAgIHJldHVybiBsZXJwKAogICAgICAgICAgbGVycCgKICAgICAgICAgICAgbGVycChuMDAwLCBuMTAwLCB1KSwKICAgICAgICAgICAgbGVycChuMDAxLCBuMTAxLCB1KSwKICAgICAgICAgICAgdwogICAgICAgICAgKSwKICAgICAgICAgIGxlcnAoCiAgICAgICAgICAgIGxlcnAobjAxMCwgbjExMCwgdSksCiAgICAgICAgICAgIGxlcnAobjAxMSwgbjExMSwgdSksCiAgICAgICAgICAgIHcKICAgICAgICAgICksCiAgICAgICAgICB2CiAgICAgICAgKTsKICAgICAgfTsKICAgICAgZ2xvYmFsLk5vaXNlID0gTm9pc2U7CiAgICB9KShtb2R1bGUuZXhwb3J0cyk7CiAgfSkobm9pc2Vqcyk7CiAgdmFyIG5vaXNlanNFeHBvcnRzID0gbm9pc2Vqcy5leHBvcnRzOwogIGZ1bmN0aW9uIHNldChhcnIsIHgsIHksIHosIHN0cmlkZSwgdmFsdWUpIHsKICAgIGFyclt4ICogc3RyaWRlWzBdICsgeSAqIHN0cmlkZVsxXSArIHogKiBzdHJpZGVbMl1dID0gdmFsdWU7CiAgfQogIGNvbnN0IGluc3RhbmNlID0gbmV3IG5vaXNlanNFeHBvcnRzLk5vaXNlKCk7CiAgZnVuY3Rpb24gbm9pc2UoeCwgeSwgeiwgb2N0YXZlcywgZmFsbG9mZiwgbGFjdW5hcml0eSA9IDAuOCkgewogICAgbGV0IHRvdGFsID0gMDsKICAgIGxldCBmcmVxdWVuY3kgPSAxOwogICAgbGV0IGFtcGxpdHVkZSA9IDE7CiAgICBsZXQgbWF4VmFsID0gMDsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2N0YXZlczsgaSsrKSB7CiAgICAgIHRvdGFsICs9IGluc3RhbmNlLnNpbXBsZXgzKHggKiBmcmVxdWVuY3ksIHkgKiBmcmVxdWVuY3ksIHogKiBmcmVxdWVuY3kpICogYW1wbGl0dWRlOwogICAgICBtYXhWYWwgKz0gYW1wbGl0dWRlOwogICAgICBhbXBsaXR1ZGUgKj0gZmFsbG9mZjsKICAgICAgZnJlcXVlbmN5ICo9IGxhY3VuYXJpdHk7CiAgICB9CiAgICByZXR1cm4gdG90YWwgLyBtYXhWYWw7CiAgfQogIG9ubWVzc2FnZSA9IGZ1bmN0aW9uKGUpIHsKICAgIGNvbnN0IHsKICAgICAgZGF0YSwKICAgICAgY29uZmlnczogewogICAgICAgIG1pbiwKICAgICAgICBtYXgsCiAgICAgICAgbm9pc2VTY2FsZSwKICAgICAgICB0aHJlc2hvbGQsCiAgICAgICAgc3RyaWRlLAogICAgICAgIG9jdGF2ZXMsCiAgICAgICAgZmFsbG9mZiwKICAgICAgICBzZWVkCiAgICAgIH0KICAgIH0gPSBlLmRhdGE7CiAgICBpbnN0YW5jZS5zZWVkKHNlZWQpOwogICAgY29uc3QgW3N0YXJ0WCwgc3RhcnRZLCBzdGFydFpdID0gbWluOwogICAgY29uc3QgW2VuZFgsIGVuZFksIGVuZFpdID0gbWF4OwogICAgZm9yIChsZXQgdnggPSBzdGFydFgsIGx4ID0gMDsgdnggPCBlbmRYOyArK3Z4LCArK2x4KSB7CiAgICAgIGZvciAobGV0IHZ6ID0gc3RhcnRaLCBseiA9IDA7IHZ6IDwgZW5kWjsgKyt2eiwgKytseikgewogICAgICAgIGZvciAobGV0IHZ5ID0gc3RhcnRZLCBseSA9IDA7IHZ5IDwgZW5kWTsgKyt2eSwgKytseSkgewogICAgICAgICAgY29uc3QgdmFsdWUgPSBub2lzZSgKICAgICAgICAgICAgdnggKiBub2lzZVNjYWxlLAogICAgICAgICAgICB2eSAqIG5vaXNlU2NhbGUsCiAgICAgICAgICAgIHZ6ICogbm9pc2VTY2FsZSwKICAgICAgICAgICAgb2N0YXZlcywKICAgICAgICAgICAgZmFsbG9mZgogICAgICAgICAgKSA+IHRocmVzaG9sZCA/IDEgOiAwOwogICAgICAgICAgc2V0KGRhdGEsIGx4LCBseSwgbHosIHN0cmlkZSwgdmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcG9zdE1lc3NhZ2UoZGF0YSwgW2RhdGEuYnVmZmVyXSk7CiAgfTsKfSkoKTsK",x="undefined"!=typeof self&&self.Blob&&new Blob([(g=>Uint8Array.from(atob(g),(g=>g.charCodeAt(0))))(L)],{type:"text/javascript;charset=utf-8"});function D(g){let I;try{if(I=x&&(self.URL||self.webkitURL).createObjectURL(x),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+L,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}const f={alpha:.8,color:"#fff",count:16,noiseScale:.08,width:8,height:3,dimensions:[20,20,20],speedFactor:8,lerpFactor:.3,threshold:.05,octaves:5,falloff:.9,seed:-1,cloudHeight:256};class T extends i.YJl{constructor(g={}){super(),this.isInitialized=!1,this.meshes=[],this.xOffset=0,this.zOffset=0,this.locatedCell=[0,0],this.newPosition=new i.Pq0,this.pool=new F(D,{maxWorker:2}),this.clock=new i.zD7,this.reset=async()=>{this.children.forEach((g=>{var I;g.parent&&(g.parent.remove(g),null==(I=g.geometry)||I.dispose())})),this.meshes.length=0,await this.initialize()},this.update=g=>{if(!this.isInitialized)return;const I=Math.min(.1,this.clock.getDelta()),{speedFactor:C,count:A,dimensions:i}=this.options;this.newPosition=this.position.clone(),this.newPosition.z-=C*I;const t=[Math.floor((g.x-this.position.x)/(A*i[0])),Math.floor((g.z-this.position.z)/(A*i[2]))];if(this.locatedCell[0]!==t[0]||this.locatedCell[1]!==t[1]){const g=t[0]-this.locatedCell[0],I=t[1]-this.locatedCell[1];this.locatedCell=t,Math.abs(g)>1||Math.abs(I)>1?this.reset():(g&&this.shiftX(g),I&&this.shiftZ(I))}this.position.lerp(this.newPosition,this.options.lerpFactor)},this.initialize=async()=>{const{width:g}=this.options,[I,C]=this.locatedCell;for(let A=0;A<g;A++){const i=[];for(let t=0;t<g;t++){const g=await this.makeCell(A+I,t+C);this.add(g),i.push(g)}this.meshes.push(i)}this.isInitialized=!0},this.shiftX=async(g=1)=>{const{width:I}=this.options,C=g>0?this.meshes.shift():this.meshes.pop();for(let A=0;A<I;A++)await this.makeCell(this.xOffset+(g>0?I:0),A+this.zOffset,C[A]);g>0?this.meshes.push(C):this.meshes.unshift(C),this.xOffset+=g},this.shiftZ=async(g=1)=>{const{width:I}=this.options;if(this.meshes&&0!==this.meshes.length){for(let C=0;C<I;C++){this.meshes[C]||(this.meshes[C]=[]);const A=this.meshes[C];if(0===A.length)continue;const i=g>0?A.shift():A.pop();if(!i)continue;const t=await this.makeCell(C+this.xOffset,this.zOffset+(g>0?I:0),i);g>0?A.push(t):A.unshift(t)}this.zOffset+=g}},this.makeCell=async(g,I,C)=>{const{width:t,height:s,count:o,noiseScale:e,seed:l,threshold:d,dimensions:n,cloudHeight:c,octaves:a,falloff:h}=this.options,Z=C?C.userData.data:A(new Uint8Array((o+2)*s*(o+2)),[o+2,s,o+2]),m=[g*o-1,0,I*o-1],b=[(g+1)*o+1,s,(I+1)*o+1],G=await new Promise((g=>this.pool.addJob({message:{data:Z.data,configs:{min:m,max:b,noiseScale:e,threshold:d,stride:Z.stride,octaves:a,falloff:h,seed:l}},resolve:g,buffers:[Z.data.buffer.slice(0)]})));Z.data=G;const{positions:B,indices:W,normals:p}=await M(Z,{dimensions:n,min:[1,0,1],max:[o+1,s,o+1],realMin:[0,0,0],realMax:[o+2,s,o+2]}),u=C?C.geometry:new i.LoY;return u.setAttribute("position",new i.qtW(B,3)),u.setAttribute("normal",new i.wvS(p,3)),u.setIndex(Array.from(W)),u.computeBoundingBox(),(C=C||new i.eaF(u,this.material)).position.setX((-t/2+g)*o*n[0]),C.position.setY(c),C.position.setZ((-t/2+I)*o*n[2]),C.userData.data=Z,C.renderOrder=-1,C},this.options={...f,...g};const{seed:I,color:C,alpha:t,uFogNear:s,uFogFar:o,uFogColor:e}=this.options;-1===I&&(this.options.seed=Math.floor(10230123*Math.random())),this.material=new i.BKk({transparent:!0,vertexShader:"varying vec4 vWorldPosition;\n\nvoid main() {\n  vWorldPosition = modelMatrix * vec4(position, 1.0);\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"uniform vec3 uFogColor;\nuniform vec3 uCloudColor;\nuniform float uFogNear;\nuniform float uFogFar;\nuniform float uCloudAlpha;\n\nvarying vec4 vWorldPosition;\n\nvoid main() {\n  gl_FragColor = vec4(uCloudColor, uCloudAlpha);\n\n  // fog\n  vec3 fogOrigin = cameraPosition;\n  float depth = sqrt(pow(vWorldPosition.x - fogOrigin.x, 2.0) + pow(vWorldPosition.z - fogOrigin.z, 2.0)) / 8.0;\n\n  float fogFactor = smoothstep(uFogNear, uFogFar, depth);\n  gl_FragColor.rgb = mix(gl_FragColor.rgb, uFogColor, fogFactor);\n}\n",side:i.hB5,uniforms:{uFogNear:s||{value:500},uFogFar:o||{value:1e3},uFogColor:e||{value:new i.Q1f("#fff")},uCloudColor:{value:new i.Q1f(C)},uCloudAlpha:{value:t}}}),this.material.toneMapped=!1,this.initialize()}}class Q{static generateClip(g,I,C,A,t,s){if(t.length!==s.length)throw new Error("midPositions and midQuaternions must have the same length");if(t.length!==I.length-2)throw new Error("midPositions must have two less length than times");const o=[],e=[];o.push(C.x,C.y,C.z),e.push(A.x,A.y,A.z,A.w);for(let i=0;i<t.length;i++)o.push(t[i].x,t[i].y,t[i].z),e.push(s[i].x,s[i].y,s[i].z,s[i].w);o.push(C.x,C.y,C.z),e.push(A.x,A.y,A.z,A.w);const l=new i.RiT(".position",I,o),d=new i.MBL(".quaternion",I,e);return new i.tz3(g,I[I.length-1],[l,d])}}var P=(g=>(g.And="and",g.Or="or",g.Not="not",g))(P||{});const j=0,U=1,O=2,E=3,q=4,$=5,_=16,gg=[],Ig=[],Cg=[];for(let KC=0;KC<_;KC++){const g=[[KC/_*Math.PI*2,KC],[KC/_*Math.PI*2-2*Math.PI,KC]];gg.push(...g),KC%2==0&&Ig.push(...g),KC%4==0&&Cg.push(...g)}const Ag=Math.PI,ig=Math.PI/2,tg=class g{constructor(I=j,C=0){this.rotateNode=(I,C=!0,A=!0)=>{switch(C&&0!==this.yRotation&&(I[0]-=.5,I[2]-=.5,g.rotateY(I,this.yRotation),I[0]+=.5,I[2]+=.5),this.value){case O:g.rotateZ(I,-ig),A&&(I[1]+=1);break;case E:g.rotateZ(I,ig),A&&(I[0]+=1);break;case j:break;case U:g.rotateX(I,Ag),A&&(I[1]+=1,I[2]+=1);break;case q:g.rotateX(I,ig),A&&(I[1]+=1);break;case $:g.rotateX(I,-ig),A&&(I[2]+=1)}},this.rotateAABB=(g,I=!0,C=!0)=>{const A=[g.minX,g.minY,g.minZ],i=[g.maxX,g.maxY,g.maxZ];let t=null,o=null,e=null,l=null;if(I&&0!==this.yRotation){[[g.minX,g.minY,g.minZ],[g.minX,g.minY,g.maxZ],[g.maxX,g.minY,g.minZ],[g.maxX,g.minY,g.maxZ]].forEach((g=>{this.rotateNode(g,!0,!0),t=null===t?g[0]:Math.min(t,g[0]),o=null===o?g[2]:Math.min(o,g[2])}));[[g.minX,g.maxY,g.minZ],[g.minX,g.maxY,g.maxZ],[g.maxX,g.maxY,g.minZ],[g.maxX,g.maxY,g.maxZ]].forEach((g=>{this.rotateNode(g,!0,!0),e=null===e?g[0]:Math.max(e,g[0]),l=null===l?g[2]:Math.max(l,g[2])}))}this.rotateNode(A,I,C),this.rotateNode(i,I,C);const d=g=>g<1e-4?0:g;A[0]=d(A[0]),A[1]=d(A[1]),A[2]=d(A[2]),i[0]=d(i[0]),i[1]=d(i[1]),i[2]=d(i[2]);const n=[null!==t?d(t):Math.min(A[0],i[0]),Math.min(A[1],i[1]),null!==o?d(o):Math.min(A[2],i[2])],c=[null!==e?d(e):Math.max(A[0],i[0]),Math.max(A[1],i[1]),null!==l?d(l):Math.max(A[2],i[2])];return new s(n[0],n[1],n[2],c[0],c[1],c[2])},this.value=I,this.yRotation=C}rotateTransparency([g,I,C,A,i,t]){const s=this.value;if(Math.abs(s)<Number.EPSILON)return[g,I,C,A,i,t];const o=[1,2,3],e=[4,5,6];this.rotateNode(o,!0,!1),this.rotateNode(e,!0,!1);const l=o.map((s=>1===s?g:2===s?I:3===s?C:4===s?A:5===s?i:t)),d=e.map((s=>1===s?g:2===s?I:3===s?C:4===s?A:5===s?i:t));return[l[0],l[1],l[2],d[0],d[1],d[2]]}};tg.encode=(g,I=0)=>{const C=I*Math.PI*2/_;return new tg(g,C)},tg.decode=g=>[g.value,Math.round(g.yRotation*_/(2*Math.PI))%_],tg.rotateX=(g,I)=>{const C=Math.sin(I),A=Math.cos(I),[,i,t]=g;g[1]=i*A-t*C,g[2]=t*A+i*C},tg.rotateY=(g,I)=>{const C=Math.sin(I),A=Math.cos(I),[i,,t]=g;g[0]=i*A+t*C,g[2]=t*A-i*C},tg.rotateZ=(g,I)=>{const C=Math.sin(I),A=Math.cos(I),[i,t]=g;g[0]=i*A-t*C,g[1]=t*A+i*C};let sg=tg;const og=class{static getBlockRotatedTransparency(g,I){return I.rotateTransparency(g.isTransparent)}static getBlockEntityId(g,I){const[C,A,i]=I;return`block::${g}::${C}::${A}::${i}`}constructor(){}};og.extractID=g=>65535&g,og.insertID=(g,I)=>4294901760&g|65535&I,og.extractRotation=g=>{const I=g>>16&15,C=g>>20&15;return sg.encode(I,C)},og.insertRotation=(g,I)=>{const[C,A]=sg.decode(I);return 4279238655&(4293984255&g|(15&C)<<16)|(15&A)<<20},og.extractStage=g=>g>>24&15,og.insertStage=(g,I)=>4043309055&g|I<<24,og.insertAll=(g,I,C)=>{let A=0;return A=og.insertID(A,g),I&&(A=og.insertRotation(A,I)),void 0!==C&&(A=og.insertStage(A,C)),A},og.getBlockTorchLightLevel=(g,I)=>{switch(I){case"RED":return g.redLightLevel;case"GREEN":return g.greenLightLevel;case"BLUE":return g.blueLightLevel}return 0},og.evaluateBlockRule=(g,I,C)=>{if("none"===g.type)return!0;if("simple"===g.type){const{offset:A,id:i,rotation:t,stage:s}=g,[o,e,l]=I,d=A[0]+o,n=A[1]+e,c=A[2]+l;if(null!==i){if(C.getVoxelAt(d,n,c)!==i)return!1}if(null!==t){const g=C.getVoxelRotationAt(d,n,c);if(g.value!==t.value||g.yRotation!==t.yRotation)return!1}if(null!==s){if(C.getVoxelStageAt(d,n,c)!==s)return!1}return!0}if("combination"===g.type){const{logic:A,rules:i}=g;switch(A){case P.And:return i.every((g=>og.evaluateBlockRule(g,I,C)));case P.Or:return i.some((g=>og.evaluateBlockRule(g,I,C)));case P.Not:return!i.some((g=>og.evaluateBlockRule(g,I,C)));default:return!1}}return!1};let eg=og;const lg=class{constructor(){}};lg.getChunkName=(g,I="|")=>g[0]+I+g[1],lg.getVoxelName=(g,I="|")=>(0|g[0])+I+(0|g[1])+I+(0|g[2]),lg.parseChunkName=(g,I="|")=>g.split(I).map((g=>parseInt(g,10))),lg.scaleCoordsF=(g,I)=>{const C=o.scale([0,0,0],g,I);return o.floor(C,C)},lg.mapVoxelToChunkLocal=(g,I)=>{const[C,A]=lg.mapVoxelToChunk(g,I),[i,t,s]=g;return[i-C*I,t,s-A*I]},lg.mapVoxelToChunk=(g,I)=>{const C=lg.scaleCoordsF(g,1/I);return[C[0],C[2]]},lg.mapChunkToVoxel=(g,I)=>{const C=[0,0,0];return o.copy(C,[g[0],0,g[1]]),o.scale(C,C,I),C},lg.mapWorldToVoxel=g=>lg.scaleCoordsF(g,1);let dg=lg;const ng=class{constructor(){}};ng.applyStyles=(g,I)=>{if(g)return Object.keys(I).forEach((C=>{const A=I[C];Array.isArray(g)?g.forEach((g=>g.style[C]=A)):g.style[C]=A})),g},ng.rgba=(g,I,C,A)=>`rgba(${255*g}, ${255*I}, ${255*C}, ${A})`,ng.keyMap=null,ng.mapKeyToCode=g=>{if(!ng.keyMap){ng.keyMap={ArrowUp:"KeyW",ArrowDown:"KeyS",ArrowLeft:"KeyA",ArrowRight:"KeyD",Space:"Space",ShiftLeft:"ShiftLeft",ShiftRight:"ShiftRight",ControlLeft:"ControlLeft",ControlRight:"ControlRight",AltLeft:"AltLeft",AltRight:"AltRight",Enter:"Enter",Escape:"Escape",Tab:"Tab","/":"Slash",".":"Period",",":"Comma",";":"Semicolon","'":"Quote","[":"BracketLeft","]":"BracketRight","\\":"Backslash","-":"Minus","=":"Equal","`":"Backquote"};for(let g=65;g<=90;g++){const I=String.fromCharCode(g);ng.keyMap[I.toLowerCase()]=`Key${I}`}for(let g=0;g<=9;g++)ng.keyMap[g.toString()]=`Digit${g}`}return ng.keyMap[g]||g};let cg=ng;const ag=class{constructor(){}};ag.extractSunlight=g=>g>>12&15,ag.insertSunlight=(g,I)=>4095&g|I<<12,ag.extractRedLight=g=>g>>8&15,ag.insertRedLight=(g,I)=>61695&g|I<<8,ag.extractGreenLight=g=>g>>4&15,ag.insertGreenLight=(g,I)=>65295&g|I<<4,ag.extractBlueLight=g=>15&g,ag.insertBlueLight=(g,I)=>65520&g|I,ag.canEnterInto=(g,I,C,A)=>{if(1!==Math.abs(I+C+A))throw new Error("This isn't supposed to happen. Light neighboring direction should be on 1 axis only.");const[i,t,s,o,e,l]=g;return 1===I?o:-1===I?i:1===C?e:-1===C?t:1===A?l:s},ag.canEnter=(g,I,C,A,i)=>{if(1!==Math.abs(C+A+i))throw new Error("This isn't supposed to happen. Light neighboring direction should be on 1 axis only.");const[t,s,o,e,l,d]=g,[n,c,a,h,Z,m]=I;return 1===C?t&&h:-1===C?e&&n:1===A?s&&Z:-1===A?l&&c:1===i?o&&m:d&&a};let hg=ag;const Zg="RED",mg="GREEN",bg="BLUE",Gg="SUNLIGHT",Bg=2*Math.PI,Wg=class{constructor(){}};Wg.round=(g,I)=>Math.round(g*10**I)/10**I,Wg.normalizeAngle=g=>g-Bg*Math.floor((g+Math.PI)/Bg),Wg.directionToQuaternion=(g,I,C)=>(()=>{const A=new i.kn4,t=new i.PTz,s=new i.Pq0(0,0,0),o=new i.Pq0(0,1,0);return()=>t.setFromRotationMatrix(A.lookAt(new i.Pq0(-g,-I,-C),s,o))})()();let pg=Wg;class ug{static isTexture(g){return g&&g.isTexture}static isVector3(g){return g&&g.isVector3}static isColor(g){return g&&g.isColor}static isMatrix4(g){return g&&g.isMatrix4}static isQuaternion(g){return g&&g.isQuaternion}static isEuler(g){return g&&g.isEuler}static isBufferGeometry(g){return g&&g.isBufferGeometry}static isMesh(g){return g&&g.isMesh}static isGroup(g){return g&&g.isGroup}static isScene(g){return g&&g.isScene}static isCamera(g){return g&&g.isCamera}static isObject3D(g){return g&&g.isObject3D}static isCanvasTexture(g){return g&&g.isCanvasTexture}static isShaderMaterial(g){return g&&g.isShaderMaterial}}const rg={gap:0,layers:1,width:1,widthSegments:8,side:i.hB5,transparent:!1},yg=["back","front","top","bottom","left","right"];class Vg extends i.eaF{constructor(g,I,C,A,t,s,o,e){super(new i.iNn(g,I,C)),this.materials=new Map,this.paint=(g,I)=>{var C;const A="all"===g?yg:"sides"===g?["front","back","left","right"]:Array.isArray(g)?g:[g];for(const i of A){const g=this.materials.get(i);if(!g)continue;const A=null==(C=g.map)?void 0:C.image;if(!A)continue;const t=A.getContext("2d");if(!t)continue;t.imageSmoothingEnabled=!1;const{width:s,height:o}=this.getDimensionFromSide(i),e=g=>g.isColor;(g=>g.isTexture)(I)?t.drawImage(I.image,0,0,s,o):e(I)?(t.save(),t.fillStyle=`rgb(${255*I.r},${255*I.g},${255*I.b})`,t.fillRect(0,0,s,o),t.restore()):"function"==typeof I?I(t,A):console.warn("Invalid art type: ",I),g.needsUpdate=!0,g.map.needsUpdate=!0}},this.createCanvasMaterial=g=>{const I=document.createElement("canvas"),{width:C,height:A}=this.getDimensionFromSide(g);I.width=C,I.height=A;const t=new i.GOR(I);t.colorSpace=i.jf0;const s=new i.V9B({side:this.side,map:t,transparent:this.transparent,name:g});return s.toneMapped=!1,s.map&&(s.map.magFilter=i.hxR,s.map.minFilter=i.NZq,s.map.wrapS=i.GJx,s.map.wrapT=i.GJx,s.map.needsUpdate=!0),s},this.getDimensionFromSide=g=>{switch(g){case"front":case"back":case"top":case"bottom":return{width:this.widthSegments,height:this.heightSegments};case"left":case"right":return{width:this.depthSegments,height:this.heightSegments};default:throw new Error("Cannot derive width/height from unknown side.")}},this.width=g,this.height=I,this.depth=C,this.widthSegments=A,this.heightSegments=t,this.depthSegments=s,this.side=o,this.transparent=e;for(const i of yg)this.materials.set(i,this.createCanvasMaterial(i));const l=Array.from(this.materials.values()),d=l[0];l[0]=l[1],l[1]=d,this.material=l,this.rotation.y=Math.PI/2}}class Kg extends i.YJl{constructor(g={}){super(),this.boxLayers=[],this.paint=(g,I,C=0)=>{if(C>=this.boxLayers.length)throw new Error("Canvas box layer does not exist.");this.boxLayers[C].paint(g,I)},this.makeBoxes=()=>{const{layers:g,gap:I,side:C,width:A,height:i,depth:t,widthSegments:s,heightSegments:o,depthSegments:e,transparent:l}=this.options;if(!A)throw new Error("CanvasBox width must be specified.");this.width=A,this.height=i||A,this.depth=t||A;for(let d=0;d<g;d++){const g=new Vg(A+d*I*2,(i||A)+d*I*2,(t||A)+d*I*2,s,o||s,e||s,C,l);this.boxLayers.push(g),this.add(g)}},this.options={...rg,...g},this.makeBoxes()}get boxMaterials(){return this.boxLayers[0].materials}}const Xg={drawCrown:g=>{g.fillStyle="#f7ea00",[[0,0],[0,1],[0,2],[1,2],[2,2],[2,1],[3,0],[3,2],[4,0],[4,2],[5,1],[5,2],[6,2],[7,0],[7,1],[7,2]].forEach((([I,C])=>g.fillRect(I,C,1,1))),g.fillStyle="#51c2d5",[[1,1],[6,1]].forEach((([I,C])=>g.fillRect(I,C,1,1))),g.fillStyle="#ff005c",g.fillRect(3,1,1,1),g.fillRect(4,1,1,1)},drawSun:(g=50,I="#f8ffb5")=>(C,A)=>{const t=new i.Q1f(I);C.save(),C.beginPath();let s=A.width/2,o=A.height/2;const e=C.createRadialGradient(s,o,1,s,o,2*g);e.addColorStop(0,cg.rgba(1,1,1,.3)),e.addColorStop(1,cg.rgba(1,1,1,0)),C.arc(s,o,3*g,0,2*Math.PI,!1),C.fillStyle=e,C.fill(),C.closePath(),C.beginPath(),s=A.width/2-g/2,o=A.height/2-g/2,C.rect(s,o,g,g),C.fillStyle=cg.rgba(t.r,t.g,t.b,1),C.fill(),C.closePath(),C.beginPath();const l=g/1.6;s=A.width/2-l/2,o=A.height/2-l/2,C.rect(s,o,l,l),C.fillStyle=cg.rgba(1,1,1,.5),C.fill(),C.closePath(),C.restore()},drawMoon:(g=20,I="#e6e2d1",C=1)=>(A,t)=>{const s=new i.Q1f(I),o=t.width/2,e=t.height/2;A.beginPath();const l=A.createRadialGradient(o+g/2,e+g/2,1,o+g/2,e+g/2,2*g);l.addColorStop(0,cg.rgba(1,1,1,.3)),l.addColorStop(1,cg.rgba(1,1,1,0)),A.arc(o+g/2,e+g/2,2*g,0,2*Math.PI,!1),A.fillStyle=l,A.fill(),A.closePath(),A.save(),A.beginPath(),A.rect(o,e,g,g),A.clip(),A.beginPath(),A.rect(o,e,g,g),A.fillStyle=cg.rgba(s.r,s.g,s.b,1),A.fill(),A.translate(o,e),A.beginPath(),A.rect(4,4,g-8,g-8),A.fillStyle=cg.rgba(1,1,1,.8),A.fill();const d=C*g*2-g;A.beginPath(),A.rect(d,0,g,g),A.fillStyle=cg.rgba(0,0,0,.8),A.fill(),A.beginPath(),A.rect(2+d,2,g-4,g-4),A.fillStyle=cg.rgba(0,0,0,.9),A.fill(),A.restore()},drawStars:(g=100,I=["#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#8589FF","#FF8585"])=>(C,A)=>{const i=C.globalAlpha;for(let t=0;t<g;t++)C.globalAlpha=1*Math.random()+.5,C.beginPath(),C.arc(Math.random()*A.width,Math.random()*A.height,.5*Math.random(),0,2*Math.PI,!1),C.fillStyle=I[Math.floor(Math.random()*I.length)],C.fill();C.globalAlpha=i}},wg={dimension:2e3,lerpFactor:.1,transitionSpan:.05};class Yg extends Kg{constructor(g={}){super({width:.8*(g.dimension?g.dimension:wg.dimension),side:i.hsX,transparent:!0,widthSegments:512,heightSegments:512,depthSegments:512}),this.shadingData=[],this.setShadingPhases=g=>{if(0!==g.length){if(1===g.length){const{top:I,middle:C,bottom:A}=g[0].color,t=new i.Q1f(I),s=new i.Q1f(C),o=new i.Q1f(A);this.uTopColor.value.copy(t),this.uMiddleColor.value.copy(s),this.uBottomColor.value.copy(o),this.uSkyOffset.value=g[0].skyOffset,this.uVoidOffset.value=g[0].voidOffset}this.shadingData=g,this.shadingData.sort(((g,I)=>g.start-I.start))}},this.getTopColor=()=>this.uTopColor.value,this.getMiddleColor=()=>this.uMiddleColor.value,this.getBottomColor=()=>this.uBottomColor.value,this.update=(g,I,C)=>{if(this.rotation.z=2*Math.PI*(I/C),["top","right","left","front","back"].forEach((g=>{this.boxMaterials.get(g)})),this.position.copy(g),this.shadingData.length<=1)return;const A=[],t=this.options.transitionSpan*C;for(let i=0;i<this.shadingData.length;i++){const g=this.shadingData[i],s=this.shadingData[(i+1)%this.shadingData.length],{start:o}=g,e=o*C,l=s.start*C;if(e<l?I>=e&&I<l:I<l||I>=e){const s=Math.max(Math.min(I>=e?(I-e)/t:(I+C-e)/t,1),0);if(A.push([s,g]),I>=e?I<e+t:I+C<e+t){const g=this.shadingData[(i-1<0?i-1+this.shadingData.length:i-1)%this.shadingData.length];A.push([1-s,g])}break}}const s=[0,0,0],o=[0,0,0],e=[0,0,0];let l=0,d=0;const n={r:0,g:0,b:0};A.forEach((([g,I])=>{const{skyOffset:C,voidOffset:A,color:{top:t,middle:c,bottom:a}}=I,h=new i.Q1f(t),Z=new i.Q1f(c),m=new i.Q1f(a);h.getRGB(n),s[0]+=n.r*g,s[1]+=n.g*g,s[2]+=n.b*g,Z.getRGB(n),o[0]+=n.r*g,o[1]+=n.g*g,o[2]+=n.b*g,m.getRGB(n),e[0]+=n.r*g,e[1]+=n.g*g,e[2]+=n.b*g,l+=g*C,d+=g*A})),this.uTopColor.value.setRGB(s[0],s[1],s[2]),this.uMiddleColor.value.setRGB(o[0],o[1],o[2]),this.uBottomColor.value.setRGB(e[0],e[1],e[2]),this.uSkyOffset.value=l,this.uVoidOffset.value=d},this.createSkyShading=()=>{const{color:{top:g,middle:I,bottom:C},skyOffset:A,voidOffset:t}={color:{top:"#222",middle:"#222",bottom:"#222"},skyOffset:0,voidOffset:1200};this.uTopColor={value:new i.Q1f(g)},this.uMiddleColor={value:new i.Q1f(I)},this.uBottomColor={value:new i.Q1f(C)},this.uSkyOffset={value:A},this.uVoidOffset={value:t};const s=new i.nEu(this.options.dimension,2),o=new i.BKk({uniforms:{uTopColor:this.uTopColor,uMiddleColor:this.uMiddleColor,uBottomColor:this.uBottomColor,uSkyOffset:this.uSkyOffset,uVoidOffset:this.uVoidOffset,uExponent:{value:.6},uExponent2:{value:1.2}},vertexShader:"varying vec3 vWorldPosition;\n\nvoid main() {\n  vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n  vWorldPosition = worldPosition.xyz;\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"uniform vec3 uTopColor;\nuniform vec3 uMiddleColor;\nuniform vec3 uBottomColor;\nuniform float uSkyOffset;\nuniform float uVoidOffset;\nuniform float uExponent;\nuniform float uExponent2;\n\nvarying vec3 vWorldPosition;\n\nvoid main() {\n  float h = normalize(vWorldPosition + uSkyOffset).y;\n  float h2 = normalize(vWorldPosition + uVoidOffset).y;\n  vec3 color = mix(uMiddleColor, uTopColor, max(pow(max(h, 0.0), uExponent), 0.0));\n  gl_FragColor = vec4(mix(color, uBottomColor, max(pow(max(-h2, 0.0), uExponent2), 0.0)), 1.0);\n}\n",depthWrite:!1,side:i.hsX}),e=new i.eaF(s,o);this.attach(e)},this.options={...this.options,...wg,...g},this.boxMaterials.forEach((g=>g.depthWrite=!1)),this.frustumCulled=!1,this.renderOrder=-1,this.createSkyShading()}}const Hg=class g{static split(I,C="black"){const A=I.split(new RegExp(`(\\${g.SPLITTER}[^\\${g.SPLITTER}]*\\${g.SPLITTER})`)).filter(Boolean);A.length&&(A[0].includes(g.SPLITTER)||A.unshift(`${g.SPLITTER}${C}${g.SPLITTER}`),A[A.length-1].includes(g.SPLITTER)&&A.push(""));const i=[];for(let g=0;g<A.length;g+=2){const I=A[g].substring(1,A[g].length-1),C=A[g+1];i.push({color:I,text:C})}return i}};Hg.SPLITTER="\u2206";let Sg=Hg;class Rg extends i.kxk{constructor(g="",I=10){super(new i.RoJ),this._padding=0,this._borderWidth=0,this._borderRadius=0,this._borderColor="white",this._strokeWidth=0,this._strokeColor="white",this._fontFace="Arial",this._fontSize=90,this._fontWeight="normal",this._canvas=document.createElement("canvas"),this.generate=()=>{const g=this._canvas,I=g.getContext("2d"),C=Array.isArray(this.borderWidth)?this.borderWidth:[this.borderWidth,this.borderWidth],A=C.map((g=>g*this.fontSize*.1)),t=(Array.isArray(this.borderRadius)?this.borderRadius:[this.borderRadius,this.borderRadius,this.borderRadius,this.borderRadius]).map((g=>g*this.fontSize*.1)),s=Array.isArray(this.padding)?this.padding:[this.padding,this.padding],o=s.map((g=>g*this.fontSize*.1)),e=this.text.split("\n"),l=`${this.fontWeight} ${this.fontSize}px ${this.fontFace}`;I.font=l;const d=Math.max(...e.map((g=>{const C=Sg.split(g);let A=0;return C.forEach((({text:g})=>A+=I.measureText(g).width)),A}))),n=this.fontSize*e.length;if(g.width=d+2*A[0]+2*o[0],g.height=n+2*A[1]+2*o[1],this.borderWidth){if(I.strokeStyle=this.borderColor,A[0]){const C=A[0]/2;I.lineWidth=A[0],I.beginPath(),I.moveTo(C,t[0]),I.lineTo(C,g.height-t[3]),I.moveTo(g.width-C,t[1]),I.lineTo(g.width-C,g.height-t[2]),I.stroke()}if(A[1]){const C=A[1]/2;I.lineWidth=A[1],I.beginPath(),I.moveTo(Math.max(A[0],t[0]),C),I.lineTo(g.width-Math.max(A[0],t[1]),C),I.moveTo(Math.max(A[0],t[3]),g.height-C),I.lineTo(g.width-Math.max(A[0],t[2]),g.height-C),I.stroke()}if(this.borderRadius){const C=Math.max(...A),i=C/2;I.lineWidth=C,I.beginPath(),[!!t[0]&&[t[0],i,i,t[0]],!!t[1]&&[g.width-t[1],g.width-i,i,t[1]],!!t[2]&&[g.width-t[2],g.width-i,g.height-i,g.height-t[2]],!!t[3]&&[t[3],i,g.height-i,g.height-t[3]]].filter((g=>g)).forEach((([g,C,A,i])=>{I.moveTo(g,A),I.quadraticCurveTo(C,A,C,i)})),I.stroke()}}this.backgroundColor&&(I.fillStyle=this.backgroundColor,this.borderRadius?(I.beginPath(),I.moveTo(A[0],t[0]),[[A[0],t[0],g.width-t[1],A[1],A[1],A[1]],[g.width-A[0],g.width-A[0],g.width-A[0],A[1],t[1],g.height-t[2]],[g.width-A[0],g.width-t[2],t[3],g.height-A[1],g.height-A[1],g.height-A[1]],[A[0],A[0],A[0],g.height-A[1],g.height-t[3],t[0]]].forEach((([g,C,A,i,t,s])=>{I.quadraticCurveTo(g,i,C,t),I.lineTo(A,s)})),I.closePath(),I.fill()):I.fillRect(A[0],A[1],g.width-2*A[0],g.height-2*A[1])),I.translate(...A),I.translate(...o),I.font=l,I.textBaseline="bottom";const c=this.strokeWidth>0;c&&(I.lineWidth=this.strokeWidth*this.fontSize/10,I.strokeStyle=this.strokeColor),e.forEach(((g,C)=>{const A=Sg.split(g,this.strokeColor);let i=0;A.forEach((({text:g})=>i+=I.measureText(g).width));let t=(d-i)/2;const s=(C+1)*this.fontSize;A.forEach((({color:g,text:C})=>{I.fillStyle=g,I.fillText(C,t,s),c&&I.strokeText(C,t,s),I.fillText(C,t,s),t+=I.measureText(C).width}))})),this.material.map&&this.material.map.dispose();const a=this.material.map=new i.gPd(g);a.minFilter=i.k6q,a.needsUpdate=!0;const h=this.textHeight*e.length+2*C[1]+2*s[1];this.scale.set(h*g.width/g.height,h,0)},this._text=`${g}`,this._textHeight=I,this._backgroundColor=!1,this.generate()}get text(){return this._text}set text(g){this._text=g,this.generate()}get textHeight(){return this._textHeight}set textHeight(g){this._textHeight=g,this.generate()}get backgroundColor(){return this._backgroundColor}set backgroundColor(g){this._backgroundColor=g,this.generate()}get padding(){return this._padding}set padding(g){this._padding=g,this.generate()}get borderWidth(){return this._borderWidth}set borderWidth(g){this._borderWidth=g,this.generate()}get borderRadius(){return this._borderRadius}set borderRadius(g){this._borderRadius=g,this.generate()}get borderColor(){return this._borderColor}set borderColor(g){this._borderColor=g,this.generate()}get fontFace(){return this._fontFace}set fontFace(g){this._fontFace=g,this.generate()}get fontSize(){return this._fontSize}set fontSize(g){this._fontSize=g,this.generate()}get fontWeight(){return this._fontWeight}set fontWeight(g){this._fontWeight=g,this.generate()}get strokeWidth(){return this._strokeWidth}set strokeWidth(g){this._strokeWidth=g,this.generate()}get strokeColor(){return this._strokeColor}set strokeColor(g){this._strokeColor=g,this.generate()}}const kg={fontFace:"monospace",fontSize:.1,yOffset:0,color:"#ffffff",backgroundColor:"#00000077"};class Fg extends Rg{constructor(g,I={}){super(g,I.fontSize??kg.fontSize);const{fontFace:C,yOffset:A,backgroundColor:t,color:s}={...kg,...I};this.fontFace=C,this.position.y+=A,this.backgroundColor=t,this.material.depthTest=!1,this.renderOrder=1e12,this.strokeColor=s;const o=this.material.map;o&&(o.minFilter=i.hxR,o.magFilter=i.hxR)}}const Jg=[0,.05,.1,.15,.2,.3],Ng=[new i.PTz(.22181091786438836,.1299627903568272,.4885423545532194,.8338081060090633),new i.PTz(.893363678312996,-.013401460299294354,-.006736763863508881,.4490839065760065),new i.PTz(.9328672195091751,-.12196055833290745,-.04393897067375234,.3360859113864748),new i.PTz(.7659226373876284,.04985520396032439,.04163546301748589,.6396432289914226)],vg={swingLerp:.8,walkingSpeed:1.4,positionLerp:.7,rotationLerp:.2,idleArmSwing:.06},zg={color:"#96baff",faceColor:"#f99999",gap:.09000000000000001,layers:1,side:i.$EB,width:.45,widthSegments:16,height:.225,heightSegments:8,depth:.45,depthSegments:16,neckGap:.045000000000000005},Mg={color:"#2b2e42",gap:.09000000000000001,layers:1,side:i.$EB,width:.9,widthSegments:16},Lg={color:"#548ca8",gap:.09000000000000001,layers:1,side:i.$EB,width:.225,height:.45,depth:.225,widthSegments:8,heightSegments:16,depthSegments:8,shoulderGap:.045000000000000005,shoulderDrop:.225},xg={color:"#96baff",gap:.09000000000000001,layers:1,side:i.$EB,width:.225,height:.225,depth:.225,widthSegments:3,heightSegments:3,depthSegments:3,betweenLegsGap:.18000000000000002};class Dg extends i.YJl{constructor(g={}){var I,C,A,t,s,o,e,l,d;super(),this.speed=0,this.newPosition=new i.Pq0,this.newBodyDirection=new i.PTz,this.newDirection=new i.PTz,this.extraData=null,this.clock=new i.zD7,this.createModel=()=>{const g=new Kg({...zg,...this.options.head?this.options.head:{}}),I=new Kg({...Mg,...this.options.body?this.options.body:{}}),C=new Kg({...Lg,...this.options.arms?this.options.arms:{}}),A=new Kg({...Lg,...this.options.arms?this.options.arms:{}}),t=new Kg({...xg,...this.options.legs?this.options.legs:{}}),s=new Kg({...xg,...this.options.legs?this.options.legs:{}});this.headGroup=new i.YJl,this.bodyGroup=new i.YJl,this.leftArmGroup=new i.YJl,this.rightArmGroup=new i.YJl,this.leftLegGroup=new i.YJl,this.rightLegGroup=new i.YJl,this.headGroup.add(g),g.position.y+=g.height/2,this.headGroup.position.y+=I.height+t.height,this.options.head&&this.options.head.neckGap&&(this.headGroup.position.y+=this.options.head.neckGap),this.bodyGroup.add(I),I.position.y+=I.height/2,this.bodyGroup.position.y+=t.height,this.leftArmGroup.add(C),C.position.y-=C.height/2,C.position.x-=C.width/2,this.leftArmGroup.position.y+=I.height,this.leftArmGroup.position.x-=I.width/2,this.rightArmGroup.add(A),A.position.y-=A.height/2,A.position.x+=A.width/2,this.rightArmGroup.position.y+=I.height,this.rightArmGroup.position.x+=I.width/2,this.options.arms&&(this.options.arms.shoulderDrop&&(this.leftArmGroup.position.y-=this.options.arms.shoulderDrop,this.rightArmGroup.position.y-=this.options.arms.shoulderDrop),this.options.arms.shoulderGap&&(this.leftArmGroup.position.x-=this.options.arms.shoulderGap,this.rightArmGroup.position.x+=this.options.arms.shoulderGap)),this.leftLegGroup.add(t),t.position.y-=t.height/2,t.position.x-=t.width/2,this.rightLegGroup.add(s),s.position.y-=s.height/2,s.position.x+=s.width/2,this.options.legs&&this.options.legs.betweenLegsGap&&(this.leftLegGroup.position.x-=this.options.legs.betweenLegsGap/2,this.rightLegGroup.position.x+=this.options.legs.betweenLegsGap/2),g.paint("all",new i.Q1f(this.options.head.color)),g.paint("front",new i.Q1f(this.options.head.faceColor)),I.paint("all",new i.Q1f(this.options.body.color)),C.paint("all",new i.Q1f(this.options.arms.color)),A.paint("all",new i.Q1f(this.options.arms.color)),t.paint("all",new i.Q1f(this.options.legs.color)),s.paint("all",new i.Q1f(this.options.legs.color)),this.add(this.headGroup,this.bodyGroup),this.bodyGroup.add(this.leftArmGroup,this.rightArmGroup,this.leftLegGroup,this.rightLegGroup),this.headGroup.position.y-=this.eyeHeight,this.bodyGroup.position.y-=this.eyeHeight,this.head=g,this.body=I,this.leftArm=C,this.rightArm=A,this.leftLeg=t,this.rightLeg=s},this.calculateDelta=()=>{var g,I;const C=this.position.clone(),A=this.newPosition.clone();C.y=A.y=0;C.distanceTo(A)>1e-5?(0===this.speed&&(null==(g=this.onMove)||g.call(this)),this.speed=this.options.walkingSpeed):(this.speed>0&&(null==(I=this.onIdle)||I.call(this)),this.speed=0)},this.lerpAll=()=>{0!==this.newPosition.length()&&this.position.lerp(this.newPosition,this.options.positionLerp),0!==this.newDirection.length()&&this.headGroup.rotation.setFromQuaternion(this.newDirection),0!==this.newBodyDirection.length()&&this.bodyGroup.quaternion.slerp(this.newBodyDirection,this.options.rotationLerp)},this.playArmsWalkingAnimation=()=>{const g=100,I=Math.max(this.speed,this.options.idleArmSwing),C=1*I;this.leftArmGroup.rotation.x=i.cj9.lerp(this.leftArmGroup.rotation.x,Math.sin(performance.now()*I/g)*C,this.options.swingLerp),this.leftArmGroup.rotation.z=i.cj9.lerp(this.leftArmGroup.rotation.z,Math.cos(performance.now()*I/g)**2*C*.1,this.options.swingLerp),this.armSwingAnimation.isRunning()||(this.rightArmGroup.rotation.x=i.cj9.lerp(this.rightArmGroup.rotation.x,Math.sin(performance.now()*I/g+Math.PI)*C,this.options.swingLerp),this.rightArmGroup.rotation.z=i.cj9.lerp(this.rightArmGroup.rotation.z,-(Math.sin(performance.now()*I/g)**2)*C*.1,this.options.swingLerp))},this.playLegsWalkingAnimation=()=>{const g=Math.max(this.speed,this.options.idleArmSwing),I=1*g;this.leftLegGroup.rotation.x=i.cj9.lerp(this.leftLegGroup.rotation.x,-Math.sin(performance.now()*g/100)*I,this.options.swingLerp),this.rightLegGroup.rotation.x=i.cj9.lerp(this.rightLegGroup.rotation.x,Math.sin(performance.now()*g/100)*I,this.options.swingLerp)},this.playArmSwingAnimation=()=>{this.armSwingAnimation&&(this.armSwingAnimation.reset(),this.armSwingAnimation.play())},this.setArmHoldingObject=(g,I="right")=>{const C="armObject";let A=this.rightArmGroup;"left"===I&&(A=this.leftArmGroup);const t=A.getObjectByName(C);t&&A.remove(t),g&&(g.name=C,g.position.add(new i.Pq0(this.options.arms.width*("left"===I?-1:1)/2,-this.options.arms.height,0)),A.add(g))},this.options={...vg,...g,head:{...zg,...g.head||{},depth:(null==(I=g.head)?void 0:I.depth)||(null==(C=g.head)?void 0:C.width)||zg.width,height:(null==(A=g.head)?void 0:A.height)||zg.height||zg.width},body:{...Mg,...g.body||{},depth:(null==(t=g.body)?void 0:t.depth)||Mg.depth||Mg.width,height:(null==(s=g.body)?void 0:s.height)||Mg.height||Mg.width},arms:{...Lg,...g.arms||{},depth:(null==(o=g.arms)?void 0:o.depth)||Lg.width,height:(null==(e=g.arms)?void 0:e.height)||Lg.height},legs:{...xg,...g.legs||{},depth:(null==(l=g.legs)?void 0:l.depth)||xg.width,height:(null==(d=g.legs)?void 0:d.height)||xg.height}},this.createModel();const n=this.rightArmGroup.position,c=this.rightArmGroup.quaternion;this.armSwingClip=Q.generateClip("characterArmSwing",Jg,n,c,[n,n,n,n],Ng),this.mixer=new i.Iw4(this.rightArmGroup),this.armSwingAnimation=this.mixer.clipAction(this.armSwingClip),this.armSwingAnimation.setLoop(i.G3T,1),this.armSwingAnimation.clampWhenFinished=!0}update(){const g=Math.min(.1,this.clock.getDelta());this.mixer.update(g),this.calculateDelta(),this.playArmsWalkingAnimation(),this.playLegsWalkingAnimation(),this.lerpAll()}set(g,I){g&&I&&(this.newPosition.set(g[0],g[1],g[2]),this.newDirection.copy(pg.directionToQuaternion(I[0],I[1],I[2])),this.newBodyDirection.copy(pg.directionToQuaternion(I[0],0,I[2])))}set username(g){this.nametag||(this.nametag=new Fg(g,{yOffset:this.head.height/2+.2,fontSize:.2,...this.options.nameTagOptions??{}}),this.add(this.nametag)),g?this.nametag.text=g:this.nametag.visible=!1}get username(){return this.nametag?this.nametag.text:""}get eyeHeight(){return this.options.legs.height+this.options.body.height+this.options.head.neckGap+this.options.head.height/2}get totalHeight(){return this.options.legs.height+this.options.body.height+this.options.head.neckGap+this.options.head.height}set bodyColor(g){this.body.paint("all",new i.Q1f(g)),this.options.body.color=g}get bodyColor(){return this.options.body.color}set armColor(g){this.leftArm.paint("all",new i.Q1f(g)),this.rightArm.paint("all",new i.Q1f(g)),this.options.arms.color=g}get armColor(){return this.options.arms.color}set legColor(g){this.leftLeg.paint("all",new i.Q1f(g)),this.rightLeg.paint("all",new i.Q1f(g)),this.options.legs.color=g}get legColor(){return this.options.legs.color}set headColor(g){this.head.paint("all",new i.Q1f(g)),this.options.head.color=g}get headColor(){return this.options.head.color}set faceColor(g){this.head.paint("front",new i.Q1f(g)),this.options.head.faceColor=g}get faceColor(){return this.options.head.faceColor}}const fg=new i.Pq0(1,-1,-1),Tg=(new i.PTz).setFromEuler(new i.O9p(-Math.PI/4,0,-Math.PI/8)),Qg=new i.Pq0(1.4,-1.4,-2.061),Pg=(new i.PTz).setFromAxisAngle(new i.Pq0(0,1,0),-Math.PI/4),jg=[0,.05,.1,.15,.2,.3],Ug=[new i.Pq0(-.34,.23,0),new i.Pq0(0,-.25,0),new i.Pq0(0,-.68,0),new i.Pq0(0,-.3,0)],Og=g=>{const I=[];for(let C=0;C<Ug.length;C++){const A=(0===C?g.clone():I[C-1].clone()).add(Ug[C]);I.push(A)}return I},Eg=Og(fg),qg=Og(Qg),$g=[new i.PTz(-.41,-.0746578340503426,.21,.9061274463528878),new i.PTz(-.41,-.0746578340503426,.52,.9061274463528878),new i.PTz(-.41,-.0746578340503426,.75,.9061274463528878),new i.PTz(-.37533027751786524,-.0746578340503426,-.18023995550173696,.9061274463528878)],_g={armObject:void 0,armObjectOptions:{position:fg,quaternion:Tg,swingPositions:Eg,swingQuaternions:$g,swingTimes:jg},blockObjectOptions:{position:Qg,quaternion:Pg,swingPositions:qg,swingQuaternions:$g,swingTimes:jg},armColor:Lg.color};class gI extends i.YJl{constructor(g={}){var I,C,A,t,s,o,e,l,d,n;super(),this.clock=new i.zD7,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=.2,this.transitionDirection=0,this.initialArmY=0,this.targetArmY=0,this.currentArmObject=null,this.connect=(g,I="*")=>{const C=g.click("left",this.doSwing,I);return()=>{try{C()}catch(g){}}},this.setArmObject=(g,I,C)=>{I?(this.pendingArmObject=g,this.pendingCustomType=C,this.isTransitioning||(this.isTransitioning=!0,this.transitionStartTime=this.clock.elapsedTime,this.transitionDirection=0,this.children.length>0&&(this.currentArmObject=this.children[0],this.initialArmY=this.currentArmObject.position.y,this.targetArmY=this.initialArmY-5))):(this.clear(),C?this.setCustomObject(C,g):g?this.setBlock(g):this.setArm())},this.setArm=()=>{var g,I,C,A;const t=new Kg({width:.5,height:1,depth:.3});if(this.options.armTexture){const g=this.options.armTexture;g.image&&g.image.complete?t.paint("all",g):(t.paint("all",new i.Q1f(this.options.armColor)),g.image&&(g.image.onload=()=>{t.paint("all",g)}))}else t.paint("all",new i.Q1f(this.options.armColor));t.position.set(null==(g=this.options.armObjectOptions)?void 0:g.position.x,null==(I=this.options.armObjectOptions)?void 0:I.position.y,null==(C=this.options.armObjectOptions)?void 0:C.position.z),t.quaternion.multiply(null==(A=this.options.armObjectOptions)?void 0:A.quaternion),this.mixer=new i.Iw4(t),this.swingAnimation=this.mixer.clipAction(this.armSwingClip),this.swingAnimation.setLoop(i.G3T,1),this.swingAnimation.clampWhenFinished=!0,this.add(t),this.currentArmObject=t},this.setBlock=g=>{var I,C,A,t;g.position.set(null==(I=this.options.blockObjectOptions)?void 0:I.position.x,null==(C=this.options.blockObjectOptions)?void 0:C.position.y,null==(A=this.options.blockObjectOptions)?void 0:A.position.z),g.quaternion.multiply(null==(t=this.options.blockObjectOptions)?void 0:t.quaternion),this.mixer=new i.Iw4(g),this.swingAnimation=this.mixer.clipAction(this.blockSwingClip),this.swingAnimation.setLoop(i.G3T,1),this.swingAnimation.clampWhenFinished=!0,this.add(g),this.currentArmObject=g},this.setCustomObject=(g,I)=>{var C;const A=null==(C=this.options.customObjectOptions)?void 0:C[g];if(!A)throw new Error(`No options found for custom object type: ${g}`);I.position.set(A.position.x,A.position.y,A.position.z),I.quaternion.multiply(A.quaternion),this.mixer=new i.Iw4(I),this.swingAnimation=this.mixer.clipAction(this.customSwingClips[g]),this.swingAnimation.setLoop(i.G3T,1),this.swingAnimation.clampWhenFinished=!0,this.add(I),this.currentArmObject=I},this.doSwing=()=>{this.playSwingAnimation(),this.emitSwingEvent&&this.emitSwingEvent()},this.paintArm=g=>{this.children.forEach((I=>{I instanceof Kg&&(I.paint("all",g),I.traverse((g=>{g instanceof i.eaF&&(Array.isArray(g.material)?g.material.forEach((g=>{g.needsUpdate=!0})):g.material.needsUpdate=!0)})))}))},this.playSwingAnimation=()=>{this.swingAnimation&&(this.swingAnimation.reset(),this.swingAnimation.play())},this.options={..._g,...g},this.armSwingClip=Q.generateClip("armSwing",null==(I=this.options.armObjectOptions)?void 0:I.swingTimes,null==(C=this.options.armObjectOptions)?void 0:C.position,null==(A=this.options.armObjectOptions)?void 0:A.quaternion,null==(t=this.options.armObjectOptions)?void 0:t.swingPositions,null==(s=this.options.armObjectOptions)?void 0:s.swingQuaternions),this.blockSwingClip=Q.generateClip("blockSwing",null==(o=this.options.blockObjectOptions)?void 0:o.swingTimes,null==(e=this.options.blockObjectOptions)?void 0:e.position,null==(l=this.options.blockObjectOptions)?void 0:l.quaternion,null==(d=this.options.blockObjectOptions)?void 0:d.swingPositions,null==(n=this.options.blockObjectOptions)?void 0:n.swingQuaternions),this.customSwingClips={};for(const[i,c]of Object.entries(this.options.customObjectOptions||{}))this.customSwingClips[i]=Q.generateClip(`customSwing-${i}`,c.swingTimes??jg,c.position,c.quaternion,c.swingPositions??Og(c.position),c.swingQuaternions??$g);this.setArm()}update(){const g=Math.min(.1,this.clock.getDelta());if(this.mixer.update(g),this.isTransitioning){const g=this.clock.elapsedTime-this.transitionStartTime,I=Math.min(g/this.transitionDuration,1),C=g=>1-Math.pow(1-g,3),A=g=>g<.5?2*g*g:1-Math.pow(-2*g+2,2)/2;if(0===this.transitionDirection){if(this.currentArmObject){const g=C(I),A=i.cj9.lerp(this.initialArmY,this.targetArmY,g);this.currentArmObject.position.y=A}I>=1&&(this.clear(),this.pendingCustomType?this.setCustomObject(this.pendingCustomType,this.pendingArmObject):this.pendingArmObject?this.setBlock(this.pendingArmObject):this.setArm(),this.children.length>0&&(this.currentArmObject=this.children[0],this.targetArmY=this.currentArmObject.position.y,this.currentArmObject.position.y-=5,this.initialArmY=this.currentArmObject.position.y),this.transitionDirection=1,this.transitionStartTime=this.clock.elapsedTime)}else{if(this.currentArmObject){const g=A(I),C=i.cj9.lerp(this.initialArmY,this.targetArmY,g);this.currentArmObject.position.y=C}I>=1&&(this.isTransitioning=!1,this.pendingArmObject=void 0,this.pendingCustomType=void 0,this.currentArmObject&&(this.currentArmObject.position.y=this.targetArmY))}}}}const II={radius:.1,height:.8,coneRadius:.2,coneHeight:.2,color:"red"};class CI extends i.E0M{constructor(g={}){super();const{radius:I,height:C,coneRadius:A,coneHeight:t}=this.options={...II,...g},s="string"==typeof this.options.color?new i.Q1f(this.options.color):this.options.color;[...this.children].forEach((g=>this.remove(g))),this.add(new i.eaF(new i.Ho_(I,I,C),new i.V9B({color:s})));const o=new i.eaF(new i.Ho_(0,A,t),new i.V9B({color:s}));o.position.y=(t+C)/2,this.add(o)}}const AI={stats:!0,onByDefault:!0,entriesStyles:{},entriesClass:"debug-entries",lineStyles:{},lineClass:"debug-line",dataStyles:{},dataClass:"debug-data",showVoxelize:!0,asyncPeriod:1e3,newLineStyles:{},statsStyles:{},containerId:"voxelize-debug"};class iI extends i.YJl{constructor(g=document.body,I={}){super(),this.dataEntries=[],this.registerDisplay=(g,I,C,A=g=>g)=>{const i=this.makeDataEntry();if(g){const I=document.createElement("span");I.className="debug-label",I.textContent=`${g}: `;const C=document.createElement("span");C.className="debug-value",i.appendChild(I),i.appendChild(C)}const t={title:g,element:i,object:I,formatter:A,attribute:C};return this.dataEntries.push(t),this.entriesWrapper.insertBefore(i,this.entriesWrapper.firstChild),"AsyncFunction"===I.constructor.name&&setInterval((()=>{I().then((I=>{const C=A(I),t=i.querySelector(".debug-value");t?t.textContent=C:i.textContent=`${g?`${g}: `:""}${C}`}))}),this.options.asyncPeriod),this},this.removeDisplay=g=>{const I=this.dataEntries.findIndex((I=>I.title===g)),C=this.dataEntries.splice(I,1)[0];C&&this.entriesWrapper.removeChild(C.element)},this.dispose=()=>{this.dataWrapper.remove()},this.displayTitle=g=>{const I=this.makeDataEntry(!0);return I.textContent=g,this.entriesWrapper.insertBefore(I,this.entriesWrapper.firstChild),this},this.displayNewline=()=>{const g=this.makeDataEntry(!0);return this.entriesWrapper.insertBefore(g,this.entriesWrapper.firstChild),this},this.toggle=(g=null)=>{this.visible=null!==g?g:!this.visible;const I=this.entriesWrapper.style.visibility,C=g?"visible":"visible"===I?"hidden":"visible";this.entriesWrapper.style.visibility=C,this.dataWrapper.style.visibility=C,this.stats&&(this.stats.dom.style.visibility=C)},this.update=()=>{var g;requestAnimationFrame((()=>{this.dataEntries.forEach((({element:g,title:I,attribute:C,object:A,formatter:i})=>{var t;if("AsyncFunction"===(null==(t=null==A?void 0:A.constructor)?void 0:t.name))return;let s="";A&&(s="function"==typeof A?A():A[C]??"");const o=i(s);if(I){const C=g.querySelector(".debug-label"),A=g.querySelector(".debug-value");if(C&&A){const g=o;A.textContent!==g&&(A.textContent=g)}else{const C=`${I}: ${o}`;g.textContent!==C&&(g.textContent=C)}}else g.textContent!==o&&(g.textContent=o)}))})),null==(g=this.stats)||g.update()},this.makeDataEntry=(g=!1)=>{const I=document.createElement("p");return I.classList.add(this.options.lineClass),cg.applyStyles(I,{...g?{height:"10px",...this.options.newLineStyles}:{},...this.options.lineStyles||{}}),I},this.makeDOM=()=>{var g;this.dataWrapper=document.createElement("div"),this.dataWrapper.id="data-wrapper",this.dataWrapper.classList.add(this.options.dataClass),this.entriesWrapper=document.createElement("div"),this.entriesWrapper.classList.add(this.options.entriesClass),cg.applyStyles(this.dataWrapper,this.options.dataStyles),cg.applyStyles(this.entriesWrapper,this.options.entriesStyles),this.options.stats&&(this.stats=new e,null==(g=this.stats.dom.parentNode)||g.removeChild(this.stats.dom),cg.applyStyles(this.stats.dom,{position:"relative",top:"unset",bottom:"unset",left:"unset",zIndex:"1000000000000",marginTop:"8px",...this.options.statsStyles||{}}))},this.setup=()=>{this.options.showVoxelize&&(this.displayTitle("Voxelize 1.0.0"),this.displayNewline())},this.mount=()=>{var g;this.dataWrapper.appendChild(this.entriesWrapper),this.stats&&this.dataWrapper.appendChild(null==(g=this.stats)?void 0:g.dom),this.domElement.appendChild(this.dataWrapper),this.dataWrapper.id=this.options.containerId},this.domElement=g;const{onByDefault:C}=this.options={...AI,...I};this.makeDOM(),this.setup(),this.mount(),this.toggle(C)}}class tI extends l.Mj{constructor(g,I){super("BlockOverlayEffect","uniform vec3 overlay;\nuniform float opacity;\n\nvoid mainImage(const in vec4 inputColor, const in vec2 uv, out vec4 outputColor) {\n  outputColor = vec4(mix(inputColor.rgb, overlay, opacity), inputColor.a);\n}",{uniforms:new Map([["overlay",new i.nc$(new i.Pq0(0,0,1))],["opacity",new i.nc$(0)]])}),this.world=g,this.camera=I,this.overlays=new Map,this.addOverlay=(g,I,C)=>{this.overlays.set("number"==typeof g?g:g.toLowerCase(),[I,C])},this.update=()=>{if(!this.world.isInitialized)return;const g=new i.Pq0;this.camera.getWorldPosition(g);const I=this.world.getVoxelAt(g.x,g.y,g.z);if(this.oldId===I)return;this.oldId=I;const C=this.world.getBlockById(I),A=this.overlays.get(I)||this.overlays.get(C.name.toLowerCase());A?(this.overlay=A[0],this.opacity=A[1]):this.opacity=0}}get opacity(){return this.uniforms.get("opacity").value}set opacity(g){this.uniforms.get("opacity").value=g}get overlay(){return this.uniforms.get("overlay").value}set overlay(g){const I=this.uniforms.get("overlay").value;I.x=g.r,I.y=g.g,I.z=g.b}}const sI={maxDistance:10,maxRadius:.5},oI=class g extends i.eaF{constructor(I,C={}){super(g.GEOMETRY,g.MATERIAL),this.world=I,this.update=()=>{if(!this.parent)return;const I=new i.Pq0;this.parent.getWorldPosition(I);const{maxDistance:C}=this.options,A=this.world.raycastVoxels(I.toArray(),[0,-1,0],C);if(this.visible=!!A,!A)return;const{point:t}=A;if(isNaN(t[0]))return;const s=Math.sqrt((t[0]-I.x)**2+(t[1]-I.y)**2+(t[2]-I.z)**2),o=Math.max(1-s/C,0)**2,e=new i.Pq0(t[0],t[1]+g.Y_OFFSET,t[2]);e.sub(I),this.position.copy(e),this.scale.set(o,o,1)},this.options={...sI,...C},this.rotateX(Math.PI/2),this.renderOrder=-1}};oI.MATERIAL=new i.V9B({side:i.$EB,color:"rgb(0,0,0)",opacity:.3,depthWrite:!1,transparent:!0}),oI.GEOMETRY=new i.tcD(sI.maxRadius,30),oI.Y_OFFSET=.01;let eI=oI;class lI extends Array{constructor(g){if(super(),this.update=()=>{this.forEach(((g,I)=>{g.parent||this.splice(I,1)})),this.forEach((g=>{g.update()}))},this.add=(g,I={})=>{const C=new eI(this.world,I);g.add(C),this.push(C)},!g)throw new Error("Shadows: world is required.");this.world=g}}const dI=new i.Pq0,nI={lerpFactor:.1,maxBrightness:.8};class cI{constructor(g,I={}){this.world=g,this.list=new Set,this.ignored=new Set,this.add=g=>{this.list.add(g),this.setupLightMaterials(g)},this.remove=g=>{this.list.delete(g)},this.update=()=>{this.list.forEach((g=>{this.recursiveUpdate(g)}))},this.ignore=(...g)=>{g.forEach((g=>{this.ignored.add(g)}))},this.setupLightMaterials=g=>{const I=I=>{if(ug.isShaderMaterial(I)||I.userData.lightEffectSetup)return;const C={value:new i.Q1f(1,1,1)},A=I.onBeforeCompile;I.onBeforeCompile=(g,I)=>{A&&A(g,I),g.uniforms.lightEffect=C,g.vertexShader=g.vertexShader.replace("void main() {","\n          uniform vec3 lightEffect;\n          void main() {\n          "),g.fragmentShader=g.fragmentShader.replace("void main() {","\n          uniform vec3 lightEffect;\n          void main() {\n          "),g.fragmentShader=g.fragmentShader.replace("#include <color_fragment>","\n          #include <color_fragment>\n          diffuseColor.rgb *= lightEffect;\n          ")},I.needsUpdate=!0,g.userData.lightUniforms||(g.userData.lightUniforms=[]),g.userData.lightUniforms.push(C),I.userData.lightEffectSetup=!0},C=g=>g.isMesh,A=g=>{C(g)&&(Array.isArray(g.material)?g.material.forEach(I):I(g.material)),g.children.forEach(A)};A(g);const t=I=>{C(I)&&(I.material=new Proxy(I.material,{set:(g,C,i)=>(g[C]=i,"needsUpdate"===C&&!0===i&&A(I),!0)}),g.userData.justChanged=!0),I.children=new Proxy(I.children,{set:(g,I,C)=>(g[I]=C,"string"!=typeof I||isNaN(Number(I))||(A(C),t(C)),!0)}),I.children.forEach(t)};t(g)},this.updateObject=(g,I)=>{for(const C of this.ignored)if(g instanceof C)return;g.userData.lightUniforms&&g.userData.lightUniforms.forEach((C=>{g.userData.justChanged?C.value.copy(I):C.value.lerp(I,this.options.lerpFactor),C.value.r=Math.min(C.value.r,this.options.maxBrightness),C.value.g=Math.min(C.value.g,this.options.maxBrightness),C.value.b=Math.min(C.value.b,this.options.maxBrightness)})),g.userData.justChanged=!1},this.recursiveUpdate=(g,I=null)=>{if(g.parent){for(const I of this.ignored)if(g instanceof I)return;if(null===I){g.getWorldPosition(dI);const C=dg.mapWorldToVoxel(dI.toArray());if(!this.world.getChunkByPosition(...C))return;I=this.world.getLightColorAt(...C)}this.updateObject(g,I),g.traverse((g=>{this.updateObject(g,I)}))}},this.options={...nI,...I},this.ignore(eI),this.ignore(Fg)}}const aI=1e5,hI=100,ZI=new i.Pq0,mI=g=>(I,C)=>{if(I.object&&I.object.isMesh&&I.object.userData.isChunk&&C.object&&C.object.isMesh&&C.object.userData.isChunk){const A=new i.Pq0,t=new i.Pq0,{object:s}=I,{object:o}=C,{geometry:e}=s,{geometry:l}=o;return e.boundingBox||e.computeBoundingBox(),l.boundingBox||l.computeBoundingBox(),e&&e.boundingBox?(e.boundingBox.getCenter(A),A.add(s.getWorldPosition(ZI))):s.getWorldPosition(A),l&&l.boundingBox?(l.boundingBox.getCenter(t),t.add(o.getWorldPosition(ZI))):o.getWorldPosition(t),t.distanceToSquared(g.position)-A.distanceToSquared(g.position)>0?1:-1}return I.groupOrder!==C.groupOrder?I.groupOrder-C.groupOrder:I.renderOrder!==C.renderOrder?I.renderOrder-C.renderOrder:I.z!==C.z?C.z-I.z:I.id-C.id},bI=()=>{},GI={wrapperClass:"item-slots",wrapperStyles:{},wrapperPadding:0,slotClass:"item-slots-slot",slotHoverClass:"item-slots-slot-hover",slotFocusClass:"item-slots-slot-focus",slotSubscriptClass:"item-slots-slot-subscript",slotMargin:0,slotPadding:0,slotGap:4,slotWidth:50,slotHeight:50,slotStyles:{},slotSubscriptStyles:{},horizontalCount:5,verticalCount:1,focusFirstByDefault:!0,activatedByDefault:!0,zoom:1,perspective:"pxyz",scrollable:!0};class BI{constructor(g,I,C){this.camera=new i.qUd(-1,1,1,-1,0,10),this.zoom=1,this.lightRotationOffset=-Math.PI/8,this.offset=new i.Pq0,this.getObject=()=>this.object,this.setObject=g=>{if(this.object&&this.scene.remove(this.object),void 0!==g){if(ug.isObject3D(g))this.object=g,this.scene.add(g);else{const I=new i.bdM(2,2),C=new i.gPd(g);C.needsUpdate=!0,C.colorSpace=i.er$,C.minFilter=i.hxR,C.magFilter=i.hxR;const A=new i.V9B({map:C,transparent:!0});A.needsUpdate=!0;const t=new i.eaF(I,A);this.object=t,this.setPerspective("pz"),this.scene.add(t)}this.triggerChange()}else this.object=void 0},this.getContent=()=>this.content,this.setContent=g=>{this.content=g,this.triggerChange()},this.getSubscript=()=>this.subscript,this.setSubscript=g=>{this.subscript=g,this.subscriptElement.innerText=g,this.triggerChange()},this.triggerChange=()=>{this.row==this.itemSlots.focusedRow&&this.col==this.itemSlots.focusedCol&&this.itemSlots.triggerFocusChange(null,this)},this.setZoom=g=>{this.zoom=g,this.camera.far=3*g+1,this.updateCamera()},this.setPerspective=g=>{const I=g.startsWith("n")?-1:1,C=g.includes("x")?1:0,A=g.includes("y")?1:0,i=g.includes("z")?1:0;this.offset.set(C,A,i).multiplyScalar(I),this.updateCamera()},this.applyClass=g=>{this.element.classList.add(g)},this.removeClass=g=>{this.element.classList.remove(g)},this.applySubscriptClass=g=>{this.subscriptElement.classList.add(g)},this.removeSubscriptClass=g=>{this.subscriptElement.classList.remove(g)},this.applyStyles=g=>{cg.applyStyles(this.element,g)},this.applySubscriptStyles=g=>{cg.applyStyles(this.subscriptElement,g)},this.updateCamera=()=>{this.camera.position.copy(this.offset.clone().multiplyScalar(3.5*(this.zoom||1))),this.camera.lookAt(0,0,0);const g=this.camera.position.clone();g.applyAxisAngle(new i.Pq0(0,1,0),this.lightRotationOffset),this.light.position.copy(g)},this.itemSlots=g,this.row=I,this.col=C,this.scene=new i.Z58,this.camera=new i.qUd(-1,1,1,-1,0,10),this.element=document.createElement("div"),this.subscriptElement=document.createElement("div"),this.element.appendChild(this.subscriptElement),this.offset=new i.Pq0,this.light=new i.ZyN(16777215,3),this.scene.add(this.light),this.updateCamera()}}class WI{constructor(g={}){this.focusedRow=-1,this.focusedCol=-1,this.activated=!1,this.hoveredRow=-1,this.hoveredCol=-1,this.onSlotClick=bI,this.onSlotUpdate=bI,this.onFocusChange=g=>{this.focusChangeCallbacks.push(g)},this.triggerFocusChange=(g,I)=>{for(const C of this.focusChangeCallbacks)C(g,I)},this.focusChangeCallbacks=[],this.animationFrame=-1,this.activate=()=>{this.activated||(this.activated=!0,cg.applyStyles(this.wrapper,{display:"flex"}),this.render())},this.deactivate=()=>{this.activated&&(this.activated=!1,cg.applyStyles(this.wrapper,{display:"none"}),cancelAnimationFrame(this.animationFrame))},this.setObject=(g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const i=this.slots[g][I];i.setObject(C),null==(A=this.onSlotUpdate)||A.call(this,i)},this.setContent=(g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const i=this.slots[g][I];i.setContent(C),null==(A=this.onSlotUpdate)||A.call(this,i)},this.setSubscript=(g,I,C)=>{var A;if(!this.slots[g]||!this.slots[g][I])return;const i=this.slots[g][I];i.setSubscript(C),null==(A=this.onSlotUpdate)||A.call(this,i)},this.setFocused=(g,I)=>{if(g===this.focusedRow&&I===this.focusedCol)return;let C=null;-1!==this.focusedRow&&-1!==this.focusedCol&&(this.focusedRow!==g||this.focusedCol!==I)&&(C=this.slots[this.focusedRow][this.focusedCol],C.element.classList.remove(this.options.slotFocusClass)),this.focusedRow=g,this.focusedCol=I;const A=this.slots[this.focusedRow][this.focusedCol];this.triggerFocusChange(C,A),A.element.classList.add(this.options.slotFocusClass),this.onSlotClick(A)},this.getObject=(g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].object:null,this.getContent=(g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].content:null,this.getSubscript=(g,I)=>this.slots[g]&&this.slots[g][I]?this.slots[g][I].subscript:null,this.getFocused=()=>-1===this.focusedRow||-1===this.focusedCol?null:this.slots[this.focusedRow][this.focusedCol],this.getRowColFromEvent=g=>{const I=this.canvas.getBoundingClientRect(),C=g.clientX-I.left,A=(g.clientY-I.top)/this.slotTotalHeight,i=C/this.slotTotalWidth,{slotMargin:t,slotWidth:s,slotHeight:o}=this.options,{verticalCount:e,horizontalCount:l}=this.options;return A<0||A>=e||i<0||i>=l||A%1<t/o||A%1>1-t/o||i%1<t/s||i%1>1-t/s?{row:-1,col:-1}:{row:Math.floor(A),col:Math.floor(i)}},this.getSlot=(g,I)=>g<0||g>=this.options.verticalCount||I<0||I>=this.options.horizontalCount?null:this.slots[g][I],this.connect=(g,I="*")=>{const{slotHoverClass:C,scrollable:A}=this.options;let i=null,t=null;this.canvas.onmouseenter=()=>{this.activated&&(this.canvas.onmousemove=g=>{const{row:I,col:A}=this.getRowColFromEvent(g);this.hoveredRow=I,this.hoveredCol=A,-1!==I&&-1!==A?(null===i||null===t||I===i&&A===t||this.slots[i][t].element.classList.remove(C),this.slots[I][A].element.classList.add(C),cg.applyStyles(this.canvas,{cursor:"pointer"}),i=I,t=A):null!==i&&null!==t&&(this.slots[i][t].element.classList.remove(C),cg.applyStyles(this.canvas,{cursor:"default"}))})},this.canvas.onmouseleave=()=>{this.activated&&(this.hoveredRow=-1,this.hoveredCol=-1,null!==i&&null!==t&&(this.slots[i][t].element.classList.remove(C),cg.applyStyles(this.canvas,{cursor:"default"})),this.canvas.onmousemove=null)},this.canvas.onmousedown=g=>{if(!this.activated)return;const{row:I,col:C}=this.getRowColFromEvent(g);-1!==I&&-1!==C&&this.setFocused(I,C)};const s=A?g.scroll((()=>{if(!this.activated)return;if(-1===this.focusedRow||-1===this.focusedCol)return;const{horizontalCount:g,verticalCount:I}=this.options,C=this.focusedRow,A=this.focusedCol;0===A?this.setFocused(0===C?I-1:C-1,g-1):this.setFocused(C,A-1)}),(()=>{if(!this.activated)return;if(-1===this.focusedRow||-1===this.focusedCol)return;const{horizontalCount:g,verticalCount:I}=this.options,C=this.focusedRow,A=this.focusedCol;A===g-1?this.setFocused(C===I-1?0:C+1,0):this.setFocused(C,A+1)}),I):bI;return()=>{try{s(),this.canvas.onmousedown=null,this.canvas.onmouseenter=null,this.canvas.onmouseleave=null}catch(g){}}},this.render=()=>{if(this.animationFrame=requestAnimationFrame(this.render),!this.activated)return;const{horizontalCount:g,verticalCount:I,slotMargin:C,slotPadding:A}=this.options,i=this.canvas.clientWidth,t=this.canvas.clientHeight;this.canvas.width===i&&this.canvas.height===t||this.renderer.setSize(i,t,!1),this.renderer.setScissorTest(!1),this.renderer.clear(),this.renderer.setScissorTest(!0);const s=this.renderer.domElement.getBoundingClientRect();let o=!1;for(let e=0;e<I;e++)for(let I=0;I<g;I++){const{scene:g,camera:i,element:t,object:l}=this.slots[e][I];if(!l)continue;const d=t.getBoundingClientRect();if(d.top+d.height<s.top||d.top>s.top+s.height||d.left+d.width<s.left||d.left>s.left+s.width)continue;o=!0;const n=d.right-d.left-2*C-2*A,c=d.bottom-d.top-2*C-2*A;if(n<=0||c<=0)continue;const a=d.left-s.left+C+A,h=s.height-(d.bottom-s.top)+C+A;this.renderer.setViewport(a,h,n,c),this.renderer.setScissor(a,h,n,c),this.renderer.render(g,i)}o||(this.renderer.setViewport(0,0,i,t),this.renderer.setScissor(0,0,i,t),this.renderer.render(this.slots[0][0].scene,this.slots[0][0].camera))},this.generate=()=>{const{wrapperClass:g,wrapperStyles:I,slotClass:C,slotStyles:A,slotSubscriptClass:t,slotSubscriptStyles:s,horizontalCount:o,verticalCount:e,zoom:l,perspective:d}=this.options,{slotWidth:n,slotHeight:c,slotMargin:a,slotPadding:h,slotGap:Z,wrapperPadding:m}=this.options,b=n*o+Z*(o-1)+2*a+2*m,G=c*e+Z*(e-1)+2*a+2*m;this.wrapper=document.createElement("div"),this.wrapper.classList.add(g),cg.applyStyles(this.wrapper,{...I,width:`${b}px`,height:`${G}px`,display:"none"}),this.slots=[];for(let i=0;i<e;i++){this.slots[i]=[];for(let g=0;g<o;g++){const I=new BI(this,i,g);I.applyClass(C),I.applyStyles({width:`${n}px`,height:`${c}px`,borderRadius:.1*n+"px",borderWidth:.08*n+"px",boxShadow:`inset 0 0 ${.05*n}px var(--item-slots-slot-color)`,...A}),I.applySubscriptClass(t),I.applySubscriptStyles(s),I.applyStyles({position:"absolute",top:`${m+a+i*(c+Z)}px`,left:`${m+a+g*(n+Z)}px`}),I.setZoom(l),I.setPerspective(d),this.slots[i][g]=I,this.wrapper.appendChild(I.element)}}this.canvas=document.createElement("canvas"),this.canvas.width=b,this.canvas.height=G,cg.applyStyles(this.canvas,{position:"absolute",background:"transparent",top:"0",left:"0",zIndex:"-1"}),this.wrapper.appendChild(this.canvas),this.renderer=new i.JeP({canvas:this.canvas,antialias:!1,alpha:!0}),this.renderer.outputColorSpace=i.er$,this.renderer.setSize(b,G)};const{focusFirstByDefault:I,activatedByDefault:C,slotHeight:A,slotMargin:t,slotWidth:s,slotPadding:o,slotGap:e}=this.options=d(GI,g);this.slotTotalWidth=s+e,this.slotTotalHeight=A+e,this.generate(),I&&this.setFocused(0,0),C&&this.activate()}get element(){return this.wrapper}}const pI={maxDistance:5,blockMargin:.3,lerpFactor:.5,ignoreSeeThrough:!0,ignoreFluids:!0},uI=class g{constructor(I,C,A={}){if(this._state="first",this.firstPersonPosition=new i.Pq0,this.connect=(I,C="*")=>{const A=I.bind("KeyC",(()=>{var g;(null==(g=this.controls)?void 0:g.isLocked)&&this.toggle()}),C,{identifier:g.INPUT_IDENTIFIER,checkType:"code"}),i=I.bind("F5",(()=>this.toggle(!0)),C,{identifier:g.INPUT_IDENTIFIER,checkType:"code"});return this.inputs=I,()=>{try{A(),i()}catch(g){}}},this.toggle=(g=!1)=>{if(g)switch(this.state){case"first":this.state="second";break;case"second":this.state="third";break;case"third":this.state="first"}else switch(this.state){case"first":this.state="third";break;case"second":this.state="first";break;case"third":this.state="second"}},this.update=()=>{const{object:g,camera:I}=this.controls;this.controls.character&&("first"===this.state&&this.controls.character.visible?this.controls.character.visible=!1:"first"===this.state||this.controls.character.visible||(this.controls.character.visible=!0)),this.controls.arm&&("first"!==this.state||this.controls.arm.visible?"first"!==this.state&&this.controls.arm.visible&&(this.controls.arm.visible=!1):this.controls.arm.visible=!0);const C=()=>{const C=new i.Pq0;("second"===this.state?g:I).getWorldDirection(C),C.normalize(),C.multiplyScalar(-1);const A=new i.Pq0;g.getWorldPosition(A),A.add(C.clone().multiplyScalar(this.options.blockMargin));const t=this.world.raycastVoxels(A.toArray(),C.toArray(),this.options.maxDistance,{ignoreFluids:this.options.ignoreFluids,ignoreSeeThrough:this.options.ignoreSeeThrough});return t?A.distanceTo(new i.Pq0(...t.point)):this.options.maxDistance};switch(this.state){case"first":break;case"second":{const A=I.position.clone();A.z=-C(),I.position.lerp(A,this.options.lerpFactor),I.lookAt(g.position);break}case"third":{const g=I.position.clone();g.z=C(),I.position.lerp(g,this.options.lerpFactor);break}}},!I)throw new Error("Perspective: invalid rigid controls.");if(!C)throw new Error("Perspective: invalid world.");this.controls=I,this.world=C,this.options={...pI,...A},this.firstPersonPosition.copy(this.controls.camera.position),this.state="first"}set state(g){var I;const{camera:C}=this.controls;"first"===g?C.position.copy(this.firstPersonPosition):C.position.set(0,0,0),C.quaternion.set(0,0,0,0),g!==this._state&&(null==(I=this.onChangeState)||I.call(this,g),this._state=g)}get state(){return this._state}};uI.INPUT_IDENTIFIER="voxelize-perspective";let rI=uI;const yI={zoom:1,perspective:"pxyz",width:100,height:100,renderOnce:!1,lightRotationOffset:-Math.PI/8},VI=class g{constructor(I,C={}){if(this.animationFrameId=-1,this.setObject=g=>{this.object&&this.scene.remove(this.object),this.scene.add(g),this.object=g},this.dispose=()=>{cancelAnimationFrame(this.animationFrameId),this.scene.remove(this.object),this.object=null},this.render=()=>{this.animationFrameId=requestAnimationFrame(this.render);const I=g.renderer,{renderOnce:C}=this.options,{width:A,height:t}=I.getSize(new i.I9Y(0,0));A===this.canvas.width&&t===this.canvas.height||I.setSize(this.canvas.width,this.canvas.height),I.render(this.scene,this.camera);const s=I.domElement,o=this.canvas.getContext("2d");o.globalCompositeOperation="copy",o.drawImage(s,0,s.height-t,A,t,0,0,A,t),C&&this.dispose()},!I)throw new Error("A target object is required for portraits.");g.renderer.outputColorSpace=i.er$;const{width:A,height:t,zoom:s,perspective:o,lightRotationOffset:e}=this.options={...yI,...C};this.canvas=document.createElement("canvas"),this.canvas.width=A,this.canvas.height=t,this.scene=new i.Z58;const l=o.includes("n")?-1:1,d=o.includes("x")?1:0,n=o.includes("y")?1:0,c=o.includes("z")?1:0;this.camera=new i.qUd(-s,s,s,-s),this.camera.far=10*s+1,this.camera.near=.1,this.camera.position.set(l*d*s*3.5,l*n*s*3.5,l*c*s*3.5),this.camera.lookAt(0,0,0);const a=this.camera.position.clone();a.applyAxisAngle(new i.Pq0(0,1,0),e);const h=new i.ZyN(16777215,3);h.position.copy(a),this.scene.add(h),this.setObject(I),this.render()}};VI.renderer=new i.JeP({antialias:!1});let KI=VI;const XI="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICBjb25zdCB0aW1lb3V0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgb25tZXNzYWdlID0gKGUpID0+IHsKICAgIGNvbnN0IHsgdGltZW91dCwgc2lnbmFsLCBpZCB9ID0gZS5kYXRhOwogICAgaWYgKHNpZ25hbCA9PT0gInN0YXJ0IikgewogICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBwb3N0TWVzc2FnZSh7IHNpZ25hbDogInRpbWVvdXQiLCBpZCB9KTsKICAgICAgICB0aW1lb3V0cy5kZWxldGUoaWQpOwogICAgICB9LCB0aW1lb3V0KTsKICAgICAgdGltZW91dHMuc2V0KGlkLCB0aW1lb3V0SWQpOwogICAgfSBlbHNlIGlmIChzaWduYWwgPT09ICJzdG9wIikgewogICAgICBjbGVhclRpbWVvdXQodGltZW91dHMuZ2V0KGlkKSk7CiAgICAgIHRpbWVvdXRzLmRlbGV0ZShpZCk7CiAgICB9CiAgfTsKfSkoKTsK",wI="undefined"!=typeof self&&self.Blob&&new Blob([(g=>Uint8Array.from(atob(g),(g=>g.charCodeAt(0))))(XI)],{type:"text/javascript;charset=utf-8"});function YI(g){let I;try{if(I=wI&&(self.URL||self.webkitURL).createObjectURL(wI),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+XI,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}function HI(g){if(document.hasFocus())return requestAnimationFrame(g);!function(g,I){const C=new YI;let A=0;var i;C.onmessage=I=>{"timeout"===I.data.signal&&I.data.id===A&&g()},i=++A,C.postMessage({signal:"start",timeout:I,id:i})}(g,1e3/60)}const SI="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICBsZXQgaW50ZXJ2YWxJZCA9IG51bGw7CiAgZnVuY3Rpb24gY2xlYXJFeGlzdGluZ0ludGVydmFsKCkgewogICAgaWYgKGludGVydmFsSWQgIT09IG51bGwpIHsKICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbElkKTsKICAgICAgaW50ZXJ2YWxJZCA9IG51bGw7CiAgICB9CiAgfQogIG9ubWVzc2FnZSA9IChlKSA9PiB7CiAgICBjb25zdCB7IGludGVydmFsLCBzaWduYWwgfSA9IGUuZGF0YTsKICAgIGlmIChzaWduYWwgPT09ICJzdGFydCIpIHsKICAgICAgY2xlYXJFeGlzdGluZ0ludGVydmFsKCk7CiAgICAgIGlmIChpbnRlcnZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgaW50ZXJ2YWxJZCA9IHNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgIHBvc3RNZXNzYWdlKCJ0aWNrIik7CiAgICAgICAgfSwgaW50ZXJ2YWwpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHNpZ25hbCA9PT0gInN0b3AiKSB7CiAgICAgIGNsZWFyRXhpc3RpbmdJbnRlcnZhbCgpOwogICAgfQogIH07Cn0pKCk7Cg==",RI="undefined"!=typeof self&&self.Blob&&new Blob([(g=>Uint8Array.from(atob(g),(g=>g.charCodeAt(0))))(SI)],{type:"text/javascript;charset=utf-8"});function kI(g){let I;try{if(I=RI&&(self.URL||self.webkitURL).createObjectURL(RI),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+SI,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}function FI(g,I){const C=new kI;return C.postMessage({signal:"start",interval:I}),C.onmessage=I=>{"tick"===I.data&&g()},()=>{C.postMessage({signal:"stop"}),C.terminate()}}const JI={maxWorker:8},NI=class g{constructor(I,C=JI){this.Proto=I,this.options=C,this.queue=[],this.workers=[],this.available=[],this.addJob=g=>{this.queue.push(g),this.process()},this.process=()=>{if(0!==this.queue.length&&this.available.length>0){const I=this.available.shift(),C=this.workers[I],{message:A,buffers:i,resolve:t}=this.queue.shift();C.port.postMessage(A,i||[]),g.WORKING_COUNT++;const s=({data:A})=>{g.WORKING_COUNT--,C.port.removeEventListener("message",s),this.available.push(I),t(A),0!==this.queue.length&&this.available.length>0&&setTimeout(this.process,0)};C.port.addEventListener("message",s)}};const{maxWorker:A}=C;for(let g=0;g<A;g++){const C=new I;C.port.start(),this.workers.push(C),this.available.push(g)}}get isBusy(){return this.available.length<=0}get workingCount(){return this.workers.length-this.available.length}};NI.WORKING_COUNT=0;let vI=NI;const zI={reachDistance:32,ignoreFluids:!0,highlightType:"box",highlightScale:1.002,highlightLerp:1,inverseDirection:!1,highlightColor:new i.Q1f("white"),highlightOpacity:.1,potentialVisuals:!1};class MI extends i.YJl{constructor(g,I,C={}){if(super(),this.object=g,this.world=I,this.active=!0,this.potential={voxel:[0,0,0],rotation:j,yRotation:0,yRotation4:0,yRotation8:0},this.target=[0,0,0],this.newTargetScale=new i.Pq0,this.newTargetPosition=new i.Pq0,this.targetGroup=new i.YJl,this.potentialGroup=new i.YJl,this.toggle=(g=null)=>{this.active=null===g?!this.active:g,this.potential=null,this.target=null,this.visible=this.active},this.update=()=>{if(!this.active)return;const{reachDistance:g,highlightScale:I}=this.options;this.targetGroup.scale.lerp(this.newTargetScale,this.options.highlightLerp),this.targetGroup.position.lerp(this.newTargetPosition,this.options.highlightLerp);const C=new i.Pq0,A=new i.Pq0;this.object.getWorldPosition(C),this.object.getWorldDirection(A),A.normalize(),this.options.inverseDirection&&A.multiplyScalar(-1);const t=this.world.raycastVoxels(C.toArray(),A.toArray(),g,{ignoreFluids:this.options.ignoreFluids});if(!t)return this.visible=!1,this.target=null,void(this.potential=null);const{voxel:s,normal:o}=t,[e,l,d]=o,n=dg.mapWorldToVoxel(s);if(0===this.world.getVoxelAt(...n))return this.visible=!1,this.target=null,void(this.potential=null);this.visible=!0,this.target=n;const{lookingAt:c}=this;if(c&&this.target){const{isDynamic:g,dynamicFn:C,dynamicPatterns:A}=c,i=A?this.world.getBlockAABBsForDynamicPatterns(s[0],s[1],s[2],A):g?C(s).aabbs:c.aabbs;if(!i.length)return;const t=this.world.getVoxelRotationAt(...this.target);let o=t.rotateAABB(i[0]);for(let I=1;I<i.length;I++){const g=t.rotateAABB(i[I]);o=o.union(g)}o.translate(this.target);let{width:e,height:l,depth:d}=o;e*=I,l*=I,d*=I,this.newTargetScale.set(e,l,d),this.newTargetPosition.set(o.minX,o.minY,o.minZ)}const a=[this.target[0]+e,this.target[1]+l,this.target[2]+d],h=0!==e?e>0?O:E:0!==l?l>0?j:U:0!==d?d>0?q:$:0,Z=g=>{if(0!==Math.abs(l)){const[I,A,t]=[C.x,C.y,C.z],[s,o,e]=[a[0]+.5,a[1]+.5,a[2]+.5];let d=l>0?Math.atan2(I-s,t-e):Math.atan2(t-e,I-s);l<0&&(d+=Math.PI/2);const n=pg.normalizeAngle(d);let c,h,Z=1/0;(4===g?Cg:8===g?Ig:gg).forEach((([g,I])=>{Math.abs(n-g)<Z&&(Z=Math.abs(n-g),c=I,h=g)}));const m=l<0?Math.cos(h-Math.PI/2):Math.sin(h),b=l<0?Math.sin(h-Math.PI/2):Math.cos(h);return this.yRotArrow.setDirection(new i.Pq0(m,0,b).normalize()),c}const[I,A,t]=[C.x,C.y,C.z],[s,o,e]=[a[0]+.5,a[1]+.5,a[2]+.5],d=Math.atan2(I-s,t-e),n=pg.normalizeAngle(d);let c,h,Z=1/0;(4===g?Cg:8===g?Ig:gg).forEach((([g,I])=>{Math.abs(n-g)<Z&&(Z=Math.abs(n-g),c=I,h=g)}));const m=l<0?Math.cos(h-Math.PI/2):Math.sin(h),b=l<0?Math.sin(h-Math.PI/2):Math.cos(h);return this.yRotArrow.setDirection(new i.Pq0(m,0,b).normalize()),c},m=Z(16),b=Z(8),G=Z(4);this.potential={voxel:a,rotation:h,yRotation:m,yRotation4:G,yRotation8:b},this.potential&&(this.potentialGroup.position.set(this.potential.voxel[0]+.5,this.potential.voxel[1]+.5,this.potential.voxel[2]+.5),this.potentialArrow.setDirection(new i.Pq0(e,l,d)))},this.setup=()=>{const{highlightType:g,highlightScale:I,highlightColor:C,highlightOpacity:A}=this.options,t=new i.V9B({color:new i.Q1f(C),opacity:A,transparent:!0});if("outline"===g){const g=.01,C=I,A=new i.eaF(new i.iNn(C,g,g),t);for(let I=-1;I<=1;I+=2)for(let i=-1;i<=1;i+=2){const t=A.clone();t.position.y=(C-g)/2*I,t.position.z=(C-g)/2*i,this.targetGroup.add(t)}for(let I=-1;I<=1;I+=2)for(let i=-1;i<=1;i+=2){const t=A.clone();t.position.z=(C-g)/2*I,t.position.x=(C-g)/2*i,t.rotation.z=Math.PI/2,this.targetGroup.add(t)}for(let I=-1;I<=1;I+=2)for(let i=-1;i<=1;i+=2){const t=A.clone();t.position.x=(C-g)/2*I,t.position.y=(C-g)/2*i,t.rotation.y=Math.PI/2,this.targetGroup.add(t)}const s=new i.Pq0(.5,.5,.5);this.targetGroup.children.forEach((g=>{g.position.add(s)}))}else{if("box"!==g)throw new Error("Invalid highlight type");{const g=new i.eaF(new i.iNn(I,I,I),t);g.position.x+=.5,g.position.y+=.5,g.position.z+=.5,this.targetGroup.add(g)}}this.potentialArrow=new CI({color:"red"}),this.yRotArrow=new CI({color:"green"}),this.potentialGroup.add(this.potentialArrow,this.yRotArrow),this.targetGroup.frustumCulled=!1,this.targetGroup.renderOrder=1e6},!g)throw new Error("VoxelInteract: object is required.");if(!I)throw new Error("VoxelInteract: a world is required to be operated on");const{potentialVisuals:A}=this.options={...zI,...C};this.setup(),this.add(this.targetGroup,this.potentialGroup),this.potentialGroup.visible=A}get lookingAt(){return this.target?this.world.getBlockAt(this.target[0],this.target[1],this.target[2]):null}}class LI{constructor(){this.commands=new Map,this.packets=[],this.fallbackCommand=null,this.onMessage=g=>{var I;switch(g.type){case"INIT":{const{commandSymbol:I}=g.json.options;this._commandSymbol=I,this._commandSymbolCode=cg.mapKeyToCode(I);break}case"CHAT":{const{chat:C}=g;null==(I=this.onChat)||I.call(this,C);break}}}}send(g){if(g.body.startsWith(this._commandSymbol)){const I=g.body.substring(this._commandSymbol.length).split(" ").filter(Boolean),C=I.shift(),A=I.join(" "),i=this.commands.get(C);if(i)return i.process(A.trim()),void this.packets.push({type:"EVENT",events:[{name:"command_executed",payload:JSON.stringify({command:C,args:A.trim(),fullCommand:g.body})}]});this.fallbackCommand&&this.fallbackCommand(g.body.substring(this._commandSymbol.length).trim())}this.packets.push({type:"CHAT",chat:g})}addCommand(g,I,C={}){if(this.commands.has(g))throw new Error(`Command trigger already taken: ${g}`);if(g.split(" ").length>1)throw new Error("Command trigger must be one word.");const A={process:I,description:C.description||"",category:C.category,aliases:C.aliases||[],flags:C.flags||[]};this.commands.set(g,A);for(const i of A.aliases)this.commands.has(i)?console.warn(`Command alias for "${g}", "${i}" ignored as already taken.`):this.commands.set(i,A);return()=>{this.commands.delete(g),A.aliases.forEach((g=>this.commands.delete(g)))}}removeCommand(g){return!!this.commands.delete(g)}get commandSymbol(){return this._commandSymbol}get commandSymbolCode(){return this._commandSymbolCode}setFallbackCommand(g){this.fallbackCommand=g}getAllCommands(){const g=new Map;this.commands.forEach(((I,C)=>{g.has(I)||g.set(I,C)}));const I=[];return g.forEach(((g,C)=>{I.push({trigger:g,description:C.description,category:C.category,aliases:C.aliases,flags:C.flags})})),I.sort(((g,I)=>g.trigger.localeCompare(I.trigger)))}}const xI=Math.PI/2,DI=new i.PTz;function fI(g,I,C){const A=I[0],i=I[2],t=g[0]-A,s=g[2]-i,o=Math.sin(C),e=Math.cos(C),l=[0,0,0];return l[0]=A+s*o+t*e,l[1]=g[1],l[2]=i+s*e-t*o,l}const TI={heading:0,running:!1,jumping:!1,sprinting:!1,crouching:!1,jumpCount:0,isJumping:!1,currentJumpTime:0},QI={sensitivity:100,minPolarAngle:.01*Math.PI,maxPolarAngle:.99*Math.PI,initialPosition:[0,80,10],initialDirection:[0,0,0],rotationLerp:.9,positionLerp:1,stepLerp:.6,bodyWidth:.8,bodyHeight:1.55,bodyDepth:.8,eyeHeight:.9193548387096774,maxSpeed:6,moveForce:30,responsiveness:240,runningFriction:.1,standingFriction:4,flySpeed:40,flyForce:80,flyImpulse:2.5,flyInertia:6,sprintFactor:1.4,crouchFactor:.45,alwaysSprint:!1,airMoveMult:.7,fluidPushForce:.3,jumpImpulse:8,jumpForce:1,jumpTime:50,airJumps:0,stepHeight:.5},PI=class g extends n.EventEmitter{constructor(I,C,A,t={}){if(super(),this.object=new i.YJl,this.isLocked=!1,this.movements={up:!1,down:!1,left:!1,right:!1,front:!1,back:!1,sprint:!1},this.euler=new i.O9p(0,0,0,"YXZ"),this.quaternion=new i.PTz,this.vector=new i.Pq0,this.newPosition=new i.Pq0,this.justUnlocked=!1,this.clock=new i.zD7,this.packets=[],this.ownID="",this.onMessage=g=>{switch(g.type){case"INIT":{const{id:I}=g.json;this.ownID=I;break}case"EVENT":{const{events:I}=g;for(const g of I)switch(g.name.toLowerCase()){case"vox-builtin:position":this.body.setPosition(g.payload),this.body.velocity=[0,0,0];break;case"vox-builtin:force":{const[I,C,A]=g.payload;this.body.applyForce([I,C,A]);break}case"vox-builtin:impulse":{const[I,C,A]=g.payload;this.body.applyImpulse([I,C,A]);break}}break}}},this.update=()=>{const g=Math.min(.1,this.clock.getDelta());if(this.object.quaternion.slerp(this.quaternion,this.options.rotationLerp),this.object.position.lerp(this.newPosition,this.options.positionLerp),this.character){const{x:g,y:I,z:C}=new i.Pq0(0,0,-1).applyQuaternion(this.object.getWorldQuaternion(DI)).normalize(),A=this.object.position.toArray();this.character.set(A,[g,I,C]),this.character.update()}this.arm&&this.arm.update(),this.moveRigidBody(),this.updateRigidBody(g)},this.connect=(I,C="*")=>{const A=[],i=g=>this.onMouseMove(g),t=g=>{g.preventDefault(),this.onPointerlockChange()},s=this.onPointerlockError,o=this.onDocumentClick;this.domElement.addEventListener("mousemove",i),this.domElement.ownerDocument.addEventListener("pointerlockchange",t),this.domElement.ownerDocument.addEventListener("pointerlockerror",s),this.domElement.addEventListener("click",o),A.push((()=>{this.domElement.removeEventListener("mousemove",i),this.domElement.ownerDocument.removeEventListener("pointerlockchange",t),this.domElement.ownerDocument.removeEventListener("pointerlockerror",s),this.domElement.removeEventListener("click",o)}));return Object.entries({KeyW:"front",KeyA:"left",KeyS:"back",KeyD:"right",Space:"up",ShiftLeft:"down",KeyR:"sprint"}).forEach((([i,t])=>{A.push(I.bind(i,(()=>{this.isLocked&&(this.movements[t]=!0)}),C,{identifier:g.INPUT_IDENTIFIER,occasion:"keydown",checkType:"code"})),A.push(I.bind(i,(()=>{this.isLocked&&(this.movements[t]=!1)}),C,{identifier:g.INPUT_IDENTIFIER,occasion:"keyup",checkType:"code"}))})),this.inputs=I,()=>{A.forEach((g=>{try{g()}catch(I){}}))}},this.getDirection=()=>new i.Pq0(0,0,-1).applyQuaternion(this.object.quaternion).normalize(),this.lock=g=>{this.domElement.requestPointerLock(),g&&(this.lockCallback=g)},this.unlock=g=>{this.domElement.ownerDocument.exitPointerLock(),g&&(this.unlockCallback=g)},this.teleport=(g,I,C)=>{const{bodyHeight:A,eyeHeight:i}=this.options;this.newPosition.set(g+.5,I+A*i+1,C+.5),this.body&&(this.body.resting=[0,0,0],this.body.velocity=[0,0,0],this.body.forces=[0,0,0],this.body.impulses=[0,0,0],this.body.resting=[0,0,0],this.body.setPosition([g+.5,I+A/2+1,C+.5]))},this.teleportToTop=(g,I,C=0)=>{if(void 0===g||void 0===I){const{x:g,z:I}=this.object.position,A=this.world.getMaxHeightAt(g,I);return void this.teleport(Math.floor(g),A+C,Math.floor(I))}const[A,i]=dg.mapVoxelToChunk([g,0,I],this.world.options.chunkSize),t=()=>{const A=this.world.getMaxHeightAt(g,I);this.teleport(Math.floor(g),A+C,Math.floor(I))};this.world.getChunkByCoords(A,i).isReady?t():this.world.addChunkInitListener([A,i],t)},this.lookAt=(g,I,C)=>{const A=this.object.position.clone().add(this.object.position.clone().sub(new i.Pq0(g,I,C)));this.object.lookAt(A)},this.resetMovements=()=>{this.movements={sprint:!1,front:!1,back:!1,left:!1,right:!1,down:!1,up:!1}},this.toggleGhostMode=()=>{const{aabb:g}=this.body,[I,C,A]=this.body.getPosition(),{bodyWidth:i,bodyHeight:t,bodyDepth:s}=this.options;if(this.ghostMode)g.minX=I-i/2,g.minY=C-t/2,g.minZ=A-s/2,g.maxX=g.minX+i,g.maxY=g.minY+t,g.maxZ=g.minZ+s,this.body.gravityMultiplier=1;else{const I=(g.minX+g.maxX)/2,C=(g.minY+g.maxY)/2,A=(g.minZ+g.maxZ)/2;g.minX=I+1,g.maxX=I-1,g.minY=C+1,g.maxY=C-1,g.minZ=A+1,g.maxZ=A-1,this.body.gravityMultiplier=0}},this.toggleFly=()=>{if(!this.ghostMode){const g=0===this.body.gravityMultiplier;g||this.body.applyImpulse([0,8,0]),setTimeout((()=>{this.body.gravityMultiplier=g?1:0}),100)}},this.reset=()=>{this.teleport(...this.options.initialPosition),this.quaternion.setFromUnitVectors(new i.Pq0(0,0,-1),new i.Pq0(this.options.initialDirection[0],this.options.initialDirection[1],this.options.initialDirection[2]).normalize()),this.object.rotation.set(0,0,0),this.resetMovements()},this.moveForward=g=>{this.vector.setFromMatrixColumn(this.object.matrix,0),this.vector.crossVectors(this.object.up,this.vector),this.object.position.addScaledVector(this.vector,g)},this.moveRight=g=>{this.vector.setFromMatrixColumn(this.object.matrix,0),this.object.position.addScaledVector(this.vector,g)},this.attachCharacter=(g,I=1)=>{g instanceof Dg?(g.options.positionLerp=I,this.options.bodyHeight=g.totalHeight,this.options.bodyWidth=g.body.width,this.options.bodyDepth=g.body.depth,this.options.eyeHeight=g.eyeHeight/g.totalHeight,this.body.aabb.maxX=this.body.aabb.minX+this.options.bodyWidth,this.body.aabb.maxY=this.body.aabb.minY+this.options.bodyHeight,this.body.aabb.maxZ=this.body.aabb.minZ+this.options.bodyDepth,this.character=g):console.warn("Character not attached: not a default character.")},this.attachArm=g=>{this.arm=g,g.getWorldPosition=g=>(g.copy(this.object.position),g),g.emitSwingEvent=()=>{this.character.playArmSwingAnimation(),this.packets.push({type:"EVENT",events:[{name:"vox-builtin:arm-swing",payload:this.ownID}]})}},this.moveRigidBody=()=>{const{object:g,state:I}=this,{sprint:C,right:A,left:t,up:s,down:o,front:e,back:l}=this.movements,d=e?l?0:1:l?-1:0,n=t?A?0:1:A?-1:0,c=new i.Pq0;c.setFromMatrixColumn(g.matrix,0),c.crossVectors(g.up,c);const{x:a,z:h}=c;c.setFromMatrixColumn(g.matrix,0);const{x:Z,z:m}=c,b=a+Z,G=h+m;let B=Math.atan2(b,G);d|n?(I.running=!0,d?(-1===d&&(B+=Math.PI),n&&(B+=Math.PI/4*d*n)):B+=n*Math.PI/2,I.heading=B+Math.PI/4):(I.running=!1,I.sprinting&&(this.movements.sprint=!1,I.sprinting=!1)),I.jumping=s,I.crouching=o,I.sprinting=!!this.options.alwaysSprint||C,this.ghostMode||0===this.body.gravityMultiplier&&-1===this.body.atRestY&&(this.body.gravityMultiplier=1),this.body.isCliffHanging=I.crouching},this.updateRigidBody=g=>{const{airJumps:I,jumpForce:C,jumpTime:A,jumpImpulse:i,maxSpeed:t,sprintFactor:s,crouchFactor:o,moveForce:e,airMoveMult:l,responsiveness:d,runningFriction:n,standingFriction:c,flyInertia:a,flyImpulse:h,flyForce:Z,flySpeed:m,fluidPushForce:b}=this.options;if(this.body.gravityMultiplier){const a=this.body.atRestY<0,h=a||this.state.jumpCount<I;if(a&&(this.state.isJumping=!1,this.state.jumpCount=0),this.state.jumping)if(this.state.isJumping){if(this.state.currentJumpTime>0){let I=C;this.state.currentJumpTime<g&&(I*=this.state.currentJumpTime/g),this.body.applyForce([0,I,0]),this.state.currentJumpTime-=g}}else h?(this.state.isJumping=!0,a||this.state.jumpCount++,this.state.currentJumpTime=A,this.body.applyImpulse([0,i,0]),!a&&this.body.velocity[1]<0&&(this.body.velocity[1]=0)):this.body.ratioInFluid>0&&this.body.applyImpulse([0,b,0]);else this.state.isJumping=!1;let Z=[0,0,0],m=[0,0,0];if(this.state.running){let g=t;this.state.sprinting&&(g*=s),this.state.crouching&&-1===this.body.resting[1]&&(g*=o),Z[2]=g,Z=fI(Z,[0,0,0],this.state.heading),m=[Z[0]-this.body.velocity[0],Z[1]-this.body.velocity[1],Z[2]-this.body.velocity[2]],m[1]=0;const I=Math.sqrt(m[0]**2+m[1]**2+m[2]**2);if(I>0){m[0]/=I,m[1]/=I,m[2]/=I;let g=e;a||(g*=l);const C=d*I;g>C&&(g=C),m[0]*=g,m[1]*=g,m[2]*=g,this.body.applyForce(m)}this.body.friction=n}else this.body.friction=c}else{this.body.velocity[0]-=this.body.velocity[0]*a*g,this.body.velocity[1]-=this.body.velocity[1]*a*g,this.body.velocity[2]-=this.body.velocity[2]*a*g,this.state.jumping&&this.body.applyImpulse([0,h,0]),this.state.crouching&&this.body.applyImpulse([0,-h,0]);let I=[0,0,0],C=[0,0,0];if(this.state.running){let g=m;this.state.sprinting&&(g*=s),this.state.crouching&&(g*=o),I[2]=g,I=fI(I,[0,0,0],this.state.heading),C=[I[0]-this.body.velocity[0],I[1]-this.body.velocity[1],I[2]-this.body.velocity[2]],C[1]=0;const A=Math.sqrt(C[0]**2+C[2]**2);if(A>0){C[0]/=A,C[2]/=A;let g=Z;const I=d*A;g>I&&(g=I),C[0]*=g,C[1]*=g,C[2]*=g,this.body.applyForce(C)}this.body.friction=n}else this.body.friction=c}const[G,B,W]=this.body.getPosition(),{eyeHeight:p,bodyHeight:u}=this.options;this.newPosition.set(G,B+u*(p-.5),W)},this.onMouseMove=g=>{if(!1===this.isLocked)return;if(this.justUnlocked)return void(this.justUnlocked=!1);const I=g.movementX||0,C=g.movementY||0;this.euler.setFromQuaternion(this.quaternion),this.euler.y-=I*this.options.sensitivity*.002/100,this.euler.x-=C*this.options.sensitivity*.002/100,this.euler.x=Math.max(xI-this.options.maxPolarAngle,Math.min(xI-this.options.minPolarAngle,this.euler.x)),this.quaternion.setFromEuler(this.euler)},this.onPointerlockChange=()=>{this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.onLock(),this.lockCallback&&(this.lockCallback(),this.lockCallback=void 0),this.isLocked=!0):(this.onUnlock(),this.unlockCallback&&(this.unlockCallback(),this.unlockCallback=void 0),this.isLocked=!1)},this.onPointerlockError=()=>{console.error("VOXELIZE.RigidControls: Unable to use Pointer Lock API")},this.onDocumentClick=()=>{this.isLocked||this.lock()},this.onLock=()=>{this.emit("lock")},this.onUnlock=()=>{this.emit("unlock"),this.justUnlocked=!0},!I)throw new Error("RigidControls: Camera is required.");if(!C)throw new Error("RigidControls: DOM Element is required.");if(!A)throw new Error("RigidControls: World is required.");this.camera=I,this.world=A,this.domElement=C,this.state=TI;const{bodyWidth:o,bodyHeight:e,bodyDepth:l}=this.options={...QI,...t};this.object.add(this.camera),this.world.add(this.object),this.body=A.physics.addBody({aabb:new s(0,0,0,o,e,l),onStep:g=>{const{positionLerp:I,stepLerp:C}=this.options;this.options.positionLerp=C,this.body.aabb=g.clone();const A=setTimeout((()=>{this.options.positionLerp=I,clearTimeout(A)}),500)},stepHeight:this.options.stepHeight}),this.reset()}on(g,I){return super.on(g,I)}get ghostMode(){return this.body.aabb.width<=0}get flyMode(){return 0===this.body.gravityMultiplier&&!this.ghostMode}get voxel(){const[g,I,C]=this.body.getPosition();return dg.mapWorldToVoxel([g,I-.5*this.options.bodyHeight,C])}get position(){const g=new i.Pq0(...this.body.getPosition());return g.y-=.5*this.options.bodyHeight,g}get chunk(){return dg.mapVoxelToChunk(this.voxel,this.world.options.chunkSize)}};PI.INPUT_IDENTIFIER="voxelize-rigid-controls";let jI=PI;class UI extends jI{constructor(g,I,C,A={}){super(g,I,C,A),this.mobileEuler=new i.O9p(0,0,0,"YXZ"),this.mobileQuaternion=new i.PTz,this.setMovementVector=(g,I)=>{this.movements.left=g<-.1,this.movements.right=g>.1,this.movements.front=I>.1,this.movements.back=I<-.1},this.setJumping=g=>{this.movements.up=g},this.setLookDirection=(g,I)=>{if(!this.isLocked)return;const C=Math.PI/2,A=.012*this.options.sensitivity/100;this.mobileEuler.setFromQuaternion(this.mobileQuaternion),this.mobileEuler.y-=g*A,this.mobileEuler.x-=I*A,this.mobileEuler.x=Math.max(C-this.options.maxPolarAngle,Math.min(C-this.options.minPolarAngle,this.mobileEuler.x)),this.mobileQuaternion.setFromEuler(this.mobileEuler),this.quaternion.copy(this.mobileQuaternion)},this.resetMovements=()=>{this.movements.up=!1,this.movements.down=!1,this.movements.left=!1,this.movements.right=!1,this.movements.front=!1,this.movements.back=!1,this.movements.sprint=!1},this.lock=()=>{},this.unlock=()=>{},this.connect=()=>()=>{},this.isLocked=!0,this.options.alwaysSprint=!0}}class OI extends i.YJl{constructor(g){super(),this.entId=g}}class EI extends i.YJl{constructor(){super(...arguments),this.map=new Map,this.types=new Map,this.setClass=(g,I)=>{this.types.set(g.toLowerCase(),I)},this.onMessage=g=>{const{entities:I}=g;I&&I.length&&I.forEach((g=>{var I,C,A,i,t;const{id:s,type:o,metadata:e,operation:l}=g;if(o.startsWith("block::"))return;let d=this.map.get(s);switch(l){case"CREATE":if(d)return;d=this.createEntityOfType(o,s),null==(I=d.onCreate)||I.call(d,e);break;case"UPDATE":d||(d=this.createEntityOfType(o,s),null==(C=d.onCreate)||C.call(d,e)),null==(A=d.onUpdate)||A.call(d,e);break;case"DELETE":if(!d)return void console.warn(`Entity ${s} does not exist.`);this.map.delete(s),null==(i=d.parent)||i.remove(d),null==(t=d.onDelete)||t.call(d,e)}}))},this.getEntityById=g=>this.map.get(g),this.update=()=>{this.map.forEach((g=>{var I;null==(I=g.update)||I.call(g)}))},this.createEntityOfType=(g,I)=>{if(!this.types.has(g))return void console.warn(`Entity type ${g} is not registered.`);const C=this.types.get(g.toLowerCase());let A;return A="function"==typeof C&&C.prototype&&C.prototype.constructor?new C(I):C(I),this.map.set(I,A),this.add(A),A}}}class qI extends Map{constructor(){super(),this.packets=[],this.onMessage=g=>{if("EVENT"!==g.type);else{const{events:I}=g;I.forEach((g=>{this.handle(g.name,g.payload)}))}},this.addEventListener=(g,I)=>{this.on(g,I)},this.on=(g,I)=>{this.has(g)?console.warn(`Registering handler for ${g} canceled: handler already exists.`):this.set(g,I)},this.emit=(g,I={})=>{this.packets.push({type:"EVENT",events:[{name:g,payload:JSON.stringify(I)}]})},this.handle=(g,I)=>{const C=this.get(g);C&&C(I)}}}class $I extends n.EventEmitter{constructor(){super(),this.clickCallbacks=new Map,this.scrollCallbacks=new Map,this.keyDownCallbacks=new Map,this.keyUpCallbacks=new Map,this.keyPressCallbacks=new Map,this.keyBounds=new Map,this.unbinds=[],this.click=(g,I,C="*")=>{var A;const i=(0,c.A)();return null==(A=this.clickCallbacks.get(g))||A.set(i,{namespace:C,callback:I}),()=>this.clickCallbacks.get(g).delete(i)},this.scroll=(g,I,C="*")=>{const A=(0,c.A)();return this.scrollCallbacks.set(A,{up:g,down:I,namespace:C}),()=>this.scrollCallbacks.delete(A)},this.bind=(g,I,C="*",A={})=>{g=this.modifyKey(g);const{occasion:i="keydown",identifier:t="default",checkType:s="code"}=A,o=g+i,e=this.keyBounds.get(o)||[];if(e.some((g=>g.identifier===t)))throw new Error(`Error registering input, key ${g} with checkType ${s}: already bound.`);const l=C=>{const A="code"===s?C.code:C.key;return this.modifyKey(A)===this.modifyKey(g)&&I(C)},d="keydown"===i?this.keyDownCallbacks:"keyup"===i?this.keyUpCallbacks:this.keyPressCallbacks;d.set(o,[...d.get(o)||[],l]);const n=()=>{var g;const I=d.get(o);if(I){const g=I.indexOf(l);-1!==g&&I.splice(g,1)}0===(null==(g=d.get(o))?void 0:g.length)&&d.delete(o);const C=this.keyBounds.get(o)||[],A=C.findIndex((g=>g.identifier===t));-1!==A&&(C.splice(A,1),0===C.length?this.keyBounds.delete(o):this.keyBounds.set(o,C))},c={unbind:n,callback:l,namespaces:C,identifier:t};return e.push(c),this.keyBounds.set(o,e),n},this.unbind=(g,I={})=>{g=this.modifyKey(g);const{occasion:C="keydown",identifier:A="default"}=I,i=g+C,t=this.keyBounds.get(i)||[],s=t.findIndex((g=>g.identifier===A));if(-1!==s){const{unbind:g}=t[s];return g(),!0}return!1},this.swap=(g,I,C={})=>{const A=g,i=I;g=this.modifyKey(g),I=this.modifyKey(I);const{occasion:t="keydown",identifier:s="default",checkType:o="code"}=C,e=g+t,l=I+t,d=this.keyBounds.get(e)||[],n=this.keyBounds.get(l)||[],c=d.findIndex((g=>g.identifier===s)),a=n.findIndex((g=>g.identifier===s));if(-1===c)throw new Error(`Key ${e} is not bound.`);if(-1===a)throw new Error(`Key ${l} is not bound.`);const{unbind:h,callback:Z,namespaces:m}=d[c],{unbind:b,callback:G,namespaces:B}=n[a];h(),b(),this.bind(i,Z,m,{occasion:t,identifier:s,checkType:o}),this.bind(A,G,B,{occasion:t,identifier:s,checkType:o})},this.remap=(g,I,C={})=>{const A=I;g=this.modifyKey(g),I=this.modifyKey(I);const{occasion:i="keydown",identifier:t="default",checkType:s="code"}=C,o=g+i,e=this.keyBounds.get(o)||[],l=e.findIndex((g=>g.identifier===t));if(-1===l)throw new Error(`Key ${o} is not bound.`);const{unbind:d,callback:n,namespaces:c}=e[l];d(),this.bind(A,n,c,{occasion:i,identifier:t,checkType:s})},this.setNamespace=g=>{this.namespace=g,this.emit("namespace",g)},this.reset=()=>{this.keyBounds.forEach((g=>g.forEach((g=>g.unbind())))),this.unbinds.forEach((g=>g()))},this.modifyKey=g=>g?(g.length>1?g.charAt(0).toUpperCase()+g.slice(1):g).toLowerCase():g,this.initializeKeyListeners=()=>{const g=(g,I)=>{for(const C of I){const{callback:I,namespaces:A}=C;if("*"===A||Array.isArray(A)?new Set(A).has(this.namespace):A===this.namespace){if(I(g))break}}},I=I=>C=>{const{key:A,code:i}=C,t=A.toLowerCase(),s=i.toLowerCase(),o=t+I,e=s+I,l=this.keyBounds.get(o),d=this.keyBounds.get(e);l&&g(C,l),d&&g(C,d)};document.addEventListener("keydown",I("keydown")),document.addEventListener("keyup",I("keyup")),document.addEventListener("keypress",I("keypress"))},this.initializeClickListeners=()=>{["left","middle","right"].forEach((g=>this.clickCallbacks.set(g,new Map)));const g=g=>{let I;0===g.button?I=this.clickCallbacks.get("left"):1===g.button?I=this.clickCallbacks.get("middle"):2===g.button&&(I=this.clickCallbacks.get("right"));for(const C of I.values()){const{namespace:I,callback:A}=C;if(this.namespace===I||"*"===I){if(A(g))break}}};document.addEventListener("mousedown",g,!1),this.unbinds.push((()=>document.removeEventListener("mousedown",g,!1)))},this.initializeScrollListeners=()=>{const g=g=>{for(const I of this.scrollCallbacks.values()){const{up:C,down:A,namespace:i}=I;if(this.namespace===i||"*"===i){if(g.deltaY>0?C(g.deltaY,g):A(g.deltaY,g))break}}};document.addEventListener("wheel",g),this.unbinds.push((()=>document.removeEventListener("wheel",g)))},this.initializeKeyListeners(),this.initializeClickListeners(),this.initializeScrollListeners()}on(g,I){return super.on(g,I),this}}class _I{constructor(){this.packets=[],this.call=(g,I={})=>{this.packets.push({type:"METHOD",method:{name:g,payload:JSON.stringify(I)}})}}}function gC(g){return new SharedWorker("data:text/javascript;base64,KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgY29tbW9uanNHbG9iYWwgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiA/IGdsb2JhbCA6IHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIiA/IHNlbGYgOiB7fTsKICB2YXIgaW5kZXhNaW5pbWFsID0ge307CiAgdmFyIG1pbmltYWwkMSA9IHt9OwogIHZhciBhc3Byb21pc2UgPSBhc1Byb21pc2U7CiAgZnVuY3Rpb24gYXNQcm9taXNlKGZuLCBjdHgpIHsKICAgIHZhciBwYXJhbXMgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBvZmZzZXQgPSAwLCBpbmRleCA9IDIsIHBlbmRpbmcgPSB0cnVlOwogICAgd2hpbGUgKGluZGV4IDwgYXJndW1lbnRzLmxlbmd0aCkKICAgICAgcGFyYW1zW29mZnNldCsrXSA9IGFyZ3VtZW50c1tpbmRleCsrXTsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiBleGVjdXRvcihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgcGFyYW1zW29mZnNldF0gPSBmdW5jdGlvbiBjYWxsYmFjayhlcnIyKSB7CiAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgIHBlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIGlmIChlcnIyKQogICAgICAgICAgICByZWplY3QoZXJyMik7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIHBhcmFtczIgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCAtIDEpLCBvZmZzZXQyID0gMDsKICAgICAgICAgICAgd2hpbGUgKG9mZnNldDIgPCBwYXJhbXMyLmxlbmd0aCkKICAgICAgICAgICAgICBwYXJhbXMyW29mZnNldDIrK10gPSBhcmd1bWVudHNbb2Zmc2V0Ml07CiAgICAgICAgICAgIHJlc29sdmUuYXBwbHkobnVsbCwgcGFyYW1zMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICB0cnkgewogICAgICAgIGZuLmFwcGx5KGN0eCB8fCBudWxsLCBwYXJhbXMpOwogICAgICB9IGNhdGNoIChlcnIyKSB7CiAgICAgICAgaWYgKHBlbmRpbmcpIHsKICAgICAgICAgIHBlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHJlamVjdChlcnIyKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICB2YXIgYmFzZTY0JDEgPSB7fTsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgdmFyIGJhc2U2NDIgPSBleHBvcnRzOwogICAgYmFzZTY0Mi5sZW5ndGggPSBmdW5jdGlvbiBsZW5ndGgoc3RyaW5nKSB7CiAgICAgIHZhciBwID0gc3RyaW5nLmxlbmd0aDsKICAgICAgaWYgKCFwKQogICAgICAgIHJldHVybiAwOwogICAgICB2YXIgbiA9IDA7CiAgICAgIHdoaWxlICgtLXAgJSA0ID4gMSAmJiBzdHJpbmcuY2hhckF0KHApID09PSAiPSIpCiAgICAgICAgKytuOwogICAgICByZXR1cm4gTWF0aC5jZWlsKHN0cmluZy5sZW5ndGggKiAzKSAvIDQgLSBuOwogICAgfTsKICAgIHZhciBiNjQgPSBuZXcgQXJyYXkoNjQpOwogICAgdmFyIHM2NCA9IG5ldyBBcnJheSgxMjMpOwogICAgZm9yICh2YXIgaTIgPSAwOyBpMiA8IDY0OyApCiAgICAgIHM2NFtiNjRbaTJdID0gaTIgPCAyNiA/IGkyICsgNjUgOiBpMiA8IDUyID8gaTIgKyA3MSA6IGkyIDwgNjIgPyBpMiAtIDQgOiBpMiAtIDU5IHwgNDNdID0gaTIrKzsKICAgIGJhc2U2NDIuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKGJ1ZmZlciwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgcGFydHMgPSBudWxsLCBjaHVuayA9IFtdOwogICAgICB2YXIgaTMgPSAwLCBqID0gMCwgdDsKICAgICAgd2hpbGUgKHN0YXJ0IDwgZW5kKSB7CiAgICAgICAgdmFyIGIgPSBidWZmZXJbc3RhcnQrK107CiAgICAgICAgc3dpdGNoIChqKSB7CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIGNodW5rW2kzKytdID0gYjY0W2IgPj4gMl07CiAgICAgICAgICAgIHQgPSAoYiAmIDMpIDw8IDQ7CiAgICAgICAgICAgIGogPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgY2h1bmtbaTMrK10gPSBiNjRbdCB8IGIgPj4gNF07CiAgICAgICAgICAgIHQgPSAoYiAmIDE1KSA8PCAyOwogICAgICAgICAgICBqID0gMjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGNodW5rW2kzKytdID0gYjY0W3QgfCBiID4+IDZdOwogICAgICAgICAgICBjaHVua1tpMysrXSA9IGI2NFtiICYgNjNdOwogICAgICAgICAgICBqID0gMDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmIChpMyA+IDgxOTEpIHsKICAgICAgICAgIChwYXJ0cyB8fCAocGFydHMgPSBbXSkpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rKSk7CiAgICAgICAgICBpMyA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChqKSB7CiAgICAgICAgY2h1bmtbaTMrK10gPSBiNjRbdF07CiAgICAgICAgY2h1bmtbaTMrK10gPSA2MTsKICAgICAgICBpZiAoaiA9PT0gMSkKICAgICAgICAgIGNodW5rW2kzKytdID0gNjE7CiAgICAgIH0KICAgICAgaWYgKHBhcnRzKSB7CiAgICAgICAgaWYgKGkzKQogICAgICAgICAgcGFydHMucHVzaChTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY2h1bmsuc2xpY2UoMCwgaTMpKSk7CiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oIiIpOwogICAgICB9CiAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZywgY2h1bmsuc2xpY2UoMCwgaTMpKTsKICAgIH07CiAgICB2YXIgaW52YWxpZEVuY29kaW5nID0gImludmFsaWQgZW5jb2RpbmciOwogICAgYmFzZTY0Mi5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUoc3RyaW5nLCBidWZmZXIsIG9mZnNldCkgewogICAgICB2YXIgc3RhcnQgPSBvZmZzZXQ7CiAgICAgIHZhciBqID0gMCwgdDsKICAgICAgZm9yICh2YXIgaTMgPSAwOyBpMyA8IHN0cmluZy5sZW5ndGg7ICkgewogICAgICAgIHZhciBjID0gc3RyaW5nLmNoYXJDb2RlQXQoaTMrKyk7CiAgICAgICAgaWYgKGMgPT09IDYxICYmIGogPiAxKQogICAgICAgICAgYnJlYWs7CiAgICAgICAgaWYgKChjID0gczY0W2NdKSA9PT0gdm9pZCAwKQogICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEVuY29kaW5nKTsKICAgICAgICBzd2l0Y2ggKGopIHsKICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgdCA9IGM7CiAgICAgICAgICAgIGogPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IHQgPDwgMiB8IChjICYgNDgpID4+IDQ7CiAgICAgICAgICAgIHQgPSBjOwogICAgICAgICAgICBqID0gMjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSAodCAmIDE1KSA8PCA0IHwgKGMgJiA2MCkgPj4gMjsKICAgICAgICAgICAgdCA9IGM7CiAgICAgICAgICAgIGogPSAzOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9ICh0ICYgMykgPDwgNiB8IGM7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGogPT09IDEpCiAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEVuY29kaW5nKTsKICAgICAgcmV0dXJuIG9mZnNldCAtIHN0YXJ0OwogICAgfTsKICAgIGJhc2U2NDIudGVzdCA9IGZ1bmN0aW9uIHRlc3Qoc3RyaW5nKSB7CiAgICAgIHJldHVybiAvXig/OltBLVphLXowLTkrL117NH0pKig/OltBLVphLXowLTkrL117Mn09PXxbQS1aYS16MC05Ky9dezN9PSk/JC8udGVzdChzdHJpbmcpOwogICAgfTsKICB9KShiYXNlNjQkMSk7CiAgdmFyIGV2ZW50ZW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKICBmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICB9CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIG9uKGV2dCwgZm4sIGN0eCkgewogICAgKHRoaXMuX2xpc3RlbmVyc1tldnRdIHx8ICh0aGlzLl9saXN0ZW5lcnNbZXZ0XSA9IFtdKSkucHVzaCh7CiAgICAgIGZuLAogICAgICBjdHg6IGN0eCB8fCB0aGlzCiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbiBvZmYoZXZ0LCBmbikgewogICAgaWYgKGV2dCA9PT0gdm9pZCAwKQogICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgIGVsc2UgewogICAgICBpZiAoZm4gPT09IHZvaWQgMCkKICAgICAgICB0aGlzLl9saXN0ZW5lcnNbZXZ0XSA9IFtdOwogICAgICBlbHNlIHsKICAgICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzW2V2dF07CiAgICAgICAgZm9yICh2YXIgaTIgPSAwOyBpMiA8IGxpc3RlbmVycy5sZW5ndGg7ICkKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaTJdLmZuID09PSBmbikKICAgICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpMiwgMSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgICsraTI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CiAgRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdChldnQpIHsKICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnNbZXZ0XTsKICAgIGlmIChsaXN0ZW5lcnMpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwgaTIgPSAxOwogICAgICBmb3IgKDsgaTIgPCBhcmd1bWVudHMubGVuZ3RoOyApCiAgICAgICAgYXJncy5wdXNoKGFyZ3VtZW50c1tpMisrXSk7CiAgICAgIGZvciAoaTIgPSAwOyBpMiA8IGxpc3RlbmVycy5sZW5ndGg7ICkKICAgICAgICBsaXN0ZW5lcnNbaTJdLmZuLmFwcGx5KGxpc3RlbmVyc1tpMisrXS5jdHgsIGFyZ3MpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICB2YXIgZmxvYXQgPSBmYWN0b3J5KGZhY3RvcnkpOwogIGZ1bmN0aW9uIGZhY3RvcnkoZXhwb3J0cykgewogICAgaWYgKHR5cGVvZiBGbG9hdDMyQXJyYXkgIT09ICJ1bmRlZmluZWQiKSAoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBmMzIgPSBuZXcgRmxvYXQzMkFycmF5KFstMF0pLCBmOGIgPSBuZXcgVWludDhBcnJheShmMzIuYnVmZmVyKSwgbGUgPSBmOGJbM10gPT09IDEyODsKICAgICAgZnVuY3Rpb24gd3JpdGVGbG9hdF9mMzJfY3B5KHZhbCwgYnVmLCBwb3MpIHsKICAgICAgICBmMzJbMF0gPSB2YWw7CiAgICAgICAgYnVmW3Bvc10gPSBmOGJbMF07CiAgICAgICAgYnVmW3BvcyArIDFdID0gZjhiWzFdOwogICAgICAgIGJ1Zltwb3MgKyAyXSA9IGY4YlsyXTsKICAgICAgICBidWZbcG9zICsgM10gPSBmOGJbM107CiAgICAgIH0KICAgICAgZnVuY3Rpb24gd3JpdGVGbG9hdF9mMzJfcmV2KHZhbCwgYnVmLCBwb3MpIHsKICAgICAgICBmMzJbMF0gPSB2YWw7CiAgICAgICAgYnVmW3Bvc10gPSBmOGJbM107CiAgICAgICAgYnVmW3BvcyArIDFdID0gZjhiWzJdOwogICAgICAgIGJ1Zltwb3MgKyAyXSA9IGY4YlsxXTsKICAgICAgICBidWZbcG9zICsgM10gPSBmOGJbMF07CiAgICAgIH0KICAgICAgZXhwb3J0cy53cml0ZUZsb2F0TEUgPSBsZSA/IHdyaXRlRmxvYXRfZjMyX2NweSA6IHdyaXRlRmxvYXRfZjMyX3JldjsKICAgICAgZXhwb3J0cy53cml0ZUZsb2F0QkUgPSBsZSA/IHdyaXRlRmxvYXRfZjMyX3JldiA6IHdyaXRlRmxvYXRfZjMyX2NweTsKICAgICAgZnVuY3Rpb24gcmVhZEZsb2F0X2YzMl9jcHkoYnVmLCBwb3MpIHsKICAgICAgICBmOGJbMF0gPSBidWZbcG9zXTsKICAgICAgICBmOGJbMV0gPSBidWZbcG9zICsgMV07CiAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDJdOwogICAgICAgIGY4YlszXSA9IGJ1Zltwb3MgKyAzXTsKICAgICAgICByZXR1cm4gZjMyWzBdOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHJlYWRGbG9hdF9mMzJfcmV2KGJ1ZiwgcG9zKSB7CiAgICAgICAgZjhiWzNdID0gYnVmW3Bvc107CiAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDFdOwogICAgICAgIGY4YlsxXSA9IGJ1Zltwb3MgKyAyXTsKICAgICAgICBmOGJbMF0gPSBidWZbcG9zICsgM107CiAgICAgICAgcmV0dXJuIGYzMlswXTsKICAgICAgfQogICAgICBleHBvcnRzLnJlYWRGbG9hdExFID0gbGUgPyByZWFkRmxvYXRfZjMyX2NweSA6IHJlYWRGbG9hdF9mMzJfcmV2OwogICAgICBleHBvcnRzLnJlYWRGbG9hdEJFID0gbGUgPyByZWFkRmxvYXRfZjMyX3JldiA6IHJlYWRGbG9hdF9mMzJfY3B5OwogICAgfSkoKTsKICAgIGVsc2UgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiB3cml0ZUZsb2F0X2llZWU3NTQod3JpdGVVaW50LCB2YWwsIGJ1ZiwgcG9zKSB7CiAgICAgICAgdmFyIHNpZ24gPSB2YWwgPCAwID8gMSA6IDA7CiAgICAgICAgaWYgKHNpZ24pCiAgICAgICAgICB2YWwgPSAtdmFsOwogICAgICAgIGlmICh2YWwgPT09IDApCiAgICAgICAgICB3cml0ZVVpbnQoMSAvIHZhbCA+IDAgPyAoCiAgICAgICAgICAgIC8qIHBvc2l0aXZlICovCiAgICAgICAgICAgIDAKICAgICAgICAgICkgOiAoCiAgICAgICAgICAgIC8qIG5lZ2F0aXZlIDAgKi8KICAgICAgICAgICAgMjE0NzQ4MzY0OAogICAgICAgICAgKSwgYnVmLCBwb3MpOwogICAgICAgIGVsc2UgaWYgKGlzTmFOKHZhbCkpCiAgICAgICAgICB3cml0ZVVpbnQoMjE0MzI4OTM0NCwgYnVmLCBwb3MpOwogICAgICAgIGVsc2UgaWYgKHZhbCA+IDM0MDI4MjM0NjYzODUyODg2ZTIyKQogICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgMjEzOTA5NTA0MCkgPj4+IDAsIGJ1ZiwgcG9zKTsKICAgICAgICBlbHNlIGlmICh2YWwgPCAxMTc1NDk0MzUwODIyMjg3NWUtNTQpCiAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCBNYXRoLnJvdW5kKHZhbCAvIDE0MDEyOTg0NjQzMjQ4MTdlLTYwKSkgPj4+IDAsIGJ1ZiwgcG9zKTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHZhciBleHBvbmVudCA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsKSAvIE1hdGguTE4yKSwgbWFudGlzc2EgPSBNYXRoLnJvdW5kKHZhbCAqIE1hdGgucG93KDIsIC1leHBvbmVudCkgKiA4Mzg4NjA4KSAmIDgzODg2MDc7CiAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCBleHBvbmVudCArIDEyNyA8PCAyMyB8IG1hbnRpc3NhKSA+Pj4gMCwgYnVmLCBwb3MpOwogICAgICAgIH0KICAgICAgfQogICAgICBleHBvcnRzLndyaXRlRmxvYXRMRSA9IHdyaXRlRmxvYXRfaWVlZTc1NC5iaW5kKG51bGwsIHdyaXRlVWludExFKTsKICAgICAgZXhwb3J0cy53cml0ZUZsb2F0QkUgPSB3cml0ZUZsb2F0X2llZWU3NTQuYmluZChudWxsLCB3cml0ZVVpbnRCRSk7CiAgICAgIGZ1bmN0aW9uIHJlYWRGbG9hdF9pZWVlNzU0KHJlYWRVaW50LCBidWYsIHBvcykgewogICAgICAgIHZhciB1aW50ID0gcmVhZFVpbnQoYnVmLCBwb3MpLCBzaWduID0gKHVpbnQgPj4gMzEpICogMiArIDEsIGV4cG9uZW50ID0gdWludCA+Pj4gMjMgJiAyNTUsIG1hbnRpc3NhID0gdWludCAmIDgzODg2MDc7CiAgICAgICAgcmV0dXJuIGV4cG9uZW50ID09PSAyNTUgPyBtYW50aXNzYSA/IE5hTiA6IHNpZ24gKiBJbmZpbml0eSA6IGV4cG9uZW50ID09PSAwID8gc2lnbiAqIDE0MDEyOTg0NjQzMjQ4MTdlLTYwICogbWFudGlzc2EgOiBzaWduICogTWF0aC5wb3coMiwgZXhwb25lbnQgLSAxNTApICogKG1hbnRpc3NhICsgODM4ODYwOCk7CiAgICAgIH0KICAgICAgZXhwb3J0cy5yZWFkRmxvYXRMRSA9IHJlYWRGbG9hdF9pZWVlNzU0LmJpbmQobnVsbCwgcmVhZFVpbnRMRSk7CiAgICAgIGV4cG9ydHMucmVhZEZsb2F0QkUgPSByZWFkRmxvYXRfaWVlZTc1NC5iaW5kKG51bGwsIHJlYWRVaW50QkUpOwogICAgfSkoKTsKICAgIGlmICh0eXBlb2YgRmxvYXQ2NEFycmF5ICE9PSAidW5kZWZpbmVkIikgKGZ1bmN0aW9uKCkgewogICAgICB2YXIgZjY0ID0gbmV3IEZsb2F0NjRBcnJheShbLTBdKSwgZjhiID0gbmV3IFVpbnQ4QXJyYXkoZjY0LmJ1ZmZlciksIGxlID0gZjhiWzddID09PSAxMjg7CiAgICAgIGZ1bmN0aW9uIHdyaXRlRG91YmxlX2Y2NF9jcHkodmFsLCBidWYsIHBvcykgewogICAgICAgIGY2NFswXSA9IHZhbDsKICAgICAgICBidWZbcG9zXSA9IGY4YlswXTsKICAgICAgICBidWZbcG9zICsgMV0gPSBmOGJbMV07CiAgICAgICAgYnVmW3BvcyArIDJdID0gZjhiWzJdOwogICAgICAgIGJ1Zltwb3MgKyAzXSA9IGY4YlszXTsKICAgICAgICBidWZbcG9zICsgNF0gPSBmOGJbNF07CiAgICAgICAgYnVmW3BvcyArIDVdID0gZjhiWzVdOwogICAgICAgIGJ1Zltwb3MgKyA2XSA9IGY4Yls2XTsKICAgICAgICBidWZbcG9zICsgN10gPSBmOGJbN107CiAgICAgIH0KICAgICAgZnVuY3Rpb24gd3JpdGVEb3VibGVfZjY0X3Jldih2YWwsIGJ1ZiwgcG9zKSB7CiAgICAgICAgZjY0WzBdID0gdmFsOwogICAgICAgIGJ1Zltwb3NdID0gZjhiWzddOwogICAgICAgIGJ1Zltwb3MgKyAxXSA9IGY4Yls2XTsKICAgICAgICBidWZbcG9zICsgMl0gPSBmOGJbNV07CiAgICAgICAgYnVmW3BvcyArIDNdID0gZjhiWzRdOwogICAgICAgIGJ1Zltwb3MgKyA0XSA9IGY4YlszXTsKICAgICAgICBidWZbcG9zICsgNV0gPSBmOGJbMl07CiAgICAgICAgYnVmW3BvcyArIDZdID0gZjhiWzFdOwogICAgICAgIGJ1Zltwb3MgKyA3XSA9IGY4YlswXTsKICAgICAgfQogICAgICBleHBvcnRzLndyaXRlRG91YmxlTEUgPSBsZSA/IHdyaXRlRG91YmxlX2Y2NF9jcHkgOiB3cml0ZURvdWJsZV9mNjRfcmV2OwogICAgICBleHBvcnRzLndyaXRlRG91YmxlQkUgPSBsZSA/IHdyaXRlRG91YmxlX2Y2NF9yZXYgOiB3cml0ZURvdWJsZV9mNjRfY3B5OwogICAgICBmdW5jdGlvbiByZWFkRG91YmxlX2Y2NF9jcHkoYnVmLCBwb3MpIHsKICAgICAgICBmOGJbMF0gPSBidWZbcG9zXTsKICAgICAgICBmOGJbMV0gPSBidWZbcG9zICsgMV07CiAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDJdOwogICAgICAgIGY4YlszXSA9IGJ1Zltwb3MgKyAzXTsKICAgICAgICBmOGJbNF0gPSBidWZbcG9zICsgNF07CiAgICAgICAgZjhiWzVdID0gYnVmW3BvcyArIDVdOwogICAgICAgIGY4Yls2XSA9IGJ1Zltwb3MgKyA2XTsKICAgICAgICBmOGJbN10gPSBidWZbcG9zICsgN107CiAgICAgICAgcmV0dXJuIGY2NFswXTsKICAgICAgfQogICAgICBmdW5jdGlvbiByZWFkRG91YmxlX2Y2NF9yZXYoYnVmLCBwb3MpIHsKICAgICAgICBmOGJbN10gPSBidWZbcG9zXTsKICAgICAgICBmOGJbNl0gPSBidWZbcG9zICsgMV07CiAgICAgICAgZjhiWzVdID0gYnVmW3BvcyArIDJdOwogICAgICAgIGY4Yls0XSA9IGJ1Zltwb3MgKyAzXTsKICAgICAgICBmOGJbM10gPSBidWZbcG9zICsgNF07CiAgICAgICAgZjhiWzJdID0gYnVmW3BvcyArIDVdOwogICAgICAgIGY4YlsxXSA9IGJ1Zltwb3MgKyA2XTsKICAgICAgICBmOGJbMF0gPSBidWZbcG9zICsgN107CiAgICAgICAgcmV0dXJuIGY2NFswXTsKICAgICAgfQogICAgICBleHBvcnRzLnJlYWREb3VibGVMRSA9IGxlID8gcmVhZERvdWJsZV9mNjRfY3B5IDogcmVhZERvdWJsZV9mNjRfcmV2OwogICAgICBleHBvcnRzLnJlYWREb3VibGVCRSA9IGxlID8gcmVhZERvdWJsZV9mNjRfcmV2IDogcmVhZERvdWJsZV9mNjRfY3B5OwogICAgfSkoKTsKICAgIGVsc2UgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiB3cml0ZURvdWJsZV9pZWVlNzU0KHdyaXRlVWludCwgb2ZmMCwgb2ZmMSwgdmFsLCBidWYsIHBvcykgewogICAgICAgIHZhciBzaWduID0gdmFsIDwgMCA/IDEgOiAwOwogICAgICAgIGlmIChzaWduKQogICAgICAgICAgdmFsID0gLXZhbDsKICAgICAgICBpZiAodmFsID09PSAwKSB7CiAgICAgICAgICB3cml0ZVVpbnQoMCwgYnVmLCBwb3MgKyBvZmYwKTsKICAgICAgICAgIHdyaXRlVWludCgxIC8gdmFsID4gMCA/ICgKICAgICAgICAgICAgLyogcG9zaXRpdmUgKi8KICAgICAgICAgICAgMAogICAgICAgICAgKSA6ICgKICAgICAgICAgICAgLyogbmVnYXRpdmUgMCAqLwogICAgICAgICAgICAyMTQ3NDgzNjQ4CiAgICAgICAgICApLCBidWYsIHBvcyArIG9mZjEpOwogICAgICAgIH0gZWxzZSBpZiAoaXNOYU4odmFsKSkgewogICAgICAgICAgd3JpdGVVaW50KDAsIGJ1ZiwgcG9zICsgb2ZmMCk7CiAgICAgICAgICB3cml0ZVVpbnQoMjE0Njk1OTM2MCwgYnVmLCBwb3MgKyBvZmYxKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbCA+IDE3OTc2OTMxMzQ4NjIzMTU3ZTI5MikgewogICAgICAgICAgd3JpdGVVaW50KDAsIGJ1ZiwgcG9zICsgb2ZmMCk7CiAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCAyMTQ2NDM1MDcyKSA+Pj4gMCwgYnVmLCBwb3MgKyBvZmYxKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG1hbnRpc3NhOwogICAgICAgICAgaWYgKHZhbCA8IDIyMjUwNzM4NTg1MDcyMDE0ZS0zMjQpIHsKICAgICAgICAgICAgbWFudGlzc2EgPSB2YWwgLyA1ZS0zMjQ7CiAgICAgICAgICAgIHdyaXRlVWludChtYW50aXNzYSA+Pj4gMCwgYnVmLCBwb3MgKyBvZmYwKTsKICAgICAgICAgICAgd3JpdGVVaW50KChzaWduIDw8IDMxIHwgbWFudGlzc2EgLyA0Mjk0OTY3Mjk2KSA+Pj4gMCwgYnVmLCBwb3MgKyBvZmYxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBleHBvbmVudCA9IE1hdGguZmxvb3IoTWF0aC5sb2codmFsKSAvIE1hdGguTE4yKTsKICAgICAgICAgICAgaWYgKGV4cG9uZW50ID09PSAxMDI0KQogICAgICAgICAgICAgIGV4cG9uZW50ID0gMTAyMzsKICAgICAgICAgICAgbWFudGlzc2EgPSB2YWwgKiBNYXRoLnBvdygyLCAtZXhwb25lbnQpOwogICAgICAgICAgICB3cml0ZVVpbnQobWFudGlzc2EgKiA0NTAzNTk5NjI3MzcwNDk2ID4+PiAwLCBidWYsIHBvcyArIG9mZjApOwogICAgICAgICAgICB3cml0ZVVpbnQoKHNpZ24gPDwgMzEgfCBleHBvbmVudCArIDEwMjMgPDwgMjAgfCBtYW50aXNzYSAqIDEwNDg1NzYgJiAxMDQ4NTc1KSA+Pj4gMCwgYnVmLCBwb3MgKyBvZmYxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZXhwb3J0cy53cml0ZURvdWJsZUxFID0gd3JpdGVEb3VibGVfaWVlZTc1NC5iaW5kKG51bGwsIHdyaXRlVWludExFLCAwLCA0KTsKICAgICAgZXhwb3J0cy53cml0ZURvdWJsZUJFID0gd3JpdGVEb3VibGVfaWVlZTc1NC5iaW5kKG51bGwsIHdyaXRlVWludEJFLCA0LCAwKTsKICAgICAgZnVuY3Rpb24gcmVhZERvdWJsZV9pZWVlNzU0KHJlYWRVaW50LCBvZmYwLCBvZmYxLCBidWYsIHBvcykgewogICAgICAgIHZhciBsbyA9IHJlYWRVaW50KGJ1ZiwgcG9zICsgb2ZmMCksIGhpID0gcmVhZFVpbnQoYnVmLCBwb3MgKyBvZmYxKTsKICAgICAgICB2YXIgc2lnbiA9IChoaSA+PiAzMSkgKiAyICsgMSwgZXhwb25lbnQgPSBoaSA+Pj4gMjAgJiAyMDQ3LCBtYW50aXNzYSA9IDQyOTQ5NjcyOTYgKiAoaGkgJiAxMDQ4NTc1KSArIGxvOwogICAgICAgIHJldHVybiBleHBvbmVudCA9PT0gMjA0NyA/IG1hbnRpc3NhID8gTmFOIDogc2lnbiAqIEluZmluaXR5IDogZXhwb25lbnQgPT09IDAgPyBzaWduICogNWUtMzI0ICogbWFudGlzc2EgOiBzaWduICogTWF0aC5wb3coMiwgZXhwb25lbnQgLSAxMDc1KSAqIChtYW50aXNzYSArIDQ1MDM1OTk2MjczNzA0OTYpOwogICAgICB9CiAgICAgIGV4cG9ydHMucmVhZERvdWJsZUxFID0gcmVhZERvdWJsZV9pZWVlNzU0LmJpbmQobnVsbCwgcmVhZFVpbnRMRSwgMCwgNCk7CiAgICAgIGV4cG9ydHMucmVhZERvdWJsZUJFID0gcmVhZERvdWJsZV9pZWVlNzU0LmJpbmQobnVsbCwgcmVhZFVpbnRCRSwgNCwgMCk7CiAgICB9KSgpOwogICAgcmV0dXJuIGV4cG9ydHM7CiAgfQogIGZ1bmN0aW9uIHdyaXRlVWludExFKHZhbCwgYnVmLCBwb3MpIHsKICAgIGJ1Zltwb3NdID0gdmFsICYgMjU1OwogICAgYnVmW3BvcyArIDFdID0gdmFsID4+PiA4ICYgMjU1OwogICAgYnVmW3BvcyArIDJdID0gdmFsID4+PiAxNiAmIDI1NTsKICAgIGJ1Zltwb3MgKyAzXSA9IHZhbCA+Pj4gMjQ7CiAgfQogIGZ1bmN0aW9uIHdyaXRlVWludEJFKHZhbCwgYnVmLCBwb3MpIHsKICAgIGJ1Zltwb3NdID0gdmFsID4+PiAyNDsKICAgIGJ1Zltwb3MgKyAxXSA9IHZhbCA+Pj4gMTYgJiAyNTU7CiAgICBidWZbcG9zICsgMl0gPSB2YWwgPj4+IDggJiAyNTU7CiAgICBidWZbcG9zICsgM10gPSB2YWwgJiAyNTU7CiAgfQogIGZ1bmN0aW9uIHJlYWRVaW50TEUoYnVmLCBwb3MpIHsKICAgIHJldHVybiAoYnVmW3Bvc10gfCBidWZbcG9zICsgMV0gPDwgOCB8IGJ1Zltwb3MgKyAyXSA8PCAxNiB8IGJ1Zltwb3MgKyAzXSA8PCAyNCkgPj4+IDA7CiAgfQogIGZ1bmN0aW9uIHJlYWRVaW50QkUoYnVmLCBwb3MpIHsKICAgIHJldHVybiAoYnVmW3Bvc10gPDwgMjQgfCBidWZbcG9zICsgMV0gPDwgMTYgfCBidWZbcG9zICsgMl0gPDwgOCB8IGJ1Zltwb3MgKyAzXSkgPj4+IDA7CiAgfQogIHZhciBpbnF1aXJlXzEgPSBpbnF1aXJlOwogIGZ1bmN0aW9uIGlucXVpcmUobW9kdWxlTmFtZSkgewogICAgdHJ5IHsKICAgICAgdmFyIG1vZCA9IGV2YWwoInF1aXJlIi5yZXBsYWNlKC9eLywgInJlIikpKG1vZHVsZU5hbWUpOwogICAgICBpZiAobW9kICYmIChtb2QubGVuZ3RoIHx8IE9iamVjdC5rZXlzKG1vZCkubGVuZ3RoKSkKICAgICAgICByZXR1cm4gbW9kOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB1dGY4JDIgPSB7fTsKICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgdmFyIHV0ZjgyID0gZXhwb3J0czsKICAgIHV0ZjgyLmxlbmd0aCA9IGZ1bmN0aW9uIHV0ZjhfbGVuZ3RoKHN0cmluZykgewogICAgICB2YXIgbGVuID0gMCwgYyA9IDA7CiAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBzdHJpbmcubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgYyA9IHN0cmluZy5jaGFyQ29kZUF0KGkyKTsKICAgICAgICBpZiAoYyA8IDEyOCkKICAgICAgICAgIGxlbiArPSAxOwogICAgICAgIGVsc2UgaWYgKGMgPCAyMDQ4KQogICAgICAgICAgbGVuICs9IDI7CiAgICAgICAgZWxzZSBpZiAoKGMgJiA2NDUxMikgPT09IDU1Mjk2ICYmIChzdHJpbmcuY2hhckNvZGVBdChpMiArIDEpICYgNjQ1MTIpID09PSA1NjMyMCkgewogICAgICAgICAgKytpMjsKICAgICAgICAgIGxlbiArPSA0OwogICAgICAgIH0gZWxzZQogICAgICAgICAgbGVuICs9IDM7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbjsKICAgIH07CiAgICB1dGY4Mi5yZWFkID0gZnVuY3Rpb24gdXRmOF9yZWFkKGJ1ZmZlciwgc3RhcnQsIGVuZCkgewogICAgICB2YXIgbGVuID0gZW5kIC0gc3RhcnQ7CiAgICAgIGlmIChsZW4gPCAxKQogICAgICAgIHJldHVybiAiIjsKICAgICAgdmFyIHBhcnRzID0gbnVsbCwgY2h1bmsgPSBbXSwgaTIgPSAwLCB0OwogICAgICB3aGlsZSAoc3RhcnQgPCBlbmQpIHsKICAgICAgICB0ID0gYnVmZmVyW3N0YXJ0KytdOwogICAgICAgIGlmICh0IDwgMTI4KQogICAgICAgICAgY2h1bmtbaTIrK10gPSB0OwogICAgICAgIGVsc2UgaWYgKHQgPiAxOTEgJiYgdCA8IDIyNCkKICAgICAgICAgIGNodW5rW2kyKytdID0gKHQgJiAzMSkgPDwgNiB8IGJ1ZmZlcltzdGFydCsrXSAmIDYzOwogICAgICAgIGVsc2UgaWYgKHQgPiAyMzkgJiYgdCA8IDM2NSkgewogICAgICAgICAgdCA9ICgodCAmIDcpIDw8IDE4IHwgKGJ1ZmZlcltzdGFydCsrXSAmIDYzKSA8PCAxMiB8IChidWZmZXJbc3RhcnQrK10gJiA2MykgPDwgNiB8IGJ1ZmZlcltzdGFydCsrXSAmIDYzKSAtIDY1NTM2OwogICAgICAgICAgY2h1bmtbaTIrK10gPSA1NTI5NiArICh0ID4+IDEwKTsKICAgICAgICAgIGNodW5rW2kyKytdID0gNTYzMjAgKyAodCAmIDEwMjMpOwogICAgICAgIH0gZWxzZQogICAgICAgICAgY2h1bmtbaTIrK10gPSAodCAmIDE1KSA8PCAxMiB8IChidWZmZXJbc3RhcnQrK10gJiA2MykgPDwgNiB8IGJ1ZmZlcltzdGFydCsrXSAmIDYzOwogICAgICAgIGlmIChpMiA+IDgxOTEpIHsKICAgICAgICAgIChwYXJ0cyB8fCAocGFydHMgPSBbXSkpLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rKSk7CiAgICAgICAgICBpMiA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwYXJ0cykgewogICAgICAgIGlmIChpMikKICAgICAgICAgIHBhcnRzLnB1c2goU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rLnNsaWNlKDAsIGkyKSkpOwogICAgICAgIHJldHVybiBwYXJ0cy5qb2luKCIiKTsKICAgICAgfQogICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShTdHJpbmcsIGNodW5rLnNsaWNlKDAsIGkyKSk7CiAgICB9OwogICAgdXRmODIud3JpdGUgPSBmdW5jdGlvbiB1dGY4X3dyaXRlKHN0cmluZywgYnVmZmVyLCBvZmZzZXQpIHsKICAgICAgdmFyIHN0YXJ0ID0gb2Zmc2V0LCBjMSwgYzI7CiAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBzdHJpbmcubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgYzEgPSBzdHJpbmcuY2hhckNvZGVBdChpMik7CiAgICAgICAgaWYgKGMxIDwgMTI4KSB7CiAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gYzE7CiAgICAgICAgfSBlbHNlIGlmIChjMSA8IDIwNDgpIHsKICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSA+PiA2IHwgMTkyOwogICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxICYgNjMgfCAxMjg7CiAgICAgICAgfSBlbHNlIGlmICgoYzEgJiA2NDUxMikgPT09IDU1Mjk2ICYmICgoYzIgPSBzdHJpbmcuY2hhckNvZGVBdChpMiArIDEpKSAmIDY0NTEyKSA9PT0gNTYzMjApIHsKICAgICAgICAgIGMxID0gNjU1MzYgKyAoKGMxICYgMTAyMykgPDwgMTApICsgKGMyICYgMTAyMyk7CiAgICAgICAgICArK2kyOwogICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxID4+IDE4IHwgMjQwOwogICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxID4+IDEyICYgNjMgfCAxMjg7CiAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gYzEgPj4gNiAmIDYzIHwgMTI4OwogICAgICAgICAgYnVmZmVyW29mZnNldCsrXSA9IGMxICYgNjMgfCAxMjg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSA+PiAxMiB8IDIyNDsKICAgICAgICAgIGJ1ZmZlcltvZmZzZXQrK10gPSBjMSA+PiA2ICYgNjMgfCAxMjg7CiAgICAgICAgICBidWZmZXJbb2Zmc2V0KytdID0gYzEgJiA2MyB8IDEyODsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9mZnNldCAtIHN0YXJ0OwogICAgfTsKICB9KSh1dGY4JDIpOwogIHZhciBwb29sXzEgPSBwb29sOwogIGZ1bmN0aW9uIHBvb2woYWxsb2MsIHNsaWNlLCBzaXplKSB7CiAgICB2YXIgU0laRSA9IHNpemUgfHwgODE5MjsKICAgIHZhciBNQVggPSBTSVpFID4+PiAxOwogICAgdmFyIHNsYWIgPSBudWxsOwogICAgdmFyIG9mZnNldCA9IFNJWkU7CiAgICByZXR1cm4gZnVuY3Rpb24gcG9vbF9hbGxvYyhzaXplMikgewogICAgICBpZiAoc2l6ZTIgPCAxIHx8IHNpemUyID4gTUFYKQogICAgICAgIHJldHVybiBhbGxvYyhzaXplMik7CiAgICAgIGlmIChvZmZzZXQgKyBzaXplMiA+IFNJWkUpIHsKICAgICAgICBzbGFiID0gYWxsb2MoU0laRSk7CiAgICAgICAgb2Zmc2V0ID0gMDsKICAgICAgfQogICAgICB2YXIgYnVmID0gc2xpY2UuY2FsbChzbGFiLCBvZmZzZXQsIG9mZnNldCArPSBzaXplMik7CiAgICAgIGlmIChvZmZzZXQgJiA3KQogICAgICAgIG9mZnNldCA9IChvZmZzZXQgfCA3KSArIDE7CiAgICAgIHJldHVybiBidWY7CiAgICB9OwogIH0KICB2YXIgbG9uZ2JpdHM7CiAgdmFyIGhhc1JlcXVpcmVkTG9uZ2JpdHM7CiAgZnVuY3Rpb24gcmVxdWlyZUxvbmdiaXRzKCkgewogICAgaWYgKGhhc1JlcXVpcmVkTG9uZ2JpdHMpIHJldHVybiBsb25nYml0czsKICAgIGhhc1JlcXVpcmVkTG9uZ2JpdHMgPSAxOwogICAgbG9uZ2JpdHMgPSBMb25nQml0czI7CiAgICB2YXIgdXRpbDIgPSByZXF1aXJlTWluaW1hbCgpOwogICAgZnVuY3Rpb24gTG9uZ0JpdHMyKGxvLCBoaSkgewogICAgICB0aGlzLmxvID0gbG8gPj4+IDA7CiAgICAgIHRoaXMuaGkgPSBoaSA+Pj4gMDsKICAgIH0KICAgIHZhciB6ZXJvID0gTG9uZ0JpdHMyLnplcm8gPSBuZXcgTG9uZ0JpdHMyKDAsIDApOwogICAgemVyby50b051bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gMDsKICAgIH07CiAgICB6ZXJvLnp6RW5jb2RlID0gemVyby56ekRlY29kZSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICB6ZXJvLmxlbmd0aCA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gMTsKICAgIH07CiAgICB2YXIgemVyb0hhc2ggPSBMb25nQml0czIuemVyb0hhc2ggPSAiXDBcMFwwXDBcMFwwXDBcMCI7CiAgICBMb25nQml0czIuZnJvbU51bWJlciA9IGZ1bmN0aW9uIGZyb21OdW1iZXIodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSAwKQogICAgICAgIHJldHVybiB6ZXJvOwogICAgICB2YXIgc2lnbiA9IHZhbHVlIDwgMDsKICAgICAgaWYgKHNpZ24pCiAgICAgICAgdmFsdWUgPSAtdmFsdWU7CiAgICAgIHZhciBsbyA9IHZhbHVlID4+PiAwLCBoaSA9ICh2YWx1ZSAtIGxvKSAvIDQyOTQ5NjcyOTYgPj4+IDA7CiAgICAgIGlmIChzaWduKSB7CiAgICAgICAgaGkgPSB+aGkgPj4+IDA7CiAgICAgICAgbG8gPSB+bG8gPj4+IDA7CiAgICAgICAgaWYgKCsrbG8gPiA0Mjk0OTY3Mjk1KSB7CiAgICAgICAgICBsbyA9IDA7CiAgICAgICAgICBpZiAoKytoaSA+IDQyOTQ5NjcyOTUpCiAgICAgICAgICAgIGhpID0gMDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBMb25nQml0czIobG8sIGhpKTsKICAgIH07CiAgICBMb25nQml0czIuZnJvbSA9IGZ1bmN0aW9uIGZyb20odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpCiAgICAgICAgcmV0dXJuIExvbmdCaXRzMi5mcm9tTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHV0aWwyLmlzU3RyaW5nKHZhbHVlKSkgewogICAgICAgIGlmICh1dGlsMi5Mb25nKQogICAgICAgICAgdmFsdWUgPSB1dGlsMi5Mb25nLmZyb21TdHJpbmcodmFsdWUpOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldHVybiBMb25nQml0czIuZnJvbU51bWJlcihwYXJzZUludCh2YWx1ZSwgMTApKTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUubG93IHx8IHZhbHVlLmhpZ2ggPyBuZXcgTG9uZ0JpdHMyKHZhbHVlLmxvdyA+Pj4gMCwgdmFsdWUuaGlnaCA+Pj4gMCkgOiB6ZXJvOwogICAgfTsKICAgIExvbmdCaXRzMi5wcm90b3R5cGUudG9OdW1iZXIgPSBmdW5jdGlvbiB0b051bWJlcih1bnNpZ25lZCkgewogICAgICBpZiAoIXVuc2lnbmVkICYmIHRoaXMuaGkgPj4+IDMxKSB7CiAgICAgICAgdmFyIGxvID0gfnRoaXMubG8gKyAxID4+PiAwLCBoaSA9IH50aGlzLmhpID4+PiAwOwogICAgICAgIGlmICghbG8pCiAgICAgICAgICBoaSA9IGhpICsgMSA+Pj4gMDsKICAgICAgICByZXR1cm4gLShsbyArIGhpICogNDI5NDk2NzI5Nik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMubG8gKyB0aGlzLmhpICogNDI5NDk2NzI5NjsKICAgIH07CiAgICBMb25nQml0czIucHJvdG90eXBlLnRvTG9uZyA9IGZ1bmN0aW9uIHRvTG9uZyh1bnNpZ25lZCkgewogICAgICByZXR1cm4gdXRpbDIuTG9uZyA/IG5ldyB1dGlsMi5Mb25nKHRoaXMubG8gfCAwLCB0aGlzLmhpIHwgMCwgQm9vbGVhbih1bnNpZ25lZCkpIDogeyBsb3c6IHRoaXMubG8gfCAwLCBoaWdoOiB0aGlzLmhpIHwgMCwgdW5zaWduZWQ6IEJvb2xlYW4odW5zaWduZWQpIH07CiAgICB9OwogICAgdmFyIGNoYXJDb2RlQXQgPSBTdHJpbmcucHJvdG90eXBlLmNoYXJDb2RlQXQ7CiAgICBMb25nQml0czIuZnJvbUhhc2ggPSBmdW5jdGlvbiBmcm9tSGFzaChoYXNoKSB7CiAgICAgIGlmIChoYXNoID09PSB6ZXJvSGFzaCkKICAgICAgICByZXR1cm4gemVybzsKICAgICAgcmV0dXJuIG5ldyBMb25nQml0czIoCiAgICAgICAgKGNoYXJDb2RlQXQuY2FsbChoYXNoLCAwKSB8IGNoYXJDb2RlQXQuY2FsbChoYXNoLCAxKSA8PCA4IHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDIpIDw8IDE2IHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDMpIDw8IDI0KSA+Pj4gMCwKICAgICAgICAoY2hhckNvZGVBdC5jYWxsKGhhc2gsIDQpIHwgY2hhckNvZGVBdC5jYWxsKGhhc2gsIDUpIDw8IDggfCBjaGFyQ29kZUF0LmNhbGwoaGFzaCwgNikgPDwgMTYgfCBjaGFyQ29kZUF0LmNhbGwoaGFzaCwgNykgPDwgMjQpID4+PiAwCiAgICAgICk7CiAgICB9OwogICAgTG9uZ0JpdHMyLnByb3RvdHlwZS50b0hhc2ggPSBmdW5jdGlvbiB0b0hhc2goKSB7CiAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKAogICAgICAgIHRoaXMubG8gJiAyNTUsCiAgICAgICAgdGhpcy5sbyA+Pj4gOCAmIDI1NSwKICAgICAgICB0aGlzLmxvID4+PiAxNiAmIDI1NSwKICAgICAgICB0aGlzLmxvID4+PiAyNCwKICAgICAgICB0aGlzLmhpICYgMjU1LAogICAgICAgIHRoaXMuaGkgPj4+IDggJiAyNTUsCiAgICAgICAgdGhpcy5oaSA+Pj4gMTYgJiAyNTUsCiAgICAgICAgdGhpcy5oaSA+Pj4gMjQKICAgICAgKTsKICAgIH07CiAgICBMb25nQml0czIucHJvdG90eXBlLnp6RW5jb2RlID0gZnVuY3Rpb24genpFbmNvZGUoKSB7CiAgICAgIHZhciBtYXNrID0gdGhpcy5oaSA+PiAzMTsKICAgICAgdGhpcy5oaSA9ICgodGhpcy5oaSA8PCAxIHwgdGhpcy5sbyA+Pj4gMzEpIF4gbWFzaykgPj4+IDA7CiAgICAgIHRoaXMubG8gPSAodGhpcy5sbyA8PCAxIF4gbWFzaykgPj4+IDA7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIExvbmdCaXRzMi5wcm90b3R5cGUuenpEZWNvZGUgPSBmdW5jdGlvbiB6ekRlY29kZSgpIHsKICAgICAgdmFyIG1hc2sgPSAtKHRoaXMubG8gJiAxKTsKICAgICAgdGhpcy5sbyA9ICgodGhpcy5sbyA+Pj4gMSB8IHRoaXMuaGkgPDwgMzEpIF4gbWFzaykgPj4+IDA7CiAgICAgIHRoaXMuaGkgPSAodGhpcy5oaSA+Pj4gMSBeIG1hc2spID4+PiAwOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBMb25nQml0czIucHJvdG90eXBlLmxlbmd0aCA9IGZ1bmN0aW9uIGxlbmd0aCgpIHsKICAgICAgdmFyIHBhcnQwID0gdGhpcy5sbywgcGFydDEgPSAodGhpcy5sbyA+Pj4gMjggfCB0aGlzLmhpIDw8IDQpID4+PiAwLCBwYXJ0MiA9IHRoaXMuaGkgPj4+IDI0OwogICAgICByZXR1cm4gcGFydDIgPT09IDAgPyBwYXJ0MSA9PT0gMCA/IHBhcnQwIDwgMTYzODQgPyBwYXJ0MCA8IDEyOCA/IDEgOiAyIDogcGFydDAgPCAyMDk3MTUyID8gMyA6IDQgOiBwYXJ0MSA8IDE2Mzg0ID8gcGFydDEgPCAxMjggPyA1IDogNiA6IHBhcnQxIDwgMjA5NzE1MiA/IDcgOiA4IDogcGFydDIgPCAxMjggPyA5IDogMTA7CiAgICB9OwogICAgcmV0dXJuIGxvbmdiaXRzOwogIH0KICB2YXIgaGFzUmVxdWlyZWRNaW5pbWFsOwogIGZ1bmN0aW9uIHJlcXVpcmVNaW5pbWFsKCkgewogICAgaWYgKGhhc1JlcXVpcmVkTWluaW1hbCkgcmV0dXJuIG1pbmltYWwkMTsKICAgIGhhc1JlcXVpcmVkTWluaW1hbCA9IDE7CiAgICAoZnVuY3Rpb24oZXhwb3J0cykgewogICAgICB2YXIgdXRpbDIgPSBleHBvcnRzOwogICAgICB1dGlsMi5hc1Byb21pc2UgPSBhc3Byb21pc2U7CiAgICAgIHV0aWwyLmJhc2U2NCA9IGJhc2U2NCQxOwogICAgICB1dGlsMi5FdmVudEVtaXR0ZXIgPSBldmVudGVtaXR0ZXI7CiAgICAgIHV0aWwyLmZsb2F0ID0gZmxvYXQ7CiAgICAgIHV0aWwyLmlucXVpcmUgPSBpbnF1aXJlXzE7CiAgICAgIHV0aWwyLnV0ZjggPSB1dGY4JDI7CiAgICAgIHV0aWwyLnBvb2wgPSBwb29sXzE7CiAgICAgIHV0aWwyLkxvbmdCaXRzID0gcmVxdWlyZUxvbmdiaXRzKCk7CiAgICAgIHV0aWwyLmlzTm9kZSA9IEJvb2xlYW4odHlwZW9mIGNvbW1vbmpzR2xvYmFsICE9PSAidW5kZWZpbmVkIiAmJiBjb21tb25qc0dsb2JhbCAmJiBjb21tb25qc0dsb2JhbC5wcm9jZXNzICYmIGNvbW1vbmpzR2xvYmFsLnByb2Nlc3MudmVyc2lvbnMgJiYgY29tbW9uanNHbG9iYWwucHJvY2Vzcy52ZXJzaW9ucy5ub2RlKTsKICAgICAgdXRpbDIuZ2xvYmFsID0gdXRpbDIuaXNOb2RlICYmIGNvbW1vbmpzR2xvYmFsIHx8IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdyB8fCB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgJiYgc2VsZiB8fCBjb21tb25qc0dsb2JhbDsKICAgICAgdXRpbDIuZW1wdHlBcnJheSA9IE9iamVjdC5mcmVlemUgPyBPYmplY3QuZnJlZXplKFtdKSA6ICgKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIFtdCiAgICAgICk7CiAgICAgIHV0aWwyLmVtcHR5T2JqZWN0ID0gT2JqZWN0LmZyZWV6ZSA/IE9iamVjdC5mcmVlemUoe30pIDogKAogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAge30KICAgICAgKTsKICAgICAgdXRpbDIuaXNJbnRlZ2VyID0gTnVtYmVyLmlzSW50ZWdlciB8fCAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICBmdW5jdGlvbiBpc0ludGVnZXIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc0Zpbml0ZSh2YWx1ZSkgJiYgTWF0aC5mbG9vcih2YWx1ZSkgPT09IHZhbHVlOwogICAgICB9OwogICAgICB1dGlsMi5pc1N0cmluZyA9IGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJpbmc7CiAgICAgIH07CiAgICAgIHV0aWwyLmlzT2JqZWN0ID0gZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IjsKICAgICAgfTsKICAgICAgdXRpbDIuaXNzZXQgPSAvKioKICAgICAgICogQ2hlY2tzIGlmIGEgcHJvcGVydHkgb24gYSBtZXNzYWdlIGlzIGNvbnNpZGVyZWQgdG8gYmUgcHJlc2VudC4KICAgICAgICogQHBhcmFtIHtPYmplY3R9IG9iaiBQbGFpbiBvYmplY3Qgb3IgbWVzc2FnZSBpbnN0YW5jZQogICAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcCBQcm9wZXJ0eSBuYW1lCiAgICAgICAqIEByZXR1cm5zIHtib29sZWFufSBgdHJ1ZWAgaWYgY29uc2lkZXJlZCB0byBiZSBwcmVzZW50LCBvdGhlcndpc2UgYGZhbHNlYAogICAgICAgKi8KICAgICAgdXRpbDIuaXNTZXQgPSBmdW5jdGlvbiBpc1NldChvYmosIHByb3ApIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmpbcHJvcF07CiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgb2JqLmhhc093blByb3BlcnR5KHByb3ApKQogICAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgKEFycmF5LmlzQXJyYXkodmFsdWUpID8gdmFsdWUubGVuZ3RoIDogT2JqZWN0LmtleXModmFsdWUpLmxlbmd0aCkgPiAwOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgICAgdXRpbDIuQnVmZmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciBCdWZmZXIgPSB1dGlsMi5pbnF1aXJlKCJidWZmZXIiKS5CdWZmZXI7CiAgICAgICAgICByZXR1cm4gQnVmZmVyLnByb3RvdHlwZS51dGY4V3JpdGUgPyBCdWZmZXIgOiAoCiAgICAgICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgICAgIG51bGwKICAgICAgICAgICk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICB9KCk7CiAgICAgIHV0aWwyLl9CdWZmZXJfZnJvbSA9IG51bGw7CiAgICAgIHV0aWwyLl9CdWZmZXJfYWxsb2NVbnNhZmUgPSBudWxsOwogICAgICB1dGlsMi5uZXdCdWZmZXIgPSBmdW5jdGlvbiBuZXdCdWZmZXIoc2l6ZU9yQXJyYXkpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHNpemVPckFycmF5ID09PSAibnVtYmVyIiA/IHV0aWwyLkJ1ZmZlciA/IHV0aWwyLl9CdWZmZXJfYWxsb2NVbnNhZmUoc2l6ZU9yQXJyYXkpIDogbmV3IHV0aWwyLkFycmF5KHNpemVPckFycmF5KSA6IHV0aWwyLkJ1ZmZlciA/IHV0aWwyLl9CdWZmZXJfZnJvbShzaXplT3JBcnJheSkgOiB0eXBlb2YgVWludDhBcnJheSA9PT0gInVuZGVmaW5lZCIgPyBzaXplT3JBcnJheSA6IG5ldyBVaW50OEFycmF5KHNpemVPckFycmF5KTsKICAgICAgfTsKICAgICAgdXRpbDIuQXJyYXkgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gInVuZGVmaW5lZCIgPyBVaW50OEFycmF5IDogQXJyYXk7CiAgICAgIHV0aWwyLkxvbmcgPSAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICB1dGlsMi5nbG9iYWwuZGNvZGVJTyAmJiAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICB1dGlsMi5nbG9iYWwuZGNvZGVJTy5Mb25nIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgIHV0aWwyLmdsb2JhbC5Mb25nIHx8IHV0aWwyLmlucXVpcmUoImxvbmciKTsKICAgICAgdXRpbDIua2V5MlJlID0gL150cnVlfGZhbHNlfDB8MSQvOwogICAgICB1dGlsMi5rZXkzMlJlID0gL14tPyg/OjB8WzEtOV1bMC05XSopJC87CiAgICAgIHV0aWwyLmtleTY0UmUgPSAvXig/OltcXHgwMC1cXHhmZl17OH18LT8oPzowfFsxLTldWzAtOV0qKSkkLzsKICAgICAgdXRpbDIubG9uZ1RvSGFzaCA9IGZ1bmN0aW9uIGxvbmdUb0hhc2godmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPyB1dGlsMi5Mb25nQml0cy5mcm9tKHZhbHVlKS50b0hhc2goKSA6IHV0aWwyLkxvbmdCaXRzLnplcm9IYXNoOwogICAgICB9OwogICAgICB1dGlsMi5sb25nRnJvbUhhc2ggPSBmdW5jdGlvbiBsb25nRnJvbUhhc2goaGFzaCwgdW5zaWduZWQpIHsKICAgICAgICB2YXIgYml0czIgPSB1dGlsMi5Mb25nQml0cy5mcm9tSGFzaChoYXNoKTsKICAgICAgICBpZiAodXRpbDIuTG9uZykKICAgICAgICAgIHJldHVybiB1dGlsMi5Mb25nLmZyb21CaXRzKGJpdHMyLmxvLCBiaXRzMi5oaSwgdW5zaWduZWQpOwogICAgICAgIHJldHVybiBiaXRzMi50b051bWJlcihCb29sZWFuKHVuc2lnbmVkKSk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIG1lcmdlKGRzdCwgc3JjLCBpZk5vdFNldCkgewogICAgICAgIGZvciAodmFyIGtleXMgPSBPYmplY3Qua2V5cyhzcmMpLCBpMiA9IDA7IGkyIDwga2V5cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICBpZiAoZHN0W2tleXNbaTJdXSA9PT0gdm9pZCAwIHx8ICFpZk5vdFNldCkKICAgICAgICAgICAgZHN0W2tleXNbaTJdXSA9IHNyY1trZXlzW2kyXV07CiAgICAgICAgcmV0dXJuIGRzdDsKICAgICAgfQogICAgICB1dGlsMi5tZXJnZSA9IG1lcmdlOwogICAgICB1dGlsMi5sY0ZpcnN0ID0gZnVuY3Rpb24gbGNGaXJzdChzdHIpIHsKICAgICAgICByZXR1cm4gc3RyLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpICsgc3RyLnN1YnN0cmluZygxKTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gbmV3RXJyb3IobmFtZSkgewogICAgICAgIGZ1bmN0aW9uIEN1c3RvbUVycm9yKG1lc3NhZ2UsIHByb3BlcnRpZXMpIHsKICAgICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBDdXN0b21FcnJvcikpCiAgICAgICAgICAgIHJldHVybiBuZXcgQ3VzdG9tRXJyb3IobWVzc2FnZSwgcHJvcGVydGllcyk7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgIm1lc3NhZ2UiLCB7IGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICAgICAgfSB9KTsKICAgICAgICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkKICAgICAgICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgQ3VzdG9tRXJyb3IpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgInN0YWNrIiwgeyB2YWx1ZTogbmV3IEVycm9yKCkuc3RhY2sgfHwgIiIgfSk7CiAgICAgICAgICBpZiAocHJvcGVydGllcykKICAgICAgICAgICAgbWVyZ2UodGhpcywgcHJvcGVydGllcyk7CiAgICAgICAgfQogICAgICAgIEN1c3RvbUVycm9yLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoRXJyb3IucHJvdG90eXBlLCB7CiAgICAgICAgICBjb25zdHJ1Y3RvcjogewogICAgICAgICAgICB2YWx1ZTogQ3VzdG9tRXJyb3IsCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9LAogICAgICAgICAgbmFtZTogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICByZXR1cm4gbmFtZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiB2b2lkIDAsCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAvLyBjb25maWd1cmFibGU6IGZhbHNlIHdvdWxkIGFjY3VyYXRlbHkgcHJlc2VydmUgdGhlIGJlaGF2aW9yIG9mCiAgICAgICAgICAgIC8vIHRoZSBvcmlnaW5hbCwgYnV0IEknbSBndWVzc2luZyB0aGF0IHdhcyBub3QgaW50ZW50aW9uYWwuCiAgICAgICAgICAgIC8vIEZvciBhbiBhY3R1YWwgZXJyb3Igc3ViY2xhc3MsIHRoaXMgcHJvcGVydHkgd291bGQKICAgICAgICAgICAgLy8gYmUgY29uZmlndXJhYmxlLgogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0sCiAgICAgICAgICB0b1N0cmluZzogewogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSArICI6ICIgKyB0aGlzLm1lc3NhZ2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIEN1c3RvbUVycm9yOwogICAgICB9CiAgICAgIHV0aWwyLm5ld0Vycm9yID0gbmV3RXJyb3I7CiAgICAgIHV0aWwyLlByb3RvY29sRXJyb3IgPSBuZXdFcnJvcigiUHJvdG9jb2xFcnJvciIpOwogICAgICB1dGlsMi5vbmVPZkdldHRlciA9IGZ1bmN0aW9uIGdldE9uZU9mKGZpZWxkTmFtZXMpIHsKICAgICAgICB2YXIgZmllbGRNYXAgPSB7fTsKICAgICAgICBmb3IgKHZhciBpMiA9IDA7IGkyIDwgZmllbGROYW1lcy5sZW5ndGg7ICsraTIpCiAgICAgICAgICBmaWVsZE1hcFtmaWVsZE5hbWVzW2kyXV0gPSAxOwogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgIGZvciAodmFyIGtleXMgPSBPYmplY3Qua2V5cyh0aGlzKSwgaTMgPSBrZXlzLmxlbmd0aCAtIDE7IGkzID4gLTE7IC0taTMpCiAgICAgICAgICAgIGlmIChmaWVsZE1hcFtrZXlzW2kzXV0gPT09IDEgJiYgdGhpc1trZXlzW2kzXV0gIT09IHZvaWQgMCAmJiB0aGlzW2tleXNbaTNdXSAhPT0gbnVsbCkKICAgICAgICAgICAgICByZXR1cm4ga2V5c1tpM107CiAgICAgICAgfTsKICAgICAgfTsKICAgICAgdXRpbDIub25lT2ZTZXR0ZXIgPSBmdW5jdGlvbiBzZXRPbmVPZihmaWVsZE5hbWVzKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBmaWVsZE5hbWVzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKGZpZWxkTmFtZXNbaTJdICE9PSBuYW1lKQogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW2ZpZWxkTmFtZXNbaTJdXTsKICAgICAgICB9OwogICAgICB9OwogICAgICB1dGlsMi50b0pTT05PcHRpb25zID0gewogICAgICAgIGxvbmdzOiBTdHJpbmcsCiAgICAgICAgZW51bXM6IFN0cmluZywKICAgICAgICBieXRlczogU3RyaW5nLAogICAgICAgIGpzb246IHRydWUKICAgICAgfTsKICAgICAgdXRpbDIuX2NvbmZpZ3VyZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBCdWZmZXIgPSB1dGlsMi5CdWZmZXI7CiAgICAgICAgaWYgKCFCdWZmZXIpIHsKICAgICAgICAgIHV0aWwyLl9CdWZmZXJfZnJvbSA9IHV0aWwyLl9CdWZmZXJfYWxsb2NVbnNhZmUgPSBudWxsOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB1dGlsMi5fQnVmZmVyX2Zyb20gPSBCdWZmZXIuZnJvbSAhPT0gVWludDhBcnJheS5mcm9tICYmIEJ1ZmZlci5mcm9tIHx8IC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgICAgICAgZnVuY3Rpb24gQnVmZmVyX2Zyb20odmFsdWUsIGVuY29kaW5nKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcih2YWx1ZSwgZW5jb2RpbmcpOwogICAgICAgIH07CiAgICAgICAgdXRpbDIuX0J1ZmZlcl9hbGxvY1Vuc2FmZSA9IEJ1ZmZlci5hbGxvY1Vuc2FmZSB8fCAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIGZ1bmN0aW9uIEJ1ZmZlcl9hbGxvY1Vuc2FmZShzaXplKSB7CiAgICAgICAgICByZXR1cm4gbmV3IEJ1ZmZlcihzaXplKTsKICAgICAgICB9OwogICAgICB9OwogICAgfSkobWluaW1hbCQxKTsKICAgIHJldHVybiBtaW5pbWFsJDE7CiAgfQogIHZhciB3cml0ZXIgPSBXcml0ZXIkMTsKICB2YXIgdXRpbCQ0ID0gcmVxdWlyZU1pbmltYWwoKTsKICB2YXIgQnVmZmVyV3JpdGVyJDE7CiAgdmFyIExvbmdCaXRzJDEgPSB1dGlsJDQuTG9uZ0JpdHMsIGJhc2U2NCA9IHV0aWwkNC5iYXNlNjQsIHV0ZjgkMSA9IHV0aWwkNC51dGY4OwogIGZ1bmN0aW9uIE9wKGZuLCBsZW4sIHZhbCkgewogICAgdGhpcy5mbiA9IGZuOwogICAgdGhpcy5sZW4gPSBsZW47CiAgICB0aGlzLm5leHQgPSB2b2lkIDA7CiAgICB0aGlzLnZhbCA9IHZhbDsKICB9CiAgZnVuY3Rpb24gbm9vcCgpIHsKICB9CiAgZnVuY3Rpb24gU3RhdGUod3JpdGVyMikgewogICAgdGhpcy5oZWFkID0gd3JpdGVyMi5oZWFkOwogICAgdGhpcy50YWlsID0gd3JpdGVyMi50YWlsOwogICAgdGhpcy5sZW4gPSB3cml0ZXIyLmxlbjsKICAgIHRoaXMubmV4dCA9IHdyaXRlcjIuc3RhdGVzOwogIH0KICBmdW5jdGlvbiBXcml0ZXIkMSgpIHsKICAgIHRoaXMubGVuID0gMDsKICAgIHRoaXMuaGVhZCA9IG5ldyBPcChub29wLCAwLCAwKTsKICAgIHRoaXMudGFpbCA9IHRoaXMuaGVhZDsKICAgIHRoaXMuc3RhdGVzID0gbnVsbDsKICB9CiAgdmFyIGNyZWF0ZSQxID0gZnVuY3Rpb24gY3JlYXRlMigpIHsKICAgIHJldHVybiB1dGlsJDQuQnVmZmVyID8gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcl9zZXR1cCgpIHsKICAgICAgcmV0dXJuIChXcml0ZXIkMS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGVfYnVmZmVyKCkgewogICAgICAgIHJldHVybiBuZXcgQnVmZmVyV3JpdGVyJDEoKTsKICAgICAgfSkoKTsKICAgIH0gOiBmdW5jdGlvbiBjcmVhdGVfYXJyYXkyKCkgewogICAgICByZXR1cm4gbmV3IFdyaXRlciQxKCk7CiAgICB9OwogIH07CiAgV3JpdGVyJDEuY3JlYXRlID0gY3JlYXRlJDEoKTsKICBXcml0ZXIkMS5hbGxvYyA9IGZ1bmN0aW9uIGFsbG9jKHNpemUpIHsKICAgIHJldHVybiBuZXcgdXRpbCQ0LkFycmF5KHNpemUpOwogIH07CiAgaWYgKHV0aWwkNC5BcnJheSAhPT0gQXJyYXkpCiAgICBXcml0ZXIkMS5hbGxvYyA9IHV0aWwkNC5wb29sKFdyaXRlciQxLmFsbG9jLCB1dGlsJDQuQXJyYXkucHJvdG90eXBlLnN1YmFycmF5KTsKICBXcml0ZXIkMS5wcm90b3R5cGUuX3B1c2ggPSBmdW5jdGlvbiBwdXNoKGZuLCBsZW4sIHZhbCkgewogICAgdGhpcy50YWlsID0gdGhpcy50YWlsLm5leHQgPSBuZXcgT3AoZm4sIGxlbiwgdmFsKTsKICAgIHRoaXMubGVuICs9IGxlbjsKICAgIHJldHVybiB0aGlzOwogIH07CiAgZnVuY3Rpb24gd3JpdGVCeXRlKHZhbCwgYnVmLCBwb3MpIHsKICAgIGJ1Zltwb3NdID0gdmFsICYgMjU1OwogIH0KICBmdW5jdGlvbiB3cml0ZVZhcmludDMyKHZhbCwgYnVmLCBwb3MpIHsKICAgIHdoaWxlICh2YWwgPiAxMjcpIHsKICAgICAgYnVmW3BvcysrXSA9IHZhbCAmIDEyNyB8IDEyODsKICAgICAgdmFsID4+Pj0gNzsKICAgIH0KICAgIGJ1Zltwb3NdID0gdmFsOwogIH0KICBmdW5jdGlvbiBWYXJpbnRPcChsZW4sIHZhbCkgewogICAgdGhpcy5sZW4gPSBsZW47CiAgICB0aGlzLm5leHQgPSB2b2lkIDA7CiAgICB0aGlzLnZhbCA9IHZhbDsKICB9CiAgVmFyaW50T3AucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShPcC5wcm90b3R5cGUpOwogIFZhcmludE9wLnByb3RvdHlwZS5mbiA9IHdyaXRlVmFyaW50MzI7CiAgV3JpdGVyJDEucHJvdG90eXBlLnVpbnQzMiA9IGZ1bmN0aW9uIHdyaXRlX3VpbnQzMih2YWx1ZSkgewogICAgdGhpcy5sZW4gKz0gKHRoaXMudGFpbCA9IHRoaXMudGFpbC5uZXh0ID0gbmV3IFZhcmludE9wKAogICAgICAodmFsdWUgPSB2YWx1ZSA+Pj4gMCkgPCAxMjggPyAxIDogdmFsdWUgPCAxNjM4NCA/IDIgOiB2YWx1ZSA8IDIwOTcxNTIgPyAzIDogdmFsdWUgPCAyNjg0MzU0NTYgPyA0IDogNSwKICAgICAgdmFsdWUKICAgICkpLmxlbjsKICAgIHJldHVybiB0aGlzOwogIH07CiAgV3JpdGVyJDEucHJvdG90eXBlLmludDMyID0gZnVuY3Rpb24gd3JpdGVfaW50MzIodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSA8IDAgPyB0aGlzLl9wdXNoKHdyaXRlVmFyaW50NjQsIDEwLCBMb25nQml0cyQxLmZyb21OdW1iZXIodmFsdWUpKSA6IHRoaXMudWludDMyKHZhbHVlKTsKICB9OwogIFdyaXRlciQxLnByb3RvdHlwZS5zaW50MzIgPSBmdW5jdGlvbiB3cml0ZV9zaW50MzIodmFsdWUpIHsKICAgIHJldHVybiB0aGlzLnVpbnQzMigodmFsdWUgPDwgMSBeIHZhbHVlID4+IDMxKSA+Pj4gMCk7CiAgfTsKICBmdW5jdGlvbiB3cml0ZVZhcmludDY0KHZhbCwgYnVmLCBwb3MpIHsKICAgIHdoaWxlICh2YWwuaGkpIHsKICAgICAgYnVmW3BvcysrXSA9IHZhbC5sbyAmIDEyNyB8IDEyODsKICAgICAgdmFsLmxvID0gKHZhbC5sbyA+Pj4gNyB8IHZhbC5oaSA8PCAyNSkgPj4+IDA7CiAgICAgIHZhbC5oaSA+Pj49IDc7CiAgICB9CiAgICB3aGlsZSAodmFsLmxvID4gMTI3KSB7CiAgICAgIGJ1Zltwb3MrK10gPSB2YWwubG8gJiAxMjcgfCAxMjg7CiAgICAgIHZhbC5sbyA9IHZhbC5sbyA+Pj4gNzsKICAgIH0KICAgIGJ1Zltwb3MrK10gPSB2YWwubG87CiAgfQogIFdyaXRlciQxLnByb3RvdHlwZS51aW50NjQgPSBmdW5jdGlvbiB3cml0ZV91aW50NjQodmFsdWUpIHsKICAgIHZhciBiaXRzMiA9IExvbmdCaXRzJDEuZnJvbSh2YWx1ZSk7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh3cml0ZVZhcmludDY0LCBiaXRzMi5sZW5ndGgoKSwgYml0czIpOwogIH07CiAgV3JpdGVyJDEucHJvdG90eXBlLmludDY0ID0gV3JpdGVyJDEucHJvdG90eXBlLnVpbnQ2NDsKICBXcml0ZXIkMS5wcm90b3R5cGUuc2ludDY0ID0gZnVuY3Rpb24gd3JpdGVfc2ludDY0KHZhbHVlKSB7CiAgICB2YXIgYml0czIgPSBMb25nQml0cyQxLmZyb20odmFsdWUpLnp6RW5jb2RlKCk7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh3cml0ZVZhcmludDY0LCBiaXRzMi5sZW5ndGgoKSwgYml0czIpOwogIH07CiAgV3JpdGVyJDEucHJvdG90eXBlLmJvb2wgPSBmdW5jdGlvbiB3cml0ZV9ib29sKHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh3cml0ZUJ5dGUsIDEsIHZhbHVlID8gMSA6IDApOwogIH07CiAgZnVuY3Rpb24gd3JpdGVGaXhlZDMyKHZhbCwgYnVmLCBwb3MpIHsKICAgIGJ1Zltwb3NdID0gdmFsICYgMjU1OwogICAgYnVmW3BvcyArIDFdID0gdmFsID4+PiA4ICYgMjU1OwogICAgYnVmW3BvcyArIDJdID0gdmFsID4+PiAxNiAmIDI1NTsKICAgIGJ1Zltwb3MgKyAzXSA9IHZhbCA+Pj4gMjQ7CiAgfQogIFdyaXRlciQxLnByb3RvdHlwZS5maXhlZDMyID0gZnVuY3Rpb24gd3JpdGVfZml4ZWQzMih2YWx1ZSkgewogICAgcmV0dXJuIHRoaXMuX3B1c2god3JpdGVGaXhlZDMyLCA0LCB2YWx1ZSA+Pj4gMCk7CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUuc2ZpeGVkMzIgPSBXcml0ZXIkMS5wcm90b3R5cGUuZml4ZWQzMjsKICBXcml0ZXIkMS5wcm90b3R5cGUuZml4ZWQ2NCA9IGZ1bmN0aW9uIHdyaXRlX2ZpeGVkNjQodmFsdWUpIHsKICAgIHZhciBiaXRzMiA9IExvbmdCaXRzJDEuZnJvbSh2YWx1ZSk7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh3cml0ZUZpeGVkMzIsIDQsIGJpdHMyLmxvKS5fcHVzaCh3cml0ZUZpeGVkMzIsIDQsIGJpdHMyLmhpKTsKICB9OwogIFdyaXRlciQxLnByb3RvdHlwZS5zZml4ZWQ2NCA9IFdyaXRlciQxLnByb3RvdHlwZS5maXhlZDY0OwogIFdyaXRlciQxLnByb3RvdHlwZS5mbG9hdCA9IGZ1bmN0aW9uIHdyaXRlX2Zsb2F0KHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh1dGlsJDQuZmxvYXQud3JpdGVGbG9hdExFLCA0LCB2YWx1ZSk7CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUuZG91YmxlID0gZnVuY3Rpb24gd3JpdGVfZG91YmxlKHZhbHVlKSB7CiAgICByZXR1cm4gdGhpcy5fcHVzaCh1dGlsJDQuZmxvYXQud3JpdGVEb3VibGVMRSwgOCwgdmFsdWUpOwogIH07CiAgdmFyIHdyaXRlQnl0ZXMgPSB1dGlsJDQuQXJyYXkucHJvdG90eXBlLnNldCA/IGZ1bmN0aW9uIHdyaXRlQnl0ZXNfc2V0KHZhbCwgYnVmLCBwb3MpIHsKICAgIGJ1Zi5zZXQodmFsLCBwb3MpOwogIH0gOiBmdW5jdGlvbiB3cml0ZUJ5dGVzX2Zvcih2YWwsIGJ1ZiwgcG9zKSB7CiAgICBmb3IgKHZhciBpMiA9IDA7IGkyIDwgdmFsLmxlbmd0aDsgKytpMikKICAgICAgYnVmW3BvcyArIGkyXSA9IHZhbFtpMl07CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUuYnl0ZXMgPSBmdW5jdGlvbiB3cml0ZV9ieXRlcyh2YWx1ZSkgewogICAgdmFyIGxlbiA9IHZhbHVlLmxlbmd0aCA+Pj4gMDsKICAgIGlmICghbGVuKQogICAgICByZXR1cm4gdGhpcy5fcHVzaCh3cml0ZUJ5dGUsIDEsIDApOwogICAgaWYgKHV0aWwkNC5pc1N0cmluZyh2YWx1ZSkpIHsKICAgICAgdmFyIGJ1ZiA9IFdyaXRlciQxLmFsbG9jKGxlbiA9IGJhc2U2NC5sZW5ndGgodmFsdWUpKTsKICAgICAgYmFzZTY0LmRlY29kZSh2YWx1ZSwgYnVmLCAwKTsKICAgICAgdmFsdWUgPSBidWY7CiAgICB9CiAgICByZXR1cm4gdGhpcy51aW50MzIobGVuKS5fcHVzaCh3cml0ZUJ5dGVzLCBsZW4sIHZhbHVlKTsKICB9OwogIFdyaXRlciQxLnByb3RvdHlwZS5zdHJpbmcgPSBmdW5jdGlvbiB3cml0ZV9zdHJpbmcodmFsdWUpIHsKICAgIHZhciBsZW4gPSB1dGY4JDEubGVuZ3RoKHZhbHVlKTsKICAgIHJldHVybiBsZW4gPyB0aGlzLnVpbnQzMihsZW4pLl9wdXNoKHV0ZjgkMS53cml0ZSwgbGVuLCB2YWx1ZSkgOiB0aGlzLl9wdXNoKHdyaXRlQnl0ZSwgMSwgMCk7CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUuZm9yayA9IGZ1bmN0aW9uIGZvcmsoKSB7CiAgICB0aGlzLnN0YXRlcyA9IG5ldyBTdGF0ZSh0aGlzKTsKICAgIHRoaXMuaGVhZCA9IHRoaXMudGFpbCA9IG5ldyBPcChub29wLCAwLCAwKTsKICAgIHRoaXMubGVuID0gMDsKICAgIHJldHVybiB0aGlzOwogIH07CiAgV3JpdGVyJDEucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24gcmVzZXQoKSB7CiAgICBpZiAodGhpcy5zdGF0ZXMpIHsKICAgICAgdGhpcy5oZWFkID0gdGhpcy5zdGF0ZXMuaGVhZDsKICAgICAgdGhpcy50YWlsID0gdGhpcy5zdGF0ZXMudGFpbDsKICAgICAgdGhpcy5sZW4gPSB0aGlzLnN0YXRlcy5sZW47CiAgICAgIHRoaXMuc3RhdGVzID0gdGhpcy5zdGF0ZXMubmV4dDsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuaGVhZCA9IHRoaXMudGFpbCA9IG5ldyBPcChub29wLCAwLCAwKTsKICAgICAgdGhpcy5sZW4gPSAwOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUubGRlbGltID0gZnVuY3Rpb24gbGRlbGltKCkgewogICAgdmFyIGhlYWQgPSB0aGlzLmhlYWQsIHRhaWwgPSB0aGlzLnRhaWwsIGxlbiA9IHRoaXMubGVuOwogICAgdGhpcy5yZXNldCgpLnVpbnQzMihsZW4pOwogICAgaWYgKGxlbikgewogICAgICB0aGlzLnRhaWwubmV4dCA9IGhlYWQubmV4dDsKICAgICAgdGhpcy50YWlsID0gdGFpbDsKICAgICAgdGhpcy5sZW4gKz0gbGVuOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBXcml0ZXIkMS5wcm90b3R5cGUuZmluaXNoID0gZnVuY3Rpb24gZmluaXNoKCkgewogICAgdmFyIGhlYWQgPSB0aGlzLmhlYWQubmV4dCwgYnVmID0gdGhpcy5jb25zdHJ1Y3Rvci5hbGxvYyh0aGlzLmxlbiksIHBvcyA9IDA7CiAgICB3aGlsZSAoaGVhZCkgewogICAgICBoZWFkLmZuKGhlYWQudmFsLCBidWYsIHBvcyk7CiAgICAgIHBvcyArPSBoZWFkLmxlbjsKICAgICAgaGVhZCA9IGhlYWQubmV4dDsKICAgIH0KICAgIHJldHVybiBidWY7CiAgfTsKICBXcml0ZXIkMS5fY29uZmlndXJlID0gZnVuY3Rpb24oQnVmZmVyV3JpdGVyXykgewogICAgQnVmZmVyV3JpdGVyJDEgPSBCdWZmZXJXcml0ZXJfOwogICAgV3JpdGVyJDEuY3JlYXRlID0gY3JlYXRlJDEoKTsKICAgIEJ1ZmZlcldyaXRlciQxLl9jb25maWd1cmUoKTsKICB9OwogIHZhciB3cml0ZXJfYnVmZmVyID0gQnVmZmVyV3JpdGVyOwogIHZhciBXcml0ZXIgPSB3cml0ZXI7CiAgKEJ1ZmZlcldyaXRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFdyaXRlci5wcm90b3R5cGUpKS5jb25zdHJ1Y3RvciA9IEJ1ZmZlcldyaXRlcjsKICB2YXIgdXRpbCQzID0gcmVxdWlyZU1pbmltYWwoKTsKICBmdW5jdGlvbiBCdWZmZXJXcml0ZXIoKSB7CiAgICBXcml0ZXIuY2FsbCh0aGlzKTsKICB9CiAgQnVmZmVyV3JpdGVyLl9jb25maWd1cmUgPSBmdW5jdGlvbigpIHsKICAgIEJ1ZmZlcldyaXRlci5hbGxvYyA9IHV0aWwkMy5fQnVmZmVyX2FsbG9jVW5zYWZlOwogICAgQnVmZmVyV3JpdGVyLndyaXRlQnl0ZXNCdWZmZXIgPSB1dGlsJDMuQnVmZmVyICYmIHV0aWwkMy5CdWZmZXIucHJvdG90eXBlIGluc3RhbmNlb2YgVWludDhBcnJheSAmJiB1dGlsJDMuQnVmZmVyLnByb3RvdHlwZS5zZXQubmFtZSA9PT0gInNldCIgPyBmdW5jdGlvbiB3cml0ZUJ5dGVzQnVmZmVyX3NldCh2YWwsIGJ1ZiwgcG9zKSB7CiAgICAgIGJ1Zi5zZXQodmFsLCBwb3MpOwogICAgfSA6IGZ1bmN0aW9uIHdyaXRlQnl0ZXNCdWZmZXJfY29weSh2YWwsIGJ1ZiwgcG9zKSB7CiAgICAgIGlmICh2YWwuY29weSkKICAgICAgICB2YWwuY29weShidWYsIHBvcywgMCwgdmFsLmxlbmd0aCk7CiAgICAgIGVsc2UgZm9yICh2YXIgaTIgPSAwOyBpMiA8IHZhbC5sZW5ndGg7ICkKICAgICAgICBidWZbcG9zKytdID0gdmFsW2kyKytdOwogICAgfTsKICB9OwogIEJ1ZmZlcldyaXRlci5wcm90b3R5cGUuYnl0ZXMgPSBmdW5jdGlvbiB3cml0ZV9ieXRlc19idWZmZXIodmFsdWUpIHsKICAgIGlmICh1dGlsJDMuaXNTdHJpbmcodmFsdWUpKQogICAgICB2YWx1ZSA9IHV0aWwkMy5fQnVmZmVyX2Zyb20odmFsdWUsICJiYXNlNjQiKTsKICAgIHZhciBsZW4gPSB2YWx1ZS5sZW5ndGggPj4+IDA7CiAgICB0aGlzLnVpbnQzMihsZW4pOwogICAgaWYgKGxlbikKICAgICAgdGhpcy5fcHVzaChCdWZmZXJXcml0ZXIud3JpdGVCeXRlc0J1ZmZlciwgbGVuLCB2YWx1ZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIGZ1bmN0aW9uIHdyaXRlU3RyaW5nQnVmZmVyKHZhbCwgYnVmLCBwb3MpIHsKICAgIGlmICh2YWwubGVuZ3RoIDwgNDApCiAgICAgIHV0aWwkMy51dGY4LndyaXRlKHZhbCwgYnVmLCBwb3MpOwogICAgZWxzZSBpZiAoYnVmLnV0ZjhXcml0ZSkKICAgICAgYnVmLnV0ZjhXcml0ZSh2YWwsIHBvcyk7CiAgICBlbHNlCiAgICAgIGJ1Zi53cml0ZSh2YWwsIHBvcyk7CiAgfQogIEJ1ZmZlcldyaXRlci5wcm90b3R5cGUuc3RyaW5nID0gZnVuY3Rpb24gd3JpdGVfc3RyaW5nX2J1ZmZlcih2YWx1ZSkgewogICAgdmFyIGxlbiA9IHV0aWwkMy5CdWZmZXIuYnl0ZUxlbmd0aCh2YWx1ZSk7CiAgICB0aGlzLnVpbnQzMihsZW4pOwogICAgaWYgKGxlbikKICAgICAgdGhpcy5fcHVzaCh3cml0ZVN0cmluZ0J1ZmZlciwgbGVuLCB2YWx1ZSk7CiAgICByZXR1cm4gdGhpczsKICB9OwogIEJ1ZmZlcldyaXRlci5fY29uZmlndXJlKCk7CiAgdmFyIHJlYWRlciA9IFJlYWRlciQxOwogIHZhciB1dGlsJDIgPSByZXF1aXJlTWluaW1hbCgpOwogIHZhciBCdWZmZXJSZWFkZXIkMTsKICB2YXIgTG9uZ0JpdHMgPSB1dGlsJDIuTG9uZ0JpdHMsIHV0ZjggPSB1dGlsJDIudXRmODsKICBmdW5jdGlvbiBpbmRleE91dE9mUmFuZ2UocmVhZGVyMiwgd3JpdGVMZW5ndGgpIHsKICAgIHJldHVybiBSYW5nZUVycm9yKCJpbmRleCBvdXQgb2YgcmFuZ2U6ICIgKyByZWFkZXIyLnBvcyArICIgKyAiICsgKHdyaXRlTGVuZ3RoIHx8IDEpICsgIiA+ICIgKyByZWFkZXIyLmxlbik7CiAgfQogIGZ1bmN0aW9uIFJlYWRlciQxKGJ1ZmZlcikgewogICAgdGhpcy5idWYgPSBidWZmZXI7CiAgICB0aGlzLnBvcyA9IDA7CiAgICB0aGlzLmxlbiA9IGJ1ZmZlci5sZW5ndGg7CiAgfQogIHZhciBjcmVhdGVfYXJyYXkgPSB0eXBlb2YgVWludDhBcnJheSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbiBjcmVhdGVfdHlwZWRfYXJyYXkoYnVmZmVyKSB7CiAgICBpZiAoYnVmZmVyIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCBBcnJheS5pc0FycmF5KGJ1ZmZlcikpCiAgICAgIHJldHVybiBuZXcgUmVhZGVyJDEoYnVmZmVyKTsKICAgIHRocm93IEVycm9yKCJpbGxlZ2FsIGJ1ZmZlciIpOwogIH0gOiBmdW5jdGlvbiBjcmVhdGVfYXJyYXkyKGJ1ZmZlcikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoYnVmZmVyKSkKICAgICAgcmV0dXJuIG5ldyBSZWFkZXIkMShidWZmZXIpOwogICAgdGhyb3cgRXJyb3IoImlsbGVnYWwgYnVmZmVyIik7CiAgfTsKICB2YXIgY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlMigpIHsKICAgIHJldHVybiB1dGlsJDIuQnVmZmVyID8gZnVuY3Rpb24gY3JlYXRlX2J1ZmZlcl9zZXR1cChidWZmZXIpIHsKICAgICAgcmV0dXJuIChSZWFkZXIkMS5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGVfYnVmZmVyKGJ1ZmZlcjIpIHsKICAgICAgICByZXR1cm4gdXRpbCQyLkJ1ZmZlci5pc0J1ZmZlcihidWZmZXIyKSA/IG5ldyBCdWZmZXJSZWFkZXIkMShidWZmZXIyKSA6IGNyZWF0ZV9hcnJheShidWZmZXIyKTsKICAgICAgfSkoYnVmZmVyKTsKICAgIH0gOiBjcmVhdGVfYXJyYXk7CiAgfTsKICBSZWFkZXIkMS5jcmVhdGUgPSBjcmVhdGUoKTsKICBSZWFkZXIkMS5wcm90b3R5cGUuX3NsaWNlID0gdXRpbCQyLkFycmF5LnByb3RvdHlwZS5zdWJhcnJheSB8fCAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIHV0aWwkMi5BcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgUmVhZGVyJDEucHJvdG90eXBlLnVpbnQzMiA9IC8qIEBfX1BVUkVfXyAqLyBmdW5jdGlvbiByZWFkX3VpbnQzMl9zZXR1cCgpIHsKICAgIHZhciB2YWx1ZSA9IDQyOTQ5NjcyOTU7CiAgICByZXR1cm4gZnVuY3Rpb24gcmVhZF91aW50MzIoKSB7CiAgICAgIHZhbHVlID0gKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPj4+IDA7CiAgICAgIGlmICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA8IDEyOCkgcmV0dXJuIHZhbHVlOwogICAgICB2YWx1ZSA9ICh2YWx1ZSB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpIDw8IDcpID4+PiAwOwogICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpIHJldHVybiB2YWx1ZTsKICAgICAgdmFsdWUgPSAodmFsdWUgfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCAxNCkgPj4+IDA7CiAgICAgIGlmICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA8IDEyOCkgcmV0dXJuIHZhbHVlOwogICAgICB2YWx1ZSA9ICh2YWx1ZSB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpIDw8IDIxKSA+Pj4gMDsKICAgICAgaWYgKHRoaXMuYnVmW3RoaXMucG9zKytdIDwgMTI4KSByZXR1cm4gdmFsdWU7CiAgICAgIHZhbHVlID0gKHZhbHVlIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDE1KSA8PCAyOCkgPj4+IDA7CiAgICAgIGlmICh0aGlzLmJ1Zlt0aGlzLnBvcysrXSA8IDEyOCkgcmV0dXJuIHZhbHVlOwogICAgICBpZiAoKHRoaXMucG9zICs9IDUpID4gdGhpcy5sZW4pIHsKICAgICAgICB0aGlzLnBvcyA9IHRoaXMubGVuOwogICAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCAxMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9KCk7CiAgUmVhZGVyJDEucHJvdG90eXBlLmludDMyID0gZnVuY3Rpb24gcmVhZF9pbnQzMigpIHsKICAgIHJldHVybiB0aGlzLnVpbnQzMigpIHwgMDsKICB9OwogIFJlYWRlciQxLnByb3RvdHlwZS5zaW50MzIgPSBmdW5jdGlvbiByZWFkX3NpbnQzMigpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMudWludDMyKCk7CiAgICByZXR1cm4gdmFsdWUgPj4+IDEgXiAtKHZhbHVlICYgMSkgfCAwOwogIH07CiAgZnVuY3Rpb24gcmVhZExvbmdWYXJpbnQoKSB7CiAgICB2YXIgYml0czIgPSBuZXcgTG9uZ0JpdHMoMCwgMCk7CiAgICB2YXIgaTIgPSAwOwogICAgaWYgKHRoaXMubGVuIC0gdGhpcy5wb3MgPiA0KSB7CiAgICAgIGZvciAoOyBpMiA8IDQ7ICsraTIpIHsKICAgICAgICBiaXRzMi5sbyA9IChiaXRzMi5sbyB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpIDw8IGkyICogNykgPj4+IDA7CiAgICAgICAgaWYgKHRoaXMuYnVmW3RoaXMucG9zKytdIDwgMTI4KQogICAgICAgICAgcmV0dXJuIGJpdHMyOwogICAgICB9CiAgICAgIGJpdHMyLmxvID0gKGJpdHMyLmxvIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPDwgMjgpID4+PiAwOwogICAgICBiaXRzMi5oaSA9IChiaXRzMi5oaSB8ICh0aGlzLmJ1Zlt0aGlzLnBvc10gJiAxMjcpID4+IDQpID4+PiAwOwogICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCiAgICAgICAgcmV0dXJuIGJpdHMyOwogICAgICBpMiA9IDA7CiAgICB9IGVsc2UgewogICAgICBmb3IgKDsgaTIgPCAzOyArK2kyKSB7CiAgICAgICAgaWYgKHRoaXMucG9zID49IHRoaXMubGVuKQogICAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMpOwogICAgICAgIGJpdHMyLmxvID0gKGJpdHMyLmxvIHwgKHRoaXMuYnVmW3RoaXMucG9zXSAmIDEyNykgPDwgaTIgKiA3KSA+Pj4gMDsKICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCiAgICAgICAgICByZXR1cm4gYml0czI7CiAgICAgIH0KICAgICAgYml0czIubG8gPSAoYml0czIubG8gfCAodGhpcy5idWZbdGhpcy5wb3MrK10gJiAxMjcpIDw8IGkyICogNykgPj4+IDA7CiAgICAgIHJldHVybiBiaXRzMjsKICAgIH0KICAgIGlmICh0aGlzLmxlbiAtIHRoaXMucG9zID4gNCkgewogICAgICBmb3IgKDsgaTIgPCA1OyArK2kyKSB7CiAgICAgICAgYml0czIuaGkgPSAoYml0czIuaGkgfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCBpMiAqIDcgKyAzKSA+Pj4gMDsKICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCiAgICAgICAgICByZXR1cm4gYml0czI7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZvciAoOyBpMiA8IDU7ICsraTIpIHsKICAgICAgICBpZiAodGhpcy5wb3MgPj0gdGhpcy5sZW4pCiAgICAgICAgICB0aHJvdyBpbmRleE91dE9mUmFuZ2UodGhpcyk7CiAgICAgICAgYml0czIuaGkgPSAoYml0czIuaGkgfCAodGhpcy5idWZbdGhpcy5wb3NdICYgMTI3KSA8PCBpMiAqIDcgKyAzKSA+Pj4gMDsKICAgICAgICBpZiAodGhpcy5idWZbdGhpcy5wb3MrK10gPCAxMjgpCiAgICAgICAgICByZXR1cm4gYml0czI7CiAgICAgIH0KICAgIH0KICAgIHRocm93IEVycm9yKCJpbnZhbGlkIHZhcmludCBlbmNvZGluZyIpOwogIH0KICBSZWFkZXIkMS5wcm90b3R5cGUuYm9vbCA9IGZ1bmN0aW9uIHJlYWRfYm9vbCgpIHsKICAgIHJldHVybiB0aGlzLnVpbnQzMigpICE9PSAwOwogIH07CiAgZnVuY3Rpb24gcmVhZEZpeGVkMzJfZW5kKGJ1ZiwgZW5kKSB7CiAgICByZXR1cm4gKGJ1ZltlbmQgLSA0XSB8IGJ1ZltlbmQgLSAzXSA8PCA4IHwgYnVmW2VuZCAtIDJdIDw8IDE2IHwgYnVmW2VuZCAtIDFdIDw8IDI0KSA+Pj4gMDsKICB9CiAgUmVhZGVyJDEucHJvdG90eXBlLmZpeGVkMzIgPSBmdW5jdGlvbiByZWFkX2ZpeGVkMzIoKSB7CiAgICBpZiAodGhpcy5wb3MgKyA0ID4gdGhpcy5sZW4pCiAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCA0KTsKICAgIHJldHVybiByZWFkRml4ZWQzMl9lbmQodGhpcy5idWYsIHRoaXMucG9zICs9IDQpOwogIH07CiAgUmVhZGVyJDEucHJvdG90eXBlLnNmaXhlZDMyID0gZnVuY3Rpb24gcmVhZF9zZml4ZWQzMigpIHsKICAgIGlmICh0aGlzLnBvcyArIDQgPiB0aGlzLmxlbikKICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIDQpOwogICAgcmV0dXJuIHJlYWRGaXhlZDMyX2VuZCh0aGlzLmJ1ZiwgdGhpcy5wb3MgKz0gNCkgfCAwOwogIH07CiAgZnVuY3Rpb24gcmVhZEZpeGVkNjQoKSB7CiAgICBpZiAodGhpcy5wb3MgKyA4ID4gdGhpcy5sZW4pCiAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCA4KTsKICAgIHJldHVybiBuZXcgTG9uZ0JpdHMocmVhZEZpeGVkMzJfZW5kKHRoaXMuYnVmLCB0aGlzLnBvcyArPSA0KSwgcmVhZEZpeGVkMzJfZW5kKHRoaXMuYnVmLCB0aGlzLnBvcyArPSA0KSk7CiAgfQogIFJlYWRlciQxLnByb3RvdHlwZS5mbG9hdCA9IGZ1bmN0aW9uIHJlYWRfZmxvYXQoKSB7CiAgICBpZiAodGhpcy5wb3MgKyA0ID4gdGhpcy5sZW4pCiAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCA0KTsKICAgIHZhciB2YWx1ZSA9IHV0aWwkMi5mbG9hdC5yZWFkRmxvYXRMRSh0aGlzLmJ1ZiwgdGhpcy5wb3MpOwogICAgdGhpcy5wb3MgKz0gNDsKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIFJlYWRlciQxLnByb3RvdHlwZS5kb3VibGUgPSBmdW5jdGlvbiByZWFkX2RvdWJsZSgpIHsKICAgIGlmICh0aGlzLnBvcyArIDggPiB0aGlzLmxlbikKICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIDQpOwogICAgdmFyIHZhbHVlID0gdXRpbCQyLmZsb2F0LnJlYWREb3VibGVMRSh0aGlzLmJ1ZiwgdGhpcy5wb3MpOwogICAgdGhpcy5wb3MgKz0gODsKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIFJlYWRlciQxLnByb3RvdHlwZS5ieXRlcyA9IGZ1bmN0aW9uIHJlYWRfYnl0ZXMoKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy51aW50MzIoKSwgc3RhcnQgPSB0aGlzLnBvcywgZW5kID0gdGhpcy5wb3MgKyBsZW5ndGg7CiAgICBpZiAoZW5kID4gdGhpcy5sZW4pCiAgICAgIHRocm93IGluZGV4T3V0T2ZSYW5nZSh0aGlzLCBsZW5ndGgpOwogICAgdGhpcy5wb3MgKz0gbGVuZ3RoOwogICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5idWYpKQogICAgICByZXR1cm4gdGhpcy5idWYuc2xpY2Uoc3RhcnQsIGVuZCk7CiAgICBpZiAoc3RhcnQgPT09IGVuZCkgewogICAgICB2YXIgbmF0aXZlQnVmZmVyID0gdXRpbCQyLkJ1ZmZlcjsKICAgICAgcmV0dXJuIG5hdGl2ZUJ1ZmZlciA/IG5hdGl2ZUJ1ZmZlci5hbGxvYygwKSA6IG5ldyB0aGlzLmJ1Zi5jb25zdHJ1Y3RvcigwKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9zbGljZS5jYWxsKHRoaXMuYnVmLCBzdGFydCwgZW5kKTsKICB9OwogIFJlYWRlciQxLnByb3RvdHlwZS5zdHJpbmcgPSBmdW5jdGlvbiByZWFkX3N0cmluZygpIHsKICAgIHZhciBieXRlcyA9IHRoaXMuYnl0ZXMoKTsKICAgIHJldHVybiB1dGY4LnJlYWQoYnl0ZXMsIDAsIGJ5dGVzLmxlbmd0aCk7CiAgfTsKICBSZWFkZXIkMS5wcm90b3R5cGUuc2tpcCA9IGZ1bmN0aW9uIHNraXAobGVuZ3RoKSB7CiAgICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gIm51bWJlciIpIHsKICAgICAgaWYgKHRoaXMucG9zICsgbGVuZ3RoID4gdGhpcy5sZW4pCiAgICAgICAgdGhyb3cgaW5kZXhPdXRPZlJhbmdlKHRoaXMsIGxlbmd0aCk7CiAgICAgIHRoaXMucG9zICs9IGxlbmd0aDsKICAgIH0gZWxzZSB7CiAgICAgIGRvIHsKICAgICAgICBpZiAodGhpcy5wb3MgPj0gdGhpcy5sZW4pCiAgICAgICAgICB0aHJvdyBpbmRleE91dE9mUmFuZ2UodGhpcyk7CiAgICAgIH0gd2hpbGUgKHRoaXMuYnVmW3RoaXMucG9zKytdICYgMTI4KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH07CiAgUmVhZGVyJDEucHJvdG90eXBlLnNraXBUeXBlID0gZnVuY3Rpb24od2lyZVR5cGUpIHsKICAgIHN3aXRjaCAod2lyZVR5cGUpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuc2tpcCgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5za2lwKDgpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5za2lwKHRoaXMudWludDMyKCkpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgd2hpbGUgKCh3aXJlVHlwZSA9IHRoaXMudWludDMyKCkgJiA3KSAhPT0gNCkgewogICAgICAgICAgdGhpcy5za2lwVHlwZSh3aXJlVHlwZSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDU6CiAgICAgICAgdGhpcy5za2lwKDQpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IEVycm9yKCJpbnZhbGlkIHdpcmUgdHlwZSAiICsgd2lyZVR5cGUgKyAiIGF0IG9mZnNldCAiICsgdGhpcy5wb3MpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfTsKICBSZWFkZXIkMS5fY29uZmlndXJlID0gZnVuY3Rpb24oQnVmZmVyUmVhZGVyXykgewogICAgQnVmZmVyUmVhZGVyJDEgPSBCdWZmZXJSZWFkZXJfOwogICAgUmVhZGVyJDEuY3JlYXRlID0gY3JlYXRlKCk7CiAgICBCdWZmZXJSZWFkZXIkMS5fY29uZmlndXJlKCk7CiAgICB2YXIgZm4gPSB1dGlsJDIuTG9uZyA/ICJ0b0xvbmciIDogKAogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAidG9OdW1iZXIiCiAgICApOwogICAgdXRpbCQyLm1lcmdlKFJlYWRlciQxLnByb3RvdHlwZSwgewogICAgICBpbnQ2NDogZnVuY3Rpb24gcmVhZF9pbnQ2NCgpIHsKICAgICAgICByZXR1cm4gcmVhZExvbmdWYXJpbnQuY2FsbCh0aGlzKVtmbl0oZmFsc2UpOwogICAgICB9LAogICAgICB1aW50NjQ6IGZ1bmN0aW9uIHJlYWRfdWludDY0KCkgewogICAgICAgIHJldHVybiByZWFkTG9uZ1ZhcmludC5jYWxsKHRoaXMpW2ZuXSh0cnVlKTsKICAgICAgfSwKICAgICAgc2ludDY0OiBmdW5jdGlvbiByZWFkX3NpbnQ2NCgpIHsKICAgICAgICByZXR1cm4gcmVhZExvbmdWYXJpbnQuY2FsbCh0aGlzKS56ekRlY29kZSgpW2ZuXShmYWxzZSk7CiAgICAgIH0sCiAgICAgIGZpeGVkNjQ6IGZ1bmN0aW9uIHJlYWRfZml4ZWQ2NCgpIHsKICAgICAgICByZXR1cm4gcmVhZEZpeGVkNjQuY2FsbCh0aGlzKVtmbl0odHJ1ZSk7CiAgICAgIH0sCiAgICAgIHNmaXhlZDY0OiBmdW5jdGlvbiByZWFkX3NmaXhlZDY0KCkgewogICAgICAgIHJldHVybiByZWFkRml4ZWQ2NC5jYWxsKHRoaXMpW2ZuXShmYWxzZSk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgdmFyIHJlYWRlcl9idWZmZXIgPSBCdWZmZXJSZWFkZXI7CiAgdmFyIFJlYWRlciA9IHJlYWRlcjsKICAoQnVmZmVyUmVhZGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUmVhZGVyLnByb3RvdHlwZSkpLmNvbnN0cnVjdG9yID0gQnVmZmVyUmVhZGVyOwogIHZhciB1dGlsJDEgPSByZXF1aXJlTWluaW1hbCgpOwogIGZ1bmN0aW9uIEJ1ZmZlclJlYWRlcihidWZmZXIpIHsKICAgIFJlYWRlci5jYWxsKHRoaXMsIGJ1ZmZlcik7CiAgfQogIEJ1ZmZlclJlYWRlci5fY29uZmlndXJlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAodXRpbCQxLkJ1ZmZlcikKICAgICAgQnVmZmVyUmVhZGVyLnByb3RvdHlwZS5fc2xpY2UgPSB1dGlsJDEuQnVmZmVyLnByb3RvdHlwZS5zbGljZTsKICB9OwogIEJ1ZmZlclJlYWRlci5wcm90b3R5cGUuc3RyaW5nID0gZnVuY3Rpb24gcmVhZF9zdHJpbmdfYnVmZmVyKCkgewogICAgdmFyIGxlbiA9IHRoaXMudWludDMyKCk7CiAgICByZXR1cm4gdGhpcy5idWYudXRmOFNsaWNlID8gdGhpcy5idWYudXRmOFNsaWNlKHRoaXMucG9zLCB0aGlzLnBvcyA9IE1hdGgubWluKHRoaXMucG9zICsgbGVuLCB0aGlzLmxlbikpIDogdGhpcy5idWYudG9TdHJpbmcoInV0Zi04IiwgdGhpcy5wb3MsIHRoaXMucG9zID0gTWF0aC5taW4odGhpcy5wb3MgKyBsZW4sIHRoaXMubGVuKSk7CiAgfTsKICBCdWZmZXJSZWFkZXIuX2NvbmZpZ3VyZSgpOwogIHZhciBycGMgPSB7fTsKICB2YXIgc2VydmljZSA9IFNlcnZpY2U7CiAgdmFyIHV0aWwgPSByZXF1aXJlTWluaW1hbCgpOwogIChTZXJ2aWNlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUodXRpbC5FdmVudEVtaXR0ZXIucHJvdG90eXBlKSkuY29uc3RydWN0b3IgPSBTZXJ2aWNlOwogIGZ1bmN0aW9uIFNlcnZpY2UocnBjSW1wbCwgcmVxdWVzdERlbGltaXRlZCwgcmVzcG9uc2VEZWxpbWl0ZWQpIHsKICAgIGlmICh0eXBlb2YgcnBjSW1wbCAhPT0gImZ1bmN0aW9uIikKICAgICAgdGhyb3cgVHlwZUVycm9yKCJycGNJbXBsIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgdXRpbC5FdmVudEVtaXR0ZXIuY2FsbCh0aGlzKTsKICAgIHRoaXMucnBjSW1wbCA9IHJwY0ltcGw7CiAgICB0aGlzLnJlcXVlc3REZWxpbWl0ZWQgPSBCb29sZWFuKHJlcXVlc3REZWxpbWl0ZWQpOwogICAgdGhpcy5yZXNwb25zZURlbGltaXRlZCA9IEJvb2xlYW4ocmVzcG9uc2VEZWxpbWl0ZWQpOwogIH0KICBTZXJ2aWNlLnByb3RvdHlwZS5ycGNDYWxsID0gZnVuY3Rpb24gcnBjQ2FsbChtZXRob2QsIHJlcXVlc3RDdG9yLCByZXNwb25zZUN0b3IsIHJlcXVlc3QsIGNhbGxiYWNrKSB7CiAgICBpZiAoIXJlcXVlc3QpCiAgICAgIHRocm93IFR5cGVFcnJvcigicmVxdWVzdCBtdXN0IGJlIHNwZWNpZmllZCIpOwogICAgdmFyIHNlbGYyID0gdGhpczsKICAgIGlmICghY2FsbGJhY2spCiAgICAgIHJldHVybiB1dGlsLmFzUHJvbWlzZShycGNDYWxsLCBzZWxmMiwgbWV0aG9kLCByZXF1ZXN0Q3RvciwgcmVzcG9uc2VDdG9yLCByZXF1ZXN0KTsKICAgIGlmICghc2VsZjIucnBjSW1wbCkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGNhbGxiYWNrKEVycm9yKCJhbHJlYWR5IGVuZGVkIikpOwogICAgICB9LCAwKTsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHRyeSB7CiAgICAgIHJldHVybiBzZWxmMi5ycGNJbXBsKAogICAgICAgIG1ldGhvZCwKICAgICAgICByZXF1ZXN0Q3RvcltzZWxmMi5yZXF1ZXN0RGVsaW1pdGVkID8gImVuY29kZURlbGltaXRlZCIgOiAiZW5jb2RlIl0ocmVxdWVzdCkuZmluaXNoKCksCiAgICAgICAgZnVuY3Rpb24gcnBjQ2FsbGJhY2soZXJyMiwgcmVzcG9uc2UpIHsKICAgICAgICAgIGlmIChlcnIyKSB7CiAgICAgICAgICAgIHNlbGYyLmVtaXQoImVycm9yIiwgZXJyMiwgbWV0aG9kKTsKICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycjIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJlc3BvbnNlID09PSBudWxsKSB7CiAgICAgICAgICAgIHNlbGYyLmVuZCgKICAgICAgICAgICAgICAvKiBlbmRlZEJ5UlBDICovCiAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICApOwogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEocmVzcG9uc2UgaW5zdGFuY2VvZiByZXNwb25zZUN0b3IpKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXNwb25zZUN0b3Jbc2VsZjIucmVzcG9uc2VEZWxpbWl0ZWQgPyAiZGVjb2RlRGVsaW1pdGVkIiA6ICJkZWNvZGUiXShyZXNwb25zZSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycjMpIHsKICAgICAgICAgICAgICBzZWxmMi5lbWl0KCJlcnJvciIsIGVycjMsIG1ldGhvZCk7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGVycjMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzZWxmMi5lbWl0KCJkYXRhIiwgcmVzcG9uc2UsIG1ldGhvZCk7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgKTsKICAgIH0gY2F0Y2ggKGVycjIpIHsKICAgICAgc2VsZjIuZW1pdCgiZXJyb3IiLCBlcnIyLCBtZXRob2QpOwogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGNhbGxiYWNrKGVycjIpOwogICAgICB9LCAwKTsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9OwogIFNlcnZpY2UucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uIGVuZChlbmRlZEJ5UlBDKSB7CiAgICBpZiAodGhpcy5ycGNJbXBsKSB7CiAgICAgIGlmICghZW5kZWRCeVJQQykKICAgICAgICB0aGlzLnJwY0ltcGwobnVsbCwgbnVsbCwgbnVsbCk7CiAgICAgIHRoaXMucnBjSW1wbCA9IG51bGw7CiAgICAgIHRoaXMuZW1pdCgiZW5kIikub2ZmKCk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIChmdW5jdGlvbihleHBvcnRzKSB7CiAgICB2YXIgcnBjMiA9IGV4cG9ydHM7CiAgICBycGMyLlNlcnZpY2UgPSBzZXJ2aWNlOwogIH0pKHJwYyk7CiAgdmFyIHJvb3RzID0ge307CiAgKGZ1bmN0aW9uKGV4cG9ydHMpIHsKICAgIHZhciBwcm90b2J1ZiA9IGV4cG9ydHM7CiAgICBwcm90b2J1Zi5idWlsZCA9ICJtaW5pbWFsIjsKICAgIHByb3RvYnVmLldyaXRlciA9IHdyaXRlcjsKICAgIHByb3RvYnVmLkJ1ZmZlcldyaXRlciA9IHdyaXRlcl9idWZmZXI7CiAgICBwcm90b2J1Zi5SZWFkZXIgPSByZWFkZXI7CiAgICBwcm90b2J1Zi5CdWZmZXJSZWFkZXIgPSByZWFkZXJfYnVmZmVyOwogICAgcHJvdG9idWYudXRpbCA9IHJlcXVpcmVNaW5pbWFsKCk7CiAgICBwcm90b2J1Zi5ycGMgPSBycGM7CiAgICBwcm90b2J1Zi5yb290cyA9IHJvb3RzOwogICAgcHJvdG9idWYuY29uZmlndXJlID0gY29uZmlndXJlOwogICAgZnVuY3Rpb24gY29uZmlndXJlKCkgewogICAgICBwcm90b2J1Zi51dGlsLl9jb25maWd1cmUoKTsKICAgICAgcHJvdG9idWYuV3JpdGVyLl9jb25maWd1cmUocHJvdG9idWYuQnVmZmVyV3JpdGVyKTsKICAgICAgcHJvdG9idWYuUmVhZGVyLl9jb25maWd1cmUocHJvdG9idWYuQnVmZmVyUmVhZGVyKTsKICAgIH0KICAgIGNvbmZpZ3VyZSgpOwogIH0pKGluZGV4TWluaW1hbCk7CiAgdmFyIG1pbmltYWwgPSBpbmRleE1pbmltYWw7CiAgY29uc3QgJFJlYWRlciA9IG1pbmltYWwuUmVhZGVyLCAkV3JpdGVyID0gbWluaW1hbC5Xcml0ZXIsICR1dGlsID0gbWluaW1hbC51dGlsOwogIGNvbnN0ICRyb290ID0gbWluaW1hbC5yb290c1siZGVmYXVsdCJdIHx8IChtaW5pbWFsLnJvb3RzWyJkZWZhdWx0Il0gPSB7fSk7CiAgY29uc3QgcHJvdG9jb2wgPSAkcm9vdC5wcm90b2NvbCA9ICgoKSA9PiB7CiAgICBjb25zdCBwcm90b2NvbDIgPSB7fTsKICAgIHByb3RvY29sMi5HZW9tZXRyeSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBHZW9tZXRyeShwcm9wZXJ0aWVzKSB7CiAgICAgICAgdGhpcy5hdCA9IFtdOwogICAgICAgIHRoaXMucG9zaXRpb25zID0gW107CiAgICAgICAgdGhpcy51dnMgPSBbXTsKICAgICAgICB0aGlzLmluZGljZXMgPSBbXTsKICAgICAgICB0aGlzLmxpZ2h0cyA9IFtdOwogICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CiAgICAgICAgICBmb3IgKGxldCBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkyID0gMDsgaTIgPCBrZXlzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKHByb3BlcnRpZXNba2V5c1tpMl1dICE9IG51bGwpCiAgICAgICAgICAgICAgdGhpc1trZXlzW2kyXV0gPSBwcm9wZXJ0aWVzW2tleXNbaTJdXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgR2VvbWV0cnkucHJvdG90eXBlLnZveGVsID0gMDsKICAgICAgR2VvbWV0cnkucHJvdG90eXBlLmZhY2VOYW1lID0gbnVsbDsKICAgICAgR2VvbWV0cnkucHJvdG90eXBlLmF0ID0gJHV0aWwuZW1wdHlBcnJheTsKICAgICAgR2VvbWV0cnkucHJvdG90eXBlLnBvc2l0aW9ucyA9ICR1dGlsLmVtcHR5QXJyYXk7CiAgICAgIEdlb21ldHJ5LnByb3RvdHlwZS51dnMgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBHZW9tZXRyeS5wcm90b3R5cGUuaW5kaWNlcyA9ICR1dGlsLmVtcHR5QXJyYXk7CiAgICAgIEdlb21ldHJ5LnByb3RvdHlwZS5saWdodHMgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBsZXQgJG9uZU9mRmllbGRzOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoR2VvbWV0cnkucHJvdG90eXBlLCAiX2ZhY2VOYW1lIiwgewogICAgICAgIGdldDogJHV0aWwub25lT2ZHZXR0ZXIoJG9uZU9mRmllbGRzID0gWyJmYWNlTmFtZSJdKSwKICAgICAgICBzZXQ6ICR1dGlsLm9uZU9mU2V0dGVyKCRvbmVPZkZpZWxkcykKICAgICAgfSk7CiAgICAgIEdlb21ldHJ5LmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZTIocHJvcGVydGllcykgewogICAgICAgIHJldHVybiBuZXcgR2VvbWV0cnkocHJvcGVydGllcyk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5LmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIyKSB7CiAgICAgICAgaWYgKCF3cml0ZXIyKQogICAgICAgICAgd3JpdGVyMiA9ICRXcml0ZXIuY3JlYXRlKCk7CiAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWwgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidm94ZWwiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAxLCB3aXJlVHlwZSAwID0qLwogICAgICAgICAgICA4CiAgICAgICAgICApLnVpbnQzMihtZXNzYWdlLnZveGVsKTsKICAgICAgICBpZiAobWVzc2FnZS5mYWNlTmFtZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJmYWNlTmFtZSIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDIsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDE4CiAgICAgICAgICApLnN0cmluZyhtZXNzYWdlLmZhY2VOYW1lKTsKICAgICAgICBpZiAobWVzc2FnZS5hdCAhPSBudWxsICYmIG1lc3NhZ2UuYXQubGVuZ3RoKSB7CiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMjYKICAgICAgICAgICkuZm9yaygpOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UuYXQubGVuZ3RoOyArK2kyKQogICAgICAgICAgICB3cml0ZXIyLmludDMyKG1lc3NhZ2UuYXRbaTJdKTsKICAgICAgICAgIHdyaXRlcjIubGRlbGltKCk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnBvc2l0aW9ucyAhPSBudWxsICYmIG1lc3NhZ2UucG9zaXRpb25zLmxlbmd0aCkgewogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDQsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDM0CiAgICAgICAgICApLmZvcmsoKTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnBvc2l0aW9ucy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIHdyaXRlcjIuZmxvYXQobWVzc2FnZS5wb3NpdGlvbnNbaTJdKTsKICAgICAgICAgIHdyaXRlcjIubGRlbGltKCk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnV2cyAhPSBudWxsICYmIG1lc3NhZ2UudXZzLmxlbmd0aCkgewogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDUsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDQyCiAgICAgICAgICApLmZvcmsoKTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnV2cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIHdyaXRlcjIuZmxvYXQobWVzc2FnZS51dnNbaTJdKTsKICAgICAgICAgIHdyaXRlcjIubGRlbGltKCk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmluZGljZXMgIT0gbnVsbCAmJiBtZXNzYWdlLmluZGljZXMubGVuZ3RoKSB7CiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgNiwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgNTAKICAgICAgICAgICkuZm9yaygpOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UuaW5kaWNlcy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIHdyaXRlcjIuaW50MzIobWVzc2FnZS5pbmRpY2VzW2kyXSk7CiAgICAgICAgICB3cml0ZXIyLmxkZWxpbSgpOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgIT0gbnVsbCAmJiBtZXNzYWdlLmxpZ2h0cy5sZW5ndGgpIHsKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCA3LCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICA1OAogICAgICAgICAgKS5mb3JrKCk7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICB3cml0ZXIyLmludDMyKG1lc3NhZ2UubGlnaHRzW2kyXSk7CiAgICAgICAgICB3cml0ZXIyLmxkZWxpbSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gd3JpdGVyMjsKICAgICAgfTsKICAgICAgR2VvbWV0cnkuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5LmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeSgpOwogICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZCkgewogICAgICAgICAgbGV0IHRhZyA9IHJlYWRlcjIudWludDMyKCk7CiAgICAgICAgICBzd2l0Y2ggKHRhZyA+Pj4gMykgewogICAgICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgICAgICBtZXNzYWdlLnZveGVsID0gcmVhZGVyMi51aW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgICBtZXNzYWdlLmZhY2VOYW1lID0gcmVhZGVyMi5zdHJpbmcoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLmF0ICYmIG1lc3NhZ2UuYXQubGVuZ3RoKSkKICAgICAgICAgICAgICAgIG1lc3NhZ2UuYXQgPSBbXTsKICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CiAgICAgICAgICAgICAgICBsZXQgZW5kMiA9IHJlYWRlcjIudWludDMyKCkgKyByZWFkZXIyLnBvczsKICAgICAgICAgICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZDIpCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuYXQucHVzaChyZWFkZXIyLmludDMyKCkpOwogICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgbWVzc2FnZS5hdC5wdXNoKHJlYWRlcjIuaW50MzIoKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA0OiB7CiAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5wb3NpdGlvbnMgJiYgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoKSkKICAgICAgICAgICAgICAgIG1lc3NhZ2UucG9zaXRpb25zID0gW107CiAgICAgICAgICAgICAgaWYgKCh0YWcgJiA3KSA9PT0gMikgewogICAgICAgICAgICAgICAgbGV0IGVuZDIgPSByZWFkZXIyLnVpbnQzMigpICsgcmVhZGVyMi5wb3M7CiAgICAgICAgICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQyKQogICAgICAgICAgICAgICAgICBtZXNzYWdlLnBvc2l0aW9ucy5wdXNoKHJlYWRlcjIuZmxvYXQoKSk7CiAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICBtZXNzYWdlLnBvc2l0aW9ucy5wdXNoKHJlYWRlcjIuZmxvYXQoKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA1OiB7CiAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS51dnMgJiYgbWVzc2FnZS51dnMubGVuZ3RoKSkKICAgICAgICAgICAgICAgIG1lc3NhZ2UudXZzID0gW107CiAgICAgICAgICAgICAgaWYgKCh0YWcgJiA3KSA9PT0gMikgewogICAgICAgICAgICAgICAgbGV0IGVuZDIgPSByZWFkZXIyLnVpbnQzMigpICsgcmVhZGVyMi5wb3M7CiAgICAgICAgICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQyKQogICAgICAgICAgICAgICAgICBtZXNzYWdlLnV2cy5wdXNoKHJlYWRlcjIuZmxvYXQoKSk7CiAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICBtZXNzYWdlLnV2cy5wdXNoKHJlYWRlcjIuZmxvYXQoKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA2OiB7CiAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5pbmRpY2VzICYmIG1lc3NhZ2UuaW5kaWNlcy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS5pbmRpY2VzID0gW107CiAgICAgICAgICAgICAgaWYgKCh0YWcgJiA3KSA9PT0gMikgewogICAgICAgICAgICAgICAgbGV0IGVuZDIgPSByZWFkZXIyLnVpbnQzMigpICsgcmVhZGVyMi5wb3M7CiAgICAgICAgICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQyKQogICAgICAgICAgICAgICAgICBtZXNzYWdlLmluZGljZXMucHVzaChyZWFkZXIyLmludDMyKCkpOwogICAgICAgICAgICAgIH0gZWxzZQogICAgICAgICAgICAgICAgbWVzc2FnZS5pbmRpY2VzLnB1c2gocmVhZGVyMi5pbnQzMigpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDc6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLmxpZ2h0cyAmJiBtZXNzYWdlLmxpZ2h0cy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS5saWdodHMgPSBbXTsKICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CiAgICAgICAgICAgICAgICBsZXQgZW5kMiA9IHJlYWRlcjIudWludDMyKCkgKyByZWFkZXIyLnBvczsKICAgICAgICAgICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZDIpCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2UubGlnaHRzLnB1c2gocmVhZGVyMi5pbnQzMigpKTsKICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG1lc3NhZ2UubGlnaHRzLnB1c2gocmVhZGVyMi5pbnQzMigpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJlYWRlcjIuc2tpcFR5cGUodGFnICYgNyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9OwogICAgICBHZW9tZXRyeS5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyMikgewogICAgICAgIGlmICghKHJlYWRlcjIgaW5zdGFuY2VvZiAkUmVhZGVyKSkKICAgICAgICAgIHJlYWRlcjIgPSBuZXcgJFJlYWRlcihyZWFkZXIyKTsKICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSk7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5LnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKQogICAgICAgICAgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwogICAgICAgIGlmIChtZXNzYWdlLnZveGVsICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidm94ZWwiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52b3hlbCkpCiAgICAgICAgICAgIHJldHVybiAidm94ZWw6IGludGVnZXIgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5mYWNlTmFtZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImZhY2VOYW1lIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5mYWNlTmFtZSkpCiAgICAgICAgICAgIHJldHVybiAiZmFjZU5hbWU6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmF0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiYXQiKSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UuYXQpKQogICAgICAgICAgICByZXR1cm4gImF0OiBhcnJheSBleHBlY3RlZCI7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5hdC5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UuYXRbaTJdKSkKICAgICAgICAgICAgICByZXR1cm4gImF0OiBpbnRlZ2VyW10gZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5wb3NpdGlvbnMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJwb3NpdGlvbnMiKSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UucG9zaXRpb25zKSkKICAgICAgICAgICAgcmV0dXJuICJwb3NpdGlvbnM6IGFycmF5IGV4cGVjdGVkIjsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnBvc2l0aW9ucy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZS5wb3NpdGlvbnNbaTJdICE9PSAibnVtYmVyIikKICAgICAgICAgICAgICByZXR1cm4gInBvc2l0aW9uczogbnVtYmVyW10gZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS51dnMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ1dnMiKSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UudXZzKSkKICAgICAgICAgICAgcmV0dXJuICJ1dnM6IGFycmF5IGV4cGVjdGVkIjsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnV2cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZS51dnNbaTJdICE9PSAibnVtYmVyIikKICAgICAgICAgICAgICByZXR1cm4gInV2czogbnVtYmVyW10gZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5pbmRpY2VzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiaW5kaWNlcyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5pbmRpY2VzKSkKICAgICAgICAgICAgcmV0dXJuICJpbmRpY2VzOiBhcnJheSBleHBlY3RlZCI7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5pbmRpY2VzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS5pbmRpY2VzW2kyXSkpCiAgICAgICAgICAgICAgcmV0dXJuICJpbmRpY2VzOiBpbnRlZ2VyW10gZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodHMiKSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2UubGlnaHRzKSkKICAgICAgICAgICAgcmV0dXJuICJsaWdodHM6IGFycmF5IGV4cGVjdGVkIjsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLmxpZ2h0cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UubGlnaHRzW2kyXSkpCiAgICAgICAgICAgICAgcmV0dXJuICJsaWdodHM6IGludGVnZXJbXSBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBHZW9tZXRyeS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuR2VvbWV0cnkpCiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIGxldCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkdlb21ldHJ5KCk7CiAgICAgICAgaWYgKG9iamVjdC52b3hlbCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS52b3hlbCA9IG9iamVjdC52b3hlbCA+Pj4gMDsKICAgICAgICBpZiAob2JqZWN0LmZhY2VOYW1lICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLmZhY2VOYW1lID0gU3RyaW5nKG9iamVjdC5mYWNlTmFtZSk7CiAgICAgICAgaWYgKG9iamVjdC5hdCkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5hdCkpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkdlb21ldHJ5LmF0OiBhcnJheSBleHBlY3RlZCIpOwogICAgICAgICAgbWVzc2FnZS5hdCA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG9iamVjdC5hdC5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIG1lc3NhZ2UuYXRbaTJdID0gb2JqZWN0LmF0W2kyXSB8IDA7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QucG9zaXRpb25zKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LnBvc2l0aW9ucykpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkdlb21ldHJ5LnBvc2l0aW9uczogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UucG9zaXRpb25zID0gW107CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgb2JqZWN0LnBvc2l0aW9ucy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIG1lc3NhZ2UucG9zaXRpb25zW2kyXSA9IE51bWJlcihvYmplY3QucG9zaXRpb25zW2kyXSk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QudXZzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LnV2cykpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkdlb21ldHJ5LnV2czogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UudXZzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgb2JqZWN0LnV2cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIG1lc3NhZ2UudXZzW2kyXSA9IE51bWJlcihvYmplY3QudXZzW2kyXSk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QuaW5kaWNlcykgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5pbmRpY2VzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuR2VvbWV0cnkuaW5kaWNlczogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UuaW5kaWNlcyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG9iamVjdC5pbmRpY2VzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgbWVzc2FnZS5pbmRpY2VzW2kyXSA9IG9iamVjdC5pbmRpY2VzW2kyXSB8IDA7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QubGlnaHRzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LmxpZ2h0cykpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLkdlb21ldHJ5LmxpZ2h0czogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UubGlnaHRzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgb2JqZWN0LmxpZ2h0cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIG1lc3NhZ2UubGlnaHRzW2kyXSA9IG9iamVjdC5saWdodHNbaTJdIHwgMDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5LnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgIGlmICghb3B0aW9ucykKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgaWYgKG9wdGlvbnMuYXJyYXlzIHx8IG9wdGlvbnMuZGVmYXVsdHMpIHsKICAgICAgICAgIG9iamVjdC5hdCA9IFtdOwogICAgICAgICAgb2JqZWN0LnBvc2l0aW9ucyA9IFtdOwogICAgICAgICAgb2JqZWN0LnV2cyA9IFtdOwogICAgICAgICAgb2JqZWN0LmluZGljZXMgPSBbXTsKICAgICAgICAgIG9iamVjdC5saWdodHMgPSBbXTsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuZGVmYXVsdHMpCiAgICAgICAgICBvYmplY3Qudm94ZWwgPSAwOwogICAgICAgIGlmIChtZXNzYWdlLnZveGVsICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidm94ZWwiKSkKICAgICAgICAgIG9iamVjdC52b3hlbCA9IG1lc3NhZ2Uudm94ZWw7CiAgICAgICAgaWYgKG1lc3NhZ2UuZmFjZU5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJmYWNlTmFtZSIpKSB7CiAgICAgICAgICBvYmplY3QuZmFjZU5hbWUgPSBtZXNzYWdlLmZhY2VOYW1lOwogICAgICAgICAgaWYgKG9wdGlvbnMub25lb2ZzKQogICAgICAgICAgICBvYmplY3QuX2ZhY2VOYW1lID0gImZhY2VOYW1lIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UuYXQgJiYgbWVzc2FnZS5hdC5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5hdCA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtZXNzYWdlLmF0Lmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QuYXRbal0gPSBtZXNzYWdlLmF0W2pdOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5wb3NpdGlvbnMgJiYgbWVzc2FnZS5wb3NpdGlvbnMubGVuZ3RoKSB7CiAgICAgICAgICBvYmplY3QucG9zaXRpb25zID0gW107CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1lc3NhZ2UucG9zaXRpb25zLmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QucG9zaXRpb25zW2pdID0gb3B0aW9ucy5qc29uICYmICFpc0Zpbml0ZShtZXNzYWdlLnBvc2l0aW9uc1tqXSkgPyBTdHJpbmcobWVzc2FnZS5wb3NpdGlvbnNbal0pIDogbWVzc2FnZS5wb3NpdGlvbnNbal07CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnV2cyAmJiBtZXNzYWdlLnV2cy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC51dnMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS51dnMubGVuZ3RoOyArK2opCiAgICAgICAgICAgIG9iamVjdC51dnNbal0gPSBvcHRpb25zLmpzb24gJiYgIWlzRmluaXRlKG1lc3NhZ2UudXZzW2pdKSA/IFN0cmluZyhtZXNzYWdlLnV2c1tqXSkgOiBtZXNzYWdlLnV2c1tqXTsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UuaW5kaWNlcyAmJiBtZXNzYWdlLmluZGljZXMubGVuZ3RoKSB7CiAgICAgICAgICBvYmplY3QuaW5kaWNlcyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtZXNzYWdlLmluZGljZXMubGVuZ3RoOyArK2opCiAgICAgICAgICAgIG9iamVjdC5pbmRpY2VzW2pdID0gbWVzc2FnZS5pbmRpY2VzW2pdOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgJiYgbWVzc2FnZS5saWdodHMubGVuZ3RoKSB7CiAgICAgICAgICBvYmplY3QubGlnaHRzID0gW107CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1lc3NhZ2UubGlnaHRzLmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QubGlnaHRzW2pdID0gbWVzc2FnZS5saWdodHNbal07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIEdlb21ldHJ5LnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9PYmplY3QodGhpcywgbWluaW1hbC51dGlsLnRvSlNPTk9wdGlvbnMpOwogICAgICB9OwogICAgICBHZW9tZXRyeS5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CiAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgdHlwZVVybFByZWZpeCA9ICJ0eXBlLmdvb2dsZWFwaXMuY29tIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkdlb21ldHJ5IjsKICAgICAgfTsKICAgICAgcmV0dXJuIEdlb21ldHJ5OwogICAgfSgpOwogICAgcHJvdG9jb2wyLk1lc2ggPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gTWVzaChwcm9wZXJ0aWVzKSB7CiAgICAgICAgdGhpcy5nZW9tZXRyaWVzID0gW107CiAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKICAgICAgICAgIGZvciAobGV0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaTIgPSAwOyBpMiA8IGtleXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICBpZiAocHJvcGVydGllc1trZXlzW2kyXV0gIT0gbnVsbCkKICAgICAgICAgICAgICB0aGlzW2tleXNbaTJdXSA9IHByb3BlcnRpZXNba2V5c1tpMl1dOwogICAgICAgIH0KICAgICAgfQogICAgICBNZXNoLnByb3RvdHlwZS5sZXZlbCA9IDA7CiAgICAgIE1lc2gucHJvdG90eXBlLmdlb21ldHJpZXMgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBNZXNoLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZTIocHJvcGVydGllcykgewogICAgICAgIHJldHVybiBuZXcgTWVzaChwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgTWVzaC5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyMikgewogICAgICAgIGlmICghd3JpdGVyMikKICAgICAgICAgIHdyaXRlcjIgPSAkV3JpdGVyLmNyZWF0ZSgpOwogICAgICAgIGlmIChtZXNzYWdlLmxldmVsICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImxldmVsIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMSwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgOAogICAgICAgICAgKS5pbnQzMihtZXNzYWdlLmxldmVsKTsKICAgICAgICBpZiAobWVzc2FnZS5nZW9tZXRyaWVzICE9IG51bGwgJiYgbWVzc2FnZS5nZW9tZXRyaWVzLmxlbmd0aCkKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLmdlb21ldHJpZXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeS5lbmNvZGUobWVzc2FnZS5nZW9tZXRyaWVzW2kyXSwgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgICAgLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgICAxOAogICAgICAgICAgICApLmZvcmsoKSkubGRlbGltKCk7CiAgICAgICAgcmV0dXJuIHdyaXRlcjI7CiAgICAgIH07CiAgICAgIE1lc2guZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIE1lc2guZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlcjIsIGxlbmd0aCkgewogICAgICAgIGlmICghKHJlYWRlcjIgaW5zdGFuY2VvZiAkUmVhZGVyKSkKICAgICAgICAgIHJlYWRlcjIgPSAkUmVhZGVyLmNyZWF0ZShyZWFkZXIyKTsKICAgICAgICBsZXQgZW5kID0gbGVuZ3RoID09PSB2b2lkIDAgPyByZWFkZXIyLmxlbiA6IHJlYWRlcjIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLk1lc2goKTsKICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQpIHsKICAgICAgICAgIGxldCB0YWcgPSByZWFkZXIyLnVpbnQzMigpOwogICAgICAgICAgc3dpdGNoICh0YWcgPj4+IDMpIHsKICAgICAgICAgICAgY2FzZSAxOiB7CiAgICAgICAgICAgICAgbWVzc2FnZS5sZXZlbCA9IHJlYWRlcjIuaW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLmdlb21ldHJpZXMgJiYgbWVzc2FnZS5nZW9tZXRyaWVzLmxlbmd0aCkpCiAgICAgICAgICAgICAgICBtZXNzYWdlLmdlb21ldHJpZXMgPSBbXTsKICAgICAgICAgICAgICBtZXNzYWdlLmdlb21ldHJpZXMucHVzaCgkcm9vdC5wcm90b2NvbC5HZW9tZXRyeS5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIE1lc2guZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcjIpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gbmV3ICRSZWFkZXIocmVhZGVyMik7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICB9OwogICAgICBNZXNoLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKQogICAgICAgICAgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwogICAgICAgIGlmIChtZXNzYWdlLmxldmVsICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibGV2ZWwiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS5sZXZlbCkpCiAgICAgICAgICAgIHJldHVybiAibGV2ZWw6IGludGVnZXIgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5nZW9tZXRyaWVzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiZ2VvbWV0cmllcyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5nZW9tZXRyaWVzKSkKICAgICAgICAgICAgcmV0dXJuICJnZW9tZXRyaWVzOiBhcnJheSBleHBlY3RlZCI7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5nZW9tZXRyaWVzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBsZXQgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeS52ZXJpZnkobWVzc2FnZS5nZW9tZXRyaWVzW2kyXSk7CiAgICAgICAgICAgIGlmIChlcnJvcikKICAgICAgICAgICAgICByZXR1cm4gImdlb21ldHJpZXMuIiArIGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfTsKICAgICAgTWVzaC5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuTWVzaCkKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgbGV0IG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuTWVzaCgpOwogICAgICAgIGlmIChvYmplY3QubGV2ZWwgIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UubGV2ZWwgPSBvYmplY3QubGV2ZWwgfCAwOwogICAgICAgIGlmIChvYmplY3QuZ2VvbWV0cmllcykgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5nZW9tZXRyaWVzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzaC5nZW9tZXRyaWVzOiBhcnJheSBleHBlY3RlZCIpOwogICAgICAgICAgbWVzc2FnZS5nZW9tZXRyaWVzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgb2JqZWN0Lmdlb21ldHJpZXMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0Lmdlb21ldHJpZXNbaTJdICE9PSAib2JqZWN0IikKICAgICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNoLmdlb21ldHJpZXM6IG9iamVjdCBleHBlY3RlZCIpOwogICAgICAgICAgICBtZXNzYWdlLmdlb21ldHJpZXNbaTJdID0gJHJvb3QucHJvdG9jb2wuR2VvbWV0cnkuZnJvbU9iamVjdChvYmplY3QuZ2VvbWV0cmllc1tpMl0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfTsKICAgICAgTWVzaC50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKICAgICAgICBpZiAoIW9wdGlvbnMpCiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgbGV0IG9iamVjdCA9IHt9OwogICAgICAgIGlmIChvcHRpb25zLmFycmF5cyB8fCBvcHRpb25zLmRlZmF1bHRzKQogICAgICAgICAgb2JqZWN0Lmdlb21ldHJpZXMgPSBbXTsKICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykKICAgICAgICAgIG9iamVjdC5sZXZlbCA9IDA7CiAgICAgICAgaWYgKG1lc3NhZ2UubGV2ZWwgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsZXZlbCIpKQogICAgICAgICAgb2JqZWN0LmxldmVsID0gbWVzc2FnZS5sZXZlbDsKICAgICAgICBpZiAobWVzc2FnZS5nZW9tZXRyaWVzICYmIG1lc3NhZ2UuZ2VvbWV0cmllcy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5nZW9tZXRyaWVzID0gW107CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1lc3NhZ2UuZ2VvbWV0cmllcy5sZW5ndGg7ICsraikKICAgICAgICAgICAgb2JqZWN0Lmdlb21ldHJpZXNbal0gPSAkcm9vdC5wcm90b2NvbC5HZW9tZXRyeS50b09iamVjdChtZXNzYWdlLmdlb21ldHJpZXNbal0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9OwogICAgICBNZXNoLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9PYmplY3QodGhpcywgbWluaW1hbC51dGlsLnRvSlNPTk9wdGlvbnMpOwogICAgICB9OwogICAgICBNZXNoLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuTWVzaCI7CiAgICAgIH07CiAgICAgIHJldHVybiBNZXNoOwogICAgfSgpOwogICAgcHJvdG9jb2wyLkNodW5rID0gZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIENodW5rKHByb3BlcnRpZXMpIHsKICAgICAgICB0aGlzLm1lc2hlcyA9IFtdOwogICAgICAgIHRoaXMudm94ZWxzID0gW107CiAgICAgICAgdGhpcy5saWdodHMgPSBbXTsKICAgICAgICBpZiAocHJvcGVydGllcykgewogICAgICAgICAgZm9yIChsZXQga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpMiA9IDA7IGkyIDwga2V5cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzW2tleXNbaTJdXSAhPSBudWxsKQogICAgICAgICAgICAgIHRoaXNba2V5c1tpMl1dID0gcHJvcGVydGllc1trZXlzW2kyXV07CiAgICAgICAgfQogICAgICB9CiAgICAgIENodW5rLnByb3RvdHlwZS54ID0gMDsKICAgICAgQ2h1bmsucHJvdG90eXBlLnogPSAwOwogICAgICBDaHVuay5wcm90b3R5cGUuaWQgPSAiIjsKICAgICAgQ2h1bmsucHJvdG90eXBlLm1lc2hlcyA9ICR1dGlsLmVtcHR5QXJyYXk7CiAgICAgIENodW5rLnByb3RvdHlwZS52b3hlbHMgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBDaHVuay5wcm90b3R5cGUubGlnaHRzID0gJHV0aWwuZW1wdHlBcnJheTsKICAgICAgQ2h1bmsuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlMihwcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDaHVuayhwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgQ2h1bmsuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICBpZiAoIXdyaXRlcjIpCiAgICAgICAgICB3cml0ZXIyID0gJFdyaXRlci5jcmVhdGUoKTsKICAgICAgICBpZiAobWVzc2FnZS54ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIngiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAxLCB3aXJlVHlwZSAwID0qLwogICAgICAgICAgICA4CiAgICAgICAgICApLmludDMyKG1lc3NhZ2UueCk7CiAgICAgICAgaWYgKG1lc3NhZ2UueiAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ6IikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMiwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgMTYKICAgICAgICAgICkuaW50MzIobWVzc2FnZS56KTsKICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJpZCIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDMsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDI2CiAgICAgICAgICApLnN0cmluZyhtZXNzYWdlLmlkKTsKICAgICAgICBpZiAobWVzc2FnZS5tZXNoZXMgIT0gbnVsbCAmJiBtZXNzYWdlLm1lc2hlcy5sZW5ndGgpCiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5tZXNoZXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICAkcm9vdC5wcm90b2NvbC5NZXNoLmVuY29kZShtZXNzYWdlLm1lc2hlc1tpMl0sIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAgIC8qIGlkIDQsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgMzQKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLnZveGVscyAhPSBudWxsICYmIG1lc3NhZ2Uudm94ZWxzLmxlbmd0aCkgewogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDUsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDQyCiAgICAgICAgICApLmZvcmsoKTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnZveGVscy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIHdyaXRlcjIudWludDMyKG1lc3NhZ2Uudm94ZWxzW2kyXSk7CiAgICAgICAgICB3cml0ZXIyLmxkZWxpbSgpOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgIT0gbnVsbCAmJiBtZXNzYWdlLmxpZ2h0cy5sZW5ndGgpIHsKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCA2LCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICA1MAogICAgICAgICAgKS5mb3JrKCk7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5saWdodHMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICB3cml0ZXIyLnVpbnQzMihtZXNzYWdlLmxpZ2h0c1tpMl0pOwogICAgICAgICAgd3JpdGVyMi5sZGVsaW0oKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHdyaXRlcjI7CiAgICAgIH07CiAgICAgIENodW5rLmVuY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZChtZXNzYWdlLCB3cml0ZXIyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpLmxkZWxpbSgpOwogICAgICB9OwogICAgICBDaHVuay5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyMiwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCEocmVhZGVyMiBpbnN0YW5jZW9mICRSZWFkZXIpKQogICAgICAgICAgcmVhZGVyMiA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcjIpOwogICAgICAgIGxldCBlbmQgPSBsZW5ndGggPT09IHZvaWQgMCA/IHJlYWRlcjIubGVuIDogcmVhZGVyMi5wb3MgKyBsZW5ndGgsIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuQ2h1bmsoKTsKICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQpIHsKICAgICAgICAgIGxldCB0YWcgPSByZWFkZXIyLnVpbnQzMigpOwogICAgICAgICAgc3dpdGNoICh0YWcgPj4+IDMpIHsKICAgICAgICAgICAgY2FzZSAxOiB7CiAgICAgICAgICAgICAgbWVzc2FnZS54ID0gcmVhZGVyMi5pbnQzMigpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMjogewogICAgICAgICAgICAgIG1lc3NhZ2UueiA9IHJlYWRlcjIuaW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgICBtZXNzYWdlLmlkID0gcmVhZGVyMi5zdHJpbmcoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDQ6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLm1lc2hlcyAmJiBtZXNzYWdlLm1lc2hlcy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS5tZXNoZXMgPSBbXTsKICAgICAgICAgICAgICBtZXNzYWdlLm1lc2hlcy5wdXNoKCRyb290LnByb3RvY29sLk1lc2guZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDU6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLnZveGVscyAmJiBtZXNzYWdlLnZveGVscy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS52b3hlbHMgPSBbXTsKICAgICAgICAgICAgICBpZiAoKHRhZyAmIDcpID09PSAyKSB7CiAgICAgICAgICAgICAgICBsZXQgZW5kMiA9IHJlYWRlcjIudWludDMyKCkgKyByZWFkZXIyLnBvczsKICAgICAgICAgICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZDIpCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2Uudm94ZWxzLnB1c2gocmVhZGVyMi51aW50MzIoKSk7CiAgICAgICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgICBtZXNzYWdlLnZveGVscy5wdXNoKHJlYWRlcjIudWludDMyKCkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNjogewogICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UubGlnaHRzICYmIG1lc3NhZ2UubGlnaHRzLmxlbmd0aCkpCiAgICAgICAgICAgICAgICBtZXNzYWdlLmxpZ2h0cyA9IFtdOwogICAgICAgICAgICAgIGlmICgodGFnICYgNykgPT09IDIpIHsKICAgICAgICAgICAgICAgIGxldCBlbmQyID0gcmVhZGVyMi51aW50MzIoKSArIHJlYWRlcjIucG9zOwogICAgICAgICAgICAgICAgd2hpbGUgKHJlYWRlcjIucG9zIDwgZW5kMikKICAgICAgICAgICAgICAgICAgbWVzc2FnZS5saWdodHMucHVzaChyZWFkZXIyLnVpbnQzMigpKTsKICAgICAgICAgICAgICB9IGVsc2UKICAgICAgICAgICAgICAgIG1lc3NhZ2UubGlnaHRzLnB1c2gocmVhZGVyMi51aW50MzIoKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZWFkZXIyLnNraXBUeXBlKHRhZyAmIDcpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfTsKICAgICAgQ2h1bmsuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcjIpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gbmV3ICRSZWFkZXIocmVhZGVyMik7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICB9OwogICAgICBDaHVuay52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkKICAgICAgICAgIHJldHVybiAib2JqZWN0IGV4cGVjdGVkIjsKICAgICAgICBpZiAobWVzc2FnZS54ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgieCIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzSW50ZWdlcihtZXNzYWdlLngpKQogICAgICAgICAgICByZXR1cm4gIng6IGludGVnZXIgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS56ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgieiIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzSW50ZWdlcihtZXNzYWdlLnopKQogICAgICAgICAgICByZXR1cm4gIno6IGludGVnZXIgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5pZCkpCiAgICAgICAgICAgIHJldHVybiAiaWQ6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLm1lc2hlcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1lc2hlcyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5tZXNoZXMpKQogICAgICAgICAgICByZXR1cm4gIm1lc2hlczogYXJyYXkgZXhwZWN0ZWQiOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UubWVzaGVzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBsZXQgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5NZXNoLnZlcmlmeShtZXNzYWdlLm1lc2hlc1tpMl0pOwogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuICJtZXNoZXMuIiArIGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS52b3hlbHMgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2b3hlbHMiKSkgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG1lc3NhZ2Uudm94ZWxzKSkKICAgICAgICAgICAgcmV0dXJuICJ2b3hlbHM6IGFycmF5IGV4cGVjdGVkIjsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnZveGVscy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2Uudm94ZWxzW2kyXSkpCiAgICAgICAgICAgICAgcmV0dXJuICJ2b3hlbHM6IGludGVnZXJbXSBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmxpZ2h0cyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImxpZ2h0cyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5saWdodHMpKQogICAgICAgICAgICByZXR1cm4gImxpZ2h0czogYXJyYXkgZXhwZWN0ZWQiOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UubGlnaHRzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS5saWdodHNbaTJdKSkKICAgICAgICAgICAgICByZXR1cm4gImxpZ2h0czogaW50ZWdlcltdIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH07CiAgICAgIENodW5rLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5DaHVuaykKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgbGV0IG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuQ2h1bmsoKTsKICAgICAgICBpZiAob2JqZWN0LnggIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UueCA9IG9iamVjdC54IHwgMDsKICAgICAgICBpZiAob2JqZWN0LnogIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UueiA9IG9iamVjdC56IHwgMDsKICAgICAgICBpZiAob2JqZWN0LmlkICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLmlkID0gU3RyaW5nKG9iamVjdC5pZCk7CiAgICAgICAgaWYgKG9iamVjdC5tZXNoZXMpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QubWVzaGVzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuQ2h1bmsubWVzaGVzOiBhcnJheSBleHBlY3RlZCIpOwogICAgICAgICAgbWVzc2FnZS5tZXNoZXMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QubWVzaGVzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5tZXNoZXNbaTJdICE9PSAib2JqZWN0IikKICAgICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5DaHVuay5tZXNoZXM6IG9iamVjdCBleHBlY3RlZCIpOwogICAgICAgICAgICBtZXNzYWdlLm1lc2hlc1tpMl0gPSAkcm9vdC5wcm90b2NvbC5NZXNoLmZyb21PYmplY3Qob2JqZWN0Lm1lc2hlc1tpMl0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0LnZveGVscykgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC52b3hlbHMpKQogICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5DaHVuay52b3hlbHM6IGFycmF5IGV4cGVjdGVkIik7CiAgICAgICAgICBtZXNzYWdlLnZveGVscyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG9iamVjdC52b3hlbHMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICBtZXNzYWdlLnZveGVsc1tpMl0gPSBvYmplY3Qudm94ZWxzW2kyXSA+Pj4gMDsKICAgICAgICB9CiAgICAgICAgaWYgKG9iamVjdC5saWdodHMpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShvYmplY3QubGlnaHRzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuQ2h1bmsubGlnaHRzOiBhcnJheSBleHBlY3RlZCIpOwogICAgICAgICAgbWVzc2FnZS5saWdodHMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QubGlnaHRzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgbWVzc2FnZS5saWdodHNbaTJdID0gb2JqZWN0LmxpZ2h0c1tpMl0gPj4+IDA7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9OwogICAgICBDaHVuay50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKICAgICAgICBpZiAoIW9wdGlvbnMpCiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgbGV0IG9iamVjdCA9IHt9OwogICAgICAgIGlmIChvcHRpb25zLmFycmF5cyB8fCBvcHRpb25zLmRlZmF1bHRzKSB7CiAgICAgICAgICBvYmplY3QubWVzaGVzID0gW107CiAgICAgICAgICBvYmplY3Qudm94ZWxzID0gW107CiAgICAgICAgICBvYmplY3QubGlnaHRzID0gW107CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CiAgICAgICAgICBvYmplY3QueCA9IDA7CiAgICAgICAgICBvYmplY3QueiA9IDA7CiAgICAgICAgICBvYmplY3QuaWQgPSAiIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UueCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIngiKSkKICAgICAgICAgIG9iamVjdC54ID0gbWVzc2FnZS54OwogICAgICAgIGlmIChtZXNzYWdlLnogIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ6IikpCiAgICAgICAgICBvYmplY3QueiA9IG1lc3NhZ2UuejsKICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpCiAgICAgICAgICBvYmplY3QuaWQgPSBtZXNzYWdlLmlkOwogICAgICAgIGlmIChtZXNzYWdlLm1lc2hlcyAmJiBtZXNzYWdlLm1lc2hlcy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5tZXNoZXMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS5tZXNoZXMubGVuZ3RoOyArK2opCiAgICAgICAgICAgIG9iamVjdC5tZXNoZXNbal0gPSAkcm9vdC5wcm90b2NvbC5NZXNoLnRvT2JqZWN0KG1lc3NhZ2UubWVzaGVzW2pdLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2Uudm94ZWxzICYmIG1lc3NhZ2Uudm94ZWxzLmxlbmd0aCkgewogICAgICAgICAgb2JqZWN0LnZveGVscyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtZXNzYWdlLnZveGVscy5sZW5ndGg7ICsraikKICAgICAgICAgICAgb2JqZWN0LnZveGVsc1tqXSA9IG1lc3NhZ2Uudm94ZWxzW2pdOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5saWdodHMgJiYgbWVzc2FnZS5saWdodHMubGVuZ3RoKSB7CiAgICAgICAgICBvYmplY3QubGlnaHRzID0gW107CiAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IG1lc3NhZ2UubGlnaHRzLmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QubGlnaHRzW2pdID0gbWVzc2FnZS5saWdodHNbal07CiAgICAgICAgfQogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIENodW5rLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9PYmplY3QodGhpcywgbWluaW1hbC51dGlsLnRvSlNPTk9wdGlvbnMpOwogICAgICB9OwogICAgICBDaHVuay5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CiAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgdHlwZVVybFByZWZpeCA9ICJ0eXBlLmdvb2dsZWFwaXMuY29tIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkNodW5rIjsKICAgICAgfTsKICAgICAgcmV0dXJuIENodW5rOwogICAgfSgpOwogICAgcHJvdG9jb2wyLlBlZXIgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gUGVlcihwcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKICAgICAgICAgIGZvciAobGV0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaTIgPSAwOyBpMiA8IGtleXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICBpZiAocHJvcGVydGllc1trZXlzW2kyXV0gIT0gbnVsbCkKICAgICAgICAgICAgICB0aGlzW2tleXNbaTJdXSA9IHByb3BlcnRpZXNba2V5c1tpMl1dOwogICAgICAgIH0KICAgICAgfQogICAgICBQZWVyLnByb3RvdHlwZS5pZCA9ICIiOwogICAgICBQZWVyLnByb3RvdHlwZS51c2VybmFtZSA9ICIiOwogICAgICBQZWVyLnByb3RvdHlwZS5tZXRhZGF0YSA9ICIiOwogICAgICBQZWVyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZTIocHJvcGVydGllcykgewogICAgICAgIHJldHVybiBuZXcgUGVlcihwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgUGVlci5lbmNvZGUgPSBmdW5jdGlvbiBlbmNvZGUobWVzc2FnZSwgd3JpdGVyMikgewogICAgICAgIGlmICghd3JpdGVyMikKICAgICAgICAgIHdyaXRlcjIgPSAkV3JpdGVyLmNyZWF0ZSgpOwogICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImlkIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMTAKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UuaWQpOwogICAgICAgIGlmIChtZXNzYWdlLnVzZXJuYW1lICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInVzZXJuYW1lIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMTgKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UudXNlcm5hbWUpOwogICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm1ldGFkYXRhIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMjYKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UubWV0YWRhdGEpOwogICAgICAgIHJldHVybiB3cml0ZXIyOwogICAgICB9OwogICAgICBQZWVyLmVuY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGVuY29kZURlbGltaXRlZChtZXNzYWdlLCB3cml0ZXIyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpLmxkZWxpbSgpOwogICAgICB9OwogICAgICBQZWVyLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5QZWVyKCk7CiAgICAgICAgd2hpbGUgKHJlYWRlcjIucG9zIDwgZW5kKSB7CiAgICAgICAgICBsZXQgdGFnID0gcmVhZGVyMi51aW50MzIoKTsKICAgICAgICAgIHN3aXRjaCAodGFnID4+PiAzKSB7CiAgICAgICAgICAgIGNhc2UgMTogewogICAgICAgICAgICAgIG1lc3NhZ2UuaWQgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMjogewogICAgICAgICAgICAgIG1lc3NhZ2UudXNlcm5hbWUgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMzogewogICAgICAgICAgICAgIG1lc3NhZ2UubWV0YWRhdGEgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIFBlZXIuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcjIpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gbmV3ICRSZWFkZXIocmVhZGVyMik7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICB9OwogICAgICBQZWVyLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKQogICAgICAgICAgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwogICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLmlkKSkKICAgICAgICAgICAgcmV0dXJuICJpZDogc3RyaW5nIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UudXNlcm5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ1c2VybmFtZSIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UudXNlcm5hbWUpKQogICAgICAgICAgICByZXR1cm4gInVzZXJuYW1lOiBzdHJpbmcgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5tZXRhZGF0YSkpCiAgICAgICAgICAgIHJldHVybiAibWV0YWRhdGE6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBQZWVyLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5QZWVyKQogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICBsZXQgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5QZWVyKCk7CiAgICAgICAgaWYgKG9iamVjdC5pZCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS5pZCA9IFN0cmluZyhvYmplY3QuaWQpOwogICAgICAgIGlmIChvYmplY3QudXNlcm5hbWUgIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UudXNlcm5hbWUgPSBTdHJpbmcob2JqZWN0LnVzZXJuYW1lKTsKICAgICAgICBpZiAob2JqZWN0Lm1ldGFkYXRhICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLm1ldGFkYXRhID0gU3RyaW5nKG9iamVjdC5tZXRhZGF0YSk7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIFBlZXIudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKCFvcHRpb25zKQogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgICAgb2JqZWN0LmlkID0gIiI7CiAgICAgICAgICBvYmplY3QudXNlcm5hbWUgPSAiIjsKICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpCiAgICAgICAgICBvYmplY3QuaWQgPSBtZXNzYWdlLmlkOwogICAgICAgIGlmIChtZXNzYWdlLnVzZXJuYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidXNlcm5hbWUiKSkKICAgICAgICAgIG9iamVjdC51c2VybmFtZSA9IG1lc3NhZ2UudXNlcm5hbWU7CiAgICAgICAgaWYgKG1lc3NhZ2UubWV0YWRhdGEgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJtZXRhZGF0YSIpKQogICAgICAgICAgb2JqZWN0Lm1ldGFkYXRhID0gbWVzc2FnZS5tZXRhZGF0YTsKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9OwogICAgICBQZWVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiB0b0pTT04oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3IudG9PYmplY3QodGhpcywgbWluaW1hbC51dGlsLnRvSlNPTk9wdGlvbnMpOwogICAgICB9OwogICAgICBQZWVyLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuUGVlciI7CiAgICAgIH07CiAgICAgIHJldHVybiBQZWVyOwogICAgfSgpOwogICAgcHJvdG9jb2wyLkVudGl0eSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBFbnRpdHkyKHByb3BlcnRpZXMpIHsKICAgICAgICBpZiAocHJvcGVydGllcykgewogICAgICAgICAgZm9yIChsZXQga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpMiA9IDA7IGkyIDwga2V5cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzW2tleXNbaTJdXSAhPSBudWxsKQogICAgICAgICAgICAgIHRoaXNba2V5c1tpMl1dID0gcHJvcGVydGllc1trZXlzW2kyXV07CiAgICAgICAgfQogICAgICB9CiAgICAgIEVudGl0eTIucHJvdG90eXBlLm9wZXJhdGlvbiA9IDA7CiAgICAgIEVudGl0eTIucHJvdG90eXBlLmlkID0gIiI7CiAgICAgIEVudGl0eTIucHJvdG90eXBlLnR5cGUgPSAiIjsKICAgICAgRW50aXR5Mi5wcm90b3R5cGUubWV0YWRhdGEgPSAiIjsKICAgICAgRW50aXR5Mi5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUyKHByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gbmV3IEVudGl0eTIocHJvcGVydGllcyk7CiAgICAgIH07CiAgICAgIEVudGl0eTIuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICBpZiAoIXdyaXRlcjIpCiAgICAgICAgICB3cml0ZXIyID0gJFdyaXRlci5jcmVhdGUoKTsKICAgICAgICBpZiAobWVzc2FnZS5vcGVyYXRpb24gIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAib3BlcmF0aW9uIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMSwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgOAogICAgICAgICAgKS5pbnQzMihtZXNzYWdlLm9wZXJhdGlvbik7CiAgICAgICAgaWYgKG1lc3NhZ2UuaWQgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAiaWQiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAyLCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAxOAogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS5pZCk7CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ0eXBlIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMywgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMjYKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UudHlwZSk7CiAgICAgICAgaWYgKG1lc3NhZ2UubWV0YWRhdGEgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAibWV0YWRhdGEiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCA0LCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAzNAogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS5tZXRhZGF0YSk7CiAgICAgICAgcmV0dXJuIHdyaXRlcjI7CiAgICAgIH07CiAgICAgIEVudGl0eTIuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIEVudGl0eTIuZGVjb2RlID0gZnVuY3Rpb24gZGVjb2RlKHJlYWRlcjIsIGxlbmd0aCkgewogICAgICAgIGlmICghKHJlYWRlcjIgaW5zdGFuY2VvZiAkUmVhZGVyKSkKICAgICAgICAgIHJlYWRlcjIgPSAkUmVhZGVyLmNyZWF0ZShyZWFkZXIyKTsKICAgICAgICBsZXQgZW5kID0gbGVuZ3RoID09PSB2b2lkIDAgPyByZWFkZXIyLmxlbiA6IHJlYWRlcjIucG9zICsgbGVuZ3RoLCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkVudGl0eSgpOwogICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZCkgewogICAgICAgICAgbGV0IHRhZyA9IHJlYWRlcjIudWludDMyKCk7CiAgICAgICAgICBzd2l0Y2ggKHRhZyA+Pj4gMykgewogICAgICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgICAgICBtZXNzYWdlLm9wZXJhdGlvbiA9IHJlYWRlcjIuaW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgICBtZXNzYWdlLmlkID0gcmVhZGVyMi5zdHJpbmcoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNDogewogICAgICAgICAgICAgIG1lc3NhZ2UubWV0YWRhdGEgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIEVudGl0eTIuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcjIpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gbmV3ICRSZWFkZXIocmVhZGVyMik7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICB9OwogICAgICBFbnRpdHkyLnZlcmlmeSA9IGZ1bmN0aW9uIHZlcmlmeShtZXNzYWdlKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtZXNzYWdlICE9PSAib2JqZWN0IiB8fCBtZXNzYWdlID09PSBudWxsKQogICAgICAgICAgcmV0dXJuICJvYmplY3QgZXhwZWN0ZWQiOwogICAgICAgIGlmIChtZXNzYWdlLm9wZXJhdGlvbiAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm9wZXJhdGlvbiIpKQogICAgICAgICAgc3dpdGNoIChtZXNzYWdlLm9wZXJhdGlvbikgewogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAib3BlcmF0aW9uOiBlbnVtIHZhbHVlIGV4cGVjdGVkIjsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5pZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImlkIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5pZCkpCiAgICAgICAgICAgIHJldHVybiAiaWQ6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnR5cGUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ0eXBlIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS50eXBlKSkKICAgICAgICAgICAgcmV0dXJuICJ0eXBlOiBzdHJpbmcgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5tZXRhZGF0YSkpCiAgICAgICAgICAgIHJldHVybiAibWV0YWRhdGE6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBFbnRpdHkyLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5FbnRpdHkpCiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIGxldCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkVudGl0eSgpOwogICAgICAgIHN3aXRjaCAob2JqZWN0Lm9wZXJhdGlvbikgewogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3Qub3BlcmF0aW9uID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIG1lc3NhZ2Uub3BlcmF0aW9uID0gb2JqZWN0Lm9wZXJhdGlvbjsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIkNSRUFURSI6CiAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgIG1lc3NhZ2Uub3BlcmF0aW9uID0gMDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJERUxFVEUiOgogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBtZXNzYWdlLm9wZXJhdGlvbiA9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiVVBEQVRFIjoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbWVzc2FnZS5vcGVyYXRpb24gPSAyOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKG9iamVjdC5pZCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS5pZCA9IFN0cmluZyhvYmplY3QuaWQpOwogICAgICAgIGlmIChvYmplY3QudHlwZSAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS50eXBlID0gU3RyaW5nKG9iamVjdC50eXBlKTsKICAgICAgICBpZiAob2JqZWN0Lm1ldGFkYXRhICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLm1ldGFkYXRhID0gU3RyaW5nKG9iamVjdC5tZXRhZGF0YSk7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIEVudGl0eTIudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKCFvcHRpb25zKQogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgICAgb2JqZWN0Lm9wZXJhdGlvbiA9IG9wdGlvbnMuZW51bXMgPT09IFN0cmluZyA/ICJDUkVBVEUiIDogMDsKICAgICAgICAgIG9iamVjdC5pZCA9ICIiOwogICAgICAgICAgb2JqZWN0LnR5cGUgPSAiIjsKICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5vcGVyYXRpb24gIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJvcGVyYXRpb24iKSkKICAgICAgICAgIG9iamVjdC5vcGVyYXRpb24gPSBvcHRpb25zLmVudW1zID09PSBTdHJpbmcgPyAkcm9vdC5wcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9uW21lc3NhZ2Uub3BlcmF0aW9uXSA9PT0gdm9pZCAwID8gbWVzc2FnZS5vcGVyYXRpb24gOiAkcm9vdC5wcm90b2NvbC5FbnRpdHkuT3BlcmF0aW9uW21lc3NhZ2Uub3BlcmF0aW9uXSA6IG1lc3NhZ2Uub3BlcmF0aW9uOwogICAgICAgIGlmIChtZXNzYWdlLmlkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiaWQiKSkKICAgICAgICAgIG9iamVjdC5pZCA9IG1lc3NhZ2UuaWQ7CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkKICAgICAgICAgIG9iamVjdC50eXBlID0gbWVzc2FnZS50eXBlOwogICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibWV0YWRhdGEiKSkKICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9IG1lc3NhZ2UubWV0YWRhdGE7CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgRW50aXR5Mi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsIG1pbmltYWwudXRpbC50b0pTT05PcHRpb25zKTsKICAgICAgfTsKICAgICAgRW50aXR5Mi5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CiAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgdHlwZVVybFByZWZpeCA9ICJ0eXBlLmdvb2dsZWFwaXMuY29tIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLkVudGl0eSI7CiAgICAgIH07CiAgICAgIEVudGl0eTIuT3BlcmF0aW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29uc3QgdmFsdWVzQnlJZCA9IHt9LCB2YWx1ZXMgPSBPYmplY3QuY3JlYXRlKHZhbHVlc0J5SWQpOwogICAgICAgIHZhbHVlc1t2YWx1ZXNCeUlkWzBdID0gIkNSRUFURSJdID0gMDsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxXSA9ICJERUxFVEUiXSA9IDE7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMl0gPSAiVVBEQVRFIl0gPSAyOwogICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0oKTsKICAgICAgcmV0dXJuIEVudGl0eTI7CiAgICB9KCk7CiAgICBwcm90b2NvbDIuRXZlbnQgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gRXZlbnQocHJvcGVydGllcykgewogICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CiAgICAgICAgICBmb3IgKGxldCBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkyID0gMDsgaTIgPCBrZXlzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKHByb3BlcnRpZXNba2V5c1tpMl1dICE9IG51bGwpCiAgICAgICAgICAgICAgdGhpc1trZXlzW2kyXV0gPSBwcm9wZXJ0aWVzW2tleXNbaTJdXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgRXZlbnQucHJvdG90eXBlLm5hbWUgPSAiIjsKICAgICAgRXZlbnQucHJvdG90eXBlLnBheWxvYWQgPSAiIjsKICAgICAgRXZlbnQuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlMihwcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBFdmVudChwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgRXZlbnQuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICBpZiAoIXdyaXRlcjIpCiAgICAgICAgICB3cml0ZXIyID0gJFdyaXRlci5jcmVhdGUoKTsKICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgIm5hbWUiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAxLCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAxMAogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS5uYW1lKTsKICAgICAgICBpZiAobWVzc2FnZS5wYXlsb2FkICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInBheWxvYWQiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAyLCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAxOAogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS5wYXlsb2FkKTsKICAgICAgICByZXR1cm4gd3JpdGVyMjsKICAgICAgfTsKICAgICAgRXZlbnQuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIEV2ZW50LmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5FdmVudCgpOwogICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZCkgewogICAgICAgICAgbGV0IHRhZyA9IHJlYWRlcjIudWludDMyKCk7CiAgICAgICAgICBzd2l0Y2ggKHRhZyA+Pj4gMykgewogICAgICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgICAgICBtZXNzYWdlLm5hbWUgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMjogewogICAgICAgICAgICAgIG1lc3NhZ2UucGF5bG9hZCA9IHJlYWRlcjIuc3RyaW5nKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZWFkZXIyLnNraXBUeXBlKHRhZyAmIDcpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfTsKICAgICAgRXZlbnQuZGVjb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZGVjb2RlRGVsaW1pdGVkKHJlYWRlcjIpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gbmV3ICRSZWFkZXIocmVhZGVyMik7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICB9OwogICAgICBFdmVudC52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkKICAgICAgICAgIHJldHVybiAib2JqZWN0IGV4cGVjdGVkIjsKICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibmFtZSIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UubmFtZSkpCiAgICAgICAgICAgIHJldHVybiAibmFtZTogc3RyaW5nIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBheWxvYWQiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnBheWxvYWQpKQogICAgICAgICAgICByZXR1cm4gInBheWxvYWQ6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBFdmVudC5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuRXZlbnQpCiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIGxldCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkV2ZW50KCk7CiAgICAgICAgaWYgKG9iamVjdC5uYW1lICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLm5hbWUgPSBTdHJpbmcob2JqZWN0Lm5hbWUpOwogICAgICAgIGlmIChvYmplY3QucGF5bG9hZCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS5wYXlsb2FkID0gU3RyaW5nKG9iamVjdC5wYXlsb2FkKTsKICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfTsKICAgICAgRXZlbnQudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKCFvcHRpb25zKQogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgICAgb2JqZWN0Lm5hbWUgPSAiIjsKICAgICAgICAgIG9iamVjdC5wYXlsb2FkID0gIiI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLm5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJuYW1lIikpCiAgICAgICAgICBvYmplY3QubmFtZSA9IG1lc3NhZ2UubmFtZTsKICAgICAgICBpZiAobWVzc2FnZS5wYXlsb2FkICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgicGF5bG9hZCIpKQogICAgICAgICAgb2JqZWN0LnBheWxvYWQgPSBtZXNzYWdlLnBheWxvYWQ7CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgRXZlbnQucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCBtaW5pbWFsLnV0aWwudG9KU09OT3B0aW9ucyk7CiAgICAgIH07CiAgICAgIEV2ZW50LmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuRXZlbnQiOwogICAgICB9OwogICAgICByZXR1cm4gRXZlbnQ7CiAgICB9KCk7CiAgICBwcm90b2NvbDIuTWV0aG9kID0gZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIE1ldGhvZChwcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKICAgICAgICAgIGZvciAobGV0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaTIgPSAwOyBpMiA8IGtleXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICBpZiAocHJvcGVydGllc1trZXlzW2kyXV0gIT0gbnVsbCkKICAgICAgICAgICAgICB0aGlzW2tleXNbaTJdXSA9IHByb3BlcnRpZXNba2V5c1tpMl1dOwogICAgICAgIH0KICAgICAgfQogICAgICBNZXRob2QucHJvdG90eXBlLm5hbWUgPSAiIjsKICAgICAgTWV0aG9kLnByb3RvdHlwZS5wYXlsb2FkID0gIiI7CiAgICAgIE1ldGhvZC5jcmVhdGUgPSBmdW5jdGlvbiBjcmVhdGUyKHByb3BlcnRpZXMpIHsKICAgICAgICByZXR1cm4gbmV3IE1ldGhvZChwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgTWV0aG9kLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIyKSB7CiAgICAgICAgaWYgKCF3cml0ZXIyKQogICAgICAgICAgd3JpdGVyMiA9ICRXcml0ZXIuY3JlYXRlKCk7CiAgICAgICAgaWYgKG1lc3NhZ2UubmFtZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJuYW1lIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMSwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMTAKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UubmFtZSk7CiAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJwYXlsb2FkIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMTgKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2UucGF5bG9hZCk7CiAgICAgICAgcmV0dXJuIHdyaXRlcjI7CiAgICAgIH07CiAgICAgIE1ldGhvZC5lbmNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBlbmNvZGVEZWxpbWl0ZWQobWVzc2FnZSwgd3JpdGVyMikgewogICAgICAgIHJldHVybiB0aGlzLmVuY29kZShtZXNzYWdlLCB3cml0ZXIyKS5sZGVsaW0oKTsKICAgICAgfTsKICAgICAgTWV0aG9kLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXRob2QoKTsKICAgICAgICB3aGlsZSAocmVhZGVyMi5wb3MgPCBlbmQpIHsKICAgICAgICAgIGxldCB0YWcgPSByZWFkZXIyLnVpbnQzMigpOwogICAgICAgICAgc3dpdGNoICh0YWcgPj4+IDMpIHsKICAgICAgICAgICAgY2FzZSAxOiB7CiAgICAgICAgICAgICAgbWVzc2FnZS5uYW1lID0gcmVhZGVyMi5zdHJpbmcoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgICBtZXNzYWdlLnBheWxvYWQgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIE1ldGhvZC5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyMikgewogICAgICAgIGlmICghKHJlYWRlcjIgaW5zdGFuY2VvZiAkUmVhZGVyKSkKICAgICAgICAgIHJlYWRlcjIgPSBuZXcgJFJlYWRlcihyZWFkZXIyKTsKICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSk7CiAgICAgIH07CiAgICAgIE1ldGhvZC52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkKICAgICAgICAgIHJldHVybiAib2JqZWN0IGV4cGVjdGVkIjsKICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibmFtZSIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UubmFtZSkpCiAgICAgICAgICAgIHJldHVybiAibmFtZTogc3RyaW5nIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBheWxvYWQiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnBheWxvYWQpKQogICAgICAgICAgICByZXR1cm4gInBheWxvYWQ6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBNZXRob2QuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLk1ldGhvZCkKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgbGV0IG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuTWV0aG9kKCk7CiAgICAgICAgaWYgKG9iamVjdC5uYW1lICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLm5hbWUgPSBTdHJpbmcob2JqZWN0Lm5hbWUpOwogICAgICAgIGlmIChvYmplY3QucGF5bG9hZCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS5wYXlsb2FkID0gU3RyaW5nKG9iamVjdC5wYXlsb2FkKTsKICAgICAgICByZXR1cm4gbWVzc2FnZTsKICAgICAgfTsKICAgICAgTWV0aG9kLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgIGlmICghb3B0aW9ucykKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgaWYgKG9wdGlvbnMuZGVmYXVsdHMpIHsKICAgICAgICAgIG9iamVjdC5uYW1lID0gIiI7CiAgICAgICAgICBvYmplY3QucGF5bG9hZCA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5uYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibmFtZSIpKQogICAgICAgICAgb2JqZWN0Lm5hbWUgPSBtZXNzYWdlLm5hbWU7CiAgICAgICAgaWYgKG1lc3NhZ2UucGF5bG9hZCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBheWxvYWQiKSkKICAgICAgICAgIG9iamVjdC5wYXlsb2FkID0gbWVzc2FnZS5wYXlsb2FkOwogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH07CiAgICAgIE1ldGhvZC5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsIG1pbmltYWwudXRpbC50b0pTT05PcHRpb25zKTsKICAgICAgfTsKICAgICAgTWV0aG9kLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuTWV0aG9kIjsKICAgICAgfTsKICAgICAgcmV0dXJuIE1ldGhvZDsKICAgIH0oKTsKICAgIHByb3RvY29sMi5VcGRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gVXBkYXRlKHByb3BlcnRpZXMpIHsKICAgICAgICBpZiAocHJvcGVydGllcykgewogICAgICAgICAgZm9yIChsZXQga2V5cyA9IE9iamVjdC5rZXlzKHByb3BlcnRpZXMpLCBpMiA9IDA7IGkyIDwga2V5cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzW2tleXNbaTJdXSAhPSBudWxsKQogICAgICAgICAgICAgIHRoaXNba2V5c1tpMl1dID0gcHJvcGVydGllc1trZXlzW2kyXV07CiAgICAgICAgfQogICAgICB9CiAgICAgIFVwZGF0ZS5wcm90b3R5cGUudnggPSAwOwogICAgICBVcGRhdGUucHJvdG90eXBlLnZ5ID0gMDsKICAgICAgVXBkYXRlLnByb3RvdHlwZS52eiA9IDA7CiAgICAgIFVwZGF0ZS5wcm90b3R5cGUudm94ZWwgPSAwOwogICAgICBVcGRhdGUucHJvdG90eXBlLmxpZ2h0ID0gMDsKICAgICAgVXBkYXRlLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZTIocHJvcGVydGllcykgewogICAgICAgIHJldHVybiBuZXcgVXBkYXRlKHByb3BlcnRpZXMpOwogICAgICB9OwogICAgICBVcGRhdGUuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICBpZiAoIXdyaXRlcjIpCiAgICAgICAgICB3cml0ZXIyID0gJFdyaXRlci5jcmVhdGUoKTsKICAgICAgICBpZiAobWVzc2FnZS52eCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ2eCIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDEsIHdpcmVUeXBlIDAgPSovCiAgICAgICAgICAgIDgKICAgICAgICAgICkuaW50MzIobWVzc2FnZS52eCk7CiAgICAgICAgaWYgKG1lc3NhZ2UudnkgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidnkiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAyLCB3aXJlVHlwZSAwID0qLwogICAgICAgICAgICAxNgogICAgICAgICAgKS5pbnQzMihtZXNzYWdlLnZ5KTsKICAgICAgICBpZiAobWVzc2FnZS52eiAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ2eiIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDMsIHdpcmVUeXBlIDAgPSovCiAgICAgICAgICAgIDI0CiAgICAgICAgICApLmludDMyKG1lc3NhZ2UudnopOwogICAgICAgIGlmIChtZXNzYWdlLnZveGVsICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInZveGVsIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgNCwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgMzIKICAgICAgICAgICkudWludDMyKG1lc3NhZ2Uudm94ZWwpOwogICAgICAgIGlmIChtZXNzYWdlLmxpZ2h0ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImxpZ2h0IikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgNSwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgNDAKICAgICAgICAgICkudWludDMyKG1lc3NhZ2UubGlnaHQpOwogICAgICAgIHJldHVybiB3cml0ZXIyOwogICAgICB9OwogICAgICBVcGRhdGUuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIFVwZGF0ZS5kZWNvZGUgPSBmdW5jdGlvbiBkZWNvZGUocmVhZGVyMiwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKCEocmVhZGVyMiBpbnN0YW5jZW9mICRSZWFkZXIpKQogICAgICAgICAgcmVhZGVyMiA9ICRSZWFkZXIuY3JlYXRlKHJlYWRlcjIpOwogICAgICAgIGxldCBlbmQgPSBsZW5ndGggPT09IHZvaWQgMCA/IHJlYWRlcjIubGVuIDogcmVhZGVyMi5wb3MgKyBsZW5ndGgsIG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuVXBkYXRlKCk7CiAgICAgICAgd2hpbGUgKHJlYWRlcjIucG9zIDwgZW5kKSB7CiAgICAgICAgICBsZXQgdGFnID0gcmVhZGVyMi51aW50MzIoKTsKICAgICAgICAgIHN3aXRjaCAodGFnID4+PiAzKSB7CiAgICAgICAgICAgIGNhc2UgMTogewogICAgICAgICAgICAgIG1lc3NhZ2UudnggPSByZWFkZXIyLmludDMyKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAyOiB7CiAgICAgICAgICAgICAgbWVzc2FnZS52eSA9IHJlYWRlcjIuaW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgICBtZXNzYWdlLnZ6ID0gcmVhZGVyMi5pbnQzMigpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNDogewogICAgICAgICAgICAgIG1lc3NhZ2Uudm94ZWwgPSByZWFkZXIyLnVpbnQzMigpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNTogewogICAgICAgICAgICAgIG1lc3NhZ2UubGlnaHQgPSByZWFkZXIyLnVpbnQzMigpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIFVwZGF0ZS5kZWNvZGVEZWxpbWl0ZWQgPSBmdW5jdGlvbiBkZWNvZGVEZWxpbWl0ZWQocmVhZGVyMikgewogICAgICAgIGlmICghKHJlYWRlcjIgaW5zdGFuY2VvZiAkUmVhZGVyKSkKICAgICAgICAgIHJlYWRlcjIgPSBuZXcgJFJlYWRlcihyZWFkZXIyKTsKICAgICAgICByZXR1cm4gdGhpcy5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSk7CiAgICAgIH07CiAgICAgIFVwZGF0ZS52ZXJpZnkgPSBmdW5jdGlvbiB2ZXJpZnkobWVzc2FnZSkgewogICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gIm9iamVjdCIgfHwgbWVzc2FnZSA9PT0gbnVsbCkKICAgICAgICAgIHJldHVybiAib2JqZWN0IGV4cGVjdGVkIjsKICAgICAgICBpZiAobWVzc2FnZS52eCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInZ4IikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2UudngpKQogICAgICAgICAgICByZXR1cm4gInZ4OiBpbnRlZ2VyIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UudnkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eSIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzSW50ZWdlcihtZXNzYWdlLnZ5KSkKICAgICAgICAgICAgcmV0dXJuICJ2eTogaW50ZWdlciBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnZ6ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidnoiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc0ludGVnZXIobWVzc2FnZS52eikpCiAgICAgICAgICAgIHJldHVybiAidno6IGludGVnZXIgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS52b3hlbCAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInZveGVsIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNJbnRlZ2VyKG1lc3NhZ2Uudm94ZWwpKQogICAgICAgICAgICByZXR1cm4gInZveGVsOiBpbnRlZ2VyIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodCIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzSW50ZWdlcihtZXNzYWdlLmxpZ2h0KSkKICAgICAgICAgICAgcmV0dXJuICJsaWdodDogaW50ZWdlciBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBVcGRhdGUuZnJvbU9iamVjdCA9IGZ1bmN0aW9uIGZyb21PYmplY3Qob2JqZWN0KSB7CiAgICAgICAgaWYgKG9iamVjdCBpbnN0YW5jZW9mICRyb290LnByb3RvY29sLlVwZGF0ZSkKICAgICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgICAgbGV0IG1lc3NhZ2UgPSBuZXcgJHJvb3QucHJvdG9jb2wuVXBkYXRlKCk7CiAgICAgICAgaWYgKG9iamVjdC52eCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS52eCA9IG9iamVjdC52eCB8IDA7CiAgICAgICAgaWYgKG9iamVjdC52eSAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS52eSA9IG9iamVjdC52eSB8IDA7CiAgICAgICAgaWYgKG9iamVjdC52eiAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS52eiA9IG9iamVjdC52eiB8IDA7CiAgICAgICAgaWYgKG9iamVjdC52b3hlbCAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS52b3hlbCA9IG9iamVjdC52b3hlbCA+Pj4gMDsKICAgICAgICBpZiAob2JqZWN0LmxpZ2h0ICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLmxpZ2h0ID0gb2JqZWN0LmxpZ2h0ID4+PiAwOwogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9OwogICAgICBVcGRhdGUudG9PYmplY3QgPSBmdW5jdGlvbiB0b09iamVjdChtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKCFvcHRpb25zKQogICAgICAgICAgb3B0aW9ucyA9IHt9OwogICAgICAgIGxldCBvYmplY3QgPSB7fTsKICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgICAgb2JqZWN0LnZ4ID0gMDsKICAgICAgICAgIG9iamVjdC52eSA9IDA7CiAgICAgICAgICBvYmplY3QudnogPSAwOwogICAgICAgICAgb2JqZWN0LnZveGVsID0gMDsKICAgICAgICAgIG9iamVjdC5saWdodCA9IDA7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnZ4ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidngiKSkKICAgICAgICAgIG9iamVjdC52eCA9IG1lc3NhZ2Uudng7CiAgICAgICAgaWYgKG1lc3NhZ2UudnkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ2eSIpKQogICAgICAgICAgb2JqZWN0LnZ5ID0gbWVzc2FnZS52eTsKICAgICAgICBpZiAobWVzc2FnZS52eiAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInZ6IikpCiAgICAgICAgICBvYmplY3QudnogPSBtZXNzYWdlLnZ6OwogICAgICAgIGlmIChtZXNzYWdlLnZveGVsICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidm94ZWwiKSkKICAgICAgICAgIG9iamVjdC52b3hlbCA9IG1lc3NhZ2Uudm94ZWw7CiAgICAgICAgaWYgKG1lc3NhZ2UubGlnaHQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJsaWdodCIpKQogICAgICAgICAgb2JqZWN0LmxpZ2h0ID0gbWVzc2FnZS5saWdodDsKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9OwogICAgICBVcGRhdGUucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCBtaW5pbWFsLnV0aWwudG9KU09OT3B0aW9ucyk7CiAgICAgIH07CiAgICAgIFVwZGF0ZS5nZXRUeXBlVXJsID0gZnVuY3Rpb24gZ2V0VHlwZVVybCh0eXBlVXJsUHJlZml4KSB7CiAgICAgICAgaWYgKHR5cGVVcmxQcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgdHlwZVVybFByZWZpeCA9ICJ0eXBlLmdvb2dsZWFwaXMuY29tIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHR5cGVVcmxQcmVmaXggKyAiL3Byb3RvY29sLlVwZGF0ZSI7CiAgICAgIH07CiAgICAgIHJldHVybiBVcGRhdGU7CiAgICB9KCk7CiAgICBwcm90b2NvbDIuQ2hhdE1lc3NhZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gQ2hhdE1lc3NhZ2UocHJvcGVydGllcykgewogICAgICAgIGlmIChwcm9wZXJ0aWVzKSB7CiAgICAgICAgICBmb3IgKGxldCBrZXlzID0gT2JqZWN0LmtleXMocHJvcGVydGllcyksIGkyID0gMDsgaTIgPCBrZXlzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgaWYgKHByb3BlcnRpZXNba2V5c1tpMl1dICE9IG51bGwpCiAgICAgICAgICAgICAgdGhpc1trZXlzW2kyXV0gPSBwcm9wZXJ0aWVzW2tleXNbaTJdXTsKICAgICAgICB9CiAgICAgIH0KICAgICAgQ2hhdE1lc3NhZ2UucHJvdG90eXBlLnR5cGUgPSAiIjsKICAgICAgQ2hhdE1lc3NhZ2UucHJvdG90eXBlLnNlbmRlciA9ICIiOwogICAgICBDaGF0TWVzc2FnZS5wcm90b3R5cGUuYm9keSA9ICIiOwogICAgICBDaGF0TWVzc2FnZS5wcm90b3R5cGUubWV0YWRhdGEgPSAiIjsKICAgICAgQ2hhdE1lc3NhZ2UuY3JlYXRlID0gZnVuY3Rpb24gY3JlYXRlMihwcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIG5ldyBDaGF0TWVzc2FnZShwcm9wZXJ0aWVzKTsKICAgICAgfTsKICAgICAgQ2hhdE1lc3NhZ2UuZW5jb2RlID0gZnVuY3Rpb24gZW5jb2RlKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICBpZiAoIXdyaXRlcjIpCiAgICAgICAgICB3cml0ZXIyID0gJFdyaXRlci5jcmVhdGUoKTsKICAgICAgICBpZiAobWVzc2FnZS50eXBlICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgInR5cGUiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAxLCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAxMAogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS50eXBlKTsKICAgICAgICBpZiAobWVzc2FnZS5zZW5kZXIgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAic2VuZGVyIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMiwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgMTgKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2Uuc2VuZGVyKTsKICAgICAgICBpZiAobWVzc2FnZS5ib2R5ICE9IG51bGwgJiYgT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgImJvZHkiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAzLCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAyNgogICAgICAgICAgKS5zdHJpbmcobWVzc2FnZS5ib2R5KTsKICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJtZXRhZGF0YSIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDQsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDM0CiAgICAgICAgICApLnN0cmluZyhtZXNzYWdlLm1ldGFkYXRhKTsKICAgICAgICByZXR1cm4gd3JpdGVyMjsKICAgICAgfTsKICAgICAgQ2hhdE1lc3NhZ2UuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIENoYXRNZXNzYWdlLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5DaGF0TWVzc2FnZSgpOwogICAgICAgIHdoaWxlIChyZWFkZXIyLnBvcyA8IGVuZCkgewogICAgICAgICAgbGV0IHRhZyA9IHJlYWRlcjIudWludDMyKCk7CiAgICAgICAgICBzd2l0Y2ggKHRhZyA+Pj4gMykgewogICAgICAgICAgICBjYXNlIDE6IHsKICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMjogewogICAgICAgICAgICAgIG1lc3NhZ2Uuc2VuZGVyID0gcmVhZGVyMi5zdHJpbmcoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDM6IHsKICAgICAgICAgICAgICBtZXNzYWdlLmJvZHkgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNDogewogICAgICAgICAgICAgIG1lc3NhZ2UubWV0YWRhdGEgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIENoYXRNZXNzYWdlLmRlY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZChyZWFkZXIyKSB7CiAgICAgICAgaWYgKCEocmVhZGVyMiBpbnN0YW5jZW9mICRSZWFkZXIpKQogICAgICAgICAgcmVhZGVyMiA9IG5ldyAkUmVhZGVyKHJlYWRlcjIpOwogICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIyLCByZWFkZXIyLnVpbnQzMigpKTsKICAgICAgfTsKICAgICAgQ2hhdE1lc3NhZ2UudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IG1lc3NhZ2UgPT09IG51bGwpCiAgICAgICAgICByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkgewogICAgICAgICAgaWYgKCEkdXRpbC5pc1N0cmluZyhtZXNzYWdlLnR5cGUpKQogICAgICAgICAgICByZXR1cm4gInR5cGU6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnNlbmRlciAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInNlbmRlciIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2Uuc2VuZGVyKSkKICAgICAgICAgICAgcmV0dXJuICJzZW5kZXI6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmJvZHkgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJib2R5IikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5ib2R5KSkKICAgICAgICAgICAgcmV0dXJuICJib2R5OiBzdHJpbmcgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5tZXRhZGF0YSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoIm1ldGFkYXRhIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5tZXRhZGF0YSkpCiAgICAgICAgICAgIHJldHVybiAibWV0YWRhdGE6IHN0cmluZyBleHBlY3RlZCI7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9OwogICAgICBDaGF0TWVzc2FnZS5mcm9tT2JqZWN0ID0gZnVuY3Rpb24gZnJvbU9iamVjdChvYmplY3QpIHsKICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgJHJvb3QucHJvdG9jb2wuQ2hhdE1lc3NhZ2UpCiAgICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICAgIGxldCBtZXNzYWdlID0gbmV3ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlKCk7CiAgICAgICAgaWYgKG9iamVjdC50eXBlICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLnR5cGUgPSBTdHJpbmcob2JqZWN0LnR5cGUpOwogICAgICAgIGlmIChvYmplY3Quc2VuZGVyICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLnNlbmRlciA9IFN0cmluZyhvYmplY3Quc2VuZGVyKTsKICAgICAgICBpZiAob2JqZWN0LmJvZHkgIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UuYm9keSA9IFN0cmluZyhvYmplY3QuYm9keSk7CiAgICAgICAgaWYgKG9iamVjdC5tZXRhZGF0YSAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS5tZXRhZGF0YSA9IFN0cmluZyhvYmplY3QubWV0YWRhdGEpOwogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9OwogICAgICBDaGF0TWVzc2FnZS50b09iamVjdCA9IGZ1bmN0aW9uIHRvT2JqZWN0KG1lc3NhZ2UsIG9wdGlvbnMpIHsKICAgICAgICBpZiAoIW9wdGlvbnMpCiAgICAgICAgICBvcHRpb25zID0ge307CiAgICAgICAgbGV0IG9iamVjdCA9IHt9OwogICAgICAgIGlmIChvcHRpb25zLmRlZmF1bHRzKSB7CiAgICAgICAgICBvYmplY3QudHlwZSA9ICIiOwogICAgICAgICAgb2JqZWN0LnNlbmRlciA9ICIiOwogICAgICAgICAgb2JqZWN0LmJvZHkgPSAiIjsKICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9ICIiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS50eXBlICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidHlwZSIpKQogICAgICAgICAgb2JqZWN0LnR5cGUgPSBtZXNzYWdlLnR5cGU7CiAgICAgICAgaWYgKG1lc3NhZ2Uuc2VuZGVyICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgic2VuZGVyIikpCiAgICAgICAgICBvYmplY3Quc2VuZGVyID0gbWVzc2FnZS5zZW5kZXI7CiAgICAgICAgaWYgKG1lc3NhZ2UuYm9keSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImJvZHkiKSkKICAgICAgICAgIG9iamVjdC5ib2R5ID0gbWVzc2FnZS5ib2R5OwogICAgICAgIGlmIChtZXNzYWdlLm1ldGFkYXRhICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibWV0YWRhdGEiKSkKICAgICAgICAgIG9iamVjdC5tZXRhZGF0YSA9IG1lc3NhZ2UubWV0YWRhdGE7CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgQ2hhdE1lc3NhZ2UucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uIHRvSlNPTigpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvci50b09iamVjdCh0aGlzLCBtaW5pbWFsLnV0aWwudG9KU09OT3B0aW9ucyk7CiAgICAgIH07CiAgICAgIENoYXRNZXNzYWdlLmdldFR5cGVVcmwgPSBmdW5jdGlvbiBnZXRUeXBlVXJsKHR5cGVVcmxQcmVmaXgpIHsKICAgICAgICBpZiAodHlwZVVybFByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICB0eXBlVXJsUHJlZml4ID0gInR5cGUuZ29vZ2xlYXBpcy5jb20iOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHlwZVVybFByZWZpeCArICIvcHJvdG9jb2wuQ2hhdE1lc3NhZ2UiOwogICAgICB9OwogICAgICByZXR1cm4gQ2hhdE1lc3NhZ2U7CiAgICB9KCk7CiAgICBwcm90b2NvbDIuTWVzc2FnZSA9IGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBNZXNzYWdlMihwcm9wZXJ0aWVzKSB7CiAgICAgICAgdGhpcy5wZWVycyA9IFtdOwogICAgICAgIHRoaXMuZW50aXRpZXMgPSBbXTsKICAgICAgICB0aGlzLmNodW5rcyA9IFtdOwogICAgICAgIHRoaXMuZXZlbnRzID0gW107CiAgICAgICAgdGhpcy51cGRhdGVzID0gW107CiAgICAgICAgaWYgKHByb3BlcnRpZXMpIHsKICAgICAgICAgIGZvciAobGV0IGtleXMgPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKSwgaTIgPSAwOyBpMiA8IGtleXMubGVuZ3RoOyArK2kyKQogICAgICAgICAgICBpZiAocHJvcGVydGllc1trZXlzW2kyXV0gIT0gbnVsbCkKICAgICAgICAgICAgICB0aGlzW2tleXNbaTJdXSA9IHByb3BlcnRpZXNba2V5c1tpMl1dOwogICAgICAgIH0KICAgICAgfQogICAgICBNZXNzYWdlMi5wcm90b3R5cGUudHlwZSA9IDA7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS5qc29uID0gIiI7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS50ZXh0ID0gIiI7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS5tZXRob2QgPSBudWxsOwogICAgICBNZXNzYWdlMi5wcm90b3R5cGUuY2hhdCA9IG51bGw7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS5wZWVycyA9ICR1dGlsLmVtcHR5QXJyYXk7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS5lbnRpdGllcyA9ICR1dGlsLmVtcHR5QXJyYXk7CiAgICAgIE1lc3NhZ2UyLnByb3RvdHlwZS5jaHVua3MgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBNZXNzYWdlMi5wcm90b3R5cGUuZXZlbnRzID0gJHV0aWwuZW1wdHlBcnJheTsKICAgICAgTWVzc2FnZTIucHJvdG90eXBlLnVwZGF0ZXMgPSAkdXRpbC5lbXB0eUFycmF5OwogICAgICBNZXNzYWdlMi5wcm90b3R5cGUud29ybGROYW1lID0gIiI7CiAgICAgIE1lc3NhZ2UyLmNyZWF0ZSA9IGZ1bmN0aW9uIGNyZWF0ZTIocHJvcGVydGllcykgewogICAgICAgIHJldHVybiBuZXcgTWVzc2FnZTIocHJvcGVydGllcyk7CiAgICAgIH07CiAgICAgIE1lc3NhZ2UyLmVuY29kZSA9IGZ1bmN0aW9uIGVuY29kZShtZXNzYWdlLCB3cml0ZXIyKSB7CiAgICAgICAgaWYgKCF3cml0ZXIyKQogICAgICAgICAgd3JpdGVyMiA9ICRXcml0ZXIuY3JlYXRlKCk7CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ0eXBlIikpCiAgICAgICAgICB3cml0ZXIyLnVpbnQzMigKICAgICAgICAgICAgLyogaWQgMSwgd2lyZVR5cGUgMCA9Ki8KICAgICAgICAgICAgOAogICAgICAgICAgKS5pbnQzMihtZXNzYWdlLnR5cGUpOwogICAgICAgIGlmIChtZXNzYWdlLmpzb24gIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAianNvbiIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDIsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDE4CiAgICAgICAgICApLnN0cmluZyhtZXNzYWdlLmpzb24pOwogICAgICAgIGlmIChtZXNzYWdlLnRleHQgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAidGV4dCIpKQogICAgICAgICAgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDMsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDI2CiAgICAgICAgICApLnN0cmluZyhtZXNzYWdlLnRleHQpOwogICAgICAgIGlmIChtZXNzYWdlLm1ldGhvZCAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJtZXRob2QiKSkKICAgICAgICAgICRyb290LnByb3RvY29sLk1ldGhvZC5lbmNvZGUobWVzc2FnZS5tZXRob2QsIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCA0LCB3aXJlVHlwZSAyID0qLwogICAgICAgICAgICAzNAogICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLmNoYXQgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCAiY2hhdCIpKQogICAgICAgICAgJHJvb3QucHJvdG9jb2wuQ2hhdE1lc3NhZ2UuZW5jb2RlKG1lc3NhZ2UuY2hhdCwgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgIC8qIGlkIDUsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgIDQyCiAgICAgICAgICApLmZvcmsoKSkubGRlbGltKCk7CiAgICAgICAgaWYgKG1lc3NhZ2UucGVlcnMgIT0gbnVsbCAmJiBtZXNzYWdlLnBlZXJzLmxlbmd0aCkKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLnBlZXJzLmxlbmd0aDsgKytpMikKICAgICAgICAgICAgJHJvb3QucHJvdG9jb2wuUGVlci5lbmNvZGUobWVzc2FnZS5wZWVyc1tpMl0sIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAgIC8qIGlkIDYsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgNTAKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLmVudGl0aWVzICE9IG51bGwgJiYgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGgpCiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgICRyb290LnByb3RvY29sLkVudGl0eS5lbmNvZGUobWVzc2FnZS5lbnRpdGllc1tpMl0sIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAgIC8qIGlkIDcsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgNTgKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLmNodW5rcyAhPSBudWxsICYmIG1lc3NhZ2UuY2h1bmtzLmxlbmd0aCkKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLmNodW5rcy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgICRyb290LnByb3RvY29sLkNodW5rLmVuY29kZShtZXNzYWdlLmNodW5rc1tpMl0sIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAgIC8qIGlkIDgsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgNjYKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLmV2ZW50cyAhPSBudWxsICYmIG1lc3NhZ2UuZXZlbnRzLmxlbmd0aCkKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBtZXNzYWdlLmV2ZW50cy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgICRyb290LnByb3RvY29sLkV2ZW50LmVuY29kZShtZXNzYWdlLmV2ZW50c1tpMl0sIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAgIC8qIGlkIDksIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgNzQKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLnVwZGF0ZXMgIT0gbnVsbCAmJiBtZXNzYWdlLnVwZGF0ZXMubGVuZ3RoKQogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UudXBkYXRlcy5sZW5ndGg7ICsraTIpCiAgICAgICAgICAgICRyb290LnByb3RvY29sLlVwZGF0ZS5lbmNvZGUobWVzc2FnZS51cGRhdGVzW2kyXSwgd3JpdGVyMi51aW50MzIoCiAgICAgICAgICAgICAgLyogaWQgMTAsIHdpcmVUeXBlIDIgPSovCiAgICAgICAgICAgICAgODIKICAgICAgICAgICAgKS5mb3JrKCkpLmxkZWxpbSgpOwogICAgICAgIGlmIChtZXNzYWdlLndvcmxkTmFtZSAhPSBudWxsICYmIE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsICJ3b3JsZE5hbWUiKSkKICAgICAgICAgIHdyaXRlcjIudWludDMyKAogICAgICAgICAgICAvKiBpZCAxMSwgd2lyZVR5cGUgMiA9Ki8KICAgICAgICAgICAgOTAKICAgICAgICAgICkuc3RyaW5nKG1lc3NhZ2Uud29ybGROYW1lKTsKICAgICAgICByZXR1cm4gd3JpdGVyMjsKICAgICAgfTsKICAgICAgTWVzc2FnZTIuZW5jb2RlRGVsaW1pdGVkID0gZnVuY3Rpb24gZW5jb2RlRGVsaW1pdGVkKG1lc3NhZ2UsIHdyaXRlcjIpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbmNvZGUobWVzc2FnZSwgd3JpdGVyMikubGRlbGltKCk7CiAgICAgIH07CiAgICAgIE1lc3NhZ2UyLmRlY29kZSA9IGZ1bmN0aW9uIGRlY29kZShyZWFkZXIyLCBsZW5ndGgpIHsKICAgICAgICBpZiAoIShyZWFkZXIyIGluc3RhbmNlb2YgJFJlYWRlcikpCiAgICAgICAgICByZWFkZXIyID0gJFJlYWRlci5jcmVhdGUocmVhZGVyMik7CiAgICAgICAgbGV0IGVuZCA9IGxlbmd0aCA9PT0gdm9pZCAwID8gcmVhZGVyMi5sZW4gOiByZWFkZXIyLnBvcyArIGxlbmd0aCwgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXNzYWdlKCk7CiAgICAgICAgd2hpbGUgKHJlYWRlcjIucG9zIDwgZW5kKSB7CiAgICAgICAgICBsZXQgdGFnID0gcmVhZGVyMi51aW50MzIoKTsKICAgICAgICAgIHN3aXRjaCAodGFnID4+PiAzKSB7CiAgICAgICAgICAgIGNhc2UgMTogewogICAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IHJlYWRlcjIuaW50MzIoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDI6IHsKICAgICAgICAgICAgICBtZXNzYWdlLmpzb24gPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMzogewogICAgICAgICAgICAgIG1lc3NhZ2UudGV4dCA9IHJlYWRlcjIuc3RyaW5nKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA0OiB7CiAgICAgICAgICAgICAgbWVzc2FnZS5tZXRob2QgPSAkcm9vdC5wcm90b2NvbC5NZXRob2QuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNTogewogICAgICAgICAgICAgIG1lc3NhZ2UuY2hhdCA9ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlLmRlY29kZShyZWFkZXIyLCByZWFkZXIyLnVpbnQzMigpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDY6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLnBlZXJzICYmIG1lc3NhZ2UucGVlcnMubGVuZ3RoKSkKICAgICAgICAgICAgICAgIG1lc3NhZ2UucGVlcnMgPSBbXTsKICAgICAgICAgICAgICBtZXNzYWdlLnBlZXJzLnB1c2goJHJvb3QucHJvdG9jb2wuUGVlci5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgNzogewogICAgICAgICAgICAgIGlmICghKG1lc3NhZ2UuZW50aXRpZXMgJiYgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS5lbnRpdGllcyA9IFtdOwogICAgICAgICAgICAgIG1lc3NhZ2UuZW50aXRpZXMucHVzaCgkcm9vdC5wcm90b2NvbC5FbnRpdHkuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDg6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLmNodW5rcyAmJiBtZXNzYWdlLmNodW5rcy5sZW5ndGgpKQogICAgICAgICAgICAgICAgbWVzc2FnZS5jaHVua3MgPSBbXTsKICAgICAgICAgICAgICBtZXNzYWdlLmNodW5rcy5wdXNoKCRyb290LnByb3RvY29sLkNodW5rLmRlY29kZShyZWFkZXIyLCByZWFkZXIyLnVpbnQzMigpKSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSA5OiB7CiAgICAgICAgICAgICAgaWYgKCEobWVzc2FnZS5ldmVudHMgJiYgbWVzc2FnZS5ldmVudHMubGVuZ3RoKSkKICAgICAgICAgICAgICAgIG1lc3NhZ2UuZXZlbnRzID0gW107CiAgICAgICAgICAgICAgbWVzc2FnZS5ldmVudHMucHVzaCgkcm9vdC5wcm90b2NvbC5FdmVudC5kZWNvZGUocmVhZGVyMiwgcmVhZGVyMi51aW50MzIoKSkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgMTA6IHsKICAgICAgICAgICAgICBpZiAoIShtZXNzYWdlLnVwZGF0ZXMgJiYgbWVzc2FnZS51cGRhdGVzLmxlbmd0aCkpCiAgICAgICAgICAgICAgICBtZXNzYWdlLnVwZGF0ZXMgPSBbXTsKICAgICAgICAgICAgICBtZXNzYWdlLnVwZGF0ZXMucHVzaCgkcm9vdC5wcm90b2NvbC5VcGRhdGUuZGVjb2RlKHJlYWRlcjIsIHJlYWRlcjIudWludDMyKCkpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIDExOiB7CiAgICAgICAgICAgICAgbWVzc2FnZS53b3JsZE5hbWUgPSByZWFkZXIyLnN0cmluZygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmVhZGVyMi5za2lwVHlwZSh0YWcgJiA3KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIE1lc3NhZ2UyLmRlY29kZURlbGltaXRlZCA9IGZ1bmN0aW9uIGRlY29kZURlbGltaXRlZChyZWFkZXIyKSB7CiAgICAgICAgaWYgKCEocmVhZGVyMiBpbnN0YW5jZW9mICRSZWFkZXIpKQogICAgICAgICAgcmVhZGVyMiA9IG5ldyAkUmVhZGVyKHJlYWRlcjIpOwogICAgICAgIHJldHVybiB0aGlzLmRlY29kZShyZWFkZXIyLCByZWFkZXIyLnVpbnQzMigpKTsKICAgICAgfTsKICAgICAgTWVzc2FnZTIudmVyaWZ5ID0gZnVuY3Rpb24gdmVyaWZ5KG1lc3NhZ2UpIHsKICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgIT09ICJvYmplY3QiIHx8IG1lc3NhZ2UgPT09IG51bGwpCiAgICAgICAgICByZXR1cm4gIm9iamVjdCBleHBlY3RlZCI7CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkKICAgICAgICAgIHN3aXRjaCAobWVzc2FnZS50eXBlKSB7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICJ0eXBlOiBlbnVtIHZhbHVlIGV4cGVjdGVkIjsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICBjYXNlIDc6CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSA5OgogICAgICAgICAgICBjYXNlIDEwOgogICAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICBjYXNlIDEzOgogICAgICAgICAgICBjYXNlIDE0OgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmpzb24gIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJqc29uIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS5qc29uKSkKICAgICAgICAgICAgcmV0dXJuICJqc29uOiBzdHJpbmcgZXhwZWN0ZWQiOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS50ZXh0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidGV4dCIpKSB7CiAgICAgICAgICBpZiAoISR1dGlsLmlzU3RyaW5nKG1lc3NhZ2UudGV4dCkpCiAgICAgICAgICAgIHJldHVybiAidGV4dDogc3RyaW5nIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UubWV0aG9kICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibWV0aG9kIikpIHsKICAgICAgICAgIGxldCBlcnJvciA9ICRyb290LnByb3RvY29sLk1ldGhvZC52ZXJpZnkobWVzc2FnZS5tZXRob2QpOwogICAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgICByZXR1cm4gIm1ldGhvZC4iICsgZXJyb3I7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmNoYXQgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJjaGF0IikpIHsKICAgICAgICAgIGxldCBlcnJvciA9ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlLnZlcmlmeShtZXNzYWdlLmNoYXQpOwogICAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgICByZXR1cm4gImNoYXQuIiArIGVycm9yOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5wZWVycyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInBlZXJzIikpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLnBlZXJzKSkKICAgICAgICAgICAgcmV0dXJuICJwZWVyczogYXJyYXkgZXhwZWN0ZWQiOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UucGVlcnMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGxldCBlcnJvciA9ICRyb290LnByb3RvY29sLlBlZXIudmVyaWZ5KG1lc3NhZ2UucGVlcnNbaTJdKTsKICAgICAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgICAgIHJldHVybiAicGVlcnMuIiArIGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5lbnRpdGllcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImVudGl0aWVzIikpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLmVudGl0aWVzKSkKICAgICAgICAgICAgcmV0dXJuICJlbnRpdGllczogYXJyYXkgZXhwZWN0ZWQiOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UuZW50aXRpZXMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGxldCBlcnJvciA9ICRyb290LnByb3RvY29sLkVudGl0eS52ZXJpZnkobWVzc2FnZS5lbnRpdGllc1tpMl0pOwogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuICJlbnRpdGllcy4iICsgZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmNodW5rcyAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoImNodW5rcyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS5jaHVua3MpKQogICAgICAgICAgICByZXR1cm4gImNodW5rczogYXJyYXkgZXhwZWN0ZWQiOwogICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IG1lc3NhZ2UuY2h1bmtzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBsZXQgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5DaHVuay52ZXJpZnkobWVzc2FnZS5jaHVua3NbaTJdKTsKICAgICAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgICAgIHJldHVybiAiY2h1bmtzLiIgKyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UuZXZlbnRzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiZXZlbnRzIikpIHsKICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShtZXNzYWdlLmV2ZW50cykpCiAgICAgICAgICAgIHJldHVybiAiZXZlbnRzOiBhcnJheSBleHBlY3RlZCI7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS5ldmVudHMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGxldCBlcnJvciA9ICRyb290LnByb3RvY29sLkV2ZW50LnZlcmlmeShtZXNzYWdlLmV2ZW50c1tpMl0pOwogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuICJldmVudHMuIiArIGVycm9yOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS51cGRhdGVzICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidXBkYXRlcyIpKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkobWVzc2FnZS51cGRhdGVzKSkKICAgICAgICAgICAgcmV0dXJuICJ1cGRhdGVzOiBhcnJheSBleHBlY3RlZCI7CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgbWVzc2FnZS51cGRhdGVzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBsZXQgZXJyb3IgPSAkcm9vdC5wcm90b2NvbC5VcGRhdGUudmVyaWZ5KG1lc3NhZ2UudXBkYXRlc1tpMl0pOwogICAgICAgICAgICBpZiAoZXJyb3IpCiAgICAgICAgICAgICAgcmV0dXJuICJ1cGRhdGVzLiIgKyBlcnJvcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2Uud29ybGROYW1lICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgid29ybGROYW1lIikpIHsKICAgICAgICAgIGlmICghJHV0aWwuaXNTdHJpbmcobWVzc2FnZS53b3JsZE5hbWUpKQogICAgICAgICAgICByZXR1cm4gIndvcmxkTmFtZTogc3RyaW5nIGV4cGVjdGVkIjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH07CiAgICAgIE1lc3NhZ2UyLmZyb21PYmplY3QgPSBmdW5jdGlvbiBmcm9tT2JqZWN0KG9iamVjdCkgewogICAgICAgIGlmIChvYmplY3QgaW5zdGFuY2VvZiAkcm9vdC5wcm90b2NvbC5NZXNzYWdlKQogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICBsZXQgbWVzc2FnZSA9IG5ldyAkcm9vdC5wcm90b2NvbC5NZXNzYWdlKCk7CiAgICAgICAgc3dpdGNoIChvYmplY3QudHlwZSkgewogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QudHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSBvYmplY3QudHlwZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIklOSVQiOgogICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAwOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIkpPSU4iOgogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIkxFQVZFIjoKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJFUlJPUiI6CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDM7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiUEVFUiI6CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiRU5USVRZIjoKICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gNTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJMT0FEIjoKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gNjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJVTkxPQUQiOgogICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSA3OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIlVQREFURSI6CiAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDg7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiTUVUSE9EIjoKICAgICAgICAgIGNhc2UgOToKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gOTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJDSEFUIjoKICAgICAgICAgIGNhc2UgMTA6CiAgICAgICAgICAgIG1lc3NhZ2UudHlwZSA9IDEwOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgIlRSQU5TUE9SVCI6CiAgICAgICAgICBjYXNlIDExOgogICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAxMTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJFVkVOVCI6CiAgICAgICAgICBjYXNlIDEyOgogICAgICAgICAgICBtZXNzYWdlLnR5cGUgPSAxMjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICJBQ1RJT04iOgogICAgICAgICAgY2FzZSAxMzoKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMTM7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSAiU1RBVFMiOgogICAgICAgICAgY2FzZSAxNDoKICAgICAgICAgICAgbWVzc2FnZS50eXBlID0gMTQ7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0Lmpzb24gIT0gbnVsbCkKICAgICAgICAgIG1lc3NhZ2UuanNvbiA9IFN0cmluZyhvYmplY3QuanNvbik7CiAgICAgICAgaWYgKG9iamVjdC50ZXh0ICE9IG51bGwpCiAgICAgICAgICBtZXNzYWdlLnRleHQgPSBTdHJpbmcob2JqZWN0LnRleHQpOwogICAgICAgIGlmIChvYmplY3QubWV0aG9kICE9IG51bGwpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0Lm1ldGhvZCAhPT0gIm9iamVjdCIpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UubWV0aG9kOiBvYmplY3QgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UubWV0aG9kID0gJHJvb3QucHJvdG9jb2wuTWV0aG9kLmZyb21PYmplY3Qob2JqZWN0Lm1ldGhvZCk7CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QuY2hhdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5jaGF0ICE9PSAib2JqZWN0IikKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5jaGF0OiBvYmplY3QgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UuY2hhdCA9ICRyb290LnByb3RvY29sLkNoYXRNZXNzYWdlLmZyb21PYmplY3Qob2JqZWN0LmNoYXQpOwogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0LnBlZXJzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LnBlZXJzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5wZWVyczogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UucGVlcnMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QucGVlcnMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LnBlZXJzW2kyXSAhPT0gIm9iamVjdCIpCiAgICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5wZWVyczogb2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgICAgIG1lc3NhZ2UucGVlcnNbaTJdID0gJHJvb3QucHJvdG9jb2wuUGVlci5mcm9tT2JqZWN0KG9iamVjdC5wZWVyc1tpMl0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0LmVudGl0aWVzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LmVudGl0aWVzKSkKICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5lbnRpdGllczogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UuZW50aXRpZXMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QuZW50aXRpZXMubGVuZ3RoOyArK2kyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0LmVudGl0aWVzW2kyXSAhPT0gIm9iamVjdCIpCiAgICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5lbnRpdGllczogb2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgICAgIG1lc3NhZ2UuZW50aXRpZXNbaTJdID0gJHJvb3QucHJvdG9jb2wuRW50aXR5LmZyb21PYmplY3Qob2JqZWN0LmVudGl0aWVzW2kyXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChvYmplY3QuY2h1bmtzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LmNodW5rcykpCiAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UuY2h1bmtzOiBhcnJheSBleHBlY3RlZCIpOwogICAgICAgICAgbWVzc2FnZS5jaHVua3MgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QuY2h1bmtzLmxlbmd0aDsgKytpMikgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdC5jaHVua3NbaTJdICE9PSAib2JqZWN0IikKICAgICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNzYWdlLmNodW5rczogb2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgICAgIG1lc3NhZ2UuY2h1bmtzW2kyXSA9ICRyb290LnByb3RvY29sLkNodW5rLmZyb21PYmplY3Qob2JqZWN0LmNodW5rc1tpMl0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0LmV2ZW50cykgewogICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KG9iamVjdC5ldmVudHMpKQogICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNzYWdlLmV2ZW50czogYXJyYXkgZXhwZWN0ZWQiKTsKICAgICAgICAgIG1lc3NhZ2UuZXZlbnRzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpMiA9IDA7IGkyIDwgb2JqZWN0LmV2ZW50cy5sZW5ndGg7ICsraTIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QuZXZlbnRzW2kyXSAhPT0gIm9iamVjdCIpCiAgICAgICAgICAgICAgdGhyb3cgVHlwZUVycm9yKCIucHJvdG9jb2wuTWVzc2FnZS5ldmVudHM6IG9iamVjdCBleHBlY3RlZCIpOwogICAgICAgICAgICBtZXNzYWdlLmV2ZW50c1tpMl0gPSAkcm9vdC5wcm90b2NvbC5FdmVudC5mcm9tT2JqZWN0KG9iamVjdC5ldmVudHNbaTJdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKG9iamVjdC51cGRhdGVzKSB7CiAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkob2JqZWN0LnVwZGF0ZXMpKQogICAgICAgICAgICB0aHJvdyBUeXBlRXJyb3IoIi5wcm90b2NvbC5NZXNzYWdlLnVwZGF0ZXM6IGFycmF5IGV4cGVjdGVkIik7CiAgICAgICAgICBtZXNzYWdlLnVwZGF0ZXMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGkyID0gMDsgaTIgPCBvYmplY3QudXBkYXRlcy5sZW5ndGg7ICsraTIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3QudXBkYXRlc1tpMl0gIT09ICJvYmplY3QiKQogICAgICAgICAgICAgIHRocm93IFR5cGVFcnJvcigiLnByb3RvY29sLk1lc3NhZ2UudXBkYXRlczogb2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgICAgIG1lc3NhZ2UudXBkYXRlc1tpMl0gPSAkcm9vdC5wcm90b2NvbC5VcGRhdGUuZnJvbU9iamVjdChvYmplY3QudXBkYXRlc1tpMl0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAob2JqZWN0LndvcmxkTmFtZSAhPSBudWxsKQogICAgICAgICAgbWVzc2FnZS53b3JsZE5hbWUgPSBTdHJpbmcob2JqZWN0LndvcmxkTmFtZSk7CiAgICAgICAgcmV0dXJuIG1lc3NhZ2U7CiAgICAgIH07CiAgICAgIE1lc3NhZ2UyLnRvT2JqZWN0ID0gZnVuY3Rpb24gdG9PYmplY3QobWVzc2FnZSwgb3B0aW9ucykgewogICAgICAgIGlmICghb3B0aW9ucykKICAgICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgICBsZXQgb2JqZWN0ID0ge307CiAgICAgICAgaWYgKG9wdGlvbnMuYXJyYXlzIHx8IG9wdGlvbnMuZGVmYXVsdHMpIHsKICAgICAgICAgIG9iamVjdC5wZWVycyA9IFtdOwogICAgICAgICAgb2JqZWN0LmVudGl0aWVzID0gW107CiAgICAgICAgICBvYmplY3QuY2h1bmtzID0gW107CiAgICAgICAgICBvYmplY3QuZXZlbnRzID0gW107CiAgICAgICAgICBvYmplY3QudXBkYXRlcyA9IFtdOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgICAgb2JqZWN0LnR5cGUgPSBvcHRpb25zLmVudW1zID09PSBTdHJpbmcgPyAiSU5JVCIgOiAwOwogICAgICAgICAgb2JqZWN0Lmpzb24gPSAiIjsKICAgICAgICAgIG9iamVjdC50ZXh0ID0gIiI7CiAgICAgICAgICBvYmplY3QubWV0aG9kID0gbnVsbDsKICAgICAgICAgIG9iamVjdC5jaGF0ID0gbnVsbDsKICAgICAgICAgIG9iamVjdC53b3JsZE5hbWUgPSAiIjsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UudHlwZSAhPSBudWxsICYmIG1lc3NhZ2UuaGFzT3duUHJvcGVydHkoInR5cGUiKSkKICAgICAgICAgIG9iamVjdC50eXBlID0gb3B0aW9ucy5lbnVtcyA9PT0gU3RyaW5nID8gJHJvb3QucHJvdG9jb2wuTWVzc2FnZS5UeXBlW21lc3NhZ2UudHlwZV0gPT09IHZvaWQgMCA/IG1lc3NhZ2UudHlwZSA6ICRyb290LnByb3RvY29sLk1lc3NhZ2UuVHlwZVttZXNzYWdlLnR5cGVdIDogbWVzc2FnZS50eXBlOwogICAgICAgIGlmIChtZXNzYWdlLmpzb24gIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJqc29uIikpCiAgICAgICAgICBvYmplY3QuanNvbiA9IG1lc3NhZ2UuanNvbjsKICAgICAgICBpZiAobWVzc2FnZS50ZXh0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgidGV4dCIpKQogICAgICAgICAgb2JqZWN0LnRleHQgPSBtZXNzYWdlLnRleHQ7CiAgICAgICAgaWYgKG1lc3NhZ2UubWV0aG9kICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgibWV0aG9kIikpCiAgICAgICAgICBvYmplY3QubWV0aG9kID0gJHJvb3QucHJvdG9jb2wuTWV0aG9kLnRvT2JqZWN0KG1lc3NhZ2UubWV0aG9kLCBvcHRpb25zKTsKICAgICAgICBpZiAobWVzc2FnZS5jaGF0ICE9IG51bGwgJiYgbWVzc2FnZS5oYXNPd25Qcm9wZXJ0eSgiY2hhdCIpKQogICAgICAgICAgb2JqZWN0LmNoYXQgPSAkcm9vdC5wcm90b2NvbC5DaGF0TWVzc2FnZS50b09iamVjdChtZXNzYWdlLmNoYXQsIG9wdGlvbnMpOwogICAgICAgIGlmIChtZXNzYWdlLnBlZXJzICYmIG1lc3NhZ2UucGVlcnMubGVuZ3RoKSB7CiAgICAgICAgICBvYmplY3QucGVlcnMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS5wZWVycy5sZW5ndGg7ICsraikKICAgICAgICAgICAgb2JqZWN0LnBlZXJzW2pdID0gJHJvb3QucHJvdG9jb2wuUGVlci50b09iamVjdChtZXNzYWdlLnBlZXJzW2pdLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKG1lc3NhZ2UuZW50aXRpZXMgJiYgbWVzc2FnZS5lbnRpdGllcy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5lbnRpdGllcyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBtZXNzYWdlLmVudGl0aWVzLmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QuZW50aXRpZXNbal0gPSAkcm9vdC5wcm90b2NvbC5FbnRpdHkudG9PYmplY3QobWVzc2FnZS5lbnRpdGllc1tqXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmNodW5rcyAmJiBtZXNzYWdlLmNodW5rcy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5jaHVua3MgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS5jaHVua3MubGVuZ3RoOyArK2opCiAgICAgICAgICAgIG9iamVjdC5jaHVua3Nbal0gPSAkcm9vdC5wcm90b2NvbC5DaHVuay50b09iamVjdChtZXNzYWdlLmNodW5rc1tqXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmV2ZW50cyAmJiBtZXNzYWdlLmV2ZW50cy5sZW5ndGgpIHsKICAgICAgICAgIG9iamVjdC5ldmVudHMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS5ldmVudHMubGVuZ3RoOyArK2opCiAgICAgICAgICAgIG9iamVjdC5ldmVudHNbal0gPSAkcm9vdC5wcm90b2NvbC5FdmVudC50b09iamVjdChtZXNzYWdlLmV2ZW50c1tqXSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnVwZGF0ZXMgJiYgbWVzc2FnZS51cGRhdGVzLmxlbmd0aCkgewogICAgICAgICAgb2JqZWN0LnVwZGF0ZXMgPSBbXTsKICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbWVzc2FnZS51cGRhdGVzLmxlbmd0aDsgKytqKQogICAgICAgICAgICBvYmplY3QudXBkYXRlc1tqXSA9ICRyb290LnByb3RvY29sLlVwZGF0ZS50b09iamVjdChtZXNzYWdlLnVwZGF0ZXNbal0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS53b3JsZE5hbWUgIT0gbnVsbCAmJiBtZXNzYWdlLmhhc093blByb3BlcnR5KCJ3b3JsZE5hbWUiKSkKICAgICAgICAgIG9iamVjdC53b3JsZE5hbWUgPSBtZXNzYWdlLndvcmxkTmFtZTsKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgICB9OwogICAgICBNZXNzYWdlMi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gdG9KU09OKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yLnRvT2JqZWN0KHRoaXMsIG1pbmltYWwudXRpbC50b0pTT05PcHRpb25zKTsKICAgICAgfTsKICAgICAgTWVzc2FnZTIuZ2V0VHlwZVVybCA9IGZ1bmN0aW9uIGdldFR5cGVVcmwodHlwZVVybFByZWZpeCkgewogICAgICAgIGlmICh0eXBlVXJsUHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgIHR5cGVVcmxQcmVmaXggPSAidHlwZS5nb29nbGVhcGlzLmNvbSI7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0eXBlVXJsUHJlZml4ICsgIi9wcm90b2NvbC5NZXNzYWdlIjsKICAgICAgfTsKICAgICAgTWVzc2FnZTIuVHlwZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnN0IHZhbHVlc0J5SWQgPSB7fSwgdmFsdWVzID0gT2JqZWN0LmNyZWF0ZSh2YWx1ZXNCeUlkKTsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFswXSA9ICJJTklUIl0gPSAwOwogICAgICAgIHZhbHVlc1t2YWx1ZXNCeUlkWzFdID0gIkpPSU4iXSA9IDE7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMl0gPSAiTEVBVkUiXSA9IDI7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbM10gPSAiRVJST1IiXSA9IDM7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbNF0gPSAiUEVFUiJdID0gNDsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFs1XSA9ICJFTlRJVFkiXSA9IDU7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbNl0gPSAiTE9BRCJdID0gNjsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFs3XSA9ICJVTkxPQUQiXSA9IDc7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbOF0gPSAiVVBEQVRFIl0gPSA4OwogICAgICAgIHZhbHVlc1t2YWx1ZXNCeUlkWzldID0gIk1FVEhPRCJdID0gOTsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxMF0gPSAiQ0hBVCJdID0gMTA7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMTFdID0gIlRSQU5TUE9SVCJdID0gMTE7CiAgICAgICAgdmFsdWVzW3ZhbHVlc0J5SWRbMTJdID0gIkVWRU5UIl0gPSAxMjsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxM10gPSAiQUNUSU9OIl0gPSAxMzsKICAgICAgICB2YWx1ZXNbdmFsdWVzQnlJZFsxNF0gPSAiU1RBVFMiXSA9IDE0OwogICAgICAgIHJldHVybiB2YWx1ZXM7CiAgICAgIH0oKTsKICAgICAgcmV0dXJuIE1lc3NhZ2UyOwogICAgfSgpOwogICAgcmV0dXJuIHByb3RvY29sMjsKICB9KSgpOwogIHZhciB1OCA9IFVpbnQ4QXJyYXksIHUxNiA9IFVpbnQxNkFycmF5LCB1MzIgPSBVaW50MzJBcnJheTsKICB2YXIgZmxlYiA9IG5ldyB1OChbCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMSwKICAgIDEsCiAgICAyLAogICAgMiwKICAgIDIsCiAgICAyLAogICAgMywKICAgIDMsCiAgICAzLAogICAgMywKICAgIDQsCiAgICA0LAogICAgNCwKICAgIDQsCiAgICA1LAogICAgNSwKICAgIDUsCiAgICA1LAogICAgMCwKICAgIC8qIHVudXNlZCAqLwogICAgMCwKICAgIDAsCiAgICAvKiBpbXBvc3NpYmxlICovCiAgICAwCiAgXSk7CiAgdmFyIGZkZWIgPSBuZXcgdTgoWwogICAgMCwKICAgIDAsCiAgICAwLAogICAgMCwKICAgIDEsCiAgICAxLAogICAgMiwKICAgIDIsCiAgICAzLAogICAgMywKICAgIDQsCiAgICA0LAogICAgNSwKICAgIDUsCiAgICA2LAogICAgNiwKICAgIDcsCiAgICA3LAogICAgOCwKICAgIDgsCiAgICA5LAogICAgOSwKICAgIDEwLAogICAgMTAsCiAgICAxMSwKICAgIDExLAogICAgMTIsCiAgICAxMiwKICAgIDEzLAogICAgMTMsCiAgICAvKiB1bnVzZWQgKi8KICAgIDAsCiAgICAwCiAgXSk7CiAgdmFyIGNsaW0gPSBuZXcgdTgoWzE2LCAxNywgMTgsIDAsIDgsIDcsIDksIDYsIDEwLCA1LCAxMSwgNCwgMTIsIDMsIDEzLCAyLCAxNCwgMSwgMTVdKTsKICB2YXIgZnJlYiA9IGZ1bmN0aW9uKGViLCBzdGFydCkgewogICAgdmFyIGIgPSBuZXcgdTE2KDMxKTsKICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCAzMTsgKytpMikgewogICAgICBiW2kyXSA9IHN0YXJ0ICs9IDEgPDwgZWJbaTIgLSAxXTsKICAgIH0KICAgIHZhciByID0gbmV3IHUzMihiWzMwXSk7CiAgICBmb3IgKHZhciBpMiA9IDE7IGkyIDwgMzA7ICsraTIpIHsKICAgICAgZm9yICh2YXIgaiA9IGJbaTJdOyBqIDwgYltpMiArIDFdOyArK2opIHsKICAgICAgICByW2pdID0gaiAtIGJbaTJdIDw8IDUgfCBpMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIFtiLCByXTsKICB9OwogIHZhciBfYSA9IGZyZWIoZmxlYiwgMiksIGZsID0gX2FbMF0sIHJldmZsID0gX2FbMV07CiAgZmxbMjhdID0gMjU4LCByZXZmbFsyNThdID0gMjg7CiAgdmFyIF9iID0gZnJlYihmZGViLCAwKSwgZmQgPSBfYlswXTsKICB2YXIgcmV2ID0gbmV3IHUxNigzMjc2OCk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCAzMjc2ODsgKytpKSB7CiAgICB2YXIgeCA9IChpICYgNDM2OTApID4+PiAxIHwgKGkgJiAyMTg0NSkgPDwgMTsKICAgIHggPSAoeCAmIDUyNDI4KSA+Pj4gMiB8ICh4ICYgMTMxMDcpIDw8IDI7CiAgICB4ID0gKHggJiA2MTY4MCkgPj4+IDQgfCAoeCAmIDM4NTUpIDw8IDQ7CiAgICByZXZbaV0gPSAoKHggJiA2NTI4MCkgPj4+IDggfCAoeCAmIDI1NSkgPDwgOCkgPj4+IDE7CiAgfQogIHZhciBoTWFwID0gZnVuY3Rpb24oY2QsIG1iLCByKSB7CiAgICB2YXIgcyA9IGNkLmxlbmd0aDsKICAgIHZhciBpMiA9IDA7CiAgICB2YXIgbCA9IG5ldyB1MTYobWIpOwogICAgZm9yICg7IGkyIDwgczsgKytpMikgewogICAgICBpZiAoY2RbaTJdKQogICAgICAgICsrbFtjZFtpMl0gLSAxXTsKICAgIH0KICAgIHZhciBsZSA9IG5ldyB1MTYobWIpOwogICAgZm9yIChpMiA9IDA7IGkyIDwgbWI7ICsraTIpIHsKICAgICAgbGVbaTJdID0gbGVbaTIgLSAxXSArIGxbaTIgLSAxXSA8PCAxOwogICAgfQogICAgdmFyIGNvOwogICAgaWYgKHIpIHsKICAgICAgY28gPSBuZXcgdTE2KDEgPDwgbWIpOwogICAgICB2YXIgcnZiID0gMTUgLSBtYjsKICAgICAgZm9yIChpMiA9IDA7IGkyIDwgczsgKytpMikgewogICAgICAgIGlmIChjZFtpMl0pIHsKICAgICAgICAgIHZhciBzdiA9IGkyIDw8IDQgfCBjZFtpMl07CiAgICAgICAgICB2YXIgcl8xID0gbWIgLSBjZFtpMl07CiAgICAgICAgICB2YXIgdiA9IGxlW2NkW2kyXSAtIDFdKysgPDwgcl8xOwogICAgICAgICAgZm9yICh2YXIgbSA9IHYgfCAoMSA8PCByXzEpIC0gMTsgdiA8PSBtOyArK3YpIHsKICAgICAgICAgICAgY29bcmV2W3ZdID4+PiBydmJdID0gc3Y7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjbyA9IG5ldyB1MTYocyk7CiAgICAgIGZvciAoaTIgPSAwOyBpMiA8IHM7ICsraTIpIHsKICAgICAgICBpZiAoY2RbaTJdKSB7CiAgICAgICAgICBjb1tpMl0gPSByZXZbbGVbY2RbaTJdIC0gMV0rK10gPj4+IDE1IC0gY2RbaTJdOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvOwogIH07CiAgdmFyIGZsdCA9IG5ldyB1OCgyODgpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMTQ0OyArK2kpCiAgICBmbHRbaV0gPSA4OwogIGZvciAodmFyIGkgPSAxNDQ7IGkgPCAyNTY7ICsraSkKICAgIGZsdFtpXSA9IDk7CiAgZm9yICh2YXIgaSA9IDI1NjsgaSA8IDI4MDsgKytpKQogICAgZmx0W2ldID0gNzsKICBmb3IgKHZhciBpID0gMjgwOyBpIDwgMjg4OyArK2kpCiAgICBmbHRbaV0gPSA4OwogIHZhciBmZHQgPSBuZXcgdTgoMzIpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgMzI7ICsraSkKICAgIGZkdFtpXSA9IDU7CiAgdmFyIGZscm0gPSAvKiBAX19QVVJFX18gKi8gaE1hcChmbHQsIDksIDEpOwogIHZhciBmZHJtID0gLyogQF9fUFVSRV9fICovIGhNYXAoZmR0LCA1LCAxKTsKICB2YXIgbWF4ID0gZnVuY3Rpb24oYSkgewogICAgdmFyIG0gPSBhWzBdOwogICAgZm9yICh2YXIgaTIgPSAxOyBpMiA8IGEubGVuZ3RoOyArK2kyKSB7CiAgICAgIGlmIChhW2kyXSA+IG0pCiAgICAgICAgbSA9IGFbaTJdOwogICAgfQogICAgcmV0dXJuIG07CiAgfTsKICB2YXIgYml0cyA9IGZ1bmN0aW9uKGQsIHAsIG0pIHsKICAgIHZhciBvID0gcCAvIDggfCAwOwogICAgcmV0dXJuIChkW29dIHwgZFtvICsgMV0gPDwgOCkgPj4gKHAgJiA3KSAmIG07CiAgfTsKICB2YXIgYml0czE2ID0gZnVuY3Rpb24oZCwgcCkgewogICAgdmFyIG8gPSBwIC8gOCB8IDA7CiAgICByZXR1cm4gKGRbb10gfCBkW28gKyAxXSA8PCA4IHwgZFtvICsgMl0gPDwgMTYpID4+IChwICYgNyk7CiAgfTsKICB2YXIgc2hmdCA9IGZ1bmN0aW9uKHApIHsKICAgIHJldHVybiAocCArIDcpIC8gOCB8IDA7CiAgfTsKICB2YXIgc2xjID0gZnVuY3Rpb24odiwgcywgZSkgewogICAgaWYgKGUgPT0gbnVsbCB8fCBlID4gdi5sZW5ndGgpCiAgICAgIGUgPSB2Lmxlbmd0aDsKICAgIHZhciBuID0gbmV3ICh2LkJZVEVTX1BFUl9FTEVNRU5UID09IDIgPyB1MTYgOiB2LkJZVEVTX1BFUl9FTEVNRU5UID09IDQgPyB1MzIgOiB1OCkoZSAtIHMpOwogICAgbi5zZXQodi5zdWJhcnJheShzLCBlKSk7CiAgICByZXR1cm4gbjsKICB9OwogIHZhciBlYyA9IFsKICAgICJ1bmV4cGVjdGVkIEVPRiIsCiAgICAiaW52YWxpZCBibG9jayB0eXBlIiwKICAgICJpbnZhbGlkIGxlbmd0aC9saXRlcmFsIiwKICAgICJpbnZhbGlkIGRpc3RhbmNlIiwKICAgICJzdHJlYW0gZmluaXNoZWQiLAogICAgIm5vIHN0cmVhbSBoYW5kbGVyIiwKICAgICwKICAgICJubyBjYWxsYmFjayIsCiAgICAiaW52YWxpZCBVVEYtOCBkYXRhIiwKICAgICJleHRyYSBmaWVsZCB0b28gbG9uZyIsCiAgICAiZGF0ZSBub3QgaW4gcmFuZ2UgMTk4MC0yMDk5IiwKICAgICJmaWxlbmFtZSB0b28gbG9uZyIsCiAgICAic3RyZWFtIGZpbmlzaGluZyIsCiAgICAiaW52YWxpZCB6aXAgZGF0YSIKICAgIC8vIGRldGVybWluZWQgYnkgdW5rbm93biBjb21wcmVzc2lvbiBtZXRob2QKICBdOwogIHZhciBlcnIgPSBmdW5jdGlvbihpbmQsIG1zZywgbnQpIHsKICAgIHZhciBlID0gbmV3IEVycm9yKG1zZyB8fCBlY1tpbmRdKTsKICAgIGUuY29kZSA9IGluZDsKICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UoZSwgZXJyKTsKICAgIGlmICghbnQpCiAgICAgIHRocm93IGU7CiAgICByZXR1cm4gZTsKICB9OwogIHZhciBpbmZsdCA9IGZ1bmN0aW9uKGRhdCwgYnVmLCBzdCkgewogICAgdmFyIHNsID0gZGF0Lmxlbmd0aDsKICAgIGlmICghc2wgfHwgc3QgJiYgc3QuZiAmJiAhc3QubCkKICAgICAgcmV0dXJuIGJ1ZiB8fCBuZXcgdTgoMCk7CiAgICB2YXIgbm9CdWYgPSAhYnVmIHx8IHN0OwogICAgdmFyIG5vU3QgPSAhc3QgfHwgc3QuaTsKICAgIGlmICghc3QpCiAgICAgIHN0ID0ge307CiAgICBpZiAoIWJ1ZikKICAgICAgYnVmID0gbmV3IHU4KHNsICogMyk7CiAgICB2YXIgY2J1ZiA9IGZ1bmN0aW9uKGwyKSB7CiAgICAgIHZhciBibCA9IGJ1Zi5sZW5ndGg7CiAgICAgIGlmIChsMiA+IGJsKSB7CiAgICAgICAgdmFyIG5idWYgPSBuZXcgdTgoTWF0aC5tYXgoYmwgKiAyLCBsMikpOwogICAgICAgIG5idWYuc2V0KGJ1Zik7CiAgICAgICAgYnVmID0gbmJ1ZjsKICAgICAgfQogICAgfTsKICAgIHZhciBmaW5hbCA9IHN0LmYgfHwgMCwgcG9zID0gc3QucCB8fCAwLCBidCA9IHN0LmIgfHwgMCwgbG0gPSBzdC5sLCBkbSA9IHN0LmQsIGxidCA9IHN0Lm0sIGRidCA9IHN0Lm47CiAgICB2YXIgdGJ0cyA9IHNsICogODsKICAgIGRvIHsKICAgICAgaWYgKCFsbSkgewogICAgICAgIGZpbmFsID0gYml0cyhkYXQsIHBvcywgMSk7CiAgICAgICAgdmFyIHR5cGUgPSBiaXRzKGRhdCwgcG9zICsgMSwgMyk7CiAgICAgICAgcG9zICs9IDM7CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICB2YXIgcyA9IHNoZnQocG9zKSArIDQsIGwgPSBkYXRbcyAtIDRdIHwgZGF0W3MgLSAzXSA8PCA4LCB0ID0gcyArIGw7CiAgICAgICAgICBpZiAodCA+IHNsKSB7CiAgICAgICAgICAgIGlmIChub1N0KQogICAgICAgICAgICAgIGVycigwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9CdWYpCiAgICAgICAgICAgIGNidWYoYnQgKyBsKTsKICAgICAgICAgIGJ1Zi5zZXQoZGF0LnN1YmFycmF5KHMsIHQpLCBidCk7CiAgICAgICAgICBzdC5iID0gYnQgKz0gbCwgc3QucCA9IHBvcyA9IHQgKiA4LCBzdC5mID0gZmluYWw7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gMSkKICAgICAgICAgIGxtID0gZmxybSwgZG0gPSBmZHJtLCBsYnQgPSA5LCBkYnQgPSA1OwogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gMikgewogICAgICAgICAgdmFyIGhMaXQgPSBiaXRzKGRhdCwgcG9zLCAzMSkgKyAyNTcsIGhjTGVuID0gYml0cyhkYXQsIHBvcyArIDEwLCAxNSkgKyA0OwogICAgICAgICAgdmFyIHRsID0gaExpdCArIGJpdHMoZGF0LCBwb3MgKyA1LCAzMSkgKyAxOwogICAgICAgICAgcG9zICs9IDE0OwogICAgICAgICAgdmFyIGxkdCA9IG5ldyB1OCh0bCk7CiAgICAgICAgICB2YXIgY2x0ID0gbmV3IHU4KDE5KTsKICAgICAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCBoY0xlbjsgKytpMikgewogICAgICAgICAgICBjbHRbY2xpbVtpMl1dID0gYml0cyhkYXQsIHBvcyArIGkyICogMywgNyk7CiAgICAgICAgICB9CiAgICAgICAgICBwb3MgKz0gaGNMZW4gKiAzOwogICAgICAgICAgdmFyIGNsYiA9IG1heChjbHQpLCBjbGJtc2sgPSAoMSA8PCBjbGIpIC0gMTsKICAgICAgICAgIHZhciBjbG0gPSBoTWFwKGNsdCwgY2xiLCAxKTsKICAgICAgICAgIGZvciAodmFyIGkyID0gMDsgaTIgPCB0bDsgKSB7CiAgICAgICAgICAgIHZhciByID0gY2xtW2JpdHMoZGF0LCBwb3MsIGNsYm1zayldOwogICAgICAgICAgICBwb3MgKz0gciAmIDE1OwogICAgICAgICAgICB2YXIgcyA9IHIgPj4+IDQ7CiAgICAgICAgICAgIGlmIChzIDwgMTYpIHsKICAgICAgICAgICAgICBsZHRbaTIrK10gPSBzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjID0gMCwgbiA9IDA7CiAgICAgICAgICAgICAgaWYgKHMgPT0gMTYpCiAgICAgICAgICAgICAgICBuID0gMyArIGJpdHMoZGF0LCBwb3MsIDMpLCBwb3MgKz0gMiwgYyA9IGxkdFtpMiAtIDFdOwogICAgICAgICAgICAgIGVsc2UgaWYgKHMgPT0gMTcpCiAgICAgICAgICAgICAgICBuID0gMyArIGJpdHMoZGF0LCBwb3MsIDcpLCBwb3MgKz0gMzsKICAgICAgICAgICAgICBlbHNlIGlmIChzID09IDE4KQogICAgICAgICAgICAgICAgbiA9IDExICsgYml0cyhkYXQsIHBvcywgMTI3KSwgcG9zICs9IDc7CiAgICAgICAgICAgICAgd2hpbGUgKG4tLSkKICAgICAgICAgICAgICAgIGxkdFtpMisrXSA9IGM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsdCA9IGxkdC5zdWJhcnJheSgwLCBoTGl0KSwgZHQgPSBsZHQuc3ViYXJyYXkoaExpdCk7CiAgICAgICAgICBsYnQgPSBtYXgobHQpOwogICAgICAgICAgZGJ0ID0gbWF4KGR0KTsKICAgICAgICAgIGxtID0gaE1hcChsdCwgbGJ0LCAxKTsKICAgICAgICAgIGRtID0gaE1hcChkdCwgZGJ0LCAxKTsKICAgICAgICB9IGVsc2UKICAgICAgICAgIGVycigxKTsKICAgICAgICBpZiAocG9zID4gdGJ0cykgewogICAgICAgICAgaWYgKG5vU3QpCiAgICAgICAgICAgIGVycigwKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9CdWYpCiAgICAgICAgY2J1ZihidCArIDEzMTA3Mik7CiAgICAgIHZhciBsbXMgPSAoMSA8PCBsYnQpIC0gMSwgZG1zID0gKDEgPDwgZGJ0KSAtIDE7CiAgICAgIHZhciBscG9zID0gcG9zOwogICAgICBmb3IgKDsgOyBscG9zID0gcG9zKSB7CiAgICAgICAgdmFyIGMgPSBsbVtiaXRzMTYoZGF0LCBwb3MpICYgbG1zXSwgc3ltID0gYyA+Pj4gNDsKICAgICAgICBwb3MgKz0gYyAmIDE1OwogICAgICAgIGlmIChwb3MgPiB0YnRzKSB7CiAgICAgICAgICBpZiAobm9TdCkKICAgICAgICAgICAgZXJyKDApOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGlmICghYykKICAgICAgICAgIGVycigyKTsKICAgICAgICBpZiAoc3ltIDwgMjU2KQogICAgICAgICAgYnVmW2J0KytdID0gc3ltOwogICAgICAgIGVsc2UgaWYgKHN5bSA9PSAyNTYpIHsKICAgICAgICAgIGxwb3MgPSBwb3MsIGxtID0gbnVsbDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgYWRkID0gc3ltIC0gMjU0OwogICAgICAgICAgaWYgKHN5bSA+IDI2NCkgewogICAgICAgICAgICB2YXIgaTIgPSBzeW0gLSAyNTcsIGIgPSBmbGViW2kyXTsKICAgICAgICAgICAgYWRkID0gYml0cyhkYXQsIHBvcywgKDEgPDwgYikgLSAxKSArIGZsW2kyXTsKICAgICAgICAgICAgcG9zICs9IGI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZCA9IGRtW2JpdHMxNihkYXQsIHBvcykgJiBkbXNdLCBkc3ltID0gZCA+Pj4gNDsKICAgICAgICAgIGlmICghZCkKICAgICAgICAgICAgZXJyKDMpOwogICAgICAgICAgcG9zICs9IGQgJiAxNTsKICAgICAgICAgIHZhciBkdCA9IGZkW2RzeW1dOwogICAgICAgICAgaWYgKGRzeW0gPiAzKSB7CiAgICAgICAgICAgIHZhciBiID0gZmRlYltkc3ltXTsKICAgICAgICAgICAgZHQgKz0gYml0czE2KGRhdCwgcG9zKSAmICgxIDw8IGIpIC0gMSwgcG9zICs9IGI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocG9zID4gdGJ0cykgewogICAgICAgICAgICBpZiAobm9TdCkKICAgICAgICAgICAgICBlcnIoMCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vQnVmKQogICAgICAgICAgICBjYnVmKGJ0ICsgMTMxMDcyKTsKICAgICAgICAgIHZhciBlbmQgPSBidCArIGFkZDsKICAgICAgICAgIGZvciAoOyBidCA8IGVuZDsgYnQgKz0gNCkgewogICAgICAgICAgICBidWZbYnRdID0gYnVmW2J0IC0gZHRdOwogICAgICAgICAgICBidWZbYnQgKyAxXSA9IGJ1ZltidCArIDEgLSBkdF07CiAgICAgICAgICAgIGJ1ZltidCArIDJdID0gYnVmW2J0ICsgMiAtIGR0XTsKICAgICAgICAgICAgYnVmW2J0ICsgM10gPSBidWZbYnQgKyAzIC0gZHRdOwogICAgICAgICAgfQogICAgICAgICAgYnQgPSBlbmQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN0LmwgPSBsbSwgc3QucCA9IGxwb3MsIHN0LmIgPSBidCwgc3QuZiA9IGZpbmFsOwogICAgICBpZiAobG0pCiAgICAgICAgZmluYWwgPSAxLCBzdC5tID0gbGJ0LCBzdC5kID0gZG0sIHN0Lm4gPSBkYnQ7CiAgICB9IHdoaWxlICghZmluYWwpOwogICAgcmV0dXJuIGJ0ID09IGJ1Zi5sZW5ndGggPyBidWYgOiBzbGMoYnVmLCAwLCBidCk7CiAgfTsKICB2YXIgZXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IHU4KDApOwogIHZhciB6bHYgPSBmdW5jdGlvbihkKSB7CiAgICBpZiAoKGRbMF0gJiAxNSkgIT0gOCB8fCBkWzBdID4+PiA0ID4gNyB8fCAoZFswXSA8PCA4IHwgZFsxXSkgJSAzMSkKICAgICAgZXJyKDYsICJpbnZhbGlkIHpsaWIgZGF0YSIpOwogICAgaWYgKGRbMV0gJiAzMikKICAgICAgZXJyKDYsICJpbnZhbGlkIHpsaWIgZGF0YTogcHJlc2V0IGRpY3Rpb25hcmllcyBub3Qgc3VwcG9ydGVkIik7CiAgfTsKICBmdW5jdGlvbiB1bnpsaWJTeW5jKGRhdGEsIG91dCkgewogICAgcmV0dXJuIGluZmx0KCh6bHYoZGF0YSksIGRhdGEuc3ViYXJyYXkoMiwgLTQpKSwgb3V0KTsKICB9CiAgdmFyIHRkID0gdHlwZW9mIFRleHREZWNvZGVyICE9ICJ1bmRlZmluZWQiICYmIC8qIEBfX1BVUkVfXyAqLyBuZXcgVGV4dERlY29kZXIoKTsKICB2YXIgdGRzID0gMDsKICB0cnkgewogICAgdGQuZGVjb2RlKGV0LCB7IHN0cmVhbTogdHJ1ZSB9KTsKICAgIHRkcyA9IDE7CiAgfSBjYXRjaCAoZSkgewogIH0KICBjb25zdCB7IE1lc3NhZ2UsIEVudGl0eSB9ID0gcHJvdG9jb2w7CiAgb25jb25uZWN0ID0gKGUpID0+IHsKICAgIGNvbnN0IHBvcnQgPSBlLnBvcnRzWzBdOwogICAgcG9ydC5vbm1lc3NhZ2UgPSAoZTIpID0+IHsKICAgICAgbGV0IHsgZGF0YTogYnVmZmVycyB9ID0gZTI7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShidWZmZXJzKSkgewogICAgICAgIGJ1ZmZlcnMgPSBbYnVmZmVyc107CiAgICAgIH0KICAgICAgY29uc3QgdHJhbnNmZXJhYmxlcyA9IFtdOwogICAgICBjb25zdCBtZXNzYWdlcyA9IGJ1ZmZlcnMubWFwKChidWZmZXIpID0+IHsKICAgICAgICBpZiAoYnVmZmVyWzBdID09PSAxMjAgJiYgYnVmZmVyWzFdID09PSAxNTYpIHsKICAgICAgICAgIGJ1ZmZlciA9IHVuemxpYlN5bmMoYnVmZmVyKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbWVzc2FnZSA9IE1lc3NhZ2UudG9PYmplY3QoTWVzc2FnZS5kZWNvZGUoYnVmZmVyKSwgewogICAgICAgICAgZGVmYXVsdHM6IHRydWUKICAgICAgICB9KTsKICAgICAgICBtZXNzYWdlLnR5cGUgPSBNZXNzYWdlLlR5cGVbbWVzc2FnZS50eXBlXTsKICAgICAgICBpZiAobWVzc2FnZS5qc29uKSB7CiAgICAgICAgICBtZXNzYWdlLmpzb24gPSBKU09OLnBhcnNlKG1lc3NhZ2UuanNvbik7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmVudGl0aWVzKSB7CiAgICAgICAgICBtZXNzYWdlLmVudGl0aWVzLmZvckVhY2goKGVudGl0eSkgPT4gewogICAgICAgICAgICBpZiAoZW50aXR5Lm1ldGFkYXRhKSB7CiAgICAgICAgICAgICAgZW50aXR5Lm1ldGFkYXRhID0gSlNPTi5wYXJzZShlbnRpdHkubWV0YWRhdGEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVudGl0eS5vcGVyYXRpb24gPSBFbnRpdHkuT3BlcmF0aW9uW2VudGl0eS5vcGVyYXRpb25dOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLnBlZXJzKSB7CiAgICAgICAgICBtZXNzYWdlLnBlZXJzLmZvckVhY2goKHBlZXIpID0+IHsKICAgICAgICAgICAgaWYgKHBlZXIubWV0YWRhdGEpIHsKICAgICAgICAgICAgICBwZWVyLm1ldGFkYXRhID0gSlNPTi5wYXJzZShwZWVyLm1ldGFkYXRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChtZXNzYWdlLmV2ZW50cykgewogICAgICAgICAgbWVzc2FnZS5ldmVudHMuZm9yRWFjaCgoZXZlbnQpID0+IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBsZXQgcGFyc2VkUGF5bG9hZCA9IGV2ZW50LnBheWxvYWQ7CiAgICAgICAgICAgICAgZm9yIChsZXQgaTIgPSAwOyBpMiA8IDU7IGkyKyspIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHBhcnNlZFBheWxvYWQgPSBKU09OLnBhcnNlKHBhcnNlZFBheWxvYWQpOwogICAgICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBldmVudC5wYXlsb2FkID0gcGFyc2VkUGF5bG9hZDsKICAgICAgICAgICAgfSBjYXRjaCAoZTMpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlMyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAobWVzc2FnZS5jaHVua3MpIHsKICAgICAgICAgIG1lc3NhZ2UuY2h1bmtzLmZvckVhY2goKGNodW5rKSA9PiB7CiAgICAgICAgICAgIFsibGlnaHRzIiwgInZveGVscyJdLmZvckVhY2goKGtleSkgPT4gewogICAgICAgICAgICAgIGlmIChjaHVua1trZXldKSB7CiAgICAgICAgICAgICAgICBjaHVua1trZXldID0gbmV3IFVpbnQzMkFycmF5KGNodW5rW2tleV0pOwogICAgICAgICAgICAgICAgdHJhbnNmZXJhYmxlcy5wdXNoKGNodW5rW2tleV0uYnVmZmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoY2h1bmsubWVzaGVzKSB7CiAgICAgICAgICAgICAgY2h1bmsubWVzaGVzLmZvckVhY2goKG1lc2gpID0+IHsKICAgICAgICAgICAgICAgIG1lc2guZ2VvbWV0cmllcy5mb3JFYWNoKChnZW9tZXRyeSkgPT4gewogICAgICAgICAgICAgICAgICBbImluZGljZXMiXS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2VvbWV0cnkgJiYgZ2VvbWV0cnlba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnlba2V5XSA9IG5ldyBVaW50MTZBcnJheShnZW9tZXRyeVtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZmVyYWJsZXMucHVzaChnZW9tZXRyeVtrZXldLmJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgWyJsaWdodHMiXS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2VvbWV0cnkgJiYgZ2VvbWV0cnlba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnlba2V5XSA9IG5ldyBJbnQzMkFycmF5KGdlb21ldHJ5W2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgdHJhbnNmZXJhYmxlcy5wdXNoKGdlb21ldHJ5W2tleV0uYnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICBbInBvc2l0aW9ucyIsICJ1dnMiXS5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZ2VvbWV0cnkgJiYgZ2VvbWV0cnlba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgZ2VvbWV0cnlba2V5XSA9IG5ldyBGbG9hdDMyQXJyYXkoZ2VvbWV0cnlba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICB0cmFuc2ZlcmFibGVzLnB1c2goZ2VvbWV0cnlba2V5XS5idWZmZXIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtZXNzYWdlOwogICAgICB9KTsKICAgICAgcG9ydC5wb3N0TWVzc2FnZShtZXNzYWdlcywgdHJhbnNmZXJhYmxlcyk7CiAgICB9OwogIH07Cn0pKCk7Cg==",{name:null==g?void 0:g.name})}const{Message:IC}=G,CC={maxPacketsPerTick:8};class AC{constructor(g={}){this.clientInfo={id:"",username:"",metadata:{}},this.intercepts=[],this.connected=!1,this.joined=!1,this.pool=new vI(gC,{maxWorker:window.navigator.hardwareConcurrency||4}),this.joinResolve=null,this.joinReject=null,this.packetQueue=[],this.connect=async(g,I={})=>{if(!g)throw new Error("No server URL provided.");if("string"!=typeof g)throw new Error("Server URL must be a string.");this.url=new B(g),this.url.protocol=this.url.protocol.replace(/ws/,"http"),this.url.hash="";const C=new B(g);return C.path="/ws/",this.socket=new URL(C.toString()),this.socket.protocol=this.socket.protocol.replace(/http/,"ws"),this.socket.hash="",this.socket.searchParams.set("secret",I.secret||""),this.clientInfo.id&&this.socket.searchParams.set("client_id",this.clientInfo.id),this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close(),this.reconnection&&clearTimeout(this.reconnection)),new Promise((C=>{const A=new WebSocket(this.socket.toString());A.binaryType="arraybuffer",A.sendEvent=async g=>{for(;!this.connected;)console.log("waiting for websocket connection..."),await new Promise((g=>setTimeout(g,100)));A.readyState===WebSocket.OPEN&&A.send(AC.encodeSync(g))},A.onopen=()=>{var g;this.connected=!0,null==(g=this.onConnect)||g.call(this),clearTimeout(this.reconnection),C(this)},A.onerror=console.error,A.onmessage=({data:g})=>{this.packetQueue.push(g)},A.onclose=()=>{var C;this.connected=!1,null==(C=this.onDisconnect)||C.call(this),I.reconnectTimeout&&(this.reconnection=setTimeout((()=>{this.connect(g,I)}),I.reconnectTimeout))},this.ws=A}))},this.join=async g=>(this.joined&&this.leave(),this.joined=!0,this.world=g,this.send({type:"JOIN",json:{world:g,username:this.clientInfo.username}}),new Promise(((g,I)=>{this.joinResolve=g,this.joinReject=I}))),this.leave=()=>{this.joined&&(this.joined=!1,this.send({type:"LEAVE",text:this.world}))},this.action=async(g,I)=>{this.send({type:"ACTION",json:{action:g,data:I}})},this.sync=()=>{this.connected&&this.packetQueue.length&&!this.pool.isBusy&&this.decode(this.packetQueue.splice(0,Math.min(this.options.maxPacketsPerTick,this.packetQueue.length)).map((g=>new Uint8Array(g)))).then((async g=>{g.forEach((g=>{this.onMessage(g)}))}))},this.flush=()=>{this.intercepts.forEach((g=>{g.packets&&g.packets.length&&g.packets.splice(0,g.packets.length).forEach((g=>{this.send(g)}))}))},this.register=(...g)=>(g.forEach((g=>{this.intercepts.push(g)})),this),this.unregister=(...g)=>(g.forEach((g=>{const I=this.intercepts.indexOf(g);-1!==I&&this.intercepts.splice(I,1)})),this),this.disconnect=()=>{this.connected&&(this.ws&&(this.ws.onclose=null,this.ws.onmessage=null,this.ws.close()),this.reconnection&&clearTimeout(this.reconnection))},this.send=g=>{this.ws.sendEvent(g)},this.setID=g=>{this.clientInfo.id=g||""},this.setUsername=g=>{this.clientInfo.username=g||" "},this.setMetadata=g=>{this.clientInfo.metadata=g||{}},this.onMessage=async g=>{var I;const{type:C}=g;if("ERROR"===C){const{text:I}=g;return this.disconnect(),void this.joinReject(I)}if("INIT"===C){const{id:I}=g.json;if(I){if(this.clientInfo.id&&this.clientInfo.id!==I)throw new Error("Something went wrong with IDs! Better check if you're passing two same ID's to the same Voxelize server.");this.clientInfo.id=I}}if(this.intercepts.forEach((I=>{var C;null==(C=I.onMessage)||C.call(I,g,this.clientInfo)})),"INIT"===C){if(!this.joinResolve)throw new Error("Something went wrong with joining worlds...");this.joinResolve(this),null==(I=this.onJoin)||I.call(this,this.world)}},this.decode=async g=>new Promise((I=>{this.pool.addJob({message:g,buffers:g.map((g=>g.buffer)),resolve:I})})),this.options={...CC,...g},FI((()=>{this.connected&&(this.flush(),this.sync())}),1e3/60);let I=Math.floor(1e4*Math.random()).toString();I=new Array(1e4.toString().length-I.length).fill("0").join("")+I,this.clientInfo.username=`Guest ${I}`}get concurrentWorkers(){return this.pool.workingCount}get packetQueueLength(){return this.packetQueue.length}static encodeSync(g){return g.json&&(g.json=JSON.stringify(g.json)),g.type=IC.Type[g.type],g.entities&&g.entities.forEach((g=>g.metadata=JSON.stringify(g.metadata))),g.peers&&g.peers.forEach((g=>g.metadata=JSON.stringify(g.metadata))),G.Message.encode(G.Message.create(g)).finish()}}const iC=new i.PTz,tC=new i.Pq0,sC={countSelf:!1,updateChildren:!0,autoAddToSelf:!0};class oC extends i.YJl{constructor(g,I={}){super(),this.object=g,this.ownID="",this.ownUsername="",this.packets=[],this.infoJsonCache=null,this.map=new Map,this.onMessage=(g,{username:I,metadata:C})=>{var A,i;this.ownUsername=I,this.ownMetadata=C;const t=g=>{const I=this.createPeer(g);return this.options.autoAddToSelf&&this.add(I),this.map.set(g,I),I};switch(g.type){case"INIT":{const{id:I}=g.json;this.ownID=I;break}case"JOIN":{const{text:I}=g;if(this.ownID&&this.ownID===I)return;if(!this.createPeer)return void console.warn("Peers.createPeer is not defined, skipping peer join.");if(this.getPeerById(I))break;const C=t(I);null==(A=this.onPeerJoin)||A.call(this,I,C);break}case"LEAVE":{const{text:I}=g,C=this.getPeerById(I);C&&this.options.autoAddToSelf&&this.remove(C),this.map.delete(I),null==(i=this.onPeerLeave)||i.call(this,I,C);break}case"EVENT":{const{events:I}=g;for(const g of I){const{name:I,payload:C}=g;switch(I.toLowerCase()){case"vox-builtin:arm-swing":{const g=this.getPeerById(C);g&&g instanceof Dg&&g.playArmSwingAnimation();break}}}break}}const{peers:s}=g;s&&s.forEach((g=>{const I=this.ownID&&g.id===this.ownID;if(!this.options.countSelf&&I)return;let C=I?this.ownPeer:this.getPeerById(g.id);C||I||(C=t(g.id)),this.onPeerUpdate?this.onPeerUpdate(C,g.metadata,{id:g.id,username:g.username}):console.warn("Peers.onPeerUpdate is not defined, skipping peer update.")}))},this.getPeerById=g=>this.map.get(g),this.options={...sC,...I}}setOwnPeer(g){this.ownPeer=g,this.options.autoAddToSelf&&this.add(g)}setOwnUsername(g){this.ownUsername=g,this.ownPeer.name=g}packInfo(){const{x:g,y:I,z:C}=new i.Pq0(0,0,-1).applyQuaternion(this.object.getWorldQuaternion(iC)).normalize(),{x:A,y:t,z:s}=this.object.getWorldPosition(tC);return{id:this.ownID,username:this.ownUsername,metadata:{...this.ownMetadata,position:[A,t,s],direction:[g,I,C]}}}update(){if(!this.object)return;const g=this.packInfo();if(this.ownPeer&&g&&this.onPeerUpdate(this.ownPeer,g.metadata,{id:g.id,username:g.username}),g){const I=JSON.stringify(g);if(this.infoJsonCache!==I){this.infoJsonCache=I;const C={type:"PEER",peers:[g]};this.packets.push(C)}}this.options.updateChildren&&this.children.forEach((g=>{g!==this.ownPeer&&g instanceof Dg&&g.update()}))}}class eC{constructor(g,I,C){this.id=g,this.name=dg.getChunkName(I),this.coords=I,this.options=C;const{size:i,maxHeight:t}=C;this.voxels=A([],[i,t,i]),this.lights=A([],[i,t,i]);const[s,o]=I;this.min=[s*i,0,o*i],this.max=[(s+1)*i,t,(o+1)*i]}serialize(){return[{id:this.id,x:this.coords[0],z:this.coords[1],voxels:this.voxels.data.buffer,lights:this.lights.data.buffer,options:this.options},[this.voxels.data.buffer.slice(0),this.lights.data.buffer.slice(0)]]}static deserialize(g){const{id:I,x:C,z:A,voxels:i,lights:t,options:s}=g,o=new eC(I,[C,A],s);return t&&t.byteLength&&(o.lights.data=new Uint32Array(t)),i&&i.byteLength&&(o.voxels.data=new Uint32Array(i)),o}setData(g){const{id:I,x:C,z:A}=g;if(this.id!==I)throw new Error("Chunk id mismatch");if(this.coords[0]!==C||this.coords[1]!==A)throw new Error("Chunk coords mismatch");const{voxels:i,lights:t}=g;t&&t.byteLength&&(this.lights.data=new Uint32Array(t)),i&&i.byteLength&&(this.voxels.data=new Uint32Array(i))}getRawValue(g,I,C){if(!this.contains(g,I,C))return 0;const[A,i,t]=this.toLocal(g,I,C);return this.voxels.get(A,i,t)}setRawValue(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.voxels.set(i,t,s,A)}getRawLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,i,t]=this.toLocal(g,I,C);return this.lights.get(A,i,t)}setRawLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.lights.set(i,t,s,A)}getVoxel(g,I,C){return eg.extractID(this.getRawValue(0|g,0|I,0|C))}setVoxel(g,I,C,A){const i=eg.insertID(0,A);return this.setRawValue(g,I,C,i),A}getVoxelRotation(g,I,C){return this.contains(g,I,C)?eg.extractRotation(this.getRawValue(g,I,C)):new sg}setVoxelRotation(g,I,C,A){const i=eg.insertRotation(this.getRawValue(g,I,C),A);this.setRawValue(g,I,C,i)}getVoxelStage(g,I,C){return this.contains(g,I,C)?eg.extractStage(this.getRawValue(g,I,C)):0}setVoxelStage(g,I,C,A){const i=eg.insertStage(this.getRawValue(g,I,C),A);return this.setRawValue(g,I,C,i),A}getRedLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,i,t]=this.toLocal(g,I,C);return this.getLocalRedLight(A,i,t)}setRedLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.setLocalRedLight(i,t,s,A)}getGreenLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,i,t]=this.toLocal(g,I,C);return this.getLocalGreenLight(A,i,t)}setGreenLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.setLocalGreenLight(i,t,s,A)}getBlueLight(g,I,C){if(!this.contains(g,I,C))return 0;const[A,i,t]=this.toLocal(g,I,C);return this.getLocalBlueLight(A,i,t)}setBlueLight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.setLocalBlueLight(i,t,s,A)}getTorchLight(g,I,C,A){switch(A){case"RED":return this.getRedLight(g,I,C);case"GREEN":return this.getGreenLight(g,I,C);case"BLUE":return this.getBlueLight(g,I,C);default:throw new Error("Received unknown light color...")}}setTorchLight(g,I,C,A,i){switch(i){case"RED":return this.setRedLight(g,I,C,A);case"GREEN":return this.setGreenLight(g,I,C,A);case"BLUE":return this.setBlueLight(g,I,C,A);default:throw new Error("Received unknown light color...")}}getSunlight(g,I,C){if(!this.contains(g,I,C))return I<0?0:this.options.maxLightLevel;const[A,i,t]=this.toLocal(g,I,C);return this.getLocalSunlight(A,i,t)}setSunlight(g,I,C,A){if(!this.contains(g,I,C))return 0;const[i,t,s]=this.toLocal(g,I,C);return this.setLocalSunlight(i,t,s,A)}get isReady(){return 0!==this.lights.data.length&&0!==this.voxels.data.length}getLocalRedLight(g,I,C){return hg.extractRedLight(this.lights.get(g,I,C))}setLocalRedLight(g,I,C,A){return this.lights.set(g,I,C,hg.insertRedLight(this.lights.get(g,I,C),A))}getLocalGreenLight(g,I,C){return hg.extractGreenLight(this.lights.get(g,I,C))}setLocalGreenLight(g,I,C,A){return this.lights.set(g,I,C,hg.insertGreenLight(this.lights.get(g,I,C),A))}getLocalBlueLight(g,I,C){return hg.extractBlueLight(this.lights.get(g,I,C))}setLocalBlueLight(g,I,C,A){return this.lights.set(g,I,C,hg.insertBlueLight(this.lights.get(g,I,C),A))}getLocalSunlight(g,I,C){return hg.extractSunlight(this.lights.get(g,I,C))}setLocalSunlight(g,I,C,A){return this.lights.set(g,I,C,hg.insertSunlight(this.lights.get(g,I,C),A))}toLocal(g,I,C){const[A,i,t]=this.min;return[(0|g)-A,(0|I)-i,(0|C)-t]}contains(g,I,C){const{size:A,maxHeight:i}=this.options,[t,s,o]=this.toLocal(g,I,C);return t<A&&s>=0&&s<i&&o>=0&&o<A}}class lC extends eC{constructor(g,I,C){super(g,I,C),this.meshes=new Map,this.added=!1,this.isDirty=!1,this.group=new i.YJl}setData(g){const{id:I,x:C,z:A}=g;if(this.id!==I)throw new Error("Chunk id mismatch");if(this.coords[0]!==C||this.coords[1]!==A)throw new Error("Chunk coords mismatch");const{voxels:i,lights:t}=g;t&&t.byteLength&&(this.lights.data=t),i&&i.byteLength&&(this.voxels.data=i)}dispose(){this.meshes.forEach((g=>{g.forEach((g=>{var I;g&&(null==(I=g.geometry)||I.dispose(),g.parent&&g.parent.remove(g))}))}))}}class dC{constructor(){this.materials=new Map,this.uniforms={fogColor:{value:new i.Q1f("#B1CCFD")},fogNear:{value:100},fogFar:{value:200},ao:{value:new i.IUQ(100,170,210,255)},minLightLevel:{value:0},sunlightIntensity:{value:1},time:{value:performance.now()},lightIntensityAdjustment:{value:.8}},this.requested=new Map,this.toAdd=[],this.toRequest=[],this.toRequestSet=new Set,this.loaded=new Map,this.toProcess=[],this.toProcessSet=new Set,this.toUpdate=[],this.toEmit=[]}}class nC{constructor(){this.textures=new Map,this.images=new Map,this.audioBuffers=new Map,this.progress=0,this.manager=new i.KPJ,this.textureLoader=new i.Tap(this.manager),this.audioLoader=new i.Am1(this.manager),this.assetPromises=new Map,this.audioCallbacks=new Map,this.loadGifImages=(g,I)=>{const C=new Promise((C=>{(async()=>{const A=await fetch(g),i=await A.blob(),t=await i.arrayBuffer(),s=new Uint8Array(t),o=new S.u(s),e=o.frameInfo(0),l=new Array(o.numFrames()).fill(0).map(((g,I)=>{const C=new ImageData(e.width,e.height);o.decodeAndBlitFrameRGBA(I,C.data);const A=document.createElement("canvas"),i=A.getContext("2d");A.width=C.width,A.height=C.height,i.putImageData(C,0,0);const t=new Image;return t.src=A.toDataURL(),t}));this.images.set(g,l),this.assetPromises.delete(g),null==I||I(l),C(l)})()}));return this.assetPromises.set(g,C),C},this.loadTexture=(g,I)=>{const C=new Promise((C=>{this.textureLoader.load(g,(A=>{this.textures.set(g,A),this.assetPromises.delete(g),null==I||I(A),C(A)}))}));return this.assetPromises.set(g,C),C},this.loadImage=(g,I)=>{const C=new Promise(((C,A)=>{const i=new Image;i.crossOrigin="anonymous",i.src=g,i.onerror=A,i.onload=()=>{this.assetPromises.delete(g),null==I||I(i),C(i)}}));return this.assetPromises.set(g,C),C},this.getTexture=g=>{const I=this.textures.get(g);if(Array.isArray(I))throw new Error("`getTexture` was called on a gif texture. Use `getGifTexture` instead.");return I},this.getGifTexture=g=>{const I=this.textures.get(g);if(!Array.isArray(I))throw new Error("`getGifTexture` was called on a non-gif texture. Use `getTexture` instead.");return I},this.loadAudioBuffer=(g,I)=>new Promise((C=>{this.audioCallbacks.set(g,(async()=>new Promise((A=>{this.audioLoader.load(g,(g=>{null==I||I(g),A(g),C(g)}))}))))})),this.load=async()=>{await Promise.all(Array.from(this.assetPromises.values())),this.assetPromises.clear()},this.loadAudios=async()=>{for(const[g,I]of this.audioCallbacks){const C=await I();this.audioBuffers.set(g,C)}this.audioCallbacks.clear()},this.manager.onProgress=(g,I,C)=>{this.progress=I/C};const g=()=>{this.loadAudios(),window.removeEventListener("click",g)};window.addEventListener("click",g)}}class cC{constructor(){this.blocksByName=new Map,this.blocksById=new Map,this.nameMap=new Map,this.idMap=new Map}serialize(){const g=g=>{const{dynamicFn:I,...C}=g;return C};return JSON.parse(JSON.stringify({blocksByName:Array.from(this.blocksByName.entries()).map((([I,C])=>[I,g(C)])),blocksById:Array.from(this.blocksById.entries()).map((([I,C])=>[I,g(C)])),nameMap:Array.from(this.nameMap.entries()),idMap:Array.from(this.idMap.entries())}))}static deserialize(g){const I=new cC;return I.blocksByName=new Map(g.blocksByName),I.blocksById=new Map(g.blocksById),I.nameMap=new Map(g.nameMap),I.idMap=new Map(g.idMap),I}}const aC={vertex:i.zkh.basic.vertexShader.replace("#include <common>","\nattribute int light;\n\nvarying float vAO;\nvarying vec4 vLight;\nvarying vec4 vWorldPosition;\nuniform vec4 uAOTable;\nuniform float uTime;\n\nvec4 unpackLight(int l) {\n  vec4 lightValues = vec4(\n    (l >> 8) & 0xF,\n    (l >> 4) & 0xF,\n    l & 0xF,\n    (l >> 12) & 0xF\n  );\n  return lightValues / 15.0;\n}\n\n#include <common>\n").replace("#include <color_vertex>","\n#include <color_vertex>\n\nint ao = light >> 16;\n\nvAO = uAOTable[ao] / 255.0;\n\nvLight = unpackLight(light & 0xFFFF);\n").replace("#include <worldpos_vertex>","\nvec4 worldPosition = vec4( transformed, 1.0 );\n#ifdef USE_INSTANCING\n  worldPosition = instanceMatrix * worldPosition;\n#endif\nworldPosition = modelMatrix * worldPosition;\nvWorldPosition = worldPosition;\n"),fragment:i.zkh.basic.fragmentShader.replace("#include <common>","\nuniform vec3 uFogColor;\nuniform float uFogNear;\nuniform float uFogFar;\nuniform float uSunlightIntensity;\nuniform float uMinLightLevel;\nuniform float uLightIntensityAdjustment;\nuniform float uTime;\nvarying float vAO;\nvarying vec4 vLight; \nvarying vec4 vWorldPosition;\n\n#include <common>\n").replace("#include <envmap_fragment>","\n#include <envmap_fragment>\n\n// Adjusting light intensity for lighter voxel textures\nfloat scale = 2.0;\nfloat s = clamp(vLight.a * vLight.a * uSunlightIntensity * uLightIntensityAdjustment, uMinLightLevel, 1.0);\ns -= s * exp(-s) * 0.02; // Optimized smoothing with adjusted intensity\n\n// Applying adjusted light intensity\noutgoingLight.rgb *= s + pow(vLight.rgb * uLightIntensityAdjustment, vec3(scale));\noutgoingLight *= vAO;\n").replace("#include <fog_fragment>","\n    vec3 fogOrigin = cameraPosition;\n\n    float depth = sqrt(pow(vWorldPosition.x - fogOrigin.x, 2.0) + pow(vWorldPosition.z - fogOrigin.z, 2.0));\n    float fogFactor = smoothstep(uFogNear, uFogFar, depth);\n\n    gl_FragColor.rgb = mix(gl_FragColor.rgb, uFogColor, fogFactor);\n    ")},hC={sway(g={}){const{speed:I,amplitude:C,rooted:A,scale:i,yScale:t}={speed:1,amplitude:.1,rooted:!1,scale:1,yScale:1,...g};return{vertexShader:aC.vertex.replace("#include <common>","\n//\tSimplex 3D Noise \n//\tby Ian McEwan, Ashima Arts\n//\nvec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}\nvec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}\n\nfloat snoise(vec3 v){ \n  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;\n  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n\n// First corner\n  vec3 i  = floor(v + dot(v, C.yyy) );\n  vec3 x0 =   v - i + dot(i, C.xxx) ;\n\n// Other corners\n  vec3 g = step(x0.yzx, x0.xyz);\n  vec3 l = 1.0 - g;\n  vec3 i1 = min( g.xyz, l.zxy );\n  vec3 i2 = max( g.xyz, l.zxy );\n\n  //  x0 = x0 - 0. + 0.0 * C \n  vec3 x1 = x0 - i1 + 1.0 * C.xxx;\n  vec3 x2 = x0 - i2 + 2.0 * C.xxx;\n  vec3 x3 = x0 - 1. + 3.0 * C.xxx;\n\n// Permutations\n  i = mod(i, 289.0 ); \n  vec4 p = permute( permute( permute( \n             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))\n           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) \n           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));\n\n// Gradients\n// ( N*N points uniformly over a square, mapped onto an octahedron.)\n  float n_ = 1.0/7.0; // N=7\n  vec3  ns = n_ * D.wyz - D.xzx;\n\n  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)\n\n  vec4 x_ = floor(j * ns.z);\n  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)\n\n  vec4 x = x_ *ns.x + ns.yyyy;\n  vec4 y = y_ *ns.x + ns.yyyy;\n  vec4 h = 1.0 - abs(x) - abs(y);\n\n  vec4 b0 = vec4( x.xy, y.xy );\n  vec4 b1 = vec4( x.zw, y.zw );\n\n  vec4 s0 = floor(b0)*2.0 + 1.0;\n  vec4 s1 = floor(b1)*2.0 + 1.0;\n  vec4 sh = -step(h, vec4(0.0));\n\n  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;\n  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;\n\n  vec3 p0 = vec3(a0.xy,h.x);\n  vec3 p1 = vec3(a0.zw,h.y);\n  vec3 p2 = vec3(a1.xy,h.z);\n  vec3 p3 = vec3(a1.zw,h.w);\n\n//Normalise gradients\n  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));\n  p0 *= norm.x;\n  p1 *= norm.y;\n  p2 *= norm.z;\n  p3 *= norm.w;\n\n// Mix final noise value\n  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n  m = m * m;\n  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), \n                                dot(p2,x2), dot(p3,x3) ) );\n}\n").replace("#include <begin_vertex>",`\nvec3 transformed = vec3(position);\nfloat scale = uTime * 0.00002 * ${I.toFixed(2)};\ntransformed.x = position.x \n             + ${A?"(position.y - floor(position.y))":"1.0"} * ${i.toFixed(2)} * snoise(vec3(position.x * scale, position.y * scale * ${t.toFixed(2)}, position.z * scale)) * 2.0 * ${C.toFixed(2)};\n`),fragmentShader:aC.fragment}}};class ZC extends i.GOR{constructor(g,I,C=document.createElement("canvas")){if(super(C),this.atlasMargin=0,this.atlasOffset=0,this.atlasRatio=0,this.animations=[],this.canvas=C,this.countPerSide=g,this.dimension=I,1===g)this.atlasOffset=0,this.atlasRatio=1,this.atlasMargin=0;else for(this.atlasOffset=1/(4*g),this.atlasMargin=1,this.atlasRatio=(this.atlasMargin/this.atlasOffset/g-2*this.atlasMargin)/I;this.atlasRatio!==Math.floor(this.atlasRatio);)this.atlasRatio*=2,this.atlasMargin*=2;const A=(I*this.atlasRatio+2*this.atlasMargin)*g,t=(I*this.atlasRatio+2*this.atlasMargin)*g;this.canvas.width=A,this.canvas.height=t;const s=this.canvas.getContext("2d");s.imageSmoothingEnabled=!1,this.makeCanvasPowerOfTwo(this.canvas),this.wrapS=i.ghU,this.wrapT=i.ghU,this.minFilter=i.hxR,this.magFilter=i.hxR,this.generateMipmaps=!1,this.needsUpdate=!0,this.colorSpace=i.er$;const o=ZC.makeUnknownImage(A/g);for(let i=0;i<g;i++)for(let I=0;I<g;I++)s.drawImage(o,i/g*A,I/g*t,A/g,t/g)}paintColor(g){this.drawImageToRange({startU:0,endU:1,startV:0,endV:1},g)}drawImageToRange(g,I,C=!0,A=1){const{startU:i,endV:t}=g,s=ug.isTexture(I)?I.image:I;if(!s)return;const o=this.canvas.getContext("2d");o.save();const e=this.canvas.width,l=this.canvas.height;if(o.globalAlpha=A,1!==A&&(o.globalCompositeOperation="lighter"),C&&o.clearRect((i-this.atlasOffset)*e,(1-t-this.atlasOffset)*l,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin),I.isColor)return o.fillStyle=`#${I.getHexString()}`,void o.fillRect((i-this.atlasOffset)*e,(1-t-this.atlasOffset)*l,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin);C&&(o.drawImage(s,(i-this.atlasOffset)*e,(1-t-this.atlasOffset)*l,this.dimension*this.atlasRatio+2*this.atlasMargin,this.dimension*this.atlasRatio+2*this.atlasMargin),o.clearRect((i-this.atlasOffset)*e+this.atlasMargin,(1-t-this.atlasOffset)*l+this.atlasMargin,this.dimension*this.atlasRatio,this.dimension*this.atlasRatio)),o.drawImage(s,(i-this.atlasOffset)*e+this.atlasMargin,(1-t-this.atlasOffset)*l+this.atlasMargin,this.dimension*this.atlasRatio,this.dimension*this.atlasRatio),o.restore(),this.needsUpdate=!0}registerAnimation(g,I,C=0){const A=new mC(g,I,C),i={animation:A,timer:null},t=(I=0)=>{const s=A.keyframes[I];this.drawImageToRange(g,s[1],1!==this.countPerSide),i.timer=setTimeout((()=>{clearTimeout(i.timer);const o=(I+1)%A.keyframes.length;if(C>0){const I=A.keyframes[o],i=(A=0)=>{A>C?t(o):(requestAnimationFrame((()=>i(A+1))),this.drawImageToRange(g,I[1],!0,A/C),this.drawImageToRange(g,s[1],!1,1-A/C),this.needsUpdate=!0)};i()}else t(o);this.needsUpdate=!0}),s[0])};this.animations.push(i),t()}makeCanvasPowerOfTwo(g){var I;let C=!1;g||(g=this.canvas,C=!0);const A=g.width,i=g.height,t=Math.pow(2,Math.round(Math.log(A)/Math.log(2))),s=Math.pow(2,Math.round(Math.log(i)/Math.log(2))),o=document.createElement("canvas");o.width=t,o.height=s,null==(I=o.getContext("2d"))||I.drawImage(g,0,0,t,s),C&&(this.canvas=o)}static makeUnknownImage(g,I="#0A2647",C="#E1D7C6"){const A=document.createElement("canvas"),i=A.getContext("2d");return i.imageSmoothingEnabled=!1,i.canvas.width=g,i.canvas.height=g,i.fillStyle=C,i.fillRect(0,0,g,g),i.fillStyle=I,i.textAlign="center",i.textBaseline="middle",i.fillText("?",g/2,g/2,g),A}static makeUnknownTexture(g){const I=new ZC(1,g),C=ZC.makeUnknownImage(g);return I.drawImageToRange({startU:0,endU:0,startV:0,endV:0},C),I.minFilter=i.hxR,I.magFilter=i.hxR,I.generateMipmaps=!1,I.needsUpdate=!0,I.colorSpace=i.er$,I}}class mC{constructor(g,I,C=0){if(!g)throw new Error("Texture range is required for FaceAnimation.");if(I.length<=1)throw new Error("FaceAnimation must have at least two keyframe.");this.range=g,this.keyframes=I,this.fadeFrames=C}}const bC="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX0FBQkIgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKSB7CiAgICAgIHRoaXMubWluWCA9IG1pblg7CiAgICAgIHRoaXMubWluWSA9IG1pblk7CiAgICAgIHRoaXMubWluWiA9IG1pblo7CiAgICAgIHRoaXMubWF4WCA9IG1heFg7CiAgICAgIHRoaXMubWF4WSA9IG1heFk7CiAgICAgIHRoaXMubWF4WiA9IG1heFo7CiAgICAgIHRoaXMuZ2V0TWluID0gKGF4aXMpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubWluWDsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1pblk7CiAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5taW5aOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdldE1pbkVycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICB0aGlzLnNldE1pbiA9IChheGlzLCB2YWx1ZSkgPT4gewogICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICB0aGlzLm1pblggPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHRoaXMubWluWSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5taW5aID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0TWluRXJyb3I6IFVua25vd24gYXhpcy4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMuZ2V0TWF4ID0gKGF4aXMpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubWF4WDsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1heFk7CiAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYXhaOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdldE1heEVycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICB0aGlzLnNldE1heCA9IChheGlzLCB2YWx1ZSkgPT4gewogICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICB0aGlzLm1heFggPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHRoaXMubWF4WSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5tYXhaID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0TWF4RXJyb3I6IFVua25vd24gYXhpcy4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMudHJhbnNsYXRlID0gKFtkeCwgZHksIGR6XSkgPT4gewogICAgICAgIHRoaXMubWluWCArPSBkeDsKICAgICAgICB0aGlzLm1pblkgKz0gZHk7CiAgICAgICAgdGhpcy5taW5aICs9IGR6OwogICAgICAgIHRoaXMubWF4WCArPSBkeDsKICAgICAgICB0aGlzLm1heFkgKz0gZHk7CiAgICAgICAgdGhpcy5tYXhaICs9IGR6OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwogICAgICB0aGlzLnRyYW5zbGF0ZUF4aXMgPSAoYXhpcywgZGVsdGEpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgdGhpcy5taW5YICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhYICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMSkgewogICAgICAgICAgdGhpcy5taW5ZICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhZICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5taW5aICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhaICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyYW5zbGF0ZUF4aXNFcnJvcjogVW5rbm93biBheGlzLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfTsKICAgICAgdGhpcy5zZXRQb3NpdGlvbiA9IChbcHgsIHB5LCBwel0pID0+IHsKICAgICAgICB0aGlzLm1heFggPSBweCArIHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5tYXhZID0gcHkgKyB0aGlzLmhlaWdodDsKICAgICAgICB0aGlzLm1heFogPSBweiArIHRoaXMuZGVwdGg7CiAgICAgICAgdGhpcy5taW5YID0gcHg7CiAgICAgICAgdGhpcy5taW5ZID0gcHk7CiAgICAgICAgdGhpcy5taW5aID0gcHo7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH07CiAgICAgIHRoaXMuaW50ZXJzZWN0cyA9IChhYWJiKSA9PiB7CiAgICAgICAgaWYgKGFhYmIubWluWCA+PSB0aGlzLm1heFgpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWluWSA+PSB0aGlzLm1heFkpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWluWiA+PSB0aGlzLm1heFopCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WCA8PSB0aGlzLm1pblgpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WSA8PSB0aGlzLm1pblkpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WiA8PSB0aGlzLm1pblopCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CiAgICAgIHRoaXMudG91Y2hlcyA9IChhYWJiKSA9PiB7CiAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gdGhpcy5pbnRlcnNlY3Rpb24oYWFiYik7CiAgICAgICAgcmV0dXJuIGludGVyc2VjdGlvbiAhPT0gbnVsbCAmJiAoaW50ZXJzZWN0aW9uLndpZHRoID09PSAwIHx8IGludGVyc2VjdGlvbi5oZWlnaHQgPT09IDAgfHwgaW50ZXJzZWN0aW9uLmRlcHRoID09PSAwKTsKICAgICAgfTsKICAgICAgdGhpcy51bmlvbiA9IChhYWJiKSA9PiB7CiAgICAgICAgcmV0dXJuIG5ldyBfQUFCQigKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWCwgYWFiYi5taW5YKSwKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWSwgYWFiYi5taW5ZKSwKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWiwgYWFiYi5taW5aKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WCwgYWFiYi5tYXhYKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WSwgYWFiYi5tYXhZKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WiwgYWFiYi5tYXhaKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uID0gKGFhYmIpID0+IHsKICAgICAgICByZXR1cm4gbmV3IF9BQUJCKAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5YLCBhYWJiLm1pblgpLAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5ZLCBhYWJiLm1pblkpLAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5aLCBhYWJiLm1pblopLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhYLCBhYWJiLm1heFgpLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhZLCBhYWJiLm1heFkpLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhaLCBhYWJiLm1heFopCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgdGhpcy5jbG9uZSA9ICgpID0+IHsKICAgICAgICByZXR1cm4gbmV3IF9BQUJCKAogICAgICAgICAgdGhpcy5taW5YLAogICAgICAgICAgdGhpcy5taW5ZLAogICAgICAgICAgdGhpcy5taW5aLAogICAgICAgICAgdGhpcy5tYXhYLAogICAgICAgICAgdGhpcy5tYXhZLAogICAgICAgICAgdGhpcy5tYXhaCiAgICAgICAgKTsKICAgICAgfTsKICAgIH0KICAgIGdldCB3aWR0aCgpIHsKICAgICAgcmV0dXJuIHRoaXMubWF4WCAtIHRoaXMubWluWDsKICAgIH0KICAgIGdldCBoZWlnaHQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1heFkgLSB0aGlzLm1pblk7CiAgICB9CiAgICBnZXQgZGVwdGgoKSB7CiAgICAgIHJldHVybiB0aGlzLm1heFogLSB0aGlzLm1pblo7CiAgICB9CiAgICBnZXQgbWFnKCkgewogICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICh0aGlzLm1heFggLSB0aGlzLm1pblgpICoqIDIgKyAodGhpcy5tYXhZIC0gdGhpcy5taW5ZKSAqKiAyICsgKHRoaXMubWF4WiAtIHRoaXMubWluWikgKiogMgogICAgICApOwogICAgfQogICAgY29tcHV0ZU9mZnNldFgoYWFiYiwgZGVsdGFYKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLmhlaWdodCA8PSAwIHx8IGludGVyc2VjdGlvbi5kZXB0aCA8PSAwKSB7CiAgICAgICAgcmV0dXJuIGRlbHRhWDsKICAgICAgfQogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFYID4gMCAmJiBhYWJiLm1pblggPj0gdGhpcy5tYXhYKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWCAtIHRoaXMubWF4WCwgZGVsdGFYKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFYIDwgMCAmJiBhYWJiLm1heFggPD0gdGhpcy5taW5YKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WCAtIHRoaXMubWluWCwgZGVsdGFYKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFYOwogICAgfQogICAgY29tcHV0ZU9mZnNldFkoYWFiYiwgZGVsdGFZKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoIDw9IDAgfHwgaW50ZXJzZWN0aW9uLmRlcHRoIDw9IDApIHsKICAgICAgICByZXR1cm4gZGVsdGFZOwogICAgICB9CiAgICAgIGlmIChpbnRlcnNlY3Rpb24uaGVpZ2h0ID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFZID4gMCAmJiBhYWJiLm1pblkgPj0gdGhpcy5tYXhZKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWSAtIHRoaXMubWF4WSwgZGVsdGFZKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFZIDwgMCAmJiBhYWJiLm1heFkgPD0gdGhpcy5taW5ZKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WSAtIHRoaXMubWluWSwgZGVsdGFZKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFZOwogICAgfQogICAgY29tcHV0ZU9mZnNldFooYWFiYiwgZGVsdGFaKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoIDw9IDAgfHwgaW50ZXJzZWN0aW9uLmhlaWdodCA8PSAwKSB7CiAgICAgICAgcmV0dXJuIGRlbHRhWjsKICAgICAgfQogICAgICBpZiAoaW50ZXJzZWN0aW9uLmRlcHRoID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFaID4gMCAmJiBhYWJiLm1pblogPj0gdGhpcy5tYXhaKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWiAtIHRoaXMubWF4WiwgZGVsdGFaKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFaIDwgMCAmJiBhYWJiLm1heFogPD0gdGhpcy5taW5aKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WiAtIHRoaXMubWluWiwgZGVsdGFaKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFaOwogICAgfQogIH07CiAgdmFyIEFBQkIgPSBfQUFCQjsKICBBQUJCLnVuaW9uID0gKGFsbCkgPT4gewogICAgbGV0IG1pblggPSBhbGxbMF0ubWluWDsKICAgIGxldCBtaW5ZID0gYWxsWzBdLm1pblk7CiAgICBsZXQgbWluWiA9IGFsbFswXS5taW5aOwogICAgbGV0IG1heFggPSBhbGxbMF0ubWF4WDsKICAgIGxldCBtYXhZID0gYWxsWzBdLm1heFk7CiAgICBsZXQgbWF4WiA9IGFsbFswXS5tYXhaOwogICAgZm9yIChjb25zdCBhYWJiIG9mIGFsbCkgewogICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgYWFiYi5taW5YKTsKICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIGFhYmIubWluWSk7CiAgICAgIG1pblogPSBNYXRoLm1pbihtaW5aLCBhYWJiLm1pblopOwogICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgYWFiYi5tYXhYKTsKICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIGFhYmIubWF4WSk7CiAgICAgIG1heFogPSBNYXRoLm1heChtYXhaLCBhYWJiLm1heFopOwogICAgfQogICAgcmV0dXJuIG5ldyBfQUFCQihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKTsKICB9OwogIHZhciBCbG9ja1J1bGVMb2dpYyA9IC8qIEBfX1BVUkVfXyAqLyAoKEJsb2NrUnVsZUxvZ2ljMikgPT4gewogICAgQmxvY2tSdWxlTG9naWMyWyJBbmQiXSA9ICJhbmQiOwogICAgQmxvY2tSdWxlTG9naWMyWyJPciJdID0gIm9yIjsKICAgIEJsb2NrUnVsZUxvZ2ljMlsiTm90Il0gPSAibm90IjsKICAgIHJldHVybiBCbG9ja1J1bGVMb2dpYzI7CiAgfSkoQmxvY2tSdWxlTG9naWMgfHwge30pOwogIGNvbnN0IFBZX1JPVEFUSU9OID0gMDsKICBjb25zdCBOWV9ST1RBVElPTiA9IDE7CiAgY29uc3QgUFhfUk9UQVRJT04gPSAyOwogIGNvbnN0IE5YX1JPVEFUSU9OID0gMzsKICBjb25zdCBQWl9ST1RBVElPTiA9IDQ7CiAgY29uc3QgTlpfUk9UQVRJT04gPSA1OwogIGNvbnN0IFlfUk9UX1NFR01FTlRTID0gMTY7CiAgY29uc3QgUEkgPSBNYXRoLlBJOwogIGNvbnN0IFBJXzIgPSBNYXRoLlBJIC8gMjsKICBjb25zdCBfQmxvY2tSb3RhdGlvbiA9IGNsYXNzIF9CbG9ja1JvdGF0aW9uIHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGJsb2NrIHJvdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgYXhpcyB0aGlzIGJsb2NrIGlzIHBvaW50aW5nIHRvd2FyZHMuCiAgICAgKiBAcGFyYW0geVJvdGF0aW9uIFRoZSByb3RhdGlvbiBhcm91bmQgdGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLCByb3VuZGVkIHRvIHRoZSBuZWFyZXN0ICgzNjAgLyAxNikgZGVncmVlcy4KICAgICAqLwogICAgY29uc3RydWN0b3IodmFsdWUgPSBQWV9ST1RBVElPTiwgeVJvdGF0aW9uID0gMCkgewogICAgICB0aGlzLnJvdGF0ZU5vZGUgPSAobm9kZSwgeVJvdGF0ZSA9IHRydWUsIHRyYW5zbGF0ZSA9IHRydWUpID0+IHsKICAgICAgICBpZiAoeVJvdGF0ZSAmJiB0aGlzLnlSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgbm9kZVswXSAtPSAwLjU7CiAgICAgICAgICBub2RlWzJdIC09IDAuNTsKICAgICAgICAgIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVkobm9kZSwgdGhpcy55Um90YXRpb24pOwogICAgICAgICAgbm9kZVswXSArPSAwLjU7CiAgICAgICAgICBub2RlWzJdICs9IDAuNTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoICh0aGlzLnZhbHVlKSB7CiAgICAgICAgICBjYXNlIFBYX1JPVEFUSU9OOiB7CiAgICAgICAgICAgIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVoobm9kZSwgLVBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzFdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBOWF9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVaKG5vZGUsIFBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzBdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBQWV9ST1RBVElPTjogewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgTllfUk9UQVRJT046IHsKICAgICAgICAgICAgX0Jsb2NrUm90YXRpb24ucm90YXRlWChub2RlLCBQSSk7CiAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIHsKICAgICAgICAgICAgICBub2RlWzFdICs9IDE7CiAgICAgICAgICAgICAgbm9kZVsyXSArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBQWl9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVYKG5vZGUsIFBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzFdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBOWl9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVYKG5vZGUsIC1QSV8yKTsKICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSkgbm9kZVsyXSArPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMucm90YXRlQUFCQiA9IChhYWJiLCB5Um90YXRlID0gdHJ1ZSwgdHJhbnNsYXRlID0gdHJ1ZSkgPT4gewogICAgICAgIGNvbnN0IG1pbjIgPSBbYWFiYi5taW5YLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgY29uc3QgbWF4MiA9IFthYWJiLm1heFgsIGFhYmIubWF4WSwgYWFiYi5tYXhaXTsKICAgICAgICBsZXQgbWluWCA9IG51bGw7CiAgICAgICAgbGV0IG1pblogPSBudWxsOwogICAgICAgIGxldCBtYXhYID0gbnVsbDsKICAgICAgICBsZXQgbWF4WiA9IG51bGw7CiAgICAgICAgaWYgKHlSb3RhdGUgJiYgdGhpcy55Um90YXRpb24gIT09IDApIHsKICAgICAgICAgIGNvbnN0IG1pbjEgPSBbYWFiYi5taW5YLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgICBjb25zdCBtaW4yMiA9IFthYWJiLm1pblgsIGFhYmIubWluWSwgYWFiYi5tYXhaXTsKICAgICAgICAgIGNvbnN0IG1pbjMgPSBbYWFiYi5tYXhYLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgICBjb25zdCBtaW40ID0gW2FhYmIubWF4WCwgYWFiYi5taW5ZLCBhYWJiLm1heFpdOwogICAgICAgICAgW21pbjEsIG1pbjIyLCBtaW4zLCBtaW40XS5mb3JFYWNoKChtaW41KSA9PiB7CiAgICAgICAgICAgIHRoaXMucm90YXRlTm9kZShtaW41LCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgbWluWCA9IG1pblggPT09IG51bGwgPyBtaW41WzBdIDogTWF0aC5taW4obWluWCwgbWluNVswXSk7CiAgICAgICAgICAgIG1pblogPSBtaW5aID09PSBudWxsID8gbWluNVsyXSA6IE1hdGgubWluKG1pblosIG1pbjVbMl0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBtYXgxID0gW2FhYmIubWluWCwgYWFiYi5tYXhZLCBhYWJiLm1pblpdOwogICAgICAgICAgY29uc3QgbWF4MjIgPSBbYWFiYi5taW5YLCBhYWJiLm1heFksIGFhYmIubWF4Wl07CiAgICAgICAgICBjb25zdCBtYXgzID0gW2FhYmIubWF4WCwgYWFiYi5tYXhZLCBhYWJiLm1pblpdOwogICAgICAgICAgY29uc3QgbWF4NCA9IFthYWJiLm1heFgsIGFhYmIubWF4WSwgYWFiYi5tYXhaXTsKICAgICAgICAgIFttYXgxLCBtYXgyMiwgbWF4MywgbWF4NF0uZm9yRWFjaCgobWF4NSkgPT4gewogICAgICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWF4NSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIG1heFggPSBtYXhYID09PSBudWxsID8gbWF4NVswXSA6IE1hdGgubWF4KG1heFgsIG1heDVbMF0pOwogICAgICAgICAgICBtYXhaID0gbWF4WiA9PT0gbnVsbCA/IG1heDVbMl0gOiBNYXRoLm1heChtYXhaLCBtYXg1WzJdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWluMiwgeVJvdGF0ZSwgdHJhbnNsYXRlKTsKICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWF4MiwgeVJvdGF0ZSwgdHJhbnNsYXRlKTsKICAgICAgICBjb25zdCBFUFNJTE9OMiA9IDFlLTQ7CiAgICAgICAgY29uc3QganVzdGlmeSA9IChudW0pID0+IG51bSA8IEVQU0lMT04yID8gMCA6IG51bTsKICAgICAgICBtaW4yWzBdID0ganVzdGlmeShtaW4yWzBdKTsKICAgICAgICBtaW4yWzFdID0ganVzdGlmeShtaW4yWzFdKTsKICAgICAgICBtaW4yWzJdID0ganVzdGlmeShtaW4yWzJdKTsKICAgICAgICBtYXgyWzBdID0ganVzdGlmeShtYXgyWzBdKTsKICAgICAgICBtYXgyWzFdID0ganVzdGlmeShtYXgyWzFdKTsKICAgICAgICBtYXgyWzJdID0ganVzdGlmeShtYXgyWzJdKTsKICAgICAgICBjb25zdCByZWFsTWluID0gWwogICAgICAgICAgbWluWCAhPT0gbnVsbCA/IGp1c3RpZnkobWluWCkgOiBNYXRoLm1pbihtaW4yWzBdLCBtYXgyWzBdKSwKICAgICAgICAgIE1hdGgubWluKG1pbjJbMV0sIG1heDJbMV0pLAogICAgICAgICAgbWluWiAhPT0gbnVsbCA/IGp1c3RpZnkobWluWikgOiBNYXRoLm1pbihtaW4yWzJdLCBtYXgyWzJdKQogICAgICAgIF07CiAgICAgICAgY29uc3QgcmVhbE1heCA9IFsKICAgICAgICAgIG1heFggIT09IG51bGwgPyBqdXN0aWZ5KG1heFgpIDogTWF0aC5tYXgobWluMlswXSwgbWF4MlswXSksCiAgICAgICAgICBNYXRoLm1heChtaW4yWzFdLCBtYXgyWzFdKSwKICAgICAgICAgIG1heFogIT09IG51bGwgPyBqdXN0aWZ5KG1heFopIDogTWF0aC5tYXgobWluMlsyXSwgbWF4MlsyXSkKICAgICAgICBdOwogICAgICAgIHJldHVybiBuZXcgQUFCQigKICAgICAgICAgIHJlYWxNaW5bMF0sCiAgICAgICAgICByZWFsTWluWzFdLAogICAgICAgICAgcmVhbE1pblsyXSwKICAgICAgICAgIHJlYWxNYXhbMF0sCiAgICAgICAgICByZWFsTWF4WzFdLAogICAgICAgICAgcmVhbE1heFsyXQogICAgICAgICk7CiAgICAgIH07CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgdGhpcy55Um90YXRpb24gPSB5Um90YXRpb247CiAgICB9CiAgICByb3RhdGVUcmFuc3BhcmVuY3koW3B4LCBweSwgcHosIG54LCBueSwgbnpdKSB7CiAgICAgIGNvbnN0IHJvdCA9IHRoaXMudmFsdWU7CiAgICAgIGlmIChNYXRoLmFicyhyb3QpIDwgTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICByZXR1cm4gW3B4LCBweSwgcHosIG54LCBueSwgbnpdOwogICAgICB9CiAgICAgIGNvbnN0IHBvc2l0aXZlID0gWzEsIDIsIDNdOwogICAgICBjb25zdCBuZWdhdGl2ZSA9IFs0LCA1LCA2XTsKICAgICAgdGhpcy5yb3RhdGVOb2RlKHBvc2l0aXZlLCB0cnVlLCBmYWxzZSk7CiAgICAgIHRoaXMucm90YXRlTm9kZShuZWdhdGl2ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICBjb25zdCBwID0gcG9zaXRpdmUubWFwKChuMikgPT4gewogICAgICAgIGlmIChuMiA9PT0gMSkgcmV0dXJuIHB4OwogICAgICAgIGlmIChuMiA9PT0gMikgcmV0dXJuIHB5OwogICAgICAgIGlmIChuMiA9PT0gMykgcmV0dXJuIHB6OwogICAgICAgIGlmIChuMiA9PT0gNCkgcmV0dXJuIG54OwogICAgICAgIGlmIChuMiA9PT0gNSkgcmV0dXJuIG55OwogICAgICAgIHJldHVybiBuejsKICAgICAgfSk7CiAgICAgIGNvbnN0IG4gPSBuZWdhdGl2ZS5tYXAoKG4yKSA9PiB7CiAgICAgICAgaWYgKG4yID09PSAxKSByZXR1cm4gcHg7CiAgICAgICAgaWYgKG4yID09PSAyKSByZXR1cm4gcHk7CiAgICAgICAgaWYgKG4yID09PSAzKSByZXR1cm4gcHo7CiAgICAgICAgaWYgKG4yID09PSA0KSByZXR1cm4gbng7CiAgICAgICAgaWYgKG4yID09PSA1KSByZXR1cm4gbnk7CiAgICAgICAgcmV0dXJuIG56OwogICAgICB9KTsKICAgICAgcmV0dXJuIFtwWzBdLCBwWzFdLCBwWzJdLCBuWzBdLCBuWzFdLCBuWzJdXTsKICAgIH0KICB9OwogIF9CbG9ja1JvdGF0aW9uLmVuY29kZSA9ICh2YWx1ZSwgeVJvdGF0aW9uID0gMCkgPT4gewogICAgY29uc3QgeUVuY29kZWQgPSB5Um90YXRpb24gKiBNYXRoLlBJICogMiAvIFlfUk9UX1NFR01FTlRTOwogICAgcmV0dXJuIG5ldyBfQmxvY2tSb3RhdGlvbih2YWx1ZSwgeUVuY29kZWQpOwogIH07CiAgX0Jsb2NrUm90YXRpb24uZGVjb2RlID0gKHJvdGF0aW9uKSA9PiB7CiAgICBjb25zdCB2YWx1ZSA9IHJvdGF0aW9uLnZhbHVlOwogICAgY29uc3QgeURlY29kZWQgPSBNYXRoLnJvdW5kKHJvdGF0aW9uLnlSb3RhdGlvbiAqIFlfUk9UX1NFR01FTlRTIC8gKE1hdGguUEkgKiAyKSkgJSBZX1JPVF9TRUdNRU5UUzsKICAgIHJldHVybiBbdmFsdWUsIHlEZWNvZGVkXTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVggPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbLCB5LCB6XSA9IG5vZGU7CiAgICBub2RlWzFdID0geSAqIGNvc1RoZXRhIC0geiAqIHNpblRoZXRhOwogICAgbm9kZVsyXSA9IHogKiBjb3NUaGV0YSArIHkgKiBzaW5UaGV0YTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVkgPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbeCwgLCB6XSA9IG5vZGU7CiAgICBub2RlWzBdID0geCAqIGNvc1RoZXRhICsgeiAqIHNpblRoZXRhOwogICAgbm9kZVsyXSA9IHogKiBjb3NUaGV0YSAtIHggKiBzaW5UaGV0YTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVogPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbeCwgeV0gPSBub2RlOwogICAgbm9kZVswXSA9IHggKiBjb3NUaGV0YSAtIHkgKiBzaW5UaGV0YTsKICAgIG5vZGVbMV0gPSB5ICogY29zVGhldGEgKyB4ICogc2luVGhldGE7CiAgfTsKICBsZXQgQmxvY2tSb3RhdGlvbiA9IF9CbG9ja1JvdGF0aW9uOwogIGNvbnN0IFJPVEFUSU9OX01BU0sgPSA0MjkzOTg0MjU1OwogIGNvbnN0IFlfUk9UQVRJT05fTUFTSyA9IDQyNzkyMzg2NTU7CiAgY29uc3QgU1RBR0VfTUFTSyA9IDQwNDMzMDkwNTU7CiAgY29uc3QgX0Jsb2NrVXRpbHMgPSBjbGFzcyBfQmxvY2tVdGlscyB7CiAgICBzdGF0aWMgZ2V0QmxvY2tSb3RhdGVkVHJhbnNwYXJlbmN5KGJsb2NrLCByb3RhdGlvbikgewogICAgICByZXR1cm4gcm90YXRpb24ucm90YXRlVHJhbnNwYXJlbmN5KGJsb2NrLmlzVHJhbnNwYXJlbnQpOwogICAgfQogICAgc3RhdGljIGdldEJsb2NrRW50aXR5SWQoaWQsIHZveGVsKSB7CiAgICAgIGNvbnN0IFt2eCwgdnksIHZ6XSA9IHZveGVsOwogICAgICByZXR1cm4gYGJsb2NrOjoke2lkfTo6JHt2eH06OiR7dnl9Ojoke3Z6fWA7CiAgICB9CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgIH0KICB9OwogIF9CbG9ja1V0aWxzLmV4dHJhY3RJRCA9ICh2b3hlbCkgPT4gewogICAgcmV0dXJuIHZveGVsICYgNjU1MzU7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRJRCA9ICh2b3hlbCwgaWQpID0+IHsKICAgIHJldHVybiB2b3hlbCAmIDQyOTQ5MDE3NjAgfCBpZCAmIDY1NTM1OwogIH07CiAgX0Jsb2NrVXRpbHMuZXh0cmFjdFJvdGF0aW9uID0gKHZveGVsKSA9PiB7CiAgICBjb25zdCByb3RhdGlvbiA9IHZveGVsID4+IDE2ICYgMTU7CiAgICBjb25zdCB5Um90ID0gdm94ZWwgPj4gMjAgJiAxNTsKICAgIHJldHVybiBCbG9ja1JvdGF0aW9uLmVuY29kZShyb3RhdGlvbiwgeVJvdCk7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbiA9ICh2b3hlbCwgcm90YXRpb24pID0+IHsKICAgIGNvbnN0IFtyb3QsIHlSb3RdID0gQmxvY2tSb3RhdGlvbi5kZWNvZGUocm90YXRpb24pOwogICAgY29uc3QgdmFsdWUgPSB2b3hlbCAmIFJPVEFUSU9OX01BU0sgfCAocm90ICYgMTUpIDw8IDE2OwogICAgcmV0dXJuIHZhbHVlICYgWV9ST1RBVElPTl9NQVNLIHwgKHlSb3QgJiAxNSkgPDwgMjA7CiAgfTsKICBfQmxvY2tVdGlscy5leHRyYWN0U3RhZ2UgPSAodm94ZWwpID0+IHsKICAgIHJldHVybiB2b3hlbCA+PiAyNCAmIDE1OwogIH07CiAgX0Jsb2NrVXRpbHMuaW5zZXJ0U3RhZ2UgPSAodm94ZWwsIHN0YWdlKSA9PiB7CiAgICByZXR1cm4gdm94ZWwgJiBTVEFHRV9NQVNLIHwgc3RhZ2UgPDwgMjQ7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRBbGwgPSAoaWQsIHJvdGF0aW9uLCBzdGFnZSkgPT4gewogICAgbGV0IHZhbHVlID0gMDsKICAgIHZhbHVlID0gX0Jsb2NrVXRpbHMuaW5zZXJ0SUQodmFsdWUsIGlkKTsKICAgIGlmIChyb3RhdGlvbikgdmFsdWUgPSBfQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbih2YWx1ZSwgcm90YXRpb24pOwogICAgaWYgKHN0YWdlICE9PSB2b2lkIDApIHZhbHVlID0gX0Jsb2NrVXRpbHMuaW5zZXJ0U3RhZ2UodmFsdWUsIHN0YWdlKTsKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIF9CbG9ja1V0aWxzLmdldEJsb2NrVG9yY2hMaWdodExldmVsID0gKGJsb2NrLCBjb2xvcikgPT4gewogICAgc3dpdGNoIChjb2xvcikgewogICAgICBjYXNlICJSRUQiOgogICAgICAgIHJldHVybiBibG9jay5yZWRMaWdodExldmVsOwogICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgcmV0dXJuIGJsb2NrLmdyZWVuTGlnaHRMZXZlbDsKICAgICAgY2FzZSAiQkxVRSI6CiAgICAgICAgcmV0dXJuIGJsb2NrLmJsdWVMaWdodExldmVsOwogICAgfQogICAgcmV0dXJuIDA7CiAgfTsKICBfQmxvY2tVdGlscy5ldmFsdWF0ZUJsb2NrUnVsZSA9IChydWxlLCB2b3hlbCwgZnVuY3Rpb25zKSA9PiB7CiAgICBpZiAocnVsZS50eXBlID09PSAibm9uZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAocnVsZS50eXBlID09PSAic2ltcGxlIikgewogICAgICBjb25zdCB7IG9mZnNldCwgaWQsIHJvdGF0aW9uLCBzdGFnZSB9ID0gcnVsZTsKICAgICAgY29uc3QgW3Z4LCB2eSwgdnpdID0gdm94ZWw7CiAgICAgIGNvbnN0IG94ID0gb2Zmc2V0WzBdICsgdng7CiAgICAgIGNvbnN0IG95ID0gb2Zmc2V0WzFdICsgdnk7CiAgICAgIGNvbnN0IG96ID0gb2Zmc2V0WzJdICsgdno7CiAgICAgIGlmIChpZCAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IHZveGVsSWQgPSBmdW5jdGlvbnMuZ2V0Vm94ZWxBdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxJZCAhPT0gaWQpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAocm90YXRpb24gIT09IG51bGwpIHsKICAgICAgICBjb25zdCB2b3hlbFJvdGF0aW9uID0gZnVuY3Rpb25zLmdldFZveGVsUm90YXRpb25BdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxSb3RhdGlvbi52YWx1ZSAhPT0gcm90YXRpb24udmFsdWUgfHwgdm94ZWxSb3RhdGlvbi55Um90YXRpb24gIT09IHJvdGF0aW9uLnlSb3RhdGlvbikKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoc3RhZ2UgIT09IG51bGwpIHsKICAgICAgICBjb25zdCB2b3hlbFN0YWdlID0gZnVuY3Rpb25zLmdldFZveGVsU3RhZ2VBdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxTdGFnZSAhPT0gc3RhZ2UpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChydWxlLnR5cGUgPT09ICJjb21iaW5hdGlvbiIpIHsKICAgICAgY29uc3QgeyBsb2dpYywgcnVsZXMgfSA9IHJ1bGU7CiAgICAgIHN3aXRjaCAobG9naWMpIHsKICAgICAgICBjYXNlIEJsb2NrUnVsZUxvZ2ljLkFuZDoKICAgICAgICAgIHJldHVybiBydWxlcy5ldmVyeSgKICAgICAgICAgICAgKHN1YlJ1bGUpID0+IF9CbG9ja1V0aWxzLmV2YWx1YXRlQmxvY2tSdWxlKHN1YlJ1bGUsIHZveGVsLCBmdW5jdGlvbnMpCiAgICAgICAgICApOwogICAgICAgIGNhc2UgQmxvY2tSdWxlTG9naWMuT3I6CiAgICAgICAgICByZXR1cm4gcnVsZXMuc29tZSgKICAgICAgICAgICAgKHN1YlJ1bGUpID0+IF9CbG9ja1V0aWxzLmV2YWx1YXRlQmxvY2tSdWxlKHN1YlJ1bGUsIHZveGVsLCBmdW5jdGlvbnMpCiAgICAgICAgICApOwogICAgICAgIGNhc2UgQmxvY2tSdWxlTG9naWMuTm90OgogICAgICAgICAgcmV0dXJuICFydWxlcy5zb21lKAogICAgICAgICAgICAoc3ViUnVsZSkgPT4gX0Jsb2NrVXRpbHMuZXZhbHVhdGVCbG9ja1J1bGUoc3ViUnVsZSwgdm94ZWwsIGZ1bmN0aW9ucykKICAgICAgICAgICk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgbGV0IEJsb2NrVXRpbHMgPSBfQmxvY2tVdGlsczsKICBmdW5jdGlvbiBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyh4KSB7CiAgICByZXR1cm4geCAmJiB4Ll9fZXNNb2R1bGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHgsICJkZWZhdWx0IikgPyB4WyJkZWZhdWx0Il0gOiB4OwogIH0KICB2YXIgZXBzaWxvbiA9IDFlLTY7CiAgdmFyIGNyZWF0ZV8xID0gY3JlYXRlOwogIGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgb3V0WzBdID0gMDsKICAgIG91dFsxXSA9IDA7CiAgICBvdXRbMl0gPSAwOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGNsb25lXzEgPSBjbG9uZTsKICBmdW5jdGlvbiBjbG9uZShhKSB7CiAgICB2YXIgb3V0ID0gbmV3IEZsb2F0MzJBcnJheSgzKTsKICAgIG91dFswXSA9IGFbMF07CiAgICBvdXRbMV0gPSBhWzFdOwogICAgb3V0WzJdID0gYVsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBmcm9tVmFsdWVzXzEgPSBmcm9tVmFsdWVzJDE7CiAgZnVuY3Rpb24gZnJvbVZhbHVlcyQxKHgsIHksIHopIHsKICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgb3V0WzBdID0geDsKICAgIG91dFsxXSA9IHk7CiAgICBvdXRbMl0gPSB6OwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIG5vcm1hbGl6ZV8xID0gbm9ybWFsaXplJDE7CiAgZnVuY3Rpb24gbm9ybWFsaXplJDEob3V0LCBhKSB7CiAgICB2YXIgeCA9IGFbMF0sIHkgPSBhWzFdLCB6ID0gYVsyXTsKICAgIHZhciBsZW4yID0geCAqIHggKyB5ICogeSArIHogKiB6OwogICAgaWYgKGxlbjIgPiAwKSB7CiAgICAgIGxlbjIgPSAxIC8gTWF0aC5zcXJ0KGxlbjIpOwogICAgICBvdXRbMF0gPSBhWzBdICogbGVuMjsKICAgICAgb3V0WzFdID0gYVsxXSAqIGxlbjI7CiAgICAgIG91dFsyXSA9IGFbMl0gKiBsZW4yOwogICAgfQogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGRvdF8xID0gZG90JDE7CiAgZnVuY3Rpb24gZG90JDEoYSwgYikgewogICAgcmV0dXJuIGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV0gKyBhWzJdICogYlsyXTsKICB9CiAgdmFyIGFuZ2xlXzEgPSBhbmdsZTsKICB2YXIgZnJvbVZhbHVlcyA9IGZyb21WYWx1ZXNfMTsKICB2YXIgbm9ybWFsaXplID0gbm9ybWFsaXplXzE7CiAgdmFyIGRvdCA9IGRvdF8xOwogIGZ1bmN0aW9uIGFuZ2xlKGEsIGIpIHsKICAgIHZhciB0ZW1wQSA9IGZyb21WYWx1ZXMoYVswXSwgYVsxXSwgYVsyXSk7CiAgICB2YXIgdGVtcEIgPSBmcm9tVmFsdWVzKGJbMF0sIGJbMV0sIGJbMl0pOwogICAgbm9ybWFsaXplKHRlbXBBLCB0ZW1wQSk7CiAgICBub3JtYWxpemUodGVtcEIsIHRlbXBCKTsKICAgIHZhciBjb3NpbmUgPSBkb3QodGVtcEEsIHRlbXBCKTsKICAgIGlmIChjb3NpbmUgPiAxKSB7CiAgICAgIHJldHVybiAwOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIE1hdGguYWNvcyhjb3NpbmUpOwogICAgfQogIH0KICB2YXIgY29weV8xID0gY29weTsKICBmdW5jdGlvbiBjb3B5KG91dCwgYSkgewogICAgb3V0WzBdID0gYVswXTsKICAgIG91dFsxXSA9IGFbMV07CiAgICBvdXRbMl0gPSBhWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHNldF8xID0gc2V0OwogIGZ1bmN0aW9uIHNldChvdXQsIHgsIHksIHopIHsKICAgIG91dFswXSA9IHg7CiAgICBvdXRbMV0gPSB5OwogICAgb3V0WzJdID0gejsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBlcXVhbHNfMSA9IGVxdWFsczsKICB2YXIgRVBTSUxPTiA9IGVwc2lsb247CiAgZnVuY3Rpb24gZXF1YWxzKGEsIGIpIHsKICAgIHZhciBhMCA9IGFbMF07CiAgICB2YXIgYTEgPSBhWzFdOwogICAgdmFyIGEyID0gYVsyXTsKICAgIHZhciBiMCA9IGJbMF07CiAgICB2YXIgYjEgPSBiWzFdOwogICAgdmFyIGIyID0gYlsyXTsKICAgIHJldHVybiBNYXRoLmFicyhhMCAtIGIwKSA8PSBFUFNJTE9OICogTWF0aC5tYXgoMSwgTWF0aC5hYnMoYTApLCBNYXRoLmFicyhiMCkpICYmIE1hdGguYWJzKGExIC0gYjEpIDw9IEVQU0lMT04gKiBNYXRoLm1heCgxLCBNYXRoLmFicyhhMSksIE1hdGguYWJzKGIxKSkgJiYgTWF0aC5hYnMoYTIgLSBiMikgPD0gRVBTSUxPTiAqIE1hdGgubWF4KDEsIE1hdGguYWJzKGEyKSwgTWF0aC5hYnMoYjIpKTsKICB9CiAgdmFyIGV4YWN0RXF1YWxzXzEgPSBleGFjdEVxdWFsczsKICBmdW5jdGlvbiBleGFjdEVxdWFscyhhLCBiKSB7CiAgICByZXR1cm4gYVswXSA9PT0gYlswXSAmJiBhWzFdID09PSBiWzFdICYmIGFbMl0gPT09IGJbMl07CiAgfQogIHZhciBhZGRfMSA9IGFkZDsKICBmdW5jdGlvbiBhZGQob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBhWzBdICsgYlswXTsKICAgIG91dFsxXSA9IGFbMV0gKyBiWzFdOwogICAgb3V0WzJdID0gYVsyXSArIGJbMl07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgc3VidHJhY3RfMSA9IHN1YnRyYWN0OwogIGZ1bmN0aW9uIHN1YnRyYWN0KG91dCwgYSwgYikgewogICAgb3V0WzBdID0gYVswXSAtIGJbMF07CiAgICBvdXRbMV0gPSBhWzFdIC0gYlsxXTsKICAgIG91dFsyXSA9IGFbMl0gLSBiWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHN1YiA9IHN1YnRyYWN0XzE7CiAgdmFyIG11bHRpcGx5XzEgPSBtdWx0aXBseTsKICBmdW5jdGlvbiBtdWx0aXBseShvdXQsIGEsIGIpIHsKICAgIG91dFswXSA9IGFbMF0gKiBiWzBdOwogICAgb3V0WzFdID0gYVsxXSAqIGJbMV07CiAgICBvdXRbMl0gPSBhWzJdICogYlsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBtdWwgPSBtdWx0aXBseV8xOwogIHZhciBkaXZpZGVfMSA9IGRpdmlkZTsKICBmdW5jdGlvbiBkaXZpZGUob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBhWzBdIC8gYlswXTsKICAgIG91dFsxXSA9IGFbMV0gLyBiWzFdOwogICAgb3V0WzJdID0gYVsyXSAvIGJbMl07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgZGl2ID0gZGl2aWRlXzE7CiAgdmFyIG1pbl8xID0gbWluOwogIGZ1bmN0aW9uIG1pbihvdXQsIGEsIGIpIHsKICAgIG91dFswXSA9IE1hdGgubWluKGFbMF0sIGJbMF0pOwogICAgb3V0WzFdID0gTWF0aC5taW4oYVsxXSwgYlsxXSk7CiAgICBvdXRbMl0gPSBNYXRoLm1pbihhWzJdLCBiWzJdKTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBtYXhfMSA9IG1heDsKICBmdW5jdGlvbiBtYXgob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBNYXRoLm1heChhWzBdLCBiWzBdKTsKICAgIG91dFsxXSA9IE1hdGgubWF4KGFbMV0sIGJbMV0pOwogICAgb3V0WzJdID0gTWF0aC5tYXgoYVsyXSwgYlsyXSk7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgZmxvb3JfMSA9IGZsb29yOwogIGZ1bmN0aW9uIGZsb29yKG91dCwgYSkgewogICAgb3V0WzBdID0gTWF0aC5mbG9vcihhWzBdKTsKICAgIG91dFsxXSA9IE1hdGguZmxvb3IoYVsxXSk7CiAgICBvdXRbMl0gPSBNYXRoLmZsb29yKGFbMl0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGNlaWxfMSA9IGNlaWw7CiAgZnVuY3Rpb24gY2VpbChvdXQsIGEpIHsKICAgIG91dFswXSA9IE1hdGguY2VpbChhWzBdKTsKICAgIG91dFsxXSA9IE1hdGguY2VpbChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGguY2VpbChhWzJdKTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByb3VuZF8xID0gcm91bmQ7CiAgZnVuY3Rpb24gcm91bmQob3V0LCBhKSB7CiAgICBvdXRbMF0gPSBNYXRoLnJvdW5kKGFbMF0pOwogICAgb3V0WzFdID0gTWF0aC5yb3VuZChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGgucm91bmQoYVsyXSk7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgc2NhbGVfMSA9IHNjYWxlOwogIGZ1bmN0aW9uIHNjYWxlKG91dCwgYSwgYikgewogICAgb3V0WzBdID0gYVswXSAqIGI7CiAgICBvdXRbMV0gPSBhWzFdICogYjsKICAgIG91dFsyXSA9IGFbMl0gKiBiOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHNjYWxlQW5kQWRkXzEgPSBzY2FsZUFuZEFkZDsKICBmdW5jdGlvbiBzY2FsZUFuZEFkZChvdXQsIGEsIGIsIHNjYWxlMikgewogICAgb3V0WzBdID0gYVswXSArIGJbMF0gKiBzY2FsZTI7CiAgICBvdXRbMV0gPSBhWzFdICsgYlsxXSAqIHNjYWxlMjsKICAgIG91dFsyXSA9IGFbMl0gKyBiWzJdICogc2NhbGUyOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGRpc3RhbmNlXzEgPSBkaXN0YW5jZTsKICBmdW5jdGlvbiBkaXN0YW5jZShhLCBiKSB7CiAgICB2YXIgeCA9IGJbMF0gLSBhWzBdLCB5ID0gYlsxXSAtIGFbMV0sIHogPSBiWzJdIC0gYVsyXTsKICAgIHJldHVybiBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICB9CiAgdmFyIGRpc3QgPSBkaXN0YW5jZV8xOwogIHZhciBzcXVhcmVkRGlzdGFuY2VfMSA9IHNxdWFyZWREaXN0YW5jZTsKICBmdW5jdGlvbiBzcXVhcmVkRGlzdGFuY2UoYSwgYikgewogICAgdmFyIHggPSBiWzBdIC0gYVswXSwgeSA9IGJbMV0gLSBhWzFdLCB6ID0gYlsyXSAtIGFbMl07CiAgICByZXR1cm4geCAqIHggKyB5ICogeSArIHogKiB6OwogIH0KICB2YXIgc3FyRGlzdCA9IHNxdWFyZWREaXN0YW5jZV8xOwogIHZhciBsZW5ndGhfMSA9IGxlbmd0aDsKICBmdW5jdGlvbiBsZW5ndGgoYSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl07CiAgICByZXR1cm4gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgfQogIHZhciBsZW4gPSBsZW5ndGhfMTsKICB2YXIgc3F1YXJlZExlbmd0aF8xID0gc3F1YXJlZExlbmd0aDsKICBmdW5jdGlvbiBzcXVhcmVkTGVuZ3RoKGEpIHsKICAgIHZhciB4ID0gYVswXSwgeSA9IGFbMV0sIHogPSBhWzJdOwogICAgcmV0dXJuIHggKiB4ICsgeSAqIHkgKyB6ICogejsKICB9CiAgdmFyIHNxckxlbiA9IHNxdWFyZWRMZW5ndGhfMTsKICB2YXIgbmVnYXRlXzEgPSBuZWdhdGU7CiAgZnVuY3Rpb24gbmVnYXRlKG91dCwgYSkgewogICAgb3V0WzBdID0gLWFbMF07CiAgICBvdXRbMV0gPSAtYVsxXTsKICAgIG91dFsyXSA9IC1hWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGludmVyc2VfMSA9IGludmVyc2U7CiAgZnVuY3Rpb24gaW52ZXJzZShvdXQsIGEpIHsKICAgIG91dFswXSA9IDEgLyBhWzBdOwogICAgb3V0WzFdID0gMSAvIGFbMV07CiAgICBvdXRbMl0gPSAxIC8gYVsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBjcm9zc18xID0gY3Jvc3M7CiAgZnVuY3Rpb24gY3Jvc3Mob3V0LCBhLCBiKSB7CiAgICB2YXIgYXggPSBhWzBdLCBheSA9IGFbMV0sIGF6ID0gYVsyXSwgYnggPSBiWzBdLCBieSA9IGJbMV0sIGJ6ID0gYlsyXTsKICAgIG91dFswXSA9IGF5ICogYnogLSBheiAqIGJ5OwogICAgb3V0WzFdID0gYXogKiBieCAtIGF4ICogYno7CiAgICBvdXRbMl0gPSBheCAqIGJ5IC0gYXkgKiBieDsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBsZXJwXzEgPSBsZXJwOwogIGZ1bmN0aW9uIGxlcnAob3V0LCBhLCBiLCB0KSB7CiAgICB2YXIgYXggPSBhWzBdLCBheSA9IGFbMV0sIGF6ID0gYVsyXTsKICAgIG91dFswXSA9IGF4ICsgdCAqIChiWzBdIC0gYXgpOwogICAgb3V0WzFdID0gYXkgKyB0ICogKGJbMV0gLSBheSk7CiAgICBvdXRbMl0gPSBheiArIHQgKiAoYlsyXSAtIGF6KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByYW5kb21fMSA9IHJhbmRvbTsKICBmdW5jdGlvbiByYW5kb20ob3V0LCBzY2FsZTIpIHsKICAgIHNjYWxlMiA9IHNjYWxlMiB8fCAxOwogICAgdmFyIHIgPSBNYXRoLnJhbmRvbSgpICogMiAqIE1hdGguUEk7CiAgICB2YXIgeiA9IE1hdGgucmFuZG9tKCkgKiAyIC0gMTsKICAgIHZhciB6U2NhbGUgPSBNYXRoLnNxcnQoMSAtIHogKiB6KSAqIHNjYWxlMjsKICAgIG91dFswXSA9IE1hdGguY29zKHIpICogelNjYWxlOwogICAgb3V0WzFdID0gTWF0aC5zaW4ocikgKiB6U2NhbGU7CiAgICBvdXRbMl0gPSB6ICogc2NhbGUyOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHRyYW5zZm9ybU1hdDRfMSA9IHRyYW5zZm9ybU1hdDQ7CiAgZnVuY3Rpb24gdHJhbnNmb3JtTWF0NChvdXQsIGEsIG0pIHsKICAgIHZhciB4ID0gYVswXSwgeSA9IGFbMV0sIHogPSBhWzJdLCB3ID0gbVszXSAqIHggKyBtWzddICogeSArIG1bMTFdICogeiArIG1bMTVdOwogICAgdyA9IHcgfHwgMTsKICAgIG91dFswXSA9IChtWzBdICogeCArIG1bNF0gKiB5ICsgbVs4XSAqIHogKyBtWzEyXSkgLyB3OwogICAgb3V0WzFdID0gKG1bMV0gKiB4ICsgbVs1XSAqIHkgKyBtWzldICogeiArIG1bMTNdKSAvIHc7CiAgICBvdXRbMl0gPSAobVsyXSAqIHggKyBtWzZdICogeSArIG1bMTBdICogeiArIG1bMTRdKSAvIHc7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgdHJhbnNmb3JtTWF0M18xID0gdHJhbnNmb3JtTWF0MzsKICBmdW5jdGlvbiB0cmFuc2Zvcm1NYXQzKG91dCwgYSwgbSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl07CiAgICBvdXRbMF0gPSB4ICogbVswXSArIHkgKiBtWzNdICsgeiAqIG1bNl07CiAgICBvdXRbMV0gPSB4ICogbVsxXSArIHkgKiBtWzRdICsgeiAqIG1bN107CiAgICBvdXRbMl0gPSB4ICogbVsyXSArIHkgKiBtWzVdICsgeiAqIG1bOF07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgdHJhbnNmb3JtUXVhdF8xID0gdHJhbnNmb3JtUXVhdDsKICBmdW5jdGlvbiB0cmFuc2Zvcm1RdWF0KG91dCwgYSwgcSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl0sIHF4ID0gcVswXSwgcXkgPSBxWzFdLCBxeiA9IHFbMl0sIHF3ID0gcVszXSwgaXggPSBxdyAqIHggKyBxeSAqIHogLSBxeiAqIHksIGl5ID0gcXcgKiB5ICsgcXogKiB4IC0gcXggKiB6LCBpeiA9IHF3ICogeiArIHF4ICogeSAtIHF5ICogeCwgaXcgPSAtcXggKiB4IC0gcXkgKiB5IC0gcXogKiB6OwogICAgb3V0WzBdID0gaXggKiBxdyArIGl3ICogLXF4ICsgaXkgKiAtcXogLSBpeiAqIC1xeTsKICAgIG91dFsxXSA9IGl5ICogcXcgKyBpdyAqIC1xeSArIGl6ICogLXF4IC0gaXggKiAtcXo7CiAgICBvdXRbMl0gPSBpeiAqIHF3ICsgaXcgKiAtcXogKyBpeCAqIC1xeSAtIGl5ICogLXF4OwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHJvdGF0ZVhfMSA9IHJvdGF0ZVg7CiAgZnVuY3Rpb24gcm90YXRlWChvdXQsIGEsIGIsIGMpIHsKICAgIHZhciBieSA9IGJbMV07CiAgICB2YXIgYnogPSBiWzJdOwogICAgdmFyIHB5ID0gYVsxXSAtIGJ5OwogICAgdmFyIHB6ID0gYVsyXSAtIGJ6OwogICAgdmFyIHNjID0gTWF0aC5zaW4oYyk7CiAgICB2YXIgY2MgPSBNYXRoLmNvcyhjKTsKICAgIG91dFswXSA9IGFbMF07CiAgICBvdXRbMV0gPSBieSArIHB5ICogY2MgLSBweiAqIHNjOwogICAgb3V0WzJdID0gYnogKyBweSAqIHNjICsgcHogKiBjYzsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByb3RhdGVZXzEgPSByb3RhdGVZOwogIGZ1bmN0aW9uIHJvdGF0ZVkob3V0LCBhLCBiLCBjKSB7CiAgICB2YXIgYnggPSBiWzBdOwogICAgdmFyIGJ6ID0gYlsyXTsKICAgIHZhciBweCA9IGFbMF0gLSBieDsKICAgIHZhciBweiA9IGFbMl0gLSBiejsKICAgIHZhciBzYyA9IE1hdGguc2luKGMpOwogICAgdmFyIGNjID0gTWF0aC5jb3MoYyk7CiAgICBvdXRbMF0gPSBieCArIHB6ICogc2MgKyBweCAqIGNjOwogICAgb3V0WzFdID0gYVsxXTsKICAgIG91dFsyXSA9IGJ6ICsgcHogKiBjYyAtIHB4ICogc2M7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgcm90YXRlWl8xID0gcm90YXRlWjsKICBmdW5jdGlvbiByb3RhdGVaKG91dCwgYSwgYiwgYykgewogICAgdmFyIGJ4ID0gYlswXTsKICAgIHZhciBieSA9IGJbMV07CiAgICB2YXIgcHggPSBhWzBdIC0gYng7CiAgICB2YXIgcHkgPSBhWzFdIC0gYnk7CiAgICB2YXIgc2MgPSBNYXRoLnNpbihjKTsKICAgIHZhciBjYyA9IE1hdGguY29zKGMpOwogICAgb3V0WzBdID0gYnggKyBweCAqIGNjIC0gcHkgKiBzYzsKICAgIG91dFsxXSA9IGJ5ICsgcHggKiBzYyArIHB5ICogY2M7CiAgICBvdXRbMl0gPSBhWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGZvckVhY2hfMSA9IGZvckVhY2g7CiAgdmFyIHZlYyA9IGNyZWF0ZV8xKCk7CiAgZnVuY3Rpb24gZm9yRWFjaChhLCBzdHJpZGUsIG9mZnNldCwgY291bnQsIGZuLCBhcmcpIHsKICAgIHZhciBpLCBsOwogICAgaWYgKCFzdHJpZGUpIHsKICAgICAgc3RyaWRlID0gMzsKICAgIH0KICAgIGlmICghb2Zmc2V0KSB7CiAgICAgIG9mZnNldCA9IDA7CiAgICB9CiAgICBpZiAoY291bnQpIHsKICAgICAgbCA9IE1hdGgubWluKGNvdW50ICogc3RyaWRlICsgb2Zmc2V0LCBhLmxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICBsID0gYS5sZW5ndGg7CiAgICB9CiAgICBmb3IgKGkgPSBvZmZzZXQ7IGkgPCBsOyBpICs9IHN0cmlkZSkgewogICAgICB2ZWNbMF0gPSBhW2ldOwogICAgICB2ZWNbMV0gPSBhW2kgKyAxXTsKICAgICAgdmVjWzJdID0gYVtpICsgMl07CiAgICAgIGZuKHZlYywgdmVjLCBhcmcpOwogICAgICBhW2ldID0gdmVjWzBdOwogICAgICBhW2kgKyAxXSA9IHZlY1sxXTsKICAgICAgYVtpICsgMl0gPSB2ZWNbMl07CiAgICB9CiAgICByZXR1cm4gYTsKICB9CiAgdmFyIGdsVmVjMyA9IHsKICAgIEVQU0lMT046IGVwc2lsb24sCiAgICBjcmVhdGU6IGNyZWF0ZV8xLAogICAgY2xvbmU6IGNsb25lXzEsCiAgICBhbmdsZTogYW5nbGVfMSwKICAgIGZyb21WYWx1ZXM6IGZyb21WYWx1ZXNfMSwKICAgIGNvcHk6IGNvcHlfMSwKICAgIHNldDogc2V0XzEsCiAgICBlcXVhbHM6IGVxdWFsc18xLAogICAgZXhhY3RFcXVhbHM6IGV4YWN0RXF1YWxzXzEsCiAgICBhZGQ6IGFkZF8xLAogICAgc3VidHJhY3Q6IHN1YnRyYWN0XzEsCiAgICBzdWIsCiAgICBtdWx0aXBseTogbXVsdGlwbHlfMSwKICAgIG11bCwKICAgIGRpdmlkZTogZGl2aWRlXzEsCiAgICBkaXYsCiAgICBtaW46IG1pbl8xLAogICAgbWF4OiBtYXhfMSwKICAgIGZsb29yOiBmbG9vcl8xLAogICAgY2VpbDogY2VpbF8xLAogICAgcm91bmQ6IHJvdW5kXzEsCiAgICBzY2FsZTogc2NhbGVfMSwKICAgIHNjYWxlQW5kQWRkOiBzY2FsZUFuZEFkZF8xLAogICAgZGlzdGFuY2U6IGRpc3RhbmNlXzEsCiAgICBkaXN0LAogICAgc3F1YXJlZERpc3RhbmNlOiBzcXVhcmVkRGlzdGFuY2VfMSwKICAgIHNxckRpc3QsCiAgICBsZW5ndGg6IGxlbmd0aF8xLAogICAgbGVuLAogICAgc3F1YXJlZExlbmd0aDogc3F1YXJlZExlbmd0aF8xLAogICAgc3FyTGVuLAogICAgbmVnYXRlOiBuZWdhdGVfMSwKICAgIGludmVyc2U6IGludmVyc2VfMSwKICAgIG5vcm1hbGl6ZTogbm9ybWFsaXplXzEsCiAgICBkb3Q6IGRvdF8xLAogICAgY3Jvc3M6IGNyb3NzXzEsCiAgICBsZXJwOiBsZXJwXzEsCiAgICByYW5kb206IHJhbmRvbV8xLAogICAgdHJhbnNmb3JtTWF0NDogdHJhbnNmb3JtTWF0NF8xLAogICAgdHJhbnNmb3JtTWF0MzogdHJhbnNmb3JtTWF0M18xLAogICAgdHJhbnNmb3JtUXVhdDogdHJhbnNmb3JtUXVhdF8xLAogICAgcm90YXRlWDogcm90YXRlWF8xLAogICAgcm90YXRlWTogcm90YXRlWV8xLAogICAgcm90YXRlWjogcm90YXRlWl8xLAogICAgZm9yRWFjaDogZm9yRWFjaF8xCiAgfTsKICB2YXIgdmVjMyA9IC8qIEBfX1BVUkVfXyAqLyBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyhnbFZlYzMpOwogIGNvbnN0IF9DaHVua1V0aWxzID0gY2xhc3MgX0NodW5rVXRpbHMgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgfTsKICBfQ2h1bmtVdGlscy5nZXRDaHVua05hbWUgPSAoY29vcmRzLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiBjb29yZHNbMF0gKyBjb25jYXQgKyBjb29yZHNbMV07CiAgfTsKICBfQ2h1bmtVdGlscy5nZXRWb3hlbE5hbWUgPSAoY29vcmRzLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiAoY29vcmRzWzBdIHwgMCkgKyBjb25jYXQgKyAoY29vcmRzWzFdIHwgMCkgKyBjb25jYXQgKyAoY29vcmRzWzJdIHwgMCk7CiAgfTsKICBfQ2h1bmtVdGlscy5wYXJzZUNodW5rTmFtZSA9IChuYW1lLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiBuYW1lLnNwbGl0KGNvbmNhdCkubWFwKChzKSA9PiBwYXJzZUludChzLCAxMCkpOwogIH07CiAgX0NodW5rVXRpbHMuc2NhbGVDb29yZHNGID0gKGNvb3JkcywgZmFjdG9yKSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSBbMCwgMCwgMF07CiAgICBjb25zdCBzY2FsZWQgPSB2ZWMzLnNjYWxlKHJlc3VsdCwgY29vcmRzLCBmYWN0b3IpOwogICAgcmV0dXJuIHZlYzMuZmxvb3Ioc2NhbGVkLCBzY2FsZWQpOwogIH07CiAgX0NodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rTG9jYWwgPSAodm94ZWxQb3MsIGNodW5rU2l6ZSkgPT4gewogICAgY29uc3QgW2N4LCBjel0gPSBfQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsodm94ZWxQb3MsIGNodW5rU2l6ZSk7CiAgICBjb25zdCBbdngsIHZ5LCB2el0gPSB2b3hlbFBvczsKICAgIHJldHVybiBbdnggLSBjeCAqIGNodW5rU2l6ZSwgdnksIHZ6IC0gY3ogKiBjaHVua1NpemVdOwogIH07CiAgX0NodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rID0gKHZveGVsUG9zLCBjaHVua1NpemUpID0+IHsKICAgIGNvbnN0IGNvb3JkczMgPSBfQ2h1bmtVdGlscy5zY2FsZUNvb3Jkc0Yodm94ZWxQb3MsIDEgLyBjaHVua1NpemUpOwogICAgcmV0dXJuIFtjb29yZHMzWzBdLCBjb29yZHMzWzJdXTsKICB9OwogIF9DaHVua1V0aWxzLm1hcENodW5rVG9Wb3hlbCA9IChjaHVua1BvcywgY2h1bmtTaXplKSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSBbMCwgMCwgMF07CiAgICB2ZWMzLmNvcHkocmVzdWx0LCBbY2h1bmtQb3NbMF0sIDAsIGNodW5rUG9zWzFdXSk7CiAgICB2ZWMzLnNjYWxlKHJlc3VsdCwgcmVzdWx0LCBjaHVua1NpemUpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIF9DaHVua1V0aWxzLm1hcFdvcmxkVG9Wb3hlbCA9ICh3b3JsZFBvcykgPT4gewogICAgcmV0dXJuIF9DaHVua1V0aWxzLnNjYWxlQ29vcmRzRih3b3JsZFBvcywgMSk7CiAgfTsKICBsZXQgQ2h1bmtVdGlscyA9IF9DaHVua1V0aWxzOwogIGNvbnN0IF9MaWdodFV0aWxzID0gY2xhc3MgX0xpZ2h0VXRpbHMgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgfTsKICBfTGlnaHRVdGlscy5leHRyYWN0U3VubGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCA+PiAxMiAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0U3VubGlnaHQgPSAobGlnaHQsIGxldmVsKSA9PiB7CiAgICByZXR1cm4gbGlnaHQgJiA0MDk1IHwgbGV2ZWwgPDwgMTI7CiAgfTsKICBfTGlnaHRVdGlscy5leHRyYWN0UmVkTGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCA+PiA4ICYgMTU7CiAgfTsKICBfTGlnaHRVdGlscy5pbnNlcnRSZWRMaWdodCA9IChsaWdodCwgbGV2ZWwpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDYxNjk1IHwgbGV2ZWwgPDwgODsKICB9OwogIF9MaWdodFV0aWxzLmV4dHJhY3RHcmVlbkxpZ2h0ID0gKGxpZ2h0KSA9PiB7CiAgICByZXR1cm4gbGlnaHQgPj4gNCAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0R3JlZW5MaWdodCA9IChsaWdodCwgbGV2ZWwpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDY1Mjk1IHwgbGV2ZWwgPDwgNDsKICB9OwogIF9MaWdodFV0aWxzLmV4dHJhY3RCbHVlTGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0Qmx1ZUxpZ2h0ID0gKGxpZ2h0LCBsZXZlbCkgPT4gewogICAgcmV0dXJuIGxpZ2h0ICYgNjU1MjAgfCBsZXZlbDsKICB9OwogIF9MaWdodFV0aWxzLmNhbkVudGVySW50byA9ICh0YXJnZXQsIGR4LCBkeSwgZHopID0+IHsKICAgIGlmIChNYXRoLmFicyhkeCArIGR5ICsgZHopICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAiVGhpcyBpc24ndCBzdXBwb3NlZCB0byBoYXBwZW4uIExpZ2h0IG5laWdoYm9yaW5nIGRpcmVjdGlvbiBzaG91bGQgYmUgb24gMSBheGlzIG9ubHkuIgogICAgICApOwogICAgfQogICAgY29uc3QgW3B4LCBweSwgcHosIG54LCBueSwgbnpdID0gdGFyZ2V0OwogICAgaWYgKGR4ID09PSAxKSB7CiAgICAgIHJldHVybiBueDsKICAgIH0KICAgIGlmIChkeCA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHB4OwogICAgfQogICAgaWYgKGR5ID09PSAxKSB7CiAgICAgIHJldHVybiBueTsKICAgIH0KICAgIGlmIChkeSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHB5OwogICAgfQogICAgaWYgKGR6ID09PSAxKSB7CiAgICAgIHJldHVybiBuejsKICAgIH0KICAgIHJldHVybiBwejsKICB9OwogIF9MaWdodFV0aWxzLmNhbkVudGVyID0gKHNvdXJjZSwgdGFyZ2V0LCBkeCwgZHksIGR6KSA9PiB7CiAgICBpZiAoTWF0aC5hYnMoZHggKyBkeSArIGR6KSAhPT0gMSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgIlRoaXMgaXNuJ3Qgc3VwcG9zZWQgdG8gaGFwcGVuLiBMaWdodCBuZWlnaGJvcmluZyBkaXJlY3Rpb24gc2hvdWxkIGJlIG9uIDEgYXhpcyBvbmx5LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IFtzcHgsIHNweSwgc3B6LCBzbngsIHNueSwgc256XSA9IHNvdXJjZTsKICAgIGNvbnN0IFt0cHgsIHRweSwgdHB6LCB0bngsIHRueSwgdG56XSA9IHRhcmdldDsKICAgIGlmIChkeCA9PT0gMSkgewogICAgICByZXR1cm4gc3B4ICYmIHRueDsKICAgIH0KICAgIGlmIChkeCA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHNueCAmJiB0cHg7CiAgICB9CiAgICBpZiAoZHkgPT09IDEpIHsKICAgICAgcmV0dXJuIHNweSAmJiB0bnk7CiAgICB9CiAgICBpZiAoZHkgPT09IC0xKSB7CiAgICAgIHJldHVybiBzbnkgJiYgdHB5OwogICAgfQogICAgaWYgKGR6ID09PSAxKSB7CiAgICAgIHJldHVybiBzcHogJiYgdG56OwogICAgfQogICAgcmV0dXJuIHNueiAmJiB0cHo7CiAgfTsKICBsZXQgTGlnaHRVdGlscyA9IF9MaWdodFV0aWxzOwogIGZ1bmN0aW9uIGlvdGEkMShuKSB7CiAgICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KG4pOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gaTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBpb3RhXzEgPSBpb3RhJDE7CiAgLyohCiAgICogRGV0ZXJtaW5lIGlmIGFuIG9iamVjdCBpcyBhIEJ1ZmZlcgogICAqCiAgICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGh0dHBzOi8vZmVyb3NzLm9yZz4KICAgKiBAbGljZW5zZSAgTUlUCiAgICovCiAgdmFyIGlzQnVmZmVyXzEgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiAoaXNCdWZmZXIkMShvYmopIHx8IGlzU2xvd0J1ZmZlcihvYmopIHx8ICEhb2JqLl9pc0J1ZmZlcik7CiAgfTsKICBmdW5jdGlvbiBpc0J1ZmZlciQxKG9iaikgewogICAgcmV0dXJuICEhb2JqLmNvbnN0cnVjdG9yICYmIHR5cGVvZiBvYmouY29uc3RydWN0b3IuaXNCdWZmZXIgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yLmlzQnVmZmVyKG9iaik7CiAgfQogIGZ1bmN0aW9uIGlzU2xvd0J1ZmZlcihvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqLnJlYWRGbG9hdExFID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBvYmouc2xpY2UgPT09ICJmdW5jdGlvbiIgJiYgaXNCdWZmZXIkMShvYmouc2xpY2UoMCwgMCkpOwogIH0KICB2YXIgaW90YSA9IGlvdGFfMTsKICB2YXIgaXNCdWZmZXIgPSBpc0J1ZmZlcl8xOwogIHZhciBoYXNUeXBlZEFycmF5cyA9IHR5cGVvZiBGbG9hdDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiOwogIGZ1bmN0aW9uIGNvbXBhcmUxc3QoYSwgYikgewogICAgcmV0dXJuIGFbMF0gLSBiWzBdOwogIH0KICBmdW5jdGlvbiBvcmRlcigpIHsKICAgIHZhciBzdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgIHZhciB0ZXJtcyA9IG5ldyBBcnJheShzdHJpZGUubGVuZ3RoKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IHRlcm1zLmxlbmd0aDsgKytpKSB7CiAgICAgIHRlcm1zW2ldID0gW01hdGguYWJzKHN0cmlkZVtpXSksIGldOwogICAgfQogICAgdGVybXMuc29ydChjb21wYXJlMXN0KTsKICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkodGVybXMubGVuZ3RoKTsKICAgIGZvciAoaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gdGVybXNbaV1bMV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjb21waWxlQ29uc3RydWN0b3IoZHR5cGUsIGRpbWVuc2lvbikgewogICAgdmFyIGNsYXNzTmFtZSA9IFsiVmlldyIsIGRpbWVuc2lvbiwgImQiLCBkdHlwZV0uam9pbigiIik7CiAgICBpZiAoZGltZW5zaW9uIDwgMCkgewogICAgICBjbGFzc05hbWUgPSAiVmlld19OaWwiICsgZHR5cGU7CiAgICB9CiAgICB2YXIgdXNlR2V0dGVycyA9IGR0eXBlID09PSAiZ2VuZXJpYyI7CiAgICBpZiAoZGltZW5zaW9uID09PSAtMSkgewogICAgICB2YXIgY29kZSA9ICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhKXt0aGlzLmRhdGE9YTt9O3ZhciBwcm90bz0iICsgY2xhc3NOYW1lICsgIi5wcm90b3R5cGU7cHJvdG8uZHR5cGU9JyIgKyBkdHlwZSArICInO3Byb3RvLmluZGV4PWZ1bmN0aW9uKCl7cmV0dXJuIC0xfTtwcm90by5zaXplPTA7cHJvdG8uZGltZW5zaW9uPS0xO3Byb3RvLnNoYXBlPXByb3RvLnN0cmlkZT1wcm90by5vcmRlcj1bXTtwcm90by5sbz1wcm90by5oaT1wcm90by50cmFuc3Bvc2U9cHJvdG8uc3RlcD1mdW5jdGlvbigpe3JldHVybiBuZXcgIiArIGNsYXNzTmFtZSArICIodGhpcy5kYXRhKTt9O3Byb3RvLmdldD1wcm90by5zZXQ9ZnVuY3Rpb24oKXt9O3Byb3RvLnBpY2s9ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbH07cmV0dXJuIGZ1bmN0aW9uIGNvbnN0cnVjdF8iICsgY2xhc3NOYW1lICsgIihhKXtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKGEpO30iOwogICAgICB2YXIgcHJvY2VkdXJlID0gbmV3IEZ1bmN0aW9uKGNvZGUpOwogICAgICByZXR1cm4gcHJvY2VkdXJlKCk7CiAgICB9IGVsc2UgaWYgKGRpbWVuc2lvbiA9PT0gMCkgewogICAgICB2YXIgY29kZSA9ICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhLGQpIHt0aGlzLmRhdGEgPSBhO3RoaXMub2Zmc2V0ID0gZH07dmFyIHByb3RvPSIgKyBjbGFzc05hbWUgKyAiLnByb3RvdHlwZTtwcm90by5kdHlwZT0nIiArIGR0eXBlICsgIic7cHJvdG8uaW5kZXg9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5vZmZzZXR9O3Byb3RvLmRpbWVuc2lvbj0wO3Byb3RvLnNpemU9MTtwcm90by5zaGFwZT1wcm90by5zdHJpZGU9cHJvdG8ub3JkZXI9W107cHJvdG8ubG89cHJvdG8uaGk9cHJvdG8udHJhbnNwb3NlPXByb3RvLnN0ZXA9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfY29weSgpIHtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSx0aGlzLm9mZnNldCl9O3Byb3RvLnBpY2s9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfcGljaygpe3JldHVybiBUcml2aWFsQXJyYXkodGhpcy5kYXRhKTt9O3Byb3RvLnZhbHVlT2Y9cHJvdG8uZ2V0PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2dldCgpe3JldHVybiAiICsgKHVzZUdldHRlcnMgPyAidGhpcy5kYXRhLmdldCh0aGlzLm9mZnNldCkiIDogInRoaXMuZGF0YVt0aGlzLm9mZnNldF0iKSArICJ9O3Byb3RvLnNldD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zZXQodil7cmV0dXJuICIgKyAodXNlR2V0dGVycyA/ICJ0aGlzLmRhdGEuc2V0KHRoaXMub2Zmc2V0LHYpIiA6ICJ0aGlzLmRhdGFbdGhpcy5vZmZzZXRdPXYiKSArICJ9O3JldHVybiBmdW5jdGlvbiBjb25zdHJ1Y3RfIiArIGNsYXNzTmFtZSArICIoYSxiLGMsZCl7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIihhLGQpfSI7CiAgICAgIHZhciBwcm9jZWR1cmUgPSBuZXcgRnVuY3Rpb24oIlRyaXZpYWxBcnJheSIsIGNvZGUpOwogICAgICByZXR1cm4gcHJvY2VkdXJlKENBQ0hFRF9DT05TVFJVQ1RPUlNbZHR5cGVdWzBdKTsKICAgIH0KICAgIHZhciBjb2RlID0gWyIndXNlIHN0cmljdCciXTsKICAgIHZhciBpbmRpY2VzID0gaW90YShkaW1lbnNpb24pOwogICAgdmFyIGFyZ3MgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImkiICsgaTI7CiAgICB9KTsKICAgIHZhciBpbmRleF9zdHIgPSAidGhpcy5vZmZzZXQrIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAidGhpcy5zdHJpZGVbIiArIGkyICsgIl0qaSIgKyBpMjsKICAgIH0pLmpvaW4oIisiKTsKICAgIHZhciBzaGFwZUFyZyA9IGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKTsKICAgIHZhciBzdHJpZGVBcmcgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImMiICsgaTI7CiAgICB9KS5qb2luKCIsIik7CiAgICBjb2RlLnB1c2goCiAgICAgICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhLCIgKyBzaGFwZUFyZyArICIsIiArIHN0cmlkZUFyZyArICIsZCl7dGhpcy5kYXRhPWEiLAogICAgICAidGhpcy5zaGFwZT1bIiArIHNoYXBlQXJnICsgIl0iLAogICAgICAidGhpcy5zdHJpZGU9WyIgKyBzdHJpZGVBcmcgKyAiXSIsCiAgICAgICJ0aGlzLm9mZnNldD1kfDB9IiwKICAgICAgInZhciBwcm90bz0iICsgY2xhc3NOYW1lICsgIi5wcm90b3R5cGUiLAogICAgICAicHJvdG8uZHR5cGU9JyIgKyBkdHlwZSArICInIiwKICAgICAgInByb3RvLmRpbWVuc2lvbj0iICsgZGltZW5zaW9uCiAgICApOwogICAgY29kZS5wdXNoKAogICAgICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCdzaXplJyx7Z2V0OmZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX3NpemUoKXtyZXR1cm4gIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgICAgcmV0dXJuICJ0aGlzLnNoYXBlWyIgKyBpMiArICJdIjsKICAgICAgfSkuam9pbigiKiIpLAogICAgICAifX0pIgogICAgKTsKICAgIGlmIChkaW1lbnNpb24gPT09IDEpIHsKICAgICAgY29kZS5wdXNoKCJwcm90by5vcmRlcj1bMF0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgiT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCdvcmRlcicse2dldDoiKTsKICAgICAgaWYgKGRpbWVuc2lvbiA8IDQpIHsKICAgICAgICBjb2RlLnB1c2goImZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX29yZGVyKCl7Iik7CiAgICAgICAgaWYgKGRpbWVuc2lvbiA9PT0gMikgewogICAgICAgICAgY29kZS5wdXNoKCJyZXR1cm4gKE1hdGguYWJzKHRoaXMuc3RyaWRlWzBdKT5NYXRoLmFicyh0aGlzLnN0cmlkZVsxXSkpP1sxLDBdOlswLDFdfX0pIik7CiAgICAgICAgfSBlbHNlIGlmIChkaW1lbnNpb24gPT09IDMpIHsKICAgICAgICAgIGNvZGUucHVzaCgKICAgICAgICAgICAgInZhciBzMD1NYXRoLmFicyh0aGlzLnN0cmlkZVswXSksczE9TWF0aC5hYnModGhpcy5zdHJpZGVbMV0pLHMyPU1hdGguYWJzKHRoaXMuc3RyaWRlWzJdKTtpZihzMD5zMSl7aWYoczE+czIpe3JldHVybiBbMiwxLDBdO31lbHNlIGlmKHMwPnMyKXtyZXR1cm4gWzEsMiwwXTt9ZWxzZXtyZXR1cm4gWzEsMCwyXTt9fWVsc2UgaWYoczA+czIpe3JldHVybiBbMiwwLDFdO31lbHNlIGlmKHMyPnMxKXtyZXR1cm4gWzAsMSwyXTt9ZWxzZXtyZXR1cm4gWzAsMiwxXTt9fX0pIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29kZS5wdXNoKCJPUkRFUn0pIik7CiAgICAgIH0KICAgIH0KICAgIGNvZGUucHVzaCgKICAgICAgInByb3RvLnNldD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zZXQoIiArIGFyZ3Muam9pbigiLCIpICsgIix2KXsiCiAgICApOwogICAgaWYgKHVzZUdldHRlcnMpIHsKICAgICAgY29kZS5wdXNoKCJyZXR1cm4gdGhpcy5kYXRhLnNldCgiICsgaW5kZXhfc3RyICsgIix2KX0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YVsiICsgaW5kZXhfc3RyICsgIl09dn0iKTsKICAgIH0KICAgIGNvZGUucHVzaCgicHJvdG8uZ2V0PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2dldCgiICsgYXJncy5qb2luKCIsIikgKyAiKXsiKTsKICAgIGlmICh1c2VHZXR0ZXJzKSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YS5nZXQoIiArIGluZGV4X3N0ciArICIpfSIpOwogICAgfSBlbHNlIHsKICAgICAgY29kZS5wdXNoKCJyZXR1cm4gdGhpcy5kYXRhWyIgKyBpbmRleF9zdHIgKyAiXX0iKTsKICAgIH0KICAgIGNvZGUucHVzaCgKICAgICAgInByb3RvLmluZGV4PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2luZGV4KCIsCiAgICAgIGFyZ3Muam9pbigpLAogICAgICAiKXtyZXR1cm4gIiArIGluZGV4X3N0ciArICJ9IgogICAgKTsKICAgIGNvZGUucHVzaCgicHJvdG8uaGk9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfaGkoIiArIGFyZ3Muam9pbigiLCIpICsgIil7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIih0aGlzLmRhdGEsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiBbIih0eXBlb2YgaSIsIGkyLCAiIT09J251bWJlcid8fGkiLCBpMiwgIjwwKT90aGlzLnNoYXBlWyIsIGkyLCAiXTppIiwgaTIsICJ8MCJdLmpvaW4oIiIpOwogICAgfSkuam9pbigiLCIpICsgIiwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJ0aGlzLnN0cmlkZVsiICsgaTIgKyAiXSI7CiAgICB9KS5qb2luKCIsIikgKyAiLHRoaXMub2Zmc2V0KX0iKTsKICAgIHZhciBhX3ZhcnMgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImEiICsgaTIgKyAiPXRoaXMuc2hhcGVbIiArIGkyICsgIl0iOwogICAgfSk7CiAgICB2YXIgY192YXJzID0gaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJjIiArIGkyICsgIj10aGlzLnN0cmlkZVsiICsgaTIgKyAiXSI7CiAgICB9KTsKICAgIGNvZGUucHVzaCgicHJvdG8ubG89ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfbG8oIiArIGFyZ3Muam9pbigiLCIpICsgIil7dmFyIGI9dGhpcy5vZmZzZXQsZD0wLCIgKyBhX3ZhcnMuam9pbigiLCIpICsgIiwiICsgY192YXJzLmpvaW4oIiwiKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIGNvZGUucHVzaCgKICAgICAgICAiaWYodHlwZW9mIGkiICsgaSArICI9PT0nbnVtYmVyJyYmaSIgKyBpICsgIj49MCl7ZD1pIiArIGkgKyAifDA7Yis9YyIgKyBpICsgIipkO2EiICsgaSArICItPWR9IgogICAgICApOwogICAgfQogICAgY29kZS5wdXNoKCJyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJhIiArIGkyOwogICAgfSkuam9pbigiLCIpICsgIiwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJjIiArIGkyOwogICAgfSkuam9pbigiLCIpICsgIixiKX0iKTsKICAgIGNvZGUucHVzaCgicHJvdG8uc3RlcD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zdGVwKCIgKyBhcmdzLmpvaW4oIiwiKSArICIpe3ZhciAiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJhIiArIGkyICsgIj10aGlzLnNoYXBlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMiArICI9dGhpcy5zdHJpZGVbIiArIGkyICsgIl0iOwogICAgfSkuam9pbigiLCIpICsgIixjPXRoaXMub2Zmc2V0LGQ9MCxjZWlsPU1hdGguY2VpbCIpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaW1lbnNpb247ICsraSkgewogICAgICBjb2RlLnB1c2goCiAgICAgICAgImlmKHR5cGVvZiBpIiArIGkgKyAiPT09J251bWJlcicpe2Q9aSIgKyBpICsgInwwO2lmKGQ8MCl7Yys9YiIgKyBpICsgIiooYSIgKyBpICsgIi0xKTthIiArIGkgKyAiPWNlaWwoLWEiICsgaSArICIvZCl9ZWxzZXthIiArIGkgKyAiPWNlaWwoYSIgKyBpICsgIi9kKX1iIiArIGkgKyAiKj1kfSIKICAgICAgKTsKICAgIH0KICAgIGNvZGUucHVzaCgicmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIih0aGlzLmRhdGEsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYSIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKSArICIsYyl9Iik7CiAgICB2YXIgdFNoYXBlID0gbmV3IEFycmF5KGRpbWVuc2lvbik7CiAgICB2YXIgdFN0cmlkZSA9IG5ldyBBcnJheShkaW1lbnNpb24pOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaW1lbnNpb247ICsraSkgewogICAgICB0U2hhcGVbaV0gPSAiYVtpIiArIGkgKyAiXSI7CiAgICAgIHRTdHJpZGVbaV0gPSAiYltpIiArIGkgKyAiXSI7CiAgICB9CiAgICBjb2RlLnB1c2goCiAgICAgICJwcm90by50cmFuc3Bvc2U9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfdHJhbnNwb3NlKCIgKyBhcmdzICsgIil7IiArIGFyZ3MubWFwKGZ1bmN0aW9uKG4sIGlkeCkgewogICAgICAgIHJldHVybiBuICsgIj0oIiArIG4gKyAiPT09dW5kZWZpbmVkPyIgKyBpZHggKyAiOiIgKyBuICsgInwwKSI7CiAgICAgIH0pLmpvaW4oIjsiKSwKICAgICAgInZhciBhPXRoaXMuc2hhcGUsYj10aGlzLnN0cmlkZTtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSwiICsgdFNoYXBlLmpvaW4oIiwiKSArICIsIiArIHRTdHJpZGUuam9pbigiLCIpICsgIix0aGlzLm9mZnNldCl9IgogICAgKTsKICAgIGNvZGUucHVzaCgicHJvdG8ucGljaz1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9waWNrKCIgKyBhcmdzICsgIil7dmFyIGE9W10sYj1bXSxjPXRoaXMub2Zmc2V0Iik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIGNvZGUucHVzaCgiaWYodHlwZW9mIGkiICsgaSArICI9PT0nbnVtYmVyJyYmaSIgKyBpICsgIj49MCl7Yz0oYyt0aGlzLnN0cmlkZVsiICsgaSArICJdKmkiICsgaSArICIpfDB9ZWxzZXthLnB1c2godGhpcy5zaGFwZVsiICsgaSArICJdKTtiLnB1c2godGhpcy5zdHJpZGVbIiArIGkgKyAiXSl9Iik7CiAgICB9CiAgICBjb2RlLnB1c2goInZhciBjdG9yPUNUT1JfTElTVFthLmxlbmd0aCsxXTtyZXR1cm4gY3Rvcih0aGlzLmRhdGEsYSxiLGMpfSIpOwogICAgY29kZS5wdXNoKCJyZXR1cm4gZnVuY3Rpb24gY29uc3RydWN0XyIgKyBjbGFzc05hbWUgKyAiKGRhdGEsc2hhcGUsc3RyaWRlLG9mZnNldCl7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIihkYXRhLCIgKyBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gInNoYXBlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAic3RyaWRlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsb2Zmc2V0KX0iKTsKICAgIHZhciBwcm9jZWR1cmUgPSBuZXcgRnVuY3Rpb24oIkNUT1JfTElTVCIsICJPUkRFUiIsIGNvZGUuam9pbigiXG4iKSk7CiAgICByZXR1cm4gcHJvY2VkdXJlKENBQ0hFRF9DT05TVFJVQ1RPUlNbZHR5cGVdLCBvcmRlcik7CiAgfQogIGZ1bmN0aW9uIGFycmF5RFR5cGUoZGF0YSkgewogICAgaWYgKGlzQnVmZmVyKGRhdGEpKSB7CiAgICAgIHJldHVybiAiYnVmZmVyIjsKICAgIH0KICAgIGlmIChoYXNUeXBlZEFycmF5cykgewogICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChkYXRhKSkgewogICAgICAgIGNhc2UgIltvYmplY3QgRmxvYXQ2NEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImZsb2F0NjQiOwogICAgICAgIGNhc2UgIltvYmplY3QgRmxvYXQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImZsb2F0MzIiOwogICAgICAgIGNhc2UgIltvYmplY3QgSW50OEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImludDgiOwogICAgICAgIGNhc2UgIltvYmplY3QgSW50MTZBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJpbnQxNiI7CiAgICAgICAgY2FzZSAiW29iamVjdCBJbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImludDMyIjsKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQ4QXJyYXldIjoKICAgICAgICAgIHJldHVybiAidWludDgiOwogICAgICAgIGNhc2UgIltvYmplY3QgVWludDE2QXJyYXldIjoKICAgICAgICAgIHJldHVybiAidWludDE2IjsKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gInVpbnQzMiI7CiAgICAgICAgY2FzZSAiW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJ1aW50OF9jbGFtcGVkIjsKICAgICAgICBjYXNlICJbb2JqZWN0IEJpZ0ludDY0QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiYmlnaW50NjQiOwogICAgICAgIGNhc2UgIltvYmplY3QgQmlnVWludDY0QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiYmlndWludDY0IjsKICAgICAgfQogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgcmV0dXJuICJhcnJheSI7CiAgICB9CiAgICByZXR1cm4gImdlbmVyaWMiOwogIH0KICB2YXIgQ0FDSEVEX0NPTlNUUlVDVE9SUyA9IHsKICAgICJmbG9hdDMyIjogW10sCiAgICAiZmxvYXQ2NCI6IFtdLAogICAgImludDgiOiBbXSwKICAgICJpbnQxNiI6IFtdLAogICAgImludDMyIjogW10sCiAgICAidWludDgiOiBbXSwKICAgICJ1aW50MTYiOiBbXSwKICAgICJ1aW50MzIiOiBbXSwKICAgICJhcnJheSI6IFtdLAogICAgInVpbnQ4X2NsYW1wZWQiOiBbXSwKICAgICJiaWdpbnQ2NCI6IFtdLAogICAgImJpZ3VpbnQ2NCI6IFtdLAogICAgImJ1ZmZlciI6IFtdLAogICAgImdlbmVyaWMiOiBbXQogIH07CiAgZnVuY3Rpb24gd3JhcHBlZE5EQXJyYXlDdG9yKGRhdGEsIHNoYXBlLCBzdHJpZGUsIG9mZnNldCkgewogICAgaWYgKGRhdGEgPT09IHZvaWQgMCkgewogICAgICB2YXIgY3RvciA9IENBQ0hFRF9DT05TVFJVQ1RPUlMuYXJyYXlbMF07CiAgICAgIHJldHVybiBjdG9yKFtdKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICJudW1iZXIiKSB7CiAgICAgIGRhdGEgPSBbZGF0YV07CiAgICB9CiAgICBpZiAoc2hhcGUgPT09IHZvaWQgMCkgewogICAgICBzaGFwZSA9IFtkYXRhLmxlbmd0aF07CiAgICB9CiAgICB2YXIgZCA9IHNoYXBlLmxlbmd0aDsKICAgIGlmIChzdHJpZGUgPT09IHZvaWQgMCkgewogICAgICBzdHJpZGUgPSBuZXcgQXJyYXkoZCk7CiAgICAgIGZvciAodmFyIGkgPSBkIC0gMSwgc3ogPSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHN0cmlkZVtpXSA9IHN6OwogICAgICAgIHN6ICo9IHNoYXBlW2ldOwogICAgICB9CiAgICB9CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgb2Zmc2V0ID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkOyArK2kpIHsKICAgICAgICBpZiAoc3RyaWRlW2ldIDwgMCkgewogICAgICAgICAgb2Zmc2V0IC09IChzaGFwZVtpXSAtIDEpICogc3RyaWRlW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdmFyIGR0eXBlID0gYXJyYXlEVHlwZShkYXRhKTsKICAgIHZhciBjdG9yX2xpc3QgPSBDQUNIRURfQ09OU1RSVUNUT1JTW2R0eXBlXTsKICAgIHdoaWxlIChjdG9yX2xpc3QubGVuZ3RoIDw9IGQgKyAxKSB7CiAgICAgIGN0b3JfbGlzdC5wdXNoKGNvbXBpbGVDb25zdHJ1Y3RvcihkdHlwZSwgY3Rvcl9saXN0Lmxlbmd0aCAtIDEpKTsKICAgIH0KICAgIHZhciBjdG9yID0gY3Rvcl9saXN0W2QgKyAxXTsKICAgIHJldHVybiBjdG9yKGRhdGEsIHNoYXBlLCBzdHJpZGUsIG9mZnNldCk7CiAgfQogIHZhciBuZGFycmF5ID0gd3JhcHBlZE5EQXJyYXlDdG9yOwogIHZhciBuZGFycmF5JDEgPSAvKiBAX19QVVJFX18gKi8gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMobmRhcnJheSk7CiAgY2xhc3MgUmF3Q2h1bmsgewogICAgY29uc3RydWN0b3IoaWQsIGNvb3Jkcywgb3B0aW9ucykgewogICAgICB0aGlzLmlkID0gaWQ7CiAgICAgIHRoaXMubmFtZSA9IENodW5rVXRpbHMuZ2V0Q2h1bmtOYW1lKGNvb3Jkcyk7CiAgICAgIHRoaXMuY29vcmRzID0gY29vcmRzOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICBjb25zdCB7IHNpemUsIG1heEhlaWdodCB9ID0gb3B0aW9uczsKICAgICAgdGhpcy52b3hlbHMgPSBuZGFycmF5JDEoW10sIFtzaXplLCBtYXhIZWlnaHQsIHNpemVdKTsKICAgICAgdGhpcy5saWdodHMgPSBuZGFycmF5JDEoW10sIFtzaXplLCBtYXhIZWlnaHQsIHNpemVdKTsKICAgICAgY29uc3QgW3gsIHpdID0gY29vcmRzOwogICAgICB0aGlzLm1pbiA9IFt4ICogc2l6ZSwgMCwgeiAqIHNpemVdOwogICAgICB0aGlzLm1heCA9IFsoeCArIDEpICogc2l6ZSwgbWF4SGVpZ2h0LCAoeiArIDEpICogc2l6ZV07CiAgICB9CiAgICBzZXJpYWxpemUoKSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgewogICAgICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgICAgICB4OiB0aGlzLmNvb3Jkc1swXSwKICAgICAgICAgIHo6IHRoaXMuY29vcmRzWzFdLAogICAgICAgICAgdm94ZWxzOiB0aGlzLnZveGVscy5kYXRhLmJ1ZmZlciwKICAgICAgICAgIGxpZ2h0czogdGhpcy5saWdodHMuZGF0YS5idWZmZXIsCiAgICAgICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMKICAgICAgICB9LAogICAgICAgIFsKICAgICAgICAgIHRoaXMudm94ZWxzLmRhdGEuYnVmZmVyLnNsaWNlKDApLAogICAgICAgICAgdGhpcy5saWdodHMuZGF0YS5idWZmZXIuc2xpY2UoMCkKICAgICAgICBdCiAgICAgIF07CiAgICB9CiAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICBjb25zdCB7IGlkLCB4LCB6LCB2b3hlbHMsIGxpZ2h0cywgb3B0aW9ucyB9ID0gZGF0YTsKICAgICAgY29uc3QgY2h1bmsgPSBuZXcgUmF3Q2h1bmsoaWQsIFt4LCB6XSwgb3B0aW9ucyk7CiAgICAgIGlmIChsaWdodHMgJiYgbGlnaHRzLmJ5dGVMZW5ndGgpCiAgICAgICAgY2h1bmsubGlnaHRzLmRhdGEgPSBuZXcgVWludDMyQXJyYXkobGlnaHRzKTsKICAgICAgaWYgKHZveGVscyAmJiB2b3hlbHMuYnl0ZUxlbmd0aCkKICAgICAgICBjaHVuay52b3hlbHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheSh2b3hlbHMpOwogICAgICByZXR1cm4gY2h1bms7CiAgICB9CiAgICBzZXREYXRhKGRhdGEpIHsKICAgICAgY29uc3QgeyBpZCwgeCwgeiB9ID0gZGF0YTsKICAgICAgaWYgKHRoaXMuaWQgIT09IGlkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaHVuayBpZCBtaXNtYXRjaCIpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNvb3Jkc1swXSAhPT0geCB8fCB0aGlzLmNvb3Jkc1sxXSAhPT0geikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2h1bmsgY29vcmRzIG1pc21hdGNoIik7CiAgICAgIH0KICAgICAgY29uc3QgeyB2b3hlbHMsIGxpZ2h0cyB9ID0gZGF0YTsKICAgICAgaWYgKGxpZ2h0cyAmJiBsaWdodHMuYnl0ZUxlbmd0aCkgdGhpcy5saWdodHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheShsaWdodHMpOwogICAgICBpZiAodm94ZWxzICYmIHZveGVscy5ieXRlTGVuZ3RoKSB0aGlzLnZveGVscy5kYXRhID0gbmV3IFVpbnQzMkFycmF5KHZveGVscyk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgcmF3IHZveGVsIHZhbHVlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmF3IHZveGVsIHZhbHVlIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgaXMgbm90IHdpdGhpbgogICAgICogdGhlIGNodW5rLCB0aGlzIG1ldGhvZCByZXR1cm5zIGAwYC4KICAgICAqLwogICAgZ2V0UmF3VmFsdWUodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnZveGVscy5nZXQobHgsIGx5LCBseik7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcmF3IHZveGVsIHZhbHVlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgcmF3IHZveGVsIHZhbHVlIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgdm94ZWwgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIHNldFJhd1ZhbHVlKHZ4LCB2eSwgdnosIHZhbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnZveGVscy5zZXQobHgsIGx5LCBseiwgdmFsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSByYXcgbGlnaHQgdmFsdWUgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgbGlnaHQgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIGdldFJhd0xpZ2h0KHZ4LCB2eSwgdnopIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSByZXR1cm4gMDsKICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHJhdyBsaWdodCB2YWx1ZSBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIHJhdyBsaWdodCBsZXZlbCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmF3IGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBzZXRSYXdMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmxpZ2h0cy5zZXQobHgsIGx5LCBseiwgbGV2ZWwpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZveGVsIHR5cGUgSUQgYXQgYSBnaXZlbiB2b3hlbCBvciB3b3JsZCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSB2b3hlbCB0eXBlIElEIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBnZXRWb3hlbCh2eCwgdnksIHZ6KSB7CiAgICAgIHJldHVybiBCbG9ja1V0aWxzLmV4dHJhY3RJRCh0aGlzLmdldFJhd1ZhbHVlKHZ4IHwgMCwgdnkgfCAwLCB2eiB8IDApKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSB2b3hlbCB0eXBlIElEIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBpZCBUaGUgdm94ZWwgdHlwZSBJRCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgdHlwZSBJRCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqLwogICAgc2V0Vm94ZWwodngsIHZ5LCB2eiwgaWQpIHsKICAgICAgY29uc3QgdmFsdWUgPSBCbG9ja1V0aWxzLmluc2VydElEKDAsIGlkKTsKICAgICAgdGhpcy5zZXRSYXdWYWx1ZSh2eCwgdnksIHZ6LCB2YWx1ZSk7CiAgICAgIHJldHVybiBpZDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB2b3hlbCByb3RhdGlvbiBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHZveGVsIHJvdGF0aW9uIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBnZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnopIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSByZXR1cm4gbmV3IEJsb2NrUm90YXRpb24oKTsKICAgICAgcmV0dXJuIEJsb2NrVXRpbHMuZXh0cmFjdFJvdGF0aW9uKHRoaXMuZ2V0UmF3VmFsdWUodngsIHZ5LCB2eikpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZveGVsIHJvdGF0aW9uIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSByb3RhdGlvbiBUaGUgdm94ZWwgcm90YXRpb24gdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBzZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnosIHJvdGF0aW9uKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbigKICAgICAgICB0aGlzLmdldFJhd1ZhbHVlKHZ4LCB2eSwgdnopLAogICAgICAgIHJvdGF0aW9uCiAgICAgICk7CiAgICAgIHRoaXMuc2V0UmF3VmFsdWUodngsIHZ5LCB2eiwgdmFsdWUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZveGVsIHN0YWdlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgc3RhZ2UgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIGdldFZveGVsU3RhZ2UodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICByZXR1cm4gQmxvY2tVdGlscy5leHRyYWN0U3RhZ2UodGhpcy5nZXRSYXdWYWx1ZSh2eCwgdnksIHZ6KSk7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgdm94ZWwgc3RhZ2UgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHN0YWdlIFRoZSB2b3hlbCBzdGFnZSB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgc3RhZ2UgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIHNldFZveGVsU3RhZ2UodngsIHZ5LCB2eiwgc3RhZ2UpIHsKICAgICAgY29uc3QgdmFsdWUgPSBCbG9ja1V0aWxzLmluc2VydFN0YWdlKHRoaXMuZ2V0UmF3VmFsdWUodngsIHZ5LCB2eiksIHN0YWdlKTsKICAgICAgdGhpcy5zZXRSYXdWYWx1ZSh2eCwgdnksIHZ6LCB2YWx1ZSk7CiAgICAgIHJldHVybiBzdGFnZTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgZ2V0UmVkTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsUmVkTGlnaHQobHgsIGx5LCBseik7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcmVkIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSBsZXZlbCBUaGUgcmVkIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgc2V0UmVkTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwpIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5zZXRMb2NhbFJlZExpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHJldHVybnMgVGhlIGdyZWVuIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIGdldEdyZWVuTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGdyZWVuIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBzZXRHcmVlbkxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0TG9jYWxHcmVlbkxpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcmV0dXJucyBUaGUgYmx1ZSBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBnZXRCbHVlTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIGJsdWUgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGxldmVsIFRoZSBibHVlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIHNldEJsdWVMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnNldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb2xvcmVkIHRvcmNoIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gY29sb3IgVGhlIGNvbG9yIG9mIHRoZSBsaWdodCB0byBnZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgZ2V0VG9yY2hMaWdodCh2eCwgdnksIHZ6LCBjb2xvcikgewogICAgICBzd2l0Y2ggKGNvbG9yKSB7CiAgICAgICAgY2FzZSAiUkVEIjoKICAgICAgICAgIHJldHVybiB0aGlzLmdldFJlZExpZ2h0KHZ4LCB2eSwgdnopOwogICAgICAgIGNhc2UgIkdSRUVOIjoKICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyZWVuTGlnaHQodngsIHZ5LCB2eik7CiAgICAgICAgY2FzZSAiQkxVRSI6CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRCbHVlTGlnaHQodngsIHZ5LCB2eik7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVjZWl2ZWQgdW5rbm93biBsaWdodCBjb2xvci4uLiIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgY29sb3JlZCB0b3JjaCBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBjb2xvciBUaGUgY29sb3Igb2YgdGhlIGxpZ2h0IHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBzZXRUb3JjaExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsLCBjb2xvcikgewogICAgICBzd2l0Y2ggKGNvbG9yKSB7CiAgICAgICAgY2FzZSAiUkVEIjoKICAgICAgICAgIHJldHVybiB0aGlzLnNldFJlZExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgICByZXR1cm4gdGhpcy5zZXRHcmVlbkxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICBjYXNlICJCTFVFIjoKICAgICAgICAgIHJldHVybiB0aGlzLnNldEJsdWVMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVjZWl2ZWQgdW5rbm93biBsaWdodCBjb2xvci4uLiIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgc3VubGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEByZXR1cm5zIFRoZSBzdW5saWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBnZXRTdW5saWdodCh2eCwgdnksIHZ6KSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIGlmICh2eSA8IDApIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLm1heExpZ2h0TGV2ZWw7CiAgICAgIH0KICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5nZXRMb2NhbFN1bmxpZ2h0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHN1bmxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSBsZXZlbCBUaGUgc3VubGlnaHQgbGV2ZWwgdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHN1bmxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIHNldFN1bmxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6LCBsZXZlbCk7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgb3Igbm90IGlzIHRoaXMgY2h1bmsgcmVhZHkgdG8gYmUgcmVuZGVyZWQgYW5kIHNlZW4gaW4gdGhlIHdvcmxkLgogICAgICovCiAgICBnZXQgaXNSZWFkeSgpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLmRhdGEubGVuZ3RoICE9PSAwICYmIHRoaXMudm94ZWxzLmRhdGEubGVuZ3RoICE9PSAwOwogICAgfQogICAgZ2V0TG9jYWxSZWRMaWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RSZWRMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxSZWRMaWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KAogICAgICAgIGx4LAogICAgICAgIGx5LAogICAgICAgIGx6LAogICAgICAgIExpZ2h0VXRpbHMuaW5zZXJ0UmVkTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIGdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RHcmVlbkxpZ2h0KHRoaXMubGlnaHRzLmdldChseCwgbHksIGx6KSk7CiAgICB9CiAgICBzZXRMb2NhbEdyZWVuTGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldCgKICAgICAgICBseCwKICAgICAgICBseSwKICAgICAgICBseiwKICAgICAgICBMaWdodFV0aWxzLmluc2VydEdyZWVuTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIGdldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHopIHsKICAgICAgcmV0dXJuIExpZ2h0VXRpbHMuZXh0cmFjdEJsdWVMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxCbHVlTGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldCgKICAgICAgICBseCwKICAgICAgICBseSwKICAgICAgICBseiwKICAgICAgICBMaWdodFV0aWxzLmluc2VydEJsdWVMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseiksIGxldmVsKQogICAgICApOwogICAgfQogICAgZ2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RTdW5saWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KAogICAgICAgIGx4LAogICAgICAgIGx5LAogICAgICAgIGx6LAogICAgICAgIExpZ2h0VXRpbHMuaW5zZXJ0U3VubGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIHRvTG9jYWwodngsIHZ5LCB2eikgewogICAgICBjb25zdCBbbXgsIG15LCBtel0gPSB0aGlzLm1pbjsKICAgICAgcmV0dXJuIFsodnggfCAwKSAtIG14LCAodnkgfCAwKSAtIG15LCAodnogfCAwKSAtIG16XTsKICAgIH0KICAgIGNvbnRhaW5zKHZ4LCB2eSwgdnopIHsKICAgICAgY29uc3QgeyBzaXplLCBtYXhIZWlnaHQgfSA9IHRoaXMub3B0aW9uczsKICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gbHggPCBzaXplICYmIGx5ID49IDAgJiYgbHkgPCBtYXhIZWlnaHQgJiYgbHogPj0gMCAmJiBseiA8IHNpemU7CiAgICB9CiAgfQogIGNsYXNzIFJlZ2lzdHJ5IHsKICAgIC8qKgogICAgICogQGhpZGRlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5ibG9ja3NCeU5hbWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLmJsb2Nrc0J5SWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLm5hbWVNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLmlkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIH0KICAgIHNlcmlhbGl6ZSgpIHsKICAgICAgY29uc3QgY2xlYW5CbG9jayA9IChibG9jaykgPT4gewogICAgICAgIGNvbnN0IHsgZHluYW1pY0ZuLCAuLi5yZXN0IH0gPSBibG9jazsKICAgICAgICByZXR1cm4gcmVzdDsKICAgICAgfTsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UoCiAgICAgICAgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgYmxvY2tzQnlOYW1lOiBBcnJheS5mcm9tKHRoaXMuYmxvY2tzQnlOYW1lLmVudHJpZXMoKSkubWFwKAogICAgICAgICAgICAoW25hbWUsIGJsb2NrXSkgPT4gW25hbWUsIGNsZWFuQmxvY2soYmxvY2spXQogICAgICAgICAgKSwKICAgICAgICAgIGJsb2Nrc0J5SWQ6IEFycmF5LmZyb20odGhpcy5ibG9ja3NCeUlkLmVudHJpZXMoKSkubWFwKChbaWQsIGJsb2NrXSkgPT4gWwogICAgICAgICAgICBpZCwKICAgICAgICAgICAgY2xlYW5CbG9jayhibG9jaykKICAgICAgICAgIF0pLAogICAgICAgICAgbmFtZU1hcDogQXJyYXkuZnJvbSh0aGlzLm5hbWVNYXAuZW50cmllcygpKSwKICAgICAgICAgIGlkTWFwOiBBcnJheS5mcm9tKHRoaXMuaWRNYXAuZW50cmllcygpKQogICAgICAgIH0pCiAgICAgICk7CiAgICB9CiAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICBjb25zdCByZWdpc3RyeTIgPSBuZXcgUmVnaXN0cnkoKTsKICAgICAgcmVnaXN0cnkyLmJsb2Nrc0J5TmFtZSA9IG5ldyBNYXAoZGF0YS5ibG9ja3NCeU5hbWUpOwogICAgICByZWdpc3RyeTIuYmxvY2tzQnlJZCA9IG5ldyBNYXAoZGF0YS5ibG9ja3NCeUlkKTsKICAgICAgcmVnaXN0cnkyLm5hbWVNYXAgPSBuZXcgTWFwKGRhdGEubmFtZU1hcCk7CiAgICAgIHJlZ2lzdHJ5Mi5pZE1hcCA9IG5ldyBNYXAoZGF0YS5pZE1hcCk7CiAgICAgIHJldHVybiByZWdpc3RyeTI7CiAgICB9CiAgfQogIGxldCByZWdpc3RyeTsKICBjb25zdCBWT1hFTF9ORUlHSEJPUlMgPSBbCiAgICBbMSwgMCwgMF0sCiAgICBbLTEsIDAsIDBdLAogICAgWzAsIDAsIDFdLAogICAgWzAsIDAsIC0xXSwKICAgIFswLCAxLCAwXSwKICAgIFswLCAtMSwgMF0KICBdOwogIGNvbnN0IEFMTF9UUkFOU1BBUkVOVCA9IFt0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlLCB0cnVlXTsKICBjbGFzcyBCb3VuZGVkU3BhY2UgewogICAgY29uc3RydWN0b3IoY2h1bmtHcmlkLCBncmlkV2lkdGgsIGdyaWREZXB0aCwgZ3JpZE9mZnNldFgsIGdyaWRPZmZzZXRaLCBjaHVua1NpemUpIHsKICAgICAgdGhpcy5jaHVua0dyaWQgPSBjaHVua0dyaWQ7CiAgICAgIHRoaXMuZ3JpZFdpZHRoID0gZ3JpZFdpZHRoOwogICAgICB0aGlzLmdyaWREZXB0aCA9IGdyaWREZXB0aDsKICAgICAgdGhpcy5ncmlkT2Zmc2V0WCA9IGdyaWRPZmZzZXRYOwogICAgICB0aGlzLmdyaWRPZmZzZXRaID0gZ3JpZE9mZnNldFo7CiAgICAgIHRoaXMuY2h1bmtTaXplID0gY2h1bmtTaXplOwogICAgICB0aGlzLmNodW5rQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLm1vZGlmaWVkQ2h1bmtzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIH0KICAgIGdldENodW5rQnlDb29yZHMoY3gsIGN6KSB7CiAgICAgIGNvbnN0IGxvY2FsWCA9IGN4IC0gdGhpcy5ncmlkT2Zmc2V0WDsKICAgICAgY29uc3QgbG9jYWxaID0gY3ogLSB0aGlzLmdyaWRPZmZzZXRaOwogICAgICBpZiAobG9jYWxYIDwgMCB8fCBsb2NhbFggPj0gdGhpcy5ncmlkV2lkdGggfHwgbG9jYWxaIDwgMCB8fCBsb2NhbFogPj0gdGhpcy5ncmlkRGVwdGgpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5jaHVua0dyaWRbbG9jYWxYXVtsb2NhbFpdOwogICAgfQogICAgZ2V0Q2FjaGVkQ2h1bmsoY3gsIGN6KSB7CiAgICAgIGNvbnN0IGtleSA9IGAke2N4fSwke2N6fWA7CiAgICAgIGxldCBjaHVuayA9IHRoaXMuY2h1bmtDYWNoZS5nZXQoa2V5KTsKICAgICAgaWYgKGNodW5rID09PSB2b2lkIDApIHsKICAgICAgICBjaHVuayA9IHRoaXMuZ2V0Q2h1bmtCeUNvb3JkcyhjeCwgY3opOwogICAgICAgIHRoaXMuY2h1bmtDYWNoZS5zZXQoa2V5LCBjaHVuayk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNodW5rOwogICAgfQogICAgZ2V0Vm94ZWxBdCh2eCwgdnksIHZ6KSB7CiAgICAgIGNvbnN0IFtjeCwgY3pdID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCB0aGlzLmNodW5rU2l6ZSk7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5nZXRDYWNoZWRDaHVuayhjeCwgY3opOwogICAgICByZXR1cm4gKGNodW5rID09IG51bGwgPyB2b2lkIDAgOiBjaHVuay5nZXRWb3hlbCh2eCwgdnksIHZ6KSkgPz8gMDsKICAgIH0KICAgIGdldFZveGVsUm90YXRpb25BdCh2eCwgdnksIHZ6KSB7CiAgICAgIGNvbnN0IFtjeCwgY3pdID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCB0aGlzLmNodW5rU2l6ZSk7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5nZXRDYWNoZWRDaHVuayhjeCwgY3opOwogICAgICByZXR1cm4gKGNodW5rID09IG51bGwgPyB2b2lkIDAgOiBjaHVuay5nZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnopKSA/PyBuZXcgQmxvY2tSb3RhdGlvbigpOwogICAgfQogICAgZ2V0Vm94ZWxTdGFnZUF0KHZ4LCB2eSwgdnopIHsKICAgICAgY29uc3QgW2N4LCBjel0gPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuayhbdngsIHZ5LCB2el0sIHRoaXMuY2h1bmtTaXplKTsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmdldENhY2hlZENodW5rKGN4LCBjeik7CiAgICAgIHJldHVybiAoY2h1bmsgPT0gbnVsbCA/IHZvaWQgMCA6IGNodW5rLmdldFZveGVsU3RhZ2UodngsIHZ5LCB2eikpID8/IDA7CiAgICB9CiAgICBnZXRTdW5saWdodEF0KHZ4LCB2eSwgdnopIHsKICAgICAgY29uc3QgW2N4LCBjel0gPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuayhbdngsIHZ5LCB2el0sIHRoaXMuY2h1bmtTaXplKTsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmdldENhY2hlZENodW5rKGN4LCBjeik7CiAgICAgIHJldHVybiAoY2h1bmsgPT0gbnVsbCA/IHZvaWQgMCA6IGNodW5rLmdldFN1bmxpZ2h0KHZ4LCB2eSwgdnopKSA/PyAwOwogICAgfQogICAgZ2V0VG9yY2hMaWdodEF0KHZ4LCB2eSwgdnosIGNvbG9yKSB7CiAgICAgIGNvbnN0IFtjeCwgY3pdID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCB0aGlzLmNodW5rU2l6ZSk7CiAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5nZXRDYWNoZWRDaHVuayhjeCwgY3opOwogICAgICByZXR1cm4gKGNodW5rID09IG51bGwgPyB2b2lkIDAgOiBjaHVuay5nZXRUb3JjaExpZ2h0KHZ4LCB2eSwgdnosIGNvbG9yKSkgPz8gMDsKICAgIH0KICAgIHNldFN1bmxpZ2h0QXQodngsIHZ5LCB2eiwgbGV2ZWwpIHsKICAgICAgY29uc3QgW2N4LCBjel0gPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuayhbdngsIHZ5LCB2el0sIHRoaXMuY2h1bmtTaXplKTsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmdldENhY2hlZENodW5rKGN4LCBjeik7CiAgICAgIGlmIChjaHVuaykgewogICAgICAgIGNodW5rLnNldFN1bmxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICB0aGlzLm1vZGlmaWVkQ2h1bmtzLmFkZChjaHVuayk7CiAgICAgIH0KICAgIH0KICAgIHNldFRvcmNoTGlnaHRBdCh2eCwgdnksIHZ6LCBsZXZlbCwgY29sb3IpIHsKICAgICAgY29uc3QgW2N4LCBjel0gPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuayhbdngsIHZ5LCB2el0sIHRoaXMuY2h1bmtTaXplKTsKICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLmdldENhY2hlZENodW5rKGN4LCBjeik7CiAgICAgIGlmIChjaHVuaykgewogICAgICAgIGNodW5rLnNldFRvcmNoTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwsIGNvbG9yKTsKICAgICAgICB0aGlzLm1vZGlmaWVkQ2h1bmtzLmFkZChjaHVuayk7CiAgICAgIH0KICAgIH0KICAgIG1hcmtDaHVua01vZGlmaWVkKGN4LCBjeikgewogICAgICBjb25zdCBjaHVuayA9IHRoaXMuZ2V0Q2FjaGVkQ2h1bmsoY3gsIGN6KTsKICAgICAgaWYgKGNodW5rKSB7CiAgICAgICAgdGhpcy5tb2RpZmllZENodW5rcy5hZGQoY2h1bmspOwogICAgICB9CiAgICB9CiAgICBnZXRNb2RpZmllZENodW5rcygpIHsKICAgICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5tb2RpZmllZENodW5rcyk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGZsb29kTGlnaHQoc3BhY2UsIHF1ZXVlLCBjb2xvciwgbWluMiwgbWF4Miwgb3B0aW9ucykgewogICAgY29uc3QgeyBtYXhIZWlnaHQsIG1pbkNodW5rLCBtYXhDaHVuaywgbWF4TGlnaHRMZXZlbCwgY2h1bmtTaXplIH0gPSBvcHRpb25zOwogICAgY29uc3QgW3N0YXJ0Q1gsIHN0YXJ0Q1pdID0gbWluQ2h1bms7CiAgICBjb25zdCBbZW5kQ1gsIGVuZENaXSA9IG1heENodW5rOwogICAgY29uc3QgaXNTdW5saWdodCA9IGNvbG9yID09PSAiU1VOTElHSFQiOwogICAgY29uc3QgYmxvY2tDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCByb3RhdGlvbkNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGdldENhY2hlZEJsb2NrID0gKHZ4LCB2eSwgdnopID0+IHsKICAgICAgY29uc3Qga2V5ID0gYCR7dnh9LCR7dnl9LCR7dnp9YDsKICAgICAgbGV0IGJsb2NrID0gYmxvY2tDYWNoZS5nZXQoa2V5KTsKICAgICAgaWYgKCFibG9jaykgewogICAgICAgIGNvbnN0IGlkID0gc3BhY2UuZ2V0Vm94ZWxBdCh2eCwgdnksIHZ6KTsKICAgICAgICBibG9jayA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KGlkKTsKICAgICAgICBibG9ja0NhY2hlLnNldChrZXksIGJsb2NrKTsKICAgICAgfQogICAgICByZXR1cm4gYmxvY2s7CiAgICB9OwogICAgY29uc3QgZ2V0Q2FjaGVkUm90YXRpb24gPSAodngsIHZ5LCB2eikgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHt2eH0sJHt2eX0sJHt2en1gOwogICAgICBsZXQgcm90YXRpb24gPSByb3RhdGlvbkNhY2hlLmdldChrZXkpOwogICAgICBpZiAoIXJvdGF0aW9uKSB7CiAgICAgICAgcm90YXRpb24gPSBzcGFjZS5nZXRWb3hlbFJvdGF0aW9uQXQodngsIHZ5LCB2eik7CiAgICAgICAgcm90YXRpb25DYWNoZS5zZXQoa2V5LCByb3RhdGlvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJvdGF0aW9uOwogICAgfTsKICAgIHdoaWxlIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgY29uc3Qgbm9kZSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgIGlmICghbm9kZSkgYnJlYWs7CiAgICAgIGNvbnN0IHsgdm94ZWwsIGxldmVsIH0gPSBub2RlOwogICAgICBpZiAobGV2ZWwgPT09IDApIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBjb25zdCBbdngsIHZ5LCB2el0gPSB2b3hlbDsKICAgICAgY29uc3Qgc291cmNlQmxvY2sgPSBnZXRDYWNoZWRCbG9jayh2eCwgdnksIHZ6KTsKICAgICAgY29uc3Qgc291cmNlUm90YXRpb24gPSBnZXRDYWNoZWRSb3RhdGlvbih2eCwgdnksIHZ6KTsKICAgICAgY29uc3Qgc291cmNlVHJhbnNwYXJlbmN5ID0gIWlzU3VubGlnaHQgJiYgQmxvY2tVdGlscy5nZXRCbG9ja1RvcmNoTGlnaHRMZXZlbChzb3VyY2VCbG9jaywgY29sb3IpID4gMCA/IEFMTF9UUkFOU1BBUkVOVCA6IEJsb2NrVXRpbHMuZ2V0QmxvY2tSb3RhdGVkVHJhbnNwYXJlbmN5KHNvdXJjZUJsb2NrLCBzb3VyY2VSb3RhdGlvbik7CiAgICAgIGZvciAoY29uc3QgW294LCBveSwgb3pdIG9mIFZPWEVMX05FSUdIQk9SUykgewogICAgICAgIGNvbnN0IG52eSA9IHZ5ICsgb3k7CiAgICAgICAgaWYgKG52eSA8IDAgfHwgbnZ5ID49IG1heEhlaWdodCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG52eCA9IHZ4ICsgb3g7CiAgICAgICAgY29uc3QgbnZ6ID0gdnogKyBvejsKICAgICAgICBjb25zdCBbbmN4LCBuY3pdID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW252eCwgbnZ5LCBudnpdLCBjaHVua1NpemUpOwogICAgICAgIGlmIChuY3ggPCBzdGFydENYIHx8IG5jeCA+IGVuZENYIHx8IG5jeiA8IHN0YXJ0Q1ogfHwgbmN6ID4gZW5kQ1ogfHwgbWluMiAmJiAobnZ4IDwgbWluMlswXSB8fCBudnogPCBtaW4yWzJdKSB8fCBtYXgyICYmIChudnggPj0gbWF4MlswXSB8fCBudnogPj0gbWF4MlsyXSkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXh0Vm94ZWwgPSBbbnZ4LCBudnksIG52el07CiAgICAgICAgY29uc3QgbkJsb2NrID0gZ2V0Q2FjaGVkQmxvY2sobnZ4LCBudnksIG52eik7CiAgICAgICAgY29uc3QgblJvdGF0aW9uID0gZ2V0Q2FjaGVkUm90YXRpb24obnZ4LCBudnksIG52eik7CiAgICAgICAgY29uc3QgblRyYW5zcGFyZW5jeSA9IEJsb2NrVXRpbHMuZ2V0QmxvY2tSb3RhdGVkVHJhbnNwYXJlbmN5KAogICAgICAgICAgbkJsb2NrLAogICAgICAgICAgblJvdGF0aW9uCiAgICAgICAgKTsKICAgICAgICBjb25zdCBuZXh0TGV2ZWwgPSBsZXZlbCAtIChpc1N1bmxpZ2h0ICYmICFuQmxvY2subGlnaHRSZWR1Y2UgJiYgb3kgPT09IC0xICYmIGxldmVsID09PSBtYXhMaWdodExldmVsID8gMCA6IDEpOwogICAgICAgIGlmICghTGlnaHRVdGlscy5jYW5FbnRlcihzb3VyY2VUcmFuc3BhcmVuY3ksIG5UcmFuc3BhcmVuY3ksIG94LCBveSwgb3opIHx8IChpc1N1bmxpZ2h0ID8gc3BhY2UuZ2V0U3VubGlnaHRBdChudngsIG52eSwgbnZ6KSA6IHNwYWNlLmdldFRvcmNoTGlnaHRBdChudngsIG52eSwgbnZ6LCBjb2xvcikpID49IG5leHRMZXZlbCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc1N1bmxpZ2h0KSB7CiAgICAgICAgICBzcGFjZS5zZXRTdW5saWdodEF0KG52eCwgbnZ5LCBudnosIG5leHRMZXZlbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNwYWNlLnNldFRvcmNoTGlnaHRBdChudngsIG52eSwgbnZ6LCBuZXh0TGV2ZWwsIGNvbG9yKTsKICAgICAgICB9CiAgICAgICAgcXVldWUucHVzaCh7IHZveGVsOiBuZXh0Vm94ZWwsIGxldmVsOiBuZXh0TGV2ZWwgfSk7CiAgICAgIH0KICAgIH0KICB9CiAgZnVuY3Rpb24gcmVtb3ZlTGlnaHRzQmF0Y2goc3BhY2UsIHZveGVscywgY29sb3IsIG9wdGlvbnMpIHsKICAgIGlmICghdm94ZWxzLmxlbmd0aCkgcmV0dXJuIFtdOwogICAgY29uc3QgeyBtYXhIZWlnaHQsIG1heExpZ2h0TGV2ZWwgfSA9IG9wdGlvbnM7CiAgICBjb25zdCBmaWxsID0gW107CiAgICBjb25zdCBxdWV1ZSA9IFtdOwogICAgY29uc3QgaXNTdW5saWdodCA9IGNvbG9yID09PSAiU1VOTElHSFQiOwogICAgdm94ZWxzLmZvckVhY2goKFt2eCwgdnksIHZ6XSkgPT4gewogICAgICBjb25zdCBsZXZlbCA9IGlzU3VubGlnaHQgPyBzcGFjZS5nZXRTdW5saWdodEF0KHZ4LCB2eSwgdnopIDogc3BhY2UuZ2V0VG9yY2hMaWdodEF0KHZ4LCB2eSwgdnosIGNvbG9yKTsKICAgICAgaWYgKGxldmVsID09PSAwKSByZXR1cm47CiAgICAgIHF1ZXVlLnB1c2goeyB2b3hlbDogW3Z4LCB2eSwgdnpdLCBsZXZlbCB9KTsKICAgICAgaWYgKGlzU3VubGlnaHQpIHsKICAgICAgICBzcGFjZS5zZXRTdW5saWdodEF0KHZ4LCB2eSwgdnosIDApOwogICAgICB9IGVsc2UgewogICAgICAgIHNwYWNlLnNldFRvcmNoTGlnaHRBdCh2eCwgdnksIHZ6LCAwLCBjb2xvcik7CiAgICAgIH0KICAgIH0pOwogICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCkgewogICAgICBjb25zdCBub2RlID0gcXVldWUuc2hpZnQoKTsKICAgICAgaWYgKCFub2RlKSBicmVhazsKICAgICAgY29uc3QgeyB2b3hlbCwgbGV2ZWwgfSA9IG5vZGU7CiAgICAgIGNvbnN0IFt2eCwgdnksIHZ6XSA9IHZveGVsOwogICAgICBmb3IgKGNvbnN0IFtveCwgb3ksIG96XSBvZiBWT1hFTF9ORUlHSEJPUlMpIHsKICAgICAgICBjb25zdCBudnkgPSB2eSArIG95OwogICAgICAgIGlmIChudnkgPCAwIHx8IG52eSA+PSBtYXhIZWlnaHQpIGNvbnRpbnVlOwogICAgICAgIGNvbnN0IG52eCA9IHZ4ICsgb3g7CiAgICAgICAgY29uc3QgbnZ6ID0gdnogKyBvejsKICAgICAgICBjb25zdCBuQmxvY2tJZCA9IHNwYWNlLmdldFZveGVsQXQobnZ4LCBudnksIG52eik7CiAgICAgICAgY29uc3QgbkJsb2NrID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQobkJsb2NrSWQpOwogICAgICAgIGNvbnN0IHJvdGF0aW9uID0gc3BhY2UuZ2V0Vm94ZWxSb3RhdGlvbkF0KG52eCwgbnZ5LCBudnopOwogICAgICAgIGNvbnN0IG5UcmFuc3BhcmVuY3kgPSBCbG9ja1V0aWxzLmdldEJsb2NrUm90YXRlZFRyYW5zcGFyZW5jeSgKICAgICAgICAgIG5CbG9jaywKICAgICAgICAgIHJvdGF0aW9uCiAgICAgICAgKTsKICAgICAgICBpZiAoKGlzU3VubGlnaHQgPyB0cnVlIDogQmxvY2tVdGlscy5nZXRCbG9ja1RvcmNoTGlnaHRMZXZlbChuQmxvY2ssIGNvbG9yKSA9PT0gMCkgJiYgIUxpZ2h0VXRpbHMuY2FuRW50ZXJJbnRvKG5UcmFuc3BhcmVuY3ksIG94LCBveSwgb3opKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmwgPSBpc1N1bmxpZ2h0ID8gc3BhY2UuZ2V0U3VubGlnaHRBdChudngsIG52eSwgbnZ6KSA6IHNwYWNlLmdldFRvcmNoTGlnaHRBdChudngsIG52eSwgbnZ6LCBjb2xvcik7CiAgICAgICAgaWYgKG5sID09PSAwKSBjb250aW51ZTsKICAgICAgICBpZiAobmwgPCBsZXZlbCB8fCBpc1N1bmxpZ2h0ICYmIG95ID09PSAtMSAmJiBsZXZlbCA9PT0gbWF4TGlnaHRMZXZlbCAmJiBubCA9PT0gbWF4TGlnaHRMZXZlbCkgewogICAgICAgICAgcXVldWUucHVzaCh7IHZveGVsOiBbbnZ4LCBudnksIG52el0sIGxldmVsOiBubCB9KTsKICAgICAgICAgIGlmIChpc1N1bmxpZ2h0KSB7CiAgICAgICAgICAgIHNwYWNlLnNldFN1bmxpZ2h0QXQobnZ4LCBudnksIG52eiwgMCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzcGFjZS5zZXRUb3JjaExpZ2h0QXQobnZ4LCBudnksIG52eiwgMCwgY29sb3IpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoaXNTdW5saWdodCAmJiBveSA9PT0gLTEgPyBubCA+IGxldmVsIDogbmwgPj0gbGV2ZWwpIHsKICAgICAgICAgIGZpbGwucHVzaCh7IHZveGVsOiBbbnZ4LCBudnksIG52el0sIGxldmVsOiBubCB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmaWxsOwogIH0KICBvbm1lc3NhZ2UgPSBmdW5jdGlvbihlKSB7CiAgICBjb25zdCB7IHR5cGUgfSA9IGUuZGF0YTsKICAgIGlmICh0eXBlID09PSAiaW5pdCIpIHsKICAgICAgcmVnaXN0cnkgPSBSZWdpc3RyeS5kZXNlcmlhbGl6ZShlLmRhdGEucmVnaXN0cnlEYXRhKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGUgPT09ICJiYXRjaE9wZXJhdGlvbnMiKSB7CiAgICAgIGNvbnN0IHsKICAgICAgICBqb2JJZCwKICAgICAgICBjb2xvciwKICAgICAgICBib3VuZGluZ0JveCwKICAgICAgICBjaHVua3NEYXRhLAogICAgICAgIGNodW5rR3JpZERpbWVuc2lvbnMsCiAgICAgICAgY2h1bmtHcmlkT2Zmc2V0LAogICAgICAgIHJlbGV2YW50RGVsdGFzLAogICAgICAgIGxpZ2h0T3BzLAogICAgICAgIG9wdGlvbnMKICAgICAgfSA9IGUuZGF0YTsKICAgICAgY29uc3QgW2dyaWRXaWR0aCwgZ3JpZERlcHRoXSA9IGNodW5rR3JpZERpbWVuc2lvbnM7CiAgICAgIGNvbnN0IFtncmlkT2Zmc2V0WCwgZ3JpZE9mZnNldFpdID0gY2h1bmtHcmlkT2Zmc2V0OwogICAgICBjb25zdCBjaHVua0dyaWQgPSBbXTsKICAgICAgbGV0IGlkeCA9IDA7CiAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgZ3JpZFdpZHRoOyB4KyspIHsKICAgICAgICBjaHVua0dyaWRbeF0gPSBbXTsKICAgICAgICBmb3IgKGxldCB6ID0gMDsgeiA8IGdyaWREZXB0aDsgeisrKSB7CiAgICAgICAgICBjb25zdCBkYXRhID0gY2h1bmtzRGF0YVtpZHgrK107CiAgICAgICAgICBjaHVua0dyaWRbeF1bel0gPSBkYXRhID8gUmF3Q2h1bmsuZGVzZXJpYWxpemUoZGF0YSkgOiBudWxsOwogICAgICAgIH0KICAgICAgfQogICAgICBsZXQgbGFzdFNlcXVlbmNlSWQgPSAwOwogICAgICBPYmplY3QuZW50cmllcyhyZWxldmFudERlbHRhcykuZm9yRWFjaCgoW2NodW5rTmFtZSwgZGVsdGFzXSkgPT4gewogICAgICAgIGNvbnN0IFtjeCwgY3pdID0gQ2h1bmtVdGlscy5wYXJzZUNodW5rTmFtZShjaHVua05hbWUpOwogICAgICAgIGNvbnN0IGxvY2FsWCA9IGN4IC0gZ3JpZE9mZnNldFg7CiAgICAgICAgY29uc3QgbG9jYWxaID0gY3ogLSBncmlkT2Zmc2V0WjsKICAgICAgICBpZiAobG9jYWxYIDwgMCB8fCBsb2NhbFggPj0gZ3JpZFdpZHRoIHx8IGxvY2FsWiA8IDAgfHwgbG9jYWxaID49IGdyaWREZXB0aCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjaHVuayA9IGNodW5rR3JpZFtsb2NhbFhdW2xvY2FsWl07CiAgICAgICAgaWYgKCFjaHVuaykgcmV0dXJuOwogICAgICAgIGRlbHRhcy5mb3JFYWNoKChkZWx0YSkgPT4gewogICAgICAgICAgY29uc3QgeyBjb29yZHMsIG5ld1ZveGVsLCBuZXdSb3RhdGlvbiwgbmV3U3RhZ2UsIHNlcXVlbmNlSWQgfSA9IGRlbHRhOwogICAgICAgICAgY2h1bmsuc2V0Vm94ZWwoY29vcmRzWzBdLCBjb29yZHNbMV0sIGNvb3Jkc1syXSwgbmV3Vm94ZWwpOwogICAgICAgICAgaWYgKG5ld1JvdGF0aW9uKQogICAgICAgICAgICBjaHVuay5zZXRWb3hlbFJvdGF0aW9uKGNvb3Jkc1swXSwgY29vcmRzWzFdLCBjb29yZHNbMl0sIG5ld1JvdGF0aW9uKTsKICAgICAgICAgIGlmIChuZXdTdGFnZSAhPT0gdm9pZCAwKQogICAgICAgICAgICBjaHVuay5zZXRWb3hlbFN0YWdlKGNvb3Jkc1swXSwgY29vcmRzWzFdLCBjb29yZHNbMl0sIG5ld1N0YWdlKTsKICAgICAgICAgIGxhc3RTZXF1ZW5jZUlkID0gTWF0aC5tYXgobGFzdFNlcXVlbmNlSWQsIHNlcXVlbmNlSWQpOwogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgY29uc3Qgc3BhY2UgPSBuZXcgQm91bmRlZFNwYWNlKAogICAgICAgIGNodW5rR3JpZCwKICAgICAgICBncmlkV2lkdGgsCiAgICAgICAgZ3JpZERlcHRoLAogICAgICAgIGdyaWRPZmZzZXRYLAogICAgICAgIGdyaWRPZmZzZXRaLAogICAgICAgIG9wdGlvbnMuY2h1bmtTaXplCiAgICAgICk7CiAgICAgIGNvbnN0IHsgbWluOiBtaW4yLCBzaGFwZSB9ID0gYm91bmRpbmdCb3g7CiAgICAgIGNvbnN0IG1heENvb3JkcyA9IFsKICAgICAgICBtaW4yWzBdICsgc2hhcGVbMF0sCiAgICAgICAgbWluMlsxXSArIHNoYXBlWzFdLAogICAgICAgIG1pbjJbMl0gKyBzaGFwZVsyXQogICAgICBdOwogICAgICBpZiAobGlnaHRPcHMucmVtb3ZhbHMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGZpbGxRdWV1ZSA9IHJlbW92ZUxpZ2h0c0JhdGNoKAogICAgICAgICAgc3BhY2UsCiAgICAgICAgICBsaWdodE9wcy5yZW1vdmFscywKICAgICAgICAgIGNvbG9yLAogICAgICAgICAgb3B0aW9ucwogICAgICAgICk7CiAgICAgICAgaWYgKGZpbGxRdWV1ZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBmbG9vZExpZ2h0KHNwYWNlLCBmaWxsUXVldWUsIGNvbG9yLCBtaW4yLCBtYXhDb29yZHMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobGlnaHRPcHMuZmxvb2RzLmxlbmd0aCA+IDApIHsKICAgICAgICBsaWdodE9wcy5mbG9vZHMuZm9yRWFjaCgobm9kZSkgPT4gewogICAgICAgICAgY29uc3QgW3Z4LCB2eSwgdnpdID0gbm9kZS52b3hlbDsKICAgICAgICAgIGlmIChjb2xvciA9PT0gIlNVTkxJR0hUIikgewogICAgICAgICAgICBzcGFjZS5zZXRTdW5saWdodEF0KHZ4LCB2eSwgdnosIG5vZGUubGV2ZWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3BhY2Uuc2V0VG9yY2hMaWdodEF0KHZ4LCB2eSwgdnosIG5vZGUubGV2ZWwsIGNvbG9yKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBmbG9vZExpZ2h0KHNwYWNlLCBsaWdodE9wcy5mbG9vZHMsIGNvbG9yLCBtaW4yLCBtYXhDb29yZHMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIGNvbnN0IG1vZGlmaWVkQ2h1bmtzID0gc3BhY2UuZ2V0TW9kaWZpZWRDaHVua3MoKTsKICAgICAgcG9zdE1lc3NhZ2UoCiAgICAgICAgewogICAgICAgICAgam9iSWQsCiAgICAgICAgICBtb2RpZmllZENodW5rczogbW9kaWZpZWRDaHVua3MubWFwKChjaHVuaykgPT4gKHsKICAgICAgICAgICAgY29vcmRzOiBjaHVuay5jb29yZHMsCiAgICAgICAgICAgIGxpZ2h0czogY2h1bmsubGlnaHRzLmRhdGEKICAgICAgICAgIH0pKSwKICAgICAgICAgIGFwcGxpZWREZWx0YXM6IHsgbGFzdFNlcXVlbmNlSWQgfQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgdHJhbnNmZXI6IG1vZGlmaWVkQ2h1bmtzLm1hcCgoYykgPT4gYy5saWdodHMuZGF0YS5idWZmZXIpCiAgICAgICAgfQogICAgICApOwogICAgfQogIH07Cn0pKCk7Cg==",GC="undefined"!=typeof self&&self.Blob&&new Blob([(g=>Uint8Array.from(atob(g),(g=>g.charCodeAt(0))))(bC)],{type:"text/javascript;charset=utf-8"});function BC(g){let I;try{if(I=GC&&(self.URL||self.webkitURL).createObjectURL(GC),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+bC,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}const WC="KGZ1bmN0aW9uKCkgewogICJ1c2Ugc3RyaWN0IjsKICB2YXIgX0FBQkIgPSBjbGFzcyB7CiAgICBjb25zdHJ1Y3RvcihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKSB7CiAgICAgIHRoaXMubWluWCA9IG1pblg7CiAgICAgIHRoaXMubWluWSA9IG1pblk7CiAgICAgIHRoaXMubWluWiA9IG1pblo7CiAgICAgIHRoaXMubWF4WCA9IG1heFg7CiAgICAgIHRoaXMubWF4WSA9IG1heFk7CiAgICAgIHRoaXMubWF4WiA9IG1heFo7CiAgICAgIHRoaXMuZ2V0TWluID0gKGF4aXMpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubWluWDsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1pblk7CiAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5taW5aOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdldE1pbkVycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICB0aGlzLnNldE1pbiA9IChheGlzLCB2YWx1ZSkgPT4gewogICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICB0aGlzLm1pblggPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHRoaXMubWluWSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5taW5aID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0TWluRXJyb3I6IFVua25vd24gYXhpcy4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMuZ2V0TWF4ID0gKGF4aXMpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIHRoaXMubWF4WDsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHJldHVybiB0aGlzLm1heFk7CiAgICAgICAgfSBlbHNlIGlmIChheGlzID09PSAyKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5tYXhaOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkdldE1heEVycm9yOiBVbmtub3duIGF4aXMuIik7CiAgICAgICAgfQogICAgICB9OwogICAgICB0aGlzLnNldE1heCA9IChheGlzLCB2YWx1ZSkgPT4gewogICAgICAgIGlmIChheGlzID09PSAwKSB7CiAgICAgICAgICB0aGlzLm1heFggPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKGF4aXMgPT09IDEpIHsKICAgICAgICAgIHRoaXMubWF4WSA9IHZhbHVlOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5tYXhaID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2V0TWF4RXJyb3I6IFVua25vd24gYXhpcy4iKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMudHJhbnNsYXRlID0gKFtkeCwgZHksIGR6XSkgPT4gewogICAgICAgIHRoaXMubWluWCArPSBkeDsKICAgICAgICB0aGlzLm1pblkgKz0gZHk7CiAgICAgICAgdGhpcy5taW5aICs9IGR6OwogICAgICAgIHRoaXMubWF4WCArPSBkeDsKICAgICAgICB0aGlzLm1heFkgKz0gZHk7CiAgICAgICAgdGhpcy5tYXhaICs9IGR6OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwogICAgICB0aGlzLnRyYW5zbGF0ZUF4aXMgPSAoYXhpcywgZGVsdGEpID0+IHsKICAgICAgICBpZiAoYXhpcyA9PT0gMCkgewogICAgICAgICAgdGhpcy5taW5YICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhYICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMSkgewogICAgICAgICAgdGhpcy5taW5ZICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhZICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSBpZiAoYXhpcyA9PT0gMikgewogICAgICAgICAgdGhpcy5taW5aICs9IGRlbHRhOwogICAgICAgICAgdGhpcy5tYXhaICs9IGRlbHRhOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRyYW5zbGF0ZUF4aXNFcnJvcjogVW5rbm93biBheGlzLiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfTsKICAgICAgdGhpcy5zZXRQb3NpdGlvbiA9IChbcHgsIHB5LCBwel0pID0+IHsKICAgICAgICB0aGlzLm1heFggPSBweCArIHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5tYXhZID0gcHkgKyB0aGlzLmhlaWdodDsKICAgICAgICB0aGlzLm1heFogPSBweiArIHRoaXMuZGVwdGg7CiAgICAgICAgdGhpcy5taW5YID0gcHg7CiAgICAgICAgdGhpcy5taW5ZID0gcHk7CiAgICAgICAgdGhpcy5taW5aID0gcHo7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH07CiAgICAgIHRoaXMuaW50ZXJzZWN0cyA9IChhYWJiKSA9PiB7CiAgICAgICAgaWYgKGFhYmIubWluWCA+PSB0aGlzLm1heFgpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWluWSA+PSB0aGlzLm1heFkpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWluWiA+PSB0aGlzLm1heFopCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WCA8PSB0aGlzLm1pblgpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WSA8PSB0aGlzLm1pblkpCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGFhYmIubWF4WiA8PSB0aGlzLm1pblopCiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH07CiAgICAgIHRoaXMudG91Y2hlcyA9IChhYWJiKSA9PiB7CiAgICAgICAgY29uc3QgaW50ZXJzZWN0aW9uID0gdGhpcy5pbnRlcnNlY3Rpb24oYWFiYik7CiAgICAgICAgcmV0dXJuIGludGVyc2VjdGlvbiAhPT0gbnVsbCAmJiAoaW50ZXJzZWN0aW9uLndpZHRoID09PSAwIHx8IGludGVyc2VjdGlvbi5oZWlnaHQgPT09IDAgfHwgaW50ZXJzZWN0aW9uLmRlcHRoID09PSAwKTsKICAgICAgfTsKICAgICAgdGhpcy51bmlvbiA9IChhYWJiKSA9PiB7CiAgICAgICAgcmV0dXJuIG5ldyBfQUFCQigKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWCwgYWFiYi5taW5YKSwKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWSwgYWFiYi5taW5ZKSwKICAgICAgICAgIE1hdGgubWluKHRoaXMubWluWiwgYWFiYi5taW5aKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WCwgYWFiYi5tYXhYKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WSwgYWFiYi5tYXhZKSwKICAgICAgICAgIE1hdGgubWF4KHRoaXMubWF4WiwgYWFiYi5tYXhaKQogICAgICAgICk7CiAgICAgIH07CiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uID0gKGFhYmIpID0+IHsKICAgICAgICByZXR1cm4gbmV3IF9BQUJCKAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5YLCBhYWJiLm1pblgpLAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5ZLCBhYWJiLm1pblkpLAogICAgICAgICAgTWF0aC5tYXgodGhpcy5taW5aLCBhYWJiLm1pblopLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhYLCBhYWJiLm1heFgpLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhZLCBhYWJiLm1heFkpLAogICAgICAgICAgTWF0aC5taW4odGhpcy5tYXhaLCBhYWJiLm1heFopCiAgICAgICAgKTsKICAgICAgfTsKICAgICAgdGhpcy5jbG9uZSA9ICgpID0+IHsKICAgICAgICByZXR1cm4gbmV3IF9BQUJCKAogICAgICAgICAgdGhpcy5taW5YLAogICAgICAgICAgdGhpcy5taW5ZLAogICAgICAgICAgdGhpcy5taW5aLAogICAgICAgICAgdGhpcy5tYXhYLAogICAgICAgICAgdGhpcy5tYXhZLAogICAgICAgICAgdGhpcy5tYXhaCiAgICAgICAgKTsKICAgICAgfTsKICAgIH0KICAgIGdldCB3aWR0aCgpIHsKICAgICAgcmV0dXJuIHRoaXMubWF4WCAtIHRoaXMubWluWDsKICAgIH0KICAgIGdldCBoZWlnaHQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1heFkgLSB0aGlzLm1pblk7CiAgICB9CiAgICBnZXQgZGVwdGgoKSB7CiAgICAgIHJldHVybiB0aGlzLm1heFogLSB0aGlzLm1pblo7CiAgICB9CiAgICBnZXQgbWFnKCkgewogICAgICByZXR1cm4gTWF0aC5zcXJ0KAogICAgICAgICh0aGlzLm1heFggLSB0aGlzLm1pblgpICoqIDIgKyAodGhpcy5tYXhZIC0gdGhpcy5taW5ZKSAqKiAyICsgKHRoaXMubWF4WiAtIHRoaXMubWluWikgKiogMgogICAgICApOwogICAgfQogICAgY29tcHV0ZU9mZnNldFgoYWFiYiwgZGVsdGFYKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLmhlaWdodCA8PSAwIHx8IGludGVyc2VjdGlvbi5kZXB0aCA8PSAwKSB7CiAgICAgICAgcmV0dXJuIGRlbHRhWDsKICAgICAgfQogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFYID4gMCAmJiBhYWJiLm1pblggPj0gdGhpcy5tYXhYKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWCAtIHRoaXMubWF4WCwgZGVsdGFYKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFYIDwgMCAmJiBhYWJiLm1heFggPD0gdGhpcy5taW5YKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WCAtIHRoaXMubWluWCwgZGVsdGFYKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFYOwogICAgfQogICAgY29tcHV0ZU9mZnNldFkoYWFiYiwgZGVsdGFZKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoIDw9IDAgfHwgaW50ZXJzZWN0aW9uLmRlcHRoIDw9IDApIHsKICAgICAgICByZXR1cm4gZGVsdGFZOwogICAgICB9CiAgICAgIGlmIChpbnRlcnNlY3Rpb24uaGVpZ2h0ID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFZID4gMCAmJiBhYWJiLm1pblkgPj0gdGhpcy5tYXhZKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWSAtIHRoaXMubWF4WSwgZGVsdGFZKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFZIDwgMCAmJiBhYWJiLm1heFkgPD0gdGhpcy5taW5ZKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WSAtIHRoaXMubWluWSwgZGVsdGFZKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFZOwogICAgfQogICAgY29tcHV0ZU9mZnNldFooYWFiYiwgZGVsdGFaKSB7CiAgICAgIGNvbnN0IGludGVyc2VjdGlvbiA9IHRoaXMuaW50ZXJzZWN0aW9uKGFhYmIpOwogICAgICBpZiAoaW50ZXJzZWN0aW9uLndpZHRoIDw9IDAgfHwgaW50ZXJzZWN0aW9uLmhlaWdodCA8PSAwKSB7CiAgICAgICAgcmV0dXJuIGRlbHRhWjsKICAgICAgfQogICAgICBpZiAoaW50ZXJzZWN0aW9uLmRlcHRoID49IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBpZiAoZGVsdGFaID4gMCAmJiBhYWJiLm1pblogPj0gdGhpcy5tYXhaKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWluKGFhYmIubWluWiAtIHRoaXMubWF4WiwgZGVsdGFaKTsKICAgICAgfQogICAgICBpZiAoZGVsdGFaIDwgMCAmJiBhYWJiLm1heFogPD0gdGhpcy5taW5aKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KGFhYmIubWF4WiAtIHRoaXMubWluWiwgZGVsdGFaKTsKICAgICAgfQogICAgICByZXR1cm4gZGVsdGFaOwogICAgfQogIH07CiAgdmFyIEFBQkIgPSBfQUFCQjsKICBBQUJCLnVuaW9uID0gKGFsbCkgPT4gewogICAgbGV0IG1pblggPSBhbGxbMF0ubWluWDsKICAgIGxldCBtaW5ZID0gYWxsWzBdLm1pblk7CiAgICBsZXQgbWluWiA9IGFsbFswXS5taW5aOwogICAgbGV0IG1heFggPSBhbGxbMF0ubWF4WDsKICAgIGxldCBtYXhZID0gYWxsWzBdLm1heFk7CiAgICBsZXQgbWF4WiA9IGFsbFswXS5tYXhaOwogICAgZm9yIChjb25zdCBhYWJiIG9mIGFsbCkgewogICAgICBtaW5YID0gTWF0aC5taW4obWluWCwgYWFiYi5taW5YKTsKICAgICAgbWluWSA9IE1hdGgubWluKG1pblksIGFhYmIubWluWSk7CiAgICAgIG1pblogPSBNYXRoLm1pbihtaW5aLCBhYWJiLm1pblopOwogICAgICBtYXhYID0gTWF0aC5tYXgobWF4WCwgYWFiYi5tYXhYKTsKICAgICAgbWF4WSA9IE1hdGgubWF4KG1heFksIGFhYmIubWF4WSk7CiAgICAgIG1heFogPSBNYXRoLm1heChtYXhaLCBhYWJiLm1heFopOwogICAgfQogICAgcmV0dXJuIG5ldyBfQUFCQihtaW5YLCBtaW5ZLCBtaW5aLCBtYXhYLCBtYXhZLCBtYXhaKTsKICB9OwogIHZhciBCbG9ja1J1bGVMb2dpYyA9IC8qIEBfX1BVUkVfXyAqLyAoKEJsb2NrUnVsZUxvZ2ljMikgPT4gewogICAgQmxvY2tSdWxlTG9naWMyWyJBbmQiXSA9ICJhbmQiOwogICAgQmxvY2tSdWxlTG9naWMyWyJPciJdID0gIm9yIjsKICAgIEJsb2NrUnVsZUxvZ2ljMlsiTm90Il0gPSAibm90IjsKICAgIHJldHVybiBCbG9ja1J1bGVMb2dpYzI7CiAgfSkoQmxvY2tSdWxlTG9naWMgfHwge30pOwogIGNvbnN0IFBZX1JPVEFUSU9OID0gMDsKICBjb25zdCBOWV9ST1RBVElPTiA9IDE7CiAgY29uc3QgUFhfUk9UQVRJT04gPSAyOwogIGNvbnN0IE5YX1JPVEFUSU9OID0gMzsKICBjb25zdCBQWl9ST1RBVElPTiA9IDQ7CiAgY29uc3QgTlpfUk9UQVRJT04gPSA1OwogIGNvbnN0IFlfUk9UX1NFR01FTlRTID0gMTY7CiAgY29uc3QgUEkgPSBNYXRoLlBJOwogIGNvbnN0IFBJXzIgPSBNYXRoLlBJIC8gMjsKICBjb25zdCBfQmxvY2tSb3RhdGlvbiA9IGNsYXNzIF9CbG9ja1JvdGF0aW9uIHsKICAgIC8qKgogICAgICogQ3JlYXRlIGEgbmV3IGJsb2NrIHJvdGF0aW9uLgogICAgICoKICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgYXhpcyB0aGlzIGJsb2NrIGlzIHBvaW50aW5nIHRvd2FyZHMuCiAgICAgKiBAcGFyYW0geVJvdGF0aW9uIFRoZSByb3RhdGlvbiBhcm91bmQgdGhlIGF4aXMgdGhpcyBibG9jayBpcyBwb2ludGluZyB0b3dhcmRzLCByb3VuZGVkIHRvIHRoZSBuZWFyZXN0ICgzNjAgLyAxNikgZGVncmVlcy4KICAgICAqLwogICAgY29uc3RydWN0b3IodmFsdWUgPSBQWV9ST1RBVElPTiwgeVJvdGF0aW9uID0gMCkgewogICAgICB0aGlzLnJvdGF0ZU5vZGUgPSAobm9kZSwgeVJvdGF0ZSA9IHRydWUsIHRyYW5zbGF0ZSA9IHRydWUpID0+IHsKICAgICAgICBpZiAoeVJvdGF0ZSAmJiB0aGlzLnlSb3RhdGlvbiAhPT0gMCkgewogICAgICAgICAgbm9kZVswXSAtPSAwLjU7CiAgICAgICAgICBub2RlWzJdIC09IDAuNTsKICAgICAgICAgIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVkobm9kZSwgdGhpcy55Um90YXRpb24pOwogICAgICAgICAgbm9kZVswXSArPSAwLjU7CiAgICAgICAgICBub2RlWzJdICs9IDAuNTsKICAgICAgICB9CiAgICAgICAgc3dpdGNoICh0aGlzLnZhbHVlKSB7CiAgICAgICAgICBjYXNlIFBYX1JPVEFUSU9OOiB7CiAgICAgICAgICAgIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVoobm9kZSwgLVBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzFdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBOWF9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVaKG5vZGUsIFBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzBdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBQWV9ST1RBVElPTjogewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgTllfUk9UQVRJT046IHsKICAgICAgICAgICAgX0Jsb2NrUm90YXRpb24ucm90YXRlWChub2RlLCBQSSk7CiAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIHsKICAgICAgICAgICAgICBub2RlWzFdICs9IDE7CiAgICAgICAgICAgICAgbm9kZVsyXSArPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBQWl9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVYKG5vZGUsIFBJXzIpOwogICAgICAgICAgICBpZiAodHJhbnNsYXRlKSBub2RlWzFdICs9IDE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgY2FzZSBOWl9ST1RBVElPTjogewogICAgICAgICAgICBfQmxvY2tSb3RhdGlvbi5yb3RhdGVYKG5vZGUsIC1QSV8yKTsKICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSkgbm9kZVsyXSArPSAxOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICAgIHRoaXMucm90YXRlQUFCQiA9IChhYWJiLCB5Um90YXRlID0gdHJ1ZSwgdHJhbnNsYXRlID0gdHJ1ZSkgPT4gewogICAgICAgIGNvbnN0IG1pbjIgPSBbYWFiYi5taW5YLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgY29uc3QgbWF4MiA9IFthYWJiLm1heFgsIGFhYmIubWF4WSwgYWFiYi5tYXhaXTsKICAgICAgICBsZXQgbWluWCA9IG51bGw7CiAgICAgICAgbGV0IG1pblogPSBudWxsOwogICAgICAgIGxldCBtYXhYID0gbnVsbDsKICAgICAgICBsZXQgbWF4WiA9IG51bGw7CiAgICAgICAgaWYgKHlSb3RhdGUgJiYgdGhpcy55Um90YXRpb24gIT09IDApIHsKICAgICAgICAgIGNvbnN0IG1pbjEgPSBbYWFiYi5taW5YLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgICBjb25zdCBtaW4yMiA9IFthYWJiLm1pblgsIGFhYmIubWluWSwgYWFiYi5tYXhaXTsKICAgICAgICAgIGNvbnN0IG1pbjMgPSBbYWFiYi5tYXhYLCBhYWJiLm1pblksIGFhYmIubWluWl07CiAgICAgICAgICBjb25zdCBtaW40ID0gW2FhYmIubWF4WCwgYWFiYi5taW5ZLCBhYWJiLm1heFpdOwogICAgICAgICAgW21pbjEsIG1pbjIyLCBtaW4zLCBtaW40XS5mb3JFYWNoKChtaW41KSA9PiB7CiAgICAgICAgICAgIHRoaXMucm90YXRlTm9kZShtaW41LCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgbWluWCA9IG1pblggPT09IG51bGwgPyBtaW41WzBdIDogTWF0aC5taW4obWluWCwgbWluNVswXSk7CiAgICAgICAgICAgIG1pblogPSBtaW5aID09PSBudWxsID8gbWluNVsyXSA6IE1hdGgubWluKG1pblosIG1pbjVbMl0pOwogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zdCBtYXgxID0gW2FhYmIubWluWCwgYWFiYi5tYXhZLCBhYWJiLm1pblpdOwogICAgICAgICAgY29uc3QgbWF4MjIgPSBbYWFiYi5taW5YLCBhYWJiLm1heFksIGFhYmIubWF4Wl07CiAgICAgICAgICBjb25zdCBtYXgzID0gW2FhYmIubWF4WCwgYWFiYi5tYXhZLCBhYWJiLm1pblpdOwogICAgICAgICAgY29uc3QgbWF4NCA9IFthYWJiLm1heFgsIGFhYmIubWF4WSwgYWFiYi5tYXhaXTsKICAgICAgICAgIFttYXgxLCBtYXgyMiwgbWF4MywgbWF4NF0uZm9yRWFjaCgobWF4NSkgPT4gewogICAgICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWF4NSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIG1heFggPSBtYXhYID09PSBudWxsID8gbWF4NVswXSA6IE1hdGgubWF4KG1heFgsIG1heDVbMF0pOwogICAgICAgICAgICBtYXhaID0gbWF4WiA9PT0gbnVsbCA/IG1heDVbMl0gOiBNYXRoLm1heChtYXhaLCBtYXg1WzJdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWluMiwgeVJvdGF0ZSwgdHJhbnNsYXRlKTsKICAgICAgICB0aGlzLnJvdGF0ZU5vZGUobWF4MiwgeVJvdGF0ZSwgdHJhbnNsYXRlKTsKICAgICAgICBjb25zdCBFUFNJTE9OMiA9IDFlLTQ7CiAgICAgICAgY29uc3QganVzdGlmeSA9IChudW0pID0+IG51bSA8IEVQU0lMT04yID8gMCA6IG51bTsKICAgICAgICBtaW4yWzBdID0ganVzdGlmeShtaW4yWzBdKTsKICAgICAgICBtaW4yWzFdID0ganVzdGlmeShtaW4yWzFdKTsKICAgICAgICBtaW4yWzJdID0ganVzdGlmeShtaW4yWzJdKTsKICAgICAgICBtYXgyWzBdID0ganVzdGlmeShtYXgyWzBdKTsKICAgICAgICBtYXgyWzFdID0ganVzdGlmeShtYXgyWzFdKTsKICAgICAgICBtYXgyWzJdID0ganVzdGlmeShtYXgyWzJdKTsKICAgICAgICBjb25zdCByZWFsTWluID0gWwogICAgICAgICAgbWluWCAhPT0gbnVsbCA/IGp1c3RpZnkobWluWCkgOiBNYXRoLm1pbihtaW4yWzBdLCBtYXgyWzBdKSwKICAgICAgICAgIE1hdGgubWluKG1pbjJbMV0sIG1heDJbMV0pLAogICAgICAgICAgbWluWiAhPT0gbnVsbCA/IGp1c3RpZnkobWluWikgOiBNYXRoLm1pbihtaW4yWzJdLCBtYXgyWzJdKQogICAgICAgIF07CiAgICAgICAgY29uc3QgcmVhbE1heCA9IFsKICAgICAgICAgIG1heFggIT09IG51bGwgPyBqdXN0aWZ5KG1heFgpIDogTWF0aC5tYXgobWluMlswXSwgbWF4MlswXSksCiAgICAgICAgICBNYXRoLm1heChtaW4yWzFdLCBtYXgyWzFdKSwKICAgICAgICAgIG1heFogIT09IG51bGwgPyBqdXN0aWZ5KG1heFopIDogTWF0aC5tYXgobWluMlsyXSwgbWF4MlsyXSkKICAgICAgICBdOwogICAgICAgIHJldHVybiBuZXcgQUFCQigKICAgICAgICAgIHJlYWxNaW5bMF0sCiAgICAgICAgICByZWFsTWluWzFdLAogICAgICAgICAgcmVhbE1pblsyXSwKICAgICAgICAgIHJlYWxNYXhbMF0sCiAgICAgICAgICByZWFsTWF4WzFdLAogICAgICAgICAgcmVhbE1heFsyXQogICAgICAgICk7CiAgICAgIH07CiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICAgICAgdGhpcy55Um90YXRpb24gPSB5Um90YXRpb247CiAgICB9CiAgICByb3RhdGVUcmFuc3BhcmVuY3koW3B4LCBweSwgcHosIG54LCBueSwgbnpdKSB7CiAgICAgIGNvbnN0IHJvdCA9IHRoaXMudmFsdWU7CiAgICAgIGlmIChNYXRoLmFicyhyb3QpIDwgTnVtYmVyLkVQU0lMT04pIHsKICAgICAgICByZXR1cm4gW3B4LCBweSwgcHosIG54LCBueSwgbnpdOwogICAgICB9CiAgICAgIGNvbnN0IHBvc2l0aXZlID0gWzEsIDIsIDNdOwogICAgICBjb25zdCBuZWdhdGl2ZSA9IFs0LCA1LCA2XTsKICAgICAgdGhpcy5yb3RhdGVOb2RlKHBvc2l0aXZlLCB0cnVlLCBmYWxzZSk7CiAgICAgIHRoaXMucm90YXRlTm9kZShuZWdhdGl2ZSwgdHJ1ZSwgZmFsc2UpOwogICAgICBjb25zdCBwID0gcG9zaXRpdmUubWFwKChuMikgPT4gewogICAgICAgIGlmIChuMiA9PT0gMSkgcmV0dXJuIHB4OwogICAgICAgIGlmIChuMiA9PT0gMikgcmV0dXJuIHB5OwogICAgICAgIGlmIChuMiA9PT0gMykgcmV0dXJuIHB6OwogICAgICAgIGlmIChuMiA9PT0gNCkgcmV0dXJuIG54OwogICAgICAgIGlmIChuMiA9PT0gNSkgcmV0dXJuIG55OwogICAgICAgIHJldHVybiBuejsKICAgICAgfSk7CiAgICAgIGNvbnN0IG4gPSBuZWdhdGl2ZS5tYXAoKG4yKSA9PiB7CiAgICAgICAgaWYgKG4yID09PSAxKSByZXR1cm4gcHg7CiAgICAgICAgaWYgKG4yID09PSAyKSByZXR1cm4gcHk7CiAgICAgICAgaWYgKG4yID09PSAzKSByZXR1cm4gcHo7CiAgICAgICAgaWYgKG4yID09PSA0KSByZXR1cm4gbng7CiAgICAgICAgaWYgKG4yID09PSA1KSByZXR1cm4gbnk7CiAgICAgICAgcmV0dXJuIG56OwogICAgICB9KTsKICAgICAgcmV0dXJuIFtwWzBdLCBwWzFdLCBwWzJdLCBuWzBdLCBuWzFdLCBuWzJdXTsKICAgIH0KICB9OwogIF9CbG9ja1JvdGF0aW9uLmVuY29kZSA9ICh2YWx1ZSwgeVJvdGF0aW9uID0gMCkgPT4gewogICAgY29uc3QgeUVuY29kZWQgPSB5Um90YXRpb24gKiBNYXRoLlBJICogMiAvIFlfUk9UX1NFR01FTlRTOwogICAgcmV0dXJuIG5ldyBfQmxvY2tSb3RhdGlvbih2YWx1ZSwgeUVuY29kZWQpOwogIH07CiAgX0Jsb2NrUm90YXRpb24uZGVjb2RlID0gKHJvdGF0aW9uKSA9PiB7CiAgICBjb25zdCB2YWx1ZSA9IHJvdGF0aW9uLnZhbHVlOwogICAgY29uc3QgeURlY29kZWQgPSBNYXRoLnJvdW5kKHJvdGF0aW9uLnlSb3RhdGlvbiAqIFlfUk9UX1NFR01FTlRTIC8gKE1hdGguUEkgKiAyKSkgJSBZX1JPVF9TRUdNRU5UUzsKICAgIHJldHVybiBbdmFsdWUsIHlEZWNvZGVkXTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVggPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbLCB5LCB6XSA9IG5vZGU7CiAgICBub2RlWzFdID0geSAqIGNvc1RoZXRhIC0geiAqIHNpblRoZXRhOwogICAgbm9kZVsyXSA9IHogKiBjb3NUaGV0YSArIHkgKiBzaW5UaGV0YTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVkgPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbeCwgLCB6XSA9IG5vZGU7CiAgICBub2RlWzBdID0geCAqIGNvc1RoZXRhICsgeiAqIHNpblRoZXRhOwogICAgbm9kZVsyXSA9IHogKiBjb3NUaGV0YSAtIHggKiBzaW5UaGV0YTsKICB9OwogIF9CbG9ja1JvdGF0aW9uLnJvdGF0ZVogPSAobm9kZSwgdGhldGEpID0+IHsKICAgIGNvbnN0IHNpblRoZXRhID0gTWF0aC5zaW4odGhldGEpOwogICAgY29uc3QgY29zVGhldGEgPSBNYXRoLmNvcyh0aGV0YSk7CiAgICBjb25zdCBbeCwgeV0gPSBub2RlOwogICAgbm9kZVswXSA9IHggKiBjb3NUaGV0YSAtIHkgKiBzaW5UaGV0YTsKICAgIG5vZGVbMV0gPSB5ICogY29zVGhldGEgKyB4ICogc2luVGhldGE7CiAgfTsKICBsZXQgQmxvY2tSb3RhdGlvbiA9IF9CbG9ja1JvdGF0aW9uOwogIGNvbnN0IFJPVEFUSU9OX01BU0sgPSA0MjkzOTg0MjU1OwogIGNvbnN0IFlfUk9UQVRJT05fTUFTSyA9IDQyNzkyMzg2NTU7CiAgY29uc3QgU1RBR0VfTUFTSyA9IDQwNDMzMDkwNTU7CiAgY29uc3QgX0Jsb2NrVXRpbHMgPSBjbGFzcyBfQmxvY2tVdGlscyB7CiAgICBzdGF0aWMgZ2V0QmxvY2tSb3RhdGVkVHJhbnNwYXJlbmN5KGJsb2NrLCByb3RhdGlvbikgewogICAgICByZXR1cm4gcm90YXRpb24ucm90YXRlVHJhbnNwYXJlbmN5KGJsb2NrLmlzVHJhbnNwYXJlbnQpOwogICAgfQogICAgc3RhdGljIGdldEJsb2NrRW50aXR5SWQoaWQsIHZveGVsKSB7CiAgICAgIGNvbnN0IFt2eCwgdnksIHZ6XSA9IHZveGVsOwogICAgICByZXR1cm4gYGJsb2NrOjoke2lkfTo6JHt2eH06OiR7dnl9Ojoke3Z6fWA7CiAgICB9CiAgICBjb25zdHJ1Y3RvcigpIHsKICAgIH0KICB9OwogIF9CbG9ja1V0aWxzLmV4dHJhY3RJRCA9ICh2b3hlbCkgPT4gewogICAgcmV0dXJuIHZveGVsICYgNjU1MzU7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRJRCA9ICh2b3hlbCwgaWQpID0+IHsKICAgIHJldHVybiB2b3hlbCAmIDQyOTQ5MDE3NjAgfCBpZCAmIDY1NTM1OwogIH07CiAgX0Jsb2NrVXRpbHMuZXh0cmFjdFJvdGF0aW9uID0gKHZveGVsKSA9PiB7CiAgICBjb25zdCByb3RhdGlvbiA9IHZveGVsID4+IDE2ICYgMTU7CiAgICBjb25zdCB5Um90ID0gdm94ZWwgPj4gMjAgJiAxNTsKICAgIHJldHVybiBCbG9ja1JvdGF0aW9uLmVuY29kZShyb3RhdGlvbiwgeVJvdCk7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbiA9ICh2b3hlbCwgcm90YXRpb24pID0+IHsKICAgIGNvbnN0IFtyb3QsIHlSb3RdID0gQmxvY2tSb3RhdGlvbi5kZWNvZGUocm90YXRpb24pOwogICAgY29uc3QgdmFsdWUgPSB2b3hlbCAmIFJPVEFUSU9OX01BU0sgfCAocm90ICYgMTUpIDw8IDE2OwogICAgcmV0dXJuIHZhbHVlICYgWV9ST1RBVElPTl9NQVNLIHwgKHlSb3QgJiAxNSkgPDwgMjA7CiAgfTsKICBfQmxvY2tVdGlscy5leHRyYWN0U3RhZ2UgPSAodm94ZWwpID0+IHsKICAgIHJldHVybiB2b3hlbCA+PiAyNCAmIDE1OwogIH07CiAgX0Jsb2NrVXRpbHMuaW5zZXJ0U3RhZ2UgPSAodm94ZWwsIHN0YWdlKSA9PiB7CiAgICByZXR1cm4gdm94ZWwgJiBTVEFHRV9NQVNLIHwgc3RhZ2UgPDwgMjQ7CiAgfTsKICBfQmxvY2tVdGlscy5pbnNlcnRBbGwgPSAoaWQsIHJvdGF0aW9uLCBzdGFnZSkgPT4gewogICAgbGV0IHZhbHVlID0gMDsKICAgIHZhbHVlID0gX0Jsb2NrVXRpbHMuaW5zZXJ0SUQodmFsdWUsIGlkKTsKICAgIGlmIChyb3RhdGlvbikgdmFsdWUgPSBfQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbih2YWx1ZSwgcm90YXRpb24pOwogICAgaWYgKHN0YWdlICE9PSB2b2lkIDApIHZhbHVlID0gX0Jsb2NrVXRpbHMuaW5zZXJ0U3RhZ2UodmFsdWUsIHN0YWdlKTsKICAgIHJldHVybiB2YWx1ZTsKICB9OwogIF9CbG9ja1V0aWxzLmdldEJsb2NrVG9yY2hMaWdodExldmVsID0gKGJsb2NrLCBjb2xvcikgPT4gewogICAgc3dpdGNoIChjb2xvcikgewogICAgICBjYXNlICJSRUQiOgogICAgICAgIHJldHVybiBibG9jay5yZWRMaWdodExldmVsOwogICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgcmV0dXJuIGJsb2NrLmdyZWVuTGlnaHRMZXZlbDsKICAgICAgY2FzZSAiQkxVRSI6CiAgICAgICAgcmV0dXJuIGJsb2NrLmJsdWVMaWdodExldmVsOwogICAgfQogICAgcmV0dXJuIDA7CiAgfTsKICBfQmxvY2tVdGlscy5ldmFsdWF0ZUJsb2NrUnVsZSA9IChydWxlLCB2b3hlbCwgZnVuY3Rpb25zKSA9PiB7CiAgICBpZiAocnVsZS50eXBlID09PSAibm9uZSIpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAocnVsZS50eXBlID09PSAic2ltcGxlIikgewogICAgICBjb25zdCB7IG9mZnNldCwgaWQsIHJvdGF0aW9uLCBzdGFnZSB9ID0gcnVsZTsKICAgICAgY29uc3QgW3Z4LCB2eSwgdnpdID0gdm94ZWw7CiAgICAgIGNvbnN0IG94ID0gb2Zmc2V0WzBdICsgdng7CiAgICAgIGNvbnN0IG95ID0gb2Zmc2V0WzFdICsgdnk7CiAgICAgIGNvbnN0IG96ID0gb2Zmc2V0WzJdICsgdno7CiAgICAgIGlmIChpZCAhPT0gbnVsbCkgewogICAgICAgIGNvbnN0IHZveGVsSWQgPSBmdW5jdGlvbnMuZ2V0Vm94ZWxBdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxJZCAhPT0gaWQpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAocm90YXRpb24gIT09IG51bGwpIHsKICAgICAgICBjb25zdCB2b3hlbFJvdGF0aW9uID0gZnVuY3Rpb25zLmdldFZveGVsUm90YXRpb25BdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxSb3RhdGlvbi52YWx1ZSAhPT0gcm90YXRpb24udmFsdWUgfHwgdm94ZWxSb3RhdGlvbi55Um90YXRpb24gIT09IHJvdGF0aW9uLnlSb3RhdGlvbikKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAoc3RhZ2UgIT09IG51bGwpIHsKICAgICAgICBjb25zdCB2b3hlbFN0YWdlID0gZnVuY3Rpb25zLmdldFZveGVsU3RhZ2VBdChveCwgb3ksIG96KTsKICAgICAgICBpZiAodm94ZWxTdGFnZSAhPT0gc3RhZ2UpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChydWxlLnR5cGUgPT09ICJjb21iaW5hdGlvbiIpIHsKICAgICAgY29uc3QgeyBsb2dpYywgcnVsZXMgfSA9IHJ1bGU7CiAgICAgIHN3aXRjaCAobG9naWMpIHsKICAgICAgICBjYXNlIEJsb2NrUnVsZUxvZ2ljLkFuZDoKICAgICAgICAgIHJldHVybiBydWxlcy5ldmVyeSgKICAgICAgICAgICAgKHN1YlJ1bGUpID0+IF9CbG9ja1V0aWxzLmV2YWx1YXRlQmxvY2tSdWxlKHN1YlJ1bGUsIHZveGVsLCBmdW5jdGlvbnMpCiAgICAgICAgICApOwogICAgICAgIGNhc2UgQmxvY2tSdWxlTG9naWMuT3I6CiAgICAgICAgICByZXR1cm4gcnVsZXMuc29tZSgKICAgICAgICAgICAgKHN1YlJ1bGUpID0+IF9CbG9ja1V0aWxzLmV2YWx1YXRlQmxvY2tSdWxlKHN1YlJ1bGUsIHZveGVsLCBmdW5jdGlvbnMpCiAgICAgICAgICApOwogICAgICAgIGNhc2UgQmxvY2tSdWxlTG9naWMuTm90OgogICAgICAgICAgcmV0dXJuICFydWxlcy5zb21lKAogICAgICAgICAgICAoc3ViUnVsZSkgPT4gX0Jsb2NrVXRpbHMuZXZhbHVhdGVCbG9ja1J1bGUoc3ViUnVsZSwgdm94ZWwsIGZ1bmN0aW9ucykKICAgICAgICAgICk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07CiAgbGV0IEJsb2NrVXRpbHMgPSBfQmxvY2tVdGlsczsKICBmdW5jdGlvbiBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyh4KSB7CiAgICByZXR1cm4geCAmJiB4Ll9fZXNNb2R1bGUgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHgsICJkZWZhdWx0IikgPyB4WyJkZWZhdWx0Il0gOiB4OwogIH0KICB2YXIgZXBzaWxvbiA9IDFlLTY7CiAgdmFyIGNyZWF0ZV8xID0gY3JlYXRlOwogIGZ1bmN0aW9uIGNyZWF0ZSgpIHsKICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgb3V0WzBdID0gMDsKICAgIG91dFsxXSA9IDA7CiAgICBvdXRbMl0gPSAwOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGNsb25lXzEgPSBjbG9uZTsKICBmdW5jdGlvbiBjbG9uZShhKSB7CiAgICB2YXIgb3V0ID0gbmV3IEZsb2F0MzJBcnJheSgzKTsKICAgIG91dFswXSA9IGFbMF07CiAgICBvdXRbMV0gPSBhWzFdOwogICAgb3V0WzJdID0gYVsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBmcm9tVmFsdWVzXzEgPSBmcm9tVmFsdWVzJDE7CiAgZnVuY3Rpb24gZnJvbVZhbHVlcyQxKHgsIHksIHopIHsKICAgIHZhciBvdXQgPSBuZXcgRmxvYXQzMkFycmF5KDMpOwogICAgb3V0WzBdID0geDsKICAgIG91dFsxXSA9IHk7CiAgICBvdXRbMl0gPSB6OwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIG5vcm1hbGl6ZV8xID0gbm9ybWFsaXplJDE7CiAgZnVuY3Rpb24gbm9ybWFsaXplJDEob3V0LCBhKSB7CiAgICB2YXIgeCA9IGFbMF0sIHkgPSBhWzFdLCB6ID0gYVsyXTsKICAgIHZhciBsZW4yID0geCAqIHggKyB5ICogeSArIHogKiB6OwogICAgaWYgKGxlbjIgPiAwKSB7CiAgICAgIGxlbjIgPSAxIC8gTWF0aC5zcXJ0KGxlbjIpOwogICAgICBvdXRbMF0gPSBhWzBdICogbGVuMjsKICAgICAgb3V0WzFdID0gYVsxXSAqIGxlbjI7CiAgICAgIG91dFsyXSA9IGFbMl0gKiBsZW4yOwogICAgfQogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGRvdF8xID0gZG90JDE7CiAgZnVuY3Rpb24gZG90JDEoYSwgYikgewogICAgcmV0dXJuIGFbMF0gKiBiWzBdICsgYVsxXSAqIGJbMV0gKyBhWzJdICogYlsyXTsKICB9CiAgdmFyIGFuZ2xlXzEgPSBhbmdsZTsKICB2YXIgZnJvbVZhbHVlcyA9IGZyb21WYWx1ZXNfMTsKICB2YXIgbm9ybWFsaXplID0gbm9ybWFsaXplXzE7CiAgdmFyIGRvdCA9IGRvdF8xOwogIGZ1bmN0aW9uIGFuZ2xlKGEsIGIpIHsKICAgIHZhciB0ZW1wQSA9IGZyb21WYWx1ZXMoYVswXSwgYVsxXSwgYVsyXSk7CiAgICB2YXIgdGVtcEIgPSBmcm9tVmFsdWVzKGJbMF0sIGJbMV0sIGJbMl0pOwogICAgbm9ybWFsaXplKHRlbXBBLCB0ZW1wQSk7CiAgICBub3JtYWxpemUodGVtcEIsIHRlbXBCKTsKICAgIHZhciBjb3NpbmUgPSBkb3QodGVtcEEsIHRlbXBCKTsKICAgIGlmIChjb3NpbmUgPiAxKSB7CiAgICAgIHJldHVybiAwOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIE1hdGguYWNvcyhjb3NpbmUpOwogICAgfQogIH0KICB2YXIgY29weV8xID0gY29weTsKICBmdW5jdGlvbiBjb3B5KG91dCwgYSkgewogICAgb3V0WzBdID0gYVswXTsKICAgIG91dFsxXSA9IGFbMV07CiAgICBvdXRbMl0gPSBhWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHNldF8xID0gc2V0OwogIGZ1bmN0aW9uIHNldChvdXQsIHgsIHksIHopIHsKICAgIG91dFswXSA9IHg7CiAgICBvdXRbMV0gPSB5OwogICAgb3V0WzJdID0gejsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBlcXVhbHNfMSA9IGVxdWFsczsKICB2YXIgRVBTSUxPTiA9IGVwc2lsb247CiAgZnVuY3Rpb24gZXF1YWxzKGEsIGIpIHsKICAgIHZhciBhMCA9IGFbMF07CiAgICB2YXIgYTEgPSBhWzFdOwogICAgdmFyIGEyID0gYVsyXTsKICAgIHZhciBiMCA9IGJbMF07CiAgICB2YXIgYjEgPSBiWzFdOwogICAgdmFyIGIyID0gYlsyXTsKICAgIHJldHVybiBNYXRoLmFicyhhMCAtIGIwKSA8PSBFUFNJTE9OICogTWF0aC5tYXgoMSwgTWF0aC5hYnMoYTApLCBNYXRoLmFicyhiMCkpICYmIE1hdGguYWJzKGExIC0gYjEpIDw9IEVQU0lMT04gKiBNYXRoLm1heCgxLCBNYXRoLmFicyhhMSksIE1hdGguYWJzKGIxKSkgJiYgTWF0aC5hYnMoYTIgLSBiMikgPD0gRVBTSUxPTiAqIE1hdGgubWF4KDEsIE1hdGguYWJzKGEyKSwgTWF0aC5hYnMoYjIpKTsKICB9CiAgdmFyIGV4YWN0RXF1YWxzXzEgPSBleGFjdEVxdWFsczsKICBmdW5jdGlvbiBleGFjdEVxdWFscyhhLCBiKSB7CiAgICByZXR1cm4gYVswXSA9PT0gYlswXSAmJiBhWzFdID09PSBiWzFdICYmIGFbMl0gPT09IGJbMl07CiAgfQogIHZhciBhZGRfMSA9IGFkZDsKICBmdW5jdGlvbiBhZGQob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBhWzBdICsgYlswXTsKICAgIG91dFsxXSA9IGFbMV0gKyBiWzFdOwogICAgb3V0WzJdID0gYVsyXSArIGJbMl07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgc3VidHJhY3RfMSA9IHN1YnRyYWN0OwogIGZ1bmN0aW9uIHN1YnRyYWN0KG91dCwgYSwgYikgewogICAgb3V0WzBdID0gYVswXSAtIGJbMF07CiAgICBvdXRbMV0gPSBhWzFdIC0gYlsxXTsKICAgIG91dFsyXSA9IGFbMl0gLSBiWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHN1YiA9IHN1YnRyYWN0XzE7CiAgdmFyIG11bHRpcGx5XzEgPSBtdWx0aXBseTsKICBmdW5jdGlvbiBtdWx0aXBseShvdXQsIGEsIGIpIHsKICAgIG91dFswXSA9IGFbMF0gKiBiWzBdOwogICAgb3V0WzFdID0gYVsxXSAqIGJbMV07CiAgICBvdXRbMl0gPSBhWzJdICogYlsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBtdWwgPSBtdWx0aXBseV8xOwogIHZhciBkaXZpZGVfMSA9IGRpdmlkZTsKICBmdW5jdGlvbiBkaXZpZGUob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBhWzBdIC8gYlswXTsKICAgIG91dFsxXSA9IGFbMV0gLyBiWzFdOwogICAgb3V0WzJdID0gYVsyXSAvIGJbMl07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgZGl2ID0gZGl2aWRlXzE7CiAgdmFyIG1pbl8xID0gbWluOwogIGZ1bmN0aW9uIG1pbihvdXQsIGEsIGIpIHsKICAgIG91dFswXSA9IE1hdGgubWluKGFbMF0sIGJbMF0pOwogICAgb3V0WzFdID0gTWF0aC5taW4oYVsxXSwgYlsxXSk7CiAgICBvdXRbMl0gPSBNYXRoLm1pbihhWzJdLCBiWzJdKTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBtYXhfMSA9IG1heDsKICBmdW5jdGlvbiBtYXgob3V0LCBhLCBiKSB7CiAgICBvdXRbMF0gPSBNYXRoLm1heChhWzBdLCBiWzBdKTsKICAgIG91dFsxXSA9IE1hdGgubWF4KGFbMV0sIGJbMV0pOwogICAgb3V0WzJdID0gTWF0aC5tYXgoYVsyXSwgYlsyXSk7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgZmxvb3JfMSA9IGZsb29yOwogIGZ1bmN0aW9uIGZsb29yKG91dCwgYSkgewogICAgb3V0WzBdID0gTWF0aC5mbG9vcihhWzBdKTsKICAgIG91dFsxXSA9IE1hdGguZmxvb3IoYVsxXSk7CiAgICBvdXRbMl0gPSBNYXRoLmZsb29yKGFbMl0pOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGNlaWxfMSA9IGNlaWw7CiAgZnVuY3Rpb24gY2VpbChvdXQsIGEpIHsKICAgIG91dFswXSA9IE1hdGguY2VpbChhWzBdKTsKICAgIG91dFsxXSA9IE1hdGguY2VpbChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGguY2VpbChhWzJdKTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByb3VuZF8xID0gcm91bmQ7CiAgZnVuY3Rpb24gcm91bmQob3V0LCBhKSB7CiAgICBvdXRbMF0gPSBNYXRoLnJvdW5kKGFbMF0pOwogICAgb3V0WzFdID0gTWF0aC5yb3VuZChhWzFdKTsKICAgIG91dFsyXSA9IE1hdGgucm91bmQoYVsyXSk7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgc2NhbGVfMSA9IHNjYWxlOwogIGZ1bmN0aW9uIHNjYWxlKG91dCwgYSwgYikgewogICAgb3V0WzBdID0gYVswXSAqIGI7CiAgICBvdXRbMV0gPSBhWzFdICogYjsKICAgIG91dFsyXSA9IGFbMl0gKiBiOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHNjYWxlQW5kQWRkXzEgPSBzY2FsZUFuZEFkZDsKICBmdW5jdGlvbiBzY2FsZUFuZEFkZChvdXQsIGEsIGIsIHNjYWxlMikgewogICAgb3V0WzBdID0gYVswXSArIGJbMF0gKiBzY2FsZTI7CiAgICBvdXRbMV0gPSBhWzFdICsgYlsxXSAqIHNjYWxlMjsKICAgIG91dFsyXSA9IGFbMl0gKyBiWzJdICogc2NhbGUyOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGRpc3RhbmNlXzEgPSBkaXN0YW5jZTsKICBmdW5jdGlvbiBkaXN0YW5jZShhLCBiKSB7CiAgICB2YXIgeCA9IGJbMF0gLSBhWzBdLCB5ID0gYlsxXSAtIGFbMV0sIHogPSBiWzJdIC0gYVsyXTsKICAgIHJldHVybiBNYXRoLnNxcnQoeCAqIHggKyB5ICogeSArIHogKiB6KTsKICB9CiAgdmFyIGRpc3QgPSBkaXN0YW5jZV8xOwogIHZhciBzcXVhcmVkRGlzdGFuY2VfMSA9IHNxdWFyZWREaXN0YW5jZTsKICBmdW5jdGlvbiBzcXVhcmVkRGlzdGFuY2UoYSwgYikgewogICAgdmFyIHggPSBiWzBdIC0gYVswXSwgeSA9IGJbMV0gLSBhWzFdLCB6ID0gYlsyXSAtIGFbMl07CiAgICByZXR1cm4geCAqIHggKyB5ICogeSArIHogKiB6OwogIH0KICB2YXIgc3FyRGlzdCA9IHNxdWFyZWREaXN0YW5jZV8xOwogIHZhciBsZW5ndGhfMSA9IGxlbmd0aDsKICBmdW5jdGlvbiBsZW5ndGgoYSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl07CiAgICByZXR1cm4gTWF0aC5zcXJ0KHggKiB4ICsgeSAqIHkgKyB6ICogeik7CiAgfQogIHZhciBsZW4gPSBsZW5ndGhfMTsKICB2YXIgc3F1YXJlZExlbmd0aF8xID0gc3F1YXJlZExlbmd0aDsKICBmdW5jdGlvbiBzcXVhcmVkTGVuZ3RoKGEpIHsKICAgIHZhciB4ID0gYVswXSwgeSA9IGFbMV0sIHogPSBhWzJdOwogICAgcmV0dXJuIHggKiB4ICsgeSAqIHkgKyB6ICogejsKICB9CiAgdmFyIHNxckxlbiA9IHNxdWFyZWRMZW5ndGhfMTsKICB2YXIgbmVnYXRlXzEgPSBuZWdhdGU7CiAgZnVuY3Rpb24gbmVnYXRlKG91dCwgYSkgewogICAgb3V0WzBdID0gLWFbMF07CiAgICBvdXRbMV0gPSAtYVsxXTsKICAgIG91dFsyXSA9IC1hWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGludmVyc2VfMSA9IGludmVyc2U7CiAgZnVuY3Rpb24gaW52ZXJzZShvdXQsIGEpIHsKICAgIG91dFswXSA9IDEgLyBhWzBdOwogICAgb3V0WzFdID0gMSAvIGFbMV07CiAgICBvdXRbMl0gPSAxIC8gYVsyXTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBjcm9zc18xID0gY3Jvc3M7CiAgZnVuY3Rpb24gY3Jvc3Mob3V0LCBhLCBiKSB7CiAgICB2YXIgYXggPSBhWzBdLCBheSA9IGFbMV0sIGF6ID0gYVsyXSwgYnggPSBiWzBdLCBieSA9IGJbMV0sIGJ6ID0gYlsyXTsKICAgIG91dFswXSA9IGF5ICogYnogLSBheiAqIGJ5OwogICAgb3V0WzFdID0gYXogKiBieCAtIGF4ICogYno7CiAgICBvdXRbMl0gPSBheCAqIGJ5IC0gYXkgKiBieDsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciBsZXJwXzEgPSBsZXJwOwogIGZ1bmN0aW9uIGxlcnAob3V0LCBhLCBiLCB0KSB7CiAgICB2YXIgYXggPSBhWzBdLCBheSA9IGFbMV0sIGF6ID0gYVsyXTsKICAgIG91dFswXSA9IGF4ICsgdCAqIChiWzBdIC0gYXgpOwogICAgb3V0WzFdID0gYXkgKyB0ICogKGJbMV0gLSBheSk7CiAgICBvdXRbMl0gPSBheiArIHQgKiAoYlsyXSAtIGF6KTsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByYW5kb21fMSA9IHJhbmRvbTsKICBmdW5jdGlvbiByYW5kb20ob3V0LCBzY2FsZTIpIHsKICAgIHNjYWxlMiA9IHNjYWxlMiB8fCAxOwogICAgdmFyIHIgPSBNYXRoLnJhbmRvbSgpICogMiAqIE1hdGguUEk7CiAgICB2YXIgeiA9IE1hdGgucmFuZG9tKCkgKiAyIC0gMTsKICAgIHZhciB6U2NhbGUgPSBNYXRoLnNxcnQoMSAtIHogKiB6KSAqIHNjYWxlMjsKICAgIG91dFswXSA9IE1hdGguY29zKHIpICogelNjYWxlOwogICAgb3V0WzFdID0gTWF0aC5zaW4ocikgKiB6U2NhbGU7CiAgICBvdXRbMl0gPSB6ICogc2NhbGUyOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHRyYW5zZm9ybU1hdDRfMSA9IHRyYW5zZm9ybU1hdDQ7CiAgZnVuY3Rpb24gdHJhbnNmb3JtTWF0NChvdXQsIGEsIG0pIHsKICAgIHZhciB4ID0gYVswXSwgeSA9IGFbMV0sIHogPSBhWzJdLCB3ID0gbVszXSAqIHggKyBtWzddICogeSArIG1bMTFdICogeiArIG1bMTVdOwogICAgdyA9IHcgfHwgMTsKICAgIG91dFswXSA9IChtWzBdICogeCArIG1bNF0gKiB5ICsgbVs4XSAqIHogKyBtWzEyXSkgLyB3OwogICAgb3V0WzFdID0gKG1bMV0gKiB4ICsgbVs1XSAqIHkgKyBtWzldICogeiArIG1bMTNdKSAvIHc7CiAgICBvdXRbMl0gPSAobVsyXSAqIHggKyBtWzZdICogeSArIG1bMTBdICogeiArIG1bMTRdKSAvIHc7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgdHJhbnNmb3JtTWF0M18xID0gdHJhbnNmb3JtTWF0MzsKICBmdW5jdGlvbiB0cmFuc2Zvcm1NYXQzKG91dCwgYSwgbSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl07CiAgICBvdXRbMF0gPSB4ICogbVswXSArIHkgKiBtWzNdICsgeiAqIG1bNl07CiAgICBvdXRbMV0gPSB4ICogbVsxXSArIHkgKiBtWzRdICsgeiAqIG1bN107CiAgICBvdXRbMl0gPSB4ICogbVsyXSArIHkgKiBtWzVdICsgeiAqIG1bOF07CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgdHJhbnNmb3JtUXVhdF8xID0gdHJhbnNmb3JtUXVhdDsKICBmdW5jdGlvbiB0cmFuc2Zvcm1RdWF0KG91dCwgYSwgcSkgewogICAgdmFyIHggPSBhWzBdLCB5ID0gYVsxXSwgeiA9IGFbMl0sIHF4ID0gcVswXSwgcXkgPSBxWzFdLCBxeiA9IHFbMl0sIHF3ID0gcVszXSwgaXggPSBxdyAqIHggKyBxeSAqIHogLSBxeiAqIHksIGl5ID0gcXcgKiB5ICsgcXogKiB4IC0gcXggKiB6LCBpeiA9IHF3ICogeiArIHF4ICogeSAtIHF5ICogeCwgaXcgPSAtcXggKiB4IC0gcXkgKiB5IC0gcXogKiB6OwogICAgb3V0WzBdID0gaXggKiBxdyArIGl3ICogLXF4ICsgaXkgKiAtcXogLSBpeiAqIC1xeTsKICAgIG91dFsxXSA9IGl5ICogcXcgKyBpdyAqIC1xeSArIGl6ICogLXF4IC0gaXggKiAtcXo7CiAgICBvdXRbMl0gPSBpeiAqIHF3ICsgaXcgKiAtcXogKyBpeCAqIC1xeSAtIGl5ICogLXF4OwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIHJvdGF0ZVhfMSA9IHJvdGF0ZVg7CiAgZnVuY3Rpb24gcm90YXRlWChvdXQsIGEsIGIsIGMpIHsKICAgIHZhciBieSA9IGJbMV07CiAgICB2YXIgYnogPSBiWzJdOwogICAgdmFyIHB5ID0gYVsxXSAtIGJ5OwogICAgdmFyIHB6ID0gYVsyXSAtIGJ6OwogICAgdmFyIHNjID0gTWF0aC5zaW4oYyk7CiAgICB2YXIgY2MgPSBNYXRoLmNvcyhjKTsKICAgIG91dFswXSA9IGFbMF07CiAgICBvdXRbMV0gPSBieSArIHB5ICogY2MgLSBweiAqIHNjOwogICAgb3V0WzJdID0gYnogKyBweSAqIHNjICsgcHogKiBjYzsKICAgIHJldHVybiBvdXQ7CiAgfQogIHZhciByb3RhdGVZXzEgPSByb3RhdGVZOwogIGZ1bmN0aW9uIHJvdGF0ZVkob3V0LCBhLCBiLCBjKSB7CiAgICB2YXIgYnggPSBiWzBdOwogICAgdmFyIGJ6ID0gYlsyXTsKICAgIHZhciBweCA9IGFbMF0gLSBieDsKICAgIHZhciBweiA9IGFbMl0gLSBiejsKICAgIHZhciBzYyA9IE1hdGguc2luKGMpOwogICAgdmFyIGNjID0gTWF0aC5jb3MoYyk7CiAgICBvdXRbMF0gPSBieCArIHB6ICogc2MgKyBweCAqIGNjOwogICAgb3V0WzFdID0gYVsxXTsKICAgIG91dFsyXSA9IGJ6ICsgcHogKiBjYyAtIHB4ICogc2M7CiAgICByZXR1cm4gb3V0OwogIH0KICB2YXIgcm90YXRlWl8xID0gcm90YXRlWjsKICBmdW5jdGlvbiByb3RhdGVaKG91dCwgYSwgYiwgYykgewogICAgdmFyIGJ4ID0gYlswXTsKICAgIHZhciBieSA9IGJbMV07CiAgICB2YXIgcHggPSBhWzBdIC0gYng7CiAgICB2YXIgcHkgPSBhWzFdIC0gYnk7CiAgICB2YXIgc2MgPSBNYXRoLnNpbihjKTsKICAgIHZhciBjYyA9IE1hdGguY29zKGMpOwogICAgb3V0WzBdID0gYnggKyBweCAqIGNjIC0gcHkgKiBzYzsKICAgIG91dFsxXSA9IGJ5ICsgcHggKiBzYyArIHB5ICogY2M7CiAgICBvdXRbMl0gPSBhWzJdOwogICAgcmV0dXJuIG91dDsKICB9CiAgdmFyIGZvckVhY2hfMSA9IGZvckVhY2g7CiAgdmFyIHZlYyA9IGNyZWF0ZV8xKCk7CiAgZnVuY3Rpb24gZm9yRWFjaChhLCBzdHJpZGUsIG9mZnNldCwgY291bnQsIGZuLCBhcmcpIHsKICAgIHZhciBpLCBsOwogICAgaWYgKCFzdHJpZGUpIHsKICAgICAgc3RyaWRlID0gMzsKICAgIH0KICAgIGlmICghb2Zmc2V0KSB7CiAgICAgIG9mZnNldCA9IDA7CiAgICB9CiAgICBpZiAoY291bnQpIHsKICAgICAgbCA9IE1hdGgubWluKGNvdW50ICogc3RyaWRlICsgb2Zmc2V0LCBhLmxlbmd0aCk7CiAgICB9IGVsc2UgewogICAgICBsID0gYS5sZW5ndGg7CiAgICB9CiAgICBmb3IgKGkgPSBvZmZzZXQ7IGkgPCBsOyBpICs9IHN0cmlkZSkgewogICAgICB2ZWNbMF0gPSBhW2ldOwogICAgICB2ZWNbMV0gPSBhW2kgKyAxXTsKICAgICAgdmVjWzJdID0gYVtpICsgMl07CiAgICAgIGZuKHZlYywgdmVjLCBhcmcpOwogICAgICBhW2ldID0gdmVjWzBdOwogICAgICBhW2kgKyAxXSA9IHZlY1sxXTsKICAgICAgYVtpICsgMl0gPSB2ZWNbMl07CiAgICB9CiAgICByZXR1cm4gYTsKICB9CiAgdmFyIGdsVmVjMyA9IHsKICAgIEVQU0lMT046IGVwc2lsb24sCiAgICBjcmVhdGU6IGNyZWF0ZV8xLAogICAgY2xvbmU6IGNsb25lXzEsCiAgICBhbmdsZTogYW5nbGVfMSwKICAgIGZyb21WYWx1ZXM6IGZyb21WYWx1ZXNfMSwKICAgIGNvcHk6IGNvcHlfMSwKICAgIHNldDogc2V0XzEsCiAgICBlcXVhbHM6IGVxdWFsc18xLAogICAgZXhhY3RFcXVhbHM6IGV4YWN0RXF1YWxzXzEsCiAgICBhZGQ6IGFkZF8xLAogICAgc3VidHJhY3Q6IHN1YnRyYWN0XzEsCiAgICBzdWIsCiAgICBtdWx0aXBseTogbXVsdGlwbHlfMSwKICAgIG11bCwKICAgIGRpdmlkZTogZGl2aWRlXzEsCiAgICBkaXYsCiAgICBtaW46IG1pbl8xLAogICAgbWF4OiBtYXhfMSwKICAgIGZsb29yOiBmbG9vcl8xLAogICAgY2VpbDogY2VpbF8xLAogICAgcm91bmQ6IHJvdW5kXzEsCiAgICBzY2FsZTogc2NhbGVfMSwKICAgIHNjYWxlQW5kQWRkOiBzY2FsZUFuZEFkZF8xLAogICAgZGlzdGFuY2U6IGRpc3RhbmNlXzEsCiAgICBkaXN0LAogICAgc3F1YXJlZERpc3RhbmNlOiBzcXVhcmVkRGlzdGFuY2VfMSwKICAgIHNxckRpc3QsCiAgICBsZW5ndGg6IGxlbmd0aF8xLAogICAgbGVuLAogICAgc3F1YXJlZExlbmd0aDogc3F1YXJlZExlbmd0aF8xLAogICAgc3FyTGVuLAogICAgbmVnYXRlOiBuZWdhdGVfMSwKICAgIGludmVyc2U6IGludmVyc2VfMSwKICAgIG5vcm1hbGl6ZTogbm9ybWFsaXplXzEsCiAgICBkb3Q6IGRvdF8xLAogICAgY3Jvc3M6IGNyb3NzXzEsCiAgICBsZXJwOiBsZXJwXzEsCiAgICByYW5kb206IHJhbmRvbV8xLAogICAgdHJhbnNmb3JtTWF0NDogdHJhbnNmb3JtTWF0NF8xLAogICAgdHJhbnNmb3JtTWF0MzogdHJhbnNmb3JtTWF0M18xLAogICAgdHJhbnNmb3JtUXVhdDogdHJhbnNmb3JtUXVhdF8xLAogICAgcm90YXRlWDogcm90YXRlWF8xLAogICAgcm90YXRlWTogcm90YXRlWV8xLAogICAgcm90YXRlWjogcm90YXRlWl8xLAogICAgZm9yRWFjaDogZm9yRWFjaF8xCiAgfTsKICB2YXIgdmVjMyA9IC8qIEBfX1BVUkVfXyAqLyBnZXREZWZhdWx0RXhwb3J0RnJvbUNqcyhnbFZlYzMpOwogIGNvbnN0IF9DaHVua1V0aWxzID0gY2xhc3MgX0NodW5rVXRpbHMgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgfTsKICBfQ2h1bmtVdGlscy5nZXRDaHVua05hbWUgPSAoY29vcmRzLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiBjb29yZHNbMF0gKyBjb25jYXQgKyBjb29yZHNbMV07CiAgfTsKICBfQ2h1bmtVdGlscy5nZXRWb3hlbE5hbWUgPSAoY29vcmRzLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiAoY29vcmRzWzBdIHwgMCkgKyBjb25jYXQgKyAoY29vcmRzWzFdIHwgMCkgKyBjb25jYXQgKyAoY29vcmRzWzJdIHwgMCk7CiAgfTsKICBfQ2h1bmtVdGlscy5wYXJzZUNodW5rTmFtZSA9IChuYW1lLCBjb25jYXQgPSAifCIpID0+IHsKICAgIHJldHVybiBuYW1lLnNwbGl0KGNvbmNhdCkubWFwKChzKSA9PiBwYXJzZUludChzLCAxMCkpOwogIH07CiAgX0NodW5rVXRpbHMuc2NhbGVDb29yZHNGID0gKGNvb3JkcywgZmFjdG9yKSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSBbMCwgMCwgMF07CiAgICBjb25zdCBzY2FsZWQgPSB2ZWMzLnNjYWxlKHJlc3VsdCwgY29vcmRzLCBmYWN0b3IpOwogICAgcmV0dXJuIHZlYzMuZmxvb3Ioc2NhbGVkLCBzY2FsZWQpOwogIH07CiAgX0NodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rTG9jYWwgPSAodm94ZWxQb3MsIGNodW5rU2l6ZSkgPT4gewogICAgY29uc3QgW2N4LCBjel0gPSBfQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsodm94ZWxQb3MsIGNodW5rU2l6ZSk7CiAgICBjb25zdCBbdngsIHZ5LCB2el0gPSB2b3hlbFBvczsKICAgIHJldHVybiBbdnggLSBjeCAqIGNodW5rU2l6ZSwgdnksIHZ6IC0gY3ogKiBjaHVua1NpemVdOwogIH07CiAgX0NodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rID0gKHZveGVsUG9zLCBjaHVua1NpemUpID0+IHsKICAgIGNvbnN0IGNvb3JkczMgPSBfQ2h1bmtVdGlscy5zY2FsZUNvb3Jkc0Yodm94ZWxQb3MsIDEgLyBjaHVua1NpemUpOwogICAgcmV0dXJuIFtjb29yZHMzWzBdLCBjb29yZHMzWzJdXTsKICB9OwogIF9DaHVua1V0aWxzLm1hcENodW5rVG9Wb3hlbCA9IChjaHVua1BvcywgY2h1bmtTaXplKSA9PiB7CiAgICBjb25zdCByZXN1bHQgPSBbMCwgMCwgMF07CiAgICB2ZWMzLmNvcHkocmVzdWx0LCBbY2h1bmtQb3NbMF0sIDAsIGNodW5rUG9zWzFdXSk7CiAgICB2ZWMzLnNjYWxlKHJlc3VsdCwgcmVzdWx0LCBjaHVua1NpemUpOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIF9DaHVua1V0aWxzLm1hcFdvcmxkVG9Wb3hlbCA9ICh3b3JsZFBvcykgPT4gewogICAgcmV0dXJuIF9DaHVua1V0aWxzLnNjYWxlQ29vcmRzRih3b3JsZFBvcywgMSk7CiAgfTsKICBsZXQgQ2h1bmtVdGlscyA9IF9DaHVua1V0aWxzOwogIGNvbnN0IF9MaWdodFV0aWxzID0gY2xhc3MgX0xpZ2h0VXRpbHMgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgfTsKICBfTGlnaHRVdGlscy5leHRyYWN0U3VubGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCA+PiAxMiAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0U3VubGlnaHQgPSAobGlnaHQsIGxldmVsKSA9PiB7CiAgICByZXR1cm4gbGlnaHQgJiA0MDk1IHwgbGV2ZWwgPDwgMTI7CiAgfTsKICBfTGlnaHRVdGlscy5leHRyYWN0UmVkTGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCA+PiA4ICYgMTU7CiAgfTsKICBfTGlnaHRVdGlscy5pbnNlcnRSZWRMaWdodCA9IChsaWdodCwgbGV2ZWwpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDYxNjk1IHwgbGV2ZWwgPDwgODsKICB9OwogIF9MaWdodFV0aWxzLmV4dHJhY3RHcmVlbkxpZ2h0ID0gKGxpZ2h0KSA9PiB7CiAgICByZXR1cm4gbGlnaHQgPj4gNCAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0R3JlZW5MaWdodCA9IChsaWdodCwgbGV2ZWwpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDY1Mjk1IHwgbGV2ZWwgPDwgNDsKICB9OwogIF9MaWdodFV0aWxzLmV4dHJhY3RCbHVlTGlnaHQgPSAobGlnaHQpID0+IHsKICAgIHJldHVybiBsaWdodCAmIDE1OwogIH07CiAgX0xpZ2h0VXRpbHMuaW5zZXJ0Qmx1ZUxpZ2h0ID0gKGxpZ2h0LCBsZXZlbCkgPT4gewogICAgcmV0dXJuIGxpZ2h0ICYgNjU1MjAgfCBsZXZlbDsKICB9OwogIF9MaWdodFV0aWxzLmNhbkVudGVySW50byA9ICh0YXJnZXQsIGR4LCBkeSwgZHopID0+IHsKICAgIGlmIChNYXRoLmFicyhkeCArIGR5ICsgZHopICE9PSAxKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAiVGhpcyBpc24ndCBzdXBwb3NlZCB0byBoYXBwZW4uIExpZ2h0IG5laWdoYm9yaW5nIGRpcmVjdGlvbiBzaG91bGQgYmUgb24gMSBheGlzIG9ubHkuIgogICAgICApOwogICAgfQogICAgY29uc3QgW3B4LCBweSwgcHosIG54LCBueSwgbnpdID0gdGFyZ2V0OwogICAgaWYgKGR4ID09PSAxKSB7CiAgICAgIHJldHVybiBueDsKICAgIH0KICAgIGlmIChkeCA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHB4OwogICAgfQogICAgaWYgKGR5ID09PSAxKSB7CiAgICAgIHJldHVybiBueTsKICAgIH0KICAgIGlmIChkeSA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHB5OwogICAgfQogICAgaWYgKGR6ID09PSAxKSB7CiAgICAgIHJldHVybiBuejsKICAgIH0KICAgIHJldHVybiBwejsKICB9OwogIF9MaWdodFV0aWxzLmNhbkVudGVyID0gKHNvdXJjZSwgdGFyZ2V0LCBkeCwgZHksIGR6KSA9PiB7CiAgICBpZiAoTWF0aC5hYnMoZHggKyBkeSArIGR6KSAhPT0gMSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgIlRoaXMgaXNuJ3Qgc3VwcG9zZWQgdG8gaGFwcGVuLiBMaWdodCBuZWlnaGJvcmluZyBkaXJlY3Rpb24gc2hvdWxkIGJlIG9uIDEgYXhpcyBvbmx5LiIKICAgICAgKTsKICAgIH0KICAgIGNvbnN0IFtzcHgsIHNweSwgc3B6LCBzbngsIHNueSwgc256XSA9IHNvdXJjZTsKICAgIGNvbnN0IFt0cHgsIHRweSwgdHB6LCB0bngsIHRueSwgdG56XSA9IHRhcmdldDsKICAgIGlmIChkeCA9PT0gMSkgewogICAgICByZXR1cm4gc3B4ICYmIHRueDsKICAgIH0KICAgIGlmIChkeCA9PT0gLTEpIHsKICAgICAgcmV0dXJuIHNueCAmJiB0cHg7CiAgICB9CiAgICBpZiAoZHkgPT09IDEpIHsKICAgICAgcmV0dXJuIHNweSAmJiB0bnk7CiAgICB9CiAgICBpZiAoZHkgPT09IC0xKSB7CiAgICAgIHJldHVybiBzbnkgJiYgdHB5OwogICAgfQogICAgaWYgKGR6ID09PSAxKSB7CiAgICAgIHJldHVybiBzcHogJiYgdG56OwogICAgfQogICAgcmV0dXJuIHNueiAmJiB0cHo7CiAgfTsKICBsZXQgTGlnaHRVdGlscyA9IF9MaWdodFV0aWxzOwogIGZ1bmN0aW9uIGlvdGEkMShuKSB7CiAgICB2YXIgcmVzdWx0ID0gbmV3IEFycmF5KG4pOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gaTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHZhciBpb3RhXzEgPSBpb3RhJDE7CiAgLyohCiAgICogRGV0ZXJtaW5lIGlmIGFuIG9iamVjdCBpcyBhIEJ1ZmZlcgogICAqCiAgICogQGF1dGhvciAgIEZlcm9zcyBBYm91a2hhZGlqZWggPGh0dHBzOi8vZmVyb3NzLm9yZz4KICAgKiBAbGljZW5zZSAgTUlUCiAgICovCiAgdmFyIGlzQnVmZmVyXzEgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogIT0gbnVsbCAmJiAoaXNCdWZmZXIkMShvYmopIHx8IGlzU2xvd0J1ZmZlcihvYmopIHx8ICEhb2JqLl9pc0J1ZmZlcik7CiAgfTsKICBmdW5jdGlvbiBpc0J1ZmZlciQxKG9iaikgewogICAgcmV0dXJuICEhb2JqLmNvbnN0cnVjdG9yICYmIHR5cGVvZiBvYmouY29uc3RydWN0b3IuaXNCdWZmZXIgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yLmlzQnVmZmVyKG9iaik7CiAgfQogIGZ1bmN0aW9uIGlzU2xvd0J1ZmZlcihvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqLnJlYWRGbG9hdExFID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBvYmouc2xpY2UgPT09ICJmdW5jdGlvbiIgJiYgaXNCdWZmZXIkMShvYmouc2xpY2UoMCwgMCkpOwogIH0KICB2YXIgaW90YSA9IGlvdGFfMTsKICB2YXIgaXNCdWZmZXIgPSBpc0J1ZmZlcl8xOwogIHZhciBoYXNUeXBlZEFycmF5cyA9IHR5cGVvZiBGbG9hdDY0QXJyYXkgIT09ICJ1bmRlZmluZWQiOwogIGZ1bmN0aW9uIGNvbXBhcmUxc3QoYSwgYikgewogICAgcmV0dXJuIGFbMF0gLSBiWzBdOwogIH0KICBmdW5jdGlvbiBvcmRlcigpIHsKICAgIHZhciBzdHJpZGUgPSB0aGlzLnN0cmlkZTsKICAgIHZhciB0ZXJtcyA9IG5ldyBBcnJheShzdHJpZGUubGVuZ3RoKTsKICAgIHZhciBpOwogICAgZm9yIChpID0gMDsgaSA8IHRlcm1zLmxlbmd0aDsgKytpKSB7CiAgICAgIHRlcm1zW2ldID0gW01hdGguYWJzKHN0cmlkZVtpXSksIGldOwogICAgfQogICAgdGVybXMuc29ydChjb21wYXJlMXN0KTsKICAgIHZhciByZXN1bHQgPSBuZXcgQXJyYXkodGVybXMubGVuZ3RoKTsKICAgIGZvciAoaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyArK2kpIHsKICAgICAgcmVzdWx0W2ldID0gdGVybXNbaV1bMV07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBmdW5jdGlvbiBjb21waWxlQ29uc3RydWN0b3IoZHR5cGUsIGRpbWVuc2lvbikgewogICAgdmFyIGNsYXNzTmFtZSA9IFsiVmlldyIsIGRpbWVuc2lvbiwgImQiLCBkdHlwZV0uam9pbigiIik7CiAgICBpZiAoZGltZW5zaW9uIDwgMCkgewogICAgICBjbGFzc05hbWUgPSAiVmlld19OaWwiICsgZHR5cGU7CiAgICB9CiAgICB2YXIgdXNlR2V0dGVycyA9IGR0eXBlID09PSAiZ2VuZXJpYyI7CiAgICBpZiAoZGltZW5zaW9uID09PSAtMSkgewogICAgICB2YXIgY29kZSA9ICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhKXt0aGlzLmRhdGE9YTt9O3ZhciBwcm90bz0iICsgY2xhc3NOYW1lICsgIi5wcm90b3R5cGU7cHJvdG8uZHR5cGU9JyIgKyBkdHlwZSArICInO3Byb3RvLmluZGV4PWZ1bmN0aW9uKCl7cmV0dXJuIC0xfTtwcm90by5zaXplPTA7cHJvdG8uZGltZW5zaW9uPS0xO3Byb3RvLnNoYXBlPXByb3RvLnN0cmlkZT1wcm90by5vcmRlcj1bXTtwcm90by5sbz1wcm90by5oaT1wcm90by50cmFuc3Bvc2U9cHJvdG8uc3RlcD1mdW5jdGlvbigpe3JldHVybiBuZXcgIiArIGNsYXNzTmFtZSArICIodGhpcy5kYXRhKTt9O3Byb3RvLmdldD1wcm90by5zZXQ9ZnVuY3Rpb24oKXt9O3Byb3RvLnBpY2s9ZnVuY3Rpb24oKXtyZXR1cm4gbnVsbH07cmV0dXJuIGZ1bmN0aW9uIGNvbnN0cnVjdF8iICsgY2xhc3NOYW1lICsgIihhKXtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKGEpO30iOwogICAgICB2YXIgcHJvY2VkdXJlID0gbmV3IEZ1bmN0aW9uKGNvZGUpOwogICAgICByZXR1cm4gcHJvY2VkdXJlKCk7CiAgICB9IGVsc2UgaWYgKGRpbWVuc2lvbiA9PT0gMCkgewogICAgICB2YXIgY29kZSA9ICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhLGQpIHt0aGlzLmRhdGEgPSBhO3RoaXMub2Zmc2V0ID0gZH07dmFyIHByb3RvPSIgKyBjbGFzc05hbWUgKyAiLnByb3RvdHlwZTtwcm90by5kdHlwZT0nIiArIGR0eXBlICsgIic7cHJvdG8uaW5kZXg9ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5vZmZzZXR9O3Byb3RvLmRpbWVuc2lvbj0wO3Byb3RvLnNpemU9MTtwcm90by5zaGFwZT1wcm90by5zdHJpZGU9cHJvdG8ub3JkZXI9W107cHJvdG8ubG89cHJvdG8uaGk9cHJvdG8udHJhbnNwb3NlPXByb3RvLnN0ZXA9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfY29weSgpIHtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSx0aGlzLm9mZnNldCl9O3Byb3RvLnBpY2s9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfcGljaygpe3JldHVybiBUcml2aWFsQXJyYXkodGhpcy5kYXRhKTt9O3Byb3RvLnZhbHVlT2Y9cHJvdG8uZ2V0PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2dldCgpe3JldHVybiAiICsgKHVzZUdldHRlcnMgPyAidGhpcy5kYXRhLmdldCh0aGlzLm9mZnNldCkiIDogInRoaXMuZGF0YVt0aGlzLm9mZnNldF0iKSArICJ9O3Byb3RvLnNldD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zZXQodil7cmV0dXJuICIgKyAodXNlR2V0dGVycyA/ICJ0aGlzLmRhdGEuc2V0KHRoaXMub2Zmc2V0LHYpIiA6ICJ0aGlzLmRhdGFbdGhpcy5vZmZzZXRdPXYiKSArICJ9O3JldHVybiBmdW5jdGlvbiBjb25zdHJ1Y3RfIiArIGNsYXNzTmFtZSArICIoYSxiLGMsZCl7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIihhLGQpfSI7CiAgICAgIHZhciBwcm9jZWR1cmUgPSBuZXcgRnVuY3Rpb24oIlRyaXZpYWxBcnJheSIsIGNvZGUpOwogICAgICByZXR1cm4gcHJvY2VkdXJlKENBQ0hFRF9DT05TVFJVQ1RPUlNbZHR5cGVdWzBdKTsKICAgIH0KICAgIHZhciBjb2RlID0gWyIndXNlIHN0cmljdCciXTsKICAgIHZhciBpbmRpY2VzID0gaW90YShkaW1lbnNpb24pOwogICAgdmFyIGFyZ3MgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImkiICsgaTI7CiAgICB9KTsKICAgIHZhciBpbmRleF9zdHIgPSAidGhpcy5vZmZzZXQrIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAidGhpcy5zdHJpZGVbIiArIGkyICsgIl0qaSIgKyBpMjsKICAgIH0pLmpvaW4oIisiKTsKICAgIHZhciBzaGFwZUFyZyA9IGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKTsKICAgIHZhciBzdHJpZGVBcmcgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImMiICsgaTI7CiAgICB9KS5qb2luKCIsIik7CiAgICBjb2RlLnB1c2goCiAgICAgICJmdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIihhLCIgKyBzaGFwZUFyZyArICIsIiArIHN0cmlkZUFyZyArICIsZCl7dGhpcy5kYXRhPWEiLAogICAgICAidGhpcy5zaGFwZT1bIiArIHNoYXBlQXJnICsgIl0iLAogICAgICAidGhpcy5zdHJpZGU9WyIgKyBzdHJpZGVBcmcgKyAiXSIsCiAgICAgICJ0aGlzLm9mZnNldD1kfDB9IiwKICAgICAgInZhciBwcm90bz0iICsgY2xhc3NOYW1lICsgIi5wcm90b3R5cGUiLAogICAgICAicHJvdG8uZHR5cGU9JyIgKyBkdHlwZSArICInIiwKICAgICAgInByb3RvLmRpbWVuc2lvbj0iICsgZGltZW5zaW9uCiAgICApOwogICAgY29kZS5wdXNoKAogICAgICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCdzaXplJyx7Z2V0OmZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX3NpemUoKXtyZXR1cm4gIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgICAgcmV0dXJuICJ0aGlzLnNoYXBlWyIgKyBpMiArICJdIjsKICAgICAgfSkuam9pbigiKiIpLAogICAgICAifX0pIgogICAgKTsKICAgIGlmIChkaW1lbnNpb24gPT09IDEpIHsKICAgICAgY29kZS5wdXNoKCJwcm90by5vcmRlcj1bMF0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgiT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3RvLCdvcmRlcicse2dldDoiKTsKICAgICAgaWYgKGRpbWVuc2lvbiA8IDQpIHsKICAgICAgICBjb2RlLnB1c2goImZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX29yZGVyKCl7Iik7CiAgICAgICAgaWYgKGRpbWVuc2lvbiA9PT0gMikgewogICAgICAgICAgY29kZS5wdXNoKCJyZXR1cm4gKE1hdGguYWJzKHRoaXMuc3RyaWRlWzBdKT5NYXRoLmFicyh0aGlzLnN0cmlkZVsxXSkpP1sxLDBdOlswLDFdfX0pIik7CiAgICAgICAgfSBlbHNlIGlmIChkaW1lbnNpb24gPT09IDMpIHsKICAgICAgICAgIGNvZGUucHVzaCgKICAgICAgICAgICAgInZhciBzMD1NYXRoLmFicyh0aGlzLnN0cmlkZVswXSksczE9TWF0aC5hYnModGhpcy5zdHJpZGVbMV0pLHMyPU1hdGguYWJzKHRoaXMuc3RyaWRlWzJdKTtpZihzMD5zMSl7aWYoczE+czIpe3JldHVybiBbMiwxLDBdO31lbHNlIGlmKHMwPnMyKXtyZXR1cm4gWzEsMiwwXTt9ZWxzZXtyZXR1cm4gWzEsMCwyXTt9fWVsc2UgaWYoczA+czIpe3JldHVybiBbMiwwLDFdO31lbHNlIGlmKHMyPnMxKXtyZXR1cm4gWzAsMSwyXTt9ZWxzZXtyZXR1cm4gWzAsMiwxXTt9fX0pIgogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29kZS5wdXNoKCJPUkRFUn0pIik7CiAgICAgIH0KICAgIH0KICAgIGNvZGUucHVzaCgKICAgICAgInByb3RvLnNldD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zZXQoIiArIGFyZ3Muam9pbigiLCIpICsgIix2KXsiCiAgICApOwogICAgaWYgKHVzZUdldHRlcnMpIHsKICAgICAgY29kZS5wdXNoKCJyZXR1cm4gdGhpcy5kYXRhLnNldCgiICsgaW5kZXhfc3RyICsgIix2KX0iKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YVsiICsgaW5kZXhfc3RyICsgIl09dn0iKTsKICAgIH0KICAgIGNvZGUucHVzaCgicHJvdG8uZ2V0PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2dldCgiICsgYXJncy5qb2luKCIsIikgKyAiKXsiKTsKICAgIGlmICh1c2VHZXR0ZXJzKSB7CiAgICAgIGNvZGUucHVzaCgicmV0dXJuIHRoaXMuZGF0YS5nZXQoIiArIGluZGV4X3N0ciArICIpfSIpOwogICAgfSBlbHNlIHsKICAgICAgY29kZS5wdXNoKCJyZXR1cm4gdGhpcy5kYXRhWyIgKyBpbmRleF9zdHIgKyAiXX0iKTsKICAgIH0KICAgIGNvZGUucHVzaCgKICAgICAgInByb3RvLmluZGV4PWZ1bmN0aW9uICIgKyBjbGFzc05hbWUgKyAiX2luZGV4KCIsCiAgICAgIGFyZ3Muam9pbigpLAogICAgICAiKXtyZXR1cm4gIiArIGluZGV4X3N0ciArICJ9IgogICAgKTsKICAgIGNvZGUucHVzaCgicHJvdG8uaGk9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfaGkoIiArIGFyZ3Muam9pbigiLCIpICsgIil7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIih0aGlzLmRhdGEsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiBbIih0eXBlb2YgaSIsIGkyLCAiIT09J251bWJlcid8fGkiLCBpMiwgIjwwKT90aGlzLnNoYXBlWyIsIGkyLCAiXTppIiwgaTIsICJ8MCJdLmpvaW4oIiIpOwogICAgfSkuam9pbigiLCIpICsgIiwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJ0aGlzLnN0cmlkZVsiICsgaTIgKyAiXSI7CiAgICB9KS5qb2luKCIsIikgKyAiLHRoaXMub2Zmc2V0KX0iKTsKICAgIHZhciBhX3ZhcnMgPSBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gImEiICsgaTIgKyAiPXRoaXMuc2hhcGVbIiArIGkyICsgIl0iOwogICAgfSk7CiAgICB2YXIgY192YXJzID0gaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJjIiArIGkyICsgIj10aGlzLnN0cmlkZVsiICsgaTIgKyAiXSI7CiAgICB9KTsKICAgIGNvZGUucHVzaCgicHJvdG8ubG89ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfbG8oIiArIGFyZ3Muam9pbigiLCIpICsgIil7dmFyIGI9dGhpcy5vZmZzZXQsZD0wLCIgKyBhX3ZhcnMuam9pbigiLCIpICsgIiwiICsgY192YXJzLmpvaW4oIiwiKSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIGNvZGUucHVzaCgKICAgICAgICAiaWYodHlwZW9mIGkiICsgaSArICI9PT0nbnVtYmVyJyYmaSIgKyBpICsgIj49MCl7ZD1pIiArIGkgKyAifDA7Yis9YyIgKyBpICsgIipkO2EiICsgaSArICItPWR9IgogICAgICApOwogICAgfQogICAgY29kZS5wdXNoKCJyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJhIiArIGkyOwogICAgfSkuam9pbigiLCIpICsgIiwiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJjIiArIGkyOwogICAgfSkuam9pbigiLCIpICsgIixiKX0iKTsKICAgIGNvZGUucHVzaCgicHJvdG8uc3RlcD1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9zdGVwKCIgKyBhcmdzLmpvaW4oIiwiKSArICIpe3ZhciAiICsgaW5kaWNlcy5tYXAoZnVuY3Rpb24oaTIpIHsKICAgICAgcmV0dXJuICJhIiArIGkyICsgIj10aGlzLnNoYXBlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMiArICI9dGhpcy5zdHJpZGVbIiArIGkyICsgIl0iOwogICAgfSkuam9pbigiLCIpICsgIixjPXRoaXMub2Zmc2V0LGQ9MCxjZWlsPU1hdGguY2VpbCIpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaW1lbnNpb247ICsraSkgewogICAgICBjb2RlLnB1c2goCiAgICAgICAgImlmKHR5cGVvZiBpIiArIGkgKyAiPT09J251bWJlcicpe2Q9aSIgKyBpICsgInwwO2lmKGQ8MCl7Yys9YiIgKyBpICsgIiooYSIgKyBpICsgIi0xKTthIiArIGkgKyAiPWNlaWwoLWEiICsgaSArICIvZCl9ZWxzZXthIiArIGkgKyAiPWNlaWwoYSIgKyBpICsgIi9kKX1iIiArIGkgKyAiKj1kfSIKICAgICAgKTsKICAgIH0KICAgIGNvZGUucHVzaCgicmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIih0aGlzLmRhdGEsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYSIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAiYiIgKyBpMjsKICAgIH0pLmpvaW4oIiwiKSArICIsYyl9Iik7CiAgICB2YXIgdFNoYXBlID0gbmV3IEFycmF5KGRpbWVuc2lvbik7CiAgICB2YXIgdFN0cmlkZSA9IG5ldyBBcnJheShkaW1lbnNpb24pOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaW1lbnNpb247ICsraSkgewogICAgICB0U2hhcGVbaV0gPSAiYVtpIiArIGkgKyAiXSI7CiAgICAgIHRTdHJpZGVbaV0gPSAiYltpIiArIGkgKyAiXSI7CiAgICB9CiAgICBjb2RlLnB1c2goCiAgICAgICJwcm90by50cmFuc3Bvc2U9ZnVuY3Rpb24gIiArIGNsYXNzTmFtZSArICJfdHJhbnNwb3NlKCIgKyBhcmdzICsgIil7IiArIGFyZ3MubWFwKGZ1bmN0aW9uKG4sIGlkeCkgewogICAgICAgIHJldHVybiBuICsgIj0oIiArIG4gKyAiPT09dW5kZWZpbmVkPyIgKyBpZHggKyAiOiIgKyBuICsgInwwKSI7CiAgICAgIH0pLmpvaW4oIjsiKSwKICAgICAgInZhciBhPXRoaXMuc2hhcGUsYj10aGlzLnN0cmlkZTtyZXR1cm4gbmV3ICIgKyBjbGFzc05hbWUgKyAiKHRoaXMuZGF0YSwiICsgdFNoYXBlLmpvaW4oIiwiKSArICIsIiArIHRTdHJpZGUuam9pbigiLCIpICsgIix0aGlzLm9mZnNldCl9IgogICAgKTsKICAgIGNvZGUucHVzaCgicHJvdG8ucGljaz1mdW5jdGlvbiAiICsgY2xhc3NOYW1lICsgIl9waWNrKCIgKyBhcmdzICsgIil7dmFyIGE9W10sYj1bXSxjPXRoaXMub2Zmc2V0Iik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpbWVuc2lvbjsgKytpKSB7CiAgICAgIGNvZGUucHVzaCgiaWYodHlwZW9mIGkiICsgaSArICI9PT0nbnVtYmVyJyYmaSIgKyBpICsgIj49MCl7Yz0oYyt0aGlzLnN0cmlkZVsiICsgaSArICJdKmkiICsgaSArICIpfDB9ZWxzZXthLnB1c2godGhpcy5zaGFwZVsiICsgaSArICJdKTtiLnB1c2godGhpcy5zdHJpZGVbIiArIGkgKyAiXSl9Iik7CiAgICB9CiAgICBjb2RlLnB1c2goInZhciBjdG9yPUNUT1JfTElTVFthLmxlbmd0aCsxXTtyZXR1cm4gY3Rvcih0aGlzLmRhdGEsYSxiLGMpfSIpOwogICAgY29kZS5wdXNoKCJyZXR1cm4gZnVuY3Rpb24gY29uc3RydWN0XyIgKyBjbGFzc05hbWUgKyAiKGRhdGEsc2hhcGUsc3RyaWRlLG9mZnNldCl7cmV0dXJuIG5ldyAiICsgY2xhc3NOYW1lICsgIihkYXRhLCIgKyBpbmRpY2VzLm1hcChmdW5jdGlvbihpMikgewogICAgICByZXR1cm4gInNoYXBlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsIiArIGluZGljZXMubWFwKGZ1bmN0aW9uKGkyKSB7CiAgICAgIHJldHVybiAic3RyaWRlWyIgKyBpMiArICJdIjsKICAgIH0pLmpvaW4oIiwiKSArICIsb2Zmc2V0KX0iKTsKICAgIHZhciBwcm9jZWR1cmUgPSBuZXcgRnVuY3Rpb24oIkNUT1JfTElTVCIsICJPUkRFUiIsIGNvZGUuam9pbigiXG4iKSk7CiAgICByZXR1cm4gcHJvY2VkdXJlKENBQ0hFRF9DT05TVFJVQ1RPUlNbZHR5cGVdLCBvcmRlcik7CiAgfQogIGZ1bmN0aW9uIGFycmF5RFR5cGUoZGF0YSkgewogICAgaWYgKGlzQnVmZmVyKGRhdGEpKSB7CiAgICAgIHJldHVybiAiYnVmZmVyIjsKICAgIH0KICAgIGlmIChoYXNUeXBlZEFycmF5cykgewogICAgICBzd2l0Y2ggKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChkYXRhKSkgewogICAgICAgIGNhc2UgIltvYmplY3QgRmxvYXQ2NEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImZsb2F0NjQiOwogICAgICAgIGNhc2UgIltvYmplY3QgRmxvYXQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImZsb2F0MzIiOwogICAgICAgIGNhc2UgIltvYmplY3QgSW50OEFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImludDgiOwogICAgICAgIGNhc2UgIltvYmplY3QgSW50MTZBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJpbnQxNiI7CiAgICAgICAgY2FzZSAiW29iamVjdCBJbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gImludDMyIjsKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQ4QXJyYXldIjoKICAgICAgICAgIHJldHVybiAidWludDgiOwogICAgICAgIGNhc2UgIltvYmplY3QgVWludDE2QXJyYXldIjoKICAgICAgICAgIHJldHVybiAidWludDE2IjsKICAgICAgICBjYXNlICJbb2JqZWN0IFVpbnQzMkFycmF5XSI6CiAgICAgICAgICByZXR1cm4gInVpbnQzMiI7CiAgICAgICAgY2FzZSAiW29iamVjdCBVaW50OENsYW1wZWRBcnJheV0iOgogICAgICAgICAgcmV0dXJuICJ1aW50OF9jbGFtcGVkIjsKICAgICAgICBjYXNlICJbb2JqZWN0IEJpZ0ludDY0QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiYmlnaW50NjQiOwogICAgICAgIGNhc2UgIltvYmplY3QgQmlnVWludDY0QXJyYXldIjoKICAgICAgICAgIHJldHVybiAiYmlndWludDY0IjsKICAgICAgfQogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgcmV0dXJuICJhcnJheSI7CiAgICB9CiAgICByZXR1cm4gImdlbmVyaWMiOwogIH0KICB2YXIgQ0FDSEVEX0NPTlNUUlVDVE9SUyA9IHsKICAgICJmbG9hdDMyIjogW10sCiAgICAiZmxvYXQ2NCI6IFtdLAogICAgImludDgiOiBbXSwKICAgICJpbnQxNiI6IFtdLAogICAgImludDMyIjogW10sCiAgICAidWludDgiOiBbXSwKICAgICJ1aW50MTYiOiBbXSwKICAgICJ1aW50MzIiOiBbXSwKICAgICJhcnJheSI6IFtdLAogICAgInVpbnQ4X2NsYW1wZWQiOiBbXSwKICAgICJiaWdpbnQ2NCI6IFtdLAogICAgImJpZ3VpbnQ2NCI6IFtdLAogICAgImJ1ZmZlciI6IFtdLAogICAgImdlbmVyaWMiOiBbXQogIH07CiAgZnVuY3Rpb24gd3JhcHBlZE5EQXJyYXlDdG9yKGRhdGEsIHNoYXBlLCBzdHJpZGUsIG9mZnNldCkgewogICAgaWYgKGRhdGEgPT09IHZvaWQgMCkgewogICAgICB2YXIgY3RvciA9IENBQ0hFRF9DT05TVFJVQ1RPUlMuYXJyYXlbMF07CiAgICAgIHJldHVybiBjdG9yKFtdKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICJudW1iZXIiKSB7CiAgICAgIGRhdGEgPSBbZGF0YV07CiAgICB9CiAgICBpZiAoc2hhcGUgPT09IHZvaWQgMCkgewogICAgICBzaGFwZSA9IFtkYXRhLmxlbmd0aF07CiAgICB9CiAgICB2YXIgZCA9IHNoYXBlLmxlbmd0aDsKICAgIGlmIChzdHJpZGUgPT09IHZvaWQgMCkgewogICAgICBzdHJpZGUgPSBuZXcgQXJyYXkoZCk7CiAgICAgIGZvciAodmFyIGkgPSBkIC0gMSwgc3ogPSAxOyBpID49IDA7IC0taSkgewogICAgICAgIHN0cmlkZVtpXSA9IHN6OwogICAgICAgIHN6ICo9IHNoYXBlW2ldOwogICAgICB9CiAgICB9CiAgICBpZiAob2Zmc2V0ID09PSB2b2lkIDApIHsKICAgICAgb2Zmc2V0ID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkOyArK2kpIHsKICAgICAgICBpZiAoc3RyaWRlW2ldIDwgMCkgewogICAgICAgICAgb2Zmc2V0IC09IChzaGFwZVtpXSAtIDEpICogc3RyaWRlW2ldOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgdmFyIGR0eXBlID0gYXJyYXlEVHlwZShkYXRhKTsKICAgIHZhciBjdG9yX2xpc3QgPSBDQUNIRURfQ09OU1RSVUNUT1JTW2R0eXBlXTsKICAgIHdoaWxlIChjdG9yX2xpc3QubGVuZ3RoIDw9IGQgKyAxKSB7CiAgICAgIGN0b3JfbGlzdC5wdXNoKGNvbXBpbGVDb25zdHJ1Y3RvcihkdHlwZSwgY3Rvcl9saXN0Lmxlbmd0aCAtIDEpKTsKICAgIH0KICAgIHZhciBjdG9yID0gY3Rvcl9saXN0W2QgKyAxXTsKICAgIHJldHVybiBjdG9yKGRhdGEsIHNoYXBlLCBzdHJpZGUsIG9mZnNldCk7CiAgfQogIHZhciBuZGFycmF5ID0gd3JhcHBlZE5EQXJyYXlDdG9yOwogIHZhciBuZGFycmF5JDEgPSAvKiBAX19QVVJFX18gKi8gZ2V0RGVmYXVsdEV4cG9ydEZyb21DanMobmRhcnJheSk7CiAgY2xhc3MgUmF3Q2h1bmsgewogICAgY29uc3RydWN0b3IoaWQsIGNvb3Jkcywgb3B0aW9ucykgewogICAgICB0aGlzLmlkID0gaWQ7CiAgICAgIHRoaXMubmFtZSA9IENodW5rVXRpbHMuZ2V0Q2h1bmtOYW1lKGNvb3Jkcyk7CiAgICAgIHRoaXMuY29vcmRzID0gY29vcmRzOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICBjb25zdCB7IHNpemUsIG1heEhlaWdodCB9ID0gb3B0aW9uczsKICAgICAgdGhpcy52b3hlbHMgPSBuZGFycmF5JDEoW10sIFtzaXplLCBtYXhIZWlnaHQsIHNpemVdKTsKICAgICAgdGhpcy5saWdodHMgPSBuZGFycmF5JDEoW10sIFtzaXplLCBtYXhIZWlnaHQsIHNpemVdKTsKICAgICAgY29uc3QgW3gsIHpdID0gY29vcmRzOwogICAgICB0aGlzLm1pbiA9IFt4ICogc2l6ZSwgMCwgeiAqIHNpemVdOwogICAgICB0aGlzLm1heCA9IFsoeCArIDEpICogc2l6ZSwgbWF4SGVpZ2h0LCAoeiArIDEpICogc2l6ZV07CiAgICB9CiAgICBzZXJpYWxpemUoKSB7CiAgICAgIHJldHVybiBbCiAgICAgICAgewogICAgICAgICAgaWQ6IHRoaXMuaWQsCiAgICAgICAgICB4OiB0aGlzLmNvb3Jkc1swXSwKICAgICAgICAgIHo6IHRoaXMuY29vcmRzWzFdLAogICAgICAgICAgdm94ZWxzOiB0aGlzLnZveGVscy5kYXRhLmJ1ZmZlciwKICAgICAgICAgIGxpZ2h0czogdGhpcy5saWdodHMuZGF0YS5idWZmZXIsCiAgICAgICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMKICAgICAgICB9LAogICAgICAgIFsKICAgICAgICAgIHRoaXMudm94ZWxzLmRhdGEuYnVmZmVyLnNsaWNlKDApLAogICAgICAgICAgdGhpcy5saWdodHMuZGF0YS5idWZmZXIuc2xpY2UoMCkKICAgICAgICBdCiAgICAgIF07CiAgICB9CiAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICBjb25zdCB7IGlkLCB4LCB6LCB2b3hlbHMsIGxpZ2h0cywgb3B0aW9ucyB9ID0gZGF0YTsKICAgICAgY29uc3QgY2h1bmsgPSBuZXcgUmF3Q2h1bmsoaWQsIFt4LCB6XSwgb3B0aW9ucyk7CiAgICAgIGlmIChsaWdodHMgJiYgbGlnaHRzLmJ5dGVMZW5ndGgpCiAgICAgICAgY2h1bmsubGlnaHRzLmRhdGEgPSBuZXcgVWludDMyQXJyYXkobGlnaHRzKTsKICAgICAgaWYgKHZveGVscyAmJiB2b3hlbHMuYnl0ZUxlbmd0aCkKICAgICAgICBjaHVuay52b3hlbHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheSh2b3hlbHMpOwogICAgICByZXR1cm4gY2h1bms7CiAgICB9CiAgICBzZXREYXRhKGRhdGEpIHsKICAgICAgY29uc3QgeyBpZCwgeCwgeiB9ID0gZGF0YTsKICAgICAgaWYgKHRoaXMuaWQgIT09IGlkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaHVuayBpZCBtaXNtYXRjaCIpOwogICAgICB9CiAgICAgIGlmICh0aGlzLmNvb3Jkc1swXSAhPT0geCB8fCB0aGlzLmNvb3Jkc1sxXSAhPT0geikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2h1bmsgY29vcmRzIG1pc21hdGNoIik7CiAgICAgIH0KICAgICAgY29uc3QgeyB2b3hlbHMsIGxpZ2h0cyB9ID0gZGF0YTsKICAgICAgaWYgKGxpZ2h0cyAmJiBsaWdodHMuYnl0ZUxlbmd0aCkgdGhpcy5saWdodHMuZGF0YSA9IG5ldyBVaW50MzJBcnJheShsaWdodHMpOwogICAgICBpZiAodm94ZWxzICYmIHZveGVscy5ieXRlTGVuZ3RoKSB0aGlzLnZveGVscy5kYXRhID0gbmV3IFVpbnQzMkFycmF5KHZveGVscyk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgcmF3IHZveGVsIHZhbHVlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmF3IHZveGVsIHZhbHVlIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgaXMgbm90IHdpdGhpbgogICAgICogdGhlIGNodW5rLCB0aGlzIG1ldGhvZCByZXR1cm5zIGAwYC4KICAgICAqLwogICAgZ2V0UmF3VmFsdWUodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnZveGVscy5nZXQobHgsIGx5LCBseik7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcmF3IHZveGVsIHZhbHVlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgcmF3IHZveGVsIHZhbHVlIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgdm94ZWwgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIHNldFJhd1ZhbHVlKHZ4LCB2eSwgdnosIHZhbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnZveGVscy5zZXQobHgsIGx5LCBseiwgdmFsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSByYXcgbGlnaHQgdmFsdWUgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByYXcgbGlnaHQgdmFsdWUgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIGdldFJhd0xpZ2h0KHZ4LCB2eSwgdnopIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSByZXR1cm4gMDsKICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHJhdyBsaWdodCB2YWx1ZSBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIHJhdyBsaWdodCBsZXZlbCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgcmF3IGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBzZXRSYXdMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmxpZ2h0cy5zZXQobHgsIGx5LCBseiwgbGV2ZWwpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZveGVsIHR5cGUgSUQgYXQgYSBnaXZlbiB2b3hlbCBvciB3b3JsZCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSB2b3hlbCB0eXBlIElEIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBnZXRWb3hlbCh2eCwgdnksIHZ6KSB7CiAgICAgIHJldHVybiBCbG9ja1V0aWxzLmV4dHJhY3RJRCh0aGlzLmdldFJhd1ZhbHVlKHZ4IHwgMCwgdnkgfCAwLCB2eiB8IDApKTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSB2b3hlbCB0eXBlIElEIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBpZCBUaGUgdm94ZWwgdHlwZSBJRCB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgdHlwZSBJRCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqLwogICAgc2V0Vm94ZWwodngsIHZ5LCB2eiwgaWQpIHsKICAgICAgY29uc3QgdmFsdWUgPSBCbG9ja1V0aWxzLmluc2VydElEKDAsIGlkKTsKICAgICAgdGhpcy5zZXRSYXdWYWx1ZSh2eCwgdnksIHZ6LCB2YWx1ZSk7CiAgICAgIHJldHVybiBpZDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSB2b3hlbCByb3RhdGlvbiBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHZveGVsIHJvdGF0aW9uIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBnZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnopIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSByZXR1cm4gbmV3IEJsb2NrUm90YXRpb24oKTsKICAgICAgcmV0dXJuIEJsb2NrVXRpbHMuZXh0cmFjdFJvdGF0aW9uKHRoaXMuZ2V0UmF3VmFsdWUodngsIHZ5LCB2eikpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHZveGVsIHJvdGF0aW9uIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSByb3RhdGlvbiBUaGUgdm94ZWwgcm90YXRpb24gdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICovCiAgICBzZXRWb3hlbFJvdGF0aW9uKHZ4LCB2eSwgdnosIHJvdGF0aW9uKSB7CiAgICAgIGNvbnN0IHZhbHVlID0gQmxvY2tVdGlscy5pbnNlcnRSb3RhdGlvbigKICAgICAgICB0aGlzLmdldFJhd1ZhbHVlKHZ4LCB2eSwgdnopLAogICAgICAgIHJvdGF0aW9uCiAgICAgICk7CiAgICAgIHRoaXMuc2V0UmF3VmFsdWUodngsIHZ5LCB2eiwgdmFsdWUpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIHZveGVsIHN0YWdlIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgc3RhZ2UgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIGdldFZveGVsU3RhZ2UodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHJldHVybiAwOwogICAgICByZXR1cm4gQmxvY2tVdGlscy5leHRyYWN0U3RhZ2UodGhpcy5nZXRSYXdWYWx1ZSh2eCwgdnksIHZ6KSk7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgdm94ZWwgc3RhZ2UgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHN0YWdlIFRoZSB2b3hlbCBzdGFnZSB0byBzZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgdm94ZWwgc3RhZ2UgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKi8KICAgIHNldFZveGVsU3RhZ2UodngsIHZ5LCB2eiwgc3RhZ2UpIHsKICAgICAgY29uc3QgdmFsdWUgPSBCbG9ja1V0aWxzLmluc2VydFN0YWdlKHRoaXMuZ2V0UmF3VmFsdWUodngsIHZ5LCB2eiksIHN0YWdlKTsKICAgICAgdGhpcy5zZXRSYXdWYWx1ZSh2eCwgdnksIHZ6LCB2YWx1ZSk7CiAgICAgIHJldHVybiBzdGFnZTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgZ2V0UmVkTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsUmVkTGlnaHQobHgsIGx5LCBseik7CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgcmVkIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSBsZXZlbCBUaGUgcmVkIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSByZWQgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgc2V0UmVkTGlnaHQodngsIHZ5LCB2eiwgbGV2ZWwpIHsKICAgICAgaWYgKCF0aGlzLmNvbnRhaW5zKHZ4LCB2eSwgdnopKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5zZXRMb2NhbFJlZExpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHJldHVybnMgVGhlIGdyZWVuIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIGdldEdyZWVuTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KTsKICAgIH0KICAgIC8qKgogICAgICogU2V0IHRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGdyZWVuIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBncmVlbiBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBzZXRHcmVlbkxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0TG9jYWxHcmVlbkxpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcmV0dXJucyBUaGUgYmx1ZSBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBnZXRCbHVlTGlnaHQodngsIHZ5LCB2eikgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLmdldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIGJsdWUgbGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIHB1cmVseSBjbGllbnQtc2lkZSBhbmQgZG9lcyBub3QgYWZmZWN0IHRoZSBhY3R1YWwgdmFsdWVzIG9uIHRoZSBzZXJ2ZXIuCiAgICAgKgogICAgICogQHBhcmFtIHZ4IFRoZSB4IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eSBUaGUgeSB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnogVGhlIHogdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIGxldmVsIFRoZSBibHVlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBibHVlIGxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIHNldEJsdWVMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCkgewogICAgICBpZiAoIXRoaXMuY29udGFpbnModngsIHZ5LCB2eikpIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQogICAgICBjb25zdCBbbHgsIGx5LCBsel0gPSB0aGlzLnRvTG9jYWwodngsIHZ5LCB2eik7CiAgICAgIHJldHVybiB0aGlzLnNldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHosIGxldmVsKTsKICAgIH0KICAgIC8qKgogICAgICogR2V0IHRoZSBjb2xvcmVkIHRvcmNoIGxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gY29sb3IgVGhlIGNvbG9yIG9mIHRoZSBsaWdodCB0byBnZXQgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKiBAcmV0dXJucyBUaGUgbGlnaHQgbGV2ZWwgYXQgdGhlIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuIElmIHRoZSB2b3hlbCBjb29yZGluYXRlIGlzIG91dCBvZiBib3VuZHMsIHJldHVybnMgMC4KICAgICAqLwogICAgZ2V0VG9yY2hMaWdodCh2eCwgdnksIHZ6LCBjb2xvcikgewogICAgICBzd2l0Y2ggKGNvbG9yKSB7CiAgICAgICAgY2FzZSAiUkVEIjoKICAgICAgICAgIHJldHVybiB0aGlzLmdldFJlZExpZ2h0KHZ4LCB2eSwgdnopOwogICAgICAgIGNhc2UgIkdSRUVOIjoKICAgICAgICAgIHJldHVybiB0aGlzLmdldEdyZWVuTGlnaHQodngsIHZ5LCB2eik7CiAgICAgICAgY2FzZSAiQkxVRSI6CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRCbHVlTGlnaHQodngsIHZ5LCB2eik7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVjZWl2ZWQgdW5rbm93biBsaWdodCBjb2xvci4uLiIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFNldCB0aGUgY29sb3JlZCB0b3JjaCBsaWdodCBsZXZlbCBhdCBhIGdpdmVuIHZveGVsIGNvb3JkaW5hdGUuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBtZXRob2QgaXMgcHVyZWx5IGNsaWVudC1zaWRlIGFuZCBkb2VzIG5vdCBhZmZlY3QgdGhlIGFjdHVhbCB2YWx1ZXMgb24gdGhlIHNlcnZlci4KICAgICAqCiAgICAgKiBAcGFyYW0gdnggVGhlIHggdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ5IFRoZSB5IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSB2eiBUaGUgeiB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gbGV2ZWwgVGhlIGxpZ2h0IGxldmVsIHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEBwYXJhbSBjb2xvciBUaGUgY29sb3Igb2YgdGhlIGxpZ2h0IHRvIHNldCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqIEByZXR1cm5zIFRoZSBsaWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBzZXRUb3JjaExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsLCBjb2xvcikgewogICAgICBzd2l0Y2ggKGNvbG9yKSB7CiAgICAgICAgY2FzZSAiUkVEIjoKICAgICAgICAgIHJldHVybiB0aGlzLnNldFJlZExpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICBjYXNlICJHUkVFTiI6CiAgICAgICAgICByZXR1cm4gdGhpcy5zZXRHcmVlbkxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKTsKICAgICAgICBjYXNlICJCTFVFIjoKICAgICAgICAgIHJldHVybiB0aGlzLnNldEJsdWVMaWdodCh2eCwgdnksIHZ6LCBsZXZlbCk7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVjZWl2ZWQgdW5rbm93biBsaWdodCBjb2xvci4uLiIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgc3VubGlnaHQgbGV2ZWwgYXQgYSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEByZXR1cm5zIFRoZSBzdW5saWdodCBsZXZlbCBhdCB0aGUgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4gSWYgdGhlIHZveGVsIGNvb3JkaW5hdGUgaXMgb3V0IG9mIGJvdW5kcywgcmV0dXJucyAwLgogICAgICovCiAgICBnZXRTdW5saWdodCh2eCwgdnksIHZ6KSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIGlmICh2eSA8IDApIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLm1heExpZ2h0TGV2ZWw7CiAgICAgIH0KICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gdGhpcy5nZXRMb2NhbFN1bmxpZ2h0KGx4LCBseSwgbHopOwogICAgfQogICAgLyoqCiAgICAgKiBTZXQgdGhlIHN1bmxpZ2h0IGxldmVsIGF0IGEgZ2l2ZW4gdm94ZWwgY29vcmRpbmF0ZS4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIG1ldGhvZCBpcyBwdXJlbHkgY2xpZW50LXNpZGUgYW5kIGRvZXMgbm90IGFmZmVjdCB0aGUgYWN0dWFsIHZhbHVlcyBvbiB0aGUgc2VydmVyLgogICAgICoKICAgICAqIEBwYXJhbSB2eCBUaGUgeCB2b3hlbCBjb29yZGluYXRlCiAgICAgKiBAcGFyYW0gdnkgVGhlIHkgdm94ZWwgY29vcmRpbmF0ZQogICAgICogQHBhcmFtIHZ6IFRoZSB6IHZveGVsIGNvb3JkaW5hdGUKICAgICAqIEBwYXJhbSBsZXZlbCBUaGUgc3VubGlnaHQgbGV2ZWwgdG8gc2V0IGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLgogICAgICogQHJldHVybnMgVGhlIHN1bmxpZ2h0IGxldmVsIGF0IHRoZSBnaXZlbiB2b3hlbCBjb29yZGluYXRlLiBJZiB0aGUgdm94ZWwgY29vcmRpbmF0ZSBpcyBvdXQgb2YgYm91bmRzLCByZXR1cm5zIDAuCiAgICAgKi8KICAgIHNldFN1bmxpZ2h0KHZ4LCB2eSwgdnosIGxldmVsKSB7CiAgICAgIGlmICghdGhpcy5jb250YWlucyh2eCwgdnksIHZ6KSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIGNvbnN0IFtseCwgbHksIGx6XSA9IHRoaXMudG9Mb2NhbCh2eCwgdnksIHZ6KTsKICAgICAgcmV0dXJuIHRoaXMuc2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6LCBsZXZlbCk7CiAgICB9CiAgICAvKioKICAgICAqIFdoZXRoZXIgb3Igbm90IGlzIHRoaXMgY2h1bmsgcmVhZHkgdG8gYmUgcmVuZGVyZWQgYW5kIHNlZW4gaW4gdGhlIHdvcmxkLgogICAgICovCiAgICBnZXQgaXNSZWFkeSgpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLmRhdGEubGVuZ3RoICE9PSAwICYmIHRoaXMudm94ZWxzLmRhdGEubGVuZ3RoICE9PSAwOwogICAgfQogICAgZ2V0TG9jYWxSZWRMaWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RSZWRMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxSZWRMaWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KAogICAgICAgIGx4LAogICAgICAgIGx5LAogICAgICAgIGx6LAogICAgICAgIExpZ2h0VXRpbHMuaW5zZXJ0UmVkTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIGdldExvY2FsR3JlZW5MaWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RHcmVlbkxpZ2h0KHRoaXMubGlnaHRzLmdldChseCwgbHksIGx6KSk7CiAgICB9CiAgICBzZXRMb2NhbEdyZWVuTGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldCgKICAgICAgICBseCwKICAgICAgICBseSwKICAgICAgICBseiwKICAgICAgICBMaWdodFV0aWxzLmluc2VydEdyZWVuTGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIGdldExvY2FsQmx1ZUxpZ2h0KGx4LCBseSwgbHopIHsKICAgICAgcmV0dXJuIExpZ2h0VXRpbHMuZXh0cmFjdEJsdWVMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxCbHVlTGlnaHQobHgsIGx5LCBseiwgbGV2ZWwpIHsKICAgICAgcmV0dXJuIHRoaXMubGlnaHRzLnNldCgKICAgICAgICBseCwKICAgICAgICBseSwKICAgICAgICBseiwKICAgICAgICBMaWdodFV0aWxzLmluc2VydEJsdWVMaWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseiksIGxldmVsKQogICAgICApOwogICAgfQogICAgZ2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6KSB7CiAgICAgIHJldHVybiBMaWdodFV0aWxzLmV4dHJhY3RTdW5saWdodCh0aGlzLmxpZ2h0cy5nZXQobHgsIGx5LCBseikpOwogICAgfQogICAgc2V0TG9jYWxTdW5saWdodChseCwgbHksIGx6LCBsZXZlbCkgewogICAgICByZXR1cm4gdGhpcy5saWdodHMuc2V0KAogICAgICAgIGx4LAogICAgICAgIGx5LAogICAgICAgIGx6LAogICAgICAgIExpZ2h0VXRpbHMuaW5zZXJ0U3VubGlnaHQodGhpcy5saWdodHMuZ2V0KGx4LCBseSwgbHopLCBsZXZlbCkKICAgICAgKTsKICAgIH0KICAgIHRvTG9jYWwodngsIHZ5LCB2eikgewogICAgICBjb25zdCBbbXgsIG15LCBtel0gPSB0aGlzLm1pbjsKICAgICAgcmV0dXJuIFsodnggfCAwKSAtIG14LCAodnkgfCAwKSAtIG15LCAodnogfCAwKSAtIG16XTsKICAgIH0KICAgIGNvbnRhaW5zKHZ4LCB2eSwgdnopIHsKICAgICAgY29uc3QgeyBzaXplLCBtYXhIZWlnaHQgfSA9IHRoaXMub3B0aW9uczsKICAgICAgY29uc3QgW2x4LCBseSwgbHpdID0gdGhpcy50b0xvY2FsKHZ4LCB2eSwgdnopOwogICAgICByZXR1cm4gbHggPCBzaXplICYmIGx5ID49IDAgJiYgbHkgPCBtYXhIZWlnaHQgJiYgbHogPj0gMCAmJiBseiA8IHNpemU7CiAgICB9CiAgfQogIGNsYXNzIFJlZ2lzdHJ5IHsKICAgIC8qKgogICAgICogQGhpZGRlbgogICAgICovCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgdGhpcy5ibG9ja3NCeU5hbWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLmJsb2Nrc0J5SWQgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLm5hbWVNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICB0aGlzLmlkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIH0KICAgIHNlcmlhbGl6ZSgpIHsKICAgICAgY29uc3QgY2xlYW5CbG9jayA9IChibG9jaykgPT4gewogICAgICAgIGNvbnN0IHsgZHluYW1pY0ZuLCAuLi5yZXN0IH0gPSBibG9jazsKICAgICAgICByZXR1cm4gcmVzdDsKICAgICAgfTsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UoCiAgICAgICAgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgYmxvY2tzQnlOYW1lOiBBcnJheS5mcm9tKHRoaXMuYmxvY2tzQnlOYW1lLmVudHJpZXMoKSkubWFwKAogICAgICAgICAgICAoW25hbWUsIGJsb2NrXSkgPT4gW25hbWUsIGNsZWFuQmxvY2soYmxvY2spXQogICAgICAgICAgKSwKICAgICAgICAgIGJsb2Nrc0J5SWQ6IEFycmF5LmZyb20odGhpcy5ibG9ja3NCeUlkLmVudHJpZXMoKSkubWFwKChbaWQsIGJsb2NrXSkgPT4gWwogICAgICAgICAgICBpZCwKICAgICAgICAgICAgY2xlYW5CbG9jayhibG9jaykKICAgICAgICAgIF0pLAogICAgICAgICAgbmFtZU1hcDogQXJyYXkuZnJvbSh0aGlzLm5hbWVNYXAuZW50cmllcygpKSwKICAgICAgICAgIGlkTWFwOiBBcnJheS5mcm9tKHRoaXMuaWRNYXAuZW50cmllcygpKQogICAgICAgIH0pCiAgICAgICk7CiAgICB9CiAgICBzdGF0aWMgZGVzZXJpYWxpemUoZGF0YSkgewogICAgICBjb25zdCByZWdpc3RyeTIgPSBuZXcgUmVnaXN0cnkoKTsKICAgICAgcmVnaXN0cnkyLmJsb2Nrc0J5TmFtZSA9IG5ldyBNYXAoZGF0YS5ibG9ja3NCeU5hbWUpOwogICAgICByZWdpc3RyeTIuYmxvY2tzQnlJZCA9IG5ldyBNYXAoZGF0YS5ibG9ja3NCeUlkKTsKICAgICAgcmVnaXN0cnkyLm5hbWVNYXAgPSBuZXcgTWFwKGRhdGEubmFtZU1hcCk7CiAgICAgIHJlZ2lzdHJ5Mi5pZE1hcCA9IG5ldyBNYXAoZGF0YS5pZE1hcCk7CiAgICAgIHJldHVybiByZWdpc3RyeTI7CiAgICB9CiAgfQogIGxldCByZWdpc3RyeTsKICBvbm1lc3NhZ2UgPSBmdW5jdGlvbihlKSB7CiAgICBjb25zdCB7IHR5cGUgfSA9IGUuZGF0YTsKICAgIGlmICh0eXBlICYmIHR5cGUudG9Mb3dlckNhc2UoKSA9PT0gImluaXQiKSB7CiAgICAgIHJlZ2lzdHJ5ID0gUmVnaXN0cnkuZGVzZXJpYWxpemUoZS5kYXRhLnJlZ2lzdHJ5RGF0YSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZ1bmN0aW9uIHZlcnRleEFPKHNpZGUxLCBzaWRlMiwgY29ybmVyKSB7CiAgICAgIGNvbnN0IG51bVMxID0gTnVtYmVyKCFzaWRlMSk7CiAgICAgIGNvbnN0IG51bVMyID0gTnVtYmVyKCFzaWRlMik7CiAgICAgIGNvbnN0IG51bUMgPSBOdW1iZXIoIWNvcm5lcik7CiAgICAgIGlmIChudW1TMSA9PT0gMSAmJiBudW1TMiA9PT0gMSkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CiAgICAgIHJldHVybiAzIC0gKG51bVMxICsgbnVtUzIgKyBudW1DKTsKICAgIH0KICAgIGNvbnN0IHsgY2h1bmtzRGF0YSwgbWluOiBtaW4yLCBtYXg6IG1heDIgfSA9IGUuZGF0YTsKICAgIGNvbnN0IHsgY2h1bmtTaXplIH0gPSBlLmRhdGEub3B0aW9uczsKICAgIGNvbnN0IGNodW5rcyA9IGNodW5rc0RhdGEubWFwKAogICAgICAoY2h1bmtEYXRhKSA9PiBjaHVua0RhdGEgPyBSYXdDaHVuay5kZXNlcmlhbGl6ZShjaHVua0RhdGEpIDogbnVsbAogICAgKTsKICAgIGNvbnN0IGdldENodW5rQnlDb29yZHMgPSAoY29vcmRzKSA9PiB7CiAgICAgIGNvbnN0IGNlbnRlckNvb3JkcyA9IGNodW5rc1s0XS5jb29yZHM7CiAgICAgIGNvbnN0IGR4ID0gY29vcmRzWzBdIC0gY2VudGVyQ29vcmRzWzBdOwogICAgICBjb25zdCBkeSA9IGNvb3Jkc1sxXSAtIGNlbnRlckNvb3Jkc1sxXTsKICAgICAgY29uc3QgaW5kZXggPSAoZHkgKyAxKSAqIDMgKyAoZHggKyAxKTsKICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSBjaHVua3MubGVuZ3RoKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGNvb3JkaW5hdGVzOiAke2Nvb3Jkc31gKTsKICAgICAgfQogICAgICByZXR1cm4gY2h1bmtzW2luZGV4XTsKICAgIH07CiAgICBjb25zdCBjaHVua0NhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGdldENhY2hlZENodW5rID0gKGNvb3JkcykgPT4gewogICAgICBjb25zdCBrZXkgPSBgJHtjb29yZHNbMF19LCR7Y29vcmRzWzFdfWA7CiAgICAgIGxldCBjaHVuayA9IGNodW5rQ2FjaGUuZ2V0KGtleSk7CiAgICAgIGlmIChjaHVuayA9PT0gdm9pZCAwKSB7CiAgICAgICAgY2h1bmsgPSBnZXRDaHVua0J5Q29vcmRzKGNvb3Jkcyk7CiAgICAgICAgY2h1bmtDYWNoZS5zZXQoa2V5LCBjaHVuayk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNodW5rOwogICAgfTsKICAgIGNvbnN0IGdldFZveGVsQXQgPSAodngsIHZ5LCB2eikgPT4gewogICAgICBjb25zdCBjb29yZHMgPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuayhbdngsIHZ5LCB2el0sIGNodW5rU2l6ZSk7CiAgICAgIGNvbnN0IGNodW5rID0gZ2V0Q2FjaGVkQ2h1bmsoY29vcmRzKTsKICAgICAgcmV0dXJuIChjaHVuayA9PSBudWxsID8gdm9pZCAwIDogY2h1bmsuZ2V0Vm94ZWwodngsIHZ5LCB2eikpID8/IDA7CiAgICB9OwogICAgY29uc3QgZ2V0U3VubGlnaHRBdCA9ICh2eCwgdnksIHZ6KSA9PiB7CiAgICAgIGNvbnN0IGNvb3JkcyA9IENodW5rVXRpbHMubWFwVm94ZWxUb0NodW5rKFt2eCwgdnksIHZ6XSwgY2h1bmtTaXplKTsKICAgICAgY29uc3QgY2h1bmsgPSBnZXRDYWNoZWRDaHVuayhjb29yZHMpOwogICAgICByZXR1cm4gKGNodW5rID09IG51bGwgPyB2b2lkIDAgOiBjaHVuay5nZXRTdW5saWdodCh2eCwgdnksIHZ6KSkgPz8gMDsKICAgIH07CiAgICBjb25zdCBnZXRUb3JjaGxpZ2h0QXQgPSAodngsIHZ5LCB2eiwgY29sb3IpID0+IHsKICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCBjaHVua1NpemUpOwogICAgICBjb25zdCBjaHVuayA9IGdldENhY2hlZENodW5rKGNvb3Jkcyk7CiAgICAgIHJldHVybiAoY2h1bmsgPT0gbnVsbCA/IHZvaWQgMCA6IGNodW5rLmdldFRvcmNoTGlnaHQodngsIHZ5LCB2eiwgY29sb3IpKSA/PyAwOwogICAgfTsKICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUxpZ2h0VmFsdWVzKHZ4LCB2eSwgdnosIGR4LCBkeSwgZHosIGRpciwgaXNTZWVUaHJvdWdoLCBpc0FsbFRyYW5zcGFyZW50KSB7CiAgICAgIGlmIChpc1NlZVRocm91Z2ggfHwgaXNBbGxUcmFuc3BhcmVudCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBzdW46IGdldFN1bmxpZ2h0QXQodngsIHZ5LCB2eiksCiAgICAgICAgICByZWQ6IGdldFRvcmNobGlnaHRBdCh2eCwgdnksIHZ6LCAiUkVEIiksCiAgICAgICAgICBncmVlbjogZ2V0VG9yY2hsaWdodEF0KHZ4LCB2eSwgdnosICJHUkVFTiIpLAogICAgICAgICAgYmx1ZTogZ2V0VG9yY2hsaWdodEF0KHZ4LCB2eSwgdnosICJCTFVFIikKICAgICAgICB9OwogICAgICB9CiAgICAgIGxldCBzdW1TdW5saWdodCA9IDA7CiAgICAgIGxldCBzdW1SZWRMaWdodCA9IDA7CiAgICAgIGxldCBzdW1HcmVlbkxpZ2h0ID0gMDsKICAgICAgbGV0IHN1bUJsdWVMaWdodCA9IDA7CiAgICAgIGxldCBjb3VudCA9IDA7CiAgICAgIGZvciAobGV0IHggPSAwOyB4IDw9IDE7IHgrKykgewogICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDw9IDE7IHkrKykgewogICAgICAgICAgZm9yIChsZXQgeiA9IDA7IHogPD0gMTsgeisrKSB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldFggPSB4ICogKGR4ID09PSAwID8gLTEgOiAxKTsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0WSA9IHkgKiAoZHkgPT09IDAgPyAtMSA6IDEpOwogICAgICAgICAgICBjb25zdCBvZmZzZXRaID0geiAqIChkeiA9PT0gMCA/IC0xIDogMSk7CiAgICAgICAgICAgIGNvbnN0IGxvY2FsU3VubGlnaHQgPSBnZXRTdW5saWdodEF0KAogICAgICAgICAgICAgIHZ4ICsgb2Zmc2V0WCwKICAgICAgICAgICAgICB2eSArIG9mZnNldFksCiAgICAgICAgICAgICAgdnogKyBvZmZzZXRaCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IGxvY2FsUmVkTGlnaHQgPSBnZXRUb3JjaGxpZ2h0QXQoCiAgICAgICAgICAgICAgdnggKyBvZmZzZXRYLAogICAgICAgICAgICAgIHZ5ICsgb2Zmc2V0WSwKICAgICAgICAgICAgICB2eiArIG9mZnNldFosCiAgICAgICAgICAgICAgIlJFRCIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgbG9jYWxHcmVlbkxpZ2h0ID0gZ2V0VG9yY2hsaWdodEF0KAogICAgICAgICAgICAgIHZ4ICsgb2Zmc2V0WCwKICAgICAgICAgICAgICB2eSArIG9mZnNldFksCiAgICAgICAgICAgICAgdnogKyBvZmZzZXRaLAogICAgICAgICAgICAgICJHUkVFTiIKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgbG9jYWxCbHVlTGlnaHQgPSBnZXRUb3JjaGxpZ2h0QXQoCiAgICAgICAgICAgICAgdnggKyBvZmZzZXRYLAogICAgICAgICAgICAgIHZ5ICsgb2Zmc2V0WSwKICAgICAgICAgICAgICB2eiArIG9mZnNldFosCiAgICAgICAgICAgICAgIkJMVUUiCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmIChsb2NhbFN1bmxpZ2h0ID09IDAgJiYgbG9jYWxSZWRMaWdodCA9PSAwICYmIGxvY2FsR3JlZW5MaWdodCA9PSAwICYmIGxvY2FsQmx1ZUxpZ2h0ID09IDApIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBkaWFnb25hbDRJZCA9IGdldFZveGVsQXQoCiAgICAgICAgICAgICAgdnggKyBvZmZzZXRYLAogICAgICAgICAgICAgIHZ5ICsgb2Zmc2V0WSwKICAgICAgICAgICAgICB2eiArIG9mZnNldFoKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29uc3QgZGlhZ29uYWw0ID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQoZGlhZ29uYWw0SWQpOwogICAgICAgICAgICBpZiAoZGlhZ29uYWw0LmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpclswXSAqIG9mZnNldFggKyBkaXJbMV0gKiBvZmZzZXRZICsgZGlyWzJdICogb2Zmc2V0WiA9PT0gMCkgewogICAgICAgICAgICAgIGNvbnN0IGZhY2luZ0lkID0gZ2V0Vm94ZWxBdCgKICAgICAgICAgICAgICAgIHZ4ICsgb2Zmc2V0WCAqIGRpclswXSwKICAgICAgICAgICAgICAgIHZ5ICsgb2Zmc2V0WSAqIGRpclsxXSwKICAgICAgICAgICAgICAgIHZ6ICsgb2Zmc2V0WiAqIGRpclsyXQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgY29uc3QgZmFjaW5nID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQoZmFjaW5nSWQpOwogICAgICAgICAgICAgIGlmIChmYWNpbmcuaXNPcGFxdWUpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBhYnNTdW0gPSBNYXRoLmFicyhvZmZzZXRYKSArIE1hdGguYWJzKG9mZnNldFkpICsgTWF0aC5hYnMob2Zmc2V0Wik7CiAgICAgICAgICAgIGlmIChhYnNTdW0gPT09IDMpIHsKICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbFlaSWQgPSBnZXRWb3hlbEF0KHZ4LCB2eSArIG9mZnNldFksIHZ6ICsgb2Zmc2V0Wik7CiAgICAgICAgICAgICAgY29uc3QgZGlhZ29uYWxYWklkID0gZ2V0Vm94ZWxBdCh2eCArIG9mZnNldFgsIHZ5LCB2eiArIG9mZnNldFopOwogICAgICAgICAgICAgIGNvbnN0IGRpYWdvbmFsWFlJZCA9IGdldFZveGVsQXQodnggKyBvZmZzZXRYLCB2eSArIG9mZnNldFksIHZ6KTsKICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbFlaID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQoZGlhZ29uYWxZWklkKTsKICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbFhaID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQoZGlhZ29uYWxYWklkKTsKICAgICAgICAgICAgICBjb25zdCBkaWFnb25hbFhZID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQoZGlhZ29uYWxYWUlkKTsKICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxZWi5pc09wYXF1ZSAmJiBkaWFnb25hbFhaLmlzT3BhcXVlICYmIGRpYWdvbmFsWFkuaXNPcGFxdWUpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxYWS5pc09wYXF1ZSAmJiBkaWFnb25hbFhaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvcllJZCA9IGdldFZveGVsQXQodngsIHZ5ICsgb2Zmc2V0WSwgdnopOwogICAgICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JaSWQgPSBnZXRWb3hlbEF0KHZ4LCB2eSwgdnogKyBvZmZzZXRaKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWSA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWUlkKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWiA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWklkKTsKICAgICAgICAgICAgICAgIGlmIChuZWlnaGJvclkuaXNPcGFxdWUgJiYgbmVpZ2hib3JaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxYWS5pc09wYXF1ZSAmJiBkaWFnb25hbFlaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvclhJZCA9IGdldFZveGVsQXQodnggKyBvZmZzZXRYLCB2eSwgdnopOwogICAgICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JaSWQgPSBnZXRWb3hlbEF0KHZ4LCB2eSwgdnogKyBvZmZzZXRaKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWCA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWElkKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWiA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWklkKTsKICAgICAgICAgICAgICAgIGlmIChuZWlnaGJvclguaXNPcGFxdWUgJiYgbmVpZ2hib3JaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlhZ29uYWxYWi5pc09wYXF1ZSAmJiBkaWFnb25hbFlaLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZWlnaGJvclhJZCA9IGdldFZveGVsQXQodnggKyBvZmZzZXRYLCB2eSwgdnopOwogICAgICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JZSWQgPSBnZXRWb3hlbEF0KHZ4LCB2eSArIG9mZnNldFksIHZ6KTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWCA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWElkKTsKICAgICAgICAgICAgICAgIGNvbnN0IG5laWdoYm9yWSA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yWUlkKTsKICAgICAgICAgICAgICAgIGlmIChuZWlnaGJvclguaXNPcGFxdWUgJiYgbmVpZ2hib3JZLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzdW1TdW5saWdodCArPSBsb2NhbFN1bmxpZ2h0OwogICAgICAgICAgICBzdW1SZWRMaWdodCArPSBsb2NhbFJlZExpZ2h0OwogICAgICAgICAgICBzdW1HcmVlbkxpZ2h0ICs9IGxvY2FsR3JlZW5MaWdodDsKICAgICAgICAgICAgc3VtQmx1ZUxpZ2h0ICs9IGxvY2FsQmx1ZUxpZ2h0OwogICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY291bnQgPT09IDApIHsKICAgICAgICByZXR1cm4geyBzdW46IDAsIHJlZDogMCwgZ3JlZW46IDAsIGJsdWU6IDAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHN1bjogc3VtU3VubGlnaHQgLyBjb3VudCwKICAgICAgICByZWQ6IHN1bVJlZExpZ2h0IC8gY291bnQsCiAgICAgICAgZ3JlZW46IHN1bUdyZWVuTGlnaHQgLyBjb3VudCwKICAgICAgICBibHVlOiBzdW1CbHVlTGlnaHQgLyBjb3VudAogICAgICB9OwogICAgfQogICAgY29uc3QgZ2V0Vm94ZWxSb3RhdGlvbkF0ID0gKHZ4LCB2eSwgdnopID0+IHsKICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCBjaHVua1NpemUpOwogICAgICBjb25zdCBjaHVuayA9IGdldENhY2hlZENodW5rKGNvb3Jkcyk7CiAgICAgIHJldHVybiAoY2h1bmsgPT0gbnVsbCA/IHZvaWQgMCA6IGNodW5rLmdldFZveGVsUm90YXRpb24odngsIHZ5LCB2eikpID8/IG5ldyBCbG9ja1JvdGF0aW9uKCk7CiAgICB9OwogICAgY29uc3QgZ2V0Vm94ZWxTdGFnZUF0ID0gKHZ4LCB2eSwgdnopID0+IHsKICAgICAgY29uc3QgY29vcmRzID0gQ2h1bmtVdGlscy5tYXBWb3hlbFRvQ2h1bmsoW3Z4LCB2eSwgdnpdLCBjaHVua1NpemUpOwogICAgICBjb25zdCBjaHVuayA9IGdldENhY2hlZENodW5rKGNvb3Jkcyk7CiAgICAgIHJldHVybiAoY2h1bmsgPT0gbnVsbCA/IHZvaWQgMCA6IGNodW5rLmdldFZveGVsU3RhZ2UodngsIHZ5LCB2eikpID8/IDA7CiAgICB9OwogICAgY29uc3QgW21pblgsIG1pblksIG1pblpdID0gbWluMjsKICAgIGNvbnN0IFttYXhYLCBtYXhZLCBtYXhaXSA9IG1heDI7CiAgICBjb25zdCBnZW9tZXRyaWVzID0ge307CiAgICBjb25zdCBkaXJlY3Rpb25zID0gWwogICAgICBbLTEsIDAsIDBdLAogICAgICBbMSwgMCwgMF0sCiAgICAgIFswLCAtMSwgMF0sCiAgICAgIFswLCAxLCAwXSwKICAgICAgWzAsIDAsIC0xXSwKICAgICAgWzAsIDAsIDFdCiAgICBdOwogICAgZm9yIChsZXQgdnggPSBtaW5YOyB2eCA8IG1heFg7IHZ4KyspIHsKICAgICAgZm9yIChsZXQgdnogPSBtaW5aOyB2eiA8IG1heFo7IHZ6KyspIHsKICAgICAgICBmb3IgKGxldCB2eSA9IG1pblk7IHZ5IDwgbWF4WTsgdnkrKykgewogICAgICAgICAgY29uc3Qgdm94ZWwgPSBnZXRWb3hlbEF0KHZ4LCB2eSwgdnopOwogICAgICAgICAgY29uc3Qgcm90YXRpb24gPSBnZXRWb3hlbFJvdGF0aW9uQXQodngsIHZ5LCB2eik7CiAgICAgICAgICBjb25zdCBibG9jayA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KHZveGVsKTsKICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgaWQsCiAgICAgICAgICAgIGlzU2VlVGhyb3VnaCwKICAgICAgICAgICAgaXNFbXB0eSwKICAgICAgICAgICAgaXNPcGFxdWUsCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIHJvdGF0YWJsZSwKICAgICAgICAgICAgeVJvdGF0YWJsZSwKICAgICAgICAgICAgaXNEeW5hbWljLAogICAgICAgICAgICBkeW5hbWljUGF0dGVybnMsCiAgICAgICAgICAgIGlzVHJhbnNwYXJlbnQKICAgICAgICAgIH0gPSBibG9jazsKICAgICAgICAgIGxldCBhYWJicyA9IGJsb2NrLmFhYmJzOwogICAgICAgICAgbGV0IGZhY2VzID0gYmxvY2suZmFjZXM7CiAgICAgICAgICBpZiAoaXNEeW5hbWljICYmICFkeW5hbWljUGF0dGVybnMgfHwgaXNFbXB0eSB8fCBmYWNlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZHluYW1pY1BhdHRlcm5zKSB7CiAgICAgICAgICAgIGZhY2VzID0gW107CiAgICAgICAgICAgIGFhYmJzID0gW107CiAgICAgICAgICAgIGxldCBwYXR0ZXJuc01hdGNoZWQgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChjb25zdCBkeW5hbWljUGF0dGVybiBvZiBkeW5hbWljUGF0dGVybnMpIHsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgZHluYW1pY1BhdHRlcm4ucGFydHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhcnRNYXRjaGVkID0gQmxvY2tVdGlscy5ldmFsdWF0ZUJsb2NrUnVsZSgKICAgICAgICAgICAgICAgICAgcGFydC5ydWxlLAogICAgICAgICAgICAgICAgICBbdngsIHZ5LCB2el0sCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBnZXRWb3hlbEF0LAogICAgICAgICAgICAgICAgICAgIGdldFZveGVsUm90YXRpb25BdCwKICAgICAgICAgICAgICAgICAgICBnZXRWb3hlbFN0YWdlQXQKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0TWF0Y2hlZCkgewogICAgICAgICAgICAgICAgICBwYXR0ZXJuc01hdGNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICBmYWNlcyA9IFsuLi5mYWNlcywgLi4ucGFydC5mYWNlc107CiAgICAgICAgICAgICAgICAgIGFhYmJzID0gWy4uLmFhYmJzLCAuLi5wYXJ0LmFhYmJzXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhdHRlcm5zTWF0Y2hlZCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpc1N1cnJvdW5kZWQgPSAhZGlyZWN0aW9ucy5zb21lKChbZHgsIGR5LCBkel0pID0+IHsKICAgICAgICAgICAgdmFyIF9hOwogICAgICAgICAgICBjb25zdCBuZWlnaGJvciA9IGdldFZveGVsQXQodnggKyBkeCwgdnkgKyBkeSwgdnogKyBkeik7CiAgICAgICAgICAgIHJldHVybiAhKChfYSA9IHJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KG5laWdoYm9yKSkgPT0gbnVsbCA/IHZvaWQgMCA6IF9hLmlzT3BhcXVlKTsKICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGlzU3Vycm91bmRlZCkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGlzQWxsVHJhbnNwYXJlbnQgPSBpc1RyYW5zcGFyZW50WzBdICYmIGlzVHJhbnNwYXJlbnRbMV0gJiYgaXNUcmFuc3BhcmVudFsyXSAmJiBpc1RyYW5zcGFyZW50WzNdICYmIGlzVHJhbnNwYXJlbnRbNF0gJiYgaXNUcmFuc3BhcmVudFs1XTsKICAgICAgICAgIGNvbnN0IHV2TWFwID0ge307CiAgICAgICAgICBmb3IgKGNvbnN0IGZhY2Ugb2YgZmFjZXMpIHsKICAgICAgICAgICAgdXZNYXBbZmFjZS5uYW1lXSA9IGZhY2UucmFuZ2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKGNvbnN0IGZhY2Ugb2YgZmFjZXMpIHsKICAgICAgICAgICAgY29uc3Qga2V5ID0gZmFjZS5pc29sYXRlZCA/IGAke25hbWUudG9Mb3dlckNhc2UoKX06OiR7ZmFjZS5uYW1lLnRvTG93ZXJDYXNlKCl9Ojoke3Z4fS0ke3Z5fS0ke3Z6fWAgOiBmYWNlLmluZGVwZW5kZW50ID8gYCR7bmFtZS50b0xvd2VyQ2FzZSgpfTo6JHtmYWNlLm5hbWUudG9Mb3dlckNhc2UoKX1gIDogbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBjb25zdCBnZW9tZXRyeSA9IGdlb21ldHJpZXNba2V5XSA/PyB7CiAgICAgICAgICAgICAgbGlnaHRzOiBbXSwKICAgICAgICAgICAgICB2b3hlbDogaWQsCiAgICAgICAgICAgICAgcG9zaXRpb25zOiBbXSwKICAgICAgICAgICAgICB1dnM6IFtdLAogICAgICAgICAgICAgIGluZGljZXM6IFtdCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChmYWNlLmluZGVwZW5kZW50IHx8IGZhY2UuaXNvbGF0ZWQpIHsKICAgICAgICAgICAgICBnZW9tZXRyeS5mYWNlTmFtZSA9IGZhY2UubmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFjZS5pc29sYXRlZCkgewogICAgICAgICAgICAgIGdlb21ldHJ5LmF0ID0gW3Z4LCB2eSwgdnpdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHsgZGlyOiBmYWNlRGlyLCBjb3JuZXJzIH0gPSBmYWNlOwogICAgICAgICAgICBjb25zdCBkaXIgPSBbLi4uZmFjZURpcl07CiAgICAgICAgICAgIGlmIChyb3RhdGFibGUgfHwgeVJvdGF0YWJsZSkgewogICAgICAgICAgICAgIHJvdGF0aW9uLnJvdGF0ZU5vZGUoZGlyLCB5Um90YXRhYmxlLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlyWzBdID0gTWF0aC5yb3VuZChkaXJbMF0pOwogICAgICAgICAgICBkaXJbMV0gPSBNYXRoLnJvdW5kKGRpclsxXSk7CiAgICAgICAgICAgIGRpclsyXSA9IE1hdGgucm91bmQoZGlyWzJdKTsKICAgICAgICAgICAgY29uc3QgbnZ4ID0gdnggKyBkaXJbMF07CiAgICAgICAgICAgIGNvbnN0IG52eSA9IHZ5ICsgZGlyWzFdOwogICAgICAgICAgICBjb25zdCBudnogPSB2eiArIGRpclsyXTsKICAgICAgICAgICAgY29uc3QgbmVpZ2hib3JJZCA9IGdldFZveGVsQXQobnZ4LCBudnksIG52eik7CiAgICAgICAgICAgIGNvbnN0IG5Db29yZHMgPSBDaHVua1V0aWxzLm1hcFZveGVsVG9DaHVuaygKICAgICAgICAgICAgICBbbnZ4LCBudnksIG52el0sCiAgICAgICAgICAgICAgY2h1bmtTaXplCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnN0IG5Jc1ZvaWQgPSAhZ2V0Q2h1bmtCeUNvb3JkcyhuQ29vcmRzKTsKICAgICAgICAgICAgY29uc3QgbkJsb2NrID0gcmVnaXN0cnkuYmxvY2tzQnlJZC5nZXQobmVpZ2hib3JJZCk7CiAgICAgICAgICAgIGxldCBzZWVUaHJvdWdoQ2hlY2sgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGlzU2VlVGhyb3VnaCAmJiAhaXNPcGFxdWUgJiYgbkJsb2NrLmlzT3BhcXVlKSB7CiAgICAgICAgICAgICAgbGV0IHNlbGZCb3VuZGluZyA9IGFhYmJzWzBdIHx8IG5ldyBBQUJCKDAsIDAsIDAsIDEsIDEsIDEpOwogICAgICAgICAgICAgIGxldCBuQm91bmRpbmcgPSBuQmxvY2suYWFiYnNbMF0gfHwgbmV3IEFBQkIoMCwgMCwgMCwgMSwgMSwgMSk7CiAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBhYWJicy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgYWFiYiA9IGFhYmJzW2ldOwogICAgICAgICAgICAgICAgc2VsZkJvdW5kaW5nID0gbmV3IEFBQkIoCiAgICAgICAgICAgICAgICAgIE1hdGgubWluKHNlbGZCb3VuZGluZy5taW5YLCBhYWJiLm1pblgpLAogICAgICAgICAgICAgICAgICBNYXRoLm1pbihzZWxmQm91bmRpbmcubWluWSwgYWFiYi5taW5ZKSwKICAgICAgICAgICAgICAgICAgTWF0aC5taW4oc2VsZkJvdW5kaW5nLm1pblosIGFhYmIubWluWiksCiAgICAgICAgICAgICAgICAgIE1hdGgubWF4KHNlbGZCb3VuZGluZy5tYXhYLCBhYWJiLm1heFgpLAogICAgICAgICAgICAgICAgICBNYXRoLm1heChzZWxmQm91bmRpbmcubWF4WSwgYWFiYi5tYXhZKSwKICAgICAgICAgICAgICAgICAgTWF0aC5tYXgoc2VsZkJvdW5kaW5nLm1heFosIGFhYmIubWF4WikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbkJsb2NrLmFhYmJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhYWJiID0gbkJsb2NrLmFhYmJzW2ldOwogICAgICAgICAgICAgICAgbkJvdW5kaW5nID0gbmV3IEFBQkIoCiAgICAgICAgICAgICAgICAgIE1hdGgubWluKG5Cb3VuZGluZy5taW5YLCBhYWJiLm1pblgpLAogICAgICAgICAgICAgICAgICBNYXRoLm1pbihuQm91bmRpbmcubWluWSwgYWFiYi5taW5ZKSwKICAgICAgICAgICAgICAgICAgTWF0aC5taW4obkJvdW5kaW5nLm1pblosIGFhYmIubWluWiksCiAgICAgICAgICAgICAgICAgIE1hdGgubWF4KG5Cb3VuZGluZy5tYXhYLCBhYWJiLm1heFgpLAogICAgICAgICAgICAgICAgICBNYXRoLm1heChuQm91bmRpbmcubWF4WSwgYWFiYi5tYXhZKSwKICAgICAgICAgICAgICAgICAgTWF0aC5tYXgobkJvdW5kaW5nLm1heFosIGFhYmIubWF4WikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IHRyYW5zbGF0ZWRCb3VuZGluZyA9IG5ldyBBQUJCKAogICAgICAgICAgICAgICAgbkJvdW5kaW5nLm1pblggKyBkaXJbMF0sCiAgICAgICAgICAgICAgICBuQm91bmRpbmcubWluWSArIGRpclsxXSwKICAgICAgICAgICAgICAgIG5Cb3VuZGluZy5taW5aICsgZGlyWzJdLAogICAgICAgICAgICAgICAgbkJvdW5kaW5nLm1heFggKyBkaXJbMF0sCiAgICAgICAgICAgICAgICBuQm91bmRpbmcubWF4WSArIGRpclsxXSwKICAgICAgICAgICAgICAgIG5Cb3VuZGluZy5tYXhaICsgZGlyWzJdCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBjb25zdCBpbnRlcnNlY3RzID0gISh0cmFuc2xhdGVkQm91bmRpbmcubWF4WCA8IHNlbGZCb3VuZGluZy5taW5YIHx8IHRyYW5zbGF0ZWRCb3VuZGluZy5taW5YID4gc2VsZkJvdW5kaW5nLm1heFggfHwgdHJhbnNsYXRlZEJvdW5kaW5nLm1heFkgPCBzZWxmQm91bmRpbmcubWluWSB8fCB0cmFuc2xhdGVkQm91bmRpbmcubWluWSA+IHNlbGZCb3VuZGluZy5tYXhZIHx8IHRyYW5zbGF0ZWRCb3VuZGluZy5tYXhaIDwgc2VsZkJvdW5kaW5nLm1pblogfHwgdHJhbnNsYXRlZEJvdW5kaW5nLm1pblogPiBzZWxmQm91bmRpbmcubWF4Wik7CiAgICAgICAgICAgICAgY29uc3QgdG91Y2hlcyA9IHRyYW5zbGF0ZWRCb3VuZGluZy5tYXhYID09PSBzZWxmQm91bmRpbmcubWluWCB8fCB0cmFuc2xhdGVkQm91bmRpbmcubWluWCA9PT0gc2VsZkJvdW5kaW5nLm1heFggfHwgdHJhbnNsYXRlZEJvdW5kaW5nLm1heFkgPT09IHNlbGZCb3VuZGluZy5taW5ZIHx8IHRyYW5zbGF0ZWRCb3VuZGluZy5taW5ZID09PSBzZWxmQm91bmRpbmcubWF4WSB8fCB0cmFuc2xhdGVkQm91bmRpbmcubWF4WiA9PT0gc2VsZkJvdW5kaW5nLm1pblogfHwgdHJhbnNsYXRlZEJvdW5kaW5nLm1pblogPT09IHNlbGZCb3VuZGluZy5tYXhaOwogICAgICAgICAgICAgIGlmICghKGludGVyc2VjdHMgfHwgdG91Y2hlcykpIHsKICAgICAgICAgICAgICAgIHNlZVRocm91Z2hDaGVjayA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuSXNWb2lkICYmIG5CbG9jay5pc0VtcHR5IHx8IGlzU2VlVGhyb3VnaCAmJiAhaXNPcGFxdWUgJiYgIW5CbG9jay5pc09wYXF1ZSAmJiAoaXNTZWVUaHJvdWdoICYmIG5laWdoYm9ySWQgPT0gaWQgJiYgbkJsb2NrLnRyYW5zcGFyZW50U3RhbmRhbG9uZSB8fCBuZWlnaGJvcklkICE9IGlkICYmIChpc1NlZVRocm91Z2ggfHwgbkJsb2NrLmlzU2VlVGhyb3VnaCkgfHwgc2VlVGhyb3VnaENoZWNrKSB8fCAhaXNTZWVUaHJvdWdoICYmICghaXNPcGFxdWUgfHwgIW5CbG9jay5pc09wYXF1ZSkpIHsKICAgICAgICAgICAgICBjb25zdCB7IHN0YXJ0VSwgc3RhcnRWLCBlbmRVLCBlbmRWIH0gPSB1dk1hcFtmYWNlLm5hbWVdOwogICAgICAgICAgICAgIGNvbnN0IG5keCA9IE1hdGguZmxvb3IoZ2VvbWV0cnkucG9zaXRpb25zLmxlbmd0aCAvIDMpOwogICAgICAgICAgICAgIGNvbnN0IGZhY2VBT3MgPSBbXTsKICAgICAgICAgICAgICBjb25zdCBmb3VyTGlnaHRzID0gW1tdLCBbXSwgW10sIFtdXTsKICAgICAgICAgICAgICBmb3IgKGNvbnN0IHsgcG9zOiBjb3JuZXJQb3MsIHV2IH0gb2YgY29ybmVycykgewogICAgICAgICAgICAgICAgY29uc3QgcG9zID0gWy4uLmNvcm5lclBvc107CiAgICAgICAgICAgICAgICBpZiAocm90YXRhYmxlIHx8IHlSb3RhdGFibGUpIHsKICAgICAgICAgICAgICAgICAgcm90YXRpb24ucm90YXRlTm9kZShwb3MsIHlSb3RhdGFibGUsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcG9zWCA9IHZ4ICsgcG9zWzBdOwogICAgICAgICAgICAgICAgY29uc3QgcG9zWSA9IHZ5ICsgcG9zWzFdOwogICAgICAgICAgICAgICAgY29uc3QgcG9zWiA9IHZ6ICsgcG9zWzJdOwogICAgICAgICAgICAgICAgY29uc3Qgc2NhbGUyID0gaXNPcGFxdWUgPyAwIDogMWUtNDsKICAgICAgICAgICAgICAgIGdlb21ldHJ5LnBvc2l0aW9ucy5wdXNoKAogICAgICAgICAgICAgICAgICBwb3NYIC0gbWluWCAtIGRpclswXSAqIHNjYWxlMiwKICAgICAgICAgICAgICAgICAgcG9zWSAtIG1pblkgLSBkaXJbMV0gKiBzY2FsZTIsCiAgICAgICAgICAgICAgICAgIHBvc1ogLSBtaW5aIC0gZGlyWzJdICogc2NhbGUyCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgZ2VvbWV0cnkudXZzLnB1c2goCiAgICAgICAgICAgICAgICAgIHV2WzBdICogKGVuZFUgLSBzdGFydFUpICsgc3RhcnRVLAogICAgICAgICAgICAgICAgICB1dlsxXSAqIChlbmRWIC0gc3RhcnRWKSArIHN0YXJ0VgogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGNvbnN0IGR4ID0gTWF0aC5yb3VuZChwb3NbMF0pOwogICAgICAgICAgICAgICAgY29uc3QgZHkgPSBNYXRoLnJvdW5kKHBvc1sxXSk7CiAgICAgICAgICAgICAgICBjb25zdCBkeiA9IE1hdGgucm91bmQocG9zWzJdKTsKICAgICAgICAgICAgICAgIGNvbnN0IHVuaXREeCA9IGR4ID09PSAwID8gLTEgOiAxOwogICAgICAgICAgICAgICAgY29uc3QgdW5pdER5ID0gZHkgPT09IDAgPyAtMSA6IDE7CiAgICAgICAgICAgICAgICBjb25zdCB1bml0RHogPSBkeiA9PT0gMCA/IC0xIDogMTsKICAgICAgICAgICAgICAgIGNvbnN0IGIwMTFJZCA9IGdldFZveGVsQXQodnggKyAwLCB2eSArIHVuaXREeSwgdnogKyB1bml0RHopOwogICAgICAgICAgICAgICAgY29uc3QgYjEwMUlkID0gZ2V0Vm94ZWxBdCh2eCArIHVuaXREeCwgdnkgKyAwLCB2eiArIHVuaXREeik7CiAgICAgICAgICAgICAgICBjb25zdCBiMTEwSWQgPSBnZXRWb3hlbEF0KHZ4ICsgdW5pdER4LCB2eSArIHVuaXREeSwgdnogKyAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IGIxMTFJZCA9IGdldFZveGVsQXQodnggKyB1bml0RHgsIHZ5ICsgdW5pdER5LCB2eiArIHVuaXREeik7CiAgICAgICAgICAgICAgICBjb25zdCBiMDExID0gIXJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KGIwMTFJZCkuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICBjb25zdCBiMTAxID0gIXJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KGIxMDFJZCkuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICBjb25zdCBiMTEwID0gIXJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KGIxMTBJZCkuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICBjb25zdCBiMTExID0gIXJlZ2lzdHJ5LmJsb2Nrc0J5SWQuZ2V0KGIxMTFJZCkuaXNPcGFxdWU7CiAgICAgICAgICAgICAgICBjb25zdCBhbyA9IGlzU2VlVGhyb3VnaCB8fCBpc0FsbFRyYW5zcGFyZW50ID8gMyA6IE1hdGguYWJzKGRpclswXSkgPT09IDEgPyB2ZXJ0ZXhBTyhiMTEwLCBiMTAxLCBiMTExKSA6IE1hdGguYWJzKGRpclsxXSkgPT09IDEgPyB2ZXJ0ZXhBTyhiMTEwLCBiMDExLCBiMTExKSA6IHZlcnRleEFPKGIwMTEsIGIxMDEsIGIxMTEpOwogICAgICAgICAgICAgICAgY29uc3QgbGlnaHRWYWx1ZXMgPSBjYWxjdWxhdGVMaWdodFZhbHVlcygKICAgICAgICAgICAgICAgICAgdngsCiAgICAgICAgICAgICAgICAgIHZ5LAogICAgICAgICAgICAgICAgICB2eiwKICAgICAgICAgICAgICAgICAgZHgsCiAgICAgICAgICAgICAgICAgIGR5LAogICAgICAgICAgICAgICAgICBkeiwKICAgICAgICAgICAgICAgICAgZGlyLAogICAgICAgICAgICAgICAgICBpc1NlZVRocm91Z2gsCiAgICAgICAgICAgICAgICAgIGlzQWxsVHJhbnNwYXJlbnQKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBsZXQgbGlnaHQgPSAwOwogICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydFJlZExpZ2h0KGxpZ2h0LCBsaWdodFZhbHVlcy5yZWQpOwogICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydEdyZWVuTGlnaHQobGlnaHQsIGxpZ2h0VmFsdWVzLmdyZWVuKTsKICAgICAgICAgICAgICAgIGxpZ2h0ID0gTGlnaHRVdGlscy5pbnNlcnRCbHVlTGlnaHQobGlnaHQsIGxpZ2h0VmFsdWVzLmJsdWUpOwogICAgICAgICAgICAgICAgbGlnaHQgPSBMaWdodFV0aWxzLmluc2VydFN1bmxpZ2h0KGxpZ2h0LCBsaWdodFZhbHVlcy5zdW4pOwogICAgICAgICAgICAgICAgZ2VvbWV0cnkubGlnaHRzLnB1c2goTWF0aC5mbG9vcihsaWdodCkgfCBhbyA8PCAxNik7CiAgICAgICAgICAgICAgICBmb3VyTGlnaHRzWzBdLnB1c2gobGlnaHRWYWx1ZXMuc3VuKTsKICAgICAgICAgICAgICAgIGZvdXJMaWdodHNbMV0ucHVzaChsaWdodFZhbHVlcy5yZWQpOwogICAgICAgICAgICAgICAgZm91ckxpZ2h0c1syXS5wdXNoKGxpZ2h0VmFsdWVzLmdyZWVuKTsKICAgICAgICAgICAgICAgIGZvdXJMaWdodHNbM10ucHVzaChsaWdodFZhbHVlcy5ibHVlKTsKICAgICAgICAgICAgICAgIGZhY2VBT3MucHVzaChhbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnN0IGFSdCA9IGZvdXJMaWdodHNbMV1bMF07CiAgICAgICAgICAgICAgY29uc3QgYlJ0ID0gZm91ckxpZ2h0c1sxXVsxXTsKICAgICAgICAgICAgICBjb25zdCBjUnQgPSBmb3VyTGlnaHRzWzFdWzJdOwogICAgICAgICAgICAgIGNvbnN0IGRSdCA9IGZvdXJMaWdodHNbMV1bM107CiAgICAgICAgICAgICAgY29uc3QgYUd0ID0gZm91ckxpZ2h0c1syXVswXTsKICAgICAgICAgICAgICBjb25zdCBiR3QgPSBmb3VyTGlnaHRzWzJdWzFdOwogICAgICAgICAgICAgIGNvbnN0IGNHdCA9IGZvdXJMaWdodHNbMl1bMl07CiAgICAgICAgICAgICAgY29uc3QgZEd0ID0gZm91ckxpZ2h0c1syXVszXTsKICAgICAgICAgICAgICBjb25zdCBhQnQgPSBmb3VyTGlnaHRzWzNdWzBdOwogICAgICAgICAgICAgIGNvbnN0IGJCdCA9IGZvdXJMaWdodHNbM11bMV07CiAgICAgICAgICAgICAgY29uc3QgY0J0ID0gZm91ckxpZ2h0c1szXVsyXTsKICAgICAgICAgICAgICBjb25zdCBkQnQgPSBmb3VyTGlnaHRzWzNdWzNdOwogICAgICAgICAgICAgIGNvbnN0IHRocmVzaG9sZCA9IDA7CiAgICAgICAgICAgICAgY29uc3Qgb25lVHIwID0gYVJ0IDw9IHRocmVzaG9sZCB8fCBiUnQgPD0gdGhyZXNob2xkIHx8IGNSdCA8PSB0aHJlc2hvbGQgfHwgZFJ0IDw9IHRocmVzaG9sZDsKICAgICAgICAgICAgICBjb25zdCBvbmVUZzAgPSBhR3QgPD0gdGhyZXNob2xkIHx8IGJHdCA8PSB0aHJlc2hvbGQgfHwgY0d0IDw9IHRocmVzaG9sZCB8fCBkR3QgPD0gdGhyZXNob2xkOwogICAgICAgICAgICAgIGNvbnN0IG9uZVRiMCA9IGFCdCA8PSB0aHJlc2hvbGQgfHwgYkJ0IDw9IHRocmVzaG9sZCB8fCBjQnQgPD0gdGhyZXNob2xkIHx8IGRCdCA8PSB0aHJlc2hvbGQ7CiAgICAgICAgICAgICAgY29uc3QgZkVxdWFscyA9IGZhY2VBT3NbMF0gKyBmYWNlQU9zWzNdID09IGZhY2VBT3NbMV0gKyBmYWNlQU9zWzJdOwogICAgICAgICAgICAgIGNvbnN0IG96YW9SID0gYVJ0ICsgZFJ0IDwgYlJ0ICsgY1J0ICYmIGZFcXVhbHM7CiAgICAgICAgICAgICAgY29uc3Qgb3phb0cgPSBhR3QgKyBkR3QgPCBiR3QgKyBjR3QgJiYgZkVxdWFsczsKICAgICAgICAgICAgICBjb25zdCBvemFvQiA9IGFCdCArIGRCdCA8IGJCdCArIGNCdCAmJiBmRXF1YWxzOwogICAgICAgICAgICAgIGNvbnN0IGFuenAxUiA9IGJSdCA+IChhUnQgKyBkUnQpIC8gMiAmJiAoYVJ0ICsgZFJ0KSAvIDIgPiBjUnQgfHwgY1J0ID4gKGFSdCArIGRSdCkgLyAyICYmIChhUnQgKyBkUnQpIC8gMiA+IGJSdDsKICAgICAgICAgICAgICBjb25zdCBhbnpwMUcgPSBiR3QgPiAoYUd0ICsgZEd0KSAvIDIgJiYgKGFHdCArIGRHdCkgLyAyID4gY0d0IHx8IGNHdCA+IChhR3QgKyBkR3QpIC8gMiAmJiAoYUd0ICsgZEd0KSAvIDIgPiBiR3Q7CiAgICAgICAgICAgICAgY29uc3QgYW56cDFCID0gYkJ0ID4gKGFCdCArIGRCdCkgLyAyICYmIChhQnQgKyBkQnQpIC8gMiA+IGNCdCB8fCBjQnQgPiAoYUJ0ICsgZEJ0KSAvIDIgJiYgKGFCdCArIGRCdCkgLyAyID4gYkJ0OwogICAgICAgICAgICAgIGNvbnN0IGFuelIgPSBvbmVUcjAgJiYgYW56cDFSOwogICAgICAgICAgICAgIGNvbnN0IGFuekcgPSBvbmVUZzAgJiYgYW56cDFHOwogICAgICAgICAgICAgIGNvbnN0IGFuekIgPSBvbmVUYjAgJiYgYW56cDFCOwogICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHgpOwogICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAxKTsKICAgICAgICAgICAgICBpZiAoZmFjZUFPc1swXSArIGZhY2VBT3NbM10gPiBmYWNlQU9zWzFdICsgZmFjZUFPc1syXSB8fCBvemFvUiB8fCBvemFvRyB8fCBvemFvQiB8fCBhbnpSIHx8IGFuekcgfHwgYW56QikgewogICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDMpOwogICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDMpOwogICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCArIDIpOwogICAgICAgICAgICAgICAgZ2VvbWV0cnkuaW5kaWNlcy5wdXNoKG5keCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAyKTsKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAyKTsKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAxKTsKICAgICAgICAgICAgICAgIGdlb21ldHJ5LmluZGljZXMucHVzaChuZHggKyAzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZ2VvbWV0cmllc1trZXldID0gZ2VvbWV0cnk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCBhcnJheUJ1ZmZlcnMgPSBbXTsKICAgIGNvbnN0IGdlb21ldHJpZXNQYWNrZWQgPSBPYmplY3QudmFsdWVzKGdlb21ldHJpZXMpLm1hcCgoZ2VvbWV0cnkpID0+IHsKICAgICAgY29uc3QgcGFja2VkR2VvbWV0cnkgPSB7CiAgICAgICAgaW5kaWNlczogbmV3IFVpbnQxNkFycmF5KGdlb21ldHJ5LmluZGljZXMubGVuZ3RoKSwKICAgICAgICBsaWdodHM6IG5ldyBJbnQzMkFycmF5KGdlb21ldHJ5LmxpZ2h0cyksCiAgICAgICAgcG9zaXRpb25zOiBuZXcgRmxvYXQzMkFycmF5KGdlb21ldHJ5LnBvc2l0aW9ucyksCiAgICAgICAgdXZzOiBuZXcgRmxvYXQzMkFycmF5KGdlb21ldHJ5LnV2cyksCiAgICAgICAgdm94ZWw6IGdlb21ldHJ5LnZveGVsLAogICAgICAgIGZhY2VOYW1lOiBnZW9tZXRyeS5mYWNlTmFtZSwKICAgICAgICBhdDogZ2VvbWV0cnkuYXQKICAgICAgfTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnZW9tZXRyeS5pbmRpY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcGFja2VkR2VvbWV0cnkuaW5kaWNlc1tpXSA9IGdlb21ldHJ5LmluZGljZXNbaV07CiAgICAgIH0KICAgICAgYXJyYXlCdWZmZXJzLnB1c2gocGFja2VkR2VvbWV0cnkuaW5kaWNlcy5idWZmZXIpOwogICAgICBhcnJheUJ1ZmZlcnMucHVzaChwYWNrZWRHZW9tZXRyeS5saWdodHMuYnVmZmVyKTsKICAgICAgYXJyYXlCdWZmZXJzLnB1c2gocGFja2VkR2VvbWV0cnkucG9zaXRpb25zLmJ1ZmZlcik7CiAgICAgIGFycmF5QnVmZmVycy5wdXNoKHBhY2tlZEdlb21ldHJ5LnV2cy5idWZmZXIpOwogICAgICByZXR1cm4gcGFja2VkR2VvbWV0cnk7CiAgICB9KS5maWx0ZXIoKGdlb21ldHJ5KSA9PiBnZW9tZXRyeS5wb3NpdGlvbnMubGVuZ3RoID4gMCk7CiAgICBwb3N0TWVzc2FnZSh7IGdlb21ldHJpZXM6IGdlb21ldHJpZXNQYWNrZWQgfSwgYXJyYXlCdWZmZXJzKTsKICB9Owp9KSgpOwo=",pC="undefined"!=typeof self&&self.Blob&&new Blob([(g=>Uint8Array.from(atob(g),(g=>g.charCodeAt(0))))(WC)],{type:"text/javascript;charset=utf-8"});function uC(g){let I;try{if(I=pC&&(self.URL||self.webkitURL).createObjectURL(pC),!I)throw"";const C=new Worker(I,{name:null==g?void 0:g.name});return C.addEventListener("error",(()=>{(self.URL||self.webkitURL).revokeObjectURL(I)})),C}catch(C){return new Worker("data:text/javascript;base64,"+WC,{name:null==g?void 0:g.name})}finally{I&&(self.URL||self.webkitURL).revokeObjectURL(I)}}const rC=[[1,0,0],[-1,0,0],[0,0,1],[0,0,-1],[0,1,0],[0,-1,0]],yC={maxChunkRequestsPerUpdate:16,maxProcessesPerUpdate:4,maxUpdatesPerUpdate:1e3,maxLightsUpdateTime:5,maxMeshesPerUpdate:8,shouldGenerateChunkMeshes:!0,minLightLevel:.04,chunkRerequestInterval:1e4,defaultRenderRadius:6,textureUnitDimension:8,chunkLoadExponent:8,skyOptions:{},cloudsOptions:{},chunkUniformsOverwrite:{},sunlightStartTimeFrac:.25,sunlightEndTimeFrac:.7,sunlightChangeSpan:.15,timeForceThreshold:.1,statsSyncInterval:500,useLightWorkers:!0,maxLightWorkers:2,lightJobRetryLimit:3,deltaRetentionTime:5e3};class VC extends i.Z58{constructor(g={}){super(),this.isInitialized=!1,this.packets=[],this.chunkEvents=new n.EventEmitter,this.oldBlocks=new Map,this.clock=new i.zD7,this.chunkInitializeListeners=new Map,this.blockEntitiesMap=new Map,this.blockEntityUpdateListeners=new Set,this.blockUpdateListeners=new Set,this.initialData=null,this.initialEntities=null,this._time=0,this._renderRadius=0,this._deleteRadius=0,this.meshWorkerPool=new F(uC,{maxWorker:navigator.hardwareConcurrency??4}),this.textureLoaderLastMap={},this.chunksTracker=[],this.isTrackingChunks=!1,this.voxelDeltas=new Map,this.deltaSequenceCounter=0,this.cleanupDeltasInterval=null,this.lightJobQueue=[],this.lightJobIdCounter=0,this.accumulatedLightOps=null,this.accumulatedStartSequenceId=0,this.addChunkInitListener=(g,I)=>{const C=dg.getChunkName(g),A=this.chunkInitializeListeners.get(C)||[];return A.push(I),this.chunkInitializeListeners.set(C,A),()=>{this.chunkInitializeListeners.delete(C)}},this.addBlockUpdateListener=g=>(this.blockUpdateListeners.add(g),()=>{this.blockUpdateListeners.delete(g)}),this.addBlockEntityUpdateListener=g=>(this.blockEntityUpdateListeners.add(g),()=>{this.blockEntityUpdateListeners.delete(g)}),this.raycastVoxels=(g,I,C,A={})=>{this.checkIsInitialized("raycast voxels",!1);const{ignoreFluids:i,ignorePassables:t,ignoreSeeThrough:s}={ignoreFluids:!0,ignorePassables:!1,ignoreSeeThrough:!1,...A},o=new Set(A.ignoreList||[]);return p(((g,I,C)=>{const A=this.getBlockAt(g,I,C);if(!A)return[];const{id:e,isFluid:l,isPassable:d,isSeeThrough:n,aabbs:c,dynamicFn:a,isDynamic:h,dynamicPatterns:Z}=A;if(o.has(e))return[];if(h&&!a&&console.warn(`Block of ID ${e} is dynamic but has no dynamic function.`),l&&i||d&&t||n&&s)return[];const m=this.getVoxelRotationAt(g,I,C),b=Math.floor(g),G=Math.floor(I),B=Math.floor(C);if(Z&&Z.length>0){return this.getBlockAABBsForDynamicPatterns(g,I,C,Z).map((g=>m.rotateAABB(g).translate([b,G,B])))}return(h&&a?a([0|g,0|I,0|C]).aabbs:c).map((g=>m.rotateAABB(g).translate([b,G,B])))}),g,I,C)},this.getBlockAABBsByIdAt=(g,I,C,A)=>{const i=this.getBlockById(g);return i?i.dynamicPatterns&&i.dynamicPatterns.length>0?this.getBlockAABBsForDynamicPatterns(I,C,A,i.dynamicPatterns):i.aabbs:[]},this.getBlockAABBsAt=(g,I,C)=>{const A=this.getVoxelAt(g,I,C);return this.getBlockAABBsByIdAt(A,g,I,C)},this.getBlockAABBsForDynamicPatterns=(g,I,C,A)=>{for(const i of A){const A=[];for(const t of i.parts){eg.evaluateBlockRule(t.rule,[g,I,C],{getVoxelAt:(g,I,C)=>this.getVoxelAt(g,I,C),getVoxelRotationAt:(g,I,C)=>this.getVoxelRotationAt(g,I,C),getVoxelStageAt:(g,I,C)=>this.getVoxelStageAt(g,I,C)})&&A.push(...t.aabbs)}if(A.length>0)return A.map((g=>g instanceof s?g:new s(g.minX,g.minY,g.minZ,g.maxX,g.maxY,g.maxZ)))}return[]},this.updateVoxel=(g,I,C,A,i)=>{const{rotation:t=j,yRotation:s=0,stage:o=0,source:e="client"}=i;this.updateVoxels([{vx:g,vy:I,vz:C,type:A,rotation:t,yRotation:s,stage:o}],e)},this.updateVoxels=(g,I="client")=>{this.checkIsInitialized("update voxels",!1);const C=g.filter((g=>{if(g.vy<0||g.vy>=this.options.maxHeight)return!1;const{vx:I,vy:C,vz:A,type:i,rotation:t,yRotation:s,stage:o}=g,e=this.getVoxelAt(I,C,A),l=this.getVoxelRotationAt(I,C,A),d=this.getVoxelStageAt(I,C,A);return this.getBlockById(i)?e!==i||void 0===t||l.value!==t||void 0===s||l.yRotation!==s||void 0===o||d!==o:(console.warn(`Block ID ${i} does not exist.`),!1)})).map((g=>(isNaN(g.rotation)&&(g.rotation=0),this.getBlockById(g.type).yRotatable||(g.yRotation=0),g)));this.chunks.toUpdate.push(...C.map((g=>({source:I,update:g})))),this.processClientUpdates()},this.makeBlockMesh=(g,I={})=>{if(this.checkIsInitialized("make block mesh",!1),!g)return null;const C=this.getBlockOf(g);if(!C)return null;const{separateFaces:A,crumbs:t,material:s}={separateFaces:!1,crumbs:!1,material:"basic",...I},{faces:o,isSeeThrough:e}=C,l=new Map;o.forEach(((g,I)=>{const o=t&&A?Math.random()+.5:1,{corners:d,name:n,range:c}=g,a=`${C.name}-${n}-${A?I:"all"}`;let h=l.get(a);if(!h){const I=g.isolated?{map:ZC.makeUnknownTexture(this.options.textureUnitDimension)}:this.getBlockFaceMaterial(C.id,n),A={transparent:e,map:null==I?void 0:I.map,side:e?i.$EB:i.hB5};h={identifier:a,positions:[],uvs:[],indices:[],material:"basic"===s?new i.V9B(A):new i._4j(A)}}const{positions:Z,uvs:m,indices:b}=h,G=Math.floor(Z.length/3);let{startU:B,endU:W,startV:p,endV:u}=c;t&&(Math.random()<.5?(B+=(W-B)/2*Math.random(),u-=(u-p)/2*Math.random()):(W-=(W-B)/2*Math.random(),p+=(u-p)/2*Math.random())),d.forEach((({uv:g,pos:I})=>{Z.push(...I.map((g=>g*o))),m.push(g[0]*(W-B)+B,g[1]*(u-p)+p)})),b.push(G,G+1,G+2,G+2,G+1,G+3),l.set(a,h)}));const d=new i.YJl;return l.forEach((({identifier:g,positions:I,uvs:C,indices:A,material:t})=>{const s=new i.LoY;s.setAttribute("position",new i.qtW(I,3)),s.setAttribute("uv",new i.qtW(C,2)),s.setIndex(A),s.computeVertexNormals();const o=new i.eaF(s,t);o.name=g,d.add(o)})),d.name=C.name,d.position.x-=.5,d.position.y-=.5,d.position.z-=.5,d},this.customizeMaterialShaders=(g,I=null,C={vertexShader:aC.vertex,fragmentShader:aC.fragment,uniforms:{}})=>{this.checkIsInitialized("customize material shaders",!1);const{vertexShader:A=aC.vertex,fragmentShader:i=aC.fragment,uniforms:t={}}=C,s=this.getBlockFaceMaterial(g,I);if(!s)throw new Error(`Could not find material for block ${g} and face ${I}`);return s.vertexShader=A,s.fragmentShader=i,s.uniforms={...s.uniforms,...t},s.needsUpdate=!0,s},this.customizeBlockDynamic=(g,I)=>{this.checkIsInitialized("customize block dynamic",!1);const C=this.getBlockOf(g);if(!C)throw new Error(`Block with ID ${g} does not exist, could not overwrite dynamic function.`);C.dynamicFn=I},this.handleEntities=g=>{g.forEach((g=>{var I;const{id:C,type:A,metadata:i,operation:t}=g;if(!A.startsWith("block::"))return;if(!i||!i.voxel)return void console.log("No metadata or voxel in block entity",C,A,t,i);const[s,o,e]=i.voxel,[l,d,n]=[Math.floor(s),Math.floor(o),Math.floor(e)],c=dg.getVoxelName([l,d,n]);let a;try{a=JSON.parse(i.json)}catch(Z){console.error("Error parsing block entity JSON:",Z),a=null}const h=this.blockEntitiesMap.get(c)??[];switch(this.blockEntityUpdateListeners.forEach((g=>{const I=dg.mapVoxelToChunk([l,d,n],this.options.chunkSize),i=dg.getChunkName(I),s=this.chunks.loaded.get(i);if(s&&0!==s.meshes.size)g({id:C,voxel:[l,d,n],oldValue:(null==h?void 0:h.data)??null,newValue:a,operation:t,etype:A});else{const i=this.addChunkInitListener(I,(()=>{g({id:C,voxel:[l,d,n],oldValue:(null==h?void 0:h.data)??null,newValue:a,operation:t,etype:A}),i()}))}})),t){case"DELETE":{this.blockEntitiesMap.delete(c);const g=this.getBlockByName(A.split("::")[1]);if(g)for(const C of g.faces)if(C.isolated){const A=[l,d,n],i=this.getBlockFaceMaterial(g.id,C.name,A);i&&(i.dispose(),null==(I=i.map)||I.dispose()),this.chunks.materials.delete(this.makeChunkMaterialKey(g.id,C.name,A))}break}case"CREATE":case"UPDATE":this.blockEntitiesMap.set(c,{id:C,data:a})}}))},this.updatePhysics=g=>{if(!this.physics||!this.options.gravity)return;const I=this.options.gravity[0]**2+this.options.gravity[1]**2+this.options.gravity[2]**2<.01;this.physics.bodies.forEach((C=>{const A=dg.mapVoxelToChunk(C.getPosition(),this.options.chunkSize),i=this.getChunkByPosition(...C.getPosition());(i&&i.isReady||!this.isWithinWorld(...A))&&this.physics.iterateBody(C,g,I)}))},this.updateUniforms=()=>{this.chunks.uniforms.time.value=performance.now()},this.processLightUpdates=g=>{const I=performance.now(),C=this.deltaSequenceCounter,{maxHeight:A,maxLightsUpdateTime:i}=this.options,t=[];let s=0;const o=performance.now();for(const n of g){if(performance.now()-I>i){Math.random()<.01&&console.warn("Approaching maxLightsUpdateTime during light updates, continuing to ensure correctness");break}const{update:{type:g,vx:C,vy:o,vz:e,rotation:l,yRotation:d,stage:c}}=n;if(o<0||o>=A)continue;const a=this.getVoxelAt(C,o,e),h=this.getBlockById(a),Z=this.getBlockById(g),m=this.getVoxelRotationAt(C,o,e),b=sg.encode(l,d),G=eg.insertAll(Z.id,Z.rotatable||Z.yRotatable?b:void 0,c);this.attemptBlockCache(C,o,e,G),this.setVoxelAt(C,o,e,g),this.setVoxelStageAt(C,o,e,c),(Z.rotatable||Z.yRotatable)&&this.setVoxelRotationAt(C,o,e,b),t.push({voxel:[C,o,e],oldId:a,newId:g,oldBlock:h,newBlock:Z,oldRotation:m,newRotation:this.getVoxelRotationAt(C,o,e),stage:c}),s++}const e=performance.now();console.log(`Voxel updates (${s}): ${(e-o).toFixed(2)}ms`);const l=this.analyzeLightOperations(t);this.options.useLightWorkers&&l.hasOperations?this.accumulatedLightOps?(this.accumulatedLightOps=this.mergeLightOperations(this.accumulatedLightOps,l),this.accumulatedStartSequenceId=Math.min(this.accumulatedStartSequenceId,C)):(this.accumulatedLightOps=l,this.accumulatedStartSequenceId=C):l.hasOperations&&this.executeLightOperationsSyncAll(l);const d=performance.now();return console.log(`Total processLightUpdates: ${(d-I).toFixed(2)}ms`),g.slice(s)},this.processClientUpdates=()=>{if(0===this.chunks.toUpdate.length||this.isTrackingChunks)return;this.isTrackingChunks=!0;const g=performance.now(),I=()=>{if(this.chunks.toUpdate.length>0){const C=this.chunks.toUpdate.splice(0,this.options.maxUpdatesPerUpdate),A=this.processLightUpdates(C);if(this.chunks.toUpdate.push(...A),this.chunks.toEmit.push(...C.slice(0,this.options.maxUpdatesPerUpdate-A.length).filter((({source:g})=>"client"===g)).map((({update:g})=>g))),this.chunks.toUpdate.length>0)return void requestAnimationFrame(I);{const I=performance.now();console.log(I-g)}}this.flushAccumulatedLightOps(),this.isTrackingChunks=!1,this.processDirtyChunks()};I()},this.processDirtyChunks=async()=>{const g=this.chunksTracker.splice(0,this.chunksTracker.length);for(const[I,C]of g){const[g,A]=I;await this.meshChunkLocally(g,A,C)}},this.emitServerUpdates=()=>{if(0===this.chunks.toEmit.length)return;const g=this.chunks.toEmit.splice(0,this.options.maxUpdatesPerUpdate);this.packets.push({type:"UPDATE",updates:g.map((g=>{const{type:I,rotation:C,yRotation:A,stage:i}=g,t=this.getBlockById(I);let s=0;return s=eg.insertID(s,I),!t.rotatable&&!t.yRotatable||isNaN(C)&&isNaN(A)||(s=eg.insertRotation(s,sg.encode(C,A))),void 0!==i&&(s=eg.insertStage(s,i)),{...g,voxel:s}}))})},this.makeShaderMaterial=(g=aC.fragment,I=aC.vertex,C={})=>{const A={...this.chunks.uniforms,...this.options.chunkUniformsOverwrite},t=new i.BKk({vertexColors:!0,fragmentShader:g,vertexShader:I,uniforms:{...i.LlO.clone(i.zkh.basic.uniforms),uLightIntensityAdjustment:A.lightIntensityAdjustment,uSunlightIntensity:A.sunlightIntensity,uAOTable:A.ao,uMinLightLevel:A.minLightLevel,uFogNear:A.fogNear,uFogFar:A.fogFar,uFogColor:A.fogColor,uTime:A.time,...C}});return Object.defineProperty(t,"renderStage",{get:function(){return t.uniforms.renderStage.value},set:function(g){t.uniforms.renderStage.value=parseFloat(g)}}),t.map=ZC.makeUnknownTexture(this.options.textureUnitDimension),t.uniforms.map={value:t.map},t};const{statsSyncInterval:I}=this.options={...yC,...g};this.lightWorkerPool=new F(BC,{maxWorker:this.options.maxLightWorkers}),this.setupComponents(),this.setupUniforms(),this.startDeltaCleanup(),FI((()=>{this.packets.push({type:"METHOD",method:{name:"vox-builtin:get-stats",payload:{}}})}),I)}startDeltaCleanup(){this.cleanupDeltasInterval=setInterval((()=>{const g=performance.now()-this.options.deltaRetentionTime;this.voxelDeltas.forEach(((I,C)=>{const A=I.filter((I=>I.timestamp>g));0===A.length?this.voxelDeltas.delete(C):A.length<I.length&&this.voxelDeltas.set(C,A)}))}),1e3)}async meshChunkLocally(g,I,C){if(this.lightJobQueue.length>0||this.lightWorkerPool.workingCount>0)return new Promise((A=>{setTimeout((()=>{this.meshChunkLocally(g,I,C).then(A)}),10)}));const A=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]].map((([C,A])=>this.getChunkByCoords(g+C,I+A))),i=A[4];if(!i)return;const{min:t,max:s}=i,o=Math.floor(this.options.maxHeight/this.options.subChunks),e=[t[0],o*C,t[2]],l=[s[0],o*(C+1),s[2]],d=[],n=[];for(const b of A){if(!b){d.push(null);continue}const[g,I]=b.serialize();d.push(g),n.push(...I)}const c={chunksData:d,options:this.options,min:e,max:l},a=dg.getChunkName([g,I]);if(this.chunks.toProcessSet.has(a))return;const{geometries:h}=await new Promise((g=>{this.meshWorkerPool.addJob({message:c,buffers:n,resolve:g})}));if(this.chunks.toProcessSet.has(a))return;const Z={level:C,geometries:h};this.buildChunkMesh(g,I,Z);const m=this.getChunkByCoords(g,I);if(m){const A=m.meshes.get(C)||[];this.emitChunkEvent("chunk-mesh-updated",{chunk:m,coords:[g,I],level:C,meshes:A,reason:"voxel"}),this.emitChunkEvent("chunk-updated",{chunk:m,coords:[g,I],allMeshes:m.meshes,reason:"voxel"})}}applyBlockTexture(g,I,C){this.checkIsInitialized("apply block texture",!1);const A=this.getBlockOf(g),i=this.getBlockFacesByFaceNames(A.id,I);if(!i)throw new Error(`Face(s) "${I}" does not exist on block "${A.name}"`);const t=new Date;if(i.forEach((g=>{const I=`${g.name}::${A.id}`;this.textureLoaderLastMap[I]=t})),"string"==typeof C)return void this.loader.loadImage(C).then((I=>{const C=i.filter((g=>{const I=`${g.name}::${A.id}`;return this.textureLoaderLastMap[I]===t}));this.applyBlockTexture(g,C.map((g=>g.name)),I)}));const s=C;i.forEach((g=>{if(g.isolated)return;const I=this.getBlockFaceMaterial(A.id,g.name);if(g.independent){if(ug.isTexture(C))I.map=C,I.uniforms.map={value:C},I.needsUpdate=!0;else if(s instanceof HTMLImageElement)I.map.image=s,I.map.needsUpdate=!0,I.needsUpdate=!0;else{if(!ug.isColor(s))throw new Error(`Cannot apply texture to face "${g.name}" on block "${A.name}" because the source is not an image or a color.`);{const g=I.map.image;g.width=1,g.height=1;const C=g.getContext("2d");C.fillStyle=s.getStyle(),C.fillRect(0,0,1,1),I.map.needsUpdate=!0,I.needsUpdate=!0}}return}I.map.drawImageToRange(g.range,s),I.map.needsUpdate=!0}))}getIsolatedBlockMaterialAt(g,I,C){const A=this.getBlockAt(...g);if(0===A.id){const I=this.getChunkByPosition(...g);console.log("[ian] applying isolated block texture at",A,I.coords);const C=I.voxels.data;console.log("[ian]",C.filter((g=>!!g)),C.length)}const i=A.id;return this.applyBlockTextureAt(i,I,ZC.makeUnknownTexture(C??this.options.textureUnitDimension),g)}applyBlockTextureAt(g,I,C,A){const t=this.getBlockOf(g),s=this.getBlockFacesByFaceNames(t.id,I);if(!s||1!==s.length)throw new Error(`Face(s) "${I}" does not exist on block "${t.name}" or there are multiple faces with the same name.`);const[o]=s;if(!o.isolated)throw new Error(`Cannot apply isolated texture to face "${o.name}" on block "${t.name}" because it is not isolated.`);const e=this.getBlockFaceMaterial(t.id,o.name,A),l=e||this.makeShaderMaterial();if("string"==typeof C)this.loader.loadImage(C).then((g=>{l.map&&l.map.dispose(),l.map=new i.gPd(g),l.map.colorSpace=i.er$,l.map.needsUpdate=!0,l.needsUpdate=!0}));else if(C instanceof HTMLImageElement)l.map&&l.map.dispose(),l.map=new i.gPd(C),l.map.colorSpace=i.er$,l.map.needsUpdate=!0,l.needsUpdate=!0;else if(ug.isColor(C))if(l.map){if(l.map instanceof ZC)l.map.paintColor(C),l.map.needsUpdate=!0;else if(ug.isCanvasTexture(l.map)){const g=l.map.image,I=g.getContext("2d"),A=g.width,i=g.height;I.fillStyle=C.getStyle(),I.fillRect(0,0,A,i),l.map.needsUpdate=!0}}else{const g=document.createElement("canvas");g.width=1,g.height=1;const I=g.getContext("2d");I.fillStyle=C.getStyle(),I.fillRect(0,0,1,1),l.map=new i.GOR(g),l.map.colorSpace=i.er$,l.map.needsUpdate=!0,l.needsUpdate=!0}else{if(!ug.isTexture(C))throw new Error("Unsupported source type for texture.");l.map&&l.map.dispose(),l.map=C,l.map.needsUpdate=!0,l.needsUpdate=!0}if(l.map&&(l.uniforms.map.value=l.map),l.side=t.isSeeThrough?i.$EB:i.hB5,l.transparent=t.isSeeThrough,!e){const g=this.makeChunkMaterialKey(t.id,o.name,A);this.chunks.materials.set(g,l)}return l}async applyBlockTextures(g){return Promise.all(g.map((({idOrName:g,faceNames:I,source:C})=>this.applyBlockTexture(g,I,C))))}async applyBlockFrames(g,I,C,A=0){this.checkIsInitialized("apply block animation",!1);const i=this.getBlockOf(g),t=[];for(const[o,e]of C)"string"!=typeof e?t.push([o,e]):t.push([o,await this.loader.loadImage(e)]);const s=this.getBlockFacesByFaceNames(i.id,I);if(!s)throw new Error(`Face(s) "${I}" does not exist on block "${i.name}"`);s.forEach((g=>{const I=this.getBlockFaceMaterial(i.id,g.name);if(!(I.map instanceof ZC)){const{image:C}=I.map;if(!C||!C.width)throw new Error(`Cannot animate face "${g.name}" on block "${i.name}" because it does not have a texture.`);{const A=new ZC(1,C.width);A.drawImageToRange(g.range,C),I.map.dispose(),I.map=A,I.uniforms.map={value:A},I.needsUpdate=!0}}I.map.registerAnimation(g.range,t,A)}))}async applyBlockGif(g,I,C,A=66.666667){this.checkIsInitialized("apply GIF animation",!1),C.endsWith(".gif")||console.warn("There's a chance that this file isn't a GIF as it doesn't end with .gif");const i=(await this.loader.loadGifImages(C)).map((g=>[A,g]));await this.applyBlockFrames(g,I,i)}async setResolutionOf(g,I,C){this.checkIsInitialized("apply resolution",!1);const A=this.getBlockOf(g);I=Array.isArray(I)?I:[I];const i=this.getBlockFacesByFaceNames(A.id,I);if(!i)throw new Error(`Face(s) "${I.join(", ")}" does not exist on block "${A.name}"`);for(const t of i){if(!t.independent)throw new Error(`Cannot apply resolution to face "${t.name}" on block "${A.name}" because it is not independent.`);const g=this.getBlockFaceMaterial(A.id,t.name),I=g.map.image??g.map.source.data;if(I instanceof HTMLImageElement&&await new Promise((g=>{I.complete?g():I.onload=()=>{g()}})),!I)throw new Error(`Cannot apply resolution to face "${t.name}" on block "${A.name}" because it does not have or has not loaded a texture.`);const{width:i,height:s}=I,o=document.createElement("canvas"),e="number"==typeof C?C:C.x,l="number"==typeof C?C:C.y;o.width=e,o.height=l;o.getContext("2d").drawImage(I,0,0,i,s,0,0,e,l),g.map.image=o,g.map.needsUpdate=!0,g.needsUpdate=!0}}getBlockFacesByFaceNames(g,I){const C=this.getBlockOf(g);return"*"===I?C.faces:C.faces.filter((g=>"string"==typeof I||I instanceof RegExp?new RegExp(I).test(g.name):!!Array.isArray(I)&&I.some((I=>new RegExp(I).test(g.name)))))}getChunkByName(g){return this.checkIsInitialized("get chunk by name",!1),this.chunks.loaded.get(g)}getChunkByCoords(g,I){this.checkIsInitialized("get chunk by coords",!1);const C=dg.getChunkName([g,I]);return this.getChunkByName(C)}getChunkByPosition(g,I,C){this.checkIsInitialized("get chunk by position",!1);const A=dg.mapVoxelToChunk([0|g,0|I,0|C],this.options.chunkSize);return this.getChunkByCoords(...A)}getVoxelAt(g,I,C){this.checkIsInitialized("get voxel",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getVoxel(g,I,C)}setVoxelAt(g,I,C,A){this.checkIsInitialized("set voxel",!1);const i=this.getChunkByPosition(g,I,C);if(void 0===i)return;const t=i.getVoxel(g,I,C);i.setVoxel(g,I,C,A),t!==A&&this.recordVoxelDelta(g,I,C,{oldVoxel:t,newVoxel:A}),this.trackChunkAt(g,I,C)}getVoxelRotationAt(g,I,C){this.checkIsInitialized("get voxel rotation",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?new sg:A.getVoxelRotation(g,I,C)}setVoxelRotationAt(g,I,C,A){this.checkIsInitialized("set voxel rotation",!1);const i=this.getChunkByPosition(g,I,C);if(void 0===i)return;const t=i.getVoxelRotation(g,I,C);i.setVoxelRotation(g,I,C,A),t.value===A.value&&t.yRotation===A.yRotation||this.recordVoxelDelta(g,I,C,{oldRotation:t,newRotation:A}),this.trackChunkAt(g,I,C)}getVoxelStageAt(g,I,C){this.checkIsInitialized("get voxel stage",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getVoxelStage(g,I,C)}setVoxelStageAt(g,I,C,A){this.checkIsInitialized("set voxel stage",!1);const i=this.getChunkByPosition(g,I,C);if(void 0===i)return;const t=i.getVoxelStage(g,I,C);i.setVoxelStage(g,I,C,A),t!==A&&this.recordVoxelDelta(g,I,C,{oldStage:t,newStage:A}),this.trackChunkAt(g,I,C)}getSunlightAt(g,I,C){this.checkIsInitialized("get sunlight",!1);const A=this.getChunkByPosition(g,I,C);return void 0===A?0:A.getSunlight(g,I,C)}setSunlightAt(g,I,C,A){this.checkIsInitialized("set sunlight",!1);const i=this.getChunkByPosition(g,I,C);void 0!==i&&(i.setSunlight(g,I,C,A),this.trackChunkAt(g,I,C))}getTorchLightAt(g,I,C,A){this.checkIsInitialized("get torch light",!1);const i=this.getChunkByPosition(g,I,C);return void 0===i?0:i.getTorchLight(g,I,C,A)}setTorchLightAt(g,I,C,A,i){this.checkIsInitialized("set torch light",!1);const t=this.getChunkByPosition(g,I,C);void 0!==t&&(t.setTorchLight(g,I,C,A,i),this.trackChunkAt(g,I,C))}getLightColorAt(g,I,C){this.checkIsInitialized("get light color",!1);const A=this.getSunlightAt(g,I,C),t=this.getTorchLightAt(g,I,C,"RED"),s=this.getTorchLightAt(g,I,C,"GREEN"),o=this.getTorchLightAt(g,I,C,"BLUE"),{sunlightIntensity:e,minLightLevel:l}=this.chunks.uniforms,d=Math.min((A/this.options.maxLightLevel)**2*e.value*(1-l.value)+l.value,1);return new i.Q1f(d+Math.pow(t/this.options.maxLightLevel,2),d+Math.pow(s/this.options.maxLightLevel,2),d+Math.pow(o/this.options.maxLightLevel,2))}getBlockAt(g,I,C){this.checkIsInitialized("get block",!1);const A=this.getChunkByPosition(g,I,C);if(void 0===A)return null;const i=A.getVoxel(g,I,C);return this.getBlockById(i)}getMaxHeightAt(g,I){this.checkIsInitialized("get max height",!1);const C=0|g,A=0|I;for(let i=this.options.maxHeight-1;i>=0;i--){if(!this.getBlockAt(C,i,A).isEmpty)return i}return 0}getPreviousValueAt(g,I,C,A=1){const i=dg.getVoxelName([0|g,0|I,0|C]),t=this.oldBlocks.get(i)||[];return t[t.length-A]||0}getBlockOf(g){return"number"==typeof g?this.getBlockById(g):this.getBlockByName(g.toLowerCase())}getBlockById(g){const I=this.registry.blocksById.get(g);if(!I)throw new Error(`Block with id ${g} does not exist`);return I}getBlockByName(g){const I=this.registry.blocksByName.get(g.toLowerCase());if(!I)throw new Error(`Block with name ${g} does not exist`);return I}getBlockEntityDataAt(g,I,C){var A;this.checkIsInitialized("get block entity data",!1);const i=Math.floor(g),t=Math.floor(I),s=Math.floor(C),o=dg.getVoxelName([i,t,s]);return(null==(A=this.blockEntitiesMap.get(o))?void 0:A.data)||null}setBlockEntityDataAt(g,I,C,A){this.checkIsInitialized("set block entity data",!1);const i=Math.floor(g),t=Math.floor(I),s=Math.floor(C),o=dg.getVoxelName([i,t,s]),e=this.blockEntitiesMap.get(o);e?this.packets.push({type:"METHOD",method:{name:"vox-builtin:update-block-entity",payload:JSON.stringify({id:e.id,json:JSON.stringify(A)})}}):console.log("No entity found at:",g,I,C)}getChunkStatus(g,I){const C=dg.getChunkName([g,I]),A=this.chunks.requested.has(C),i=this.chunks.loaded.has(C),t=this.chunks.toProcessSet.has(C),s=this.chunks.toRequestSet.has(C);if(A&&t||A&&s||t&&s)throw new Error(`Chunk ${C} is in more than one state other than the loaded state. This should not happen. These are the states: requested: ${A}, loaded: ${i}, processing: ${t}, to request: ${s}`);return i?"loaded":t?"processing":A?"requested":s?"to request":null}getBlockFaceMaterial(g,I,C){this.checkIsInitialized("get material",!1);const A=this.getBlockOf(g);return C&&I&&A.isolatedFaces.has(I)?this.chunks.materials.get(this.makeChunkMaterialKey(A.id,I,C)):I&&A.independentFaces.has(I)?this.chunks.materials.get(this.makeChunkMaterialKey(A.id,I)):this.chunks.materials.get(this.makeChunkMaterialKey(A.id))}on(g,I){return this.chunkEvents.on(g,I),this}off(g,I){return this.chunkEvents.off(g,I),this}once(g,I){return this.chunkEvents.once(g,I),this}emitChunkEvent(g,I){this.chunkEvents.emit(g,I)}isWithinWorld(g,I){const{minChunk:C,maxChunk:A}=this.options;return g>=C[0]&&g<=A[0]&&I>=C[1]&&I<=A[1]}isChunkInView(g,I,C,A){const[i,t]=g,[s,o]=I,e=i-s,l=t-o;if(e*e+l*l<(this.renderRadius>>1)**2)return!0;const d=(o-t)*C.z+(s-i)*C.x,n=(o-t)*C.x-(s-i)*C.z,c=Math.atan2(n,d);return Math.abs(c)<A}floodLight(g,I,C,A){if(!g.length)return;const{maxHeight:i,minChunk:t,maxChunk:s,maxLightLevel:o,chunkSize:e}=this.options,[l,d]=t,[n,c]=s,a="SUNLIGHT"===I,h=new Map,Z=new Map,m=(g,I,C)=>{const A=`${g},${I},${C}`;let i=h.get(A);return i||(i=this.getBlockAt(g,I,C),h.set(A,i)),i},b=(g,I,C)=>{const A=`${g},${I},${C}`;let i=Z.get(A);return i||(i=this.getVoxelRotationAt(g,I,C),Z.set(A,i)),i};for(;g.length;){const t=g.shift(),{voxel:s,level:h}=t;if(0===h)continue;const[Z,G,B]=s,W=m(Z,G,B),p=b(Z,G,B),u=!a&&eg.getBlockTorchLightLevel(W,I)>0?[!0,!0,!0,!0,!0,!0]:eg.getBlockRotatedTransparency(W,p);for(const[r,y,V]of rC){const t=G+y;if(t<0||t>=i)continue;const s=Z+r,W=B+V,[p,K]=dg.mapVoxelToChunk([s,t,W],e);if(p<l||p>n||K<d||K>c||C&&(s<C[0]||W<C[2])||A&&(s>=A[0]||W>=A[2]))continue;const X=[s,t,W],w=m(s,t,W),Y=b(s,t,W),H=eg.getBlockRotatedTransparency(w,Y),S=h-(a&&!w.lightReduce&&-1===y&&h===o?0:1);!hg.canEnter(u,H,r,y,V)||(a?this.getSunlightAt(s,t,W):this.getTorchLightAt(s,t,W,I))>=S||(a?this.setSunlightAt(s,t,W,S):this.setTorchLightAt(s,t,W,S,I),g.push({voxel:X,level:S}))}}}removeLight(g,I){const{maxHeight:C,maxLightLevel:A,chunkSize:i,minChunk:t,maxChunk:s}=this.options,o=[],e=[],l="SUNLIGHT"===I,[d,n,c]=g;e.push({voxel:g,level:l?this.getSunlightAt(d,n,c):this.getTorchLightAt(d,n,c,I)}),l?this.setSunlightAt(d,n,c,0):this.setTorchLightAt(d,n,c,0,I);let a=0;const h=performance.now();for(;e.length;){a++;const g=e.shift(),{voxel:d,level:n}=g,[c,h,Z]=d;for(const[a,m,b]of rC){const g=h+m;if(g<0||g>=C)continue;const d=c+a,G=Z+b,[B,W]=dg.mapVoxelToChunk([d,g,G],i);if(B<t[0]||W<t[1]||B>s[0]||W>s[1])continue;const p=this.getBlockAt(d,g,G),u=this.getVoxelRotationAt(d,g,G),r=eg.getBlockRotatedTransparency(p,u);if((l||0===eg.getBlockTorchLightLevel(p,I))&&!hg.canEnterInto(r,a,m,b))continue;const y=[d,g,G],V=l?this.getSunlightAt(d,g,G):this.getTorchLightAt(d,g,G,I);0!==V&&(V<n||l&&-1===m&&n===A&&V===A?(e.push({voxel:y,level:V}),l?this.setSunlightAt(d,g,G,0):this.setTorchLightAt(d,g,G,0,I)):(l&&-1===m?V>n:V>=n)&&o.push({voxel:y,level:V}))}}const Z=performance.now();console.log(`removeLight executed in ${Z-h}ms with ${a} iterations, color: ${I}`),this.floodLight(o,I)}removeLightsBatch(g,I){if(!g.length)return;const{maxHeight:C,maxLightLevel:A}=this.options,i="SUNLIGHT"===I,t=[],s=[];for(g.forEach((([g,C,A])=>{const s=i?this.getSunlightAt(g,C,A):this.getTorchLightAt(g,C,A,I);0!==s&&(t.push({voxel:[g,C,A],level:s}),i?this.setSunlightAt(g,C,A,0):this.setTorchLightAt(g,C,A,0,I))}));t.length;){const{voxel:g,level:o}=t.shift(),[e,l,d]=g;for(const[n,c,a]of rC){const g=l+c;if(g<0||g>=C)continue;const h=e+n,Z=d+a,m=this.getBlockAt(h,g,Z),b=this.getVoxelRotationAt(h,g,Z),G=eg.getBlockRotatedTransparency(m,b);if(!i&&0===eg.getBlockTorchLightLevel(m,I)&&!hg.canEnterInto(G,n,c,a))continue;const B=i?this.getSunlightAt(h,g,Z):this.getTorchLightAt(h,g,Z,I);0!==B&&(B<o||i&&-1===c&&o===A&&B===A?(t.push({voxel:[h,g,Z],level:B}),i?this.setSunlightAt(h,g,Z,0):this.setTorchLightAt(h,g,Z,0,I)):(i&&-1===c?B>o:B>=o)&&s.push({voxel:[h,g,Z],level:B}))}}this.floodLight(s,I)}async initialize(){if(this.isInitialized)return void console.warn("World has already been isInitialized.");if(null===this.initialData)throw new Error("World has not received any initialization data from the server.");const{blocks:g,options:I,stats:C}=this.initialData;this._time=C.time,Object.keys(g).forEach((I=>{const C=g[I],{id:A,aabbs:i,isDynamic:t}=C,o=I.toLowerCase();C.independentFaces=new Set,C.isolatedFaces=new Set,C.faces.forEach((g=>{g.independent&&C.independentFaces.add(g.name),g.isolated&&C.isolatedFaces.add(g.name)})),C.aabbs=i.map((({minX:g,minY:I,minZ:C,maxX:A,maxY:i,maxZ:t})=>new s(g,I,C,A,i,t))),t&&(C.dynamicFn=()=>({aabbs:C.aabbs,faces:C.faces,isTransparent:C.isTransparent})),C.isLight=(C.redLightLevel??0)>0||(C.greenLightLevel??0)>0||(C.blueLightLevel??0)>0,this.registry.blocksByName.set(o,C),this.registry.blocksById.set(A,C),this.registry.nameMap.set(o,A),this.registry.idMap.set(A,o)})),this.options={...this.options,...I},this.physics.options=this.options,await this.loadMaterials();const A=this.registry.serialize();this.meshWorkerPool.postMessage({type:"init",registryData:A}),this.lightWorkerPool.postMessage({type:"init",registryData:A}),this.isInitialized=!0,this.renderRadius=this.options.defaultRenderRadius,this.initialEntities&&(this.handleEntities(this.initialEntities),this.initialEntities=null)}update(g=new i.Pq0,I=new i.Pq0){if(!this.isInitialized)return;const C=this.clock.getDelta(),A=dg.mapVoxelToChunk(g.toArray(),this.options.chunkSize);this.options.doesTickTime&&(this._time=(this.time+C)%this.options.timePerDay);performance.now(),performance.now();this.maintainChunks(A),performance.now();performance.now();this.requestChunks(A,I),performance.now();performance.now();this.processChunks(A),performance.now();performance.now();this.updatePhysics(C),performance.now();performance.now();this.updateUniforms(),performance.now();performance.now();this.updateSkyAndClouds(g),performance.now();performance.now();this.emitServerUpdates(),performance.now(),performance.now()}onMessage(g){const{type:I}=g;switch(I){case"INIT":{const{json:I,entities:C}=g;this.initialData=I,C&&(this.initialEntities=C);break}case"ENTITY":{const{entities:I}=g;I&&I.length&&this.handleEntities(I);break}case"STATS":{const{json:I}=g;Math.abs(I.time-this.time)>this.options.timeForceThreshold&&(this._time=I.time);break}case"LOAD":{const{chunks:I}=g;I.forEach((g=>{const{x:I,z:C}=g,A=dg.getChunkName([I,C]);this.chunks.requested.delete(A),this.chunks.toProcess.push({source:"load",data:g}),this.chunks.toProcessSet.add(A)}));break}case"UPDATE":{const{updates:I}=g;I.forEach((g=>{const{vx:I,vy:C,vz:A,voxel:i}=g,t=eg.extractID(i),s=eg.extractRotation(i),o=eg.extractStage(i),e=this.getVoxelRotationAt(I,C,A),l=this.getVoxelStageAt(I,C,A);this.getVoxelAt(I,C,A)===t&&e.value===s.value&&e.yRotation===s.yRotation&&l===o||this.updateVoxel(I,C,A,t,{rotation:s.value,yRotation:s.yRotation,stage:o,source:"server"})}));break}}}get time(){return this._time}set time(g){this._time=g,this.isInitialized&&this.packets.push({type:"METHOD",method:{name:"vox-builtin:set-time",payload:JSON.stringify({time:g})}})}get renderRadius(){return this._renderRadius}set renderRadius(g){this.checkIsInitialized("set render radius",!1),g=Math.floor(g),this._renderRadius=g,this._deleteRadius=1.1*g;const{chunkSize:I}=this.options;this.chunks.uniforms.fogNear.value=.7*g*I,this.chunks.uniforms.fogFar.value=g*I}get deleteRadius(){return this._deleteRadius}requestChunks(g,I){const{renderRadius:C,options:{chunkRerequestInterval:A,chunkLoadExponent:t,maxChunkRequestsPerUpdate:s}}=this,o=this.chunks.loaded.size+this.chunks.requested.size+this.chunks.toRequest.length+this.chunks.toProcess.length,e=0===o?1:this.chunks.loaded.size/o,l=I.length()>0,d=1===e?3*Math.PI/8:Math.max(e**t,.1),[n,c]=g,a=new Set,h=Math.floor(Math.max(Math.min(e*C,C),1)),Z=h*h;for(let i=-h;i<=h;i++)for(let C=-h;C<=h;C++){if(i*i+C*C>Z)continue;const t=n+i,s=c+C;if(!this.isWithinWorld(t,s))continue;if(l&&!this.isChunkInView(g,[t,s],I,d))continue;const o=dg.getChunkName([t,s]);if(this.chunks.loaded.has(o))continue;if(this.chunks.requested.has(o)){const g=dg.getChunkName([t,s]),I=this.chunks.requested.get(g)||0;I+1>A?(this.chunks.requested.delete(g),a.add(`${t},${s}`)):this.chunks.requested.set(g,I+1);continue}if(this.chunks.toProcessSet.has(o)||this.chunks.toRequestSet.has(o))continue;const e=`${t},${s}`;this.chunks.requested.has(dg.getChunkName([t,s]))||a.add(e)}const m=Array.from(a).map((g=>g.split(",").map(Number)));m.sort(((I,C)=>(I[0]-g[0])**2+(I[1]-g[1])**2-((C[0]-g[0])**2+(C[1]-g[1])**2)));const b=m.slice(0,s);b.length&&(this.packets.push({type:"LOAD",json:{center:g,direction:new i.I9Y(I.x,I.z).normalize().toArray(),chunks:b}}),b.forEach((g=>{const I=dg.getChunkName(g);this.chunks.requested.set(I,0)})))}processChunks(g){if(0===this.chunks.toProcess.length)return;this.chunks.toProcess.sort(((I,C)=>{const{x:A,z:i}=I.data,{x:t,z:s}=C.data;return(A-g[0])**2+(i-g[1])**2-((t-g[0])**2+(s-g[1])**2)}));const{maxProcessesPerUpdate:I,chunkSize:C,maxHeight:A,subChunks:i,maxLightLevel:t,shouldGenerateChunkMeshes:s}=this.options,o=g=>{const I=this.chunkInitializeListeners.get(g.name);Array.isArray(I)&&(I.forEach((I=>I(g))),this.chunkInitializeListeners.delete(g.name))};this.chunks.toProcess.splice(0,I).forEach((g=>{const{x:I,z:e,id:l,meshes:d}=g.data,n=dg.getChunkName([I,e]);this.chunks.toProcessSet.delete(n);let c=this.getChunkByCoords(I,e);c||(c=new lC(l,[I,e],{maxHeight:A,subChunks:i,size:C,maxLightLevel:t})),c.setData(g.data),c.isDirty=!1,this.chunks.loaded.set(n,c),this.emitChunkEvent("chunk-data-loaded",{chunk:c,coords:[I,e]});const a=()=>{if(s)for(const g of d)this.buildChunkMesh(I,e,g)};if(c.isReady)a(),o(c);else{let g=()=>{};g=this.addChunkInitListener([I,e],(()=>{a(),g()}))}}))}maintainChunks(g){const{deleteRadius:I}=this,[C,A]=g,i=[];this.chunks.loaded.forEach((g=>{const{name:t,coords:[s,o]}=g;if((s-C)**2+(o-A)**2>I**2){const g=this.chunks.loaded.get(t);g.meshes.forEach(((I,C)=>{this.emitChunkEvent("chunk-mesh-unloaded",{chunk:g,coords:g.coords,level:C,meshes:I})})),this.emitChunkEvent("chunk-unloaded",{chunk:g,coords:g.coords,allMeshes:new Map(g.meshes)}),g.dispose(),this.chunks.loaded.delete(t),i.push(g.coords)}})),this.chunks.requested.forEach(((g,t)=>{const[s,o]=dg.parseChunkName(t);(s-C)**2+(o-A)**2>I**2&&(this.chunks.requested.delete(t),i.push([s,o]))}));const t=[...this.chunks.toRequest];this.chunks.toRequest.length=0;const s=t.filter((g=>{const[i,t]=dg.parseChunkName(g);return(i-C)**2+(t-A)**2<=I**2}));this.chunks.toRequest.push(...s),this.chunks.toRequestSet.clear(),s.forEach((g=>this.chunks.toRequestSet.add(g)));const o=[...this.chunks.toProcess];this.chunks.toProcess.length=0;const e=o.filter((g=>{const{x:i,z:t}=g.data;return(i-C)**2+(t-A)**2<=I**2}));this.chunks.toProcess.push(...e),this.chunks.toProcessSet.clear(),e.forEach((g=>{const I=dg.getChunkName([g.data.x,g.data.z]);this.chunks.toProcessSet.add(I)})),i.forEach((g=>{const I=dg.getChunkName(g);this.chunkInitializeListeners.delete(I)})),i.length&&this.packets.push({type:"UNLOAD",json:{chunks:i}})}triggerBlockUpdateListeners(g,I,C,A,i){this.blockUpdateListeners.forEach((t=>t({voxel:[g,I,C],oldValue:A,newValue:i})))}attemptBlockCache(g,I,C,A){const i=this.getChunkByPosition(g,I,C);if(!i)return;const t=i.getRawValue(g,I,C);if(t!==A){const i=dg.getVoxelName([g,I,C]),s=this.oldBlocks.get(i)||[];s.push(t),this.oldBlocks.set(i,s),this.triggerBlockUpdateListeners(g,I,C,t,A)}}updateSkyAndClouds(g){var I;const{sunlightStartTimeFrac:C,sunlightEndTimeFrac:A,sunlightChangeSpan:t,timePerDay:s,minLightLevel:o}=this.options;this.sky.update(g,this.time,s),this.clouds.update(g);const e=Math.floor(C*s),l=Math.floor(A*s),d=Math.floor(t*s),n=Math.max(o,this.time<e?0:this.time<e+d?(this.time-e)/d:this.time<=l?1:this.time<=l+d?1-(this.time-l)/d:0);this.chunks.uniforms.sunlightIntensity.value=n;const c=this.clouds.material.uniforms.uCloudColor.value,a=c.getHSL({});c.setHSL(a.h,a.s,i.cj9.clamp(n,0,1)),null==(I=this.chunks.uniforms.fogColor.value)||I.copy(this.sky.uMiddleColor.value)}buildChunkMesh(g,I,C){var A,t;const s=this.getChunkByCoords(g,I);if(!s)return;const{maxHeight:o,subChunks:e,chunkSize:l}=this.options,{level:d,geometries:n}=C,c=Math.floor(o/e);if(null==(A=s.meshes.get(d))||A.forEach((g=>{g&&(g.geometry.dispose(),s.group.remove(g))})),s.meshes.delete(d),0===n.length)return;const a=n.map((C=>{const{voxel:A,at:t,faceName:o,indices:e,lights:n,positions:a,uvs:h}=C,Z=new i.LoY;Z.setAttribute("position",new i.THS(a,3)),Z.setAttribute("uv",new i.THS(h,2)),Z.setAttribute("light",new i.THS(n,1)),Z.setIndex(new i.THS(e,1));let m=this.getBlockFaceMaterial(A,o,t&&t.length?t:void 0);if(!m){if(!this.getBlockById(A).faces.find((g=>g.name===o)).isolated||!t)return void console.warn("Unlikely situation happened...");try{const g=this.getIsolatedBlockMaterialAt(t,o);g.map,m=g}catch(G){console.error(G)}}const b=new i.eaF(Z,m);return b.position.set(g*l,d*c,I*l),b.updateMatrix(),b.matrixAutoUpdate=!1,b.matrixWorldAutoUpdate=!1,b.userData={isChunk:!0,voxel:A},s.group.add(b),b})).filter((g=>!!g));this.children.includes(s.group)||this.add(s.group),s.meshes.has(d)||s.meshes.set(d,[]),null==(t=s.meshes.get(d))||t.push(...a),this.emitChunkEvent("chunk-mesh-loaded",{chunk:s,coords:[g,I],level:d,meshes:a}),s.meshes.size===this.options.subChunks&&this.emitChunkEvent("chunk-loaded",{chunk:s,coords:[g,I],allMeshes:s.meshes})}setupComponents(){const{skyOptions:g,cloudsOptions:I}=this.options;this.registry=new cC,this.loader=new nC,this.chunks=new dC,I.uFogColor||(I.uFogColor=this.chunks.uniforms.fogColor),this.sky=new Yg(g),this.clouds=new T(I),this.add(this.sky,this.clouds),this.physics=new H(((g,I,C)=>{if(!this.getChunkByPosition(g,I,C))return[];const A=this.getVoxelAt(g,I,C),i=this.getVoxelRotationAt(g,I,C),{aabbs:t,isPassable:s,isFluid:o,dynamicPatterns:e}=this.getBlockById(A);return s||o?[]:e&&e.length>0?this.getBlockAABBsForDynamicPatterns(g,I,C,e).map((A=>i.rotateAABB(A).translate([g,I,C]))):t.map((A=>i.rotateAABB(A).translate([g,I,C])))}),((g,I,C)=>{if(!this.getChunkByPosition(g,I,C))return!1;const A=this.getVoxelAt(g,I,C),{isFluid:i}=this.getBlockById(A);return i}),this.options)}setupUniforms(){const{minLightLevel:g}=this.options;this.chunks.uniforms.minLightLevel.value=g}analyzeLightOperations(g){const{maxHeight:I,maxLightLevel:C}=this.options,A=[],i=[],t=[],s=[],o=[],e=[],l=[],d=[],n=[];for(const a of g){const{voxel:g,oldBlock:I,newBlock:C,newRotation:i}=a,[t,s,o]=g;let e=I.isLight,l=I.redLightLevel,d=I.greenLightLevel,n=I.blueLightLevel;if(I.dynamicPatterns){e=!1,l=0,d=0,n=0;for(const g of I.dynamicPatterns)for(const I of g.parts){if(eg.evaluateBlockRule(I.rule,[t,s,o],{getVoxelAt:(g,I,C)=>this.getVoxelAt(g,I,C),getVoxelRotationAt:(g,I,C)=>this.getVoxelRotationAt(g,I,C),getVoxelStageAt:(g,I,C)=>this.getVoxelStageAt(g,I,C)})){void 0!==I.redLightLevel&&(l=I.redLightLevel),void 0!==I.greenLightLevel&&(d=I.greenLightLevel),void 0!==I.blueLightLevel&&(n=I.blueLightLevel),e=l>0||d>0||n>0;break}}}let c=C.isLight;if(C.dynamicPatterns&&void 0!==a.stage){c=!1;for(const g of C.dynamicPatterns)for(const I of g.parts){if(eg.evaluateBlockRule(I.rule,[t,s,o],{getVoxelAt:(g,I,C)=>g===t&&I===s&&C===o?a.newId:this.getVoxelAt(g,I,C),getVoxelRotationAt:(g,I,C)=>g===t&&I===s&&C===o?i:this.getVoxelRotationAt(g,I,C),getVoxelStageAt:(g,I,C)=>g===t&&I===s&&C===o?a.stage||0:this.getVoxelStageAt(g,I,C)})){if((I.redLightLevel||0)>0||(I.greenLightLevel||0)>0||(I.blueLightLevel||0)>0){c=!0;break}}}}if(e&&!c){const g={...I};g.redLightLevel=l,g.greenLightLevel=d,g.blueLightLevel=n,A.push({voxel:[t,s,o],block:g})}}A.forEach((({voxel:g,block:I})=>{const[C,A,e]=g;this.getSunlightAt(C,A,e)>0&&o.push(g),I.redLightLevel>0&&i.push(g),I.greenLightLevel>0&&t.push(g),I.blueLightLevel>0&&s.push(g)}));for(const a of g){const{voxel:g,oldBlock:c,newBlock:h,oldRotation:Z,newRotation:m}=a,[b,G,B]=g;if(A.some((({voxel:g})=>g[0]===b&&g[1]===G&&g[2]===B)))continue;const W=eg.getBlockRotatedTransparency(c,Z),p=eg.getBlockRotatedTransparency(h,m);if(h.isOpaque||h.lightReduce)this.getSunlightAt(b,G,B)>0&&o.push(g),this.getTorchLightAt(b,G,B,"RED")>0&&i.push(g),this.getTorchLightAt(b,G,B,"GREEN")>0&&t.push(g),this.getTorchLightAt(b,G,B,"BLUE")>0&&s.push(g);else{let A=0;const e=[[Gg,this.getSunlightAt(b,G,B)],[Zg,this.getTorchLightAt(b,G,B,"RED")],[mg,this.getTorchLightAt(b,G,B,"GREEN")],[bg,this.getTorchLightAt(b,G,B,"BLUE")]];for(const[g,l,d]of rC){const n=G+l;if(n<0||n>=I)continue;const c=b+g,a=B+d,h=this.getBlockAt(c,n,a),Z=this.getVoxelRotationAt(c,n,a),m=eg.getBlockRotatedTransparency(h,Z);if(hg.canEnter(W,m,g,l,d)&&!hg.canEnter(p,m,g,l,d))for(const[g,I]of e){const e=g===Gg,d=e?this.getSunlightAt(c,n,a):this.getTorchLightAt(c,n,a,g);(d<I||-1===l&&e&&d===C&&I===C)&&(A++,e?o.push([c,n,a]):g===Zg?i.push([c,n,a]):g===mg?t.push([c,n,a]):g===bg&&s.push([c,n,a]))}}0===A&&(0!==this.getSunlightAt(b,G,B)&&o.push(g),0!==this.getTorchLightAt(b,G,B,"RED")&&i.push(g),0!==this.getTorchLightAt(b,G,B,"GREEN")&&t.push(g),0!==this.getTorchLightAt(b,G,B,"BLUE")&&s.push(g))}if(h.isLight){let I=h.redLightLevel,C=h.greenLightLevel,A=h.blueLightLevel;if(h.dynamicPatterns&&void 0!==a.stage)for(const g of h.dynamicPatterns)for(const i of g.parts){if(eg.evaluateBlockRule(i.rule,[b,G,B],{getVoxelAt:(g,I,C)=>this.getVoxelAt(g,I,C),getVoxelRotationAt:(g,I,C)=>this.getVoxelRotationAt(g,I,C),getVoxelStageAt:(g,I,C)=>this.getVoxelStageAt(g,I,C)})){void 0!==i.redLightLevel&&(I=i.redLightLevel),void 0!==i.greenLightLevel&&(C=i.greenLightLevel),void 0!==i.blueLightLevel&&(A=i.blueLightLevel);break}}I>0&&e.push({voxel:g,level:I}),C>0&&l.push({voxel:g,level:C}),A>0&&d.push({voxel:g,level:A})}else if(c.isOpaque&&!h.isOpaque)for(const[A,i,t]of rC){const g=G+i;if(g<0)continue;if(g>=I){hg.canEnter([!0,!0,!0,!0,!0,!0],p,A,-1,t)&&n.push({voxel:[b+A,G,B+t],level:C});continue}const s=b+A,o=B+t,c=this.getBlockAt(s,g,o),a=this.getVoxelRotationAt(s,g,o),Z=eg.getBlockRotatedTransparency(c,a);if(!hg.canEnter(W,Z,A,i,t)&&hg.canEnter(p,Z,A,i,t)){const I=this.getSunlightAt(s,g,o)-(h.lightReduce?1:0);I>0&&n.push({voxel:[s,g,o],level:I});const C=this.getTorchLightAt(s,g,o,"RED")-(h.lightReduce?1:0);C>0&&e.push({voxel:[s,g,o],level:C});const A=this.getTorchLightAt(s,g,o,"GREEN")-(h.lightReduce?1:0);A>0&&l.push({voxel:[s,g,o],level:A});const i=this.getTorchLightAt(s,g,o,"BLUE")-(h.lightReduce?1:0);i>0&&d.push({voxel:[s,g,o],level:i})}}}const c=i.length>0||t.length>0||s.length>0||o.length>0||e.length>0||l.length>0||d.length>0||n.length>0;return{removals:{sunlight:o,red:i,green:t,blue:s},floods:{sunlight:n,red:e,green:l,blue:d},hasOperations:c}}mergeLightOperations(g,I){return{removals:{sunlight:[...g.removals.sunlight,...I.removals.sunlight],red:[...g.removals.red,...I.removals.red],green:[...g.removals.green,...I.removals.green],blue:[...g.removals.blue,...I.removals.blue]},floods:{sunlight:[...g.floods.sunlight,...I.floods.sunlight],red:[...g.floods.red,...I.floods.red],green:[...g.floods.green,...I.floods.green],blue:[...g.floods.blue,...I.floods.blue]},hasOperations:!0}}flushAccumulatedLightOps(){this.accumulatedLightOps&&this.accumulatedLightOps.hasOperations&&(this.scheduleLightJobs(this.accumulatedLightOps,this.accumulatedStartSequenceId),this.accumulatedLightOps=null,this.accumulatedStartSequenceId=0)}scheduleLightJobs(g,I){const{maxLightLevel:C,chunkSize:A,minChunk:i,maxChunk:t,maxHeight:s}=this.options;[{color:"SUNLIGHT",removals:g.removals.sunlight,floods:g.floods.sunlight},{color:"RED",removals:g.removals.red,floods:g.floods.red},{color:"GREEN",removals:g.removals.green,floods:g.floods.green},{color:"BLUE",removals:g.removals.blue,floods:g.floods.blue}].forEach((({color:g,removals:o,floods:e})=>{if(0===o.length&&0===e.length)return;const l=[...o,...e.map((g=>g.voxel))];let d=l[0][0],n=l[0][1],c=l[0][2],a=d,h=n,Z=c;for(const[I,C,A]of l)d=Math.min(d,I),n=Math.min(n,C),c=Math.min(c,A),a=Math.max(a,I),h=Math.max(h,C),Z=Math.max(Z,A);d-=C,c-=C,a+=C,Z+=C,d=Math.max(d,i[0]*A),c=Math.max(c,i[1]*A),a=Math.min(a,(t[0]+1)*A-1),Z=Math.min(Z,(t[1]+1)*A-1),n=Math.max(n,0),h=Math.min(h,s-1);const m={min:[d,n,c],shape:[a-d+1,h-n+1,Z-c+1]},b=`light-${g}-${this.lightJobIdCounter++}`;this.lightJobQueue.push({jobId:b,color:g,lightOps:{removals:o,floods:e},boundingBox:m,startSequenceId:I,retryCount:0})})),this.processNextLightJob()}processNextLightJob(){if(0===this.lightJobQueue.length)return;if(this.lightWorkerPool.isBusy)return;const g=this.lightJobQueue.shift();g&&this.executeLightJob(g)}executeLightJob(g){const{jobId:I,boundingBox:C,lightOps:A,startSequenceId:i,color:t}=g,{min:s,shape:o}=C,[e,,l]=s,[d,,n]=o,c=e+d-1,a=l+n-1,{chunkSize:h}=this.options,Z=Math.floor(e/h),m=Math.floor(l/h),b=Math.floor(c/h),G=Math.floor(a/h),B=[];for(let r=Z;r<=b;r++)for(let g=m;g<=G;g++)B.push(dg.getChunkName([r,g]));const W={};B.forEach((g=>{const I=(this.voxelDeltas.get(g)||[]).filter((g=>g.sequenceId>i));I.length>0&&(W[g]=I.map((g=>({...g,oldRotation:g.oldRotation?JSON.parse(JSON.stringify(g.oldRotation)):void 0,newRotation:g.newRotation?JSON.parse(JSON.stringify(g.newRotation)):void 0}))))}));const p=[],u=[];for(let r=Z;r<=b;r++)for(let g=m;g<=G;g++){const I=this.getChunkByCoords(r,g);if(I){const[g,C]=I.serialize();p.push(g),u.push(...C)}else p.push(null)}console.log(`Executing light job ${I} for color ${t}`),this.lightWorkerPool.addJob({message:{type:"batchOperations",jobId:I,color:t,boundingBox:C,chunksData:p,chunkGridDimensions:[b-Z+1,G-m+1],chunkGridOffset:[Z,m],relevantDeltas:W,lightOps:A,options:this.options},buffers:u,resolve:I=>this.handleLightJobResult(g,I)})}handleLightJobResult(g,I){const{jobId:C}=g,{modifiedChunks:A,appliedDeltas:i}=I;let t=!1;for(const{coords:s}of A){const g=dg.getChunkName(s),I=this.voxelDeltas.get(g)||[],C=I[I.length-1];if(C&&C.sequenceId>i.lastSequenceId){t=!0;break}}if(t&&g.retryCount<this.options.lightJobRetryLimit)return console.log(`Job ${C} stale, re-queuing (retry ${g.retryCount+1}/${this.options.lightJobRetryLimit})`),g.retryCount++,g.startSequenceId=this.deltaSequenceCounter,this.lightJobQueue.unshift(g),void this.processNextLightJob();t?(console.warn(`Job ${C} exceeded retry limit, executing sync`),this.executeLightOperationsSync(g.lightOps,g.color)):(A.forEach((({coords:g,lights:I})=>{const C=this.getChunkByCoords(g[0],g[1]);C&&(C.lights.data=I,C.isDirty=!0)})),A.forEach((({coords:g})=>{this.markChunkForRemesh(g)}))),this.processNextLightJob(),0===this.lightJobQueue.length&&0===this.lightWorkerPool.workingCount&&this.processDirtyChunks()}executeLightOperationsSync(g,I){g.removals.length>0&&this.removeLightsBatch(g.removals,I),g.floods.length>0&&this.floodLight(g.floods,I);const C=[...g.removals,...g.floods.map((g=>g.voxel))],A=new Set;C.forEach((g=>{const I=dg.mapVoxelToChunk(g,this.options.chunkSize);A.add(dg.getChunkName(I))})),A.forEach((g=>{const I=dg.parseChunkName(g);this.markChunkForRemesh(I)}))}executeLightOperationsSyncAll(g){["SUNLIGHT","RED","GREEN","BLUE"].forEach((I=>{const C=I.toLowerCase(),A=g.removals[C],i=g.floods[C];(A.length>0||i.length>0)&&this.executeLightOperationsSync({removals:A,floods:i},I)}))}async loadMaterials(){const{textureUnitDimension:g}=this.options,I=(g,I)=>{const C=this.makeShaderMaterial();return C.side=g?i.$EB:i.hB5,C.transparent=g,C.map=I,C.uniforms.map.value=I,C},C=Array.from(this.registry.blocksById.values()),A=(g=>{let I=1;const C=Math.ceil(Math.sqrt(g));for(;I<C;)I*=2;return I})(C.reduce(((g,I)=>{const C=I.faces.filter((g=>g.independent)).length,A=I.faces.filter((g=>g.isolated)).length;return g+(I.faces.length-C-A)}),0)),t=new ZC(A,g);C.forEach((C=>{const A=I(C.isSeeThrough,t),i=this.makeChunkMaterialKey(C.id);this.chunks.materials.set(i,A),C.faces.forEach((A=>{if(!A.independent||A.isolated)return;const i=I(C.isSeeThrough,ZC.makeUnknownTexture(g)),t=this.makeChunkMaterialKey(C.id,A.name);this.chunks.materials.set(t,i)}))}))}makeChunkMaterialKey(g,I,C){return C?`${g}-${I}-${C.join("-")}`:I?`${g}-${I}`:`${g}`}trackChunkAt(g,I,C){if(!this.isTrackingChunks)return;const{chunkSize:A,maxHeight:i,subChunks:t}=this.options,s=[0|g,0|I,0|C],[o,e]=dg.mapVoxelToChunk(s,A),[l,,d]=dg.mapVoxelToChunkLocal(s,A),n=i/t,c=Math.floor(I/n),a=[];a.push([o,e]),0===l&&a.push([o-1,e]),0===d&&a.push([o,e-1]),0===l&&0===d&&a.push([o-1,e-1]),l===A-1&&a.push([o+1,e]),d===A-1&&a.push([o,e+1]),l===A-1&&d===A-1&&a.push([o+1,e+1]);const h=[];I%n==0&&c>0?h.push(c-1):I%n==n-1&&c<t&&h.push(c+1),h.push(c);const Z=[];this.chunksTracker.forEach((g=>{Z.push(g.join(","))}));for(const[m,b]of a)for(const g of h)Z.includes([m,b,g].join(","))||this.chunksTracker.push([[m,b],g])}recordVoxelDelta(g,I,C,A){const i=dg.getChunkName(dg.mapVoxelToChunk([0|g,0|I,0|C],this.options.chunkSize)),t={coords:[0|g,0|I,0|C],oldVoxel:A.oldVoxel??0,newVoxel:A.newVoxel??0,oldRotation:A.oldRotation,newRotation:A.newRotation,oldStage:A.oldStage,newStage:A.newStage,timestamp:performance.now(),sequenceId:this.deltaSequenceCounter++},s=this.voxelDeltas.get(i)||[];s.push(t),this.voxelDeltas.set(i,s)}markChunkForRemesh(g){const{subChunks:I}=this.options;for(let C=0;C<I;C++)this.chunksTracker.some((([I,A])=>I[0]===g[0]&&I[1]===g[1]&&A===C))||this.chunksTracker.push([g,C])}checkIsInitialized(g,I=!0){if(I?this.isInitialized:!this.isInitialized)throw new Error(`Cannot ${g} ${I?"after":"before"} the world ${I?"has been":"is"} isInitialized. ${I?"This has to be called before `world.init`.":"Remember to call the asynchronous function `world.init` beforehand."}`)}}}}]);