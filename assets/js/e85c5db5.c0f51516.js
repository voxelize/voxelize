"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9320],{2769:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"intermediate/network-interception","title":"Network Interception","description":"Network interceptors allow you to hook into the message flow between client and server. Any object with an onMessage method can be registered as an interceptor.","source":"@site/docs/tutorials/intermediate/6-network-interception.md","sourceDirName":"intermediate","slug":"/intermediate/network-interception","permalink":"/tutorials/intermediate/network-interception","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"tutorialSidebar","previous":{"title":"Customizing the ECS","permalink":"/tutorials/intermediate/customizing-the-ecs"},"next":{"title":"Collision Detection","permalink":"/tutorials/intermediate/collision-detection"}}');var r=t(62540),i=t(43023);const c={sidebar_position:6},o="Network Interception",a={},l=[{value:"The NetIntercept Interface",id:"the-netintercept-interface",level:2},{value:"Registering Interceptors",id:"registering-interceptors",level:2},{value:"Creating a Custom Interceptor",id:"creating-a-custom-interceptor",level:2},{value:"Message Types",id:"message-types",level:2},{value:"Sending Packets",id:"sending-packets",level:2},{value:"Example: Entity Counter",id:"example-entity-counter",level:2},{value:"Example: Latency Monitor",id:"example-latency-monitor",level:2},{value:"Order of Execution",id:"order-of-execution",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"network-interception",children:"Network Interception"})}),"\n",(0,r.jsxs)(n.p,{children:["Network interceptors allow you to hook into the message flow between client and server. Any object with an ",(0,r.jsx)(n.code,{children:"onMessage"})," method can be registered as an interceptor."]}),"\n",(0,r.jsx)(n.h2,{id:"the-netintercept-interface",children:"The NetIntercept Interface"}),"\n",(0,r.jsxs)(n.p,{children:["Interceptors implement the ",(0,r.jsx)(n.code,{children:"NetIntercept"})," interface:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="NetIntercept Interface"',children:"interface NetIntercept {\n  onMessage?: (message: MessageProtocol) => void;\n  packets?: any[];\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"onMessage"})," - Called when any message is received from the server"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packets"})," - Array of outgoing packets to send on the next flush"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"registering-interceptors",children:"Registering Interceptors"}),"\n",(0,r.jsx)(n.p,{children:"Register interceptors with the network:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Registering Interceptors"',children:"const network = new VOXELIZE.Network();\n\nnetwork.register(world);\nnetwork.register(peers);\nnetwork.register(entities);\nnetwork.register(myCustomInterceptor);\n"})}),"\n",(0,r.jsx)(n.p,{children:"Built-in interceptors:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"World"})," - Handles chunk loading, world updates, initialization"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Peers"})," - Handles peer position and metadata updates"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Entities"})," - Handles entity creation, updates, and deletion"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Events"})," - Handles custom event messages"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Method"})," - Handles method call responses"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"creating-a-custom-interceptor",children:"Creating a Custom Interceptor"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Custom Interceptor"',children:'import { MessageProtocol } from "@voxelize/protocol";\n\nconst chatLogger = {\n  onMessage(message: MessageProtocol) {\n    if (message.type === "CHAT" && message.chat) {\n      console.log(`[${message.chat.sender}]: ${message.chat.body}`);\n    }\n  },\n};\n\nnetwork.register(chatLogger);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"message-types",children:"Message Types"}),"\n",(0,r.jsx)(n.p,{children:"Common message types you can intercept:"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Type"}),(0,r.jsx)(n.th,{children:"Description"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"INIT"})}),(0,r.jsx)(n.td,{children:"Initial world data (config, blocks, peers, entities)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"JOIN"})}),(0,r.jsx)(n.td,{children:"Player joined the world"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"LEAVE"})}),(0,r.jsx)(n.td,{children:"Player left the world"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"PEER"})}),(0,r.jsx)(n.td,{children:"Peer position/metadata update"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"ENTITY"})}),(0,r.jsx)(n.td,{children:"Entity create/update/delete"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"LOAD"})}),(0,r.jsx)(n.td,{children:"Chunk data received"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"UPDATE"})}),(0,r.jsx)(n.td,{children:"World stats update (time, etc.)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"CHAT"})}),(0,r.jsx)(n.td,{children:"Chat message"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"EVENT"})}),(0,r.jsx)(n.td,{children:"Custom event"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"METHOD"})}),(0,r.jsx)(n.td,{children:"Method call response"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"sending-packets",children:"Sending Packets"}),"\n",(0,r.jsx)(n.p,{children:"Interceptors can queue outgoing packets:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Sending Packets"',children:'const myInterceptor = {\n  packets: [] as any[],\n\n  sendChat(message: string) {\n    this.packets.push({\n      type: "CHAT",\n      chat: {\n        sender: "Player",\n        body: message,\n      },\n    });\n  },\n\n  onMessage(message: MessageProtocol) {\n    // Handle incoming messages\n  },\n};\n\nnetwork.register(myInterceptor);\n\n// Later, send a chat message\nmyInterceptor.sendChat("Hello world!");\n'})}),"\n",(0,r.jsx)(n.p,{children:"Packets are automatically flushed each frame by the network."}),"\n",(0,r.jsx)(n.h2,{id:"example-entity-counter",children:"Example: Entity Counter"}),"\n",(0,r.jsx)(n.p,{children:"Track entity counts by type:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Entity Counter"',children:'import { MessageProtocol } from "@voxelize/protocol";\n\nclass EntityCounter {\n  counts: Map<string, number> = new Map();\n\n  onMessage = (message: MessageProtocol) => {\n    if (!message.entities) return;\n\n    for (const entity of message.entities) {\n      const current = this.counts.get(entity.type) || 0;\n\n      switch (entity.operation) {\n        case "CREATE":\n          this.counts.set(entity.type, current + 1);\n          break;\n        case "DELETE":\n          this.counts.set(entity.type, Math.max(0, current - 1));\n          break;\n      }\n    }\n  };\n\n  getCount(type: string): number {\n    return this.counts.get(type) || 0;\n  }\n}\n\nconst counter = new EntityCounter();\nnetwork.register(counter);\n'})}),"\n",(0,r.jsx)(n.h2,{id:"example-latency-monitor",children:"Example: Latency Monitor"}),"\n",(0,r.jsx)(n.p,{children:"Measure round-trip time:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-ts",metastring:'title="Latency Monitor"',children:'class LatencyMonitor {\n  packets: any[] = [];\n  private pingTime = 0;\n  latency = 0;\n\n  ping() {\n    this.pingTime = performance.now();\n    this.packets.push({\n      type: "METHOD",\n      method: { name: "ping", payload: "{}" },\n    });\n  }\n\n  onMessage = (message: MessageProtocol) => {\n    if (message.type === "METHOD" && message.method?.name === "pong") {\n      this.latency = performance.now() - this.pingTime;\n    }\n  };\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"order-of-execution",children:"Order of Execution"}),"\n",(0,r.jsx)(n.p,{children:"When a message arrives:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"network.sync()"})," is called (automatically each frame)"]}),"\n",(0,r.jsx)(n.li,{children:"Message is decoded from the WebSocket"}),"\n",(0,r.jsxs)(n.li,{children:["Each registered interceptor's ",(0,r.jsx)(n.code,{children:"onMessage"})," is called in registration order"]}),"\n",(0,r.jsx)(n.li,{children:"Interceptors process the message"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When sending:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Interceptors add packets to their ",(0,r.jsx)(n.code,{children:"packets"})," array"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"network.flush()"})," is called (automatically each frame)"]}),"\n",(0,r.jsx)(n.li,{children:"All packets from all interceptors are collected and sent"}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"packets"})," arrays are cleared"]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Read on to learn about ",(0,r.jsx)(n.a,{href:"./collision-detection",children:"collision detection"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},43023:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>o});var s=t(63696);const r={},i=s.createContext(r);function c(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);